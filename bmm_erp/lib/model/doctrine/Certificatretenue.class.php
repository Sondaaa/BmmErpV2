<?php

/**
 * Certificatretenue
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProject1
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Certificatretenue extends BaseCertificatretenue {

    public function ReadHtmlCertificat($id) {

        $certificat = CertificatretenueTable::getInstance()->find($id);
        $fournisseur = $certificat->getFournisseur();
        $documentbudget = $certificat->getDocumentbudget();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);

        $html = '<table style="width:100%;">
                    <tr>
                        <td style="width:30%;text-align:center;">
                            REPUBLIQUE TUNISIENNE<br>
                            MINISTRE DES FINANCES<br>
                            _ _ _ _ ° ° ° _ _ _ _<br>
                            DIRECTION GENERALE<br>
                            DU CONTROLE FISCAL
                        </td>
                        <td style="width:70%;text-align:center;">
                            ANNEXE A LA NOTE COMMUNE N°10/98<br>
                            CERTIFICAT DE RETENUE A LA SOURCE AU TITRE DE LA TVA,<br>
                            DE L\'IR ET DE L\'IS SUR LES MARCHES CONCLUS AVEC L\'ETAT,<br>
                            LES COLLECTIVITÉS LOCALES, LES ENTREPRSES<br>
                            ET ETABLISSEMENTS PUBLIC
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.='<table style="width:100%;" border="1" cellpadding="3">
                    <tr>
                        <td style="width:100%;">
                            A/ ORGANISME DEBITEUR
                            <ul style="width:100%;">
                                <li> Nom ou raison sociale : ' . $societe->getRs() . '</li>
                                <li> Activité : ' . $societe->getActivite() . '</li>
                                <li> Adresse : ' . $societe->getAdresse() . '</li>
                            </ul>
                            <div style="width:100%;text-align:center;">IDENTIFIANT</div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:42%;text-align:center;">Matricule<br>fiscal</td>
                        <td style="width:18%;text-align:center;">Code<br>TVA</td>
                        <td style="width:19%;text-align:center;">Code<br>catégorie</td>
                        <td style="width:21%;text-align:center;">N° Etablissement<br>secodaire</td>
                    </tr>
                    <tr>';

        $matricule_fiscale = trim($societe->getMatfiscal());
        $matricule_fiscale = str_replace("/", "", $matricule_fiscale);
        $size_matricule = strlen($matricule_fiscale);

        $width_td = 6;
        if ($societe->getMatfiscal() != null):
            for ($j = 12; $j >= 1; $j--):
                if ($j == 5)
                    $width_td = 18;
                if ($j == 4)
                    $width_td = 19;
                if ($j < 4)
                    $width_td = 7;
                if ($size_matricule - $j >= 0):
                    $html.='<td style="width:' . $width_td . '%;text-align:center;height: 25px;">' . $matricule_fiscale[$size_matricule - $j] . '</td>';
                else:
                    $html.='<td style="width:' . $width_td . '%;text-align:center;height: 25px;"></td>';
                endif;
            endfor;
        else:
            $html.='<td style="width:6%;text-align:center;height: 25px;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>

                        <td style="width:18%;text-align:center;"></td>
                        <td style="width:19%;text-align:center;"></td>

                        <td style="width:7%;text-align:center;"></td>
                        <td style="width:7%;text-align:center;"></td>
                        <td style="width:7%;text-align:center;"></td>';
        endif;

        $html.='</tr>
                <tr>
                        <td style="width:100%;">
                            B/ DESIGNATION DU BENEFICIAIRE
                            <ul style="width:100%;">
                                <li> Nom ou raison sociale : ' . $fournisseur->getRs() . '</li>
                                <li> Activité : ' . $fournisseur->getActivitetiers() . '</li>
                                <li> Adresse : ' . $fournisseur->getAdr() . '</li>
                            </ul>
                            <div style="width:100%;text-align:center;">IDENTIFIANT</div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:42%;text-align:center;">Matricule<br>fiscal</td>
                        <td style="width:18%;text-align:center;">Code<br>TVA</td>
                        <td style="width:19%;text-align:center;">Code<br>catégorie</td>
                        <td style="width:21%;text-align:center;">N° Etablissement<br>secodaire</td>
                    </tr>
                    <tr>';

        $matricule_fiscale = trim($fournisseur->getMatriculefiscale());
        $matricule_fiscale = str_replace("/", "", $matricule_fiscale);
        $size_matricule = strlen($matricule_fiscale);

        $width_td = 6;
        if ($fournisseur->getMatriculefiscale() != null):
            for ($j = 12; $j >= 1; $j--):
                if ($j == 5)
                    $width_td = 18;
                if ($j == 4)
                    $width_td = 19;
                if ($j < 4)
                    $width_td = 7;
                if ($size_matricule - $j >= 0):
                    $html.='<td style="width:' . $width_td . '%;text-align:center;height: 25px;">' . $matricule_fiscale[$size_matricule - $j] . '</td>';
                else:
                    $html.='<td style="width:' . $width_td . '%;text-align:center;height: 25px;"></td>';
                endif;
            endfor;
        else:
            $html.='<td style="width:6%;text-align:center;height: 25px;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>
                        <td style="width:6%;text-align:center;"></td>

                        <td style="width:18%;text-align:center;"></td>
                        <td style="width:19%;text-align:center;"></td>

                        <td style="width:7%;text-align:center;"></td>
                        <td style="width:7%;text-align:center;"></td>
                        <td style="width:7%;text-align:center;"></td>';
        endif;

        $html.='</tr>
                <tr>
                        <td style="width:100%;">
                            C/ INFORMATIONS RELATIVES AU MARCHE
                            <ul style="width:100%;">
                                <li> Objet de l\'ordonnance de paiement : ' . trim($certificat->getObjetreglement()) . '</li>
                                <li> Montant TTC : ' . number_format($certificat->getMontantordonnance(), 3, '.', ' ') . '</li>
                                <li> Numéro d\'ordonnance : ' . $documentbudget->getNumero() . '</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:100%;height: 25px;">
                            D/ MONTANTS PAYES
                        </td>
                    </tr>
                    <tr style="text-align: center;">
                        <td rowspan="2" style="width: 14%;">Montant<br>hors TVA<br>(1)</td>
                        <td rowspan="2" style="width: 10%;">Taux<br>TVA<br>(2)</td>
                        <td rowspan="2" style="width: 13%;">TVA<br>due<br>(1) X (2)</td>
                        <td rowspan="2" style="width: 16%;">Montant total<br>TVA comprise<br>(3)</td>
                        <td rowspan="2" style="width: 18%;">TVA retenue<br>à la source 25%<br>(1) X (2) / (4)</td>
                        <td colspan="2" style="width: 29%;">Retenue à la source IR/IS</td>
                    </tr>
                    <tr style="text-align: center;">
                        <td style="width: 11%;">Taux de<br>la retenue (4)*</td>
                        <td style="width: 18%;">Montant de<br>la retenue<br>(3) X (4)</td>
                    </tr>
                    <tr>
                        <td style="text-align:right;height: 25px;">' . number_format($certificat->getMontantht(), 3, '.', ' ') . '</td>
                        <td></td>
                        <td style="text-align:right;">' . number_format($certificat->getTvadue(), 3, '.', ' ') . '</td>
                        <td style="text-align:right;">' . number_format($certificat->getTvacomprise(), 3, '.', ' ') . '</td>
                        <td style="text-align:right;">' . number_format($certificat->getTvaretenue(), 3, '.', ' ') . '</td>
                        <td style="text-align:center;">' . $certificat->getRetenuesource()->getValeurretenue() . ' %</td>
                        <td style="text-align:right;">' . number_format($certificat->getMontantretenue(), 3, '.', ' ') . '</td>
                    </tr>
                </table>';

        $html.='&nbsp;<br><table style="width:100%;" cellpadding="3">
                    <tr>
                        <td style="width:55%;text-align:justify;">
                            (*) Le taux de la retenue est de : <br>
                            <table style="width:100%;">
                                <tr>
                                    <td style="width:15%;">. 2,5 %</td>
                                    <td style="width:85%;">pour les honoraires payés aux personnes morales et les personnes physique soumises à l\'IR selon le régime réel.</td>
                                </tr>
                                <tr>
                                    <td style="width:15%;">. 5 %</td>
                                    <td style="width:85%;">pour les honoraires servis aux personnes physiques non soumises à l\'IR selon le régime réel.</td>
                                </tr>
                                <tr>
                                    <td style="width:15%;">. 15 %</td>
                                    <td style="width:85%;">pour les honoraires payés aux non résidents.</td>
                                </tr>
                                <tr>
                                    <td style="width:15%;">. 20 %</td>
                                    <td style="width:85%;">pour RCM et jetons.</td>
                                </tr>
                                <tr>
                                    <td style="width:15%;">. 1,5 %</td>
                                    <td style="width:85%;">dans tous les autres cas.</td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:10%;"></td>
                        <td style="width:35%;text-align:justify;">
                            &nbsp;<br>
                            Je soussigné, certifie exacts et sincères les renseignements figurant sur le présent certificat 
                            et m\'expose aux sanctions prévues par la loi pour toutes inexactitudes.<br>
                            
                            <div style="width:100%;text-align:center;">
                                A <b>kébili</b> le ' . date('d/m/Y') . '<br><br>
                                Signature et Cachet<br>
                                de l\'ordonnateur ou du débiteur
                            </div>
                        </td>
                    </tr>
                </table>';



        return $html;
    }

    public function ReadHtmlRecap($id) {
        $certificat = CertificatretenueTable::getInstance()->find($id);
        $fournisseur = $certificat->getFournisseur();
        $documentbudget = $certificat->getDocumentbudget();

        $html = '<table style="width:100%;">
                    <tr>
                        <td style="width:20%;text-align:center;">
                            MINISTRE DE LA DEFENSE<br>
                            NATIONALE<br>
                            OFFICE DE DEVELOPPEMENT<br>
                            DE RJIM MAATOUG<br>
                            KEBILI
                        </td>
                        <td style="width:80%;"></td>
                    </tr>
                </table>&nbsp;<br>';

        $html.='<div style="width:100%;text-align:center;font-size:14px;font-weight:bold;">
                    RECAP DE REGLEMENT DES FACTURES<br>
                    FOURNISSEUR : ' . $fournisseur->getRs() . '
                </div>&nbsp;<br>';

        $html.='<table style="width:100%;text-align:center;" border="1" cellpadding="3">
                    <tr>
                        <td rowspan="2" style="width:5%;"><b>N°</b></td>
                        <td style="width:39%;"><b>DESIGNATION DE LA FACTURE</b></td>
                        <td rowspan="2" style="width:15%;"><b>IMPUTATION BUDGETAIRE</b></td>
                        <td style="width:26%;"><b>RETENUE</b></td>
                        <td rowspan="2" style="width:15%;"><b>NET<br>A PAYER</b></td>
                    </tr>
                    <tr>
                        <td style="width:13%;"><b>N°</b></td>
                        <td style="width:13%;"><b>DATE</b></td>
                        <td style="width:13%;"><b>MONTANT TTC</b></td>                       
                        <td style="width:13%;"><b>TVA 25%</b></td>
                        <td style="width:13%;"><b>R. SOURCE</b></td>
                    </tr>';

        $i = 1;
        foreach ($documentbudget->getPiecejointbudget() as $piece):
            $doc_achat = $piece->getDocumentachat();
            if ($doc_achat->getIdTypedoc() == 15) {
                $piece_joint_budget = $doc_achat->getPiecejointbudget()->getFirst();
                $document_budget = $piece_joint_budget->getDocumentbudget();
                $ligne = $document_budget->getLigprotitrub();
                $mnt_tva = $doc_achat->getMnttva() / 4;
                $mnt_retenue = ($doc_achat->getMntttc() * $certificat->getRetenuesource()->getValeurretenue()) / 100;
                $mnt_net = $doc_achat->getMntttc() - $mnt_tva - $mnt_retenue;                
                $resultat_mnttc+=$doc_achat->getMntttc();
                $resultat_mnt_tva+=$mnt_tva;
                $resultat_mnt_reteune+=$mnt_retenue;
                $resultat_mnt_net+=$mnt_net;
                $html.='<tr>
                    <td style="width:5%;text-align:right;">' . $i . '</td>                    
                    <td style="width:13%;">' . $doc_achat->getNumero() . '</td>
                    <td style="width:13%;">' . date('d/m/Y', strtotime($doc_achat->getDatecreation())) . '</td>
                    <td style="width:13%;">' . number_format($doc_achat->getMntttc(), 3, '.', ' ') . '</td>                    
                    <td style="width:15%;">' . $ligne->getRubrique()->getLibelle() . '</td>                        
                    <td style="width:13%;">' . number_format($mnt_tva, 3, '.', ' ') . '</td>
                    <td style="width:13%;">' . number_format($mnt_retenue, 3, '.', ' ') . '</td>                    
                    <td style="width:15%;">' . number_format($mnt_net, 3, '.', ' ') . '</td>
                </tr>';
                $i++;
            }
        endforeach;
        for ($j = $i; $j < sizeof($documentbudget->getPiecejointbudget()); $j++):
            $html.='<tr>
                    <td style="width:5%;text-align:right;">' . $j . '</td>
                    <td style="width:13%;"></td>
                    <td style="width:13%;"></td>
                    <td style="width:13%;"></td>
                    <td style="width:15%;"></td>
                    <td style="width:13%;"></td>
                    <td style="width:13%;"></td>
                    <td style="width:15%;"></td>
                </tr>';
        endfor;

        $html.='<tr>
                    <td style="width:5%;text-align:right;height:30px;"></td>                    
                    <td style="width:13%;text-align:center;">TOTAL</td>
                    <td style="width:13%;"></td>
                    <td style="width:13%;text-align:right;">' 
                . number_format($resultat_mnttc, 3, '.', ' ') . '</td>                    
                    <td style="width:15%;"></td>                        
                    <td style="width:13%;text-align:right;">' 
                . number_format($resultat_mnt_tva, 3, '.', ' ') . '</td>
                    <td style="width:13%;text-align:right;">' 
                . number_format($resultat_mnt_reteune, 3, '.', ' ') . '</td>                    
                    <td style="width:15%;text-align:right;">' 
                . number_format($resultat_mnt_net, 3, '.', ' ') . '</td>
                </tr>';

        $html.='</table>&nbsp;<br>&nbsp;<br>';

        $html.='<table style="width:100%;">
                    <tr>
                        <td style="width:60%;"></td>
                        <td style="width:40%;text-align:center;font-size:14px;">
                            LE DIRECTEUR GENERAL
                        </td>
                    </tr>
                </table>';

        return $html;
    }

    public function ReadHtmlListeCertificat() {
        $annee = $_SESSION['exercice_budget'];
        $certificats = CertificatretenueTable::getInstance()->getByAnnee($annee);

        $html = '';
        if ($annee != '')
            $html.='<h3 style="font-size:18px;">Liste des Certificats de Retenue à la Source - ' . $annee . '</h3>';
        else
            $html.='<h3>Liste des Certificats de Retenue à la Source</h3>';

        $html.='&nbsp;<br><table border="1" cellpadding="3">
                    <tr style="text-align:center;font-weight:bold;background-color:#EDEDED;">
                        <td style="width:5%;height:25px;">N°</td>
                        <td style="width:12%;">Date de Création</td>
                        <td style="width:33%;">Ordonnance de paiement</td>
                        <td style="width:25%;">Fournisseur</td>
                        <td style="width:25%;">Objet de Règlement</td>
                    </tr>';
        $i = 1;
        foreach ($certificats as $certificat):
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($certificat->getDatecreation())) . '</td>
                        <td style="text-align:center;font-size:10px;">' . trim($certificat->getDocumentbudget()) . '</td>
                        <td style="text-align:left;font-size:10px;">' . trim($certificat->getFournisseur()) . '</td>
                        <td style="text-align:left;font-size:10px;">' . trim($certificat->getObjetreglement()) . '</td>
                </tr>';
            $i++;
        endforeach;

        $html.='</table>';

        return $html;
    }

}
