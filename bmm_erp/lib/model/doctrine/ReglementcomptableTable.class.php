<?php

/**
 * ReglementcomptableTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ReglementcomptableTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object ReglementcomptableTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Reglementcomptable');
    }

    public function getByIdPiece($id_piece = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->andWhere("a.id_dossier = ?", $_SESSION['dossier_id']);



        if ($id_piece != '')
            $q = $q->Andwhere("a.id_piececomptable = ?", $id_piece);

        $q = $q->orderby('id desc');
        return $q->execute();
    }

    public function findByPeriode($datedebut = '', $datefin = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('id asc');
        return $q->execute();
    }

    public function loadByInterval($reglement_min = '', $reglement_max = '', $datedebut = '', $datefin = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");
        if ($reglement_min != "")
            $q = $q->AndWhere('a.id >=' . $reglement_min);

        if ($reglement_max != '')
            $q->andWhere('a.id <= ' . $reglement_max);
        $q = $q->Andwhere("a.saisie = 0");
        $q = $q->orderby('id asc');
        return $q->execute();
    }

    public function load($datedebut = '', $datefin = '', $reference = '', $libelle = '', $type = '', $banque = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id'])
        ;
        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER( a.libelle)  LIKE '%" . strtoupper($libelle) . "%'");
        if ($type && $type != "")
            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");

        if ($banque && $banque != "")
            $q = $q->leftJoin('a.Caissesbanques ca')
                    ->Andwhere("UPPER( ca.libelle)  LIKE '" . strtoupper($banque) . "%'");
        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('id asc');
        return $q;
    }

    public function findByPeriodeAndType($datedebut = '', $datefin = '', $reference = '', $type = '', $libelle = '', $banque = '') {

        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($type && $type != "")
            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER(a.libelle) LIKE '%" . strtoupper($libelle) . "%'");

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");

        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("a.date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("a.date <= '" . $datefin . "'");
        if ($banque && $banque != "")
            $q = $q->leftJoin('a.Caissesbanques ca')
                    ->Andwhere("UPPER( ca.libelle)  LIKE '" . strtoupper($banque) . "%'");
        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('id asc');

        return $q->execute();
    }

    public function loadSaisie($datedebut = '', $datefin = '', $reference = '', $libelle = '', $type = '', $banque = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);


        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER( a.libelle)  LIKE '%" . strtoupper($libelle) . "%'");
        if ($type && $type != "")
            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");
        if ($banque && $banque != "")
            $q = $q->leftJoin('a.Caissesbanques ca')
                    ->Andwhere("UPPER( ca.libelle)  LIKE '" . strtoupper($banque) . "%'");
        $q = $q->Andwhere("a.saisie = 1");

        $q = $q->orderby('id asc');
        return $q;
    }

    public function getForPrint($saisie = '', $reference = '', $libelle = '', $datedebut = '', $datefin = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->andWhere("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER( a.libelle)  LIKE '%" . strtoupper($libelle) . "%'");
//        if ($type && $type != "")
//            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");



        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        if ($saisie != '')
            $q = $q->Andwhere("a.saisie = ?", $saisie);

        $q = $q->orderby('id asc');
        return $q->execute();
    }

    public function findType($datedebut = '', $datefin = '', $type = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id'])

        ;
        if ($type == '1')
            $q = $q->Andwhere("( a.type)  = '" . 'Debit' . "%'");
        else
            $q = $q->Andwhere("( a.type)  = '" . 'CrÃ©dit' . "%'");
        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("a.date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("a.date <= '" . $datefin . "'");

        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('id asc');
        return $q->execute();
    }

    public function getAllPagerComptabilite($numero = '', $libelle = '', $type = '', $compte = '') {
        $q = $this->createQuery('f')
                ->select('f.id as id, f.numero as reference, p.numerocompte as numerocompte, p.libelle as libellecompte')
                ->from('Reglementcomptable f')
                ->leftJoin('f.Plandossiercomptable p')
                ->where('f.id_dossier = ?', $_SESSION['dossier_id']);
        if ($numero != '') {
            $q = $q->andWhere('UPPER(f.numero) like ?', '%' . $numero . '%');
        }
        if ($libelle != '') {
            $q = $q->andWhere('UPPER(f.libelle) like ?', '%' . $libelle . '%');
        }
        if ($libelle != '') {
            $q = $q->andWhere('UPPER(f.libelle) like ?', '%' . $libelle . '%');
        } if ($type != '') {
            $q = $q->andWhere('UPPER(f.type) like ?', '%' . $type . '%');
        }
        if ($compte != '') {
            $q = $q->andWhere("p.id = " . $compte);
        }

        $q = $q->orderBy('f.id');
        return $q;
    }

    public function loadByIntervalFac($fac_od_min = '', $fac_od_max = '') {
        $q = Doctrine_Core::getTable('Reglementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);


        if ($fac_od_min != "")
            $q = $q->AndWhere('a.id >=' . $fac_od_min);

        if ($fac_od_max != '')
            $q->andWhere('a.id <= ' . $fac_od_max);


        $q = $q->orderby('id asc');
        return $q->execute();
    }

}
