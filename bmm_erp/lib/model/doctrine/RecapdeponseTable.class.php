<?php

/**
 * RecapdeponseTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class RecapdeponseTable extends Doctrine_Table
{

    /**
     * Returns an instance of this class.
     *
     * @return object RecapdeponseTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Recapdeponse');
    }

    public function getByAnneeAndMois($annee, $mois, $id_titre)
    {
       
            $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('EXTRACT(YEAR FROM r.datecreation) = ?', $annee)
                ->andWhere('r.mois = ?', $mois)
                ->andWhere('r.id_titre = ?', $id_titre)
                ->andWhere("l.nordre NOT LIKE '%-%'")
                ->andWhere('ru.id_rubrique is  null')
                ->orderBy('LENGTH(l.nordre), l.nordre')
                ->execute();
        
        return $q;
    }

    public function getSousByAnneeAndMois($annee, $mois, $id_titre, $id_rubrique)
    {
        $q = $this->createQuery('r')
            ->leftJoin('r.Ligprotitrub l')
            ->leftJoin('l.Rubrique ru')
            ->where('ru.id_rubrique = ?', $id_rubrique)
            ->andWhere('EXTRACT(YEAR FROM r.datecreation) = ?', $annee)
            ->andWhere('r.mois = ?', $mois)
            ->andWhere('r.id_titre = ?', $id_titre)
            ->orderBy('LENGTH(l.nordre), l.nordre')
            ->execute();
            
        return $q;
    }
    public function getMntCaisseByArray($annee,  $id_titre, $id_rubrique,$array){
        $array_push=json_decode($array,true);
        $q = $this->createQuery('r')
        ->select('coalesce(SUM(r.mnt_caisse),0) as mnt_caisse')
    
        ->where('r.id_rubrique = ?', $id_rubrique)
        ->andWhere('EXTRACT(YEAR FROM r.datecreation) = ?', $annee)
        ->andWhereIn('r.mois', $array_push)
        ->andWhere('r.id_titre = ?', $id_titre)->execute()->getFirst();
       
        return $q;
    }
    public function getMntBanqueByArray($annee,  $id_titre, $id_rubrique,$array){
        $array_push=json_decode($array,true);
        
        $q = $this->createQuery('r')
        ->select('coalesce(SUM(r.mnt_banque),0) as mnt_banque')
       
        ->where('r.id_rubrique = ?', $id_rubrique)
        ->andWhere('EXTRACT(YEAR FROM r.datecreation) = ?', $annee)
        ->andWhereIn('r.mois', $array_push)
        ->andWhere('r.id_titre = ?', $id_titre);
    
        return $q->execute()->getFirst();
    }
    public function getMntAntByArray($annee,  $id_titre, $id_rubrique,$array){
        $array_push=json_decode($array,true);
        $q = $this->createQuery('r')
        ->select('coalesce(SUM(r.mnt_ant),0) as mnt_ant')
    
        ->where('r.id_rubrique = ?', $id_rubrique)
        ->andWhere('EXTRACT(YEAR FROM r.datecreation) = ?', $annee)
        ->andWhereIn('r.mois', $array_push)
        ->andWhere('r.id_titre = ?', $id_titre)->execute()->getFirst();
       
        return $q;
    }
}
