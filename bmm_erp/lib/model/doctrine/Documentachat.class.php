<?php

/**
 * Documentachat
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    BmmErpTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Documentachat extends BaseDocumentachat {

    public function HtmlByType() {
        if ($this->getIdTypedoc() == 18)
            return $this->ReadHtmlBCEProvisoire($this->getId());
        if ($this->getIdTypedoc() == 7)
            return $this->ReadHtmlBCEDefinitif($this->getId());
        if ($this->getIdTypedoc() == 2)
            return $this->ReadHtmlBDCDefinitif($this->getId());
        if ($this->getIdTypedoc() == 17)
            return $this->ReadHtmlBDCProvisoire($this->getId());
        if ($this->getIdTypedoc() == 15)
            return $this->ReadHtmlFactureImressionComptabilite($this->getId());
        if ($this->getIdTypedoc() == 20)
            return $this->ReadHtmlFactureImressionComptabilite($this->getId());
        if ($this->getIdTypedoc() == 21)
            return $this->ReadHtmlFactureImressionComptabilite($this->getId());
        return '';
    }

    public function getTypeDocumentTitle() {
        if ($this->getIdTypedoc() == 18)
            return 'Detail Bon de commande externe (Système) provisoire';
        if ($this->getIdTypedoc() == 17)
            return 'Detail Bon de dépense au comptant (Système) provisoire';
        if ($this->getIdTypedoc() == 7)
            return 'Detail Bon de commande externe (Système)';
        if ($this->getIdTypedoc() == 2)
            return 'Detail Bon de dépense au comptant (Système)';
        if ($this->getIdTypedoc() == 15)
            return 'Detail Facture (Système)';
        return '';
    }

    public function getLinkDocument() {
        if ($this->getIdTypedoc() == 18)
            return url_for('documentachat/imprimerBCEProvisoire') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 17)
            return url_for('documentachat/imprimerBDCProvisoire') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 7)
            return url_for('documentachat/imprimerBCEDefinitf') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 2)
            return url_for('documentachat/imprimerBDCDefinitf') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 15)
            return url_for('Documents/Imprimerdocentre/') . '/iddoc/' . $this->getId();
        if ($this->getIdTypedoc() == 21)
            return url_for('documentachat/ImprimerBDCRegroupeProvisoire') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 22)
            return url_for('documentachat/ImprimerlisteBDCRegroupeS') . '?iddoc=' . $this->getId();
        if ($this->getIdTypedoc() == 16)
            return url_for('documentachat/imprimerBDCDefinitf') . '?iddoc=' . $this->getId();


        return '#';
    }

    public function ReadHtmlContratResilie(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc())
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<h3 style="font-size:18px;">Liste des Contrats d\'achat Résiliés</h3>';
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 20%;">Document</td>
                                    <td style="text-align:center;width: 15%;">   Date Création </td>
                                      <td style="text-align:center;width: 15%;">Date Annulation</td>
                                       <td style="text-align:center;width: 25%;">Motif d\'annulation</td>
                                    <td style="text-align:center;width: 20%;">Utilisateur</td>                                                                                                
                    </tr>';
        $year = date('Y');

        $query = Doctrine_Core::getTable('documentcontratresiliation')
                ->createQuery('a')
                ->select('a.*')
                ->from('documentcontratresiliation a,contratachat ,documentachat, utilisateur, agents, typedoc')
                ->where('a.id_docachat=documentachat.id')
                ->andWhere('documentachat.id_contrat=contratachat.id')
                ->andWhere('documentachat.id_typedoc=typedoc.id')
                ->andWhere('documentachat.id_typedoc=20')
                ->andWhere(' a.id_user = utilisateur.id')
                ->andWhere('utilisateur.id_parent = agents.id')
                ->andWhere('a.valide_budget = false ')
                ->andWhere('documentachat.etatdocachat is not null');
        if ($date_debut != "") {
            $query->Andwhere("a.dateresiliation>='" . $date_debut . "'");
        }
        if ($date_fin != "") {
            $query->Andwhere("a.dateresiliation<='" . $date_fin . "'");
        }
        if ($date_debut == "" && $date_fin == "") {
            $query->andWhere("a.dateresiliation >= '" . $year . "-01-01'")
                    ->andWhere("a.dateresiliation <= '" . $year . "-12-31'");
        }
        $query->orderBy(' a.id desc');
        //        die($query);
        $documentachats = $query->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste des Contrats Achats Résiliés  Vide</td>
                        </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                //                $numero = strtoupper($documentachat->getDocumentachat()->getTypedoc());
                //                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat->getDocumentachat()->getTypedoc()->getLibelle() . " N° : "
                        . $documentachat->getDocumentachat()->getNumero() . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDocumentachat()->getDatecreation())) . '</td>';

                $html .= '   <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDateresiliation())) . '</td>';

                if ($documentachat->getMotifresiliattion() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->getMotifresiliattion()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                if ($documentachat->getUtilisateur()) :
                    $html .= '   <td style="text-align:center;">' . $documentachat->getUtilisateur()->getAgents() . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlContratProvisoireAnnule(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc())
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<h3 style="font-size:18px;">Liste des Contrats d\'achat annulés</h3>';
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 20%;">Document</td>
                                    <td style="text-align:center;width: 15%;">
                                      Date Création
                                    </td>
                                      <td style="text-align:center;width: 15%;">Date Annulation</td>
                                       <td style="text-align:center;width: 25%;">Motif d\'annulation</td>
                                    <td style="text-align:center;width: 20%;">Utilisateur</td>                                                                                                
                    </tr>';
        $year = date('Y');
        $query = "select documentcontratannulation.id as id, "
                . " documentcontratannulation.dateannulation"
                . " as dateannulation, documentcontratannulation.motifannulation as motif,"
                . " concat(contratachat.reference , ' N° ',contratachat.numero) as numero,"
                . " documentachat.datecreation as datecreation, "
                . " typedoc.libelle as type, agents.nomcomplet as user"
                . " from documentcontratannulation,contratachat ,documentachat, utilisateur, agents, typedoc "
                . " where documentcontratannulation.id_docachat=documentachat.id  "
                . " and documentachat.id_contrat=contratachat.id"
                . " and documentachat.id_typedoc=typedoc.id "
                . " and documentachat.id_typedoc=19 "
                . " AND documentcontratannulation.id_user = utilisateur.id"
                . " AND utilisateur.id_parent = agents.id "
                . " AND documentcontratannulation.valide_budget = false "
                . " and documentachat.etatdocachat is not null";
        if ($date_debut != "") {
            $query .= " And documentcontratannulation.dateannulation>='" . $date_debut . "'";
        }

        if ($date_fin != "") {
            $query .= " And documentcontratannulation.dateannulation<='" . $date_fin . "'";
        }
        if ($date_debut == "" && $date_fin == "") {
            $query .= " And documentcontratannulation.dateannulation >= '" . $year . "-01-01' and documentcontratannulation.dateannulation <= '" . $year . "-12-31'";
        }
        $query .= " order by documentcontratannulation.id desc";
        //. " and documentachat.datecreation >= " . "'01-01-" . date('Y') . "' and  documentachat.datecreation <= " . "'31-12-" . date('Y') . "'"
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();

        $docs = $conn->fetchAssoc($query);
        $i = 1;
        if (sizeof($docs) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste des Contrats Achats Annulés  Vide</td>
                        </tr>';
        else :

            for (
            $i = 0; $i < sizeof($docs); $i++
            ) :

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $docs[$i]['type'] . " : " . $docs[$i]['numero'] . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($docs[$i]['datecreation'])) . '</td>';

                $html .= '   <td style="text-align:center;">' . date('d/m/Y', strtotime($docs[$i]['dateannulation'])) . '</td>';

                if ($docs[$i]['motif'] != "") :
                    $html .= '<td>' . html_entity_decode($docs[$i]['motif']) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                if ($docs[$i]['user']) :
                    $html .= '   <td style="text-align:center;">' . $docs[$i]['user'] . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                $html .= '</tr>';

            endfor;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlContratAnnule(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc())
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<h3 style="font-size:18px;">Liste des Contrats d\'achat annulés</h3>';
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 20%;">Document</td>
                                    <td style="text-align:center;width: 15%;">
                                      Date Création
                                    </td>
                                      <td style="text-align:center;width: 15%;">Date Annulation</td>
                                       <td style="text-align:center;width: 25%;">Motif d\'annulation</td>
                                    <td style="text-align:center;width: 20%;">Utilisateur</td>                                                                                                
                    </tr>';
        $year = date('Y');
        $query = "select documentcontratannulation.id as id, "
                . " documentcontratannulation.dateannulation"
                . " as dateannulation, documentcontratannulation.motifannulation as motif,"
                . " concat(contratachat.reference , ' N° ',contratachat.numero) as numero,"
                . " documentachat.datecreation as datecreation, "
                . " typedoc.libelle as type, agents.nomcomplet as user"
                . " from documentcontratannulation,contratachat ,documentachat, utilisateur, agents, typedoc "
                . " where documentcontratannulation.id_docachat=documentachat.id  "
                . " and documentachat.id_contrat=contratachat.id"
                . " and documentachat.id_typedoc=typedoc.id "
                . " and documentachat.id_typedoc=20 "
                . " AND documentcontratannulation.id_user = utilisateur.id"
                . " AND utilisateur.id_parent = agents.id "
                . " AND documentcontratannulation.valide_budget = false "
                . " and documentachat.etatdocachat is not null";
        if ($date_debut != "") {
            $query .= " And documentcontratannulation.dateannulation>='" . $date_debut . "'";
        }

        if ($date_fin != "") {
            $query .= " And documentcontratannulation.dateannulation<='" . $date_fin . "'";
        }
        if ($date_debut == "" && $date_fin == "") {
            $query .= " And documentcontratannulation.dateannulation >= '" . $year . "-01-01' and documentcontratannulation.dateannulation <= '" . $year . "-12-31'";
        }
        $query .= " order by documentcontratannulation.id desc";
        //. " and documentachat.datecreation >= " . "'01-01-" . date('Y') . "' and  documentachat.datecreation <= " . "'31-12-" . date('Y') . "'"
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();

        $docs = $conn->fetchAssoc($query);
        $i = 1;
        if (sizeof($docs) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste des Contrats Achats Annulés  Vide</td>
                        </tr>';
        else :

            for (
            $i = 0; $i < sizeof($docs); $i++
            ) :

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $docs[$i]['type'] . " : " . $docs[$i]['numero'] . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($docs[$i]['datecreation'])) . '</td>';

                $html .= '   <td style="text-align:center;">' . date('d/m/Y', strtotime($docs[$i]['dateannulation'])) . '</td>';

                if ($docs[$i]['motif'] != "") :
                    $html .= '<td>' . html_entity_decode($docs[$i]['motif']) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                if ($docs[$i]['user']) :
                    $html .= '   <td style="text-align:center;">' . $docs[$i]['user'] . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                $html .= '</tr>';

            endfor;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBCIAnnule(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $id_type = $request->getParameter('id_type', '');

        $idtypedoc = $request->getParameter('idtypedoc', '');
        $date_fin = $request->getParameter('datefin', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc())
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<h3 style="font-size:18px;">Liste des documents d\'achat annulés</h3>';
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 20%;">Document</td>
                                    <td style="text-align:center;width: 15%;">
                                      Date Création
                                    </td>
                                      <td style="text-align:center;width: 15%;">Date Annulation</td>
                                       <td style="text-align:center;width: 25%;">Motif d\'annulation</td>
                                    <td style="text-align:center;width: 20%;">Utilisateur</td>                                                                                                
                    </tr>';
        $year = date('Y');
        $query = Doctrine_Core::getTable('documentachatannulation')
                ->createQuery('a')
                ->select('a.*')
                ->from('documentachatannulation a, documentachat doc, utilisateur')
                ->where('a.id_documentachat=doc.id')

                //                 ->andWhere('doc.id_typedoc=typedoc.id')
                ->andWhere('a.id_user = utilisateur.id');
        if ($id_type == 18)
            $query->andWhere('doc.id_typedoc=18 or id_typedoc=7');
        if ($id_type == 6 && !$idtypedoc)
            $query->andWhere('doc.id_typedoc=6');
        if ($id_type == 17)
            $query->andWhere('doc.id_typedoc=2 or id_typedoc=17');
        if ($idtypedoc == 21)
            $query->andWhere('doc.id_typedoc=22 or id_typedoc=21');
        if ($date_debut != "") {
            $query->Andwhere("a.dateannulation>='" . $date_debut . "'");
        }
        if ($date_fin != "") {
            $query->Andwhere("a.dateannulation<='" . $date_fin . "'");
        }
        if ($date_debut == "" && $date_fin == "") {
            $query->andWhere("a.dateannulation >= '" . $year . "-01-01'")
                    ->andWhere("a.dateannulation <= '" . $year . "-12-31'");
        }
        //die($query);
        $documentachats = $query->orderBy('id asc')->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste Bons Commandes Annulés  Vide</td>
                        </tr>';
        else :

            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getDocumentachat()->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat->getDocumentachat()->getTypedoc()->getLibelle() . " N° : "
                        . $documentachat->getDocumentachat()->getNumero() . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDocumentachat()->getDatecreation())) . '</td>';

                $html .= '   <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDateannulation())) . '</td>';

                if ($documentachat->getMotifannulation() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->getMotifannulation()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                if ($documentachat->getUtilisateur()) :
                    $html .= '   <td style="text-align:center;">' . $documentachat->getUtilisateur()->getAgents() . '</td>';
                else :
                    $html .= '<td></td>';
                endif;
                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    /*     * ***************affichage facture dans la partie importation facture od******** */

    public function ReadHtmlFactureImressionComptabilite($id) {
        $documentachat = DocumentachatTable::getInstance()->find($id);
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($documentachat->getIdFrs());
        $fournisseur = $frs;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($documentachat->getIdEtatdoc() == 17)
            $titre = $documentachat->getEtatdocument();
        if ($documentachat->getDatesignature())
            $datesign = date('d/m/Y', strtotime($documentachat->getDatesignature()));

        $numero = strtoupper($documentachat->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $documentachat->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $documentachat->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $id)->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($qtefrs * $lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                    </tr>';
            $nordre++;
        }
        //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
        //            $html.=' <tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';

        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($documentachat->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    /*     * *******************Afficahge facutres du BDCR dans la comptabilite*********************************************************** */

    public function ReadHtmlFactureImressionComptabiliteBDCReg($id) {
        $documentachat = DocumentachatTable::getInstance()->find($id);
        $doc_factutres = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id, 15);
        $html = '';
        $fournisseur = new Fournisseur();

        foreach ($doc_factutres as $documentachat) :
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($documentachat->getIdFrs());
            $fournisseur = $frs;


            $soc = new Societe();
            $societe = Doctrine_Core::getTable('societe')->findOneById(1);
            $soc = $societe;
            $datesign = "";
            $titre = "";
            if ($documentachat->getIdEtatdoc() == 17)
                $titre = $documentachat->getEtatdocument();
            if ($documentachat->getDatesignature())
                $datesign = date('d/m/Y', strtotime($documentachat->getDatesignature()));

            $numero = strtoupper($documentachat->getTypedoc());
            $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
            $html .= '<div class="contenue"> '
                    . '<div class="titre"><h3>' . $numero . ' N°: ' . $documentachat->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $documentachat->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                </tr>
                            </thead>
                            <tbody>';
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $id)->orderBy('id asc')->execute();
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qtefrs = 0;

                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne) {
                    $qtefrs = $qteligne->getQtelivrefrs();
                }
                $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($qtefrs * $lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                    </tr>';
                $nordre++;
            }
            //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
            //            $html.=' <tr>
            //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                    </tr>';
            //        }
            $html .= '</tbody>
            </table>';

            $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($documentachat->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

            $html .= '</div></div>';
        endforeach;
        return $html;
    }

    public function ReadHtmlSuivibce(sfWebRequest $request) {

        $numero_bci = $request->getParameter('numero_bci');
        $date_creation = $request->getParameter('date_creation');
        $demandeur = $request->getParameter('demandeur');
        $decision = $request->getParameter('decision');
        $numero_bce = $request->getParameter('numero_bce');
        $numero_bced = $request->getParameter('numero_bced');
        $montant_bced = $request->getParameter('montant_bced');
        $contrat = $request->getParameter('contrat');
        $fac_sys = $request->getParameter('fac_sys');
        $fac_four = $request->getParameter('fac_four');
        $montant_fac = $request->getParameter('montant_fac');
        $eng_budgetge = $request->getParameter('eng_budget');
        $ordonnacement = $request->getParameter('ordonnacement');
        $datepai = $request->getParameter('datepai');
        $montantpaye = $request->getParameter('montantpaye');
        $banque = $request->getParameter('banque');
        $instrumen_paiment = $request->getParameter('instrumen_paiment');
        $montant_banque = $request->getParameter('montant_banque');
        $start = $request->getParameter('start_date');
        $end = $request->getParameter('end_date');
        $id_bci = $request->getParameter('id_bci');

        $documentachats = DocumentachatTable::getInstance()->getDocByTypeDocAndDate(6, null, null, $start, $end, $id_bci);
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $html = '<div >
                    <table cellspacing="0" cellpadding="3">                        
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;"><b><i>SUIVI BON DE COMMANDE</i></b> </td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';
        $html .= '<table cellspacing="0" cellpadding="5" style="width:100%;">
                    <tr>
                        <td style="font-size:12px;width:50%;">
                        ';
        if ($start != '') :
            $html .= '     <b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($start));
        endif;
        if ($end != '') :
            $html .= '   &nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($end));
        endif;


        $html .= '     </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table  cellspacing="0" cellpadding="5" border="1"> <thead>' . '<tr>';
        if ($numero_bci != '')
            $html .= ' <th style="widows: 5%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">N°BCI</th>';
        if ($date_creation != '')
            $html .= ' <th style="widows: 7%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">D.Créat°</th>';
        if ($demandeur != '')
            $html .= '<th style="widows: 8%;text-align: center" rowspan="2">Demandeur</th>';
        if ($decision != '')
            $html .= '<th style="widows: 8%;text-align: center"  rowspan="2">Etat Document</th>';
        if ($numero_bce != '')
            $html .= '<th style="widows: 4%;min-width: 110px;text-align: center"rowspan="2">BCEP</th>';
        if ($numero_bced != '')
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center" rowspan="2">N°BCED</th>';
        if ($montant_bced != '')
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center"rowspan="2" >M.BCED</th>';
        if ($contrat != '')
            $html .= '  <th style="widows: 4%;min-width: 110px;text-align: center " rowspan="2">Contrat </th>';
        if ($eng_budgetge != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center">Date Engag</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center">M.Engage</th>';
        if ($ordonnacement != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center">Date Ordon</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center">M.Ordonn</th>';
        if ($fac_sys != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC S</th>';
        if ($fac_four != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC FRS</th>';
        if ($montant_fac != '')
            $html .= ' <th style="widows: 10%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($datepai != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Date paiement</th>';
        if ($montantpaye != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Banque</th>';
        if ($instrumen_paiment != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Instrument de paiement </th>';
        if ($montant_banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Montant</th>';
        $html .= '</tr>';
        $html .= '</thead><tbody>';
        if (sizeof($documentachats) >= 1):
            foreach ($documentachats as $documentachat) :
                $bon_deponse_Provisoire = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 17);
                if (sizeof($bon_deponse_Provisoire) == 0) :
                    $document_achat_nv = Doctrine_Core::getTable('documentachat')->findByIdDocparent($documentachat->getId());
                    $document_achat_externe_Provisoire = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 18);
                    $document_achat_contrat = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 19);
                    $document_achat_externe_difinitif = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 7);
                    if (sizeof($document_achat_externe_Provisoire) >= 1)
                        $piece_budget_porvisoire = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($document_achat_externe_Provisoire->getFirst()->getId());
                    if (sizeof($document_achat_externe_difinitif) >= 1) {
                        $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                        $docparent_parent = Doctrine_Core::getTable('documentachat')->findByIdDocparent($id_docparent);
                        if (sizeof($docparent_parent) >= 1) {
                            $id_docparent_parent = $docparent_parent->getFirst()->getId();
                            $facuture_comptabe = Doctrine_Core::getTable('documentachat')->findByIdDocparent($id_docparent_parent);
                        }
                    }
                    if (sizeof($document_achat_externe_difinitif) >= 1) {
                        $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                        $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdType(2);
                        $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findOneByIdDocachatAndIdDocumentbudget($id_docparent, $document_udget_ordanancemet->getFirst()->getId());
                    }
                    $html .= '<tr class="ligne_compte" >';
                    if ($numero_bci != '') {
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col">
                             <b>' . $documentachat->getNumerodocachat() . '</b>
                </td>';
                    }
                    if ($date_creation != '') {
                        $html .= '<td style = "text-align: center" class = "fixed-side" scope = "col">'
                                . date('d/m/Y', strtotime($documentachat->getDatecreation())) .
                                '</td> ';
                    }
                    if ($demandeur != '') {
                        if (($documentachat->getIdDemandeur() != '' && $documentachat->getIdDemandeur() != null))
                            $html .= '<td>' . $documentachat->getDemandeur() . ' </td>';
                        else
                            $html .= '<td></td>';
                    }
                    if ($decision != '') {
                        if (sizeof($document_achat_externe_Provisoire) >= 1)
                            $html .= ' <td style="text-align: center">' . $document_achat_nv->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';
                        else
                            $html .= '<td></td>';
                    }

                    if ($numero_bce != '') {
                        if (sizeof($document_achat_externe_Provisoire) >= 1) :
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_Provisoire as $previsoire) :
                                $html .= '<p>' . $previsoire->getNumerodocachat() . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else :
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($numero_bced != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) :
                            $html .= '<td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) :
                                $html .= '<p>' . $definitif->getNumerodocachat() . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else :
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($montant_bced != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) :
                            $html .= '<td style="text-align: rigth" >';
                            foreach ($document_achat_externe_difinitif as $definitif) :
                                $html .= '<p>' . number_format($definitif->getMntttc(), 3, ".", " ") . '</p>';
                            endforeach;
                            $html .= '</td>';

                        else :
                            $html .= '<td></td>';
                        endif;
                    }

                    if ($contrat != '') {
                        if (sizeof($document_achat_contrat) >= 1) :
                            $html .= '<td style="text-align: center" >';
                            foreach ($document_achat_contrat as $contrat) :
                                $html .= '<p>' .
                                        $contrat->getNumerodocachat() . ' '
                                        . number_format($contrat->getMntttc(), 3, ".", " ") . '</p>';
                            endforeach;
                            $html .= '</td>';

                        else :
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($eng_budgetge != '') {
                        if (sizeof($document_achat_externe_Provisoire) >= 1 && sizeof($piece_budget_porvisoire) >= 1) {
                            $html .= '<td style="text-align: center">';
                            foreach ($piece_budget_porvisoire as $piece) :
                                $html .= '<p>' . date('d/m/Y', strtotime($piece->getDocumentbudget()->getDatecreation())) . '</p>';
                            endforeach;
                            $html .= '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                        if (sizeof($document_achat_externe_Provisoire) >= 1 && sizeof($piece_budget_porvisoire) >= 1) {
                            $html .= '<td style="text-align: right">';
                            foreach ($piece_budget_porvisoire as $piece) :
                                $html .= '<p>' . number_format($piece->getDocumentbudget()->getMnt(), 3, ".", " ") . '</p>';
                            endforeach;
                            $html .= '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                    }
                    if ($ordonnacement != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                            $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($id_docparent);
                            $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                            $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                            if (sizeof($document_udget_ordanancemet) >= 1) {
                                $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findByIdDocachatAndIdDocumentbudget($id_docparent, $document_udget_ordanancemet->getFirst()->getId());

                                if (sizeof($piece_budget) >= 1) {
                                    $html .= '<td style="text-align: center">';
                                    foreach ($piece_budget as $piece) :
                                        $html .= '<p>' . date('d/m/Y', strtotime($piece->getDocumentbudget()->getDatecreation())) . '</p>';
                                    endforeach;
                                    $html .= '</td>';
                                    $html .= '<td style="text-align: right">';
                                    foreach ($piece_budget as $piece) :
                                        $html .= '<p>' . number_format($piece->getDocumentbudget()->getMnt(), 3, ".", " ") . '</p>';
                                    endforeach;
                                    $html .= '</td>';
                                } else
                                    $html .= '<td></td><td></td>';
                            } else
                                $html .= '<td></td><td></td>';
                        } else
                            $html .= '<td></td><td></td>';
                    }
                    if ($fac_sys != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td>';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html .= '<p>' . $docparent_parent->getNumerodocachat();
                                    $html .= '</p>';
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($fac_four != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td>';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    if ($definitif->getLignemouvementfacturation()->getFirst() && $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture())
                                        $html .= '<p>' . $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture();
                                    $html .= '</p>';
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($montant_fac != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td>';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    if ($definitif->getLignemouvementfacturation()->getFirst() && $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture())
                                        $html .= '<p>' . number_format($docparent_parent->getMntttc(), 3, ".", " ");
                                    $html .= '</p>';
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($datepai != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {
                                            $html .= '<p>';
                                            $html .= date('d/m/Y', strtotime($mvts->getFirst()->getDateoperation()));
                                            $html .= '</p>';
                                        }
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($montantpaye != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {
                                            $html .= '<p>';
                                            if ($mvts->getFirst()->getDebit() != null)
                                                $html .= number_format($mvts->getFirst()->getDebit(), 3, ".", " ");
                                            else if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getCredit() != null)
                                                $html .= number_format($mvts->getFirst()->getCredit(), 3, ".", " ");
                                            $html .= '</p>';
                                        }
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($banque != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {

                            $html .= '<td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html .= '<p>';
                                        $html .= $mvts->getFirst()->getCaissesbanques();
                                        $html .= '</p>';
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($instrumen_paiment != '') {
                        if (sizeof($mvts) >= 1) {
                            if (sizeof($document_achat_externe_difinitif) >= 1) {

                                $html .= '<td style="text-align: center">';
                                foreach ($document_achat_externe_difinitif as $definitif) {
                                    $id_docparent = $definitif->getId();
                                    $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                    if ($piecejoint)
                                        $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {

                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                        if (sizeof($mvts) >= 1) {
                                            $html .= '<p>';
                                            $html .= $mvts->getFirst()->getInstrumentpaiment();
                                            $html .= '</p>';
                                        }
                                    }
                                }
                                $html .= '</td>';
                            }
                        } else
                            $html .= '<td></td>';
                    }
                    if ($montant_banque != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {

                            $html .= '<td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html .= '<p>';
                                        $html .= $mvts->getFirst()->getDebit();
                                        $html .= '</p>';
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    $html .= '</tr>';

                endif;
            endforeach;
        else:
            $html.='<tr><td style="width: 100%;text-align: center" >Liste des Bon Commandes est vide </td></tr>';
        endif;
        $html .= ' </tbody>
                    </table>';
        return $html;
    }

    public function ReadHtmlSuiviContratTotal(sfWebRequest $request) {

        $numero_bci = $request->getParameter('numero_bci');
        $date_creation = $request->getParameter('date_creation');
        $demandeur = $request->getParameter('demandeur');
        $decision = $request->getParameter('decision');
        $numero_contrat = $request->getParameter('numero_contrat');
        $numero_contratdef = $request->getParameter('numero_contratdef');
        $montant_contratdef = $request->getParameter('montant_contratdef');
        $contrat = $request->getParameter('contrat');
        $fac_sys = $request->getParameter('fac_sys');
        $fac_four = $request->getParameter('fac_four');
        $montant_fac = $request->getParameter('montant_fac');
        $eng_budgetge = $request->getParameter('eng_budget');
        $ordonnacement = $request->getParameter('ordonnacement');

        $datepai = $request->getParameter('datepai');
        $montantpaye = $request->getParameter('montantpaye');
        $banque = $request->getParameter('banque');
        $instrumen_paiment = $request->getParameter('instrumen_paiment');
        $montant_banque = $request->getParameter('montant_banque');
        $start = $request->getParameter('start_date');
        $end = $request->getParameter('end_date');
        $id_bci = $request->getParameter('id_bci');

        $documentachats = DocumentachatTable::getInstance()->getDocByTypeDocAndDateContrat(19, null, null, $start, $end, $id_bci);
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);




        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $html = '<div >
                    <table cellspacing="0" cellpadding="3">
                        
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;"><b><i>SUIVI DES CONTRATS</i></b> </td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';
        $html .= '<table cellspacing="0" cellpadding="5" style="width:100%;">
                    <tr>
                        <td style="font-size:12px;width:50%;">
                        ';
        if ($start != '') :
            $html .= '     <b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($start));
        endif;
        if ($end != '') :
            $html .= '   &nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($end));
        endif;


        $html .= '     </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table  cellspacing="0" cellpadding="5" border="1"> '
                . '<thead>'
                . '<tr style="height: 20%">';
        $contratsachat = ContratachatTable::getInstance()->findbyIdTypedoc(19);
        $contratsachats = ContratachatTable::getInstance()->findAll();
        if ($numero_bci != '')
            $html .= ' <th style="widows: 5%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">N°BCI</th>';
        if ($date_creation != '')
            $html .= ' <th style="widows: 7%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">D.Créat°</th>';
        if ($demandeur != '')
            $html .= '<th style="widows: 8%;text-align: center" rowspan="2">Demandeur</th>';
        if ($decision != '')
            $html .= '<th style="widows: 8%;text-align: center"  rowspan="2">Etat Document</th>';
        if ($numero_contrat != '')
            $html .= '<th style="widows: 4%;min-width: 110px;text-align: center"rowspan="2">CONTRAT</th>';
        if ($numero_contratdef != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°CONTRAT DEF.</th>';
        if ($montant_contratdef != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center"rowspan="2" >M.CONTRAT DEF</th>';
        if ($eng_budgetge != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center">Date Engag</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center">M.Engage</th>';
        if ($ordonnacement != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center">Date Ordon</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center">M.Ordonn</th>';
        if ($fac_sys != '')
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center" rowspan="2">N°FAC S</th>';
        if ($montant_fac != '')
            $html .= ' <th style="widows: 9%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($datepai != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Date paiement</th>';
        if ($montantpaye != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Banque</th>';
        if ($instrumen_paiment != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Instrument de paiement </th>';
        if ($montant_banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Montant</th>';
        $html .= '</tr>';

        $html .= '</thead>'
                . '<tbody>';
        if (sizeof($documentachats) >= 1):
            foreach ($documentachats as $document_achat) :
                $id_doc_parent = $document_achat->getIdDocparent();
                $doc_parent = DocumentachatTable::getInstance()->find($id_doc_parent);
                $docupmenta_acha_contrat_def = DocumentachatTable::getInstance()->getByTypedocContratDef(20, $document_achat->getId());
                if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                    $id_docparent_parent = $docupmenta_acha_contrat_def->getFirst()->getId();
                    $facuture_comptabe = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($id_docparent_parent, 15);
                    if (sizeof($facuture_comptabe) >= 1) {
                        $row_spna = sizeof($facuture_comptabe);
                    }
                }

                if (sizeof($document_achat) >= 1)
                    $piece_budget_porvisoire = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($document_achat->getId());
                if (sizeof($docupmenta_acha_contrat_def) >= 1)
                    $piece_budget_defi = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                if (sizeof($document_achat) >= 1) :
                    $html .= '<tr class="ligne_compte" >';
                    if ($numero_bci != '') {
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col">
                             <b>' . $doc_parent->getNumerodocachat() . '</b>
                </td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($date_creation != '') {
                        $html .= '<td style = "text-align: center" class = "fixed-side" scope = "col">'
                                . date('d/m/Y', strtotime($doc_parent->getDatecreation())) .
                                '</td> ';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($demandeur != '') {
                        if (($doc_parent->getIdDemandeur() != '' && $doc_parent->getIdDemandeur() != null))
                            $html .= '<td>' . $doc_parent->getDemandeur() . ' </td>';
                        else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($decision != '') {
                        $docupmenta_acha_contrat_def = DocumentachatTable::getInstance()->getByTypedocContratDef(20, $document_achat->getId());
                        if (sizeof($docupmenta_acha_contrat_def) >= 1)
                            $html .= ' <td style="text-align: center">' . $docupmenta_acha_contrat_def->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';
                        elseif (sizeof($document_achat) >= 1)
                            $html .= ' <td style="text-align: rigth">' . $document_achat->getEtatdocument()->getEtatdocachat() . '</td>';
                        else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($numero_contrat != '') {
                        if (sizeof($document_achat) >= 1)
                            $html .= ' <td style="text-align: center"><b>' . $document_achat->getContratachat()->getReference() . '  ' . $document_achat->getContratachat()->getNumero() . '</b></td>';
                        else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($numero_contratdef != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1)
                            $html .= '<td style="text-align: center"><b>' . $docupmenta_acha_contrat_def->getFirst()->getContratachat()->getNumero() . '</b></td>';
                        else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    if ($montant_contratdef != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1)
                            $html .= '<td style="text-align: rigth" >' . number_format($docupmenta_acha_contrat_def->getFirst()->getContratachat()->getMnttc(), 3, ".", " ") . '</td>';
                        else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';

                    if ($eng_budgetge != '') {
                        if (sizeof($document_achat) >= 1 && (sizeof($piece_budget_porvisoire) >= 1)) {
                            $html .= '<td style="text-align: center">' . date('d/m/Y', strtotime($piece_budget_porvisoire->getFirst()->getDocumentbudget()->getDatecreation()))
                                    . '</td>';
                        } elseif (sizeof($document_achat) >= 1 && (sizeof($piece_budget_defi) >= 1)) {
                            $html .= '<td style="text-align: center">' . date('d/m/Y', date('d/m/Y', strtotime($piece_budget_defi->getFirst()->getDocumentbudget()->getDatecreation()))) . '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                        //                    if (sizeof($document_achat) >= 1 && (sizeof($piece_budget_porvisoire) >= 1)) {
                        //                        echo number_format($piece_budget_porvisoire->getFirst()->getDocumentbudget()->getMnt(), 3, ".", " ");
                        //                    } elseif (sizeof($document_achat) >= 1 && (sizeof($piece_budget_defi) >= 1)) {
                        //                        echo number_format($piece_budget_defi->getFirst()->getDocumentbudget()->getMnt(), 3, ".", " ");
                        //                    }
                        if (sizeof($document_achat) >= 1 && (sizeof($piece_budget_porvisoire) >= 1)) {
                            $html .= '<td style="text-align: right">' . number_format($piece_budget_porvisoire->getFirst()->getDocumentbudget()->getMnt(), 3, ".", " ")
                                    . '</td>';
                        } elseif (sizeof($document_achat) >= 1 && (sizeof($piece_budget_defi) >= 1)) {
                            $html .= '<td style="text-align: right">' . number_format($piece_budget_defi->getFirst()->getDocumentbudget()->getMnt(), 3, ".", " ") . '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                    } else
                        $html .= '<td style="text-align: center;min-width: 150px;"class="fixed-side" scope="col"></td>';
                    //   die('rr'); 
                    if ($ordonnacement != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                            $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                            if (sizeof($piecejoint) >= 1) {
                                $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                                $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                                if (sizeof($document_udget_ordanancemet) >= 1) {
                                    $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findByIdDocachatAndIdDocumentbudget($docupmenta_acha_contrat_def->getFirst()->getId(), $document_udget_ordanancemet->getFirst()->getId());
                                    if (sizeof($piece_budget) >= 1) {
                                        foreach ($piece_budget as $budget) :
                                            $html .= '<td style="text-align: center">' . date('d/m/Y', strtotime($budget->getDocumentbudget()->getDatecreation())) . '</td>';
                                        endforeach;
                                        $html .= ' </br>';
                                    }
                                }
                            }
                        }
                    } else {
                        $html .= '<td></td>';
                    }
                    if ($fac_sys != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {

                            $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                            if (sizeof($piecejoint) >= 1)
                                $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                            $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                            if (sizeof($document_udget_ordanancemet) >= 1) {
                                $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findByIdDocachatAndIdDocumentbudget($docupmenta_acha_contrat_def->getFirst()->getId(), $document_udget_ordanancemet->getFirst()->getId());
                                if (sizeof($piece_budget) >= 1) {
                                    foreach ($piece_budget as $budget) :

                                        $html .= '<td style="text-align: right">' .
                                                $budget->getDocumentbudget()->getMnt() . '</td>';
                                    endforeach;
                                } else
                                    $html .= '<td></td>';
                            }
                            $html .= '<td></td>';
                        }
                        $html .= '<td></td>';
                    } else {
                        $html .= '<td></td>';
                    }
                    //                }
                    //                }$html.= '<td></td><td></td>';
                    //                } else
                    //                $html.= '<td></td><td></td>';
                    //                }
                    if ($montant_fac != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                            $id_docparent_parent = $docupmenta_acha_contrat_def->getFirst()->getId();
                            $facuture_comptabe = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($id_docparent_parent, 15);
                            if (sizeof($facuture_comptabe) >= 1) {

                                $id_docparent = $facuture_comptabe->getFirst()->getIdDocparent();
                                $docu_fac = DocumentachatTable::getInstance()->findOneById($id_docparent);
                                $lignemvt = LignemouvementfacturationTable::getInstance()->findByIdDocumentachat($docu_fac->getId());
                                foreach ($lignemvt as $ligmvt) :
                                    $html .= '<td>' . $ligmvt->getNumerofacture() . '</td> </br>';
                                endforeach;
                            } else
                                $html .= '<td></td>';
                        } else
                            $html .= '<td></td>';
                    } else {
                        $html .= '<td></td>';
                    }

                    if ($montant_fac != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                            $id_docparent_parent = $docupmenta_acha_contrat_def->getFirst()->getId();
                            $facuture_comptabe = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($id_docparent_parent, 15);
                            if (sizeof($facuture_comptabe) >= 1) {

                                $id_docparent = $facuture_comptabe->getFirst()->getIdDocparent();
                                $docu_fac = DocumentachatTable::getInstance()->findOneById($id_docparent);
                                $lignemvt = LignemouvementfacturationTable::getInstance()->findByIdDocumentachat($docu_fac->getId());
                                foreach ($lignemvt as $ligmvt) :
                                    $html .= '<td style="text-align: center">' . number_format($ligmvt->getMontant(), 3, ".", " ") . '</td> </br>';
                                endforeach;
                            } else
                                $html .= '<td></td>';
                        } else
                            $html .= '<td></td>';
                    } else {
                        $html .= '<td></td>';
                    }



                    if ($datepai != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                            $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                            if (sizeof($piecejoint) >= 1)
                                $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                            $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                            if (sizeof($document_udget_ordanancemet) >= 1) {
                                $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findByIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                                if (sizeof($piece_budget) >= 1) {
                                    foreach ($piece_budget as $piece) :
                                        $id_docbudget = $piece->getIdDocumentbudget();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1) {
                                            if ($mvts->getFirst()->getId() != null)
                                                $html .= '<td style="text-align: center">' . date('d/m/Y', strtotime($mvts->getFirst()->getDateoperation())) . '</td> </br>';
                                        }
                                    endforeach;
                                } else
                                    $html .= '<td></td>';
                            } else
                                $html .= '<td></td>';
                        } else
                            $html .= '<td></td>';
                    } else {
                        $html .= '<td></td>';
                    }
                    if ($montantpaye != '') {
                        if (sizeof($docupmenta_acha_contrat_def) >= 1) {
                            $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                            if (sizeof($piecejoint) >= 1) {
                                $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                                $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);

                                if (sizeof($document_udget_ordanancemet) >= 1) {
                                    $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findByIdDocachat($docupmenta_acha_contrat_def->getFirst()->getId());
                                    if (sizeof($piece_budget) >= 1) {
                                        foreach ($piece_budget as $piece) :
                                            $id_docbudget = $piece->getIdDocumentbudget();
                                            $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                            if (sizeof($mvts) >= 1) {
                                                if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getDebit() != null)
                                                    $html .= '<td style="text-align: rigth">' . number_format($mvts->getFirst()->getDebit(), 3, ".", " ") . '</td>';
                                                else if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getCredit() != null)
                                                    $html .= '<td style="text-align: rigth">' . number_format($mvts->getFirst()->getCredit(), 3, ".", " ") . '</td>';
                                            }
                                        endforeach;
                                    } else
                                        $html .= '<td></td>';
                                } else {
                                    $html .= '<td></td>';
                                }
                            } else
                                $html .= '<td></td>';
                        } else
                            $html .= '<td></td>';
                    } else {
                        $html .= '<td></td>';
                    }
                    //
                    if (sizeof($document_achat_externe_difinitif) >= 1) {
                        $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                        $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($id_docparent);

                        $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                        $document_budget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                        if (sizeof($document_budget_ordanancemet) >= 1) {
                            $id_docbudget = $document_budget_ordanancemet->getFirst()->getId();
                            $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                        }
                        if ($banque != '') {
                            if (sizeof($mvts) >= 1) {
                                if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getIdBanque() != null)
                                    $html .= '<td style="text-align: center">' . $mvts->getFirst()->getCaissesbanques() . '</td>';
                                else
                                    $html .= '<td></td>';
                            }
                        } else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td></td>';
                    //
                    if (sizeof($document_achat_externe_difinitif) >= 1) {
                        $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                        $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($id_docparent);

                        $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                        $document_budget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                        if (sizeof($document_budget_ordanancemet) >= 1) {
                            $id_docbudget = $document_budget_ordanancemet->getFirst()->getId();
                            $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                        }
                        if ($instrumen_paiment != '') {
                            if (sizeof($mvts) >= 1) {
                                if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getIdBanque() != null)
                                    $html .= '   <td style="text-align: center">' . $mvts->getFirst()->getInstrumentpaiment() . '</td>';
                                else
                                    $html .= '<td></td>';
                            }
                        } else
                            $html .= '<td></td>';
                    } else
                        $html .= '<td></td>';
                    if (sizeof($document_achat_externe_difinitif) >= 1) {
                        $id_docparent = $document_achat_externe_difinitif->getFirst()->getId();
                        $piecejoint = PiecejointbudgetTable::getInstance()->findbyIdDocachat($id_docparent);

                        $id_document_udget_achatt = $piecejoint->getFirst()->getIdDocumentbudget();
                        $document_budget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdDocumentbudget($id_document_udget_achatt);
                        if (sizeof($document_budget_ordanancemet) >= 1) {
                            $id_docbudget = $document_budget_ordanancemet->getFirst()->getId();
                            $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                        }

                        if ($montant_banque != '') {
                            if (sizeof($docparent_parent) >= 1 && sizeof($mvts) >= 1) {
                                $html .= '   <td style="text-align: right">' . $mvts->getFirst()->getDebit() . '</td>';
                            }
                        } else {
                            $html .= '<td></td>';
                        }
                    } else
                        $html .= '<td></td>';
                    $html .= '</tr>';

                endif;
            endforeach;
        else:
            $html.='<tr><td style="width: 100%;text-align: center" >Liste des Contrats est vide </td></tr>';
        endif;
        $html .= ' </tbody>
                    </table>';
        return $html;
    }

    public function ReadHtmlSuivicontrat(sfWebRequest $request) {
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();

        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<h3 style="font-size:18px;">Suivi des Contrats</h3>';
        $contratachats = ContratachatTable::getInstance()->findAll();
        foreach ($contratachats as $contrat) :
            $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
            $query = "SELECT    contratachat.id"
                    . " FROM    contratachat ,documentachat"
                    . " WHERE documentachat.id_contrat =" . $contrat->getId() . "";

            $fichecontrat = $conn->fetchAssoc($query);
            if (sizeof($fichecontrat) >= 1) :

                $html .= '<table border = "1" cellpadding = "3">
            <tbody>
             <thead>
            <tr > <th style="widows: 100%;text-align: center;font-size: 14px" colspan="14"  >
                        <h4><b><i>Contrat N° ' . $contrat->getNumero() . '</i></b></h4></th>
                        </tr>
                 <tr>
                            <th  style="widows: 21%;text-align: center;max-width: 25%" class="fixed-side" scope="col"  colspan="3" rowspan="3" >Articles</th> 
                            <th style="widows: 24%;text-align: center;max-width: 20%" colspan="3" >Bon Commande Interne</th>
                            <th style="widows: 20%;text-align: center;max-width: 20%" colspan="4" >Bon Commande Externe</th>
                            <th style="widows: 10%;text-align: center;max-width: 15%" colspan="2" rowspan="3">Montant Contrat</th>
                            <th style="widows: 20%;text-align: center;max-width: 20%" colspan="3" rowspan="3">Observation | Projet</th>
                        </tr>
                        <tr>
                            <th style="widows: 12%;text-align: center;max-width: 10%"  scope="col"rowspan="2">N° BCI</th>
                            <th style="widows: 12%;text-align: center;max-width: 10%" colspan="2" scope="col" rowspan="2">Date Création</th>
                            <th style="widows: 10%;min-width: 110px;text-align: center"rowspan="2">BCE Provisoire</th>
                            <th style="widows: 10%;min-width: 110px;text-align: center "colspan="3">BCE Définitif</th>
                        </tr>
                        <tr>
                            <th>N°BCE D</th><th colspan="2">Montant</th>
                        </tr>

                        </thead>
                        <tbody>';
                $total = 0;
                $montant_contrat = $contrat->getMontantcontrat();
                $documentachats = DocumentachatTable::getInstance()->findAll();
                foreach ($documentachats as $docachat) {
                    $doc_achat = $docachat->getContratachat();

                    if (count($doc_achat) >= 1) {
                        $rowspan = count($doc_achat);
                        if ($docachat->getIdContrat() == $contrat->getId()) {
                            $html .= '<tr><td style="text-align: left;max-width: 20%" colspan="3">';
                            foreach ($docachat->getLignedocachat() as $ligne) :

                                $html .= trim($ligne->getDesignationarticle()) . '**';
                            endforeach;
                            $html .= ' </td>';
                            $html .= ' <td style="text-align: center" >' . trim($docachat->getNumerodocachat()) . '</td>';
                            $html .= ' <td style="text-align: center" colspan="2">' . date('d/m/Y', strtotime($docachat->getDatecreation())) . '</td>';
                            $document_achat_externe_Provisoire = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($docachat->getId(), 18);
                            if (sizeof($document_achat_externe_Provisoire) >= 1)
                                $html .= ' <td style="text-align: center">' . $document_achat_externe_Provisoire->getFirst()->getNumerodocachat() . '</td>';
                            else
                                $html .= ' <td></td>';
                            $document_achat_externe_difinitif = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($docachat->getId(), 7);
                            if (sizeof($document_achat_externe_difinitif) >= 1) {
                                $html .= ' <td style="text-align: right">' . $document_achat_externe_difinitif->getFirst()->getNumerodocachat() . '</td>';
                                $total = $total + $document_achat_externe_difinitif->getFirst()->getMntttc();
                            } else {
                                $html .= ' <td></td>';
                            }
                            if (sizeof($document_achat_externe_difinitif) >= 1)
                                $html .= ' <td style="text-align: right" colspan="2">' . number_format($document_achat_externe_difinitif->getFirst()->getMntttc(), 3, ".", " ") . '</td>';
                            else
                                $html .= ' <td colspan="2"></td>';
                            $html .= ' <td  style="text-align: right" colspan="2">' . number_format($docachat->getContratachat()->getMontantcontrat(), 3, ".", " ") . '</td>';

                            $html .= '<td colspan="3">';
                            foreach ($docachat->getLignedocachat() as $ligne) :
                                $html .= trim($ligne->getObservation()) . ' | ' . trim($ligne->getProjet());
                            endforeach;
                            $html .= '  </td> </tr> ';
                        }
                    }
                }
                $reste = $montant_contrat - $total;
                $html .= ' </tbody>
                        <tfoot>
                            <tr style="background-color: #fff; background: repeat-x #F2F2F2;font-size: 14px;text-align: center"><td colspan="8">Somme des Achats</td>
                                <td style="text-align: right" colspan="2">' . number_format($total, 3, ".", " ") . '
                                </td>
                                <td colspan="7"></td>
                            </tr>
                            <tr style="background-color: #fff; background: repeat-x #F2F2F2;font-size: 14px;text-align: center"><td colspan="8">Le Reste</td><td colspan="2"></td>
                                <td  style="text-align: right" colspan="2">
                                   ' . number_format($reste, 3, ".", " ")
                        . '
                                </td>  
                                <td colspan="6"></td></tr>
                        </tfoot>

                    </table></br></br>';
            endif;
        endforeach;



        return $html;
    }

    public function ReadHtmlSuiviBCIDucontrat(sfWebRequest $request) {
        $html = '<h3 style="font-size:18px;">Suivi des BCIS Du Contrat</h3>';
        $offset = 1;
        $start_date = date('Y-m-d', strtotime(date('Y/m/01')));
        if ($request->getParameter('start'))
            $start_date = date('Y-m-d', strtotime($request->getParameter('start')));
        $d = cal_days_in_month(CAL_GREGORIAN, date("m"), date("Y"));
        $end_date = date('Y-m-d', strtotime(date("Y") . '-' . date("m") . '-' . $d));
        if ($request->getParameter('end'))
            $end_date = date('Y-m-d', strtotime($request->getParameter('end')));
        if ($request->getParameter('id_bci'))
            $id_bci = $request->getParameter('id_bci');
        $contratachats = ContratachatTable::getInstance()->getByTypeDocAndDateBCICONTRAT(20);
        $documentachats = DocumentachatTable::getInstance()->getDocByTypeDocAndDateBCICONTRAT(6, 5, $offset, $start_date, $end_date, $id_bci);

        foreach ($contratachats as $contrat) :
            $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
            $query = "SELECT    contratachat.id"
                    . " FROM    contratachat ,documentachat"
                    . " WHERE documentachat.id_contrat =" . $contrat->getId() . ""
                    . " and documentachat.datecreation >= " . "'01-01-" . date('Y') . "'"
                    . " and  documentachat.datecreation <= " . "'31-12-" . date('Y') . "'"
                    . " and documentachat.id_typedoc=6"
                    . " order by id desc";

            $fichecontrat = $conn->fetchAssoc($query);
            if (sizeof($fichecontrat) >= 1) :
                $html .= '<table  cellspacing="0" cellpadding="5" border="1">            
            <tbody>
            <tr > <td style="width: 100%;text-align: center;font-size: 12px"   >
                        <h4><b><i>Contrat N° ';
                if (sizeof($fichecontrat) >= 1)
                    $html .= $contrat->getNumero();
                $html .= '</i></b></h4></td>
                        </tr>';
                $html .= '    <tr style="background-color: #D3D3D3;font-size: 12px">   
                           <td  style="text-align: center;width: 20%" >Articles</td>                                                                                
                            <td style="text-align: center;width: 10%"  >N° BCI</td>
                            <td style="text-align: center;width: 11%"  >Date Créat°</td>
                            
                             <td style="width: 10%">N°Fac. Sys</td>
                             <td style="width: 12%">Montant</td>                            
                           <td style="text-align: center;width: 12%"  >Mnt Contrat</td>
                            <td style="text-align: center;width: 25%" >Observat° | Projet</td>                           
                        </tr>    ';

                $total = 0;
                $montant_contrat = $contrat->getMontantcontrat();
                if (sizeof($fichecontrat) >= 1 && sizeof($documentachats) >= 1) :
                    //
                    foreach ($documentachats as $docachat) {
                        $doc_achat = $docachat->getContratachat();
                        if (count($doc_achat) >= 1) {
                            $rowspan = count($doc_achat);
                            if ($docachat->getIdContrat() == $contrat->getId()) {
                                $html .= '<tr style="font-size: 11px"><td style="text-align: left;width: 20%;" >';
                                foreach ($docachat->getLignedocachat() as $ligne) :

                                    $html .= '<p>' . trim($ligne->getDesignationarticle()) . '</p>';
                                endforeach;
                                $html .= ' </td>';
                                $html .= ' <td style="text-align: center;width: 10%" >' . trim($docachat->getNumerodocachat()) . '</td>';
                                $html .= ' <td style="text-align: center;width: 11%">' . date('d/m/Y', strtotime($docachat->getDatecreation())) . '</td>';
                                $document_achat_externe_difinitif = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($docachat->getId(), 15);
                                if (sizeof($document_achat_externe_difinitif) >= 1) {
                                    $html .= ' <td style="text-align: right;width: 10%">';
                                    foreach ($document_achat_externe_difinitif as $fac) :
                                        $html .= '<p>';
                                        $html .= trim($fac->getNumerodocachat());

                                        $html .= '</p>';
                                        $total = $total + $fac->getMntttc();
                                    endforeach;
                                    $html .= '</td>';
                                } else {
                                    $html .= ' <td></td>';
                                }
                                if (sizeof($document_achat_externe_difinitif) >= 1) :
                                    $html .= ' <td style="text-align: right" >';
                                    foreach ($document_achat_externe_difinitif as $fac) :
                                        $html .= '<p>' . number_format($fac->getMntttc(), 3, ".", " ");
                                        $html .= '</p>';
                                    endforeach;
                                    $html .= '</td>';
                                else :
                                    $html .= ' <td ></td>';
                                endif;
                                $html .= ' <td  style="text-align: right" >' . number_format($docachat->getContratachat()->getMontantcontrat(), 3, ".", " ") . '</td>';

                                $html .= '<td>';
                                foreach ($docachat->getLignedocachat() as $ligne) :
                                    $html .= trim($ligne->getObservation()) . ' | ' . trim($ligne->getProjet());
                                endforeach;
                                $html .= '  </td> </tr> ';
                            }
                        }
                    }
                else :
                    $html .= '<tr><td style="text-align: center;width: 100%" >'
                            . 'Liste des BCI du Contrat est vide'
                            . '</td></tr>';
                endif;

                $reste = $montant_contrat - $total;
                $html .= '</tbody>
                        <tfoot>
                            <tr style="background-color: #DCDCDC;font-size: 12px;">
                            <td style="width: 51%">Somme des Achats</td>
                                <td style="text-align: right;width: 12%">';
                $html .= number_format($total, 3, ".", " ");
                $html .= '     </td>
                                <td style="width: 37%"></td> 
                            </tr>
                            <tr style="background-color: #DCDCDC; background: repeat-x #F2F2F2;font-size: 12px;text-align: left">
                            <td style="width: 51%">Le Reste</td>
                            <td ></td>
                                <td style="text-align: right;width: 12%" >';
                $html .= number_format($reste, 3, ".", " ");
                $html .= '  </td>  
                                <td style="width: 25%"></td></tr>
                        </tfoot>';
                $html .= '  </table></br></br>';
            endif;
        endforeach;
        return $html;
    }

    public function ReadHtmlSuivibdc(sfWebRequest $request) {

        $numero_bci = $request->getParameter('numero_bci');
        $date_creation = $request->getParameter('date_creation');
        $demandeur = $request->getParameter('demandeur');
        $decision = $request->getParameter('decision');
        $numero_bce = $request->getParameter('numero_bce');
        $numero_bced = $request->getParameter('numero_bced');
        $montant_bced = $request->getParameter('montant_bced');
        $fac_sys = $request->getParameter('fac_sys');
        $fac_four = $request->getParameter('fac_four');
        $montant_fac = $request->getParameter('montant_fac');
        $eng_budgetge = $request->getParameter('eng_budget');
        $ordonnacement = $request->getParameter('ordonnacement');
        $datepai = $request->getParameter('datepai');
        $montantpaye = $request->getParameter('montantpaye');
        $banque = $request->getParameter('caisse');
        $montant_banque = $request->getParameter('montant_caisse');
        $start = $request->getParameter('start_date');
        $end = $request->getParameter('end_date');
        $id_bci = $request->getParameter('id_bci');
        $documentachats = DocumentachatTable::getInstance()->getDocByTypeDocAndDate(6, null, null, $start, $end, $id_bci);

//        $documentachats = DocumentachatTable::getInstance()->getByTypedoc(6);

        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $html = '<div >
                    <table cellspacing="0" cellpadding="3">
                        
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;"><b><i>SUIVI BON DEPENSE AU COMPTANT</i></b></td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';
        $html.= '<table cellspacing="0" cellpadding="5" style="width:100%;">
        <tr><td style="font-size:12px;width:50%;"> ';
        if ($start != ''):
            $html.= '<b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($start));
        endif;
        if ($end != ''):
            $html.= '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($end));
        endif;
        $html.= '     </td>
                </tr>
            </table>&nbsp;<br>';
        $html .= '<table  cellspacing="0" cellpadding="5" border="1"> <thead> <tr>';

        if ($numero_bci != '')
            $html .= ' <th style="widows: 5%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">N°BCI</th>';
        if ($date_creation != '')
            $html .= ' <th style="widows: 7%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">D.Créat°</th>';
        if ($demandeur != '')
            $html .= '<th style="widows: 8%;text-align: center" rowspan="2">Demandeur</th>';
        if ($decision != '')
            $html .= '<th style="widows: 8%;text-align: center"  > Etat <br>Document</th>';
        if ($numero_bce != '') {
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center" rowspan="2">N°BDCP</th>';
        }
        if ($numero_bced != '') {
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center"  rowspan="2">BDCS</th>';
        }
        if ($montant_bced != '')
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center"rowspan="2" >M.BDCS</th>';

        if ($eng_budgetge != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Date Eng</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Mnt.Eng</th>';
        if ($ordonnacement != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Date.Ord</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center" rowspan="2">Mnt.Ord</th>';
        if ($fac_sys != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC S</th>';
        if ($fac_four != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC FRS</th>';
        if ($montant_fac != '')
            $html .= ' <th style="widows: 10%;min-width: 110px;text-align: center" rowspan="2">Mnt.Fac</th>';
        if ($datepai != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Date <br> paiement</th>';
        if ($montantpaye != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Caisse</th>';

        if ($montant_banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;"rowspan="2">Montant</th>';

        $html .= '</tr>';
        $html .= '    </thead><tbody>';
        if (sizeof($documentachats) >= 1):
            foreach ($documentachats as $documentachat) :
                $bon_deponse_Provisoire = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 17);

                $document_achat_externe_difinitif = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($documentachat->getId(), 2);

                if (sizeof($bon_deponse_Provisoire) >= 1) :
                    $bon_deponse_externe_difinitif = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 2);
                    $document_bddc_nv = Doctrine_Core::getTable('documentachat')->findByIdDocparent($documentachat->getId());
                    if (sizeof($bon_deponse_Provisoire) >= 1)
                        $piece_budget_bon_depense_porvisoire = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($bon_deponse_Provisoire->getFirst()->getId());
                    if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                        $id_docparent = $bon_deponse_externe_difinitif->getFirst()->getId();
                        $docparent_parent = Doctrine_Core::getTable('documentachat')->findByIdDocparent($id_docparent);
                        if (sizeof($docparent_parent) >= 1) {
                            $id_docparent_parent = $docparent_parent->getFirst()->getId();
                            $facuture_comptabe = Doctrine_Core::getTable('documentachat')->findById($id_docparent_parent);
                        }
                    }
                    if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                        $id_docparent = $bon_deponse_externe_difinitif->getFirst()->getId();
                        $document_udget_ordanancemet = Doctrine_Core::getTable('documentbudget')->findByIdType(2);
                        $piece_budget = Doctrine_Core::getTable('Piecejointbudget')->findOneByIdDocachatAndIdDocumentbudget($id_docparent, $document_udget_ordanancemet->getFirst()->getId());
                    }
                    $html .= '<tr class="ligne_compte" >';
                    if ($numero_bci != '') {
                        $html .= '<td style="text-align: center;">
                             <b>' . $documentachat->getNumerodocachat() . '</b>
                </td>';
                    }
                    if ($date_creation != '') {
                        $html .= '<td style = "text-align: center" >'
                                . date('d/m/Y', strtotime($documentachat->getDatecreation())) .
                                '</td> ';
                    }
                    if ($demandeur != '') {
                        if (($documentachat->getIdDemandeur() != '' && $documentachat->getIdDemandeur() != null))
                            $html .= '<td>' . $documentachat->getDemandeur() . ' </td>';
                        else
                            $html .= '<td></td>';
                    }
                    if ($decision != '') {
                        if (sizeof($bon_deponse_Provisoire) >= 1)
                            $html .= ' <td style="text-align: center">' . $document_bddc_nv->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';
                        else
                            $html .= '<td></td>';
                    }
                    if ($numero_bce != '') {
                        if (sizeof($bon_deponse_Provisoire) >= 1):
                            $html .= ' <td style="text-align: center">';
                            foreach ($bon_deponse_Provisoire as $prevesoire) :
                                $html .='<p>' . $prevesoire->getNumerodocachat() . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else:
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($numero_bced != '') {
                        if (sizeof($bon_deponse_externe_difinitif) >= 1):
                            $html .= '<td style="text-align: center">';
                            foreach ($bon_deponse_externe_difinitif as $definitif) :
                                $html .='<p>' . $definitif->getNumerodocachat() . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else:
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($montant_bced != '') {
                        if (sizeof($bon_deponse_externe_difinitif) >= 1):
                            $html .= '<td style="text-align: rigth" >';
                            foreach ($bon_deponse_externe_difinitif as $definitif) :
                                $html .='<p>' . number_format($definitif->getMntttc(), 3, ".", " ") . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else:
                            $html .= '<td></td>';
                        endif;
                    }
                    if ($eng_budgetge != '') {
                        if (sizeof($bon_deponse_Provisoire) >= 1 && sizeof($piece_budget_bon_depense_porvisoire) >= 1) {
                            $html .= '<td style="text-align: center">';
                            foreach ($piece_budget_bon_depense_porvisoire as $previsoire) :
                                $html .='<p>' . date('d/m/Y', strtotime($previsoire->getDocumentbudget()->getDatecreation())) . '</p>';
                            endforeach;
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                        if (sizeof($bon_deponse_Provisoire) >= 1 && sizeof($piece_budget_bon_depense_porvisoire) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($piece_budget_bon_depense_porvisoire as $previsoire) :
                                $html .='<p>' . number_format($previsoire->getDocumentbudget()->getMnt(), 3, ".", " ") . '</p>';
                            endforeach;
                            $html .='</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($ordonnacement != '') {
                        $document_achat_externe_difinitif = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($documentachat->getId(), 2);
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $document_udget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($piecejoint->getIdDocumentbudget());
                                    if ($document_udget_ordanancemet) {
                                        $piece_budget = PiecejointbudgetTable::getInstance()->findOneByIdDocachatAndIdDocumentbudget($definitif->getId(), $document_udget_ordanancemet->getId());
                                        if ($piece_budget) {
                                            $html .='<p>' . date('d/m/Y', strtotime($piece_budget->getDocumentbudget()->getDatecreation())) . '</p>';
                                        }
                                    }
                                }
                            } $html.= '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                        $document_achat_externe_difinitif = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($documentachat->getId(), 2);
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $document_udget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($piecejoint->getIdDocumentbudget());
                                    if ($document_udget_ordanancemet) {
                                        $piece_budget = PiecejointbudgetTable::getInstance()->findOneByIdDocachatAndIdDocumentbudget($definitif->getId(), $document_udget_ordanancemet->getId());
                                        if ($piece_budget) {
                                            if ($piece_budget->getDocumentbudget()->getMnt())
                                                $html .='<p>' . $piece_budget->getDocumentbudget()->getMnt() . '</p>';
                                        }
                                    }
                                }
                            } $html.= '</td>';
                        } else {
                            $html .= '<td></td>';
                        }
                    }


                    if ($fac_sys != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html.= '<p>' . $docparent_parent->getNumerodocachat();
                                    $html.= '</p>';
                                }
                            }$html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($fac_four != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    if ($definitif->getLignemouvementfacturation()->getFirst() && $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture())
                                        $html.= $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture();

                                    $html.= '</p>';
                                }
                            }
                            $html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($montant_fac != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html.= number_format($docparent_parent->getMntttc(), 3, ".", " ");
                                    $html.= '</p>';
                                }
                            }
                            $html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($datepai != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {
                                            $html.= '<p>';
                                            $html.= date('d/m/Y', strtotime($mvts->getFirst()->getDateoperation()));

                                            $html.= '</p>';
                                        }
                                    }
                                }
                            } $html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($montantpaye != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {
                                            $html.= '<p>';
                                            if ($mvts->getFirst()->getDebit() != null)
                                                $html.= number_format($mvts->getFirst()->getDebit(), 3, ".", " ");
                                            else if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getCredit() != null)
                                                $html.= number_format($mvts->getFirst()->getCredit(), 3, ".", " ");

                                            $html.= '</p>';
                                        }
                                    }
                                }
                            } $html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($banque != '') {
                        if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html.='<p>';
                                        $html.= $mvts->getFirst()->getCaissesbanques();
//                                                      
                                        $html.= '</p>';
                                    }
                                }
                            }$html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($montant_banque != '') {
                        if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                            $html .= '<td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html.='<p>';
                                        $html.= $mvts->getFirst()->getDebit();
                                        $html.= '</p>';
                                    }
                                }
                            }$html.= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    $html .= '</tr>';

                endif;
            endforeach;
        else:
            $html.='<tr><td style="width: 100%;text-align: center" >Liste des Bon Dépense au Comptant est vide </td></tr>';
        endif;
        $html .= ' </tbody>
                    </table>';
        return $html;
    }

    public function ReadHtmlSuivibdcRegroupe(sfWebRequest $request) {
        $numero_bci = $request->getParameter('numero_bci');
        $date_creation = $request->getParameter('date_creation');
        $demandeur = $request->getParameter('demandeur');
        $decision = $request->getParameter('decision');
        $numero_bce = $request->getParameter('numero_bce');
        $numero_bced = $request->getParameter('numero_bced');
        $montant_bced = $request->getParameter('montant_bced');
        $fac_sys = $request->getParameter('fac_sys');
        $fac_four = $request->getParameter('fac_four');
        $montant_fac = $request->getParameter('montant_fac');
        $eng_budgetge = $request->getParameter('eng_budget');
        $ordonnacement = $request->getParameter('ordonnacement');
        $datepai = $request->getParameter('datepai');
        $montantpaye = $request->getParameter('montantpaye');
        $banque = $request->getParameter('caisse');
        $montant_banque = $request->getParameter('montant_caisse');
        $start = $request->getParameter('start_date');
        $end = $request->getParameter('end_date');
        $id_bci = $request->getParameter('id_bci');
        $documentachats = DocumentachatTable::getInstance()->getDocByTypeDocAndDate(6, null, null, $start, $end, $id_bci);


        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">SUIVI BON DEPENSE AU COMPTANT</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';
        $html.= '<table cellspacing="0" cellpadding="5" style="width:100%;">
        <tr><td style="font-size:12px;width:50%;"> ';
        if ($start != ''):
            $html.= '<b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($start));
        endif;
        if ($end != ''):
            $html.= '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($end));
        endif;
        $html.= '     </td>
                </tr>
            </table>&nbsp;<br>';
        $html .= '<table  cellspacing="0" cellpadding="5" border="1"> <thead> <tr>';

        if ($numero_bci != '')
            $html .= ' <th style="widows: 5%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">N°BCI</th>';
        if ($date_creation != '')
            $html .= ' <th style="widows: 7%;text-align: center;min-width: 110px" class="fixed-side" rowspan="2">D.Créat°</th>';
        if ($demandeur != '')
            $html .= '<th style="widows: 8%;text-align: center" rowspan="2">Demandeur</th>';
        if ($decision != '')
            $html .= '<th style="widows: 8%;text-align: center"  > Etat <br>Document</th>';
        if ($numero_bce != '') {
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center" rowspan="2">N°BDCRP</th>';
        }
        if ($numero_bced != '') {
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center"  rowspan="2">BDCRS</th>';
        }
        if ($montant_bced != '')
            $html .= ' <th style="widows: 4%;min-width: 110px;text-align: center"rowspan="2" >M.BDCRS</th>';

        if ($eng_budgetge != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Date Eng</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Mnt.Eng</th>';
        if ($ordonnacement != '')
            $html .= '<th style="widows: 9%;min-width: 110px;text-align: center"rowspan="2">Date Ord.</th>'
                    . '<th style="widows: 9%;min-width: 110px;text-align: center" rowspan="2">Mnt.Ord</th>';
        if ($fac_sys != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC S</th>';
        if ($fac_four != '')
            $html .= ' <th style="widows: 5%;min-width: 110px;text-align: center" rowspan="2">N°FAC FRS</th>';
        if ($montant_fac != '')
            $html .= ' <th style="widows: 10%;min-width: 110px;text-align: center" rowspan="2">Mnt.Fac</th>';
        if ($datepai != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Date <br> paiement</th>';
        if ($montantpaye != '')
            $html .= '<th style="widows: 8%;min-width: 110px;text-align: center" rowspan="2">Montant</th>';
        if ($banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;">Caisse</th>';

        if ($montant_banque != '')
            $html .= '<th style="widows: 8%;min-width: 110px;"rowspan="2">Montant</th>';

        $html .= '</tr>';
        $html .= '    </thead><tbody>';
        if (sizeof($documentachats) >= 1):
            foreach ($documentachats as $documentachat) :
                $bon_deponse_Provisoire = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($documentachat->getId(), 21);
                $document_achat_externe_Provisoire = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($documentachat->getId(), 21);

                if (sizeof($bon_deponse_Provisoire) >= 1) :

                    $html .= '<tr class="ligne_compte" >';
                    if ($numero_bci != '') {
                        $html .= '<td style="text-align: center;">
                             <b>' . $documentachat->getNumerodocachat() . '</b>
                </td>';
                    }

                    if ($date_creation != '') {
                        $html .= '<td style = "text-align: center" >'
                                . date('d/m/Y', strtotime($documentachat->getDatecreation())) .
                                '</td> ';
                    } else
                        $html .= '<td></td>';
                    if ($demandeur != '') {
                        if (($documentachat->getIdDemandeur() != '' && $documentachat->getIdDemandeur() != null))
                            $html .= '<td>' . $documentachat->getDemandeur() . ' </td>';
                        else
                            $html .= '<td></td>';
                    }

                    if ($decision != '') {
                        $doc_paret = Doctrine_Core::getTable('documentachat')->findByIdDocparent($documentachat->getId());

                        if (sizeof($documentachat) >= 1 && sizeof($doc_paret) == 0)
                            $html .= ' <td style="text-align: center">' . $documentachat->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';

                        else if (sizeof($doc_paret) >= 1 && sizeof($bon_deponse_Provisoire) == 0)
                            $html .= ' <td style="text-align: center">' . $doc_paret->getLast()->getEtatdocument()->getEtatdocachat() . '</td>';

                        else if (sizeof($bon_deponse_Provisoire) >= 1 && sizeof($bon_deponse_externe_difinitif) == 0)
                            $html .= ' <td style="text-align: center">' . $bon_deponse_Provisoire->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';

                        else if (sizeof($bon_deponse_externe_difinitif) >= 1 && sizeof($bon_deponse_Provisoire) >= 1)
                            $html .= ' <td style="text-align: center">' . $bon_deponse_externe_difinitif->getFirst()->getEtatdocument()->getEtatdocachat() . '</td>';
                        else
                            $html .= '<td></td>';
                    }

                    if ($numero_bce != '') {
                        if (sizeof($document_achat_externe_Provisoire) >= 1):
                            $html .= ' <td style="text-align: center">';

                            foreach ($document_achat_externe_Provisoire as $prevesoire) :
                                $html .= '<p>' . $prevesoire->getNumerodocachat() . '</p>';
                            endforeach;
                            $html .= '</td>';
                        else:
                            $html .= '<td></td>';

                        endif;
                    }
                    if ($numero_bced != '') {
                        $document_achat_externe_difinitif = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($documentachat->getId(), 2);
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) :
                                $html .= '<p>';
                                $html .= $definitif->getNumerodocachat();
                                $html .= '</p>';
                            endforeach;
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($montant_bced != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) :
                                $html .= '<p>';
                                $html .= number_format($definitif->getMntttc(), 3, ".", " ");
                                $html .= '</p>';
                            endforeach;
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($eng_budgetge != '') {
                        if (sizeof($document_achat_externe_Provisoire) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_Provisoire as $prevesoire) :
                                $piece_budget_porvisoire = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($prevesoire->getId());
                                if ($piece_budget_porvisoire && $piece_budget_porvisoire->getDocumentbudget()) :
                                    $html .= '<p>' . date('d/m/Y', strtotime($piece_budget_porvisoire->getDocumentbudget()->getDatecreation()));
                                    $html .= '</p>';
                                endif;
                            endforeach;
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                        if (sizeof($document_achat_externe_Provisoire) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_Provisoire as $prevesoire) :
                                $piece_budget_porvisoire = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($prevesoire->getId());
                                if ($piece_budget_porvisoire && $piece_budget_porvisoire->getDocumentbudget()) :
                                    $html .= '<p>';
                                    if ($piece_budget_porvisoire->getDocumentbudget()->getMnt())
                                        $html .=$piece_budget_porvisoire->getDocumentbudget()->getMnt() . '';
                                    $html .= '</p>';
                                endif;
                            endforeach;
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    if ($ordonnacement != '') {

                        if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $document_udget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($piecejoint->getIdDocumentbudget());
                                    if ($document_udget_ordanancemet) {
                                        $piece_budget = PiecejointbudgetTable::getInstance()->findOneByIdDocachatAndIdDocumentbudget($definitif->getId(), $document_udget_ordanancemet->getId());
                                        if ($piece_budget) {
                                            $html .= '<p>';
                                            $html .= date('d/m/Y', strtotime($piece_budget->getDocumentbudget()->getDatecreation()));
                                            $html .= '</p>';
//                                                            if ($piece_budget->getDocumentbudget()->getMnt())
//                                                                echo ' - ' . $piece_budget->getDocumentbudget()->getMnt();
                                        }
                                    }
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                        if (sizeof($bon_deponse_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: rigth">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $document_udget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($piecejoint->getIdDocumentbudget());
                                    if ($document_udget_ordanancemet) {
                                        $piece_budget = PiecejointbudgetTable::getInstance()->findOneByIdDocachatAndIdDocumentbudget($definitif->getId(), $document_udget_ordanancemet->getId());
                                        if ($piece_budget) {
                                            $html .= '<p>';

                                            if ($piece_budget->getDocumentbudget()->getMnt())
                                                $html .= number_format($piece_budget->getDocumentbudget()->getMntttc(), 3, ".", " ");
                                            $html .= '</p>';
                                        }
                                    }
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($fac_sys != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html .= '<p>' . $docparent_parent->getNumerodocachat();
//                                                    if ($definitif->getLignemouvementfacturation()->getFirst() && $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture())
//                                                        echo ' - ' . $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture();
//                                                    echo ' - ' . number_format($docparent_parent->getMntttc(), 3, ".", " ");
                                    $html .= '</p>';
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }


                    if ($fac_four != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html .= '<p>';
                                    if ($definitif->getLignemouvementfacturation()->getFirst() && $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture())
                                        $html .= $definitif->getLignemouvementfacturation()->getFirst()->getNumerofacture();
//                                                    echo ' - ' . number_format($docparent_parent->getMntttc(), 3, ".", " ");
                                    $html .= '</p>';
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($montant_fac != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: right">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $docparent_parent = DocumentachatTable::getInstance()->findOneByIdDocparent($definitif->getId());
                                if ($docparent_parent) {
                                    $html .= '<p>';
                                    $html .= number_format($docparent_parent->getMntttc(), 3, ".", " ");
                                    $html .= '</p>';
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }


                    if ($datepai != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: right">';
                            foreach ($document_achat_externe_difinitif as $definitif) {

                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);

                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {

                                            $html.= '<p>';

                                            $html.= date('d/m/Y', strtotime($mvts->getFirst()->getDateoperation()));
//                                                            if ($mvts->getFirst()->getDebit() != null)
//                                                                echo ' - ' . number_format($mvts->getFirst()->getDebit(), 3, ".", " ");
//                                                            else if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getCredit() != null)
//                                                                echo ' - ' . number_format($mvts->getFirst()->getCredit(), 3, ".", " ");

                                            $html.= '</p>';
                                        }
                                    }
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($montantpaye != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: right">';
                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($definitif->getId());
                                if ($piecejoint) {
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                    $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                    if ($document_budget_ordanancemet) {
                                        $id_docbudget = $document_budget_ordanancemet->getId();
                                        $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($id_docbudget);
                                        if (sizeof($mvts) >= 1 && $mvts->getFirst()->getId() != null) {
                                            $html.= '<p>';
                                            if ($mvts->getFirst()->getDebit() != null)
                                                $html.= number_format($mvts->getFirst()->getDebit(), 3, ".", " ");
                                            else if ($mvts->getFirst()->getId() != null && $mvts->getFirst()->getCredit() != null)
                                                $html.= number_format($mvts->getFirst()->getCredit(), 3, ".", " ");
                                            $html.= '</p>';
                                        }
                                    }
                                }
                            }$html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($banque != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: center">';

                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html.= '<p>';
                                        $html.= $mvts->getFirst()->getCaissesbanques();
//                                                        echo ' - ' . $mvts->getFirst()->getInstrumentpaiment();
//                                                        echo ' - ' . $mvts->getFirst()->getDebit();
                                        $html.= '</p>';
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }

                    if ($montant_banque != '') {
                        if (sizeof($document_achat_externe_difinitif) >= 1) {
                            $html .= ' <td style="text-align: right">';

                            foreach ($document_achat_externe_difinitif as $definitif) {
                                $id_docparent = $definitif->getId();
                                $piecejoint = PiecejointbudgetTable::getInstance()->findOneByIdDocachat($id_docparent);
                                if ($piecejoint)
                                    $id_document_udget_achatt = $piecejoint->getIdDocumentbudget();
                                $document_budget_ordanancemet = DocumentbudgetTable::getInstance()->findOneByIdDocumentbudget($id_document_udget_achatt);
                                if ($document_budget_ordanancemet) {

                                    $mvts = MouvementbanciareTable::getInstance()->getMouvementBCE($document_budget_ordanancemet->getId());
                                    if (sizeof($mvts) >= 1) {
                                        $html.= '<p>';
                                        $html.= $mvts->getFirst()->getDebit();
                                        $html.= '</p>';
                                    }
                                }
                            }
                            $html .= '</td>';
                        } else
                            $html .= '<td></td>';
                    }
                    $html .= '</tr>';

                endif;
            endforeach;
        else:
            $html.='<tr><td style="width: 100%;text-align: center" >Liste des Bon Dépense au Comptant Regroupe est vide </td></tr>';
        endif;
        $html .= ' </tbody>
                    </table>';
        return $html;
    }

    public function __toString() {
        return "" . $this->getNumerodocachat();
    }

    public function getAgents() {
        return $this->getDemandeur()->getLibelle();
    }

    public function getFactureOuQuittanceParBceOuBdc() {
        $html = "";
        if ($this->getIdTypedoc() == 7)
            $html = $this->getFactureParBCE();
        if ($this->getIdTypedoc() == 2)
            $html = $this->getQuitanceParBdc();
        return $html;
    }

    public function getSignatureParDocumentBCE() {
        $trouve = true;
        if ($this->getIdTypedoc() == 7 && !$this->getDatesignature())
            $trouve = false;
        return $trouve;
    }

    public function getFactureParBCE() {
        $html = "";
        if ($this->getDocumentparent())
            $document_facture = Doctrine_Core::getTable('documentachat')->findOneByIdDocparentAndIdTypedoc($this->getId(), 15);
        if ($document_facture) {
            $html = '<a href="' . url_for('sfTCPDF/Imprimerdocentre?iddoc=') . $document_facture->getId() . '" target="_blanc" >Détail: ' . $document_facture . '</a>';
        }
        return $html;
    }

    public function ReadHtmlBcExProisore(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Bon de commande externe provisoire par fournisseur</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BCEP</td>
                                    <td style="text-align:center;width: 12%;"> Date </td>
                                    <td style="text-align:center;width: 10%;">N°BCI</td>
                                    <td style="text-align:center;width: 13%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=18');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr><td style="text-align:center;font-weight:bold;font-size:16px;" colspan="7">Liste BCEP  Vide</td> </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';
        return $html;
    }

    public function ReadHtmlDemadnedeprix(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Demande de prix par fournisseur</h3>';


        //        else
        //            $date_fin = '--/--/----';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 15%;">Demande de prix</td>
                                    <td style="text-align:center;width: 12%;"> Date </td>
                                    <td style="text-align:center;width: 13%;">N°BCI</td>
                                    <td style="text-align:center;width: 45%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                    </tr>';
        $year = date('Y');


        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=8');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();

        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr><td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste Demande de prix  Vide</td> </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';


                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';
        return $html;
    }

    public function ReadHtmlBDCProisore(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Bon de Dépense au comptant provisoire par fournisseur</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BDCP</td>
                                    <td style="text-align:center;width: 12%;">
                                      Date
                                    </td>
                                      <td style="text-align:center;width: 10%;">N°BCI</td>
                                       <td style="text-align:center;width: 13%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                                  
                           
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=17');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste BDCP  Vide</td>
                        </tr>';
        else :

            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBDCRegroupePROVI(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Bon de Dépense au comptant provisoire par fournisseur</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BDCP</td>
                                    <td style="text-align:center;width: 12%;">
                                      Date
                                    </td>
                                      <td style="text-align:center;width: 10%;">N°BCI</td>
                                       
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                                  
                           
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=21');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste BDCP  Vide</td>
                        </tr>';
        else :

            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '  
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlListeContratDef(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Liste des Contrats</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 10%;">N°</td>
                                 <td style="text-align:center;width: 15%;">N°Contrat</td>
                                 <td style="text-align:center;width: 15%;"> Date</td>
                                 <td style="text-align:center;width: 15%;">N°BCI</td>
                                 <td style="text-align:center;width: 30%;">Fournisseur</td>
                                 <td style="text-align:center;width: 15%;">M.TTC</td>
                </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=20');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste des  Contrats  Vide</td>
                        </tr>';
        else :

            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getContratachat()->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getContratachat()->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getContratachat()->getMontantcontrat(), 3, ",", ".") . '</td>
                        ';


                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlListeContrat(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Liste des Contrats</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 10%;">N°</td>
                                 <td style="text-align:center;width: 15%;">N°Contrat</td>
                                 <td style="text-align:center;width: 15%;"> Date</td>
                                 <td style="text-align:center;width: 15%;">N°BCI</td>
                                 <td style="text-align:center;width: 30%;">Fournisseur</td>
                                 <td style="text-align:center;width: 15%;">M.TTC</td>
                </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=19');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste des  Contrats  Vide</td>
                        </tr>';
        else :

            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getContratachat()->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getContratachat()->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getContratachat()->getMontantcontrat(), 3, ",", ".") . '</td>
                        ';


                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBDCSysteme(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);


        $html = '<h3 style="font-size:18px;">Bon de commande externe système</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BCED</td>
                                    <td style="text-align:center;width: 12%;">
                                      Date
                                    </td>
                                      <td style="text-align:center;width: 10%;">N°BCI</td>
                                       <td style="text-align:center;width: 13%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=2');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();
        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="6">Liste BDCS  Vide</td>
                        </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';
        return $html;
    }

    public function ReadHtmlBDCRegroupeSysteme(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<h3 style="font-size:18px;">Bon de Dépense au comptant Regroupe Definitif</h3>';
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);

        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BCED</td>
                                    <td style="text-align:center;width: 12%;">
                                      Date
                                    </td>
                                      <td style="text-align:center;width: 10%;">N°BCI</td>
                                       <td style="text-align:center;width: 13%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=22');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();

        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="7">Liste BDCS  Vide</td>
                        </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';
        return $html;
    }

    public function ReadHtmlBcExsysteme(sfWebRequest $request) {
        $date_debut = $request->getParameter('datedebut', '');
        $date_fin = $request->getParameter('datefin', '');
        $idfrs = $request->getParameter('idfrs', '');
        $id_type = $request->getParameter('id_type', '');
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        //        else
        //            $date_debut = '--/--/----';
        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($idfrs)
            $frs = FournisseurTable::getInstance()->find($idfrs);
        $html = '<h3 style="font-size:18px;">Bon de commande externe système</h3>';


        // die($idfrs.'ed');
        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">';
        if ($idfrs)
            $html .= '  <b>Fournisseur :</b> ' . $frs->getCodefrs() . ' - ' . $frs->getRs() . '<br>';
        if ($date_debut != '')
            $html .= ' <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp;';
        if ($date_fin != '')
            $html .= ' <b>Au : </b> &nbsp;&nbsp;' . $date_fin;
        $html .= '   </td>
                    </tr>
                </table>&nbsp;<br>';
        $html .= '<table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                                 <td style="text-align:center;width: 5%;">N°</td>
                                     <td style="text-align:center;width: 10%;">N°BCED</td>
                                    <td style="text-align:center;width: 12%;">
                                      Date
                                    </td>
                                      <td style="text-align:center;width: 10%;">N°BCI</td>
                                       <td style="text-align:center;width: 13%;">Fournisseur</td>
                                    <td style="text-align:center;width: 10%;">M.TTC</td>
                                    <td style="text-align:center;width: 40%;">Imputation budgétaire</td>
                    </tr>';
        $year = date('Y');
        $q = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->where('d.id_typedoc=7');
        if ($date_debut != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'");

        if ($date_debut != '' && $date_fin != '')
            $q->andWhere("datecreation >= '" . $date_debut . "'")
                    ->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin != '')
            $q->andWhere("datecreation <= '" . $date_fin . "'");
        if ($date_fin == '' && $date_debut == '')
            $q->Andwhere("datecreation>='" . date('Y') . "-01-01" . "'")
                    ->Andwhere("datecreation<='" . date('Y') . "-12-31" . "'");
        if ($idfrs)
            $q->andWhere("id_frs = " . $idfrs . "");
        $documentachats = $q->execute();

        $i = 1;
        if (sizeof($documentachats) == 0) :
            $html .= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="7">Liste BCES  Vide</td>
                        </tr>';
        else :
            foreach ($documentachats as $documentachat) :
                $numero = strtoupper($documentachat->getTypedoc());
                $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

                $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $documentachat . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>';
                $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($documentachat->getId());
                if ($documents_parent->count() != 0) {
                    foreach ($documents_parent as $doc) {
                        $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                        $html .= '   <td style="text-align:center;">' . $doc_achat . '</td>';
                    }
                } else
                    $html .= '   <td style="text-align:center;">' . $documentachat->getDocumentparent() . '</td>';
                $html .= '   <td style="text-align:center;">' . $documentachat->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($documentachat->getMntttc(), 3, ",", ".") . '</td>
                        ';
                if ($documentachat->ActionSignature() != "") :
                    $html .= '<td>' . html_entity_decode($documentachat->ActionSignature()) . '</td>';
                else :
                    $html .= '<td></td>';
                endif;

                $html .= '</tr>';
                $i++;
            endforeach;
        endif;
        $html .= '</tbody></table>';
        return $html;
    }

    public function getDocumentBudgetParBceOuBdc() {
        $documentbudget = new Documentbudget();
        $piece_joint = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());

        if ($piece) {
            $piece_joint = $piece;
            if ($piece_joint->getDocumentbudget() && $piece_joint->getDocumentbudget()->getIdType() == 1)
                return $piece_joint->getDocumentbudget();
        }
        return null;
    }

    public function getQuitanceParBdc() {

        $html = "";
        $operation = Doctrine_Core::getTable('ligneoperationcaisse')->findOneByIdDocachatAndIdCategorie($this->getId(), 2);
        if ($operation) {
            $html = '<a href="' . url_for('sfTCPDF/detailpreengagement?id=') . $operation->getIdDocachat() . '&idoperation=' . $operation->getId() . '" target="_blanc" >Détail: ' . $operation->getObjet() . '</a>';
        }
        return $html;
    }

    public function getListesBdcDefinitifNonEncoreValider() {
        $pieces = Doctrine_Query::create()
                ->select('p.id_docachat as id')
                ->from('piecejointbudget p')
                ->where('id_type is not  null')
                ->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);
        if (count($pieces) > 0) {
            $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->where(' id_typedoc=2 or id_typedoc=7 ')
                    ->andWhere('a.datesignature IS NOT NULL')
                    ->andWhere('a.id_etatdoc = 27 ');
            //                     ->andWhere(' a.id NOT IN '
            //                        . '(SELECT piecejointbudget.id_docachat'
            //                        . ' FROM piecejointbudget '
            //                        . 'WHERE id_type is   null )');
            //                    ->AndWhereNotIn('id', $pieces);
            // die($doc_bci_non_imputer);
            return $doc_bci_non_imputer;
        } else
            return null;
    }

    public function getListesBdcDefinitifNonEncoreValiderContrat() {
        $pieces = Doctrine_Query::create()
                ->select('p.id_docachat as id')
                ->from('piecejointbudget p')
                ->where('id_type is not  null  ')
                ->execute(array(), Doctrine::HYDRATE_SINGLE_SCALAR);
        //        die($pieces);
        //        die(count($pieces).'pml');
        if (count($pieces) > 0) {
            $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->where(' id_typedoc=20')
                    ->andwhere('id not in (select id_docachat from  piecejointbudget where id_type=1)')
            //                    ->AndWhereNotIn('id', $pieces);
            ;
            //             die($doc_bci_non_imputer);
            return $doc_bci_non_imputer;
        } else
            return null;
    }

    public function getListesBdcpNonImputercontrat() {

        $year = $_SESSION['exercice_budget'];
        $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->leftJoin('a.Contratachat c')
                ->whereIn('a.id_typedoc', array(19))
                ->andWhere('a.id_etatdoc=20')
                ->andWhere(' a.id NOT IN '
                        . '(SELECT piecejointbudget.id_docachat'
                        . ' FROM piecejointbudget '
                        . 'WHERE (piecejointbudget.id_type = 4 or  piecejointbudget.id_type = 5)'
                        . ' and piecejointbudget.id_docachat=a.id  ) ')
                ->andWhere('a.etatdocachat is null')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'");
        //                ->AndWhereNotIn('id', $pieces)
        //                ->andWhere('c.id =a.id_contrat')
        //                ->andWhere('id_contrat is not null')
        //         die($doc_bci_non_imputer);
        return $doc_bci_non_imputer;
    }

    public function getListesBdcpNonImputerBDC() {

        $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc =17 ')
                ->andWhere('a.id_etatdoc = 59')
        //                ->andWhere(' a.id NOT IN '
        //                . '(SELECT piecejointbudget.id_docachat'
        //                . ' FROM piecejointbudget '
        //                . 'WHERE (piecejointbudget.id_type = 4 or  piecejointbudget.id_type = 5) and '
        //                . 'piecejointbudget.id_docachat=a.id  ) ')
        //                ->andWhere('a.id in (select  ligneoperationcaisse.id_docachat from ligneoperationcaisse'
        //                        . ' where ligneoperationcaisse.id_docachat=a.id and ligneoperationcaisse.id_categorie=2) ')
        ;

        return $doc_bci_non_imputer;
    }

    public function getListesBdcpNonImputer() {
        $year = date('Y');
        $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc =17 or id_typedoc=18')
                ->andWhere("trim(a.etatdocachat) is null or trim(a.etatdocachat) = '' ")
                ->andWhere(' a.id NOT IN '
                        . '(SELECT piecejointbudget.id_docachat'
                        . ' FROM piecejointbudget '
                        . 'WHERE (piecejointbudget.id_type = 4 or  piecejointbudget.id_type = 5) and '
                        . 'piecejointbudget.id_docachat=a.id  ) ')
                ->andWhere("a.mntttc != " . 0.000 . " and a.mntttc != " . "'NAN'")
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'");
        //die($doc_bci_non_imputer);

        return $doc_bci_non_imputer;
    }

    public function getListesBdcpNonImputerNULL() {

        $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc =17 ')
                ->andWhere('id_etatdoc =56 ')
                ->andWhere(' a.id NOT IN '
                . '(SELECT piecejointbudget.id_docachat'
                . ' FROM piecejointbudget '
                . 'WHERE ( piecejointbudget.id_type = 5) and '
                . 'piecejointbudget.id_docachat=a.id  ) ');

        return $doc_bci_non_imputer;
    }

    public function getListesBdcpNonImputerBDCRegroupe() {
        //        $pieces = Doctrine_Query::create()
        //                ->select('p.id_docachat as id')
        //                ->from('piecejointbudget p')
        //                ->execute(array(), Doctrine::HYDRATE_SINGLE_SCALAR);

        $doc_bci_non_imputer = Doctrine::getTable('documentachat')
                ->createQuery('a')
                ->whereIn('id_typedoc', array(22))
                ->andWhere('id_etatdoc=63')
        // ->AndWhereNotIn('id', $pieces)
        ;
        // die($doc_bci_non_imputer.'pm');
        return $doc_bci_non_imputer;
    }

    public function getListesBdcpNonImputerBDCR() {
        $pieces = Doctrine_Query::create()
                ->select('p.id_docachat as id')
                ->from('piecejointbudget p')
                ->execute(array(), Doctrine::HYDRATE_SINGLE_SCALAR);

        $doc_bci_non_imputer = Doctrine::getTable('documentachat')
                ->createQuery('a')
                ->whereIn('id_typedoc', array(21))
                ->AndWhereNotIn('id', $pieces);
        //         die($doc_bci_non_imputer.'pm');
        return $doc_bci_non_imputer;
    }

    public function getNumeroChiffree() {
        return sprintf('%06d', $this->getNumero());
    }

    public function getNumerodocachat() {
        if ($this->getTypedoc()->getId() != 19 && $this->getTypedoc()->getId() != 20)
            return $this->getTypedoc()->getPrefixetype() . ' ' . sprintf('%05d', $this->getNumero());
        else
            return 'BCI N° ' . sprintf('%05d', $this->getNumero()) . '( ' . $this->getTypedoc()->getPrefixetype() . ' : ' . $this->getContratachat()->getReference() . ' )';
    }

    public function getNumerodocumentachat() {

        return trim($this->getTypedoc()->getPrefixetype()) . '  ' . sprintf('%05d', $this->getNumero());
    }

    public function getNumerocontrat() {

        return $this->getTypedoc()->getPrefixetype() . ' ' . sprintf('%05d', $this->getNumero());
    }

    public function getNumeroDemandedeprix() {
        if ($this->getNumerooperation())
            return sprintf('%06d', $this->getNumero()) . '/' . $this->getNumerooperation();
        else
            return sprintf('%06d', $this->getNumero());
    }

    public function getNumeroBonCommandeInterne($iddocparent) {
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        return sprintf('%06d', $docachat->getNumero());
    }

    public function getNumeroSeqDemandeDePrixParBCI($iddocparent) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 8);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . sprintf('%02d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function getNumeroSeqDemandeDePrixParBCIDD($iddoc) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdAndIdTypedoc($iddoc, 8);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddoc);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . sprintf('%02d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function getNumeroSeqDemandeDePrixParBCIDDSansopertaion($iddoc) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdAndIdTypedoc($iddoc, 8);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddoc);
        $Ndemandedeprix = sprintf('%06d', $docachat->getNumeroChiffree());

        return $Ndemandedeprix;
    }

    public function getNumeroBDCPParBCI($iddocparent) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 17);
        $BDCD = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 2);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . count($BDCD) + 1 . sprintf('%02d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function getNumeroFactureParBCI($iddocparent) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 15);
        $BDCD = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 15);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . count($BDCD) + 1 . sprintf('%02d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function getNumeroContart($iddocparent) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 19);
        $BDCD = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 2);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . count($BDCD) + 1 . sprintf('%02d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function getNumeroBDCDParBCI($iddocparent) {
        $demande_de_prix = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($iddocparent, 2);
        $docachat = Doctrine_Core::getTable('documentachat')->findOneById($iddocparent);
        $Ndemandedeprix = sprintf('%08d', $docachat->getNumeroChiffree() . sprintf('%01d', count($demande_de_prix) + 1));

        return $Ndemandedeprix;
    }

    public function NumeroSeqDocumentAchat($idtype, $year = "") {
        if ($year == "")
            $year = date('Y');
        //        $doc = Doctrine_Core::getTable('documentachat')->findByIdTypedoc($idtype);
        //        $doc = DocumentachatTable::getInstance()->getLastBciByYear($year);
        //        $type = TypedocTable::getInstance()->find($idtype);
        //        if ($type->getPrefixevaleur() && !$doc) {
        //            return sprintf('%05d', $type->getPrefixevaleur());
        //        }
        //        if ($doc || (!$type->getPrefixevaleur() && !$doc)) {
        $doc = Doctrine_Query::create()
                ->select('COALESCE(MAX(a.numero), 0) as numero')
                ->from('documentachat a')
                ->where('id_typedoc = ' . $idtype)
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->execute();

        return sprintf('%05d', $doc[0]['numero'] + 1);
        //        }
    }

    /*     * * fin functions ** */

    public function getTotalQte() {
        $qte = 0;
        $lignedoc = new Lignedocachat();
        $liste = Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        foreach ($liste as $l) {
            $lignedoc = $l;
            $qte += $lignedoc->getQte();
        }
        return $qte;
    }

    public function ExisteFacture() {
        $existe = NULL;
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneByIdDocparentAndIdTypedoc($this->getId(), 15);
        if ($documentachat)
            return $documentachat;
        return $existe;
    }

    public function ValidationEngagement() {
        $validation = 0;

        $piecevalidation = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($this->getId());
        foreach ($piecevalidation as $p) {
            $docbudget = Doctrine_Core::getTable('documentbudget')->findOneById($p->getIdDocumentbudget());
            if ($docbudget && $docbudget->getIdType() == 1 && $this->getIdTypedoc() != 2) {
                $validation = 1;
            }
        }
        if ($this->getIdTypedoc() == 2) {

            $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
            if ($piece) {
                if ($piece->getDocumentbudget()->getMnt() && $piece->getDocumentbudget()->getMnt() > 0) {

                    $validation = 1;
                }
            }
        }
        return $validation;
    }

    public function ValidationEngagementContrat() {
        $validation = 0;

        $piecevalidation = Doctrine_Core::getTable('piecejointbudget')->findByIdDocachat($this->getId());
        foreach ($piecevalidation as $p) {
            $docbudget = Doctrine_Core::getTable('documentbudget')->findOneById($p->getIdDocumentbudget());
            if ($docbudget && $docbudget->getIdType() == 1 && $this->getIdTypedoc() != 20) {
                $validation = 1;
            }
        }
        if ($this->getIdTypedoc() == 20) {

            $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
            if ($piece) {
                if ($piece->getDocumentbudget()->getMnt() && $piece->getDocumentbudget()->getMnt() > 0) {

                    $validation = 1;
                }
            }
        }
        return $validation;
    }

    public function getQteBceoubdc() {
        $qte = 0;
        $lignedoc = new Lignedocachat();
        $liste = Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        foreach ($liste as $l) {
            $lignedoc = $l;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lignedoc->getId());
            if ($qteligne)
                $qte += $qteligne->getQtelivrefrs();
        }
        return $qte;
        $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
    }

    public function getQteLivreeParFournisseur($idligne) {
        $qte = 0;

        $qtelivree = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($idligne);
        if ($qtelivree)
            $qte = $qtelivree->getQtelivrefrs();
        return $qte;
    }

    public function getDatecreationachat() {
        $date = date('d-m-Y', strtotime(date('d-m-Y', strtotime($this->getDatecreation()))));
        return $date;
    }

    public function getBonCommandeInterne() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $numero = strtoupper($documentachat->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $html = '';

        $html .= '<div>
                    <div class="titre">
                        <h3>' . $numero . ' N°: ' . $documentachat->getNumerodocachat() . '</h3>
                    </div>
                    <div> 
                        <table style="width:100%;">
                            <tr>
                                <td><span>Nom et Prénom du demandeur</span></td>
                                <td style="border-bottom: 1px dashed #000000"><h6>' . $documentachat->getAgents() . '</h6></td>
                            </tr>
                            <tr>
                                <td><span>Date création</span></td>
                                <td style="border-bottom: 1px dashed #000000;"><h6>' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</h6></td> 
                           </tr>
                        </table>
                     </div>
                <div>
                <table>
                    <tr>
                    <td style="width: 65%"></td>
                    <td>
                        <table class="tableclass" style="margin-bottom:0px;">
                            <tr>
                                <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                            </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div  style="font-size: 20px">X</div>';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";
            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>
            </div>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '
            <div>
                <table class="tableligne">
                    <tr>
                        <th style="width: 40px"></th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px">QTE.</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px">P.E.<br>Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px">P.A.<br>Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td>' . $lg->getDesignationarticle() . '</td>
                        <td>' . $qtedemander . '</td>
                        <td>Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
                </table>
            </div>
        </div>';
        $html .= '<div></div> ';

        return $html;
    }

    public function getTypeparnumero() {
        return $this->getTypedoc() . ' N°:' . $this->getNumerodocachat();
    }

    public function getDocumentparent() {
        $documentparent = null;
        if ($this->getIdDocparent())
            $documentparent = Doctrine_Core::getTable('documentachat')->findOneById($this->getIdDocparent());
        return $documentparent;
    }

    public function ExporterBudgetVersBdC($idfils) {
        //die($idfils.'rcf'.$this->getId());
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
        if ($piece) {
            $p = $piece;
            $piecedefinitif = new Piecejointbudget();
            $documentbudget_definitif = new Documentbudget();
            if ($this->getId() != null)
                $piece_budget_def = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
            else
                $piece_budget_def = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
            if ($piece_budget_def) {
                $piecedefinitif = $piece_budget_def;
                $doc_b_d == Doctrine_Core::getTable('documentbudget')->findOneById($piecedefinitif->getIdDocumentbudget());
                if ($doc_b_d)
                    $documentbudget_definitif = $doc_b_d;
            }
            $documentbudget_definitif->setNumero($documentbudget_definitif->NumeroSeqDocumentAchat(1));
            $documentbudget_definitif->setIdType(1);
            $documentbudget_definitif->setIdBudget($p->getDocumentbudget()->getLigprotitrub()->getId());
            $documentbudget_definitif->setDatecreation(date('Y-m-d'));
            $documentbudget_definitif->save();
            if ($this->getId() != null)
                $piecedefinitif->setIdDocachat($this->getId());
            else
                $piecedefinitif->setIdDocachat($idfils);
            $piecedefinitif->setIdDocumentbudget($documentbudget_definitif->getId());
            $piecedefinitif->save();
        }
    }

    public function ExporterBudgetVersBdCNULL($idfils) {
        //die($idfils.'rcf'.$this->getId());
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
        if ($piece) {
            $p = $piece;
            $piecedefinitif = new Piecejointbudget();
            $documentbudget_definitif = new Documentbudget();
            //            if ($this->getId() != null)
            //                $piece_budget_def = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
            //            else
            //                $piece_budget_def = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
            //            if ($piece_budget_def) {
            //                $piecedefinitif = $piece_budget_def;
            //                $doc_b_d == Doctrine_Core::getTable('documentbudget')->findOneById($piecedefinitif->getIdDocumentbudget());
            //                if ($doc_b_d)
            //                    $documentbudget_definitif = $doc_b_d;
            //            }
            $documentbudget_definitif->setNumero($documentbudget_definitif->NumeroSeqDocumentAchat(1));
            //            $documentbudget_definitif->setIdType(1);
            //            $documentbudget_definitif->setIdBudget($p->getDocumentbudget()->getLigprotitrub()->getId());
            $documentbudget_definitif->setDatecreation(date('Y-m-d'));
            $documentbudget_definitif->save();
            if ($this->getId() != null)
                $piecedefinitif->setIdDocachat($this->getId());
            //            else
            //                $piecedefinitif->setIdDocachat($idfils);
            $piecedefinitif->setIdDocumentbudget($documentbudget_definitif->getId());
            $piecedefinitif->save();
        }
    }

    public function ExporterBudgetVersContratD($idfils) {

        $p = new Piecejointbudget();
        $doc_b_d = new Documentbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
        //         die($piece->getId().'id=');
        if ($piece) {
            $p = $piece;
            $piecedefinitif = new Piecejointbudget();
            $documentbudget_definitif = new Documentbudget();
            $piece_budget_def = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($idfils);
            if ($piece_budget_def) {
                $piecedefinitif = $piece_budget_def;
                $id_budget = $piecedefinitif->getIdDocumentbudget();

                //                die($id_budget.'id_b');
                $doc_b_d == Doctrine_Core::getTable('documentbudget')->findOneById($id_budget);
                //                die(count($doc_b_d)."ppp");
                //                $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
                //                $query = "SELECT documentbudget.id as id "
                //                        . "FROM  documentbudget "
                //                        . "WHERE documentbudget.id =  " . $id_budget
                //                ;
                //                $resultat = $conn->fetchAssoc($query);
                //                $doc_b_d=$resultat->getId();
                //                die(json_encode($resultat) . 'mp');

                if ($doc_b_d)
                    $documentbudget_definitif = $doc_b_d;
            }
            $documentbudget_definitif->setNumero($documentbudget_definitif->NumeroSeqDocumentAchat(1));
            $documentbudget_definitif->setIdType(1);
            $documentbudget_definitif->setIdBudget($p->getDocumentbudget()->getLigprotitrub()->getid());
            $documentbudget_definitif->setDatecreation(date('Y-m-d'));
            $documentbudget_definitif->save();

            $piecedefinitif->setIdDocachat($idfils);
            $piecedefinitif->setIdDocumentbudget($documentbudget_definitif->getId());
            $piecedefinitif->save();
            //            die($piecedefinitif->getId());
        }
    }

    //ajouter signature ou non
    public function ActionSignature() {
        $html = "";

        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());

        if ($piece) {
            $p = $piece;
            return $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }

        return $html;
    }

    public function ActionSignatureContrat($iddoc) {
        $html = "";

        $p = new Piecejointbudget();
        //        die($this->getId().'id=');
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($iddoc);

        if ($piece) {
            $p = $piece;
            return $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }

        return $html;
    }

    public function TestValidExportEnPv() {
        $qte = 0;
        $query = "SELECT  lignedocachat.id_doc,  qtelignedoc.qtelivrefrs,    qtelignedoc.qtedemander,    lignedocachat.codearticle,  "
                . "  lignedocachat.designationarticle,    lignedocachat.mntttc,    lignedocachat.pu "
                . "FROM    lignedocachat,    qtelignedoc "
                . "WHERE    qtelignedoc.id_lignedocachat = lignedocachat.id   and  id_doc=" . $this->getId();

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $listesdocs = $conn->execute($query);

        foreach ($listesdocs as $lignedoc) {
            $qte = $qte + ($lignedoc['qtelivrefrs'] - $lignedoc['qtedemander']);
        }
        if ($qte > 0)
            return true;
        return false;
    }

    public function getTransfertPv() {

        $html = "";
        if ($this->getIdTypedoc() == 7) {
            $html = $this->ReadHtmlBonexterne();
        }
        if ($this->getIdTypedoc() == 2) {
            $html = $this->ReadHtmlBondeponse();
        }

        if ($this->TestValidExportEnPv()) {
            $html .= "<a class=transform_a class=btn href=" . url_for('documentachat/new?iddocparent=') . $this->getId() . '&idtype=10' . ">Transfert EN PV de réception</a>";
        }
        $html .= "<a class=print_a class=btn href=" . url_for('Documents/detail?id=') . $this->getId() . ">Détail et Impression</a>"
                . "</div>";

        return $html;
    }

    public function getTransfertBonSortie() {
        $qte = 0;

        $query = "SELECT  lignedocachat.id_doc, qtelignedoc.qtelivrefrs, qtelignedoc.qtedemander, lignedocachat.codearticle, "
                . "  lignedocachat.designationarticle, lignedocachat.mntttc, lignedocachat.pu "
                . "FROM  lignedocachat, qtelignedoc "
                . "WHERE qtelignedoc.id_lignedocachat = lignedocachat.id  and  id_doc=" . $this->getId();

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $listesdocs = $conn->execute($query);
        $html = '<table>
                    <tr style="background-color: #F0F0F0;">
                        <th style="text-align: center; width: 20%;">QteDemander</th>
                        <th style="text-align: center; width: 25%;">CodeArticle</th>
                        <th style="width: 55%;">Designation</th>
                    </tr>';
        foreach ($listesdocs as $lignedoc) {
            $qte = $qte + ($lignedoc['qtelivrefrs'] - $lignedoc['qtedemander']);
            $html .= '<tr>
                        <td style="text-align: center;">' . $lignedoc['qtedemander'] . '</td>
                        <td style="text-align: center;">' . $lignedoc['codearticle'] . '</td>
                        <td>' . $lignedoc['designationarticle'] . '</td>
                    </tr>';
        }
        $html .= '</table><div style="margin-left: 1%;">';
        if ($this->getMntTTCDocument() == "") {
            $html .= ""
                    . "<a class=transform_a href=" . url_for('documentachat/new?iddocparent=') . $lignedoc['id_doc'] . '&idtype=11' . ">Tranfert Vers Bon de Sortie</a>";
        }
        $html .= " <a class=print_a href=" . url_for('Documents/detail?id=') . $lignedoc['id_doc'] . ">Détail et Impression</a>"
                . "</div>";

        return $html;
    }

    public function getMntTTCDocument() {
        $doc = new Documentachat();
        $mnt = '';

        $doctrasnfert = Doctrine_Core::getTable('documentachat')->findOneByIdDocparentAndIdTypedoc($this->getId(), 11);
        if ($doctrasnfert) {
            $doc = $doctrasnfert;
            $mnt = number_format($doc->getMntttc(), 3, '.', ',') . ' TND <br>Bon de Sortie:' . $doc->getNumerodocachat();
        }

        return $mnt;
    }

    public function getTiers() {
        if ($this->getIdFrs())
            return "Fournisseur: " . $this->getFournisseur();
        if ($this->getIdDemandeur()) {
            return "Demandeur: " . $this->getAgents();
        }
    }

    public function getTiersPrint() {
        if ($this->getIdFrs())
            return "<b>Fournisseur :</b> " . $this->getFournisseur()->getRs();
        if ($this->getIdDemandeur()) {
            return "<b>Demandeur :</b> " . $this->getAgents();
        }
    }

    //______________________________________________________________________________Impression document
    public function getHtmlDemandedeprix() {
        $html = "";
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $adresse_frs = "";
        $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
        if ($adrs)
            $adresse_frs = $adrs;
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($affiche_document_parent == "")
                $affiche_document_parent .= $doc_achat->getNumerodocachat();
            else
                $affiche_document_parent .= "<br>" . $doc_achat->getNumerodocachat();
        }
        $html .= '<div class="contenue">            
                <div>
                    <table  style="float: left">
                        <tr>
                            <td style="width: 60%">
                                <table cellpadding="2">
                                 <tr>
                                        <td style="width: 48%;font-size:12px;font-weight:bold;">DEMANDE DE PRIX N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;font-size:12px;font-weight:bold;"><p>' . $this->getNumerodossier() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">DPS N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $this->getNumeroDemandedeprix() . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">Objet </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $this->getObservation() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td>BCI système N°</td>
                                        <td>:</td>
                                        <td><p>' . $affiche_document_parent . '</p></td>
                                    </tr>
                                  
                                    <tr>
                                        <td>Date de création</td>
                                        <td>:</td>
                                        <td><p>' . date('d-m-Y', strtotime($this->getDatecreation())) . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">Lieu de livraison </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $this->getLieulivraisson() . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">B.C.I </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $this->getDocumentparent()->getReference() . '</p></td>
                                    </tr>
                                    <tr>
                                    <td colspan="3" style="border-right: solid 2px black">
                                    <p style="text-align:justify;">
                                        J\'ai l\'honneur de vous prier vouloir me faire connaitre vos meilleurs conditions pour la fourniture éventuelle
                                        des marchandises (ou travaux) désignées ci-dessous, A cet effet  vous voudrez bien compléter  la présente formule et me la renvoyer  dans un délai de <b>' . $this->getDelaifrs()
                . ' jour(s).</b> <br> DATE  LIMITE DE REPONSE LE :<b>' . date('d-m-Y', strtotime($this->getMaxreponsefrs())) . '</b>.
                                    </p>
                                    <p style="text-align: center">
                                        Sce.Appro
                                    </p>
                                    </td>                                        
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 40%">
                            <table cellpadding="2">
                               <tr>
                                    <td>
                                        <table style="border: 2px dashed #000000;padding:2%;">
                                            <tr>
                                                <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison social ou matricule fiscal du fournisseur consulté</p></td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="text-aling:center">
                                                  ' . $this->getFournisseur() . '<br>' . $this->getFournisseur()->getActivitetiers() . '
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Adresse</td>
                                                <td>' . $adresse_frs . '</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>Fax:  ' . $fournisseur->getGsm() . '</td>
                                            </tr>
                                        </table>
                                    </td>                                           
                                </tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="3">
                                        <p style="text-align:justify;">
                                            Je m\'engage à livrer aux conditions demandées les marchandises cotées 
                                            par moi ci-dessous<br> Le .......................
                                        </p>
                                        <p style="text-align: center">
                                            Signature et Cachet du Fournisseur
                                        </p>
                                    </td>
                                </tr>
                            </table>
            </td>
        </tr>
    </table>
</div>
<div></div>
    <table cellspacing="0" cellpadding="3" border="1">
        <thead> 
          <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
            <th style="text-align:center;width: 5%">N°</th>
            <th style="text-align:center;width: 25%">DESIGNATION</th>
            <th style="text-align:center;width: 10%">Qte</th>
            <th style="text-align:center;width: 15%">P.Unit.<br>H.T</th>
            <th style="text-align:center;width: 15%">Taux<br>T.V.A</th>
            <th style="text-align:center;width: 30%">Observations</th>
        </tr>
        </thead>
        ';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        // Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $i = 0;
        $class = "secondtd";
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQteaachat();
            //class="' . $class . '"
            $html .= ' <tr>
                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                    <td style="text-align:center;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 10%">' . $qte . '<br> ' . $lignedoc->getUnitedemander() . '</td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 30%">' . $lignedoc->getObservation() . '</td>
                                   
                                </tr>';
            $nordre++;
        }

        $html .= '
            </table>
        
    </div><DIV STYLE="page-break-before:always"></DIV> ';
        $fournisseur = $this->getFournisseur();
        $rtl_chars_pattern = '/[\x{0590}-\x{05ff}\x{0600}-\x{06ff}]/u';
        if (preg_match($rtl_chars_pattern, $fournisseur))
            $fournisseur = '<span style="direction:rtl;">     ' . $fournisseur . ' : par remplie prix de Demande -</span>';
        else
            $fournisseur = "<span>     - Demande de prix remplie par : " . $fournisseur . "</span>";

        $html .= '<style>
                p{font-size: 16px;}
                </style>';
        $html .= "<h2>Conditions Administratives</h2>
                    <p>
                    L’offre du fournisseur doit parvenir à L’ODRM portant la mention     
                    « Demande de prix N°" . $this->getNumerodossier() . "» Acquisition (" . $this->getObservation() . ")
                       </p> 
                     <p>  
                    Le dernier délai de la remise des offres est fixé au: " . date('d/m/Y', strtotime($this->getMaxreponsefrs())) . "</p>
                    <p>  <span>  •	Le cachet du bureau d'ordre fait foi.</span></p>
                    <p>  <span>  •	Le prix doit etre ferme et non révisable.</span></p>
                    <p>  <span>  •	Le choix se fait par article conforme et moins disant.</span> </p>
                    <p>  <span>  •	Copie de la patente.</span> </p>
                    <p>  <span>  •        Copie du registre de commerce</span> </p>
                    <p>  <span>  •	Mode de paiement : par virement.</span> </p>
                    <p>  <span>  •	Le fournisseur est tenu d’indiquer :</span></p>
                    <p>  <span>  •	La validité de l’offre……………………………………….</span></p>
                    <p>  <span>  •	Le délai de livraison……………………………………........</span></p>
                    <p>   	REMARQUE:</p>
                    <p>             •	Le fournisseur doit obligatoirement respecter les clauses suivantes :</p>
                      <p>                 " . $fournisseur . "</p>
                        <p>                <span>    - Sa qualité :……………………………………………………………….</span></p>
                       <p>           A défaut votre offre sera automatiquement refusée.<br>
                        N.B: Toute offre portant des surcharges, des ratures ou correcteur sera écartée.</p>";
        return $html;
    }

    public function getHtmlListeDemandedeprix($iddoc, $demandedeprix) {
        $html = "";
        foreach ($demandedeprix as $dmeande) :
            $fournisseur = new Fournisseur();
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($dmeande->getIdFrs());
            $fournisseur = $frs;
            $adresse_frs = "";
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($dmeande->getIdFrs());
            if ($adrs)
                $adresse_frs = $adrs;
            $affiche_document_parent = "";
            $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($dmeande->getId());
            foreach ($documents_parent as $doc) {
                $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                if ($affiche_document_parent == "")
                    $affiche_document_parent .= $doc_achat->getNumerodocachat();
                else
                    $affiche_document_parent .= "<br>" . $doc_achat->getNumerodocachat();
            }
            $html .= '<div class="contenue">            
                <div>
                    <table  style="float: left">
                        <tr>
                            <td style="width: 60%">
                                <table cellpadding="2">
                                 <tr>
                                        <td style="width: 48%;font-size:12px;font-weight:bold;">DEMANDE DE PRIX N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;font-size:12px;font-weight:bold;"><p>' . $dmeande->getNumerodossier() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">DPS N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $dmeande->getNumeroDemandedeprix() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">Objet </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $dmeande->getObservation() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td>BCI système N°</td>
                                        <td>:</td>
                                        <td><p>' . $affiche_document_parent . '</p></td>
                                    </tr>
                                  
                                    <tr>
                                        <td>Date de création</td>
                                        <td>:</td>
                                        <td><p>' . date('d-m-Y', strtotime($dmeande->getDatecreation())) . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">Lieu de livraison </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $dmeande->getLieulivraisson() . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">B.C.I </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $dmeande->getDocumentparent()->getReference() . '</p></td>
                                    </tr>
                                     <tr>
                                    <td colspan="3" style="border-right: solid 2px black">
                                    <p style="text-align:justify;">
                                        J\'ai l\'honneur de vous prier vouloir me faire connaitre vos meilleurs conditions pour la fourniture éventuelle
                                        des marchandises (ou travaux) désignées ci-dessous, A cet effet  vous voudrez bien compléter  la présente formule et me la renvoyer  dans un délai de <b>' . $dmeande->getDelaifrs()
                    . ' jour(s).</b> <br> DATE  LIMITE DE REPONSE LE :<b>' . date('d-m-Y', strtotime($dmeande->getMaxreponsefrs())) . '</b>.
                                    </p>
                                    <p style="text-align: center">
                                        Sce.Appro
                                    </p>
                                    </td>                                        
                                    </tr>
</table></td>

<td style="width: 40%">
                            <table cellpadding="2">
                               <tr>
                                    <td>
                                        <table style="border: 2px dashed #000000;padding:2%;">
                                            <tr>
                                                <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison social ou matricule fiscal du fournisseur consulté</p></td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="text-aling:center">
                                                  ' . $dmeande->getFournisseur() . '<br>' . $dmeande->getFournisseur()->getActivitetiers() . '
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Adresse</td>
                                                <td>' . $adresse_frs . '</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>Fax:  ' . $fournisseur->getGsm() . '</td>
                                            </tr>
                                        </table>
                                    </td>                                           
                                </tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="3">
                                        <p style="text-align:justify;">
                                            Je m\'engage à livrer aux conditions demandées les marchandises cotées 
                                            par moi ci-dessous<br> Le .......................
                                        </p>
                                        <p style="text-align: center">
                                            Signature et Cachet du Fournisseur
                                        </p>
                                    </td>
                                </tr>
                            </table>
            </td>
</tr></table></div>
<div></div>
 <table cellspacing="0" cellpadding="3" border="1">
        <thead> 
          <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
            <th style="text-align:center;width: 5%">N°</th>
            <th style="text-align:center;width: 25%">DESIGNATION</th>
            <th style="text-align:center;width: 10%">Qte</th>
            <th style="text-align:center;width: 15%">P.Unit.<br>H.T</th>
            <th style="text-align:center;width: 15%">Taux<br>T.V.A</th>
            <th style="text-align:center;width: 30%">Observations</th>
        </tr>
        </thead>
        ';
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $dmeande->getId())->orderBy('id asc')->execute();
            $i = 0;
            $class = "secondtd";
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $var = $i % 2;
                // die($var.'hh');
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQteaachat();
                //class="' . $class . '"
                $html .= ' <tr>
                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                    <td style="text-align:center;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 10%">' . $qte . '<br> ' . $lignedoc->getUnitedemander() . '</td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 30%">' . $lignedoc->getObservation() . '</td>
                                   
                                </tr>';
                $nordre++;
            }

            $html .= '
            </table>
</div><DIV STYLE="page-break-before:always"></DIV> ';
        endforeach;
        return $html;
    }

    public function getHtmlListeDemandedeprixAvecConditions($iddoc, $demandedeprix) {
        $html = "";
        foreach ($demandedeprix as $dmeande) :
            $fournisseur = new Fournisseur();
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($dmeande->getIdFrs());
            $fournisseur = $frs;
            $adresse_frs = "";
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($dmeande->getIdFrs());
            if ($adrs)
                $adresse_frs = $adrs;
            $affiche_document_parent = "";
            $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($dmeande->getId());
            foreach ($documents_parent as $doc) {
                $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
                if ($affiche_document_parent == "")
                    $affiche_document_parent .= $doc_achat->getNumerodocachat();
                else
                    $affiche_document_parent .= "<br>" . $doc_achat->getNumerodocachat();
            }
            $html .= '<div class="contenue">            
                <div>
                    <table  style="float: left">
                        <tr>
                            <td style="width: 60%">
                                <table cellpadding="2">
                                 <tr>
                                        <td style="width: 48%;font-size:12px;font-weight:bold;">DEMANDE DE PRIX N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;font-size:12px;font-weight:bold;"><p>' . $dmeande->getNumerodossier() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">DPS N° </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $dmeande->getNumeroDemandedeprix() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td style="width: 48%">Objet </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%"><p>' . $dmeande->getObservation() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td>BCI système N°</td>
                                        <td>:</td>
                                        <td><p>' . $affiche_document_parent . '</p></td>
                                    </tr>
                                  
                                    <tr>
                                        <td>Date de création</td>
                                        <td>:</td>
                                        <td><p>' . date('d-m-Y', strtotime($dmeande->getDatecreation())) . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">Lieu de livraison </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $dmeande->getLieulivraisson() . '</p></td>
                                    </tr>
                                     <tr>
                                        <td style="width: 48%">B.C.I </td>
                                        <td style="width: 4%">:</td>
                                        <td style="width: 47%;"><p>' . $dmeande->getDocumentparent()->getReference() . '</p></td>
                                    </tr>
                                     <tr>
                                    <td colspan="3" style="border-right: solid 2px black">
                                    <p style="text-align:justify;">
                                        J\'ai l\'honneur de vous prier vouloir me faire connaitre vos meilleurs conditions pour la fourniture éventuelle
                                        des marchandises (ou travaux) désignées ci-dessous, A cet effet  vous voudrez bien compléter  la présente formule et me la renvoyer  dans un délai de <b>' . $dmeande->getDelaifrs()
                    . ' jour(s).</b> <br> DATE  LIMITE DE REPONSE LE :<b>' . date('d-m-Y', strtotime($dmeande->getMaxreponsefrs())) . '</b>.
                                    </p>
                                    <p style="text-align: center">
                                        Sce.Appro
                                    </p>
                                    </td>                                        
                                    </tr>
</table></td>

<td style="width: 40%">
                            <table cellpadding="2">
                               <tr>
                                    <td>
                                        <table style="border: 2px dashed #000000;padding:2%;">
                                            <tr>
                                                <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison social ou matricule fiscal du fournisseur consulté</p></td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="text-aling:center">
                                                  ' . $dmeande->getFournisseur() . '<br>' . $dmeande->getFournisseur()->getActivitetiers() . '
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Adresse</td>
                                                <td>' . $adresse_frs . '</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>Fax:  ' . $fournisseur->getGsm() . '</td>
                                            </tr>
                                        </table>
                                    </td>                                           
                                </tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="3">
                                        <p style="text-align:justify;">
                                            Je m\'engage à livrer aux conditions demandées les marchandises cotées 
                                            par moi ci-dessous<br> Le .......................
                                        </p>
                                        <p style="text-align: center">
                                            Signature et Cachet du Fournisseur
                                        </p>
                                    </td>
                                </tr>
                            </table>
            </td>
</tr></table></div>
<div></div>
 <table cellspacing="0" cellpadding="3" border="1">
        <thead> 
          <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
            <th style="text-align:center;width: 5%">N°</th>
            <th style="text-align:center;width: 25%">DESIGNATION</th>
            <th style="text-align:center;width: 10%">Qte</th>
            <th style="text-align:center;width: 15%">P.Unit.<br>H.T</th>
            <th style="text-align:center;width: 15%">Taux<br>T.V.A</th>
            <th style="text-align:center;width: 30%">Observations</th>
        </tr>
        </thead>
        ';
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $dmeande->getId())->orderBy('id asc')->execute();
            $i = 0;
            $class = "secondtd";
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $var = $i % 2;
                // die($var.'hh');
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQteaachat();
                //class="' . $class . '"
                $html .= ' <tr>
                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                    <td style="text-align:center;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 10%">' . $qte . '<br> ' . $lignedoc->getUnitedemander() . '</td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 15%"></td>
                                    <td style="text-align:center;width: 30%">' . $lignedoc->getObservation() . '</td>
                                   
                                </tr>';
                $nordre++;
            }

            $html .= '
            </table>
</div><DIV STYLE="page-break-before:always"></DIV> ';


            $fournisseur = $dmeande->getFournisseur();
            //            $rtl_chars_pattern = '/[\x{0590}-\x{05ff}\x{0600}-\x{06ff}]/u';
            //            if (preg_match($rtl_chars_pattern, $fournisseur))
            //                $fournisseur = '<span style="direction:rtl;">     ' . $fournisseur . ' : par remplie prix de Demande -</span>';
            //            else
            $fournisseur = '<label style="font-size: 10px">     - Demande de prix remplie par : ' . $fournisseur . '</label>';

            $html .= '<style>
                p{font-size: 16px;}
                </style>';
            $html .= "<h2>Conditions Administratives</h2>
                    <p>
                    L’offre du fournisseur doit parvenir à L’ODRM portant la mention     
                    « Demande de prix N°" . $dmeande->getNumerodossier() . "» Acquisition (" . $dmeande->getObservation() . ")
                       </p> 
                     <p>  
                    Le dernier délai de la remise des offres est fixé au: " . date('d/m/Y', strtotime($dmeande->getMaxreponsefrs())) . "</p>
                    <p>  <span>  •	Le cachet du bureau d'ordre fait foi.</span></p>
                    <p>  <span>  •	Le prix doit etre ferme et non révisable.</span></p>
                    <p>  <span>  •	Le choix se fait par article conforme et moins disant.</span> </p>
                    <p>  <span>  •	Copie de la patente.</span> </p>
                    <p>  <span>  •        Copie du registre de commerce</span> </p>
                    <p>  <span>  •	Mode de paiement : par virement.</span> </p>
                    <p>  <span>  •	Le fournisseur est tenu d’indiquer :</span></p>
                    <p>  <span>  •	La validité de l’offre……………………………………….</span></p>
                    <p>  <span>  •	Le délai de livraison……………………………………........</span></p>
                    <p>   	REMARQUE:</p>
                    <p>             •	Le fournisseur doit obligatoirement respecter les clauses suivantes :</p>
                      <p>                 " . $fournisseur . "</p>
                        <p>                <span>    - Sa qualité :……………………………………………………………….</span></p>
                       <p>           A défaut votre offre sera automatiquement refusée.<br>
                        N.B: Toute offre portant des surcharges, des ratures ou correcteur sera écartée.</p>";
            $html .= '<DIV STYLE="page-break-after:auto"></DIV>';
        endforeach;
        return $html;
    }

    public function ReadHtmlBBCICONTRATPartielFacturationFinal() {
        $html = '';
        $fournisseur = new Fournisseur();
        $adresse_frs = "";

        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            if ($frs) {
                $fournisseur = $frs;

                $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
                if ($adrs)
                    $adresse_frs = $adrs;
            }
        }

        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($bci_numero == "")
                $bci_numero .= $doc_achat->getNumerodocachat();
            else
                $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        }

        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 50%">
                                    <table>
                                        <tr>
                                            <td>' . $this->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                <table>
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%;">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison sociale ou matricule fiscale du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $this->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '</td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse</td>
                                                    <td>' . $adresse_frs . '</td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
                </table></div>';
        }
        $html .= '<table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 7%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 23%">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 10%">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 10%">P.H.T</th>
                                <th style="text-align:center;width: 10%">Total<br>H.T</th> ';


        $fodec = 0.000;
        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        foreach ($listesdocuments as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        if ($fodec != 0.000) :
            $html .= ' <th style="text-align:center;width: 10%">Fodec</th>';
        endif;
        $html .= '    <th style="text-align:center;width: 10%">Total<br>H.TVA</th>

                        <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>
                        <th style="text-align:center;width: 10%">M.TTC</th>  
                                                          
                            </tr>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $html .= '<tr>
                                    <td style="text-align:center;width: 50px">' . $nordre . '</td>
                                    <td style="text-align:center;width: 280px">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 80px">' . $lignedoc->getQte() . ' ' . $lignedoc->getUniteParDocumentAchat() . '</td>
                                     <td style="text-align:rigth">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                            <td style="text-align:rigth">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td>';
            if ($fodec != 0.000) :
                $html .= '   <td style="text-align:rigth">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . ' </td>';
            endif;
            $html .= '<td style="text-align:rigth">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . ' </td>
                            <td style="text-align:rigth">' . $lignedoc->getTva() . '</td>                           
                                    <td style="text-align:rigth;width: 70px">' . $lignedoc->getMntttc() . '</td>                                    
                                </tr>';
            $nordre++;
        }

        $html .= '</tbody>
                        </table>
                     
                     ';

        $html .= '
                    </div>
                </div>';

        return $html;
    }

    public function ReadHtmlBonexterneFacturationFinal() {
        $html = '';
        $fournisseur = new Fournisseur();
        $adresse_frs = "";

        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            if ($frs) {
                $fournisseur = $frs;

                $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
                if ($adrs)
                    $adresse_frs = $adrs;
            }
        }

        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($bci_numero == "")
                $bci_numero .= $doc_achat->getNumerodocachat();
            else
                $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        }

        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 50%">
                                    <table>
                                        <tr>
                                            <td>' . $this->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                <table>
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%;">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison sociale ou matricule fiscale du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $this->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '</td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse</td>
                                                    <td>' . $adresse_frs . '</td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $this->getId())
                            ->orderBy('id asc')->execute();
            $nordre = 1;
            $fodec = 0.000;
            $remise = 0.000;
            foreach ($liste_demande_de_prix as $lignedoc) {
                $fodec = $fodec + $lignedoc->getMntfodec();
                $remise = $remise + $lignedoc->getMntremise();
            }
            $somme_pru = 0;
            $somme_htva = 0;
            $somme_htax = 0;
            $somme_fdec = 0;
            $somme_ttc = 0;
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
                </table></div>';
        }
        $html .= '<table class="tableligne">
                           <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 280px">DESIGNATION</th>
                                <th style="text-align:center;width: 80px">Qte </th>
                                 <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>
                                                <th style="text-align:center;width: 12%">Total<br>H.T</th> ';
        if ($remise != 0.000)
            $html .= '      <th style="text-align:center;width: 8%">Remise</th>';
        if ($fodec != 0.000)
            $html .= ' <th style="text-align:center;width: 8%">Fodec</th>';
        $html .= '<th style="text-align:center;width: 12%">Total<br>H.TVA</th>
                       <th style="text-align:center;width: 12%">Taux<br>T.V.A</th>';
        //        if ($this->getDroittimbre()) {
        //            $html .= '  <th style="text-align:center;width: 7%">Timbre</th>';
        //        }
        $html .= '     <th style="text-align:center;width: 12%">M.TTC.Net</th>
                                <th style="text-align:center;width: 100px">Observations</th>
                            </tr>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $html .= '<tr>
                                    <td style="text-align:center;width: 50px">' . $nordre . '</td>
                                    <td style="text-align:center;width: 280px">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 80px">' . $qte . ' ' . $lignedoc->getUniteParDocumentAchat() . '</td>';
            $prix_unitaire = floatval($lignedoc->getMntht() * (1 / $lignedoc->getQte()));
            $html .= '  <td style="text-align:center;width: 10%">' . number_format($prix_unitaire, 3, ',', ' ') . ' </td>';
            $html .= ' <td style="text-align:right;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= ' <td style="text-align:right;width: 10%"> ' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . '%' . ' </td>';
            if ($fodec != 0.000)
                $html .= '      <td style="text-align:right;width: 10%">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . ' </td>';
            $html .= '     <td style="text-align:right;width: 10%">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
            $html .= ' <td style="text-align:center;width: 10%">' . $lignedoc->getTva() . ' </td>';
            //            if ($this->getDroittimbre()) {
            //                $html .= ' <td style="text-align:center;width: 7%"></td>';
            //            }
            $mnttc = $lignedoc->getMntttc();
            $html .= ' <td style="text-align:right;width: 10%">' . number_format(($mnttc), 3, ',', ' ') . '</td>';
            $html .= '  <td style="text-align:center;width: 100px">' . $lignedoc->getObservation() . '</td>
                                </tr>';
            $nordre++;
        }

        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> 
                     <table>
                     <tr><td style="width:52%"></td>
                     <td>';
        if ($this->getIdTypedoc() == 7) {
            $html .= '<table class="tableclass">                 
                        <tr style="border: #000 dashed 1px !important">
                            <td>Mnt H.T</td>';
            if ($fodec != 0.000)
                $html .= ' <td>Mnt Fodec</td>';

            $html .= ' <td>Mnt TVA</td>';
            if ($this->getDroittimbre()) {
                $html .= '  <td>Droit Timbre</td>';
            }
            $html .= '  <td>Mnt TTC</td>
                        </tr>
                        <tr style="border: #000 dashed 1px !important">
                            <td style="text-align:right;">' . $this->getMht() . '</td>';
            if ($fodec != 0.000) {
                $html .= ' <td style="text-align:right;">' . $this->getMntfodec() . '</td>';
            }
            $html .= ' <td style="text-align:right;">' . $this->getMnttva() . '</td>';

            if ($this->getDroittimbre()) {
                $html .= ' <td style="text-align:center;">' . $this->getDroittimbre() . '</td>';
            }
            $html .= '    <td style="text-align:right;">' . $this->getMntttc() . '</td>
                        </tr>
                    </table>';
        } else {
            if ($this->getIdTypedoc() == 18) {

                $html .= '<table class="tableclass" >          
                            <tr style="border: #000 dashed 1px !important">
                                <td style="width:45%:text-align:center">Mnt TTC</td>
                            </tr>
                            <tr style="border: #000 dashed 1px !important">
                                <td style="text-align:right;" colspan="2">' . number_format($this->getMntttc(), 3, '.', ',') . ' DT</td>
                            </tr>
                        </table>';
            }
        }
        $html .= '</td></tr></table></div>
                    </div>
                </div>';

        return $html;
    }

    public function ReadHtmlBondeponse() {
        $html = '';
        $fournisseur = new Fournisseur();
        $adresse_frs = "";

        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            if ($frs) {
                $fournisseur = $frs;

                $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
                if ($adrs)
                    $adresse_frs = $adrs;
            }
        }

        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($bci_numero == "")
                $bci_numero .= $doc_achat->getNumerodocachat();
            else
                $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        }

        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 50%">
                                    <table>
                                        <tr>
                                            <td>' . $this->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                <table>
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%;">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison sociale ou matricule fiscale du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $this->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '</td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse</td>
                                                    <td>' . $adresse_frs . '</td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
                </table></div>';
        }

        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        $html .= '<table class="tableligne">
                           <tr style = "font-size:12px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <th style="text-align:center;width: 4%">N°</th>
                                <th style="text-align:center;width: 22%">DESIGNATION<br>
                                
                                </th>
                                <th style="text-align:center;width: 10%">Quantité<br> à livrer </th>
                              <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>
                                 <th style="text-align:center;width: 10%">Total<br>H.T</th> ';
        if ($remise != 0.000)
            $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
        if ($fodec != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Fodec</th>'
                    . ' <th style="text-align:center;width: 10%">Total<br>H.TVA</th>';

        $html .= ' 
                <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>';
        if ($this->getDroittimbre())
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
        $html .= '<th style="text-align:center;width: 10%">M.TTC</th>
                              
                            </tr>
                            <tbody>';

        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= '<tr>
                                    <td style="text-align:center;width: 4%">' . $nordre . '</td>
                                    <td style="text-align:left;width: 22%">' . $lignedoc->getDesignationarticle() . '</td>
                                    <td style="text-align:center;width: 10%">';
            //$qte . ' ' . $lignedoc->getUniteParDocumentAchat() 
            if ($lignedoc->getUnitedemander()) :
                $html .= $qte . " (" . trim($lignedoc->getUnitedemander()) . ")";
            else :
                $html .= $qte;
            endif;
            $html .= '</td>
                                   <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                        <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            if ($remise != 0.000)
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
            if ($fodec != 0.000)
                $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
            $html .= '       <td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>';
            if ($this->getDroittimbre())
                $html .= '<td></td>';
            $html .= '  <td style="text-align:center;width: 10%">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
               
                                   
                                </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                    <td colspan="3" style="text-align: left">Total : </td><td>' . number_format($somme_pru, 3, ',', ' ') . '</td>  
                    <td style="text-align: center">' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($remise)
            $html .= '<td></td>';
        if ($fodec != 0.000)
            $html .= '     <td  style="text-align: center">' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td  style="text-align: center">' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>';

        if ($this->getDroittimbre())
            $html .= '<td  style="text-align: center">' . $this->getDroittimbre() . '</td>';
        $html .= '             <td  style="text-align: center">' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
                          ';
        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> '
        //                     <table>
        //                     <tr><td style="width:52%"></td>
        //                     <td>'
        ;
        //        if ($this->getIdTypedoc() == 2) {
        //            $html.='<table class="tableclass">                 
        //                        <tr style="border: #000 dashed 1px !important">
        //                            <td>Mnt H.T</td>
        //                            <td>Mnt TVA</td>
        //                            <td>Mnt TTC</td>
        //                        </tr>
        //                        <tr style="border: #000 dashed 1px !important">
        //                            <td style="text-align:right;">' . $this->getMht() . '</td>
        //                            <td style="text-align:right;">' . $this->getMnttva() . '</td>
        //                            <td style="text-align:right;">' . $this->getMntttc() . '</td>
        //                        </tr>
        //                    </table>';
        //        } else {
        //            if ($this->getIdTypedoc() == 17) {
        //
        //                $html.='<table class="tableclass" >          
        //                            <tr style="border: #000 dashed 1px !important">
        //                                <td style="width:45%:text-align:center">Mnt TTC</td>
        //                            </tr>
        //                            <tr style="border: #000 dashed 1px !important">
        //                                <td style="text-align:right;" colspan="2">' . number_format($this->getMntttc(), 3, '.', ',') . ' DT</td>
        //                            </tr>
        //                        </table>';
        //            }
        //        }</td></tr></table>
        $html .= '</div>
                    </div>
                </div>';

        return $html;
    }

    public function ReadHtmlttBondeponseRegroupe($id, $id_type) {
        $html = '';
        $bci_numero = "";
        $document_achat = DocumentachatTable::getInstance()->find($id);
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($document_achat->getId());
        $doc_achat = DocumentachatTable::getInstance()->find($document_achat->getIdDocparent());
        //        $id_docpaent = $doc_achat->getIdDocparent();
        //        $document_bdcprovi = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id_docpaent, 21);

        if ($bci_numero == "")
            $bci_numero .= $doc_achat->getNumerodocachat();
        else
            $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 100%">
                                    <table>
                                        <tr>
                                            <td>' . $document_achat->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $document_achat->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($document_achat->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $document_achat->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($document_achat->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
        </table></div>';
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $document_achat->getId())
                        ->orderBy('id asc')->execute();
        //      die(sizeof($liste_demande_de_prix).'dee'.$document_achat->getId());
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= '<table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 8%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 35%">DESIGNATION<br>
                                
                                </th>
                                <th style="text-align:center;width: 10%">Quantité<br> à livrer </th>
                              <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>
                                 <th style="text-align:center;width: 10%">Total<br>H.T</th> ';
        $html .= ' <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>
                <th style="text-align:center;width: 10%">M.TTC</th>                              
                            </tr>
                            <tbody>';

        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= '<tr>
                <td style="text-align:center;width: 8%">' . $nordre . '</td>
                <td style="text-align:center;width: 35%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">' . $qte . ' ' . $lignedoc->getUniteParDocumentAchat() . '</td>
               <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            $html .= ' <td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>
               <td style="text-align:center;width: 10%">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
                 </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr>
                    <td colspan="3">Total : </td><td>' . number_format($somme_pru, 3, ',', ' ') . '</td>  
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($fodec != 0.000)
            $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>
                               <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
                          ';
        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> 
                     <table>
                     ';
        $html .= '</table></div>
                    </div>
                </div>';

        $resultat_quitance = 0;
        //        die(sizeof($document_bdcprovi).'rf'.$document_bdcprovi->getLast()->getId());
        $liste_quitance = LigneoperationcaisseTable::getInstance()->getByDocAchatAndCategorie($document_achat->getId(), 2);

        $html .= '<h5>Liste des quitances Définitifs:</h5> 
            <table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 40%">N° Quitance</th>
                                <th style="text-align:center;width: 60%">Montant</th>
                            </tr>
                            <tbody>';
        foreach ($liste_quitance as $quitance) {
            $html .= '<tr><td>' . $quitance->getNumeroo() . '</td>  
                    <td>' . number_format($quitance->getMntoperation(), 3, ',', ' ') . '</td>';
            $html .= '</tr>'
                    . '';

            $resultat_quitance += $quitance->getMntoperation();
        }
        $html .= '<tr style="background: #EFEFEF"><td>Total : </td><td>' . number_format($resultat_quitance, 3, ',', ' ') . '</td></tr>';
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBondeponseRegroupeProvisoire($id) {
        $html = '';
        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        $doc_achat = DocumentachatTable::getInstance()->find($id);
        $id_docpaent = $doc_achat->getIdDocparent();
        $doc_bci = DocumentachatTable::getInstance()->find($id_docpaent);
        $document_bdcprovi = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id_docpaent, 21);
        if ($bci_numero == "")
            $bci_numero .= $doc_bci->getNumerodocachat();
        else
            $bci_numero .= "<br>" . $doc_bci->getNumerodocachat();
        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 100%">
                                    <table>
                                        <tr>
                                            <td>' . $this->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
        </table></div>';
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= '<table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 10%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 35%">DESIGNATION<br>
                                
                                </th>
                                <th style="text-align:center;width: 10%">Quantité<br> à livrer </th>';
        //                              <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>
        //                                 <th style="text-align:center;width: 10%">Total<br>H.T</th> '
        ;
        //        $html.=' <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>
        //                <th style="text-align:center;width: 10%">M.TTC</th>';                              
        $html .= '       </tr>
                            <tbody>';

        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= '<tr>
                <td style="text-align:center;width: 8%">' . $nordre . '</td>
                <td style="text-align:center;width: 22%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">' . $qte . ' ' . $lignedoc->getUniteParDocumentAchat() . '</td>';
            //               <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
            //                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            //            $html.=' <td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>
            //               <td style="text-align:center;width: 10%">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
            $html .= '   </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        //        $html.='<tr>
        //                    <td colspan="3">Total : </td><td>' . number_format($somme_pru, 3, ',', ' ') . '</td>  
        //                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //        if ($fodec != 0.000)
        //            $html.='     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //        $html.='  <td></td>
        //                               <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                </tr>
        //                          ';
        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> 
                     <table>
                     ';
        $html .= '</table></div>
                    </div>
                </div>';

        $resultat_quitance = 0;
        //        die(sizeof($document_bdcprovi).'rf'.$document_bdcprovi->getLast()->getId());
        $liste_quitance = LigneoperationcaisseTable::getInstance()->getByDocAchatAndCategorie($document_bdcprovi->getLast()->getId(), 2);

        $html .= '<h5>Liste des quitances Définitifs:</h5> 
            <table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 40%">N° Quitance</th>
                                <th style="text-align:center;width: 60%">Montant</th>
                            </tr>
                            <tbody>';
        foreach ($liste_quitance as $quitance) {
            $html .= '<tr><td>' . $quitance->getNumeroo() . '</td>  
                    <td>' . number_format($quitance->getMntoperation(), 3, ',', ' ') . '</td>';
            $html .= '</tr>'
                    . '';

            $resultat_quitance += $quitance->getMntoperation();
        }
        $html .= '<tr style="background: #EFEFEF"><td>Total : </td><td>' . number_format($resultat_quitance, 3, ',', ' ') . '</td></tr>';
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBondeponseRegroupe($id) {
        $html = '';
        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        $doc_achat = DocumentachatTable::getInstance()->find($id);
        $id_docpaent = $doc_achat->getIdDocparent();
        $document_bdcprovi = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id_docpaent, 21);

        if ($bci_numero == "")
            $bci_numero .= $doc_achat->getNumerodocachat();
        else
            $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 100%">
                                    <table>
                                        <tr>
                                            <td>' . $this->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 50%">
                                
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
        </table></div>';
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= '<table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 10%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 30%">DESIGNATION<br>
                                
                                </th>
                                <th style="text-align:center;width: 12%">Quantité<br> à livrer </th>
                              <th style="text-align:center;width: 12%">P.Unit.<br>H.T</th>
                                 <th style="text-align:center;width: 12%">Total<br>H.T</th> ';
        $html .= ' <th style="text-align:center;width: 12%">Taux<br>T.V.A</th>
                <th style="text-align:center;width: 12%">M.TTC</th>                              
                            </tr>
                            <tbody>';

        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= '<tr>
                <td style="text-align:center;width: 10%">' . $nordre . '</td>
                <td style="text-align:center;width: 30%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 12%">' . $qte . ' ' . $lignedoc->getUniteParDocumentAchat() . '</td>
               <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            $html .= ' <td style="text-align:center;width: 12%">' . $lignedoc->getTva() . '</td>
               <td style="text-align:center;width: 12%">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
                 </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr>
                    <td colspan="3">Total : </td><td>' . number_format($somme_pru, 3, ',', ' ') . '</td>  
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($fodec != 0.000)
            $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>
                               <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
                          ';
        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> 
                     <table>
                     ';
        $html .= '</table></div>
                    </div>
                </div>';

        $resultat_quitance = 0;
        //        die(sizeof($document_bdcprovi).'rf'.$document_bdcprovi->getLast()->getId());
        $liste_quitance = LigneoperationcaisseTable::getInstance()->getByDocAchatAndCategorie($document_bdcprovi->getLast()->getId(), 2);

        $html .= '<h5>Liste des quitances Définitifs:</h5> 
            <table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 40%">N° Quitance</th>
                                <th style="text-align:center;width: 60%">Montant</th>
                            </tr>
                            <tbody>';
        foreach ($liste_quitance as $quitance) {
            $html .= '<tr><td>' . $quitance->getNumeroo() . '</td>  
                    <td>' . number_format($quitance->getMntoperation(), 3, ',', ' ') . '</td>';
            $html .= '</tr>'
                    . '';

            $resultat_quitance += $quitance->getMntoperation();
        }
        $html .= '<tr style="background: #EFEFEF"><td>Total : </td><td>' . number_format($resultat_quitance, 3, ',', ' ') . '</td></tr>';
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBDCRegroupeProvisoire($id) {
        $html = '';
        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($id);
        $doc_achat = DocumentachatTable::getInstance()->find($id);
        $id_docpaent = $doc_achat->getIdDocparent();
        $doc_bci = DocumentachatTable::getInstance()->find($id_docpaent);
        $document_bdcprovi = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id_docpaent, 21);
        if ($bci_numero == "")
            $bci_numero .= $doc_bci->getNumerodocachat();
        else
            $bci_numero .= "<br>" . $doc_bci->getNumerodocachat();
        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 100%">
                                    <table>
                                        <tr>
                                            <td>' . $doc_achat->getTypedoc() . ' N° </td>
                                           
                                             <td><p>' . $doc_achat->getNumerodocachat() . '</p></td>
                                        </tr>
                                       
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                      
                                        <tr>
                                            <td>Date de création</td>
                                            
                                            <td ><p>' . date('d/m/Y', strtotime($doc_achat->getDatecreation())) . '</p></td>
                                        </tr>
                                        
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            
                                            <td><p>' . $doc_achat->getLieulivraisson() . '</p></td>
                                        </tr>
                                        
                                    </table>
                                  </td>
                                <td style="width: 50%">
                                
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($id);
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
        </table></div>';
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $doc_achat->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <div></div>';
        if ($fodec == 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                           <thead>
                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <td style="text-align:center;width: 5%">N°</td>
                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                <td style="text-align:center;width: 10%">Qte </td>
                                <td style="text-align:center;width: 15%">P.H.T</td>
                                 <td style="text-align:center;width: 15%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                                 </tr>  
                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                        <td colspan="4">Total : </td>
                                                        <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($doc_achat->getDroittimbre() == 1) {
            //     $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                   <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                       </tr>
                                                                </tbody>
                                                            </table>
                                                            </div>';
        elseif ($fodec == 0.000 && $doc_achat->getDroittimbre() == 1) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 10%">Qte </td>
                                                                                    <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($doc_achat->getDroittimbre() == 1) {
            //     $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                       <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                           </tr>
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                                </div>';
        elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 8%">Qte </td>
                                                                                    <td style="text-align:center;width: 10%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($doc_achat->getDroittimbre() == 1) {
            //     $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>';
        elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                                                                    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                                                                                   <thead>
                                                                                                                                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                                                                        <td style="text-align:center;width: 5%">N°</td>
                                                                                                                                        <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                                                                                                                        <td style="text-align:center;width: 8%">Qte </td>
                                                                                                                                        <td style="text-align:center;width: 10%">P.H.T</td>
                                                                                                                                         <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                                                                         </tr>  
                                                                                                                                         </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                                                                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                                                                        <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                                                                        <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                                                                        <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                                                                        <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                        </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                                                                                <td colspan="4">Total : </td>
                                                                                                                                                                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($doc_achat->getDroittimbre() == 1) {
            //     $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                                                                           <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                                                                               </tr>
                                                                                                                                                                        </tbody>
                                                                                                                                                                    </table>
                                                                                                                                                                    </div>';
        elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() == 1) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                                                                    
                                                                                                                                                                        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                                                                                                                                       <thead>
                                                                                                                                                                                        <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                                                                                                                            <td style="text-align:center;width: 5%">N°</td>
                                                                                                                                                                                            <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                                                                                                                                                                            <td style="text-align:center;width: 8%">Qte </td>
                                                                                                                                                                                            <td style="text-align:center;width: 8%">P.H.T</td>
                                                                                                                                                                                             <td style="text-align:center;width: 11%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                                                                                                                             </tr>  
                                                                                                                                                                                             </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                                                                                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                                                                                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                                                                                                                                    <td colspan="4">Total : </td>
                                                                                                                                                                                                                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($doc_achat->getDroittimbre() == 1) {
            //     $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                                                                                                                               <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                                                                                                                                   </tr>
                                                                                                                                                                                                                            </tbody>
                                                                                                                                                                                                                        </table>
                                                                                                                                                                                                                        </div>';
        endif;
        $resultat_quitance = 0;
        //        die(sizeof($document_bdcprovi).'rf'.$document_bdcprovi->getLast()->getId());
        $liste_quitance = LigneoperationcaisseTable::getInstance()->getByDocAchatAndCategorie($document_bdcprovi->getLast()->getId(), 2);

        $html .= '<h5>Liste des quitances Définitifs:</h5> 
            <table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 40%">N° Quitance</th>
                                <th style="text-align:center;width: 60%">Montant</th>
                            </tr>
                            <tbody>';
        foreach ($liste_quitance as $quitance) {
            $html .= '<tr><td>' . $quitance->getNumeroo() . '</td>  
                    <td>' . number_format($quitance->getMntoperation(), 3, ',', ' ') . '</td>';
            $html .= '</tr>'
                    . '';

            $resultat_quitance += $quitance->getMntoperation();
        }
        $html .= '<tr style="background: #EFEFEF"><td>Total : </td><td>' . number_format($resultat_quitance, 3, ',', ' ') . '</td></tr>';
        $html .= '</tbody></table>';

        return $html;
    }

    public function ReadHtmlBondeponseBDCR($id) {
        $html = '';
        $fournisseur = new Fournisseur();
        $adresse_frs = "";
        $ligne = LignemouvementfacturationTable::getInstance()->find($id);

        $fournisseur = new Fournisseur();

        if ($ligne->getIdFournisseur()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($ligne->getIdFournisseur());
            if ($frs) {
                $fournisseur = $frs;

                $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($ligne->getIdFournisseur());
                if ($adrs)
                    $adresse_frs = $adrs;
            }
        }
        //        die($fournisseur->getId().'ddd');

        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($bci_numero == "")
                $bci_numero .= $doc_achat->getNumerodocachat();
            else
                $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        }

        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 60%">
                                    <table>
                                        <tr>
                                            <td style="width: 55%">' . $this->getTypedoc() . ' N° </td>
                                            <td style="width: 5%">:</td>
                                             <td style="width: 30%"><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                        <tr><td></td></tr>
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            <td>:</td>
                                            <td><p>' . $bci_numero . '</p></td>
                                        </tr>
                                        <tr><td></td></tr>
                                        <tr>
                                            <td>Date de création</td>
                                            <td>:</td>
                                            <td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                        </tr>
                                        <tr><td></td></tr>
                                        <tr>
                                            <td>Lieu de livraison</td>
                                            <td>:</td>
                                            <td><p>' . $this->getLieulivraisson() . '</p></td>
                                        </tr>
                                        <tr><td></td></tr>
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 40%">
                                <table>
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%;">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison sociale ou matricule fiscale du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $fournisseur->getRs() . '<br>' . $fournisseur->getActivitetiers() . '</td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse</td>
                                                    <td>' . $adresse_frs . '</td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
                </table></div>';
        }
        $html .= '<table class="tableligne">
                            <tr>
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 280px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 80px">Qte </th>
                                <th style="text-align:center;width: 70px">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 70px">Taux<br>T.V.A</th>
                                <th style="text-align:center;width: 100px">Observations</th>
                            </tr>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();

            $mnthtva = $lignedoc->getMntht();
            $verif = $lignedoc->getMntht() - intval($lignedoc->getMntht());
            if ($verif == 0)
                $mnthtva = intval($lignedoc->getMntht());
            $html .= '<tr>
                                    <td style="text-align:center;width: 50px">' . $nordre . '</td>
                                    <td style="text-align:center;width: 280px">' . $lignedoc->getDesignationarticle() . '</td>';
            $html .= '  <td style="text-align:center;width: 80px">';
            if (intval($qte) == $lignedoc->getQte())
                $html .= intval($lignedoc->getQte()) . $lignedoc->getUniteParDocumentAchat();
            else
                $html .= number_format($lignedoc->getQte(), 2, ',', ' ') . $lignedoc->getUniteParDocumentAchat();
            $html .= '</td>
                                    <td style="text-align:center;width: 70px">' . $mnthtva . '</td>
                                    <td style="text-align:center;width: 70px">' . $lignedoc->getTva() . '</td>
                                    <td style="text-align:center;width: 100px">' . $lignedoc->getObservation() . '</td>
                                </tr>';
            $nordre++;
        }

        $html .= '</tbody>
                        </table>&nbsp;<br>
                     <div> 
                     <table>
                     <tr><td style="width:52%"></td>
                     <td>';
        if ($this->getIdTypedoc() == 2) {
            $html .= '<table class="tableclass">                 
                        <tr style="border: #000 dashed 1px !important">';
            //                            <td>Mnt H.T</td>
            //                            <td>Mnt TVA</td>
            $html .= ' <td>Montant Mouvement</td>
                        </tr>
                        <tr style="border: #000 dashed 1px !important">';
            //                            <td style="text-align:right;">' . $this->getMht() . '</td>
            //                            <td style="text-align:right;">' . $this->getMnttva() . '</td>
            $html .= ' <td style="text-align:right;">' . $ligne->getMontant() . '</td>
                        </tr>
                    </table>';
        } else {
            if ($this->getIdTypedoc() == 17) {

                $html .= '<table class="tableclass" >          
                            <tr style="border: #000 dashed 1px !important">
                                <td style="width:45%:text-align:center">Mnt TTC</td>
                            </tr>
                            <tr style="border: #000 dashed 1px !important">
                                <td style="text-align:right;" colspan="2">' . number_format($this->getMntttc(), 3, '.', ',') . ' DT</td>
                            </tr>
                        </table>';
            }
        }
        $html .= '</td></tr></table></div>
                    </div>
                </div>';

        return $html;
    }

    public function ReadHtmlTousBondeponse($idtype) {

        $html = '';
        $id_boncommandeInterne = $this->getId();
        $strfrs = "";
        $strnumerodoc = '';
        $typedoc = Doctrine_Core::getTable('typedoc')->findOneById($idtype);
        $bon_d_c_p = Doctrine_Core::getTable('documentachat')->findByIdDocparentAndIdTypedoc($id_boncommandeInterne, $idtype);
        $fournisseur = new Fournisseur();

        foreach ($bon_d_c_p as $bdcp) {
            if ($bdcp->getIdFrs()) {
                $frs = Doctrine_Core::getTable('fournisseur')->findOneById($bdcp->getIdFrs());
                $fournisseur = $frs;
                $strfrs .= $fournisseur->getRs() . '<br>';
            }
        }

        foreach ($bon_d_c_p as $bdcp) {
            $strnumerodoc .= $bdcp->getNumerodocachat() . '<br>';
        }
        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 55%">
                                    <table>
                                        <tr>
                                            <td style="width: 60%">' . $typedoc . ' N° </td>
                                            <td style="width: 5%">:</td>
                                             <td style="width: 35%"><p>' . $strnumerodoc . '</p></td>
                                        </tr>
                                        <tr>
                                            <td>Bon de commande Interne N°</td>
                                            <td>:</td>
                                            <td><p>' . $this->getNumerodocachat() . '</p></td>
                                        </tr>
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses 
                                    mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 45%">
                                <table>
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%; ">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">
                                                    Raison social ou matricule fiscal du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $strfrs . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr><td></td></tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
                <div>';
        $html .= '    <table border="1" style="padding:1%">
                            <thead>
                            <tr >
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 260px" >DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les référence au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 80px">Quantité<br> à livrer</th>
                                <th style="text-align:center;width: 70px">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 70px">Taux<br>T.V.A</th>
                                <th style="text-align:center;width: 100px">Observations</th>
                            </tr>
                            </thead>
                            <tbody>';

        foreach ($bon_d_c_p as $bdcp) {
            $p = new Piecejointbudget();
            $rubrique = "";
            $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($bdcp->getId());
            if ($piece) {
                $p = $piece;
                //$chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<tr style=" text-align:center; background-color: #d20505;"><td colspan="6">'
                    . $bdcp->getNumerodocachat() . ' - ' . $bdcp->getFournisseur()->getRs() . ' - '
                    . number_format($bdcp->getMntttc(), 3, '.', ',')
                    . ' DT<br>' . $rubrique . '</td></tr>';
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $bdcp->getId())->orderBy('id asc')->execute();
            //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
            $nordre = 1;

            if (count($liste_demande_de_prix) == 0) :
                $html .= '<tr colspan="6">Liste des Bon Deponse est vide</tr>';
            else :
                foreach ($liste_demande_de_prix as $lgnedoc) {
                    $lignedoc = $lgnedoc;
                    $qte = 0;

                    $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());

                    if ($qteligne) {
                        $qte = $qteligne->getQtelivrefrs();
                    }
                    $html .= ' <tr>
                                    <td style="text-align:center;width: 50px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 260px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 80px"><p style="border-bottom: #000 dashed 1px !important">' . $qte . '<br>' . $lignedoc->getUniteParDocumentAchat() . '</p></td>
                                    <td style="text-align:center;width: 70px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getMntht_verifier($lignedoc->getMntht()) . '</p></td>
                                    <td style="text-align:center;width: 70px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getTva() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getObservation() . '</p></td>
                                </tr>';
                    $nordre++;
                }

            endif;
        }
        $html .= '
                            </tbody>
                        </table>
                        <div></div><div></div>
                     <div>  ';
        if ($this->getIdTypedoc() == 2) {
            $html .= ' <table style="border: 1px dashed #000000;padding:2%;width: 350px;">                 
<tr style="border: #000 dashed 1px !important">
<td >Mnt H.T</td>
<td >Mnt TVA</td>
<td >Mnt TTC</td>
</tr>
<tr style="border: #000 dashed 1px !important">
<td >' . $this->getMht() . '</td>
<td >' . $this->getMnttva() . '</td>
<td >' . $this->getMntttc() . '</td>
    
</tr>
</table>';
        } else {
            if ($this->getIdTypedoc() == 17) {

                $html .= ' <table style="border: 1px dashed #000000;padding:2%;width: 350px;">                 
<tr style="border: #000 dashed 1px !important">
<td >Mnt TTC</td>
</tr>
<tr style="border: #000 dashed 1px !important">
<td >' . $this->getMntttc() . '</td>
</tr>
</table>';
            }
        }
        $html .= '</div>
                    </div>
                </div>';
        //die($html);
        // $nordre++;
        return $html;
    }

    public function ReadBonCommandeExterne_ENTETEBDCR($id) {
        $ligne = LignemouvementfacturationTable::getInstance()->find($id);
        $fournisseur = new Fournisseur();
        if ($ligne->getIdFournisseur()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($ligne->getIdFournisseur());
            $fournisseur = $frs;
        }

        $adresse_frs = "";
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($ligne->getIdFournisseur())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($ligne->getIdFournisseur());
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($ligne->getIdFournisseur() && $adrs)
            $adresse_frs = $adrs;
        $html = '';
        $html .= '<div class="contenue">
                    <H3 >' . $numero . ' N°: ' . $this->getNumerodocachat() . '</H3>
                     <table>
                        <tr>
                            <td style="width: 50%"></td>
                            <td style="width: 50%; text-align: center;">Original à joindre à la facture</td>
                        </tr><br>
                        <tr>
                        <td style="width: 51%">
                            <table > 
                            <tr><td ><b >BON COMMANDE INTERNE </b></td></tr><br>
                                <tr>
                                    <td style="width: 50%">Bon de commande Interne N°</td>
                                    <td><p style="text-aling:left">' . $affiche_document_parent . '</p></td>
                                </tr>
                                <tr>
                                    <td>Date de création</td>
                                    <td><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
                                </tr>
                                <tr>
                                    <td>Lieu de livraison</td>
                                    <td><p>' . $this->getLieulivraisson() . '</p></td>
                                </tr>
                            </table>                    
                        </td>
                           <td style="width: 53%">
                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                        <tr><td colspan="5" style="height:40px"><p style="border-bottom: 2px dashed #000000;text-align: center">IMPUTATION BUDGETAIRE</p></td></tr><br>
                    <tr>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        $chapitre = "";
        $rubrique = "";
        $mnt = "";
        if ($piece) {
            $p = $piece;
            $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
            $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }
        $html .= '<td style="width: 70px">Chapitre</td>
<td>Titre</td> 
<td>ART</td>
<td>PAR</td>       
<td>S/P</td>
</tr>
<tr>
 <td colspan="5" >' . $rubrique . '</td>  
</tr>
</table>
</td></tr></table>  
                   <div></div>
                        <table style="margin-bottom:0px;" >
                            <tr>
                                <td style="width: 50%">
                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td style="text-align:left;">
                                            <table >
                                                <tr>
                                                   <td  colspan="2" style="text-align:center;height:40px"><p style="border-bottom: 2px dashed #000000;">FOURNISSEUR</p></td>
                                               </tr>
                                               <tr>
                                                   <td colspan="2" style="text-align:left">
                                                    ' . $fournisseur->getRs() . '<br>' . $fournisseur->getActivitetiers() . '
                                                   </td>
                                               </tr>
                                               <tr>
                                                   <td >Adresse:</td>
                                                   <td>' . $adresse_frs . '</td>
                                               </tr>
                                               <tr>
                                                   <td colspan="2">Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>GSM:  ' . $fournisseur->getGsm() . '<br></td>
                                               </tr>
                                            </table>
                                        </td>                           
                                    </tr>
                                </table>
                            </td>
                             <td style="width: 54%">
                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr><td><p style="border-bottom: 2px dashed #000000;text-align: center;height:40px">DESIGNATION DE LA COMMANDE</p></td></tr>
                                    <tr>
                                        <td >' . $this->getDesiegniation() . '</td>
                                    </tr>            
                                    <tr>
                                        <td >MONTANT : ' . number_format($ligne->getMontant(), 3, ',', '.') . ' TND<br>NOTE : ' . $this->getNotesbce() . '<br>DATE MAX REPONSE : ' . date('d/m/Y', strtotime($this->getMaxreponsefrs())) . '<br><br></td> 
                                    </tr>  
                                   
                                </table>
                            </td>
                            </tr><br>
                        </table>
                    <div></div>';

        return $html;
    }

    public function ReadBonCommandeExterne_ENTETE() {

        $fournisseur = new Fournisseur();
        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            $fournisseur = $frs;
        }
        $adresse_frs = "";
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($this->getIdFrs())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($this->getIdFrs() && $adrs)
            $adresse_frs = $adrs;
        //  $html = '';
        $html .= '<div class="contenue">
                    <H3 >' . $numero . ' N°: ' . $this->getNumerodocachat() . '</H3>
                    <div>
    <table>
        <tr>
            <td style="width: 50%"></td>
            <td style="width: 48%; text-align: center;">Original à joindre à la facture</td>
        </tr>

        <tr>
            <td style="width: 50%">
                <table>
                    <tr>
                        <td>
                        </td>
                    </tr><br>
                    <tr>
                        <td style="width: 50%">B.C.I N° </td>
                        <td>
                            <p style="text-aling:left">' . $affiche_document_parent . '</p>
                        </td>
                    </tr>
                    <tr>
                        <td>Date de création</td>
                        <td>
                            <p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p>
                        </td>
                    </tr>
                    <tr>
                        <td>Lieu de livraison</td>
                        <td>
                            <p>' . $this->getLieulivraisson() . '</p>
                        </td>
                    </tr>
                </table>
            </td>
            <td style="width: 50%">
                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                    <tr>
                        <td colspan="5" style="height:40px">
                            <p style="border-bottom: 2px dashed #000000;text-align: center">IMPUTATION BUDGETAIRE</p>
                        </td>
                    </tr><br>
                    <tr>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        $chapitre = "";
        $rubrique = "";
        $mnt = "";
        if ($piece) {
            $p = $piece;
            $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
            $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }
        $html .= '<td style="width: 70px">Chapitre</td>
                        <td>Titre</td>
                        <td>ART</td>
                        <td>PAR</td>
                        <td>S/P</td>
                    </tr>
                    <tr>
                        <td colspan="5">' . $rubrique . '</td>
                    </tr>
                </table>
            </td>

        </tr>
    </table>
</div>
                  <div>
    <table style="margin-bottom:0px;">
        <tr>
            <td style="width: 50%">
                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                    <tr>
                        <td style="text-align:left;">
                            <table>
                                <tr>
                                    <td colspan="2" style="text-align:center;height:40px">
                                        <p style="border-bottom: 2px dashed #000000;">FOURNISSEUR</p>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="text-align:left">
                                        ' . $this->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '
                                    </td>
                                </tr>
                                <tr>
                                    <td>Adresse:</td>
                                    <td>' . $adresse_frs . '</td>
                                </tr>
                                <tr>
                                    <td colspan="2">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' .
                $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '<br></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
            <td style="width: 50%">
                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                    <tr>
                        <td>
                            <p style="border-bottom: 2px dashed #000000;text-align: center;height:40px">DESIGNATION DE
                                LA COMMANDE</p>
                        </td>
                    </tr>
                    <tr>
                        <td>' . $this->getDesiegniation() . '</td>
                    </tr>
                    <tr>';
        $somme_ttc = $this->getMntttc();

        $html .= ' <td>MONTANT : ' . number_format($somme_ttc, 3, ',', '.') . ' TND<br>NOTE : ' .
                $this->getNotesbce() . '<br>DATE MAX REPONSE : ' . date('d/m/Y', strtotime($this->getMaxreponsefrs())) . '<br>
                            <br><br>
                        </td>
                    </tr> ';

        $html .= '
                </table>
            </td>
        </tr><br>
    </table>
</div>
                    
</div>';

        return $html;
    }

    public function ReadBonCommandeExterne_FooterStandard() {
        $html = '';
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        //<DIV STYLE="page-break-before:always"></DIV>
        $html .= ' <br> 
            <div > <table style="margin-bottom:0px; " >
                            <tr>
                                <td style="width: 100%">
            <table border="1" style="padding:1%">
                    <tr rowspan="2">
                        <td style="text-decoration: underline;font-size: 11px"><p style="text-align: center;">Remarques Importantes </p>
                            <p>1) L\'Exemplaire original de ce bon de commande doit être joint à la facture</p>
                                                            <p>2) la facture doit être établie en 4 exemplaires signée et arrétée en toutes lettres.</p>
                                                            <p>Elle doit en outre faire réference au numéro et à la date du présent Bon de commande</p>
                            <p></p></td>
                        <td style=""><p style="text-align: center;text-decoration: underline;">Le Directeur Général</p>
                            <p style="border-bottom: 1px dashed #000000; text-align:left;">Date : ' . $datesign . '</p>
                               
                        </td>
                    </tr>
                    
                   </table>
                   </td>
                  </tr>
               </table>
             </div>
         ';
        return $html;
    }

    public function ReadBonCommandeExterne_Footer() {
        $html = '';
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        //<DIV STYLE="page-break-before:always"></DIV>
        $html .= '  
            <div > <table style="margin-bottom:0px; " >
                            <tr>
                                <td style="width: 100%">
            <table border="1" style="padding:1%">
                    <tr rowspan="2">
                        <td style="width:375px;text-decoration: underline;"><p style="text-align: center;">Remarques Importantes </p>
                            <p>1) L\'Exemplaire original de ce bon de commande doit être joint à la facture</p>
                                                            <p>2) la facture doit être établie en 4 exemplaires signée et arrétée en toutes lettres.</p>
                                                            <p>Elle doit en outre faire réference au numéro et à la date du présent Bon de commande</p>
                            <p></p><p></p><p></p></td>
                        <td style="width:275px;"><p style="text-align: center;text-decoration: underline;">Le Directeur Général</p>
                            <p style="border-bottom: 1px dashed #000000; text-align:left;">Date : ' . $datesign . '</p>
                                <p></p><p></p><p></p><p></p><p></p>
                        </td>
                    </tr>
                    <tr><td colspan="2"><p style="text-align:left">Tél : ' . $soc->getTel() . ' - ' . $soc->getTelephone() . ' ' . $soc->getGsm() . ' - Fax : ' . $soc->getFax() . ' - Email : ' . $soc->getMail() . '<br>Adresse : ' . $soc->getAdresse() . '</p></td>
                        </tr>
                   </table>
                   </td>
                  </tr>
               </table>
             </div>
         ';
        return $html;
    }

    public function ReadHtmlBonexterneBDCR($id) {
        $html = '';
        $html .= $this->ReadBonCommandeExterne_ENTETEBDCR($id);
        $html .= ' <table style="margin-bottom:0px;" >
                            <tr>
                                <td style="width: 90%">
                                <table class="tableligne" style="width:90%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 240px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 80px">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 100px">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 70px">Taux<br>T.V.A</th>
                                <th style="text-align:center;width: 110px">Observations</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $html .= ' <tr>
                        <td style="text-align:center;width: 50px">' . $nordre . '</td>
                        <td style="text-align:center;width: 240px">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 80px">' . $qte . ' ' . $lignedoc->getUnitedemander() . '</td>
                        <td style="text-align:center;width: 100px">' . $lignedoc->getMntht() . '</td>
                        <td style="text-align:center;width: 70px">' . $lignedoc->getTva() . '</td>
                        <td style="text-align:center;width: 110px">' . $lignedoc->getObservation() . '</td>
                    </tr>';
            $nordre++;
        }

        $html .= '<tr>
                    <td colspan="6">Total TTC: ' . number_format($this->getMntttc(), 3, ',', '.') . '</td>  
                </tr>
                            </tbody>
                        </table></td><td></td></tr></table>';
        $html .= $this->ReadBonCommandeExterne_Footer();
        //die($html);

        return $html;
    }

    public function ReadHtmlBonexterne() {
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $html .= $this->ReadBonCommandeExterne_ENTETE();

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        $html .= ' <table style="margin-bottom:0px;" >
                            <tr>
                                <td style="width: 100%">
                                <table class="tableligne" style="width:100%">
                        <thead>
                             <tr style="background-color:#EDEDED;font-weight:bold;">
                                <th style="text-align:center;width: 8%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 22%">DESIGNATION<br></th>
                                <th style="text-align:center;width: 10%">Qte </th>
                                <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>';
        $html .= '<th style="text-align:center;width: 10%">Total<br>H.T</th> ';
        if ($remise != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Remise</th>';


        if ($fodec != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Fodec</th>'
                    . ' <th style="text-align:center;width: 10%">Total<br>H.TVA</th>';

        $html .= ' 
                <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>';
        if ($this->getDroittimbre())
            $html .= '  <th style="text-align:center;width: 7%">Timbre</th>';
        $html .= '<th style="text-align:center;width: 10%">M.TTC.Net</th>
            </tr>
            </thead>
            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;

        foreach ($liste_demande_de_prix as $lgnedoc) {

            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht() + $lignedoc->getMnttva() + $lignedoc->getMntfodec());
            $html .= ' <tr>
                        <td style="text-align:center;width: 8%">' . $nordre . '</td>
                        <td style="text-align:center;width: 22%">' . $lignedoc->getDesignationarticle() . '</td>';

            $html .= '<td style="text-align:center;width: 10%">';
            if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                $html .= intval($lignedoc->getQte());
            else
                $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
            $html .= '</td>';
            //$html .= '<td style="text-align:center;width: 10%">' . $lignedoc->getQte() . ' ' . $lignedoc->getUnitedemander() . '</td>';
            $prix_unitaire = floatval($lignedoc->getMntht() * (1 / $lignedoc->getQte()));
            $html .= ' <td style="text-align:center;width: 10%">' . number_format($prix_unitaire, 3, ',', ' ') . '</td>';
            $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';

            if ($remise != 0.000)
                $html .= ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
            if ($fodec != 0.000)
                $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
            $html .= '<td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>';
            if ($this->getDroittimbre())
                $html .= '<td style="text-align:center;width: 7%"></td>';

            $mnttc = $lignedoc->getMntttc();

            $html .= '  <td style="text-align:center;width: 10%">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                    </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();

            $somme_ttc = $somme_ttc + $lignedoc->getMntttc();
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr>
                    <td colspan="4">Total : </td>
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($remise != 0.000)
            $html .= '<td></td>';
        if ($fodec != 0.000)
            $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>';
        if ($this->getDroittimbre()) {

            $html .= '<td style="text-align:center;width: 10%">' . number_format($this->getDroittimbre(), 3, ',', ' ') . '</td>';
        }


        $html .= '         <td>' . number_format($this->getMntttc(), 3, ',', ' ') . '</td>
                </tr>
                            </tbody>
                        </table></td><td></td></tr></table>';


        return $html;
    }

    public function ReadHtmlBonexterneFacturation() {
        $html = '';
        $somme_pru = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $html .= $this->ReadBonCommandeExterne_ENTETE();
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <table style="margin-bottom:0px;" >
                            <tr>
                                <td style="width: 100%">
                                <table class="tableligne" style="width:100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 130px">DESIGNATION<br></th>
                                <th style="text-align:center;width: 80px">Quantité<br> à livrer </th>

                                 <th style="text-align:center;width: 80px">Total<br>H.T</th> ';

        if ($fodec != 0.000)
            $html .= '  <th style="text-align:center;width: 70px">Fodec</th>';
        $html .= '    <th style="text-align:center;width: 70px">Taux<br>T.V.A</th>
                                <th style="text-align:center;width: 90px">M.TTC</th>
                            </tr>
                            </thead>
                            <tbody>';
        //        $lignedoc = new Lignedocachat();
        //        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
        //                        ->createQuery('a')
        //                        ->where('id_doc=' . $this->getId())
        //                        ->orderBy('id asc')->execute();
        //        $nordre = 1;

        foreach ($liste_demande_de_prix as $lgnedoc) {

            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= ' <tr>
                        <td style="text-align:center;width: 50px">' . $nordre . '</td>
                        <td style="text-align:center;width: 130px">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 80px">' . $lignedoc->getQte() . ' ' . $lignedoc->getUnitedemander() . '</td>
                     
                        <td style="text-align:center;width: 80px">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            if ($fodec != 0.000)
                $html .= '  <td style="text-align:center;width: 70px">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
            $html .= '       <td style="text-align:center;width: 70px">' . $lignedoc->getTva() . '</td>
                        <td style="text-align:center;width: 90px">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
                    </tr>';
            $nordre++;
            $somme_pru = $somme_pru + $lignedoc->getMntht();
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
        }

        $html .= '<tr>
                    <td colspan="3">Total : </td> 
                    <td style="text-align:center;">' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($fodec != 0.000)
            $html .= '     <td style="text-align:center;">' . number_format($somme_fdec, 3, ',', ' ') . '</td>';
        $html .= '  <td style="text-align:center;"></td>
                               <td style="text-align:center;">' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
                            </tbody>
                        </table></td><td></td></tr></table>';
        //        $html.=$this->ReadBonCommandeExterne_FooterStandard();
        //die($html);

        return $html;
    }

    public function ReadHtmlAnnexe() {
        $html = '';
        $base = 0;
        $resultat_base = 0;
        $resultat_mnttva = 0;
        $fournisseur = new Fournisseur();
        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            $fournisseur = $frs;
        }
        $adresse_frs = "";
        $affiche_document_parent = "";

        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($this->getIdFrs())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($this->getIdFrs() && $adrs)
            $adresse_frs = $adrs;
        $html = '';
        $html .= '<div class="contenue">
                    <H3 > ANNEXE ' . $numero . ' N°: ' . $this->getNumerodocachat() . '</H3>';
        $html .= '
            <table  class="tableligne"  style="width: 100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 10%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 30%">DESIGNATION
                                   
                                </th>                                
                                
                                <th style="text-align:center;width: 60%">Observations</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;

        foreach ($liste_demande_de_prix as $lgnedoc) {

            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $html .= ' <tr>
                        <td style="text-align:center;width: 10%">' . $nordre . '</td>
                        <td  style="text-align:center;width: 30%">' . $lignedoc->getDesignationarticle() . '</td>
                                           
                      <td  style="text-align:left;width: 60%">' . $lignedoc->getObservation() . '</td>
                    </tr>';
            $nordre++;
        }
        $html .= '</tbody>
                        </table></div><div></div>';

        $html .= '';
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT a.id_doc,a.id_tva "
                . "FROM lignedocachat a "
                . "WHERE id_doc= " . $this->getId()
                . " group by id_tva,a.id_doc";
        $liste_ligne_docachat = $conn->fetchAssoc($query);
        $html .= '
         
<table  class="tableligne" border="1" style="width: 100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 20%">Taux<br>T.V.A</th>  
                                 <th style="text-align:center;width: 40%">Base </th>  
                                  <th style="text-align:center;width: 40%">M.T.V.A</th>  
                            </tr>
                        </thead>
                        <tbody>';

        $nordrebase = 1;
        for (
        $i = 0; $i < sizeof($liste_ligne_docachat); $i++
        ) {
            $lignedocachat = LignedocachatTable::getInstance()->findByIdDocAndIdTva($liste_ligne_docachat[$i]['id_doc'], $liste_ligne_docachat[$i]['id_tva']);
            $tva = TvaTable::getInstance()->find($liste_ligne_docachat[$i]['id_tva']);
            foreach ($lignedocachat as $lignedoc) {
                $base = $base + ($lignedoc->getMntht());
            }


            $html .= ' <tr>
                        <td  style="text-align:center;width: 20%"> TVA '
                    . $tva->getLibelle()
                    . '</td> 
                          <td  style="text-align:center;width: 40%"> '
                    . number_format($base, 3, ',', ' ')
                    . '</td>
                       <td style="text-align:center;width: 40%">';
            $html .= number_format(($base * $tva->getValeurtva() / 100), 3, ',', ' ');
            $html .= ' </td>
                    </tr>';
            $nordrebase++;

            $resultat_mnttva = $resultat_mnttva + ($base * $tva->getValeurtva() / 100);
            $resultat_base = $resultat_base + $base;
        }

        $html .= '</tbody>
                        </table><div></div>';
        $html .= '         <table style="width: 100%" class="tableligne" border="1">
               <tbody>   
                <tr>
               <td style="text-align:center;width: 20%;bold">Base && MT 
               TVA</td> ';
        $html .= '<td style="text-align:center;width: 40%;bold">';
        $html .= number_format($resultat_base, 3, ',', ' ');
        $html .= '</td> ';

        $html .= '<td  style="text-align:center;width: 40%;bold">';
        $html .= number_format($resultat_mnttva, 3, ',', ' ');
        $html .= '</td>';
        $html .= '</tr></tbody>
                                </table>
                        ';
        $html .= '</div>';
        return $html;
    }

    public function ReadHtmlAnnexeBondeponse() {
        $html = '';
        $base = 0;
        $resultat_base = 0;
        $resultat_mnttva = 0;
        $fournisseur = new Fournisseur();
        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            $fournisseur = $frs;
        }
        $adresse_frs = "";
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($this->getIdFrs())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($this->getIdFrs() && $adrs)
            $adresse_frs = $adrs;
        $html = '';
        $html .= '<div class="contenue">
                    <H3 > ANNEXE ' . $numero . ' N°: ' . $this->getNumerodocachat() . '</H3>';
        $html .= '
            <table  class="tableligne"  style="width: 100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 10%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 30%">DESIGNATION
                                   
                                </th>                                
                                
                                <th style="text-align:center;width: 60%">Observations</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;

        foreach ($liste_demande_de_prix as $lgnedoc) {

            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $html .= ' <tr>
                        <td style="text-align:center;width: 10%">' . $nordre . '</td>
                        <td  style="text-align:center;width: 30%">' . $lignedoc->getDesignationarticle() . '</td>
                                           
                      <td  style="text-align:left;width: 60%">' . $lignedoc->getObservation() . '</td>
                    </tr>';
            $nordre++;
        }
        $html .= '</tbody>
                        </table></div><div></div>';

        $html .= '';
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT a.id_doc,a.id_tva "
                . "FROM lignedocachat a "
                . "WHERE id_doc= " . $this->getId()
                . " group by id_tva,a.id_doc";
        $liste_ligne_docachat = $conn->fetchAssoc($query);
        $html .= '
         
<table  class="tableligne" border="1" style="width: 100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 20%">Taux<br>T.V.A</th>  
                                 <th style="text-align:center;width: 40%">Base </th>  
                                  <th style="text-align:center;width: 40%">M.T.V.A</th>  
                            </tr>
                        </thead>
                        <tbody>';

        $nordrebase = 1;
        if (sizeof($liste_ligne_docachat) >= 1) {
            for (
            $i = 0; $i < sizeof($liste_ligne_docachat); $i++
            ) {
                $lignedocachat = LignedocachatTable::getInstance()->findByIdDocAndIdTva($liste_ligne_docachat[$i]['id_doc'], $liste_ligne_docachat[$i]['id_tva']);
                $tva = TvaTable::getInstance()->find($liste_ligne_docachat[$i]['id_tva']);
                foreach ($lignedocachat as $lignedoc) {
                    $base = $base + ($lignedoc->getMntht());
                }


                $html .= ' <tr>
                        <td  style="text-align:center;width: 20%"> TVA '
                        . $tva->getLibelle()
                        . '</td> 
                          <td  style="text-align:center;width: 40%"> '
                        . number_format($base, 3, ',', ' ')
                        . '</td>
                       <td style="text-align:center;width: 40%">';
                $html .= number_format(($base * $tva->getValeurtva() / 100), 3, ',', ' ');
                $html .= ' </td>
                    </tr>';
                $nordrebase++;

                $resultat_mnttva = $resultat_mnttva + ($base * $tva->getValeurtva() / 100);
                $resultat_base = $resultat_base + $base;
            }
        } else
            $html .= '<tr></tr>';
        $html .= '</tbody>
                        </table><div></div>';

        $html .= '         <table style="width: 100%" class="tableligne" border="1">
               <tbody>   
                <tr>
               <td style="text-align:center;width: 20%;bold">Base && MT 
               TVA</td> ';
        $html .= '<td style="text-align:center;width: 40%;bold">';
        $html .= number_format($resultat_base, 3, ',', ' ');
        $html .= '</td> ';

        $html .= '<td  style="text-align:center;width: 40%;bold">';
        $html .= number_format($resultat_mnttva, 3, ',', ' ');
        $html .= '</td></tr>';


        $html .= '</tbody>
                                </table>
        ';
        $html .= '</div>';
        return $html;
    }

    public function getMagasinArrivee() {
        $mag = Doctrine_Core::getTable('magasin')->findOneById($this->getIdmagarrive());
        return $mag;
    }

    public function ReadHtmlBonTransfertFacture() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $basetvas = $this->getTvabase();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));

        $html .= '<div>
                    <table style="border: 2px dashed #000000;padding:2%;width: 50%;float:right; ">
                        <tr>
                                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">FOURNISSEUR:' . $this->getFournisseur() . '
                                            </p></td>
                                        
</tr>
<tr >
                                      
<td colspan="2">Adresse:   ' . $fournisseur->getAdr() . '<br>Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>GSM:  ' . $fournisseur->getGsm() . '</td>
</tr>
                                    </table>
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr>
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 330px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 70px">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 50px">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 50px">Tva<br>T.V.A</th>
                                <th style="text-align:center;width: 100px">Mnt H.TXA</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();

        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                ->createQuery('a')
                ->where('id_doc=' . $this->getId())
                ->orderBy('id asc')
                ->execute();
        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtelivree = $this->getQteLivreeParFournisseur($lignedoc->getId());
            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 330px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 70px"><p style="border-bottom: #000 dashed 1px !important">' . $qtelivree . '</p></td>
                                    <td style="text-align:center;width: 50px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getMntht() . '</p></td>
                                    <td style="text-align:center;width: 50px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getTva()->getLibelle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . number_format($qtelivree * $lignedoc->getMntht(), 3) . '</p></td>
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                </tr>';
        }
        $html .= '<tr>

</tr>
                            </tbody>
                        </table>';

        $html .= '<div><table border="1" style="padding:1%;width: 60%;float: right;">
                        <tr><td>Total H.TVA</td><td>' . $this->getMht() . '</td></tr>
                        <tr><td>Total TVA</td><td>' . $this->getMnttva() . '</td></tr>
                        <tr><td>Total TTC</td><td>' . $this->getMntttc() . ' TND</td></tr>
                    </table>';

        $html .= '</div></div>
                </div>';
        //die($html);
        return $html;
    }

    public function ReadHtmlBonEntree() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $basetvas = $this->getTvabase();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));

        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">'
                . '<tr>
                    <td style="width: 60%">
                    <table style="border: 2px dashed #000000;padding:2%;">
                    <tr>
                                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">FOURNISSEUR:' . $this->getFournisseur() . '
                                            </p></td>
</tr>
<tr>
                                      
<td colspan="2">Adresse: ' . $fournisseur->getAdr() . '<br>Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM:  ' . $fournisseur->getGsm() . '</td>
</tr>
                                    </table>
</td>
</tr>
</table>
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr>
                                <th style="text-align:center;width: 50px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 220px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 70px">Quantité </th>
                                <th style="text-align:center;width: 100px">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 100px">Tva<br>T.V.A</th>
                                <th style="text-align:center;width: 100px">Mnt H.TXA</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();

        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        $mntttc = 0;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= '<tr>
                                    <td style="text-align:center;width: 50px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 220px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 70px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getQte() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getPu(), 3, ".", ",") . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getTva()->getLibelle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getQte() * $lignedoc->getMntht(), 3, ".", ",") . '</p></td>
                                   
                                </tr>';
            $nordre++;
            // $mntttc+=$lignedoc->getQte()*$lignedoc->getMntttc();
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= '<tr>
                                    <td style="text-align:center;width: 50px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                </tr>';
        }
        $html .= '<tr>
                            </tr>
                            </tbody>
                        </table>';

        $html .= '<div><table  style="padding:5%"> <tr><td style="width: 50%"><table border="1" style="padding:1%">';
        $basetva = new Tvabase();
        foreach ($basetvas as $tva) {
            $basetva = $tva;
            $html .= '<tr>'
                    . '<td>BASE TVA:' . $basetva->getLibelle() . '%'
                    . '</td>'
                    . '<td>' . $basetva->getValeurbase() . ''
                    . '</td></tr>';
        }
        $html .= '</table></td>'
                . '<td>'
                . '<table border="1" style="padding:1%">
                            <tr>
                            <td>Total H.TAX</td><td>' . number_format($this->getMnthtax(), 3, ".", ",") . '</td>
                        </tr>
                        <tr>
                            <td>Total Remise</td><td>' . number_format($this->getMntremise(), 3, ".", ",") . '</td>
                        </tr>
                        <tr>
                            <td>Fodec</td><td>' . number_format($this->getMntfodec(), 3, ".", ",") . '</td>
                        </tr>
                        <tr>
                            <td>Total H.TVA</td><td>' . number_format($this->getMnttva(), 3, ".", ",") . '</td>
                        </tr>
                        <tr><td>Total TVA</td><td>' . number_format($this->getMnttva(), 3, ".", ",") . '</td>
                        </tr>
                        <tr>
                            <td>Total TTC </td><td>' . number_format($this->getMntttc(), 3, ".", ",") . ' TND</td>
                        </tr></table></td></tr></table>';

        $html .= '</div></div></div>';
        return $html;
    }

    public function ReadHtmlFactureImressionBDCR() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">';

        if ($this->getIdLignemouvementfacturation() == null) {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>';
        } else {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">P.H.T </th>
                                    <th style="text-align:center;width: 11.5%;">P.TTC</th>
                                    <th style="text-align:center;width: 8%;">Taux Pourcentage</th>
                                    <th style="text-align:center;width: 14%;">Montant</th>';
        }
        $html .= '  </tr>
                            </thead>
                            <tbody>';
        if ($this->getIdLignemouvementfacturation() == null) {
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qtefrs = 0;

                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne) {
                    $qtefrs = $qteligne->getQtelivrefrs();
                }
                $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($qtefrs * $lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                    </tr>';
                $nordre++;
            }
            //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
            //            $html.=' <tr>
            //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
            //                    </tr>';
            //        }
        } else {

            //            $lignedoc = new Lignedocachat();
            //            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
            //                            ->createQuery('a')
            //                            ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();

            $id_ligne_facture = $this->getIdLignemouvementfacturation();
            $lignefacturation = LignemouvementfacturationTable::getInstance()->findOneById($id_ligne_facture);
            $id_docparent = $this->getIdDocparent();

            $doc_parent = DocumentachatTable::getInstance()->find($id_docparent);
            //            die($this->getLignemouvementfacturation()->getFirst()->getId().sizeof($lignefacturation).'rde'.$this->getIdLignemouvementfacturation());

            $nordre = 1;
            //            foreach ($lignefacturation as $lgnedoc) {
            //                $lignedoc = $lgnedoc;
            //                $qtefrs = 0;
            //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            //                if ($qteligne) {
            //                    $qtefrs = $qteligne->getQtelivrefrs();
            //                }
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $this->getLignedocachat()->getFirst()->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMht(), 3, ",", ".") . '  </p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMntttc(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . intval($lignefacturation->getTauxpourcetage()) . ' % </p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignefacturation->getMontant(), 3, ",", ".") . '</p></td>
                    </tr>';
            //                $nordre++;
            //            }
        }
        $html .= '</tbody>
            </table>';
        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImression($id_docachat) {
        $html = '';
        $fournisseur = new Fournisseur();
        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            $fournisseur = $frs;
        }
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre">' . '<h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>'
                . $titre . '</h3></div>';
        $html .= '<table style="padding:1%"> <tr>
            <td style="width: 60%">
            <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                <tr>
                    <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                </tr>
                <tr>
            <td><b>Adresse :</b> ';
        if ($fournisseur)
            $html .= $fournisseur->getAdr();
        $html .= '<br><b>Tél :</b> ';
        if ($fournisseur)
            $html .= $fournisseur->getTel();
        $html .= '<br><b>E-Mail :</b> ';
        if ($fournisseur)
            $html .= $fournisseur->getMail();
        $html .= '<br><b>GSM :</b> ';
        if ($fournisseur)
            $html .= $fournisseur->getGsm();
        if ($fournisseur) {
            $lignemvt = LignemouvementfacturationTable::getInstance()->getByIdDocachatANdIdFrs($id_docachat, $fournisseur->getId());
            if ($lignemvt) {
                $html .= '<br><b>Situation Fiscale :</b> ';
                if ($lignemvt->getEtatfrs() == '1')
                    $html .= 'En Régle';
                if ($lignemvt->getEtatfrs() == '1')
                    $html .= 'En Défaut';
            }
        }
        $html .= '</td>';
        $html .= '  </tr>
                    </table>
                </td>
            </tr>
        </table>';
        //                    <div style="padding:1%;">
        //                        <table border="1" style="padding:1%; margin-bottom:0px;">
        //                            <thead>
        //                                <tr style="font-weight: bold;background-color:#F0F0F0;">';


        if ($this->getIdLignemouvementfacturation() == null) {
            $html .= $this->ReadLignedocachat($this->getId());
            // $lignedoc = new Lignedocachat();
            // $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
            //                 ->createQuery('a')
            //                 ->where('id_doc=' . $this->getId())
            //                 ->orderBy('id desc')->execute();
            // $nordre = 1;
            // $fodec = 0.000;
            // $remise = 0.000;
            // foreach ($liste_demande_de_prix as $lignedoc) {
            //     $fodec = $fodec + $lignedoc->getMntfodec();
            //     $remise = $remise + $lignedoc->getMntremise();
            // }
            // $html .= '<th style="text-align:center;width: 4%;">N°</th>
            //                         <th style="text-align:center;width: 20%;">DESIGNATION</th>
            //                         <th style="text-align:center;width: 8%;">Qte</th>
            //                         <th style="text-align:center;width: 12%;">P.Unit.<br>H.T</th>
            //                       ';
            // if ($remise != 0.000)
            //     $html .= '      <th style="text-align:center;width: 7%">Remise</th>';
            // if ($fodec != 0.000)
            //     $html .= ' <th style="text-align:center;width: 7%">Fodec</th>';
            // $html .= '  <th style="text-align:center;width: 12%">Total<br>H.TVA</th>
            //      <th style="text-align:center;width: 12%">Taux<br>T.V.A</th>';
            // $html .= '<th style="text-align:center;width: 12%">M.TTC.Net</th>';
            // $html .= '  </tr>
            //                 </thead>
            //                 <tbody>';
            // foreach ($liste_demande_de_prix as $lgnedoc) {
            //     $lignedoc = $lgnedoc;
            //     $qtefrs = 0;
            //     $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            //     if ($qteligne) {
            //         $qtefrs = $qteligne->getQtelivrefrs();
            //     }
            //     $html .= '<tr>
            //             <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
            //             <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
            //              <td style="text-align:center;width: 80px"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . ' ' . $lignedoc->getUniteParDocumentAchat() . '</p></td>';
            //     $prix_unitaire = $lignedoc->getMntht() / $qtefrs;
            //     $html .= '  <td style="text-align:center;width: 10%"><p style="border-bottom: #000 dashed 1px !important">' . number_format($prix_unitaire, 3, ',', ' ') . '</p> </td>';
            //     if ($remise != 0.000)
            //         $html .= ' <td style="text-align:right;width: 10%"><p style="border-bottom: #000 dashed 1px !important"> ' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . '%' . ' </p></td>';
            //     if ($fodec != 0.000)
            //         $html .= '      <td style="text-align:right;width: 10%"><p style="border-bottom: #000 dashed 1px !important">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</p> </td>';
            //     $html .= ' <td style="text-align:right;width: 10%"><p style="border-bottom: #000 dashed 1px !important">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</p></td>';
            //     $html .= ' <td style="text-align:center;width: 10%"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getTva() . ' </p></td>';
            //     $mnttc = $lignedoc->getMntttc();
            //     $html .= ' <td style="text-align:right;width: 10%"><p style="border-bottom: #000 dashed 1px !important">' . number_format(($mnttc), 3, ',', ' ') . '</p></td>
            //                 </tr>';
            //     $nordre++;
            // }
        } else {
            $html .= '<div style="padding:1%;">
            <table border="1" style="padding:1%; margin-bottom:0px;">
                <thead>
                    <tr style="font-weight: bold;background-color:#F0F0F0;">
            <th style = "text-align:center;width: 5%;">N°</th>
            <th style = "text-align:center;width: 50%;">
            DESIGNATION </th>
            <th style="text-align:center;width: 11.5%;">P.H.T </th>
            <th style="text-align:center;width: 11.5%;">P.TTC</th>
            <th style="text-align:center;width: 8%;">Taux Pourcentage</th>
            <th style="text-align:center;width: 14%;">Montant</th>';
            $html .= '  </tr>
            </thead>
            <tbody>';
            $id_ligne_facture = $this->getIdLignemouvementfacturation();
            $lignefacturation = LignemouvementfacturationTable::getInstance()->findOneById($id_ligne_facture);
            $id_docparent = $this->getIdDocparent();

            $doc_parent = DocumentachatTable::getInstance()->find($id_docparent);

            $nordre = 1;
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $this->getLignedocachat()->getFirst()->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMht(), 3, ",", ".") . '  </p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMntttc(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . intval($lignefacturation->getTauxpourcetage()) . ' % </p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignefacturation->getMontant(), 3, ",", ".") . '</p></td>
                   </tr>';

            $html .= '</tbody>
    </table>';
        }
        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>';
        if ($this->getDroittimbre()) {
            $html .= '<tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Droit de Timbre</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getDroittimbre(), 3, ",", ".") . ' TND</td></tr>';
        }
        $html .= '<tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div>';

        return $html;
    }

    public function ReadHtmlBDCRegAndFactureImression() {
        $html = '';
        $fournisseur = new Fournisseur();
        //        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        //        $fournisseur = $frs;
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '</h3></div>';
        $html .= '<div style="padding:1%;">
          <table><tr><td> <table border="1" style="padding:1%; margin-bottom:0px;width: 100%">
               <thead><tr><td colspan="2">Bon Dépense au comptant Regroupe</td></tr></thead>
               <tbody>   <tr ><td>N°</td><td>' . $this->getNumerodocachat() . '</td></tr><tr><td>Date Création</td><td>';
        $html .= date('d/m/Y', strtotime($this->getDatecreation())) . '</td>'
                . '</tr><tr><td>Lieu Livraison</td><td>' . $this->getLieulivraisson() . '</tr>'
                . '</tbody>'
                . '</table></td><td>';

        $html .= '      <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;width: 100%">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">';
        $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 35%;">
                                        DESIGNATION</th>
                                                                    
                                   ';
        $html .= '  </tr> </thead> <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;

        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 35%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                      </tr>';
            $nordre++;
        }

        $html .= '</tbody>
            </table></div></td></tr></table>';
        $html .= '<h3>Liste des Factures du BDCR:</h3>';
        $html .= '&nbsp;<br>';

        $documentachat_facture_bddcregroupe = DocumentachatTable::getInstance()->findbyIdDocparentAndIdTypedoc($this->getId(), 15);
        //        die(sizeof($documentachat_facture_bddcregroupe).'dezdz');
        foreach ($documentachat_facture_bddcregroupe as $docachat_facture_bddcr) :
            $html .= $docachat_facture_bddcr->ReadHtmlFactureImression();
        endforeach;
        $html .= '</div></div>';
        return $html;
    }

    public function ReadHtmlFactureImressionDuBDCR() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">';
        $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 35%;">
                                        DESIGNATION</th>
                                    <th style="text-align:center;width: 12%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 14%;">P.H.T</th>
                                      <th style="text-align:center;width: 13%;">Taux<br>Fodec</th>
                                      <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                    <th style="text-align:center;width: 12%;">Tva<br>T.V.A</th>                                  
                                   ';
        $html .= '  </tr> </thead> <tbody>';
        //        if ($this->getIdLignemouvementfacturation() == null) {
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 35%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 12%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                            <td style="text-align:center;width: 13%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTauxfodec()->getLibelle()) . '</p></td>
                                <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntthtva(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 12%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                       
                       
                    </tr>';
            $nordre++;
        }
        //        } else {
        //            $id_ligne_facture = $this->getIdLignemouvementfacturation();
        //            $lignefacturation = LignemouvementfacturationTable::getInstance()->findOneById($id_ligne_facture);
        //            $id_docparent = $this->getIdDocparent();
        //
        //            $doc_parent = DocumentachatTable::getInstance()->find($id_docparent);
        //            $nordre = 1;
        //            $html.='<tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
        //                        <td style="text-align:left;"><p style="border-bottom: #000 dashed 1px !important">' . $this->getLignedocachat()->getFirst()->getDesignationarticle() . '</p></td>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMht(), 3, ",", ".") . '  </p></td>
        //                        <td style="text-align:right;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMntttc(), 3, ",", ".") . '</p></td>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . intval($lignefacturation->getTauxpourcetage()) . ' % </p></td>
        //                        <td style="text-align:right;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignefacturation->getMontant(), 3, ",", ".") . '</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';
        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 56%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 49%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 50%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 50%;">' . number_format($this->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 50%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 50%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                ';
        if ($this->getDroittimbre() == 1) :
            $html .= '  <tr>  <td style="width: 50%;background-color:#F0F0F0;"><b>Droit Timbre</b></td>
                                    <td style="text-align:right;width: 50%;">' . '0.600' . ' TND</td>
                                </tr>';
        endif;
        $html .= '  <tr>
                       <td style="width: 50%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 50%;">' . number_format($this->getMntttc(), 3, ",", ".") . ' TND</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlListeFactureImression($iddoc) {
        $doc_achat = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($doc_achat->getIdFrs());
        $fournisseur = $frs;
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($doc_achat->getDatesignature())
            $datesign = date('d/m/Y', strtotime($doc_achat->getDatesignature()));

        $numero = strtoupper($doc_achat->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $doc_achat->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($doc_achat->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $doc_achat->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">';

        if ($doc_achat->getIdLignemouvementfacturation() == null) {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>';
        } else {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">P.H.T </th>
                                    <th style="text-align:center;width: 11.5%;">P.TTC</th>
                                    <th style="text-align:center;width: 8%;">Taux Pourcentage</th>
                                    <th style="text-align:center;width: 14%;">Montant</th>';
        }
        $html .= '  </tr>
                            </thead>
                            <tbody>';
        if ($doc_achat->getIdLignemouvementfacturation() == null) {
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $doc_achat->getId())->orderBy('id asc')->execute();
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qtefrs = 0;

                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne) {
                    $qtefrs = $qteligne->getQtelivrefrs();
                }
                $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($qtefrs * $lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                    </tr>';
                $nordre++;
            }
        } else {
            $id_ligne_facture = $doc_achat->getIdLignemouvementfacturation();
            $lignefacturation = LignemouvementfacturationTable::getInstance()->findOneById($id_ligne_facture);
            $id_docparent = $doc_achat->getIdDocparent();

            $doc_parent = DocumentachatTable::getInstance()->find($id_docparent);
            $nordre = 1;
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $doc_achat->getLignedocachat()->getFirst()->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMht(), 3, ",", ".") . '  </p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMntttc(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . intval($lignefacturation->getTauxpourcetage()) . ' % </p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignefacturation->getMontant(), 3, ",", ".") . '</p></td>
                    </tr>';
        }
        $html .= '</tbody>
            </table>';
        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($doc_achat->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($doc_achat->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($doc_achat->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImressionBDCG($id_docparent) {
        $html = '';
        $fournisseur = new Fournisseur();
        //die($this->getId().'mp');
        $docu_achat = DocumentachatTable::getInstance()->find($id_docparent);
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($docu_achat->getIdFrs());
        $fournisseur = $frs;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($docu_achat->getDatesignature()));

        $numero = strtoupper($docu_achat->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $docu_achat->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($docu_achat->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">';

        if ($this->getIdLignemouvementfacturation() == null) {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>';
        } else {
            $html .= '<th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">P.H.T </th>
                                    <th style="text-align:center;width: 11.5%;">P.TTC</th>
                                    <th style="text-align:center;width: 8%;">Taux Pourcentage</th>
                                    <th style="text-align:center;width: 14%;">Montant</th>';
        }
        $html .= '  </tr>
                            </thead>
                            <tbody>';
        if ($this->getIdLignemouvementfacturation() == null) {
            $lignedoc = new Lignedocachat();
            $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                            ->createQuery('a')
                            ->where('id_doc=' . $docu_achat->getId())->orderBy('id asc')->execute();
            $nordre = 1;
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qtefrs = 0;

                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne) {
                    $qtefrs = $qteligne->getQtelivrefrs();
                }
                $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format(($lignedoc->getMntht() / $qtefrs), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                    </tr>';
                $nordre++;
            }

            //            $id_ligne_facture = $this->getIdLignemouvementfacturation();
            //            $lignefacturation = LignemouvementfacturationTable::getInstance()->findOneById($id_ligne_facture);
            //            $id_docparent = $this->getIdDocparent();
            //
            //            $doc_parent = DocumentachatTable::getInstance()->find($id_docparent);
            //            die($this->getLignemouvementfacturation()->getFirst()->getId().sizeof($lignefacturation).'rde'.$this->getIdLignemouvementfacturation());
            //            $nordre = 1;
            //            foreach ($lignefacturation as $lgnedoc) {
            //                $lignedoc = $lgnedoc;
            //                $qtefrs = 0;
            //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            //                if ($qteligne) {
            //                    $qtefrs = $qteligne->getQtelivrefrs();
            //                }
            //            $html.='<tr>
            //                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
            //                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $this->getLignedocachat()->getFirst()->getDesignationarticle() . '</p></td>
            //                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMht(), 3, ",", ".") . '  </p></td>
            //                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($doc_parent->getMntttc(), 3, ",", ".") . '</p></td>
            //                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . intval($lignefacturation->getTauxpourcetage()) . ' % </p></td>
            //                        <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignefacturation->getMontant(), 3, ",", ".") . '</p></td>
            //                    </tr>';
            //                $nordre++;
            //            }
        }
        $html .= '</tbody>
            </table>';
        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($docu_achat->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($docu_achat->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($docu_achat->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImressionContrat() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div style="padding:1%;">
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                   
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                    <th style="text-align:center;width: 14%;">M.TVA</th>
                                      <th style="text-align:center;width: 14%;">M.TTC</th>
                                </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            //            $contrat=  ContratTable::getInstance()->findOneById($this->getIdContrat());
            //             $ligne_mvt=  Doctrine_Core::getTable('lignemouvementfacturation')->findOneByIdDocumentachat($this->getIdDocparent());
            //           die($contrat->getLignecontrat()->getId().'mp');
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                  
<td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMht(), 3, ",", ".") . '</p></td>
                              <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMnttva(), 3, ",", ".") . '</p></td>
                                    <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMntttc(), 3, ",", ".") . '</p></td>
                    </tr>';
            $nordre++;
        }
        //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
        //            $html.=' <tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';

        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($this->getMntttc()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMht(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMntttc(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImressionContratFacturation($id) {

        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $ligne_mvt = LignemouvementfacturationTable::getInstance()->findOneById($id);
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $id_doc_achat = $ligne_mvt->getIdDocumentachat();
        $docu_achat = DocumentachatTable::getInstance()->findOneById($id_doc_achat);
        $id_doc_parent = $docu_achat->getIdDocparent();
        $doc_achat_parent = DocumentachatTable::getInstance()->find($id_doc_parent);
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                     <legend>Détail du BCI</legend>
                    <div style="padding:1%;">
                     
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                      
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                   
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                    <th style="text-align:center;width: 14%;">M.TVA</th>
                                      <th style="text-align:center;width: 14%;">M.TTC</th>
                                </tr>
                            </thead>
                            <tbody>';
        //        die($doc_achat_parent->getIdDocparent().'mp');
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $doc_achat_parent->getIdDocparent())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            //            $contrat=  ContratTable::getInstance()->findOneById($this->getIdContrat());
            //             $ligne_mvt=  Doctrine_Core::getTable('lignemouvementfacturation')->findOneByIdDocumentachat($this->getIdDocparent());
            //           die($contrat->getLignecontrat()->getId().'mp');
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                  
<td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMht(), 3, ",", ".") . '</p></td>
                              <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMnttva(), 3, ",", ".") . '</p></td>
                                    <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMntttc(), 3, ",", ".") . '</p></td>
                    </tr>';
            $nordre++;
        }
        //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
        //            $html.=' <tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';
        $html .= '&nbsp;<br>
            <legend>Détail Mouvement</legend>
                 <table border="1" style="padding:1%; margin-bottom:0px;">
                      
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                 
                                    <th style="text-align:center;width: 14%;">Taux Pourcentage </th>
                                      <th style="text-align:center;width: 14%;">Montant</th>
                                </tr>
                            </thead>
                            <tbody>';
        $html .= '<tr>'
                . '  <td style="text-align:right;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . intval($ligne_mvt->getTauxpourcetage()) . ' %' . '</p></td>
<td style="text-align:right;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $ligne_mvt->getMontant() . '</p></td>                   
</tr>';

        $html .= '</tbody></table>';

        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($ligne_mvt->getMontant()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>';
        //'<tr>
        //                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
        //                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>';
        $html .= ' <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImressionBCIContrat($id) {

        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $ligne_mvt = LignemouvementfacturationTable::getInstance()->findOneByIdDocumentachat($id);
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $id_doc_achat = $ligne_mvt->getIdDocumentachat();
        $docu_achat = DocumentachatTable::getInstance()->findOneById($id_doc_achat);
        $id_doc_parent = $docu_achat->getIdDocparent();
        $doc_achat_parent = DocumentachatTable::getInstance()->find($id_doc_parent);
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                     <legend>Détail du BCI</legend>
                    <div style="padding:1%;">
                     
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                      
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">T.H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                   <th style="text-align:center;width: 8%;">Fodec</th>
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                    <th style="text-align:center;width: 14%;">M.TVA</th>
                                      <th style="text-align:center;width: 14%;">M.TTC</th>
                                </tr>
                            </thead>
                            <tbody>';
        //        die($doc_achat_parent->getIdDocparent().'mp');
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $id_doc_achat)
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            //            $contrat=  ContratTable::getInstance()->findOneById($this->getIdContrat());
            //             $ligne_mvt=  Doctrine_Core::getTable('lignemouvementfacturation')->findOneByIdDocumentachat($this->getIdDocparent());
            //           die($contrat->getLignecontrat()->getId().'mp');
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                   <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTauxfodec()->getLibelle()) . '</p></td>
<td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMht(), 3, ",", ".") . '</p></td>
                              <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMnttva(), 3, ",", ".") . '</p></td>
                                    <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMntttc(), 3, ",", ".") . '</p></td>
                    </tr>';
            $nordre++;
        }
        //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
        //            $html.=' <tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';


        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($ligne_mvt->getMontant()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>';
        //'<tr>
        //                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
        //                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>';
        $html .= ' <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlFactureImressionBCIContratFacturation($id) {

        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $ligne_mvt = LignemouvementfacturationTable::getInstance()->findOneById($id);
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d/m/Y', strtotime($this->getDatesignature()));
        $id_doc_achat = $ligne_mvt->getIdDocumentachat();
        $docu_achat = DocumentachatTable::getInstance()->findOneById($id_doc_achat);
        $id_doc_parent = $docu_achat->getIdDocparent();
        $doc_achat_parent = DocumentachatTable::getInstance()->find($id_doc_parent);
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . $numero . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d/m/Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">
                        <tr>
                            <td style="width: 60%">
                                <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td><p style="border-bottom: 2px dashed #000000;margin:0px;"><b>FOURNISSEUR :</b> ' . $this->getFournisseur()->getRs() . '</p></td>
                                    </tr>
                                    <tr>
                                        <td><b>Adresse :</b> ' . $fournisseur->getAdr() . '<br><b>Tél :</b> ' . $fournisseur->getTel() . '<br><b>E-Mail :</b> ' . $fournisseur->getMail() . '<br><b>GSM :</b> ' . $fournisseur->getGsm() . '</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                     <legend>Détail du BCI</legend>
                    <div style="padding:1%;">
                     
                        <table border="1" style="padding:1%; margin-bottom:0px;">
                      
                            <thead>
                                <tr style="font-weight: bold;background-color:#F0F0F0;">
                                    <th style="text-align:center;width: 5%;">N°</th>
                                    <th style="text-align:center;width: 50%;">
                                        DESIGNATION<br>
                                        (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                    </th>
                                    <th style="text-align:center;width: 11.5%;">Quantité<br>livrée </th>
                                    <th style="text-align:center;width: 11.5%;">P.Unit.<br>H.T</th>
                                    <th style="text-align:center;width: 8%;">Tva<br>T.V.A</th>
                                   
                                    <th style="text-align:center;width: 14%;">Montant<br>H.TVA</th>
                                    <th style="text-align:center;width: 14%;">M.TVA</th>
                                      <th style="text-align:center;width: 14%;">M.TTC</th>
                                </tr>
                            </thead>
                            <tbody>';
        //        die($doc_achat_parent->getIdDocparent().'mp');
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $id_doc_achat)
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qtefrs = 0;

            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne) {
                $qtefrs = $qteligne->getQtelivrefrs();
            }
            //            $contrat=  ContratTable::getInstance()->findOneById($this->getIdContrat());
            //             $ligne_mvt=  Doctrine_Core::getTable('lignemouvementfacturation')->findOneByIdDocumentachat($this->getIdDocparent());
            //           die($contrat->getLignecontrat()->getId().'mp');
            $html .= '<tr>
                        <td style="text-align:center;width: 5%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($nordre) . '</p></td>
                        <td style="text-align:left;width: 50%;"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                        <td style="text-align:center;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . $qtefrs . '</p></td>
                        <td style="text-align:right;width: 11.5%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($lignedoc->getMntht(), 3, ",", ".") . '</p></td>
                        <td style="text-align:center;width: 8%;"><p style="border-bottom: #000 dashed 1px !important">' . trim($lignedoc->getTva()->getLibelle()) . '</p></td>
                  
<td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMht(), 3, ",", ".") . '</p></td>
                              <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMnttva(), 3, ",", ".") . '</p></td>
                                    <td style="text-align:right;width: 14%;"><p style="border-bottom: #000 dashed 1px !important">' . number_format($this->getMntttc(), 3, ",", ".") . '</p></td>
                    </tr>';
            $nordre++;
        }
        //        for ($i = count($liste_demande_de_prix) + 1; $i <= 5; $i++) {
        //            $html.=' <tr>
        //                        <td style="text-align:center;"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                        <td><p style="border-bottom: #000 dashed 1px !important">&nbsp;</p></td>
        //                    </tr>';
        //        }
        $html .= '</tbody>
            </table>';


        $html .= '&nbsp;<br>
                <table>
                    <tr>
                        <td style="width: 54%;">Arrêté la présente facture à la somme de ' . chiffreToLettre::cvnbst($ligne_mvt->getMontant()) . '.</td>
                        <td style="width: 46%;">
                            <table border="1" cellpadding="5" style="margin-bottom:0px;">
                                <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total H.TVA</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>';
        //'<tr>
        //                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TVA</b></td>
        //                                    <td style="text-align:right;width: 65%;">' . number_format($this->getMnttva(), 3, ",", ".") . ' TND</td></tr>';
        $html .= ' <tr>
                                    <td style="width: 35%;background-color:#F0F0F0;"><b>Total TTC</b></td>
                                    <td style="text-align:right;width: 65%;">' . number_format($ligne_mvt->getMontant(), 3, ",", ".") . ' TND</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>';

        $html .= '</div></div>';

        return $html;
    }

    public function ReadHtmlAvoir() {
        $html = '';
        $fournisseur = new Fournisseur();
        $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
        $fournisseur = $frs;
        $basetvas = $this->getTvabase();
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";
        if ($this->getIdEtatdoc() == 17)
            $titre = $this->getEtatdocument();
        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));

        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">'
                . '<tr>
                    <td style="width: 60%">
                    <table style="border: 2px dashed #000000;padding:2%; ">
                    <tr>
                                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">FOURNISSEUR:' . $this->getFournisseur() . '
                                            </p></td>
</tr>
<tr>
<td colspan="2">Adresse:   ' . $fournisseur->getAdr() . '<br>Tél:  ' . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() . '<br>GSM:  ' . $fournisseur->getGsm() . '</td>
</tr>
                                    </table>
</td>

</tr>            
    
</table>
</td>
                            </tr>
                            
                        </table>
                        
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr >
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 400px">DESIGNATION<br></th>
                                <th style="text-align:center;width: 100px">Quantité<br></th>
                                <th style="text-align:center;width: 100px">Mnt TTC</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();

        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 400px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getQte() . '</p></td>

                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getMntttc() . '</p></td>
                                   
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= ' <tr  >
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                  
                                </tr>';
        }
        $html .= '<tr>

</tr>
                            </tbody>
                        </table>';

        $html .= '<div style="float:right"><div >
                            
                      <p style="text-align: right;
font-weight: bold;
font-size: 20px;">  Total TTC: ' . $this->getMntttc() . ' TND</p>';



        $html .= '</div>   </div>   </div>
                </div>';
        //die($html);
        return $html;
    }

    public function ReadHtmlBonSortie() {
        $html = '';
        $demandeur = new Agents();
        $agent = Doctrine_Core::getTable('agents')->findOneById($this->getIdDemandeur());
        $demandeur = $agent;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));


        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">'
                . '<tr>
                    
                    <td style="width: 60%">
                    
                    <table style="border: 2px dashed #000000;padding:2%; ">
                    <tr>

                                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">DEMANDEUR:' . $this->getAgents() . '
                                            </p></td>
                                        
</tr>
<tr >
                                      
<td colspan="2">GSM:  ';
        if ($demandeur)
            $html .= $demandeur->getGsm();
        $html .= '<br>E-Mail:  ';
        if ($demandeur)
            $html .= $demandeur->getMail();
        $html .= '</td>
</tr>
                                    </table>
</td>

</tr>            
    
</table>
</td>
                            </tr>
                            
                        </table>
                        
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr>
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                
                                <th style="text-align:center;width: 400px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 100px">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 100px">PAM</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();

        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 400px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getQte() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getMntttc() . '</p></td>
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= ' <tr  >
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                </tr>';
        }
        $html .= '<tr>

</tr>
                            </tbody>
                        </table>';

        $html .= '<div><div><table  style="padding:5%"> <tr><td style="width: 50%">';
        $html .= ''
                . '<td>'
                . '<table border="1" style="padding:1%">
                            
                        <tr>
                            <td>Total  </td><td>' . $this->getMntttc() . ' TND</td>
                        </tr></table></td></tr></table>';

        $html .= '</div> </div>   </div>
                </div>';
        //die($html);
        return $html;
    }

    public function ReadHTMLBonInterne() {
        $html = '';
        $demandeur = new Agents();
        $agent = Doctrine_Core::getTable('agents')->findOneById($this->getIdDemandeur());
        $demandeur = $agent;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));


        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">'
                . '<tr>
                    
                    <td style="width: 60%">
                    
                    <table style="border: 2px dashed #000000;padding:2%; ">
                    <tr>

                                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">DEMANDEUR:' . $this->getAgents() . '
                                            </p></td>
                                        
</tr>
<tr >
                                      
<td colspan="2">GSM:  ' . $demandeur->getGsm() . '<br>E-Mail:  ' . $demandeur->getMail() . '</td>
</tr>
                                    </table>
</td>

</tr>            
    
</table>
</td>
                            </tr>
                            
                        </table>
                        
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr >
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                
                                <th style="text-align:center;width: 400px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();

        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 400px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                 
                                   
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= ' <tr  >
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                   
                 
                                  
                                </tr>';
        }
        $html .= '<tr>

</tr>
                            </tbody>
                        </table>';

        $html .= '<div> </div>   </div>
                </div>';
        //die($html);
        return $html;
    }

    public function ReadHtmlBonTransfert() {
        $html = '';

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));


        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '<br>
                        Magasin départ: ' . $this->getMagasin() . '   ====>   Magasin arrivée: ' . $this->getMagasinArrivee() . '</h3></div>
                     <table style="padding:1%">'
                . '</table>
                </td>
                            </tr>
                        </table>
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr >
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                
                                <th style="text-align:center;width: 300px" >DESIGNATION<br>
                                    
                                </th>
                                <th style="text-align:center;width: 100px">Quantité<br> envoyée </th>
                                <th style="text-align:center;width: 100px">Magasin départ</th>
                                <th style="text-align:center;width: 100px">Magasin Arivée</th>
                               
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();


        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= ' <tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 300px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getQte() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $this->getMagasin() . '</p></td>
                                     <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $this->getMagasinArrivee() . '</p></td>
                                   
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= ' <tr  >
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                      <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                  
                                </tr>';
        }
        $html .= '<tr>

</tr>
                            </tbody>
                        </table>';

        $html .= '   </div>
                </div>';
        //die($html);
        return $html;
    }

    public function ReadHtmlBonRetour() {
        $html = '';
        $demandeur = new Agents();
        $agent = Doctrine_Core::getTable('agents')->findOneById($this->getIdDemandeur());
        $demandeur = $agent;

        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        $titre = "";

        if ($this->getDatesignature())
            $datesign = date('d-m-Y', strtotime($this->getDatesignature()));

        $html .= '<div class="contenue"> '
                . '<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . ' N°: ' . $this->getNumerodocachat() . '<br>
                    ' . date('d-m-Y', strtotime($this->getDatecreation())) . '<br>' . $titre . '</h3></div>
                     <table style="padding:1%">'
                . '<tr>
                    
                    <td style="width: 60%">
                    
                    <table style="border: 2px dashed #000000;padding:2%;">
                        <tr>
                            <td colspan="2"><p style="border-bottom: 2px dashed #000000;">DEMANDEUR:' . $this->getAgents() . '</p></td>
                        </tr>
                        <tr>
                            <td colspan="2">GSM: ' . $demandeur->getGsm() . '<br>E-Mail:  ' . $demandeur->getMail() . '</td>
                        </tr>
                    </table>
</td>
</tr>
</table>
</td>
                            </tr>
                        </table>
                        
                    <div style="padding:1%">
                        <table border="1" style="padding:1%">
                            <thead>
                            <tr >
                                <th style="text-align:center;width: 45px">N°<br>Ordre</th>
                                <th style="text-align:center;width: 400px">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 100px">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 100px">PAM</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();


        //Doctrine_Core::getTable('lignedocachat')->findByIdDoc($this->getId());
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;

            $html .= '<tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $nordre . '</p></td>
                                    <td style="text-align:center;width: 400px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getDesignationarticle() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getQte() . '</p></td>
                                    <td style="text-align:center;width: 100px"><p style="border-bottom: #000 dashed 1px !important">' . $lignedoc->getMntttc() . '</p></td>
                                    
                                   
                                </tr>';
            $nordre++;
        }
        for (
        $i = count($liste_demande_de_prix) + 1; $i <= 5; $i++
        ) {
            $html .= '<tr>
                                    <td style="text-align:center;width: 45px"><p style="border-bottom: #000 dashed 1px !important">' . $i . '</p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                    <td><p style="border-bottom: #000 dashed 1px !important"></p></td>
                                </tr>';
        }
        $html .= '<tr></tr>
                            </tbody>
                        </table>';

        $html .= '<div><div><table style="padding:5%"> <tr><td style="width: 50%">';
        $html .= ''
                . '<td>
                        <table border="1" style="padding:1%">
                            <tr>
                                <td>Total</td><td>' . $this->getMntttc() . ' TND</td>
                            </tr>
                        </table>
                    </td></tr></table>';

        $html .= '</div></div></div>
                </div>';

        return $html;
    }

    public function ReadHtmlBonCommandeInterne($aviss, $listesdocuments) {
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<div class="contenue">' .
                '<div class="titre"><h3>' . $numero . '<br>N°: ' . $this->getNumerodocachat() . '</h3></div>
                <div>
                    <table style="width:100%;">';
        $html .= '<tr>
                        <td style="font-size:14px;font-weight:bold;">Nature</td>
                        <td style="font-size:14px;font-weight:bold;">' . $this->getObjectdocument() . '</td> 
                    </tr>';
        if ($this->getIdTypedoc() == 6)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
                        <td><h6>' . $this->getAgents() . '</h6></td>
                    </tr>';
        if ($this->getIdTypedoc() != 6)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
                        <td><h6>';

        if ($this->getIdDocparent())
            $html .= $this->getDocumentparent()->getAgents();

        $html .= '</h6></td>
                    </tr>';

        $html .= '<tr>
                    <td style="font-size:12px;font-weight:bold;">Date création</td>
                    <td><h6>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</h6></td> 
                </tr>';

        if ($this->getIdTypedoc() == 6) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I';

            $html .= ' /DT';
            $html .= '</td><td><h6>'
                    . $this->getReference();

            $html .= '</h6></td>
                    </tr>';
        }

        if ($this->getIdTypedoc() == 9)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I.M.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
        if ($this->getIdTypedoc() == 21) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.D.C.R.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Montant</td>
                        <td><h6>' . $this->getMntttc() . ' /DT</h6></td>
                    </tr>';
        }
        $html .= '</table>
                </div>';

        $html .= '<div>
                    <table>
                        <tr>
                            <td style="width: 49%"></td>
                            <td>
                                <table class="tableclass">
                                    <tr>
                                        <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                                    </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($this->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div style="font-size: 20px">X</div>';
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";

            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            if (strpos($avis->getLibelle(), ":") == 0) {
                $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
            } else {
                $html .= ' <tr class="' . $class . '">
                <td colspan="2">' . $avislibelle . '</td>
              
            </tr>';
            }
        }

        $html .= '</table>
                        </td>      
                    </tr>
                </table>
            </div>';
        if ($this->getIdTypedoc() != 9) {
            $lg1 = "205px";
            $lg2 = "205px";
        } else {
            $lg1 = "260px";
            $lg2 = "260px";
        }
        if ($this->getIdTypedoc() != 21) {
            $html .= '<div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                <th style="width:30px;height:30px;"></th>
                <th style="width: ' . $lg1 . '">Désignation</th>
                <th style="width:70px;">QTE. (Unité)</th>
                <th style="width: ' . $lg2 . '">Projet et Observation</th>   ';
            if ($this->getIdTypedoc() != 9)
                $html .= '<th style="width:60px;">P.E.</th>
                <th style="width:60px;">P.A.</th>';
            $html .= '</tr>             
        <tbody>';

            $lg = new Lignedocachat();
            $i = 0;
            $class = "secondtd";
            foreach ($listesdocuments as $lignedoc) {
                $var = $i % 2;
                // die($var.'hh');
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lg = $lignedoc;

                $qtedemander = 0;
                $qtees = 0;
                $qteas = 0;
                $qteap = 0;
                $qteep = 0;
                $qteea = 0;
                $qteaa = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
                if ($qteligne) {
                    if ($this->getIdTypedoc() == 18)
                        $qtedemander = $qteligne->getQtelivrefrs();
                    else
                        $qtedemander = $qteligne->getQtedemander();
                    $qteas = $qteligne->getQteas();
                    $qtees = $qteligne->getQtees();
                    $qteap = $qteligne->getQteap();
                    $qteep = $qteligne->getQteep();
                    $qteaa = $qteligne->getQteaachat();
                    $qteea = $qteligne->getQteeachat();
                }
                if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                    $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
                else
                    $qte_unite = $qtedemander;

                $html .= ' <tr class="font-size:12px; ' . $class . '">
                <td>' . sprintf('%02d', $lg->getNordre()) . '</td>
                <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                <td>' . $qte_unite . '</td><td>';
                if ($lg->getIdProjet())
                    $html .= 'Projet:' . $lg->getProjet() . '<br >';
                if ($lg->getObservation() && $lg->getObservation() != "")
                    $html .= 'Observation: ' . $lg->getObservation();
                $html .= '</td>';
                if ($this->getIdTypedoc() != 9)
                    $html .= '<td><p >' . $qteea . '</p></td>
                <td><p >' . $qteaa . '</p></td>';
                $html .= ' </tr>';
            }
            $html .= '</tbody></table></div></div>';
            $html .= '<div>
            <table>
      <tr>';

            $html .= '</tr></table>
            </div>';
        }

        if ($this->getIdTypedoc() == 21) {
            $html .= '<b><legend>Liste des BDCSP</legend></b><br>
                <div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                     <th >Numero BDC</th>
                <th>Date Création</th>
                <th >M.T.T.C</th>
                <th >Fournisseur</th>   ';
            $html .= '</tr>             
        <tbody>';
            $bdcprs = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($this->getIdDocparent(), 17);
            foreach ($bdcprs as $pdcpr) :

                $html .= ' <tr class="font-size:12px">
                <td>'
                        . $pdcpr->getNumerodocachat()
                        . '</td>
                <td style="text-align:center;">' . date('d/m/Y', strtotime($pdcpr->getDatecreation())) . '</td>
              <td>';
                $html .= $pdcpr->getMntttc() . '</td >';

                $html .= '<td>' . $pdcpr->getFournisseur() . '</td>';
                $html .= ' </tr>';


            endforeach;
            $html .= '</tbody></table></div>';
        }
        $html .= '</div>';
        return $html;
    }

    public function ReadHtmlBonCommandeJeton($aviss, $listesdocuments) {
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<div class="contenue">' .
                '<div class="titre"><h3>' . $numero . '<br>N°: ' . $this->getNumerodocachat() . '</h3></div>
                <div>
                    <table style="width:100%;">';
        $html .= '<tr>
                        <td style="font-size:14px;font-weight:bold;">Nature</td>
                        <td style="font-size:14px;font-weight:bold;">' . $this->getObjectdocument() . '</td> 
                    </tr>';
        if ($this->getIdTypedoc() == 6)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
                        <td><h6>' . $this->getAgents() . '</h6></td>
                    </tr>';
        if ($this->getIdTypedoc() != 6)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
                        <td><h6>';

        if ($this->getIdDocparent())
            $html .= $this->getDocumentparent()->getAgents();

        $html .= '</h6></td>
                    </tr>';

        $html .= '<tr>
                    <td style="font-size:12px;font-weight:bold;">Date création</td>
                    <td><h6>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</h6></td> 
                </tr>';

        if ($this->getIdTypedoc() == 6) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I';

            $html .= ' /DT';
            $html .= '</td><td><h6>'
                    . $this->getReference();

            $html .= '</h6></td>
                    </tr>';
        }

        if ($this->getIdTypedoc() == 9)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I.M.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
        if ($this->getIdTypedoc() == 21) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.D.C.R.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Montant</td>
                        <td><h6>' . $this->getMntttc() . ' /DT</h6></td>
                    </tr>';
        }
        $html .= '</table>
                </div>';

        $html .= '<div>
                    <table>
                        <tr>
                            <td style="width: 49%"></td>
                            <td>
                                <table class="tableclass">
                                    <tr>
                                        <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                                    </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($this->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div style="font-size: 20px">X</div>';
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";

            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            if (strpos($avis->getLibelle(), ":") == 0) {
                $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
            } else {
                $html .= ' <tr class="' . $class . '">
                <td colspan="2">' . $avislibelle . '</td>
              
            </tr>';
            }
        }

        $html .= '</table>
                        </td>      
                    </tr>
                </table>
            </div>';
        if ($this->getIdTypedoc() != 9) {
            $lg1 = "205px";
            $lg2 = "205px";
        } else {
            $lg1 = "260px";
            $lg2 = "260px";
        }
        if ($this->getIdTypedoc() != 21) {
            $html .= '<div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                <th style="width:30px;height:30px;"></th>
                <th style="width: ' . $lg1 . '">Désignation</th>
                <th style="width:70px;">QTE. (Unité)</th>
                <th style="width: ' . $lg2 . '">Projet et Observation</th>   ';
            if ($this->getIdTypedoc() != 9)
                $html .= '<th style="width:60px;">P.E.</th>
                <th style="width:60px;">P.A.</th>';
            $html .= '</tr>             
        <tbody>';

            $lg = new Lignedocachat();
            $i = 0;
            $class = "secondtd";
            foreach ($listesdocuments as $lignedoc) {
                $var = $i % 2;
                // die($var.'hh');
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lg = $lignedoc;

                $qtedemander = 0;
                $qtees = 0;
                $qteas = 0;
                $qteap = 0;
                $qteep = 0;
                $qteea = 0;
                $qteaa = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
                if ($qteligne) {
                    if ($this->getIdTypedoc() == 18)
                        $qtedemander = $qteligne->getQtelivrefrs();
                    else
                        $qtedemander = $qteligne->getQtedemander();
                    $qteas = $qteligne->getQteas();
                    $qtees = $qteligne->getQtees();
                    $qteap = $qteligne->getQteap();
                    $qteep = $qteligne->getQteep();
                    $qteaa = $qteligne->getQteaachat();
                    $qteea = $qteligne->getQteeachat();
                }
                if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                    $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
                else
                    $qte_unite = $qtedemander;

                $html .= ' <tr class="font-size:12px; ' . $class . '">
                <td>' . sprintf('%02d', $lg->getNordre()) . '</td>
                <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                <td>' . $qte_unite . '</td><td>';
                if ($lg->getIdProjet())
                    $html .= 'Projet:' . $lg->getProjet() . '<br >';
                if ($lg->getObservation() && $lg->getObservation() != "")
                    $html .= 'Observation: ' . $lg->getObservation();
                $html .= '</td>';
                if ($this->getIdTypedoc() != 9)
                    $html .= '<td><p >' . $qteea . '</p></td>
                <td><p >' . $qteaa . '</p></td>';
                $html .= ' </tr>';
            }
            $html .= '</tbody></table></div></div>';
            $html .= '<div>
            <table>
      <tr>';

            $html .= '</tr></table>
            </div>';
        }

        if ($this->getIdTypedoc() == 21) {
            $html .= '<b><legend>Liste des BDCSP</legend></b><br>
                <div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                     <th >Numero BDC</th>
                <th>Date Création</th>
                <th >M.T.T.C</th>
                <th >Fournisseur</th>   ';
            $html .= '</tr>             
        <tbody>';
            $bdcprs = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($this->getIdDocparent(), 17);
            foreach ($bdcprs as $pdcpr) :

                $html .= ' <tr class="font-size:12px">
                <td>'
                        . $pdcpr->getNumerodocachat()
                        . '</td>
                <td style="text-align:center;">' . date('d/m/Y', strtotime($pdcpr->getDatecreation())) . '</td>
              <td>';
                $html .= $pdcpr->getMntttc() . '</td >';

                $html .= '<td>' . $pdcpr->getFournisseur() . '</td>';
                $html .= ' </tr>';


            endforeach;
            $html .= '</tbody></table></div>';
        }
        $html .= '</div>';
        return $html;
    }

    public function ReadHtmlBonCommandeInterneMarche($aviss, $listesdocuments) {
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<div class="contenue">' .
                '<div class="titre"><h3>' . $numero . '<br>N°: ' . $this->getNumerodocachat() . '</h3></div>
                <div>
                    <table style="width:100%;">';
        //        $html.= '<tr>
        //                        <td style="font-size:14px;font-weight:bold;">Nature</td>
        //                        <td style="font-size:14px;font-weight:bold;">' . $this->getObjectdocument() . '</td> 
        //                    </tr>';
        //        if ($this->getIdTypedoc() == 6)
        $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
                        <td><h6>' . $this->getAgents() . '</h6></td>
                    </tr>';
        //        if ($this->getIdTypedoc() != 6)
        //            $html.= '<tr>
        //                        <td style="font-size:12px;font-weight:bold;">Nom et Prénom du demandeur</td>
        //                        <td>';
        //        if ($this->getIdDocparent())
        //            $html.= $this->getDocumentparent()->getAgents();
        //        $html.= '</h6></td>
        //                    </tr>';

        $html .= '<tr>
                    <td style="font-size:12px;font-weight:bold;">Date création</td>
                    <td><h6>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</h6></td> 
                </tr>';

        if ($this->getIdTypedoc() == 6) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I';

            $html .= ' /DT';
            $html .= '</td><td><h6>'
                    . $this->getReference();

            $html .= '</h6></td>
                    </tr>';
        }

        if ($this->getIdTypedoc() == 9)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.C.I.M.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
        if ($this->getIdTypedoc() == 21) {
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">B.D.C.R.P</td>
                        <td><h6>' . $this->getReference() . '</h6></td>
                    </tr>';
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Montant</td>
                        <td><h6>' . $this->getMntttc() . ' /DT</h6></td>
                    </tr>';
        }
        $html .= '</table>
                </div>';

        $html .= '<div>
                    <table>
                        <tr>
                            <td style="width: 49%"></td>
                            <td>
                                <table class="tableclass">
                                    <tr>
                                        <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                                    </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($this->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div style="font-size: 20px">X</div>';
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";

            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            if (strpos($avis->getLibelle(), ":") == 0) {
                $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
            } else {
                $html .= ' <tr class="' . $class . '">
                <td colspan="2">' . $avislibelle . '</td>
              
            </tr>';
            }
        }

        $html .= '</table>
                        </td>      
                    </tr>
                </table>
            </div>';
        if ($this->getIdTypedoc() != 9) {
            $lg1 = "205px";
            $lg2 = "205px";
        } else {
            $lg1 = "260px";
            $lg2 = "260px";
        }
        if ($this->getIdTypedoc() != 21) {
            $html .= '<div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                <th style="width:30px;height:30px;"></th>
                <th style="width: ' . $lg1 . '">Désignation</th>
                <th style="width:70px;">QTE. (Unité)</th>
                <th style="width: ' . $lg2 . '">Projet et Observation</th>   ';
            if ($this->getIdTypedoc() != 9)
                $html .= '<th style="width:60px;">P.E.</th>
                <th style="width:60px;">P.A.</th>';
            $html .= '</tr>             
        <tbody>';

            $lg = new Lignedocachat();
            $i = 0;
            $class = "secondtd";
            foreach ($listesdocuments as $lignedoc) {
                $var = $i % 2;
                // die($var.'hh');
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lg = $lignedoc;

                $qtedemander = 0;
                $qtees = 0;
                $qteas = 0;
                $qteap = 0;
                $qteep = 0;
                $qteea = 0;
                $qteaa = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
                if ($qteligne) {
                    if ($this->getIdTypedoc() == 18)
                        $qtedemander = $qteligne->getQtelivrefrs();
                    else
                        $qtedemander = $qteligne->getQtedemander();
                    $qteas = $qteligne->getQteas();
                    $qtees = $qteligne->getQtees();
                    $qteap = $qteligne->getQteap();
                    $qteep = $qteligne->getQteep();
                    $qteaa = $qteligne->getQteaachat();
                    $qteea = $qteligne->getQteeachat();
                }
                if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                    $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
                else
                    $qte_unite = $qtedemander;

                $html .= ' <tr class="font-size:12px; ' . $class . '">
                <td>' . sprintf('%02d', $lg->getNordre()) . '</td>
                <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                <td>' . $qte_unite . '</td><td>';
                if ($lg->getIdProjet())
                    $html .= 'Projet:' . $lg->getProjet() . '<br >';
                if ($lg->getObservation() && $lg->getObservation() != "")
                    $html .= 'Observation: ' . $lg->getObservation();
                $html .= '</td>';
                if ($this->getIdTypedoc() != 9)
                    $html .= '<td><p >' . $qteea . '</p></td>
                <td><p >' . $qteaa . '</p></td>';
                $html .= ' </tr>';
            }
            $html .= '</tbody></table></div></div>';
            $html .= '<div>
            <table>
      <tr>';

            $html .= '</tr></table>
            </div>';
        }

        if ($this->getIdTypedoc() == 21) {
            $html .= '<b><legend>Liste des BDCSP</legend></b><br>
                <div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                     <th >Numero BDC</th>
                <th>Date Création</th>
                <th >M.T.T.C</th>
                <th >Fournisseur</th>   ';
            $html .= '</tr>             
        <tbody>';
            $bdcprs = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($this->getIdDocparent(), 17);
            foreach ($bdcprs as $pdcpr) :

                $html .= ' <tr class="font-size:12px">
                <td>'
                        . $pdcpr->getNumerodocachat()
                        . '</td>
                <td style="text-align:center;">' . date('d/m/Y', strtotime($pdcpr->getDatecreation())) . '</td>
              <td>';
                $html .= $pdcpr->getMntttc() . '</td >';

                $html .= '<td>' . $pdcpr->getFournisseur() . '</td>';
                $html .= ' </tr>';


            endforeach;
            $html .= '</tbody></table></div>';
        }
        $html .= '</div>';
        return $html;
    }

    public function ReadHtmlBCIDuContratFac($aviss, $documentachat, $listesdocuments, $listesdocuments_contrat) {
        $contrat_provisoire = DocumentachatTable::getInstance()->find($this->getIdDocparent());
        $doc_achta_bci = DocumentachatTable::getInstance()->find($contrat_provisoire->getIdDocparent());

        $lignes_doc_bci = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $doc_achta_bci->getId())
                        ->orderBy('id asc')->execute();
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<div class="contenue" style="text-align: center;font-size:14px;"> <b>' .$this->getTypedoc().'</b>'.
                '<div >'
                . '<div class="titre" style="text-align: center;font-size:14px;"><label  >' . '' . ' '
                . '' . $this->getContratachat()->getReference() . '</label></div>'
                . '<br>'.  $this->getTypedoc()->getPrefixetype().' '.sprintf('%05d', $this->getNumero())   
                . '<div class="titre" style="text-align: center;font-size:14px;">'
                . '<label> ' .  $this->getContratachat()->getReference() . '</div></label></div>
                <div>
                    <table style="width:100%;">';
        $html .= '<tr>
                        <td style="font-size:14px;font-weight:bold;">Demandeur</td>
                        <td style="font-size:14px;;"><h6>' . $doc_achta_bci->getDemandeur() . '</h6></td> 
                    </tr>';

        $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Type</td>
                        <td><h6>';

        if ($this->getContratachat()->getType() == 0)
            $html .= 'Livraison Total';
        if ($this->getContratachat()->getType() == 1)
            $html .= 'Livraison Partiel';
        $html .= '</h6></td>
                    </tr>';


        $html .= '<tr>
                    <td style="font-size:12px;font-weight:bold;">Date création</td>
                    <td><h6>' . date('d/m/Y', strtotime($this->getContratachat()->getDatecreation())) . '</h6></td> 
                </tr>';
        $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Référence';
        $html .= '</td><td><h6>'
                . $this->getReference();
        $html .= '</h6></td>
                    </tr>';
        $html .= '</table>
                </div>';
        $html .= '<div>
                    <table>
                        <tr>
                            <td style="width: 49%"></td>
                            <td>
                                <table class="tableclass">
                                    <tr>
                                        <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                                    </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";

            $lgavis = LigavisdocTable::getInstance()->findOneByIdDocAndIdAvis($doc_achta_bci->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div style="font-size: 20px">X</div>';
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";

            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            if (strpos($avis->getLibelle(), ":") == 0) {
                $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
            } else {
                $html .= ' <tr class="' . $class . '">
                <td colspan="2">' . $avislibelle . '</td>
              
            </tr>';
            }
        }

        $html .= '</table>
                        </td>      
                    </tr>
                </table>
            </div>';
        if ($this->getIdTypedoc() != 9) {
            $lg1 = "205px";
            $lg2 = "205px";
        } else {
            $lg1 = "260px";
            $lg2 = "260px";
        }
        $html .= '<div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                <th style="width:30px;height:30px;"></th>
                <th style="width: ' . $lg1 . '">Désignation</th>
                <th style="width:70px;">QTE. (Unité)</th>
                <th style="width: ' . $lg2 . '">Projet et Observation</th>   ';
        if ($this->getIdTypedoc() != 9)
            $html .= '<th style="width:60px;">P.E.</th>
                <th style="width:60px;">P.A.</th>';
        $html .= '</tr>             
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";
        foreach ($lignes_doc_bci as $lignedoc) {
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                if ($this->getIdTypedoc() == 18)
                    $qtedemander = $qteligne->getQtelivrefrs();
                else
                    $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                $qteaa = $qteligne->getQteaachat();
                $qteea = $qteligne->getQteeachat();
            }
            if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
            else
                $qte_unite = $qtedemander;

            $html .= ' <tr class="font-size:12px; ' . $class . '">
                <td>' . sprintf('%02d', $lg->getNordre()) . '</td>
                <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                <td>' . $qte_unite . '</td><td>';
            if ($lg->getIdProjet())
                $html .= 'Projet:' . $lg->getProjet() . '<br >';
            if ($lg->getObservation() && $lg->getObservation() != "")
                $html .= 'Observation: ' . $lg->getObservation();
            $html .= '</td>';
            if ($this->getIdTypedoc() != 9)
                $html .= '<td><p >' . $qteea . '</p></td>
                <td><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody></table></div></div>';
        $html .= '<div>
            <table>
      <tr>';

        $html .= '</tr></table>
            </div>';

        $html .= '</div>';
        return $html;
    }

    public function ReadHtmlBonCommandeInternecontrat($aviss, $listesdocuments) {
        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        $html = '<div class="contenue">' .
                '<div class="titre"><h3>' . $numero . ' ' . $this->getContratachat()->getReference() . '<br> ' . $this->getNumerodocachat() . '</h3></div>
                <div>
                    <table style="width:100%;">';
        $html .= '<tr>
                        <td style="font-size:14px;font-weight:bold;">Nature</td>
                        <td style="font-size:14px;font-weight:bold;">' . $this->getObjectdocument() . '</td> 
                    </tr>';

        $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Type</td>
                        <td><h6>';
        if ($this->getContratachat()->getType() == 0)
            $html .= 'Livraison Total';
        if ($this->getContratachat()->getType() == 1)
            $html .= 'Livraison Partiel';
        $html .= '</h6></td>
                    </tr>';


        $html .= '<tr>
                    <td style="font-size:12px;font-weight:bold;">Date création</td>
                    <td><h6>' . date('d/m/Y', strtotime($this->getContratachat()->getDatecreation())) . '</h6></td> 
                </tr>';

        if ($this->getIdTypedoc() == 6)
            $html .= '<tr>
                        <td style="font-size:12px;font-weight:bold;">Contrat';

        $html .= ' /DT';
        $html .= '</td><td><h6>'
                . $this->getReference();

        $html .= '</h6></td>
                    </tr>';



        $html .= '</table>
                </div>';

        $html .= '<div>
                    <table>
                        <tr>
                            <td style="width: 49%"></td>
                            <td>
                                <table class="tableclass">
                                    <tr>
                                        <th colspan="2" style="width: 100%">Avis de l\'unité budget</th>
                                    </tr>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($this->getId(), $avis->getId());
            if ($lgavis)
                $str = '<div style="font-size: 20px">X</div>';
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avislibelle = "";

            if (strpos($avis->getLibelle(), ":") == 0)
                $avislibelle = $avis->getLibelle();
            else
                $avislibelle = '<p >' . $avis->getLibelle() . '</p>';
            if (strpos($avis->getLibelle(), ":") == 0) {
                $html .= ' <tr class="' . $class . '">
                <td style="width: 80%">' . $avislibelle . '</td>
                <td style="width: 20%;text-align:center">' . $str . '</td>
            </tr>';
            } else {
                $html .= ' <tr class="' . $class . '">
                <td colspan="2">' . $avislibelle . '</td>
              
            </tr>';
            }
        }

        $html .= '</table>
                        </td>      
                    </tr>
                </table>
            </div>';
        if ($this->getIdTypedoc() != 9) {
            $lg1 = "205px";
            $lg2 = "205px";
        } else {
            $lg1 = "260px";
            $lg2 = "260px";
        }
        $html .= '<div>
            <table class="tableligne" style="width:100%;">
            <tr style="background-color:#EDEDED;font-size:14px;">
                <th style="width:30px;height:30px;"></th>
                <th style="width: ' . $lg1 . '">Désignation</th>
                <th style="width:70px;">QTE. (Unité)</th>
                <th style="width: ' . $lg2 . '">Projet et Observation</th>   ';
        if ($this->getIdTypedoc() != 9)
            $html .= '<th style="width:60px;">P.E.</th>
                <th style="width:60px;">P.A.</th>';
        $html .= '</tr>             
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";
        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            // die($var.'hh');
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                if ($this->getIdTypedoc() == 18)
                    $qtedemander = $qteligne->getQtelivrefrs();
                else
                    $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                $qteaa = $qteligne->getQteaachat();
                $qteea = $qteligne->getQteeachat();
            }
            if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
            else
                $qte_unite = $qtedemander;

            $html .= ' <tr class="font-size:12px; ' . $class . '">
                <td>' . sprintf('%02d', $lg->getNordre()) . '</td>
                <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                <td>' . $qte_unite . '</td><td>';
            if ($lg->getIdProjet())
                $html .= 'Projet:' . $lg->getProjet() . '<br >';
            if ($lg->getObservation() && $lg->getObservation() != "")
                $html .= 'Observation: ' . $lg->getObservation();
            $html .= '</td>';
            if ($this->getIdTypedoc() != 9)
                $html .= '<td><p >' . $qteea . '</p></td>
                <td><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody></table></div></div>';
        $html .= '<div>
            <table>
      <tr>';

        $html .= '</tr></table>
            </div>';

        $html .= '</div>';
        return $html;
    }

    public function getExportBce() {
        $trouve = 0;
        $bd = Doctrine_Core::getTable('documentachat')->findOneByIdTypedocOrIdTypedocAndIdDocparent(7, 18, $this->getId());
        if ($bd)
            $trouve = 1;
        return $trouve;
    }

    public function getExportBdc() {
        $trouve = 0;
        $bd = Doctrine_Core::getTable('documentachat')->findOneByIdTypedocOrIdTypedocAndIdDocparent(2, 17, $this->getId());
        if ($bd)
            $trouve = 1;
        return $trouve;
    }

    public function getCountBdcOuBcc() {
        $trouve = 0;

        $bd = Doctrine_Core::getTable('documentachat')
                        ->createQuery('a')
                        ->whereIn('id_typedoc', array(17, 18, 7, 2))
                        ->AndWhere('id_docparent=' . $this->getId())->execute();
        if (count($bd) > 0)
            $trouve = 1;
        return $trouve;
    }

    public function ImpprimerDetailCheque() {
        $fournisseur = $this->getFournisseur();
        $rtl_chars_pattern = '/[\x{0590}-\x{05ff}\x{0600}-\x{06ff}]/u';
        if (preg_match($rtl_chars_pattern, $fournisseur))
            $fournisseur = '<span style="direction:rtl;">     ' . $fournisseur . ' : par remplie prix de Demande -</span>';
        else
            $fournisseur = "<span>     - Demande de prix remplie par : " . $fournisseur . "</span>";

        $html = '<style>
                p{font-size: 16px;}
                </style>';
        $html .= "<h2>Conditions Administratives</h2>
                    <p>
                    L’offre du fournisseur doit parvenir à L’ODRM portant la mention     
                    « Demande de prix N°" . $this->getNumerodossier() . "» Acquisition (" . $this->getObservation() . ")
                       </p> 
                     <p>  
                    Le dernier délai de la remise des offres est fixé au: " . date('d/m/Y', strtotime($this->getMaxreponsefrs())) . "</p>
                    <p>  <span>  •	Le cachet du bureau d'ordre fait foi.</span></p>
                    <p>  <span>  •	Le prix doit etre ferme et non révisable.</span></p>
                    <p>  <span>  •	Le choix se fait par article conforme et moins disant.</span> </p>
                    <p>  <span>  •	Copie de la patente.</span> </p>
                    <p>  <span>  •        Copie du registre de commerce</span> </p>
                    <p>  <span>  •	Mode de paiement : par virement.</span> </p>
                    <p>  <span>  •	Le fournisseur est tenu d’indiquer :</span></p>
                    <p>  <span>  •	La validité de l’offre……………………………………….</span></p>
                    <p>  <span>  •	Le délai de livraison……………………………………........</span></p>
                    <p>   	REMARQUE:</p>
                    <p>             •	Le fournisseur doit obligatoirement respecter les clauses suivantes :</p>
                      <p>                 " . $fournisseur . "</p>
                        <p>                <span>    - Sa qualité :……………………………………………………………….</span></p>
                       <p>           A défaut votre offre sera automatiquement refusée.<br>
                        N.B: Toute offre portant des surcharges, des ratures ou correcteur sera écartée.</p>";
        return $html;
    }

    public function ReadHtmlContrat($listesdocuments) {
        //'<div class="titre"><h3>' . strtoupper($this->getTypedoc()) . $this->getContratachat()->getReference().  '<br>N°: ' .  $this->getContratachat()->getNumero(). '</h3></div>
        //<div>
        $html = '<div class="contenue">   <h3>Fiche Contrat</h3>             
                    <table style="width:100%;">
                    <tr>
                            <td style="font-size:12px;font-weight:bold;">Non Contrat & Numéro </td>
                            <td style="border-bottom: 1px dashed #000000;">
                            <label>' . $this->getContratachat()->getReference() . ' N° ' . $this->getContratachat()->getNumero() . '</label></td> 
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Fournisseur</td>
                            <td style="border-bottom: 1px dashed #000000"><h6>' . $this->getContratachat()->getFournisseur() . '</h6></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date création</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . date('d/m/Y', strtotime($this->getContratachat()->getDatecreation())) . '</h6></td> 
                        </tr>
                        
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Total TTC</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $this->getContratachat()->getMontantcontrat() . '</h6></td> 
                        </tr>
                    </table>
                </div>';

        $html .= '<div>
            <table class="tableligne" style="width:100%;font-size:10px;">
            <tr style="background-color:#DEDEDE;">
                <th style="width:30px;">N°</th>
                <th style="width:205px;font-size:10px;">Désignation</th>
                <th style="width:80px;font-size:10px;">QTE. Unité</th>
                <th style="width:62px;font-size:10px;">P.U.H.T</th>
                <th style="width:62px;font-size:10px;">T.V.A</th>
                <th style="width:62px;font-size:10px;">Taux Fodec</th>
                <th style="width:62px;font-size:10px;">Fodec</th>
                 <th style="width:62px;font-size:10px;">T.TTC</th>
                <th style="width:205px;font-size:10px;">Observation</th>
            </tr>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";
        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                $qteaa = $qteligne->getQteaachat();
                $qteea = $qteligne->getQteeachat();
            }
            $html .= '<tr class="' . $class . '">
                        <td style="text-align:center;">' . sprintf('%02d', $lg->getNordre()) . '</td>
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td style="text-align:center;">' . number_format($lg->getQte(), 2, ".", " ") . " " . $lg->getUnitemarche() . '</td>
                        <td style="text-align:center;"><p >' . number_format($lg->getMntht(), 3, ".", " ") . '</p></td>
                        <td style="text-align:center;"><p >' . number_format($lg->getTva()->getValeurtva(), 2, ".", " ") . ' %</p></td>
                              <td style="text-align:center;"><p >';
            if ($lg->getIdTauxfodec() != null)
                $html .= $lg->getTauxfodec()->getLibelle();
            $html .= ' </p></td>                         
               <td style="text-align:center;"><p >';
            if ($lg->getIdTauxfodec() && $lg->getIdTauxfodec() != null)
                $html .= number_format($lg->getTauxfodec(), 3, ".", " ");
            $html .= '</p></td>                                            
               <td style="text-align:center;"><p >' . number_format($lg->getMntttc(), 3, ".", " ") . '</p></td>                         
               <td style="text-align:left;">' . $lg->getObservation() . '</td></tr>';
            $html .= '</tbody></table> </div> </div>';
        }

        return $html;
    }

    public function ReadHtmlBCIContrat($id) {

        $numero = strtoupper($this->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html = '<div class="contenue">
                 <div class="titre"><h3>' . $numero . ' ' . $this->getContratachat()->getReference() . '<br> ' . '</h3></div>
                    
                    <table style="width:100%;">
                    <tr>
                            <td style="font-size:12px;font-weight:bold;">Non Contrat & Numéro</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $this->getContratachat()->getReference() . ' N° ' . $this->getContratachat()->getNumero() . '</h6></td> 
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Fournisseur</td>
                            <td style="border-bottom: 1px dashed #000000"><h6>' . $this->getContratachat()->getFournisseur() . '</h6></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date création</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . date('d/m/Y', strtotime($this->getContratachat()->getDatecreation())) . '</h6></td> 
                        </tr>
                        
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Total TTC</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $this->getContratachat()->getMontantcontrat() . '</h6></td> 
                        </tr>
                         <tr>
                            <td style="font-size:12px;font-weight:bold;">Montant Plafonné</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $this->getContratachat()->getMontantplanfonne() . '</h6></td> 
                        </tr>
                    </table>
                </div>';

        $html .= '<div><legnd>Liste des articles</legend>
            <table class="tableligne" style="width:100%;font-size:10px;">
            <tr style="background-color:#DEDEDE;">
                <th style="width:30px;">N°</th>
                <th style="width:205px;font-size:10px;">Désignation</th>
                <th style="width:80px;font-size:10px;">QTE. Unité</th>
                <th style="width:62px;font-size:10px;">P.U.H.T</th>
                <th style="width:62px;font-size:10px;">T.V.A</th>
                <th style="width:62px;font-size:10px;">Taux Fodec</th>
                <th style="width:62px;font-size:10px;">Fodec</th>
                 <th style="width:62px;font-size:10px;">T.TTC</th>
                <th style="width:205px;font-size:10px;">Observation</th>
            </tr>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";
        if (sizeof($this->getContratachat()) >= 1 && $this->getContratachat()->getId() != null) {
            $listesdocuments = Doctrine_Core::getTable('lignecontrat')
                    ->createQuery('a')
                    ->where('id_contrat=' . $this->getContratachat()->getId())
                    ->andWhere('id_docparent is  null')
                    ->orderBy('id asc')
                    //                die($listesdocuments);
                    ->execute();
            foreach ($listesdocuments as $lignedoc) {
                $var = $i % 2;
                if ($var == 0)
                    $class = "fersttd";
                else
                    $class = "secondtd";
                $i++;
                $lg = $lignedoc;

                $qtedemander = 0;
                $qtees = 0;
                $qteas = 0;
                $qteap = 0;
                $qteep = 0;
                $qteea = 0;
                $qteaa = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
                $liste_ligne_contrat = Doctrine_Core::getTable('lignecontrat')->findByIdDocparent($lg->getId());

                if ($qteligne) {
                    $qtedemander = $qteligne->getQtedemander();
                    $qteas = $qteligne->getQteas();
                    $qtees = $qteligne->getQtees();
                    $qteap = $qteligne->getQteap();
                    $qteep = $qteligne->getQteep();
                    $qteaa = $qteligne->getQteaachat();
                    $qteea = $qteligne->getQteeachat();
                }
                $html .= '<tr class="' . $class . '">
                        <td style="text-align:center;">' . sprintf('%02d', $lg->getNordre()) . '</td>
                        <td style="text-align:left;">' . $lg->getDesignationartcile() . '</td>
                        <td style="text-align:center;">' . number_format($lg->getQte(), 2, ".", " ") . " " . $lg->getUnitemarche() . '</td>
                        <td style="text-align:center;"><p >' . number_format($lg->getMntht(), 3, ".", " ") . '</p></td>
                        <td style="text-align:center;"><p >' . number_format($lg->getTva()->getValeurtva(), 2, ".", " ") . ' %</p></td>
                              <td style="text-align:center;"><p >';
                if ($lg->getIdTauxfodec() != NULL)
                    $html .= $lg->getTauxfodec()->getLibelle();
                $html .= ' </p></td>                         
 <td style="text-align:center;"><p >' . number_format($lg->getFodec(), 3, ".", " ") . '</p></td>                                            
<td style="text-align:center;"><p >' . number_format($lg->getMntttc(), 3, ".", " ") . '</p></td>                         
                        <td style="text-align:left;">' . $lg->getObservation() . '</td>
                  
</tr>';
            }
        }
        $html .= '</tbody>
                </table>';
        if (sizeof($liste_ligne_contrat) >= 1):
            $html .= ' <table>
                    <legend>Sous détail du Ligne de contrat</legend>
                    <thead>
                    <th>N°Ordre</th>
                    <th>Designatioon Article</th>
                    <th>Type Pièce </th>
                    <th>Taux de Pourcentage</th>
                    </thead>
                    <tbody>';


            foreach ($liste_ligne_contrat as $ligne_lg) {

                $html .= '  <tr> <td>'
                        . sprintf('%02d', $ligne_lg->getNordre()) . '</td><td>'
                        . $ligne_lg->getDesignationartcile() . '</td>
                                <td >' . $ligne_lg->getTypepiececontrat()->getLibelle() . '</td>
                                <td style="text-align: right">' . $ligne_lg->getTauxpourcentage() . ' % ' . '</td>
                                
                            </tr> ';
            }
            $html .= '</tbody>
                </table>';
        endif;

        $mouvement = Doctrine_Core::getTable('lignemouvementfacturation')->findOneById($id);
        if (sizeof($mouvement) > 1):
            $html .= ' <table>
                    <legend>Détail du Mouvement</legend>
                    <thead>
                   
                    <th>Taux de Pourcentage</th>
                    <th>Montant</th>
                    </thead>
                    <tbody>';


            if (sizeof($mouvement) > 1) {
                if ($mouvement->getIdDocumentachat() != null) {
                    $documentachat = $mouvement->getDocumentachat();
                    //            $liste_ligne_contrat = Doctrine_Core::getTable('lignecontrat')->findByIdDocparent($lg->getId());

                    $html .= '  <tr>
                                <td style="text-align: right">' . intval($mouvement->getTauxpourcetage()) . ' % ' . '</td>
                                <td style="text-align: right">' . $mouvement->getMontant() . '</td>
                                
        </tr> ';
                }
            }

            $html .= '</tbody>
        </table>';
        endif;
        $html .= '</div>
                </div>';

        return $html;
    }

    public function ReadHtmlListeDocFournisseurProvisoire(sfWebRequest $request) {
        $id_type = $request->getParameter('id_type', '');
        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');
        $id_fournisseur = $request->getParameter('id_fournisseur', '');

        $listes = DocumentachatTable::getInstance()->getAllByFournisseurrprovisoire($date_debut, $date_fin, $id_fournisseur, $id_type);
        if ($id_fournisseur != 0)
            $fournisseur = FournisseurTable::getInstance()->find($id_fournisseur);
        if ($fournisseur) {
            $affiche_fournisseur = $fournisseur->getReference();
            if ($affiche_fournisseur != '')
                $affiche_fournisseur = $affiche_fournisseur . ' - ' . $fournisseur->getRs();
            else
                $affiche_fournisseur = $fournisseur->getRs();
        }

        $date_debut_affiche = '';
        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        $date_fin_affiche = '';
        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));


        $html = '<div class="contenue">';
        if ($id_type == 21) {
            $html .= '<div class="titre"><h3>Liste des B.D.C.S Regrouppe' . ' : ';
        } else if ($id_type == 17) {
            $html .= '<div class="titre"><h3>Liste des  B.D.C.S Provisoire' . ' : ';
        } else {
            $html .= '<div class="titre"><h3>Liste des B.C.E.S & B.D.C.S' . '<br>Fournisseur : ';
        }
        if ($fournisseur)
            $html .= $fournisseur->getRs();
        $html .= '</h3></div>
                <div>
                    <table style="width:70%;">
                    

                        <tr>
                            <td style="width:30%;font-size:12px;font-weight:bold;">Fournisseur</td>
                            <td style="width:70%;border-bottom: 1px dashed #000000"><h6>' . $affiche_fournisseur . '</h6></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Début</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_debut_affiche . '</h6></td> 
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Fin</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_fin_affiche . '</h6></td> 
                        </tr>
                    </table>
                </div>';

        $html .= '<div>
            <table class="tableligne" style="width:100%;font-size:10px;">
            <thead> 
            <tr style="background-color:#DEDEDE;">
                <th style="width:10%;">Numéro</th>
                <th style="width:12%;font-size:10px;">Date</th>
                <th style="width:12%;font-size:10px;">B.C.I.S</th>
                <th style="width:15%;font-size:10px;">Fournisseur</th>
                <th style="width:12%;font-size:10px;">Montant TTC</th>
                <th style="width:25%;font-size:10px;">Imputation budgétaire</th>
                <th style="width:13%;font-size:10px;">Ordonn.</th>
            </tr></thead> 
        <tbody>';

        $i = 0;
        $class = "secondtd";
        foreach ($listes as $doc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;

            $doc_achat = null;
            $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($doc->getId());
            if ($documents_parent->count() != 0) {
                foreach ($documents_parent as $document) {
                    $doc_achat = DocumentachatTable::getInstance()->find($document->getIdDocumentparent());
                }
            } else {
                $doc_achat = $doc->getDocumentparent();
            }

            $numero = '';
            if ($doc_achat != null)
                $numero = $doc_achat->getNumerodocachat();

            $imputation_budgetaire = '';
            if ($doc->ActionSignature() != "") {
                $imputation_budgetaire = html_entity_decode($doc->ActionSignature());
            }

            $numero_ordonnance = '';
            $piece_jointe_budget = PiecejointbudgetTable::getInstance()->findByIdDocachat($doc->getId());
            if ($piece_jointe_budget->count() != 0) {
                foreach ($piece_jointe_budget as $piece_jointe) {
                    if ($piece_jointe->getDocumentbudget()->getIdType() == 2) {

                        $numero_ordonnance = $piece_jointe->getDocumentbudget()->getNumero();
                    }
                }
            }

            $numero_quittance = '';
            $ligne = LigneoperationcaisseTable::getInstance()->findOneByIdDocachat($doc->getId());
            if ($ligne) {
                $numero_quittance = 'QUITTANCE' . $ligne->getCategorieoperation() . 'N°:' . $ligne->getNumerodocachat();
            }

            if ($numero_ordonnance != '') {
                if ($numero_quittance != '')
                    $numero_ordonnance = $numero_ordonnance . '<br>' . $numero_quittance;
            } else {
                $numero_ordonnance = $numero_quittance;
            }

            $html .= '<tr class="' . $class . '">
                        <td style="text-align:center;width:10%;">' . $doc->getNumerodocachat() . '</td>
                        <td style="text-align:center;width:12%;">' . date('d/m/Y', strtotime($doc->getDatecreation())) . '</td>
                        <td style="text-align:center;width:12%;">' . $numero . '</td>
                        <td style="text-align:left;width:15%;">' . $doc->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;width:12%;">' . number_format($doc->getMntttc(), 3, ".", " ") . '</td>
                        <td style="text-align:left;width:25%;">' . $imputation_budgetaire . '</td>
                        <td style="text-align:center;width:13%;">' . $numero_ordonnance . '</td>
                    </tr>';
        }
        $html .= '</tbody>
                </table>
                </div>
                </div>';

        return $html;
    }

    public function ReadHtmlListeDocContratFournisseurProvisoire(sfWebRequest $request) {
        $id_type = $request->getParameter('id_type', '');
        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');
        $id_fournisseur = $request->getParameter('id_fournisseur', '');

        $listes = DocumentachatTable::getInstance()->getAllByFournisseurContratrprovisoire($date_debut, $date_fin, $id_fournisseur, $id_type);
        if ($id_fournisseur != 0)
            $fournisseur = FournisseurTable::getInstance()->find($id_fournisseur);
        if ($fournisseur) {
            $affiche_fournisseur = $fournisseur->getReference();
            if ($affiche_fournisseur != '')
                $affiche_fournisseur = $affiche_fournisseur . ' - ' . $fournisseur->getRs();
            else
                $affiche_fournisseur = $fournisseur->getRs();
        }

        $date_debut_affiche = '';
        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        $date_fin_affiche = '';
        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));


        $html = '<div class="contenue">';
        if ($id_type == 20)
            $html .= '<div class="titre"><h3>Liste des Contrats Définitifs' . '<br>Fournisseur : ';
        else
            $html .= '<div class="titre"><h3>Liste des Contrats Provisoires' . '<br>Fournisseur : ';
        if ($fournisseur)
            $html .= $fournisseur->getRs();
        $html .= '</h3></div>
                <div>
                    <table style="width:70%;">
                    

                        <tr>
                            <td style="width:30%;font-size:12px;font-weight:bold;">Fournisseur</td>
                            <td style="width:70%;border-bottom: 1px dashed #000000"><h6>' . $affiche_fournisseur . '</h6></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Début</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_debut_affiche . '</h6></td> 
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Fin</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_fin_affiche . '</h6></td> 
                        </tr>
                    </table>
                </div>';

        $html .= '<div>
            <table class="tableligne" style="width:100%;font-size:10px;">
            <thead> 
            <tr style="background-color:#DEDEDE;">
                <th style="width:10%;">Numéro</th>
                <th style="width:10%;">Reference</th>
                <th style="width:10%;font-size:10px;">Date</th>
                <th style="width:10%;font-size:10px;">B.C.I.S</th>
                <th style="width:12%;font-size:10px;">Fournisseur</th>
                <th style="width:12%;font-size:10px;">Montant TTC</th>
                <th style="width:25%;font-size:10px;">Imputation budgétaire</th>
                <th style="width:12%;font-size:10px;">Ordonn.</th>
            </tr></thead> 
        <tbody>';
        $i = 0;
        $class = "secondtd";
        foreach ($listes as $doc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $doc_achat = null;
            $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($doc->getId());
            if ($documents_parent->count() != 0) {
                foreach ($documents_parent as $document) {
                    $doc_achat = DocumentachatTable::getInstance()->find($document->getIdDocumentparent());
                }
            } else {
                $doc_achat = $doc->getDocumentparent();
            }
            $numero = '';
            if ($doc_achat != null)
                $numero = $doc_achat->getNumerodocachat();
            $imputation_budgetaire = '';
            if ($doc->ActionSignature() != "") {
                $imputation_budgetaire = html_entity_decode($doc->ActionSignature());
            }
            $numero_ordonnance = '';
            $piece_jointe_budget = PiecejointbudgetTable::getInstance()->findByIdDocachat($doc->getId());
            if ($piece_jointe_budget->count() != 0) {
                foreach ($piece_jointe_budget as $piece_jointe) {
                    if ($piece_jointe->getDocumentbudget()->getIdType() == 2) {

                        $numero_ordonnance = $piece_jointe->getDocumentbudget()->getNumero();
                    }
                }
            }

            $numero_quittance = '';
            $ligne = LigneoperationcaisseTable::getInstance()->findOneByIdDocachat($doc->getId());
            if ($ligne) {
                $numero_quittance = 'QUITTANCE' . $ligne->getCategorieoperation() . 'N°:' . $ligne->getNumerodocachat();
            }

            if ($numero_ordonnance != '') {
                if ($numero_quittance != '')
                    $numero_ordonnance = $numero_ordonnance . '<br>' . $numero_quittance;
            } else {
                $numero_ordonnance = $numero_quittance;
            }

            $html .= '<tr class="' . $class . '">
                        <td style="text-align:center;width:10%;">' . $doc->getContratachat()->getNumero() . '</td>
                            <td style="text-align:center;width:10%;">' . $doc->getContratachat()->getReference() . '</td>
                        <td style="text-align:center;width:10%;">' . date('d/m/Y', strtotime($doc->getDatecreation())) . '</td>
                        <td style="text-align:center;width:10%;">' . 'BCI N° ' . sprintf('%05d', $doc->getNumero()) . '</td>
                        <td style="text-align:left;width:12%;">' . $doc->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;width:12%;">' . number_format($doc->getMntttc(), 3, ".", " ") . '</td>
                        <td style="text-align:left;width:25%;">' . $imputation_budgetaire . '</td>
                        <td style="text-align:center;width:12%;">' . $numero_ordonnance . '</td>
                    </tr>';
        }
        $html .= '</tbody>
                </table>
                </div>
                </div>';

        return $html;
    }

    public function ReadHtmlListeDocFournisseur(sfWebRequest $request) {
        $id_type = $request->getParameter('id_type', '');
        $type = $request->getParameter('type', '');
        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');
        $id_fournisseur = $request->getParameter('id_fournisseur', '');

        $listes = DocumentachatTable::getInstance()->getAllByFournisseur($date_debut, $date_fin, $id_fournisseur, $id_type, $type);
        if ($id_fournisseur != 0)
            $fournisseur = FournisseurTable::getInstance()->find($id_fournisseur);
        if ($fournisseur) {
            $affiche_fournisseur = $fournisseur->getReference();
            if ($affiche_fournisseur != '')
                $affiche_fournisseur = $affiche_fournisseur . ' - ' . $fournisseur->getRs();
            else
                $affiche_fournisseur = $fournisseur->getRs();
        }

        $date_debut_affiche = '';
        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        $date_fin_affiche = '';
        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));


        $html = '<div class="contenue">';
        if ($id_type && $type) {
            $html .= '<div class="titre"><h3>Liste des  B.D.C.S NULL' . ' : ';
        }
        $html .= '<div class="titre"><h3>Liste des B.C.E.S & B.D.C.S' . '<br>Fournisseur : ';
        if ($fournisseur)
            $html .= $fournisseur->getRs();
        $html .= '</h3></div>
                <div>
                    <table style="width:70%;">
                        <tr>
                            <td style="width:30%;font-size:12px;font-weight:bold;">Fournisseur</td>
                            <td style="width:70%;border-bottom: 1px dashed #000000"><h6>' . $affiche_fournisseur . '</h6></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Début</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_debut_affiche . '</h6></td> 
                        </tr>
                        <tr>
                            <td style="font-size:12px;font-weight:bold;">Date Fin</td>
                            <td style="border-bottom: 1px dashed #000000;"><h6>' . $date_fin_affiche . '</h6></td> 
                        </tr>
                    </table>
                </div>';

        $html .= '<div>
            <table class="tableligne" style="width:100%;font-size:10px;">
            <tr style="background-color:#DEDEDE;">
                <th style="width:75px;">Numéro</th>
                <th style="width:70px;font-size:10px;">Date</th>
                <th style="width:70px;font-size:10px;">B.C.I.S</th>
                <th style="width:100px;font-size:10px;">Fournisseur</th>
                <th style="width:80px;font-size:10px;">Montant TTC</th>
                <th style="width:200px;font-size:10px;">Imputation budgétaire</th>
                <th style="width:75px;font-size:10px;">Ordonn.</th>
            </tr>
        <tbody>';

        $i = 0;
        $class = "secondtd";
        foreach ($listes as $doc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;

            $doc_achat = null;
            $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($doc->getId());
            if ($documents_parent->count() != 0) {
                foreach ($documents_parent as $document) {
                    $doc_achat = DocumentachatTable::getInstance()->find($document->getIdDocumentparent());
                }
            } else {
                $doc_achat = $doc->getDocumentparent();
            }

            $numero = '';
            if ($doc_achat != null)
                $numero = $doc_achat->getNumerodocachat();

            $imputation_budgetaire = '';
            if ($doc->ActionSignature() != "") {
                $imputation_budgetaire = html_entity_decode($doc->ActionSignature());
            }

            $numero_ordonnance = '';
            $piece_jointe_budget = PiecejointbudgetTable::getInstance()->findByIdDocachat($doc->getId());
            if ($piece_jointe_budget->count() != 0) {
                foreach ($piece_jointe_budget as $piece_jointe) {
                    if ($piece_jointe->getDocumentbudget()->getIdType() == 2) {

                        $numero_ordonnance = $piece_jointe->getDocumentbudget()->getNumero();
                    }
                }
            }

            $numero_quittance = '';
            $ligne = LigneoperationcaisseTable::getInstance()->findOneByIdDocachat($doc->getId());
            if ($ligne) {
                $numero_quittance = 'QUITTANCE' . $ligne->getCategorieoperation() . 'N°:' . $ligne->getNumerodocachat();
            }

            if ($numero_ordonnance != '') {
                if ($numero_quittance != '')
                    $numero_ordonnance = $numero_ordonnance . '<br>' . $numero_quittance;
            } else {
                $numero_ordonnance = $numero_quittance;
            }

            $html .= '<tr class="' . $class . '">
                        <td style="text-align:center;">' . $doc->getNumerodocachat() . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($doc->getDatecreation())) . '</td>
                        <td style="text-align:center;">' . $numero . '</td>
                        <td style="text-align:left;">' . $doc->getFournisseur()->getRs() . '</td>
                        <td style="text-align:center;">' . number_format($doc->getMntttc(), 3, ".", " ") . '</td>
                        <td style="text-align:left;">' . $imputation_budgetaire . '</td>
                        <td style="text-align:center;">' . $numero_ordonnance . '</td>
                    </tr>';
        }
        $html .= '</tbody>
                </table>
                </div>
                </div>';

        return $html;
    }

    public function ReadHtmlStockDocument($id) {
        $ligne_document = LignedocachatTable::getInstance()->find($id);
        $documentachat = DocumentachatTable::getInstance()->find($ligne_document->getIdDoc());

        $html = '<div class="titre"><h3 style="font-size:18px;">Liste des Stocks Disponibles pour B.C.I</h3></div>';

        $html .= '<div>
                    <b>Article :</b> ' . $ligne_document->getArticle() . '<br>
                    <b>B.C.I &nbsp;&nbsp;&nbsp;:</b> ' . sprintf('%05d', $documentachat->getNumero()) . '
                </div>&nbsp;<br>';

        $html .= '<table border="1" cellpadding="5">
                    <thead>
                        <tr style="background-color: #D0D0D0;">
                            <th style="text-align: center; width: 10%;"><b>#</b></th>
                            <th style="width: 65%;"><b>Magasin</b></th>
                            <th style="text-align: center; width: 25%;"><b>Quantité</b></th>
                        </tr>
                    </thead>
                    <tbody>';
        $article_stocks = StockTable::getInstance()->findByIdArticle($ligne_document->getIdArticlestock());
        $total_qte = 0;
        foreach ($article_stocks as $article_stock) :
            $total_qte = $total_qte + $article_stock->getQtereel();
        endforeach;
        $k = 1;
        foreach ($article_stocks as $article_stock) :
            if ($article_stock->getQtereel() && $article_stock->getQtereel() != 0) :
                $html .= '<tr>
                        <td style="text-align: center; width: 10%;">' . $k . '</td>
                        <td style="width: 65%;">' . $article_stock->getMagasin() . '</td>
                        <td style="text-align: center; width: 25%;">' . $article_stock->getQtereel() . '</td>
                    </tr>';
                $k++;
            endif;
        endforeach;

        $html .= '<tfoot>
                        <tr style="background-color: #F0F0F0;">
                            <td colspan="2" style="text-align: right; width: 75%;"><b>Total : </b></td>
                            <td style="text-align: center; width: 25%;">' . $total_qte . '</td>
                        </tr>
                    </tfoot>';

        $html .= '</tbody>
                </table>&nbsp;<br><hr>';

        $html .= '<p ><b>Remarque :</b> Les stocks épuisés ( avec quantité 0 ) ne sont pas affichés dans le tableau si-dessus.</p>';

        return $html;
    }

    public function getBonCommandeInterneForm() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        if ($documentachat->getLigavisdoc()->getFirst())
            $ligprotitrub = $documentachat->getLigavisdoc()->getFirst()->getLigprotitrub();
        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; text-align:center;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                            ***
                            <table style="width:100%; margin-bottom:0px; margin-top: 6px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">Engagement budgétaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Exercice</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">';

        if ($ligprotitrub->getTitrebudjet()->getDatecreation())
            $html .= date('Y', strtotime($ligprotitrub->getTitrebudjet()->getDatecreation()));
        $html .= '</td></tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Budget</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getTitrebudjet() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Rubrique budgétaire</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getCode() . ' : ' . $ligprotitrub->getRubrique()->getLibelle() . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr style="background-color: #F0F0F0;">
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px; text-align:center;">P.E. Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px; text-align:center;">P.A. Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td>' . $qtedemander . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function getBonCommandeInterneFormBCIDContrat() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $contrat_achat = $documentachat->getContratachat()->getIdDocparent();
        $contra_achat_fils = ContratachatTable::getInstance()->findOneById($contrat_achat);
        $id_docparent = $contra_achat_fils->getIdDoc();
        $documentachatcontrat = DocumentachatTable::getInstance()->find($id_docparent);
        //        die($contra_achat_fils->getId().'fr'.$contrat_achat.'r'. sizeof($documentachatcontrat));
        if ($documentachatcontrat && $documentachatcontrat->getLigavisdoc())
            $ligprotitrub = $documentachatcontrat->getLigavisdoc()->getFirst()->getLigprotitrub();
        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; text-align:center;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                            ***';
        if ($ligprotitrub)
            $html = '<table style="width:100%; margin-bottom:0px; margin-top: 6px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">Engagement budgétaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Exercice</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . date('Y', strtotime($ligprotitrub->getTitrebudjet()->getDatecreation())) . '</td>
                                    </tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Budget</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getTitrebudjet() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Rubrique budgétaire</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getCode() . ' : ' . $ligprotitrub->getRubrique()->getLibelle() . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px; text-align:center;">P.E. Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px; text-align:center;">P.A. Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td>' . $lg->getQte() . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function getBonCommandeInterneFormBCIDUContrat() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $contrat_achat = $documentachat->getContratachat()->getIdDocparent();
        $contra_achat_fils = ContratachatTable::getInstance()->findOneById($contrat_achat);
        $id_docparent = $contra_achat_fils->getIdDoc();
        $documentachatcontrat = DocumentachatTable::getInstance()->find($id_docparent);
        //        die($contra_achat_fils->getId().'fr'.$contrat_achat.'r'. sizeof($documentachatcontrat));
        $ligprotitrub = $documentachatcontrat->getLigavisdoc()->getFirst()->getLigprotitrub();
        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; text-align:center;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                            ***
                            <table style="width:100%; margin-bottom:0px; margin-top: 6px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">Engagement budgétaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Exercice</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . date('Y', strtotime($ligprotitrub->getTitrebudjet()->getDatecreation())) . '</td>
                                    </tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Budget</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getTitrebudjet() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Rubrique budgétaire</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . $ligprotitrub->getCode() . ' : ' . $ligprotitrub->getRubrique()->getLibelle() . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité</th>
                         <th style="width: 50px; text-align:center;">Mnt.H.T</th>
                            <th style="width: 50px; text-align:center;">Mnt.T.T.C</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px; text-align:center;">P.E. Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px; text-align:center;">P.A. Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td style="text-align:center;">' . $lg->getQte() . '</td>
                        <td style="text-align:center;">' . $lg->getMntht() . '</td>
                        <td style="text-align:center;">' . $lg->getMntttc() . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function getBonCommandeInterneContratForm() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();

        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        if (sizeof($documentachat->getLigavisdoc()) >= 1)
            $ligprotitrub = $documentachat->getLigavisdoc()->getFirst()->getLigprotitrub();

        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; text-align:center;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat->getNumerodocumentachat() . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                            ***
                            <table style="width:100%; margin-bottom:0px; margin-top: 6px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">Engagement budgétaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Exercice</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">';
        if (sizeof($documentachat->getLigavisdoc()) >= 1)
            $html .= date('Y', strtotime($ligprotitrub->getTitrebudjet()->getDatecreation()));
        $html .= '</td>
                                    </tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Budget</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">';
        if (sizeof($documentachat->getLigavisdoc()) >= 1)
            $html .= $ligprotitrub->getTitrebudjet();
        $html .= '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Rubrique budgétaire</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">';
        if (sizeof($documentachat->getLigavisdoc()) >= 1)
            $html .= $ligprotitrub->getCode() . ' : ' . $ligprotitrub->getRubrique()->getLibelle();
        $html .= '</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px; text-align:center;">P.E. Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px; text-align:center;">P.A. Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td>' . $qtedemander . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >';
            if (sizeof($lg->getLigprotitrub()) >= 1)
                $html .= $lg->getLigprotitrub()->getTitreEtRubrique();
            $html .= '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function getBonCommandeInterneFormContrat() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getIdDocparent());

        $doc_parent = Doctrine_Core::getTable('documentachat')->findOneById($documentachat->getIdDocparent());
//        die($doc_parent->getId().'fe'.$documentachat->getId());
        $doc_parent_doc = Doctrine_Core::getTable('documentachat')->findOneById($doc_parent->getId());
//                die($doc_parent_doc->getId().'id=');
        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $doc_parent_doc->getId())->orderBy('id asc')->execute();
        if (sizeof($doc_parent_doc->getLigavisdoc()) >= 1)
            $ligprotitrub = $doc_parent_doc->getLigavisdoc()->getFirst()->getLigprotitrub();
        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; text-align:center;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                               </tbody>
                            </table>
                            ***
                            <table style="width:100%; margin-bottom:0px; margin-top: 6px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">Engagement budgétaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Exercice</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">';
        if ($ligprotitrub)
            $html.=date('Y', strtotime($ligprotitrub->getTitrebudjet()->getDatecreation()));
        $html.='</td>
                                    </tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Budget</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">';
        if ($ligprotitrub)
            $html.= $ligprotitrub->getTitrebudjet();
        $html.='</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Rubrique budgétaire</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">';
        if ($ligprotitrub)
            $html.=$ligprotitrub->getCode() . ' : ' . $ligprotitrub->getRubrique()->getLibelle();
        $html.='</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité</th>
                        <th style="width: ' . $lg2 . '">Projet et Motif pour Achat</th>   ';
        if ($documentachat->getIdTypedoc() != 9)
            $html .= '<th style="width: 100px; text-align:center;">P.E. Stk.|Patr.<br>Unité achat</th>
                    <th style="width: 80px; text-align:center;">P.A. Stk.|Patr.<br>Unité achat</th>';
        $html .= '</tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }
            //$qtedemander
            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td>' . $lg->getQte() . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '</td>';
            if ($documentachat->getIdTypedoc() != 9)
                $html .= '<td>' . $qtees . '|' . $qteep . '<br><p >' . $qteea . '</p></td>
                        <td>' . $qteas . '|' . $qteap . '<br><p >' . $qteaa . '</p></td>';
            $html .= ' </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function getBonCommandeInterneFormForAchat() {
        $aviss = AvisTable::getInstance()->getByPoste(5);
        $iddoc = $this->getId();
        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($this->getId());

        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        if (sizeof($documentachat->getLigavisdoc()) >= 1)
            $ligprotitrub = $documentachat->getLigavisdoc()->getFirst()->getLigprotitrub();
        $html = '';
        $html .= '<table style="margin-bottom: 0px;">
                    <tr>
                        <td style="width: 65%; vertical-align: top;">
                            <table style="width:100%; margin-bottom: 10px;">
                                <thead>
                                    <tr>
                                        <th colspan="2">' . $documentachat . '</th>
                                    </tr>
                                </thead>
                                <tbody>
                                 <tr>
                                        <td style="text-align: left;"><span><b>Nature</b></span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;font--size:14px"><b>' . $documentachat->getObjectdocument() . '</b></td> 
                                   </tr>
                                    <tr>
                                        <td style="width:35%; text-align: left;"><span>Nom et Prénom du demandeur</span></td>
                                        <td style="width:65%; border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getAgents() . '</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;"><span>Date création</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td> 
                                   </tr>
                                  
                                   <tr>
                                        <td style="text-align: left;"><span>B.C.I / DT </span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . $documentachat->getReference() . '</td> 
                                   </tr>
                                   <tr>
                                        <td style="text-align: left;"><span>Montant Estimatif</span></td>
                                        <td style="border-bottom: 1px dashed #000000; text-align: left;">' . number_format($documentachat->getMontantestimatif(), 3, '.', ' ') . ' TND</td> 
                                   </tr>
                               </tbody>
                            </table>
                        </td>
                    <td>
                        <table class="tableclass" style="margin-bottom: 0px;">
                            <thead>
                                <tr>
                                    <th colspan="2" style="width: 100%; text-align: center;">Avis de l\'unité budget</th>
                                </tr>
                            </thead>';
        $i = 0;
        $class = "secondtd";
        foreach ($aviss as $avis) {
            $str = "";
            $lgavis = Doctrine_Core::getTable('ligavisdoc')->findOneByIdDocAndIdAvis($documentachat->getId(), $avis->getId());
            if ($lgavis)
                $str = 'X';
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $avis_color = "";
            if (strpos($avis->getLibelle(), ":") == 0) {
                //Rien à faire
            } else {
                $avis_color = 'color: #740808';
            }
            $html .= '<tr class="' . $class . '">
                        <td style="width: 80%; text-align: left;">' . $avis->getLibelle() . '</td>
                        <td style="width: 20%; text-align: center; font-size: 14px;">' . $str . '</td>
                    </tr>';
        }

        $html .= '</table>
            </td>      
            </tr>
            </table>';
        if ($documentachat->getIdTypedoc() != 9) {
            $lg1 = "200px";
            $lg2 = "200px";
        } else {
            $lg1 = "290px";
            $lg2 = "290px";
        }
        $html .= '<table class="tableligne" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align:center;">N°</th>
                        <th style="width: ' . $lg1 . '">Désignation</th>
                        <th style="width: 50px; text-align:center;">Quantité(Unité)</th>
                        <th style="width: ' . $lg2 . '">Projet et Observation</th>
                        <th style="width: 100px; text-align:center;">P.E.</th>
                        <th style="width: 80px; text-align:center;">P.A.</th>
                    </tr>
            </thead>
        <tbody>';

        $lg = new Lignedocachat();
        $i = 0;
        $class = "secondtd";

        foreach ($listesdocuments as $lignedoc) {
            $var = $i % 2;
            if ($var == 0)
                $class = "fersttd";
            else
                $class = "secondtd";
            $i++;
            $lg = $lignedoc;

            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteap = 0;
            $qteep = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                $qteaa = $qteligne->getQteaachat();
                $qteea = $qteligne->getQteeachat();
            }
            if ($lg->getUnitedemander() != '' && $lg->getUnitedemander() != null)
                $qte_unite = $qtedemander . "<br>(" . trim($lg->getUnitedemander()) . ')';
            else
                $qte_unite = $qtedemander;


            $html .= '<tr class="' . $class . '">
                        <td>' . sprintf('%02d', $lg->getNordre()) . '</td>             
                        <td style="text-align:left;">' . $lg->getDesignationarticle() . '</td>
                        <td>' . $qte_unite . '</td>
                        <td style="text-align:left;">Projet:' . $lg->getProjet() . '<br >' . $lg->getLigprotitrub()->getTitreEtRubrique() . '<br> ' . $lg->getObservation() . '</td>
                        <td>' . $qteea . '</p></td>
                        <td>' . $qteaa . '</p></td>
                    </tr>';
        }
        $html .= '</tbody>
            </table>';

        return $html;
    }

    public function ReadHtmlBondeponseForm() {
        $html = '';
        $fournisseur = new Fournisseur();
        $adresse_frs = "";

        if ($this->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($this->getIdFrs());
            if ($frs) {
                $fournisseur = $frs;

                $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($this->getIdFrs());
                if ($adrs)
                    $adresse_frs = $adrs;
            }
        }

        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            if ($bci_numero == "")
                $bci_numero .= $doc_achat->getNumerodocachat();
            else
                $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        }

        $html .= '<div class="contenue">
                    <div>
                        <table style="float: left">
                            <tr>
                                <td style="width: 60%">
                                    <table>
                                        <tr>
                                            <td style="width: 55%; text-align: left;">' . $this->getTypedoc() . ' N° :</td>
                                            <td style="width: 35%; text-align: left;">' . $this->getNumerodocachat() . '</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;">Bon de commande Interne N° :</td>
                                            <td style="text-align: left;">' . $bci_numero . '</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;">Date de création :</td>
                                            <td style="text-align: left;">' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;">Lieu de livraison :</td>
                                            <td style="text-align: left;">' . $this->getLieulivraisson() . '</td>
                                        </tr>
                                    </table>
                                    <p>La direction Administrative et Financière est autorisée à effectuer les dépenses mentionnées ci-dessus</p>
                                </td>
                                <td style="width: 40%">
                                <table style="margin-bottom:0px;">
                                    <tr>
                                        <td>
                                            <table style="border: 2px dashed #000000;padding:2%; margin-bottom:0px;">
                                                <tr>
                                                    <td colspan="2"><p style="border-bottom: 2px dashed #000000;">Raison sociale ou matricule fiscale du fournisseur consulté</p></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-aling:center">' . $this->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '</td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align: left; width: 20%;">Adresse :</td>
                                                    <td style="width: 80%;">' . $adresse_frs . '</td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="text-align: left;">Tél: ' . $fournisseur->getTel() . '<br>E-Mail: ' . $fournisseur->getMail() . '<br>GSM: ' . $fournisseur->getGsm() . '</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            <div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style="width: 60%;float:right"><table style="border: 2px dashed #000000;padding:2%;">
                    <tr><td colspan="5"><p style="border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
        <tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style="width: 90px">Chapitre</td>
                    <td>Titre</td> 
                    <td>ART</td>
                    <td>PAR</td>       
                    <td>S/P</td>
                </tr>               
                <tr>
                    <td colspan="5" >' . $rubrique . '</td>  
                </tr>
                </table></div>';
        }
        $html .= ' <table style="margin-bottom:0px;" class="tableligne">
                            <tr>
                                <td style="width: 100%">
                                <table class="tableligne" style="width:100%">
                        <thead>
                             <tr style="background-color:#EDEDED;font-weight:bold;">
                                <th style="text-align:center;width: 8%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 22%">DESIGNATION<br></th>
                                <th style="text-align:center;width: 10%">Qte </th>
                                <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>';
        $html .= '<th style="text-align:center;width: 10%">Total<br>H.T</th> ';
        if ($remise != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Remise</th>';


        if ($fodec != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Fodec</th>'
                    . ' <th style="text-align:center;width: 10%">Total<br>H.TVA</th>';

        $html .= ' 
                <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>';
        if ($this->getDroittimbre())
            $html .= '  <th style="text-align:center;width: 7%">Timbre</th>';
        $html .= '<th style="text-align:center;width: 10%">M.TTC.Net</th>
            </tr>
            </thead>
            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $this->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {

            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht() + $lignedoc->getMnttva() + $lignedoc->getMntfodec());
            $html .= ' <tr>
                        <td style="text-align:center;width: 8%">' . $nordre . '</td>
                        <td style="text-align:center;width: 22%">' . $lignedoc->getDesignationarticle() . '</td>';

            $html .= '<td style="text-align:center;width: 10%">';
            if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                $html .= intval($lignedoc->getQte());
            else
                $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
            $html .= '</td>';
            //$html .= '<td style="text-align:center;width: 10%">' . $lignedoc->getQte() . ' ' . $lignedoc->getUnitedemander() . '</td>';
            $prix_unitaire = floatval($lignedoc->getMntht() * (1 / $lignedoc->getQte()));
            $html .= ' <td style="text-align:center;width: 10%">' . number_format($prix_unitaire, 3, ',', ' ') . '</td>';
            $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';

            if ($remise != 0.000)
                $html .= ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
            if ($fodec != 0.000)
                $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
            $html .= '<td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>';
            if ($this->getDroittimbre())
                $html .= '<td style="text-align:center;width: 7%"></td>';

            $mnttc = $lignedoc->getMntttc();

            $html .= '  <td style="text-align:center;width: 10%">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                    </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();

            $somme_ttc = $somme_ttc + $lignedoc->getMntttc();
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr>
                    <td colspan="4">Total : </td>
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($remise != 0.000)
            $html .= '<td></td>';
        if ($fodec != 0.000)
            $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>';
        if ($this->getDroittimbre()) {

            $html .= '<td style="text-align:center;width: 10%">' . number_format($this->getDroittimbre(), 3, ',', ' ') . '</td>';
        }


        $html .= '         <td>' . number_format($this->getMntttc(), 3, ',', ' ') . '</td>
                </tr>
                            </tbody>
                        </table></td><td></td></tr></table>';

        if ($this->getIdTypedoc() == 2 || $this->getIdTypedoc() == 17) {
            $html .= '<div>
                     <table>
                     <tr><td style="width:52%"></td>
                     <td>';
            if ($this->getIdTypedoc() == 2) {
                $html .= '<table class="tableclass">                 
                        <tr style="border: #000 dashed 1px !important">
                            <td>Mnt H.T</td>
                            <td>Mnt TVA</td>
                            <td>Mnt TTC</td>
                        </tr>
                        <tr style="border: #000 dashed 1px !important">
                            <td style="text-align:right;">' . $this->getMht() . '</td>
                            <td style="text-align:right;">' . $this->getMnttva() . '</td>
                            <td style="text-align:right;">' . $this->getMntttc() . '</td>
                        </tr>
                    </table>';
            } else {
                if ($this->getIdTypedoc() == 17) {

                    $html .= '<table class="tableclass" >          
                            <tr style="border: #000 dashed 1px !important">
                                <td style="width:45%:text-align:center">Mnt TTC</td>
                            </tr>
                            <tr style="border: #000 dashed 1px !important">
                                <td style="text-align:right;" colspan="2">' . number_format($this->getMntttc(), 3, '.', ',') . ' DT</td>
                            </tr>
                        </table>';
                }
            }
            $html .= '</td></tr></table>
                </div>';
        }
        $html .= '</div>
        </div>';

        return $html;
    }

    public function ReadHtmlBoncommmande($iddoc) {


        $documentachat = Doctrine_Core::getTable('documentachat')->findOneById($iddoc);
        $listesdocuments = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $iddoc)
                        ->orderBy('id asc')->execute();
        $aviss = Doctrine_Core::getTable('avis')
                        ->createQuery('a')->where('id_poste=5')
                        ->orderBy('id asc')->execute();
        $html = ' <h3 style="font-size:18px;">Fiche Bon Commande Interne N°   <br>' . $documentachat->getNumerodocachat() . '</h3>
            ';

        $numero = strtoupper($documentachat->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);

        $html .= ' <br><h4 border="1" style="text-align:center;background-color:#DCDCDC;"><i>
            ' . $numero . '</i></h4>
            &nbsp;<br>
            <table style="margin-bottom: 2px;" >
                            
                            <tr>
                                <td style="width: 10%; height: 25px;font-size: 14px">N° :</td>
                                <td style="width: 40%; height: 25px;font-size: 14px"> ' . $documentachat->getNumerodocachat() . '</td>
                                <td style="width: 25%; height: 25px;font-size: 14px">Date création :</td>
                                <td style="width: 25%; height: 25px;font-size: 14px"> ' . date('d/m/Y', strtotime($documentachat->getDatecreation())) . '</td>
                            </tr>
                            <tr>
                                <td style="width: 10%; height: 25px;font-size: 14px">Nature</td>
                                <td style="width: 40%; height: 25px;font-size: 14px">' . $documentachat->getObjectdocument() . '</td>
                            
                                <td style="width: 25%; height: 15px;font-size: 14px">Montant Estimatif</td>
                                <td style="width: 25%; height: 35px;font-size: 14px">' . number_format($documentachat->getMontantestimatif(), 3, '.', ' ') . ' TND</td>
                            </tr>
                        </table>';
        $html .= ' <h4 border="1" style="text-align:center;background-color:#DCDCDC;"><i>
            ' . 'Données de base' . '</i></h4>
            &nbsp;<br>
            <table style="margin-bottom: 2px;" >
                            
                            <tr>
                                <td style="width: 30%; height: 25px;font-size: 14px">Nom et Prénom du demandeur :</td>
                                <td style="width: 70%; height: 25px;font-size: 14px"> ' . $documentachat->getAgents() . '</td></tr><tr>
                                <td style="width: 30%; height: 25px;font-size: 14px">Référence  :</td>
                                <td style="width: 70%; height: 25px;font-size: 14px"> ' . $documentachat->getReference() . '</td>
                            </tr>
                           
                        </table>';
        $html = '<h3 style="font-size:18px;">Liste des Articles</h3>';
        $html .= '<br>
        <table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
             <th>N°ordre</th>
                        <th>Code Article</th>
                        <th>Désignation</th>
                        <th>Quantité (Unité)</th>
                        <th>Projet</th>
                        <th>Observation</th>               
                        <th>
                            P.E.<br>Stock|Patrimoine<br>Unité Achat
                        </th>
                        <th>
                            P.A.<br>Stock|Patrimoine<br>Unité Achat
                        </th>
                    </tr>';
        $lg = new Lignedocachat();
        foreach ($listesdocuments as $lignedoc) {
            $lg = $lignedoc;
            $qtedemander = 0;
            $qtees = 0;
            $qteas = 0;
            $qteep = 0;
            $qteap = 0;
            $qteea = 0;
            $qteaa = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lg->getId());
            if ($qteligne) {
                $qtedemander = $qteligne->getQtedemander();
                $qteas = $qteligne->getQteas();
                $qtees = $qteligne->getQtees();
                $qteap = $qteligne->getQteap();
                $qteep = $qteligne->getQteep();
                if ($qteligne->getQteaachat())
                    $qteaa = $qteligne->getQteaachat();
                if ($qteligne->getQteeachat())
                    $qteea = $qteligne->getQteeachat();
            }

            $html .= '<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . sprintf('%02d', $lg->getNordre()) . '</td>
                        <td style="text-align:center;">' . $lg->getCodearticle() . '</td>
                        <td style="text-align:center;">' . $lg->getDesignationarticle() . '</td>';
            if ($lg->getUnitedemander()) :
                $html .= '<td>' . $lg->getQte() . " (" . trim($lg->getUnitedemander()) . ")" . '</td>';
            else :
                $html .= '<td>' . $lg->getQte() . '</td>';
            endif;
            $html .= ' <td style="text-align:center;">' . $lg->getProjet() . '</td>
                        <td style="text-align:center;">' . html_entity_decode($lg->getObservation()) . '</td>
                        <td>' . $qtees . '|' . $qteep . '<br>' .
                    $qteea . '</td>
                        <td>' . $fournisseur['famille'] . '</td>
                </tr>';
        }

        $html .= '</tbody></table>';
        return $html;
    }

    public function ReadENTETEBDC($iddoc) {
        $bce = DocumentachatTable::getInstance()->find($iddoc);
        $fournisseur = new Fournisseur();
        if ($bce->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($bce->getIdFrs());
            $fournisseur = $frs;
        }
        $adresse_frs = "";
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($bce->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($bce->getIdFrs())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($bce->getIdFrs());
        $numero = strtoupper($bce->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($bce->getIdFrs() && $adrs)
            $adresse_frs = $adrs;
        $html = '';
        $html .= '<div class="contenue">
                    <H3 >' . $numero . ' N°: ' . $bce->getNumerodocachat() . '</H3>
                     <table  >
                       <br>
                        <tr>
                        <td style="width: 50%">
                            <table > 
                            <tr><td ><b > </b></td></tr><br>
                                <tr>
                                    <td style="width: 50%">Bon de commande Interne N°</td>
                                    <td><p style="text-aling:left">' . $affiche_document_parent . '</p></td>
                                </tr>
                                <tr>
                                    <td>Date de création</td>
                                    <td><p>' . date('d/m/Y', strtotime($bce->getDatecreation())) . '</p></td>
                                </tr>
                                <tr>
                                    <td>Lieu de livraison</td>
                                    <td><p>' . $bce->getLieulivraisson() . '</p></td>
                                </tr>
                                 <tr>
                                    <td style="width: 100%">Bon Dépense au comptant</td></tr><tr>
                                    <br>
                                     <td>Référence</td>
                                    <td><p>' . $bce->getReference() . '</p></td>
                                </tr>
                            </table>                    
                        </td>
                           <td style="width: 50%">
                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                        <tr><td colspan="5" style="height:40px"><p style="border-bottom: 2px dashed #000000;text-align: center">IMPUTATION BUDGETAIRE</p></td></tr><br>
                    <tr style="font-size:13px">';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($bce->getId());
        $chapitre = "";
        $rubrique = "";
        $mnt = "";
        if ($piece) {
            $p = $piece;
            $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
            $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }
        $html .= '<td style="width: 70px">Chapitre</td>
            <td>Titre</td> 
            <td>ART</td>
            <td>PAR</td>       
            <td>S/P</td>
            </tr>
            <tr>
             <td colspan="5" >' . $rubrique . '</td>  
            </tr>
            </table>
            </td></tr></table>  
                   <div></div>
                        <table style="margin-bottom:0px;" >
                            <tr>
                                <td style="width: 100%">
                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
                                    <tr>
                                        <td style="text-align:left;">
                                            <table >
                                                <tr>
                                                   <td  colspan="2" style="text-align:center;height:40px"><p style="border-bottom: 2px dashed #000000;">FOURNISSEUR</p></td>
                                               </tr>
                                               <tr>
                                                   <td colspan="2" style="text-align:left">
                                                    ' . $bce->getFournisseur() . '<br>' . $fournisseur->getActivitetiers() . '
                                                   </td>
                                               </tr>
                                               <tr ><td style="height:10px"></td></tr>
                                               <tr>
                                                   <td >Adresse:</td>
                                                   <td>' . $adresse_frs . '</td>
                                               </tr>
                                               <tr>
                                                   <td colspan="2">Tél:  '
                . $fournisseur->getTel() . '<br>E-Mail:  ' . $fournisseur->getMail() .
                '<br>GSM:  ' . $fournisseur->getGsm() . '<br></td>
                                               </tr>
                                            </table>
                                        </td>                           
                                    </tr>
                                    <tr></tr>
                                </table>
                            </td>
                             <td style="width: 50%">';
        //                        <table style="border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
        //                                    <tr><td><p style="border-bottom: 2px dashed #000000;text-align: center;height:40px">DESIGNATION DE LA COMMANDE</p></td></tr>
        //                                    <tr>
        //                                        <td >' . $bce->getDesiegniation() . '</td>
        //                                    </tr>            
        //                                    <tr>
        //                                        <td >MONTANT : ' . number_format($bce->getMntttc(), 3, ',', '.') . ' TND<br>NOTE : ' . $bce->getNotesbce() . '<br>DATE MAX REPONSE : ' . date('d/m/Y', strtotime($bce->getMaxreponsefrs())) . '<br><br></td> 
        //                                    </tr>  
        //                                   
        //                                </table>
        $html .= '    </td>
                            </tr><br>
                        </table>
        <div></div>';

        return $html;
    }

    public function ReadENTETEBCE($iddoc) {
        $bce = DocumentachatTable::getInstance()->find($iddoc);
        $fournisseur = new Fournisseur();
        if ($bce->getIdFrs()) {
            $frs = Doctrine_Core::getTable('fournisseur')->findOneById($bce->getIdFrs());
            $fournisseur = $frs;
        }
        $adresse_frs = "";
        $affiche_document_parent = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($bce->getId());
        foreach ($documents_parent as $doc) {
            $doc_achat = DocumentachatTable::getInstance()->find($doc->getIdDocumentparent());
            $affiche_document_parent .= $doc_achat->getNumerodocachat();
        }
        if ($bce->getIdFrs())
            $adrs = Doctrine_Core::getTable('adressefrs')->findOneByIdFrs($bce->getIdFrs());
        $numero = strtoupper($bce->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);
        if ($bce->getIdFrs() && $adrs)
            $adresse_frs = $adrs;
        $html = '';
        $html .= '<div class = "contenue"  >
        <H3 >' . $numero . ' N°: ' . $bce->getNumerodocachat() . '</H3>
        <table  >
        <tr>
        <td style = "width: 50%"></td>
        <td style = "width: 50%; text-align: center;">Original à joindre à la facture</td>
        </tr><br>
        <tr>
        <td style = "width: 50%">
        <table >

        <tr>
        <td style = "width: 52%;font-size: 12px">Bon de commande Interne N°</td>
        <td><p style = "text-aling:left;font-size: 12px">' . $affiche_document_parent . '</p></td>
        </tr>
        <tr>
        <td style = "text-aling:left;font-size: 12px">Date de création</td>
        <td style = "text-aling:left;font-size: 12px"><p>' . date('d/m/Y', strtotime($bce->getDatecreation())) . '</p></td>
        </tr>
        <tr>
        <td style = "text-aling:left;font-size: 12px">Lieu de livraison</td>
        <td style = "text-aling:left;font-size: 12px"><p>' . $bce->getLieulivraisson() . '</p></td>
  </tr><br>
  <tr>  <td style = "width: 52%;font-size: 12px">Bon de commande Externe</td></tr><tr>
  <td style = "text-aling:left;font-size: 12px">Référence</td>             
<td style = "text-aling:left;font-size: 12px"><p>' . $bce->getReference() . '</p></td>
      </tr>
        </table>
        </td>
        <td style = "width: 50%">
        <table style = "border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
        <tr><td colspan = "5" style = "height:40px;font-size: 12px"><p style = "border-bottom: 2px dashed #000000;text-align: center">IMPUTATION BUDGETAIRE</p>
        </td></tr>
        <tr style = "font-size: 12px">';

        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($bce->getId());
        $chapitre = "";
        $rubrique = "";
        $mnt = "";
        if ($piece) {
            $p = $piece;
            $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
            $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
        }
        $html .= '<td style = "width: 85px">Chapitre</td>
        <td>Titre</td>
        <td>ART</td>
        <td>PAR</td>
        <td>S/P</td> ';
        $html .= '  </tr>
        <tr style = "font-size: 12px">
        <td colspan = "5" >';
        if ($piece) {

            $html .= $rubrique;
        }
        $html .= '</td> 
        </tr> </table>
        </td></tr></table> <div></div>
        <table style = "margin-bottom:0px;" >
        <tr style = "font-size: 12px">
        <td style = "width: 50%">
        <table style = "border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
        <tr style = "font-size: 12px">
        <td style = "text-align:left;">
        <table >
        <tr>
        <td colspan = "2" style = "text-align:center;"><p style = "border-bottom: 2px dashed #000000;">FOURNISSEUR</p></td>
        </tr>
        <tr>
        <td colspan = "2" style = "text-align:left">
        ';
        if ($fournisseur)
            $html .= $bce->getFournisseur() . ' ' . $fournisseur->getActivitetiers();
        $html .= ' </td> </tr>
        <tr ><td style = "height:10px"></td><br>
        <td >Adresse:</td>
        <td>' . $adresse_frs . '</td>
        </tr>
        <tr>
        <td colspan = "2">Tél: ';
        if ($fournisseur) {
            $html .= $fournisseur->getTel();
        }
        $html .= ' <br>E-Mail: ';
        if ($fournisseur) {
            $html .= $fournisseur->getMail();
        }
        $html .= '<br>GSM: ';
        if ($fournisseur) {
            $html .= $fournisseur->getGsm();
        }
        $html .= '<br></td><br>
        </tr><br>
        </table>
        </td>
        </tr>
        <tr></tr>
        </table>
        </td>
        <td style = "width: 50%">
        <table style = "border: 2px dashed #000000; padding:2%; margin-bottom:0px;">
        <tr style = "font-size: 12px"><td><p style = "border-bottom: 2px dashed #000000;text-align: center;height:40px">DESIGNATION DE LA COMMANDE</p></td></tr>
        <tr>';
        $mnttc = $bce->getMntttc();
        $html .= ' <td >MONTANT : ' . number_format($mnttc, 3, ', ', ' ') . ' TND<br>NOTE : ' . $bce->getNotesbce() . '<br>DATE MAX REPONSE : ';
        if ($bce->getMaxreponsefrs())
            $html .= date('d/m/Y', strtotime($bce->getMaxreponsefrs()));

        $html .= '</td>';
        $html .= '</tr>
        </table>
        </td>
        </tr>
        </table> ';

        return $html;
    }

    public function ReadBDCFooter($iddoc) {
        $bce = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        if ($bce->getDatesignature())
            $datesign = date('d/m/Y', strtotime($bce->getDatesignature()));

        return $html;
    }

    public function ReadBCEFooter($iddoc) {
        $bce = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $soc = new Societe();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $soc = $societe;
        $datesign = "";
        if ($bce->getDatesignature())
            $datesign = date('d/m/Y', strtotime($bce->getDatesignature()));
        //;page-break-inside: avoid;page-break-inside: auto  !important; display: inline-block
        $html .= '
       <div style="display: inline-block;position: relative; page-break-inside:auto;">     
         <table border = "1"  class="tableligne" align = "center"  margin-bottom:0px; cellpadding="3" style = "padding:2%;width: 100%;;text-align:center;margin-left:auto;margin-left: 2px; 
        " >
        <tr rowspan = "2" style="; page-break-after:auto 
        ">
        <td style = "width:60%;text-decoration: underline;font-size: 11px;
       "><p style = "text-align: center; ; display: inline-block;">Remarques Importantes </p>
        <p style="">1) L\'Exemplaire original de ce bon de commande doit être joint à la facture</p>
                                                            <p style="">2) la facture doit être établie en 4 exemplaires signée et arrétée en toutes lettres.</p>
                                                            <p style="">Elle doit en outre faire réference au numéro et à la date du présent Bon de commande</p>
                            <p style=""></p></td>
                        <td style="width:40%;font-size: 11px
                       "><p style="text-align: center;text-decoration: underline;">Le Directeur Général</p>
                            <p style="border-bottom: 1px dashed #000000; text-align:left;">Date : ' . $datesign . '</p>                                
                        </td>
                    </tr>                   
                    </table></div>
                    </div>
                </div>';
        return $html;
    }

    public function ReadHtmlBCEDefinitif($iddoc) {
        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $html .= $this->ReadENTETEBCE($iddoc);
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;

        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <div></div>';
        //die($fodec .' fr' .$bcedef->getDroittimbre() .'  t'. $remise );
        if ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">                                                               
        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        <thead>
         <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
             <td style="text-align:center;width: 5%">N°</td>
             <td style="text-align:center;width: 25%">DESIGNATION<br></td>
             <td style="text-align:center;width: 10%">Qte </td>
             <td style="text-align:center;width: 15%">P.H.T</td>
              <td style="text-align:center;width: 15%;">T.H.T</td>';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            //            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                    </tr>  
        </thead>
        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                    <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                // $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            //            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                       <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                           </tr>
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                                </div>';
        elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 10%">Qte </td>
                                                                                    <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                            </tr>
                     </tbody>
                 </table>
                 </div>';
        elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                 <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                     <td style="text-align:center;width: 5%">N°</td>
                     <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                     <td style="text-align:center;width: 8%">Qte </td>
                     <td style="text-align:center;width: 10%">P.H.T</td>
                      <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                        </tr>  
            </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                    <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre() == 1) {
                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }
            $html .= '  
                <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :

            $html .= '<div style="text-align:center;margin-left:auto; ">

            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
               <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                    <td style="text-align:center;width: 5%">N°</td>
                    <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                    <td style="text-align:center;width: 8%">Qte </td>
                    <td style="text-align:center;width: 8%">P.H.T</td>
                     <td style="text-align:center;width: 11%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                        </tr>  
                        </thead>
                        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                <td style="text-align:center;width: 8%">';
                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
            <td colspan="4">Total : </td>
            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre() == 1) {
                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                        </tr>
                 </tbody>
             </table>
             </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">                                                               
        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        <thead>
         <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
             <td style="text-align:center;width: 5%">N°</td>
             <td style="text-align:center;width: 25%">DESIGNATION<br></td>
             <td style="text-align:center;width: 10%">Qte </td>
             <td style="text-align:center;width: 13%">P.H.T</td>
              <td style="text-align:center;width: 13%;">T.H.T</td>';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                    </tr>  
        </thead>
        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }
            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                            </tr>
                     </tbody>
                 </table>
                 </div>';
        elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :


            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 4%;background-color:#E0E0E0;">N°</td>
                 <td style="text-align:center;width: 18%;background-color:#E0E0E0;">DESIGNATION<br></td>
                 <td style="text-align:center;width: 6%;background-color:#E0E0E0;">Qte </td>
                 <td style="text-align:center;width: 9%;background-color:#E0E0E0;">P.H.T</td>
                  <td style="text-align:center;width: 10%;background-color:#E0E0E0;">T.H.T</td> ';
            if ($remise != 0.000) {
                $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Remise</td>';
            }
            $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Fodec</td>'
                    . ' <td style="text-align:center;width: 12%;background-color:#E0E0E0;">T.H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;background-color:#E0E0E0;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;background-color:#E0E0E0;">M.TTC</td>';
            $html .= '  </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 6%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 10%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }
            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';

            $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            $html .= '  
                            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                </tr>';
            $html .= '</tbody>
                     </table>';
            $html .= '</div>';
        elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 4%">N°</td>
                 <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 6%">Qte </td>
                 <td style="text-align:center;width: 12%">P.H.T</td>
                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Fodec</td>';
            $html .= ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 6%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                //$html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>';
            $html .= ' <td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                       <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                           </tr>
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                                </div>';
        elseif ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 5%">N°</td>
                 <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 7%">Qte </td>
                 <td style="text-align:center;width: 12%">P.H.T</td>
                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Fodec</td>';
            $html .= ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                            <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 7%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                //$html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                // $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>';
            $html .= ' <td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            //  $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
         </tbody>
     </table>
     </div>';
        elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
    <thead>
     <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
         <td style="text-align:center;width: 4%">N°</td>
         <td style="text-align:center;width: 18%">DESIGNATION<br></td>
         <td style="text-align:center;width: 8%">Qte </td>
         <td style="text-align:center;width: 9%">P.H.T</td>
          <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                                                                                                                                     </tr>  
                                                                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';

                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';

            $html .= '<td style="text-align:center;"></td>';
            $html .= '  
                            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                </tr>
                         </tbody>
                     </table>
                     </div>';

        endif;
        $html .= '<DIV STYLE="page-break-before:avoid ; "></DIV>';

        $s = count($liste_demande_de_prix);
        if (($s % 43 > 5 && $s % 43 < 18)) {
            $html .= '<br pagebreak="true"/>';
        }
        $html .= $this->ReadBCEFooter($iddoc);
        return $html;
    }

    public function ReadHtmlContratFacDefinitif($iddoc) {
        // die($iddoc . 'rrdd');

        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $contrat = ContratachatTable::getInstance()->find($bcedef->getIdContrat());
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $html .= $this->ReadENTETEBCE($iddoc);
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;

        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <div></div>';
        //die($fodec .' fr' .$bcedef->getDroittimbre() .'  t'. $remise );
        if ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">                                                               
        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        <thead>
         <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
             <td style="text-align:center;width: 5%">N°</td>
             <td style="text-align:center;width: 25%">DESIGNATION<br></td>
             <td style="text-align:center;width: 10%">Qte </td>
             <td style="text-align:center;width: 15%">P.H.T</td>
              <td style="text-align:center;width: 15%;">T.H.T</td>';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            //            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                    </tr>  
        </thead>
        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                    <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                // $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            //            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                       <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                           </tr>
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                                </div>';
        elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 10%">Qte </td>
                                                                                    <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                            </tr>
                     </tbody>
                 </table>
                 </div>';
        elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                 <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                     <td style="text-align:center;width: 5%">N°</td>
                     <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                     <td style="text-align:center;width: 8%">Qte </td>
                     <td style="text-align:center;width: 10%">P.H.T</td>
                      <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                        </tr>  
            </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                    <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre() == 1) {
                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }
            $html .= '  
                <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :

            $html .= '<div style="text-align:center;margin-left:auto; ">

            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
               <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                    <td style="text-align:center;width: 5%">N°</td>
                    <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                    <td style="text-align:center;width: 8%">Qte </td>
                    <td style="text-align:center;width: 8%">P.H.T</td>
                     <td style="text-align:center;width: 11%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                        </tr>  
                        </thead>
                        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                <td style="text-align:center;width: 8%">';
                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
            <td colspan="4">Total : </td>
            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre() == 1) {
                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                        </tr>
                 </tbody>
             </table>
             </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">                                                               
        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        <thead>
         <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
             <td style="text-align:center;width: 5%">N°</td>
             <td style="text-align:center;width: 25%">DESIGNATION<br></td>
             <td style="text-align:center;width: 10%">Qte </td>
             <td style="text-align:center;width: 13%">P.H.T</td>
              <td style="text-align:center;width: 13%;">T.H.T</td>';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                    </tr>  
        </thead>
        <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }
            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                            </tr>
                     </tbody>
                 </table>
                 </div>';
        elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :


            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 4%;background-color:#E0E0E0;">N°</td>
                 <td style="text-align:center;width: 18%;background-color:#E0E0E0;">DESIGNATION<br></td>
                 <td style="text-align:center;width: 6%;background-color:#E0E0E0;">Qte </td>
                 <td style="text-align:center;width: 9%;background-color:#E0E0E0;">P.H.T</td>
                  <td style="text-align:center;width: 10%;background-color:#E0E0E0;">T.H.T</td> ';
            if ($remise != 0.000) {
                $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Remise</td>';
            }
            $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Fodec</td>'
                    . ' <td style="text-align:center;width: 12%;background-color:#E0E0E0;">T.H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;background-color:#E0E0E0;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 7%;background-color:#E0E0E0;">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;background-color:#E0E0E0;">M.TTC</td>';
            $html .= '  </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 6%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 10%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }
            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';

            $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            $html .= '  
                            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                </tr>';
            $html .= '</tbody>
                     </table>';
            $html .= '</div>';
        elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 4%">N°</td>
                 <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 6%">Qte </td>
                 <td style="text-align:center;width: 12%">P.H.T</td>
                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Fodec</td>';
            $html .= ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 6%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                //$html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>';
            $html .= ' <td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
                                                                                                                       <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                                                                           </tr>
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                                </div>';
        elseif ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 5%">N°</td>
                 <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 7%">Qte </td>
                 <td style="text-align:center;width: 12%">P.H.T</td>
                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Fodec</td>';
            $html .= ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
            // $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                </tr>  
                </thead>
            <tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                            <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 7%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                //$html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                // $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>';
            $html .= ' <td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            // if ($bcedef->getDroittimbre() == 1) {
            //  $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
            //     $somme_ttc = $somme_ttc + 0.600;
            // }


            $html .= '  
            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
         </tbody>
     </table>
     </div>';
        elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
    <thead>
     <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
         <td style="text-align:center;width: 4%">N°</td>
         <td style="text-align:center;width: 18%">DESIGNATION<br></td>
         <td style="text-align:center;width: 8%">Qte </td>
         <td style="text-align:center;width: 9%">P.H.T</td>
          <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                                                                                                                                     </tr>  
                                                                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                            <td style="text-align:center;width: 4%">' . $nordre . '</td>
                            <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>'
                        . '<td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td> '
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';

                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                   </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise != 0.000)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';

            $html .= '<td style="text-align:center;"></td>';
            $html .= '  
                            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                </tr>
                         </tbody>
                     </table>
                     </div>';

        endif;
        $html .= '<DIV STYLE="page-break-before:avoid ; "></DIV>';

        $s = count($liste_demande_de_prix);
        if (($s % 43 > 5 && $s % 43 < 18)) {
            $html .= '<br pagebreak="true"/>';
        }
        $html .= $this->ReadBCEFooter($iddoc);
        return $html;
    }

    public function ReadHtmlBCEProvisoire($iddoc) {
        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $html .= $this->ReadENTETEBCE($iddoc);
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }
        $html .= ' <div></div>';

        if ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                           <thead>
                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <td style="text-align:center;width: 5%">N°</td>
                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                <td style="text-align:center;width: 10%">Qte </td>
                                <td style="text-align:center;width: 15%">P.H.T</td>
                                 <td style="text-align:center;width: 15%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                                 </tr>  
                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }
            $html .= '<tr style="font-size:10px;font-weight:bold">
                <td colspan="4">Total : </td>
                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }
            $html .= '<td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                   </tr>
                         </tbody>
                     </table>
                  </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">

                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                           <thead>
                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                <td style="text-align:center;width: 5%">N°</td>
                                                                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                <td style="text-align:center;width: 10%">Qte </td>
                                                                                <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                 <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                 </tr>  
                                                                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                    <td colspan="4">Total : </td>
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }


            $html .= '  
                    <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                        </tr>
                 </tbody>
             </table>
             </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">

                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                           <thead>
                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                <td style="text-align:center;width: 5%">N°</td>
                                                                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                <td style="text-align:center;width: 10%">Qte </td>
                                                                                <td style="text-align:center;width: 12%">P.H.T</td>';
            $html .= ' <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';

            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                 </tr>  
                                                                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                        <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
            <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
            <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';

                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
            <td colspan="4">Total : </td>
            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td><td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }


            $html .= '  
                                                                                                                   <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                                                                                                                       </tr>
                                                                                                                </tbody>
                                                                                                            </table>
                                                                                                            </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">

                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                           <thead>
                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                <td style="text-align:center;width: 5%">N°</td>
                                                                                <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                                                                <td style="text-align:center;width: 8%">Qte </td>
                                                                                <td style="text-align:center;width: 10%">P.H.T</td>
                                                                                 <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                 </tr>  
                                                                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                        <td colspan="4">Total : </td>
                                                                                                        <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre() == 1) {
                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  
            <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                </tr>
         </tbody>
     </table>
     </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :

            $html .= '<div style="text-align:center;margin-left:auto; ">
        endif;
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
            <thead>
             <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 5%">N°</td>
                 <td style="text-align:center;width: 19%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 7%">Qte </td>
                 <td style="text-align:center;width: 10%">P.H.T</td>
                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                  </tr>                                                                                                                                       </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                        <td style="text-align:left;width: 19%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 7%">';
                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
            <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
            <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';

                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                    <td colspan="4">Total : </td>
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';

            $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }
            $html .= '<td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
             </tr>
       </tbody>
   </table>
   </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                                                                    
                                                                                                                                                                        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                                                                                                                                       <thead>
                                                                                                                                                                                        <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                                                                                                                            <td style="text-align:center;width: 5%">N°</td>
                                                                                                                                                                                            <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                                                                                                                                                                            <td style="text-align:center;width: 8%">Qte </td>
                                                                                                                                                                                            <td style="text-align:center;width: 8%">P.H.T</td>
                                                                                                                                                                                             <td style="text-align:center;width: 11%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                                                                                                                             </tr>  
                                                                                                                                                                                             </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                                                                                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                                                                                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                                                                                                                                    <td colspan="4">Total : </td>
                                                                                                                                                                                                                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }
            $html .= ' <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                </tr>
         </tbody>
        </table>
        </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">

                    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                   <thead>
                                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                        <td style="text-align:center;width: 5%">N°</td>
                                        <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                        <td style="text-align:center;width: 8%">Qte </td>
                                        <td style="text-align:center;width: 12%">P.H.T</td>
                                         <td style="text-align:center;width: 12%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 14%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            //   $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                                                                                                                                                                                         </tr>  
                                                                                                                                                                                         </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 14%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                                                                        </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                                                                                                                                <td colspan="4">Total : </td>
                                                                                                                                                                                                                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }
            $html .= ' <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
            </tr>
     </tbody>
    </table>
    </div>'; elseif ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">

            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                   <thead>
                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                        <td style="text-align:center;width: 5%">N°</td>
                        <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                        <td style="text-align:center;width: 10%">Qte </td>
                        <td style="text-align:center;width: 14%">P.H.T</td>';
            $html .= ' <td style="text-align:center;width: 14%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';

            //  $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                    </tr>  
                    </thead>
                    
<tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                        <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
            <td style="text-align:center;width: 14%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
            <td style="text-align:center;width: 14%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';

                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
                //  $html .= '<td style="text-align:center;width: 7%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
            <td colspan="4">Total : </td>
            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }


            $html .= '  
            <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                </tr>
         </tbody>
     </table>
     </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
            <thead>
             <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                 <td style="text-align:center;width: 4%">N°</td>
                 <td style="text-align:center;width: 18%">DESIGNATION<br></td>
                 <td style="text-align:center;width: 7%">Qte </td>
                 <td style="text-align:center;width: 9%">P.H.T</td>
                  <td style="text-align:center;width: 11%;">T.H.T</td> ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 10%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                  </tr>                                                                                                                                       </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                        <td style="text-align:center;width: 4%">' . $nordre . '</td>
                        <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 7%">';
                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
            <td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 10%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 7%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">'
                    . '<td colspan="4">Total : </td>   '
                    . ' <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($remise)
                $html .= '<td></td>';
            if ($fodec != 0.000)
                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }
            $html .= '    <td>' . number_format($bcedef->getMntttc(), 3, ',', ' ') . '</td>
                   </tr>
             </tbody>
         </table>
         </div>';
        endif;
        $html .= '<DIV STYLE="page-break-before:avoid ; "></DIV>';

        $s = count($liste_demande_de_prix);
        if (($s % 43 > 5 && $s % 43 < 18)) {
            $html .= '<br pagebreak="true"/>';
        }
        $html .= $this->ReadBCEFooter($iddoc);
        return $html;
    }

    public function ReadLignedocachat($id) {
        $bcedef = DocumentachatTable::getInstance()->find($id);
        //$html= '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())
                        ->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }

        if ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                           <thead>
                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <td style="text-align:center;width: 5%">N°</td>
                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                <td style="text-align:center;width: 10%">Qte </td>
                                <td style="text-align:center;width: 15%">P.H.T</td>
                                 <td style="text-align:center;width: 15%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                                 </tr>  
                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= ' </tbody>  </table> ';
        //            elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //
        //                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                                                                           <thead>
        //                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                                                                                <td style="text-align:center;width: 5%">N°</td>
        //                                                                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
        //                                                                                <td style="text-align:center;width: 10%">Qte </td>
        //                                                                                <td style="text-align:center;width: 13%">P.H.T</td>
        //                                                                                 <td style="text-align:center;width: 13%;">T.H.T</td> ';
        //            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
        //            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
        //            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
        //                                                                                 </tr>  
        //                                                                                 </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                                                                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                                                                                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
        //                                                                                                <td style="text-align:center;width: 10%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //                                                                                                <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //                                                                                                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
        //                $html .= '<td style="text-align:center;width: 8%"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //                    <td colspan="4">Total : </td>
        //                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($fodec != 0.000)
        //                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
        //            }
        //
        //
        //            $html .= '  
        //                    <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                        </tr>
        //                 </tbody>
        //             </table>
        //             </div>'; 
        //            elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //
        //                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                                                                           <thead>
        //                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                                                                                <td style="text-align:center;width: 5%">N°</td>
        //                                                                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
        //                                                                                <td style="text-align:center;width: 10%">Qte </td>
        //                                                                                <td style="text-align:center;width: 12%">P.H.T</td>';
        //            $html .= ' <td style="text-align:center;width: 12%;">T.H.T</td> ';
        //            if ($remise != 0.000)
        //                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
        //            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
        //
        //            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
        //            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
        //                                                                                 </tr>  
        //                                                                                 </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                        <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
        //                        <td style="text-align:center;width: 10%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //            <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //            <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //
        //                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
        //                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
        //                $html .= '<td style="text-align:center;width: 7%"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //            <td colspan="4">Total : </td>
        //            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($fodec != 0.000)
        //                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td><td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //
        //
        //            $html .= '  
        //                                                                                                                   <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                                                                                                                       </tr>
        //                                                                                                                </tbody>
        //                                                                                                            </table>
        //                                                                                                            </div>'; 
        //            elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //
        //                                                            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                                                                           <thead>
        //                                                                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                                                                                <td style="text-align:center;width: 5%">N°</td>
        //                                                                                <td style="text-align:center;width: 20%">DESIGNATION<br></td>
        //                                                                                <td style="text-align:center;width: 8%">Qte </td>
        //                                                                                <td style="text-align:center;width: 10%">P.H.T</td>
        //                                                                                 <td style="text-align:center;width: 13%;">T.H.T</td> ';
        //
        //            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
        //                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
        //            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
        //            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
        //                                                                                 </tr>  
        //                                                                                 </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                                                                                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                                                                                                <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
        //                                                                                                <td style="text-align:center;width: 8%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //                                                                                                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //                                                                                                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
        //                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
        //
        //                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //                                                                                                        <td colspan="4">Total : </td>
        //                                                                                                        <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($fodec != 0.000)
        //                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre() == 1) {
        //                $html .= '<td style="text-align:center;">' . number_format((0.600), 3, ',', ' ') . '</td>';
        //                $somme_ttc = $somme_ttc + 0.600;
        //            }
        //
        //
        //            $html .= '  
        //            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                </tr>
        //         </tbody>
        //     </table>
        //     </div>'; 
        //            elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
        //
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //        endif;
        //            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //            <thead>
        //             <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                 <td style="text-align:center;width: 5%">N°</td>
        //                 <td style="text-align:center;width: 19%">DESIGNATION<br></td>
        //                 <td style="text-align:center;width: 7%">Qte </td>
        //                 <td style="text-align:center;width: 10%">P.H.T</td>
        //                  <td style="text-align:center;width: 12%;">T.H.T</td> ';
        //            if ($remise != 0.000)
        //                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
        //            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
        //                    . ' <td style="text-align:center;width: 12%">Total<br>H.TVA</td>';
        //            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
        //            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
        //                  </tr>                                                                                                                                       </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                        <td style="text-align:left;width: 19%">' . $lignedoc->getDesignationarticle() . '</td>
        //                        <td style="text-align:center;width: 7%">';
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //            <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //            <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= ' <td style="text-align:center;width: 7%;">' . number_format($lignedoc->getMntremise(), 2, ',', ' ') . ' % </td>';
        //
        //                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
        //                        . ' <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
        //                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                                                                    </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //                    <td colspan="4">Total : </td>
        //                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //
        //            $html .= '<td></td>';
        //            if ($fodec != 0.000)
        //                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //            $html .= '<td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //             </tr>
        //       </tbody>
        //   </table>
        //   </div>'; 
        //            elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //                                                                                                                    
        //                                                                                                                                                                        <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                                                                                                                                                                                       <thead>
        //                                                                                                                                                                                        <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                                                                                                                                                                                            <td style="text-align:center;width: 5%">N°</td>
        //                                                                                                                                                                                            <td style="text-align:center;width: 20%">DESIGNATION<br></td>
        //                                                                                                                                                                                            <td style="text-align:center;width: 8%">Qte </td>
        //                                                                                                                                                                                            <td style="text-align:center;width: 8%">P.H.T</td>
        //                                                                                                                                                                                             <td style="text-align:center;width: 11%;">T.H.T</td> ';
        //
        //            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
        //                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
        //            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
        //            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
        //
        //            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
        //                                                                                                                                                                                             </tr>  
        //                                                                                                                                                                                             </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                                                                                                                                                                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                                                                                                                                                                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
        //                                                                                                                                                                                                            <td style="text-align:center;width: 8%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //                                                                                                                                                                                                            <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //                                                                                                                                                                                                            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
        //                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
        //
        //                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
        //                $html .= '<td style="text-align:center;width: 8%;"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                                                                                                                            </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //                                                                                                                                                                                                                    <td colspan="4">Total : </td>
        //                                                                                                                                                                                                                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($fodec != 0.000)
        //                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //            $html .= ' <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                </tr>
        //         </tbody>
        //        </table>
        //        </div>'; 
        //            elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //
        //                    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                                   <thead>
        //                                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                                        <td style="text-align:center;width: 5%">N°</td>
        //                                        <td style="text-align:center;width: 20%">DESIGNATION<br></td>
        //                                        <td style="text-align:center;width: 8%">Qte </td>
        //                                        <td style="text-align:center;width: 12%">P.H.T</td>
        //                                         <td style="text-align:center;width: 12%;">T.H.T</td> ';
        //
        //            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
        //                    . ' <td style="text-align:center;width: 14%">Total<br>H.TVA</td>';
        //            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
        //            //   $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
        //
        //            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
        //                                                                                                                                                                                         </tr>  
        //                                                                                                                                                                                         </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
        //                                                            <td style="text-align:center;width: 8%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //                                                <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //                                                <td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
        //                        . ' <td style="text-align:center;width: 14%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
        //
        //                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
        //                $html .= '<td style="text-align:center;width: 8%;"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                                                                                                                        </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //                                                                                                                                                                                                                <td colspan="4">Total : </td>
        //                                                                                                                                                                                                                <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($fodec != 0.000)
        //                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //            $html .= ' <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //            </tr>
        //     </tbody>
        //    </table>
        //    </div>';
        //            elseif ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //
        //            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //                   <thead>
        //                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                        <td style="text-align:center;width: 5%">N°</td>
        //                        <td style="text-align:center;width: 25%">DESIGNATION<br></td>
        //                        <td style="text-align:center;width: 10%">Qte </td>
        //                        <td style="text-align:center;width: 14%">P.H.T</td>';
        //            $html .= ' <td style="text-align:center;width: 14%;">T.H.T</td> ';
        //            if ($remise != 0.000)
        //                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
        //            $html .= '  <td style="text-align:center;width: 8%;">T.V.A</td>';
        //
        //            //  $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
        //            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
        //                    </tr>  
        //                    </thead>
        //                    
        //<tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
        //                        <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
        //                        <td style="text-align:center;width: 10%">';
        //
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //            <td style="text-align:center;width: 14%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //            <td style="text-align:center;width: 14%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //
        //                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
        //                $html .= ' <td style="text-align:center;width: 8%;">' . $lignedoc->getTva() . '</td>';
        //                //  $html .= '<td style="text-align:center;width: 7%"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">
        //            <td colspan="4">Total : </td>
        //            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($remise)
        //                $html .= '<td></td>';
        //            if ($fodec != 0.000)
        //                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td><td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //
        //
        //            $html .= '  
        //            <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                </tr>
        //         </tbody>
        //     </table>
        //     </div>'; 
        //            elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
        //            $html .= '<div style="text-align:center;margin-left:auto; ">
        //            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
        //            <thead>
        //             <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
        //                 <td style="text-align:center;width: 4%">N°</td>
        //                 <td style="text-align:center;width: 18%">DESIGNATION<br></td>
        //                 <td style="text-align:center;width: 7%">Qte </td>
        //                 <td style="text-align:center;width: 9%">P.H.T</td>
        //                  <td style="text-align:center;width: 11%;">T.H.T</td> ';
        //            if ($remise != 0.000)
        //                $html .= '  <td style="text-align:center;width: 7%">Remise</td>';
        //            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
        //                    . ' <td style="text-align:center;width: 10%">Total<br>H.TVA</td>';
        //            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
        //            $html .= '  <td style="text-align:center;width: 7%">Timbre</td>';
        //            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
        //                  </tr>                                                                                                                                       </thead><tbody>';
        //            foreach ($liste_demande_de_prix as $lgnedoc) {
        //                $lignedoc = $lgnedoc;
        //                $qte = 0;
        //                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
        //                if ($qteligne)
        //                    $qte = $qteligne->getQtelivrefrs();
        //                $prixhtax = $lignedoc->getMntht();
        //                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
        //                $html .= ' <tr style="font-size:10px;">
        //                        <td style="text-align:center;width: 4%">' . $nordre . '</td>
        //                        <td style="text-align:left;width: 18%">' . $lignedoc->getDesignationarticle() . '</td>
        //                        <td style="text-align:center;width: 7%">';
        //                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
        //                    $html .= intval($lignedoc->getQte());
        //                else
        //                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
        //                $html .= $lignedoc->getUnitedemander() . '</td>
        //            <td style="text-align:center;width: 9%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
        //            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
        //                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>';
        //                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
        //                        . ' <td style="text-align:center;width: 10%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
        //
        //                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
        //                $html .= '<td style="text-align:center;width: 7%;"></td>';
        //                $mnttc = $lignedoc->getMntttc();
        //                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
        //                                                                                                                                                    </tr>';
        //                $nordre++;
        //                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
        //                $somme_htax = $somme_htax + $prixhtax;
        //                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
        //                $somme_ttc = $somme_ttc + $mnttc;
        //                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        //            }
        //
        //            $html .= '<tr style="font-size:10px;font-weight:bold">'
        //                    . '<td colspan="4">Total : </td>   '
        //                    . ' <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        //            if ($remise)
        //                $html .= '<td></td>';
        //            if ($fodec != 0.000)
        //                $html .= '<td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
        //                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        //            $html .= '  <td></td>';
        //            if ($bcedef->getDroittimbre()) {
        //                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
        //            }
        //            $html .= '    <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
        //                   </tr>
        //             </tbody>
        //         </table>
        //         </div>';
        endif;
        return $html;
    }

    public function ReadHtmlBCIDucontrat($iddoc) {
        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;
        //        $html.=$this->ReadENTETEBCE($iddoc);
        $numero = strtoupper($bcedef->getTypedoc());
        $numero = str_replace(array('à', 'á', 'â', 'ã', 'ä', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', 'ù', 'ú', 'û', 'ü', 'ý', 'ÿ'), array('À', 'Á', 'Â', 'Ã', 'Ä', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', 'Ù', 'Ú', 'Û', 'Ü', 'Ý'), $numero);


        $html .= '<div class="contenue">
                    <H3 >' . $numero . ' N°: ' . $bcedef->getNumerodocachat() . '</H3>
                        </div>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <div></div><table style="margin-bottom:0px;width: 100%" >
                            <tr style="font-size: 12px">
                                <td style="width: 100%">
                                <table class="tableligne" style="width:100%">
                           <thead>
                            <tr>
                                <th style="text-align:center;width: 10%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 20%">DESIGNATION<br></th>
                                <th style="text-align:center;width: 10%">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 10%">P.Unit.<br>H.T</th>
                                 <th style="text-align:center;width: 10%">Total<br>H.T</th> ';

        if ($fodec != 0.000)
            $html .= '  <th style="text-align:center;width: 10%">Fodec</th>'
                    . ' <th style="text-align:center;width: 10%">Total<br>H.TVA</th>';

        $html .= ' 
                           <th style="text-align:center;width: 10%">Taux<br>T.V.A</th>
                            <th style="text-align:center;width: 10%">M.TTC</th>
                            </tr>
                            </thead>
                            <tbody>';



        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $prixhtax = $lignedoc->getMntht();
            $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
            $html .= ' <tr>
                        <td style="text-align:center;width: 10%">' . $nordre . '</td>
                        <td style="text-align:center;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 10%">' . $lignedoc->getQte() . ' ' . $lignedoc->getUnitedemander() . '</td>
                        <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                        <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
            if ($fodec != 0.000)
                $html .= '  <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
            $html .= '       <td style="text-align:center;width: 10%">' . $lignedoc->getTva() . '</td>
                        <td style="text-align:center;width: 10%">' . number_format((($lignedoc->getMntht()) + $lignedoc->getMnttva()), 3, ',', ' ') . '</td>
                    </tr>';
            $nordre++;
            $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
            $somme_htax = $somme_htax + $prixhtax;
            $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
            $somme_ttc = $somme_ttc + $prixttc;
            $somme_htva = $somme_htva + $lignedoc->getMntthtva();
        }

        $html .= '<tr>
                    <td colspan="3">Total : </td><td>' . number_format($somme_pru, 3, ',', ' ') . '</td>  
                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
        if ($fodec != 0.000)
            $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                    . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
        $html .= '  <td></td>
                               <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                </tr>
                            </tbody>
                        </table></td><td>
                        </td>
                        </tr>
                        </table>';
        //        $html.=$this->ReadBCEFooter($iddoc);
        //die($html);

        return $html;
    }

    public function ReadHtmlBDCDefinitif($iddoc) {
        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $html .= $this->ReadENTETEBDC($iddoc);
        $html .= '<div></div> <table style="margin-bottom:0px;width: 100%;padding-top: 2%; padding-bottom: 2%;" >
                            <tr>
                                <td style="width: 100%">
                                <table class="tableligne" style="width:100%">
                        <thead>
                            <tr>
                                <th style="text-align:center;width: 5%">N°<br>Ordre</th>
                                <th style="text-align:center;width: 25%">DESIGNATION<br>
                                    (indiquer,s\'il y a lieu, les références au catalogue du fournisseur)
                                </th>
                                <th style="text-align:center;width: 15%">Quantité<br> à livrer </th>
                                <th style="text-align:center;width: 12%">P.Unit.<br>H.T</th>
                                <th style="text-align:center;width: 12%">Taux<br>T.V.A</th>
                                <th style="text-align:center;width: 31%">Observations</th>
                            </tr>
                            </thead>
                            <tbody>';
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        foreach ($liste_demande_de_prix as $lgnedoc) {
            $lignedoc = $lgnedoc;
            $qte = 0;
            $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
            if ($qteligne)
                $qte = $qteligne->getQtelivrefrs();
            $html .= ' <tr>
                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                        <td style="text-align:center;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                        <td style="text-align:center;width: 15%">' . $qte . ' ' . $lignedoc->getUnitedemander() . '</td>
                        <td style="text-align:center;width: 12%">' . $lignedoc->getMntht() . '</td>
                        <td style="text-align:center;width: 12%">' . $lignedoc->getTva() . '</td>
                        <td style="text-align:center;width: 31%">' . $lignedoc->getObservation() . '</td>
                    </tr>';
            $nordre++;
        }

        $html .= '<tr>
                    <td colspan="6">Total TTC: ' . number_format($bcedef->getMntttc(), 3, ',', '.') . '</td>  
                </tr>
                            </tbody>
                        </table></td><td></td></tr></table>';
        $html .= $this->ReadBDCFooter($iddoc);
        //die($html);

        return $html;
    }

    public function ReadHtmlBDCProvisoire($iddoc) {
        $bcedef = DocumentachatTable::getInstance()->find($iddoc);
        $html = '';
        $html .= $this->ReadENTETEBDC($iddoc);
        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc=' . $bcedef->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        $remise = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
            $remise = $remise + $lignedoc->getMntremise();
        }

        $html .= ' <div></div>';

        if ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:left;margin-left:auto; ">
            
            <table class="tableligne" align = "left" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                           <thead>
                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <td style="text-align:center;width: 5%">N°</td>
                                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                <td style="text-align:center;width: 10%">Qte </td>
                                <td style="text-align:center;width: 15%">P.H.T</td>
                                 <td style="text-align:center;width: 15%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 15%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 15%;">M.TTC</td>
                                 </tr>  
                                 </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                <td style="text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                <td style="text-align:center;width: 15%;">' . number_format(($lignedoc->getMnhtaxnet()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 15%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                        <td colspan="4">Total : </td>
                                                        <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }


            $html .= '  
                                                                   <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                                       </tr>
                                                                </tbody>
                                                            </table>
                                                            </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 10%">Qte </td>
                                                                                    <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = 0;
                $somme_htax = 0;
                $somme_fdec = 0;
                $somme_ttc = 0;
                $somme_htva = 0;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">            
            <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                           <thead>
                            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                <td style="text-align:center;width: 5%">N°</td>
                                <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                                <td style="text-align:center;width: 8%">Qte </td>
                                <td style="text-align:center;width: 10%">P.H.T</td>
                                 <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
        </tr>  
        </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                    <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  
                <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                   <thead>
                    <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                        <td style="text-align:center;width: 5%">N°</td>
                        <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                        <td style="text-align:center;width: 8%">Qte </td>
                        <td style="text-align:center;width: 10%">P.H.T</td>
                         <td style="text-align:center;width: 13%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 8%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                                                                         </tr>  
                                                                                                                                         </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                                                                        <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                                                                        <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                                                                        <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                                                                        <td style="text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                                                                        <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                        </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                        <td colspan="4">Total : </td>
                        <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format(($bcedef->getDroittimbre()), 3, ',', ' ') . '</td>';
            }


            $html .= '  
                                                <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                                                    </tr>
                                             </tbody>
                                         </table>
                                         </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise == 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                                                                    
    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
               <thead>
                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                    <td style="text-align:center;width: 5%">N°</td>
                    <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                    <td style="text-align:center;width: 8%">Qte </td>
                    <td style="text-align:center;width: 8%">P.H.T</td>
                                                                                                                                                                                             <td style="text-align:center;width: 11%;">T.H.T</td> ';

            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                                                                                                                             </tr>  
                                                                                                                                                                                             </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                                                                                                                            <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                                                                                                                            <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                                                                                                                                    <td colspan="4">Total : </td>
                                                                                                                                                                                                                    <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }

            $html .= '   <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
                </tbody>
                </table>
                </div>'; elseif ($fodec != 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                 <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                <thead>
                 <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                    <td style="text-align:center;width: 4%">N°</td>
                    <td style="text-align:center;width: 20%">DESIGNATION<br></td>
                    <td style="text-align:center;width: 7%">Qte </td>
                    <td style="text-align:center;width: 7%">P.H.T</td>
                    ';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>'
                        . '<td style="text-align:center;width: 11%;">T.H.T.Net</td>';
            $html .= '  <td style="text-align:center;width: 7%">Fodec</td>'
                    . ' <td style="text-align:center;width: 11%">Total<br>H.TVA</td>';
            $html .= '  <td style="text-align:center;width: 7%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 11%;">M.TTC</td>'
                    . ' </tr> </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixhtaxnet = $lignedoc->getMnhtaxnet();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 4%">' . $nordre . '</td>
                    <td style="text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 7%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 7%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                    ';
                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>'
                        . '<td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMnhtaxnet()), 3, ',', ' ') . '</td> ';
                $html .= '  <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ',', ' ') . '</td>'
                        . ' <td style="text-align:center;width: 11%;">' . number_format(($lignedoc->getMntthtva()), 3, ',', ' ') . '</td>';
                $html .= ' <td style="text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 11%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                                                                                                                            </tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtaxnet;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }
            $html .= '<tr style="font-size:10px;font-weight:bold">
       <td colspan="4">Total : </td>';

            $html .= '<td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }


            $html .= ' <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                        </tr>
                 </tbody>
             </table>
             </div>'; elseif ($fodec == 0.000 && $bcedef->getDroittimbre() && $remise != 0.000) :

            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
       <thead>
            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                <td style="text-align:center;width: 5%">N°</td>
                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                <td style="text-align:center;width: 8%">Qte </td>
                <td style="text-align:center;width: 12%">P.H.T</td>';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>'
                        . '<td style="text-align:center;width: 12%;">T.H.T.Net</td>';

            $html .= '  <td style="text-align:center;width: 11%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                                        </tr>  
                                        </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMnhtaxnet();
                $prixttc = ($lignedoc->getMnhtaxnet()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>'
                        . '<td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMnhtaxnet()), 3, ',', ' ') . '</td> ';

                $html .= ' <td style="text-align:center;width: 11%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;

                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                        <td colspan="4">Total : </td>';
            if ($remise != 0.000) {
                $html .= '<td></td>';
            }
            $html .= '<td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec != 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :
            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
                                                                <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
                                                                               <thead>
                                                                                <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                                                                                    <td style="text-align:center;width: 5%">N°</td>
                                                                                    <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                                                                                    <td style="text-align:center;width: 10%">Qte </td>
                                                                                    <td style="text-align:center;width: 13%">P.H.T</td>
                                                                                     <td style="text-align:center;width: 13%;">T.H.T</td> ';
            $html .= '  <td style="text-align:center;width: 13%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 13%;">M.TTC</td>
                                                                                     </tr>  
                                                                                     </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                                                                                                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                                                                                                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                                                                                                    <td style="text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                                                                                                    <td style="text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>
                                                                                                    <td style="text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ',', ' ') . '</td> ';
                $html .= ' <td style="text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 13%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;
                $somme_pru = 0;
                $somme_htax = 0;
                $somme_fdec = 0;
                $somme_ttc = 0;
                $somme_htva = 0;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                                                                                                            <td colspan="4">Total : </td>
                                                                                                            <td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>'; elseif ($fodec == 0.000 && !$bcedef->getDroittimbre() && $remise != 0.000) :

            $html .= '<div style="text-align:center;margin-left:auto; ">
                                                                
    <table class="tableligne" align = "center" style="width:100% " border="1" cellpadding="3" padding:2%; margin-bottom:0px;margin-left: 2px; >
       <thead>
            <tr style="font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                <td style="text-align:center;width: 5%">N°</td>
                <td style="text-align:center;width: 25%">DESIGNATION<br></td>
                <td style="text-align:center;width: 8%">Qte </td>
                <td style="text-align:center;width: 12%">P.H.T</td>';
            if ($remise != 0.000)
                $html .= '  <td style="text-align:center;width: 7%">Remise</td>'
                        . '<td style="text-align:center;width: 12%;">T.H.T.Net</td>';

            $html .= '  <td style="text-align:center;width: 11%;">T.V.A</td>';
            $html .= '  <td style="text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style="text-align:center;width: 12%;">M.TTC</td>
                                        </tr>  
                                        </thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMnhtaxnet();
                $prixttc = ($lignedoc->getMnhtaxnet()) + $lignedoc->getMnttva();
                $html .= ' <tr style="font-size:10px;">
                    <td style="text-align:center;width: 5%">' . $nordre . '</td>
                    <td style="text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
                    <td style="text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ',', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
                    <td style="text-align:center;width: 12%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ',', ' ') . '</td>';

                $html .= ' <td style="text-align:center;width: 7%;">' . number_format(($lignedoc->getMntremise()), 2, ',', ' ') . ' % </td>'
                        . '<td style="text-align:center;width: 12%;">' . number_format(($lignedoc->getMnhtaxnet()), 3, ',', ' ') . '</td> ';

                $html .= ' <td style="text-align:center;width: 11%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style="text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= '  <td style="text-align:center;width: 12%;">' . number_format(($mnttc), 3, ',', ' ') . '</td>
                                                                                                    </tr>';
                $nordre++;

                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style="font-size:10px;font-weight:bold">
                        <td colspan="4">Total : </td>';
            if ($remise != 0.000) {
                $html .= '<td></td>';
            }
            $html .= '<td>' . number_format($somme_htax, 3, ',', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= '     <td>' . number_format($somme_fdec, 3, ',', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ',', ' ') . '</td>';
            $html .= '  <td></td>';
            if ($bcedef->getDroittimbre()) {
                $html .= '<td style="text-align:center;">' . number_format($bcedef->getDroittimbre(), 3, ',', ' ') . '</td>';
            }


            $html .= '  <td>' . number_format($somme_ttc, 3, ',', ' ') . '</td>
                    </tr>
             </tbody>
         </table>
         </div>';

        endif;
        $html .= $this->ReadBDCFooter($iddoc);
        return $html;
    }

    public function ReadHtmlBondeponseRegroupeDefinitif($id) {
        $html = '';
        $bci_numero = "";
        $documents_parent = DocumentparentTable::getInstance()->findByIdDocumentachat($this->getId());
        $doc_achat = DocumentachatTable::getInstance()->find($id);
        $id_docpaent = $doc_achat->getIdDocparent();
        $document_bdcprovi = DocumentachatTable::getInstance()->findByIdDocparentAndIdTypedoc($id_docpaent, 21);

        if ($bci_numero == "")
            $bci_numero .= $doc_achat->getNumerodocachat();
        else
            $bci_numero .= "<br>" . $doc_achat->getNumerodocachat();
        $html .= '<div class = "contenue">
<div>
<table style = "float: left">
<tr>
<td style = "width: 100%">
<table>
<tr>
<td>' . $this->getTypedoc() . ' N° </td>

<td><p>' . $this->getNumerodocachat() . '</p></td>
</tr>

<tr>
<td>Bon de commande Interne N°</td>

<td><p>' . $bci_numero . '</p></td>
</tr>

<tr>
<td>Date de création</td>

<td ><p>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</p></td>
</tr>

<tr>
<td>Lieu de livraison</td>

<td><p>' . $this->getLieulivraisson() . '</p></td>
</tr>

</table>
</td>
<td style = "width: 50%">

</td>
</tr>
</table>
</div>
<div>';
        $p = new Piecejointbudget();
        $piece = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocachat($this->getId());
        if ($piece) {
            $html .= '<div style = "width: 60%;float:right"><table style = "border: 2px dashed #000000;padding:2%;">
<tr><td colspan = "5"><p style = "border-bottom: 2px dashed #000000;">IMPUTATION BUDGETAIRE</p></td></tr>
<tr>';
            $chapitre = "";
            $rubrique = "";
            $mnt = "";
            if ($piece) {
                $p = $piece;
                $chapitre = $p->getDocumentbudget()->getLigprotitrub()->getTitrebudjet()->getTypebudget();
                $rubrique = $p->getDocumentbudget()->getLigprotitrub()->getTitreEtRubrique();
            }
            $html .= '<td style = "width: 90px">Chapitre</td>
<td>Titre</td>
<td>ART</td>
<td>PAR</td>
<td>S/P</td>
</tr>
<tr>
<td colspan = "5" >' . $rubrique . '</td>
</tr>
</table></div>';
        }
        $somme_pru = 0;
        $somme_htva = 0;
        $somme_htax = 0;
        $somme_fdec = 0;
        $somme_ttc = 0;

        $lignedoc = new Lignedocachat();
        $liste_demande_de_prix = Doctrine_Core::getTable('lignedocachat')
                        ->createQuery('a')
                        ->where('id_doc = ' . $doc_achat->getId())->orderBy('id asc')->execute();
        $nordre = 1;
        $fodec = 0.000;
        foreach ($liste_demande_de_prix as $lignedoc) {
            $fodec = $fodec + $lignedoc->getMntfodec();
        }
        $html .= ' <div></div>';
        if ($fodec == 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style = "text-align:center;margin-left:auto; ">

<table class = "tableligne" align = "center" style = "width:100% " border = "1" cellpadding = "3" padding:2%;
margin-bottom:0px;
margin-left: 2px;
>
<thead>
<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
<td style = "text-align:center;width: 5%">N°</td>
<td style = "text-align:center;width: 25%">DESIGNATION<br></td>
<td style = "text-align:center;width: 10%">Qte </td>
<td style = "text-align:center;width: 15%">P.H.T</td>
<td style = "text-align:center;width: 15%;">T.H.T</td> ';
            $html .= ' <td style = "text-align:center;width: 15%;">T.V.A</td>';
            $html .= ' <td style = "text-align:center;width: 15%;">M.TTC</td>
</tr>
</thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style = "font-size:10px;">
<td style = "text-align:center;width: 5%">' . $nordre . '</td>
<td style = "text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
<td style = "text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ', ', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
<td style = "text-align:center;width: 15%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ', ', ' ') . '</td>
<td style = "text-align:center;width: 15%;">' . number_format(($lignedoc->getMntht()), 3, ', ', ' ') . '</td> ';
                $html .= ' <td style = "text-align:center;width: 15%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= ' <td style = "text-align:center;width: 15%;">' . number_format(($mnttc), 3, ', ', ' ') . '</td>
</tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style = "font-size:10px;font-weight:bold">
<td colspan = "4">Total : </td>
<td>' . number_format($somme_htax, 3, ', ', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= ' <td>' . number_format($somme_fdec, 3, ', ', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ', ', ' ') . '</td>';
            $html .= ' <td></td>';
            if ($doc_achat->getDroittimbre() == 1) {
                $html .= '<td style = "text-align:center;">' . number_format((0.600), 3, ', ', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '
<td>' . number_format($somme_ttc, 3, ', ', ' ') . '</td>
</tr>
</tbody>
</table>
</div>'; elseif ($fodec == 0.000 && $doc_achat->getDroittimbre() == 1) :
            $html .= '<div style = "text-align:center;margin-left:auto; ">

<table class = "tableligne" align = "center" style = "width:100% " border = "1" cellpadding = "3" padding:2%;
margin-bottom:0px;
margin-left: 2px;
>
<thead>
<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
<td style = "text-align:center;width: 5%">N°</td>
<td style = "text-align:center;width: 25%">DESIGNATION<br></td>
<td style = "text-align:center;width: 10%">Qte </td>
<td style = "text-align:center;width: 13%">P.H.T</td>
<td style = "text-align:center;width: 13%;">T.H.T</td> ';
            $html .= ' <td style = "text-align:center;width: 13%;">T.V.A</td>';
            $html .= ' <td style = "text-align:center;width: 8%">Timbre</td>';
            $html .= ' <td style = "text-align:center;width: 13%;">M.TTC</td>
</tr>
</thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style = "font-size:10px;">
<td style = "text-align:center;width: 5%">' . $nordre . '</td>
<td style = "text-align:left;width: 25%">' . $lignedoc->getDesignationarticle() . '</td>
<td style = "text-align:center;width: 10%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ', ', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
<td style = "text-align:center;width: 13%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ', ', ' ') . '</td>
<td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ', ', ' ') . '</td> ';
                $html .= ' <td style = "text-align:center;width: 13%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style = "text-align:center;width: 8%"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= ' <td style = "text-align:center;width: 13%;">' . number_format(($mnttc), 3, ', ', ' ') . '</td>
</tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style = "font-size:10px;font-weight:bold">
<td colspan = "4">Total : </td>
<td>' . number_format($somme_htax, 3, ', ', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= ' <td>' . number_format($somme_fdec, 3, ', ', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ', ', ' ') . '</td>';
            $html .= ' <td></td>';
            if ($doc_achat->getDroittimbre() == 1) {
                $html .= '<td style = "text-align:center;">' . number_format((0.600), 3, ', ', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '
<td>' . number_format($somme_ttc, 3, ', ', ' ') . '</td>
</tr>
</tbody>
</table>
</div>'; elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style = "text-align:center;margin-left:auto; ">

<table class = "tableligne" align = "center" style = "width:100% " border = "1" cellpadding = "3" padding:2%;
margin-bottom:0px;
margin-left: 2px;
>
<thead>
<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
<td style = "text-align:center;width: 5%">N°</td>
<td style = "text-align:center;width: 20%">DESIGNATION<br></td>
<td style = "text-align:center;width: 8%">Qte </td>
<td style = "text-align:center;width: 10%">P.H.T</td>
<td style = "text-align:center;width: 13%;">T.H.T</td> ';

            $html .= ' <td style = "text-align:center;width: 8%">Fodec</td>'
                    . ' <td style = "text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= ' <td style = "text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style = "text-align:center;width: 13%;">M.TTC</td>
</tr>
</thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style = "font-size:10px;">
<td style = "text-align:center;width: 5%">' . $nordre . '</td>
<td style = "text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
<td style = "text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ', ', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
<td style = "text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ', ', ' ') . '</td>
<td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ', ', ' ') . '</td> ';
                $html .= ' <td style = "text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ', ', ' ') . '</td>'
                        . ' <td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ', ', ' ') . '</td>';

                $html .= ' <td style = "text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= ' <td style = "text-align:center;width: 13%;">' . number_format(($mnttc), 3, ', ', ' ') . '</td>
</tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style = "font-size:10px;font-weight:bold">
<td colspan = "4">Total : </td>
<td>' . number_format($somme_htax, 3, ', ', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= ' <td>' . number_format($somme_fdec, 3, ', ', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ', ', ' ') . '</td>';
            $html .= ' <td></td>';
            if ($doc_achat->getDroittimbre() == 1) {
                $html .= '<td style = "text-align:center;">' . number_format((0.600), 3, ', ', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '
<td>' . number_format($somme_ttc, 3, ', ', ' ') . '</td>
</tr>
</tbody>
</table>
</div>'; elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() != 1) :
            $html .= '<div style = "text-align:center;margin-left:auto; ">

<table class = "tableligne" align = "center" style = "width:100% " border = "1" cellpadding = "3" padding:2%;
margin-bottom:0px;
margin-left: 2px;
>
<thead>
<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
<td style = "text-align:center;width: 5%">N°</td>
<td style = "text-align:center;width: 20%">DESIGNATION<br></td>
<td style = "text-align:center;width: 8%">Qte </td>
<td style = "text-align:center;width: 10%">P.H.T</td>
<td style = "text-align:center;width: 13%;">T.H.T</td> ';

            $html .= ' <td style = "text-align:center;width: 8%">Fodec</td>'
                    . ' <td style = "text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= ' <td style = "text-align:center;width: 10%;">T.V.A</td>';
            $html .= ' <td style = "text-align:center;width: 13%;">M.TTC</td>
</tr>
</thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style = "font-size:10px;">
<td style = "text-align:center;width: 5%">' . $nordre . '</td>
<td style = "text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
<td style = "text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ', ', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
<td style = "text-align:center;width: 10%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ', ', ' ') . '</td>
<td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntht()), 3, ', ', ' ') . '</td> ';
                $html .= ' <td style = "text-align:center;width: 8%;">' . number_format(($lignedoc->getMntfodec()), 3, ', ', ' ') . '</td>'
                        . ' <td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ', ', ' ') . '</td>';

                $html .= ' <td style = "text-align:center;width: 10%;">' . $lignedoc->getTva() . '</td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= ' <td style = "text-align:center;width: 13%;">' . number_format(($mnttc), 3, ', ', ' ') . '</td>
</tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style = "font-size:10px;font-weight:bold">
<td colspan = "4">Total : </td>
<td>' . number_format($somme_htax, 3, ', ', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= ' <td>' . number_format($somme_fdec, 3, ', ', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ', ', ' ') . '</td>';
            $html .= ' <td></td>';
            if ($doc_achat->getDroittimbre() == 1) {
                $html .= '<td style = "text-align:center;">' . number_format((0.600), 3, ', ', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '
<td>' . number_format($somme_ttc, 3, ', ', ' ') . '</td>
</tr>
</tbody>
</table>
</div>'; elseif ($fodec != 0.000 && $doc_achat->getDroittimbre() == 1) :
            $html .= '<div style = "text-align:center;margin-left:auto; ">

<table class = "tableligne" align = "center" style = "width:100% " border = "1" cellpadding = "3" padding:2%;
margin-bottom:0px;
margin-left: 2px;
>
<thead>
<tr style = "font-size:10px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
<td style = "text-align:center;width: 5%">N°</td>
<td style = "text-align:center;width: 20%">DESIGNATION<br></td>
<td style = "text-align:center;width: 8%">Qte </td>
<td style = "text-align:center;width: 8%">P.H.T</td>
<td style = "text-align:center;width: 11%;">T.H.T</td> ';

            $html .= ' <td style = "text-align:center;width: 7%">Fodec</td>'
                    . ' <td style = "text-align:center;width: 13%">Total<br>H.TVA</td>';
            $html .= ' <td style = "text-align:center;width: 7%;">T.V.A</td>';
            $html .= ' <td style = "text-align:center;width: 8%">Timbre</td>';

            $html .= ' <td style = "text-align:center;width: 13%;">M.TTC</td>
</tr>
</thead><tbody>';
            foreach ($liste_demande_de_prix as $lgnedoc) {
                $lignedoc = $lgnedoc;
                $qte = 0;
                $qteligne = Doctrine_Core::getTable('qtelignedoc')->findOneByIdLignedocachat($lgnedoc->getId());
                if ($qteligne)
                    $qte = $qteligne->getQtelivrefrs();
                $prixhtax = $lignedoc->getMntht();
                $prixttc = ($lignedoc->getMntht()) + $lignedoc->getMnttva();
                $html .= ' <tr style = "font-size:10px;">
<td style = "text-align:center;width: 5%">' . $nordre . '</td>
<td style = "text-align:left;width: 20%">' . $lignedoc->getDesignationarticle() . '</td>
<td style = "text-align:center;width: 8%">';

                if (intval($lignedoc->getQte()) == $lignedoc->getQte())
                    $html .= intval($lignedoc->getQte());
                else
                    $html .= number_format($lignedoc->getQte(), 2, ', ', ' ');
                $html .= $lignedoc->getUnitedemander() . '</td>
<td style = "text-align:center;width: 8%">' . number_format(($lignedoc->getMntht() / $lignedoc->getQte()), 3, ', ', ' ') . '</td>
<td style = "text-align:center;width: 11%;">' . number_format(($lignedoc->getMntht()), 3, ', ', ' ') . '</td> ';
                $html .= ' <td style = "text-align:center;width: 7%;">' . number_format(($lignedoc->getMntfodec()), 3, ', ', ' ') . '</td>'
                        . ' <td style = "text-align:center;width: 13%;">' . number_format(($lignedoc->getMntthtva()), 3, ', ', ' ') . '</td>';

                $html .= ' <td style = "text-align:center;width: 7%;">' . $lignedoc->getTva() . '</td>';
                $html .= '<td style = "text-align:center;width: 8%;"></td>';
                $mnttc = $lignedoc->getMntttc();
                $html .= ' <td style = "text-align:center;width: 13%;">' . number_format(($mnttc), 3, ', ', ' ') . '</td>
</tr>';
                $nordre++;
                $somme_pru = $somme_pru + ($lignedoc->getMntht() / $lignedoc->getQte());
                $somme_htax = $somme_htax + $prixhtax;
                $somme_fdec = $somme_fdec + $lignedoc->getMntfodec();
                $somme_ttc = $somme_ttc + $mnttc;
                $somme_htva = $somme_htva + $lignedoc->getMntthtva();
            }

            $html .= '<tr style = "font-size:10px;font-weight:bold">
<td colspan = "4">Total : </td>
<td>' . number_format($somme_htax, 3, ', ', ' ') . '</td>';
            if ($fodec != 0.000)
                $html .= ' <td>' . number_format($somme_fdec, 3, ', ', ' ') . '</td>'
                        . '<td>' . number_format($somme_htva, 3, ', ', ' ') . '</td>';
            $html .= ' <td></td>';
            if ($doc_achat->getDroittimbre() == 1) {
                $html .= '<td style = "text-align:center;">' . number_format((0.600), 3, ', ', ' ') . '</td>';
                $somme_ttc = $somme_ttc + 0.600;
            }


            $html .= '
<td>' . number_format($somme_ttc, 3, ', ', ' ') . '</td>
</tr>
</tbody>
</table>
</div>';
        endif;

        $resultat_quitance = 0;
        //        die(sizeof($document_bdcprovi).'rf'.$document_bdcprovi->getLast()->getId());
        $liste_quitance = LigneoperationcaisseTable::getInstance()->getByDocAchatAndCategorie($document_bdcprovi->getLast()->getId(), 2);

        $html .= '<h5>Liste des quitances Définitifs:</h5>
<table class = "tableligne">
<tr>
<th style = "text-align:center;width: 40%">N° Quitance</th>
<th style = "text-align:center;width: 60%">Montant</th>
</tr>
<tbody>';
        foreach ($liste_quitance as $quitance) {
            $html .= '<tr><td>' . $quitance->getNumeroo() . '</td>
<td>' . number_format($quitance->getMntoperation(), 3, ', ', ' ') . '</td>';
            $html .= '</tr>'
                    . '';

            $resultat_quitance += $quitance->getMntoperation();
        }
        $html .= '<tr style = "background: #EFEFEF"><td>Total : </td><td>' . number_format($resultat_quitance, 3, ', ', ' ') . '</td></tr>';
        $html .= '</tbody></table>';

        return $html;
    }

    //    public function getMagasinArrivee() {
    //        $mag = Doctrine_Core::getTable('magasin')->findOneById($this->getIdmagarrive());
    //        return $mag;
    //    }
}
