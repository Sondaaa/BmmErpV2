<?php

/**
 * Planing
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjectTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Planing extends BasePlaning {

    public function __toString() {

        return $this->getAnnee()
        ;
    }

    public function ReadHtmllistePlaning($idd) {
        $planing = Doctrine_Core::getTable('planing')->findOneById($idd);

        $html = '<h3>RECAPITULATIF DES SEMINAIRES PROPOSES PAR LES SERVICES<br>Année ' . $planing->getAnnee() . '</h3>
            &nbsp;<br>
            <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 10%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 30%;text-align:center;"><label>Thème de Formation</label></td>
                        <td style="width: 20%;text-align:center;"><label>Reg. Thème</label></td>
                        <td style="width: 10%;text-align:center;"><label>Nbr.</label></td>
                        <td style="width: 30%;text-align:center;"><label>Nom & Prénom</label></td>
                    </tr>';

        $document = Doctrine_Core::getTable('ligneplaning')
                ->createQuery('a')
                ->select('*, u.id, lb.id, p.id')
                ->from('Ligneplaning l')
                ->leftJoin('l.Planing p')
                ->leftJoin('l.Besoinsdeformation lb')
                ->leftJoin('lb.Unite u')
                ->Where('l.valide=true')
                ->andWhere('p.id= ?', $idd)
                ->groupBy('u.id, l.id, p.id, lb.id')
                ->execute();

        $i = 1;
        $ancien_unite_id = '';
        foreach ($document as $plan):
            if ($ancien_unite_id != $plan->getBesoinsdeformation()->getIdUnite()) {
                $i = 1;
                $ancien_unite_id = $plan->getBesoinsdeformation()->getIdUnite();
                $ligne = Doctrine_Core::getTable('ligneplaning')
                        ->createQuery('a')
                        ->select('*')
                        ->from('Ligneplaning l ')
                        ->leftJoin('l.Besoinsdeformation lb')
                        ->Where('l.valide=true')
                        ->andWhere('l.id_pluning= ?', $idd)
                        ->andWhere('lb.id_unite=?',$ancien_unite_id)
                        ->execute();
                $html.= '<tr>'
                        . '<td colspan="7" style="font-weight:bold;">'
                        . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getSousdirection()->getDirection()->getLibelle()
                        . '</td>'
                        . '</tr>'
                        . '<tr>'
                        . '<td colspan="7" style="font-weight:bold;">&nbsp;'
                        . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getSousdirection()->getLibelle()
                        . '</td>'
                        . '</tr>'
                        . '<tr>'
                        . '<td colspan="7" style="font-weight:bold;">&nbsp;&nbsp;&nbsp;&nbsp;'
                        . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getLibelle()
                        . '</td>'
                        . '</tr>'
                        . '<tr>'
                        . '<td colspan="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                        . $plan->getBesoinsdeformation()->getUnite()->getLibelle()
                        . '</td>'
                        . '<td style="text-align:center;">' . count($ligne) . '</td>'
                        . '<td></td>'
                        . '</tr>';
            }
            $html.='<tr>'
                    . '<td style="text-align:center;">' . $i . '</td><td>' . $plan->getTheme() . '</td>'
                    . '<td>' . $plan->getRegroupementtheme()->getLibelle() . '</td>'
                    . '<td style="text-align:center;">1</td><td>'
                    . $plan->getBesoinsdeformation()->getAgents()->getNomcomplet() . "  " . $plan->getBesoinsdeformation()->getAgents()->getPrenom()
                    . '</td>'
                    . '</tr>';
            $i++;

        endforeach;

        $html.='<tbody></table>';

        return $html;
    }

  
    public function ReadHtmllistePlaningPrevisionnlle($idd) {
        $planing = Doctrine_Core::getTable('planing')->findOneById($idd);

        $html = '<h3> RECAPITULATIF DES SEMINAIRES PROPOSES PAR LES SERVICES <br>Année ' . $planing->getAnnee() . ' (Valorisation)</h3>
                &nbsp;<br>
                <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width:10%;text-align:center;"><label>N°</label></td>
                        <td style="width 15%;text-align:center;"><label>Thème de Formation</label></td>
                        <td style="width:20%;text-align:center;"><label>Reg. Thème</label></td>
                        <td style="width:15%;text-align:center;"><label>Nbr.</label></td>
                        <td style="width:25%;text-align:center;"><label>Nom & Prénom</label></td>
                        <td style="width:15%;text-align:center;"><label>M.P.TTC</label></td>
                    </tr>';

        $document = Doctrine_Core::getTable('ligneplaning')
                ->createQuery('a')
                ->select('*, u.id, lb.id, p.id')
                ->from('Ligneplaning l')
                ->leftJoin('l.Planing p')
                ->leftJoin('l.Besoinsdeformation lb')
                ->leftJoin('lb.Unite u')
                ->Where('l.valide=true')
                ->andWhere('p.id= ?', $idd)
                ->groupBy('u.id, l.id, p.id, lb.id')
                ->execute();

        $i = 1;
        $ancien_unite_id = '';
        foreach ($document as $plan):
            $idreg = $plan->getIdRegroupement();
            $ligne = LigneplaningTable::getInstance()->findByIdRegroupementAndIdPluningAndValide($idreg, $idd, true);
            if (count($ligne) != 0) {
                if ($ancien_unite_id != $plan->getBesoinsdeformation()->getIdUnite()) {
                    $ancien_unite_id = $plan->getBesoinsdeformation()->getIdUnite();
                    $html.= '<tr>'
                            . '<td colspan="6">'
                            . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getSousdirection()->getDirection()->getLibelle()
                            . '</td>'
                            . '</tr>'
                            . '<tr>'
                            . '<td colspan="6">&nbsp;'
                            . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getSousdirection()->getLibelle()
                            . '</td>'
                            . '</tr>'
                            . '<tr>'
                            . '<td colspan="6">&nbsp;&nbsp;&nbsp;&nbsp;'
                            . $plan->getBesoinsdeformation()->getUnite()->getServicerh()->getLibelle()
                            . '</td>'
                            . '</tr>'
                            . '<tr>'
                            . '<td colspan="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                            . $plan->getBesoinsdeformation()->getUnite()->getLibelle()
                            . '</td>'
                            . '<td style="text-align:center;">' . count($ligne) . '</td>'
                            . '<td colspan="2"></td>'
                            . '</tr>';
                }
                $html.='<tr>'
                        . '<td style="text-align:center;">' . $i . '</td>'
                        . '<td>' . $plan->getTheme() . '</td>'
                        . '<td>' . $plan->getRegroupementtheme()->getLibelle() . '</td>'
                        . '<td style="text-align:center;">1</td>'
                        . '<td>' . $plan->getBesoinsdeformation()->getAgents()->getNomcomplet() . "  " . $plan->getBesoinsdeformation()->getAgents()->getPrenom()
                        . '</td>'
                        . '<td style="text-align:center;">' . $plan->getMontant() . '</td>'
                        . '</tr>';
                $i++;
            }
        endforeach;
        

        $html.='<tbody></table>';
        
        $html.='&nbsp;<br>'
                . '<table>'
                . '<tr>'
                . '<td style="width: 77%"></td>'
                . '<td style="width: 23%">'
                . '<table border="1" cellpadding="3">'
                . '<tr>'
                . '<td style="height:30px;text-align:center;width:100%;">'
                . '<h11>' . 'M.T. TTC : '
                . $plan->getMontanttotalht() . '</h11>'
                . '</td>'
                . '</tr>'
                . '</table>'
                . '</td>'
                . '</tr>'
                . '</table>';

        return $html;
    }

}
