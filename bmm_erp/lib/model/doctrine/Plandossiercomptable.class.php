<?php

/**
 * Plandossiercomptable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProject1
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Plandossiercomptable extends BasePlandossiercomptable {

    public function __toString() {
        return "" . trim($this->getNumerocompte()) . ' - ' . trim($this->getLibelle());
    }

    public function ReadHtmlSeulFicheCompte(sfWebRequest $request) {
        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');
        $id = $request->getParameter('id', '');

        $Plan_dossier_comptable = PlandossiercomptableTable::getInstance()->find($id);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);

        $etatFicheCompte = LignePieceComptableTable::getInstance()->loadEtatFicheSeulCompte($id, $date_debut, $date_fin);

        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '--/--/----';

        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '--/--/----';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Fiche Compte Comptable : ' . trim($Plan_dossier_comptable->getNumerocompte()) . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Compte Comptable :</b> ' . trim($Plan_dossier_comptable->getNumerocompte()) . ' - ' . trim($Plan_dossier_comptable->getLibelle()) . '<br>
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="3" border="1">
                    <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
                        <td style="width:9%;">Date</td>
                        <td style="width:23%;">Journal Comptable</td>
                        <td style="width:10%;">N° Pièce Comptable</td>
                        <td style="width:25%;">Libellé</td>
                        <td style="width:11%;">Débit</td>
                        <td style="width:11%;">Crédit</td>
                        <td style="width:11%;">Solde</td>
                    </tr>';

        $totalcredit = 0;
        $totaldebit = 0;

        foreach ($etatFicheCompte as $fiche):
            $html.= '<tr>
                        <td style="text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                        <td style="text-align:left;">' . $fiche->getPiececomptable()->getJournalcomptable()->getLibelle() . '</td>
                        <td style="text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                        <td style="text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                        <td style="text-align:right;">';

            if ($fiche->getMontantdebit() != 0)
                $html.= number_format($fiche->getMontantdebit(), 3, '.', ' ');

            $html.= '</td>
                        <td style="text-align:right;">';

            if ($fiche->getMontantcredit() != 0)
                $html.= number_format($fiche->getMontantcredit(), 3, '.', ' ');

            $html.= '</td>
                        <td style="text-align:right;">' . number_format($fiche->getMontantdebit() - $fiche->getMontantcredit(), 3, '.', ' ') . '</td>
                    </tr>';

            $totalcredit += $fiche->getMontantcredit();
            $totaldebit += $fiche->getMontantdebit();
        endforeach;

        $solde = $totaldebit - $totalcredit;
        $html.= '<tr>
                    <td colspan="3"></td>
                    <td style="font-weight:bold;text-align:center;background-color:#ECECEC;height:25px;">Total</td>
                    <td style="font-weight:bold;text-align:right;">';

        if ($totaldebit != 0)
            $html.= number_format($totaldebit, 3, '.', ' ');

        $html.= '</td>
                    <td style="font-weight:bold;text-align:right;">';

        if ($totalcredit != 0)
            $html.= number_format($totalcredit, 3, '.', ' ');

        $html.= '</td>
                    <td style="font-weight:bold;text-align:right;">';

        if ($solde != 0)
            $html.= number_format($solde, 3, '.', ' ');

        $html.= '</td>
                </tr>
            </table>';

        return $html;
    }

    public function ReadHtmlFicheCompte(sfWebRequest $request) {

        $compte_min = $request->getParameter('compte_min', '');
        $compte_max = $request->getParameter('compte_max', '');

        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');

        $crediteur = $request->getParameter('crediteur', '');
        $debiteur = $request->getParameter('debiteur', '');
        $solde = $request->getParameter('solde', '');

        $dossier_id = $_SESSION['dossier_id'];
        $exercice = $_SESSION['exercice'];
        $exercice_id = $_SESSION['exercice_id'];
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $compte_comptable_min = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdExerciceAndIdDossier($compte_min, $exercice_id, $_SESSION['dossier_id'])->getFirst();
        $compte_comptable_max = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdExerciceAndIdDossier($compte_max, $exercice_id, $_SESSION['dossier_id'])->getFirst();
        $comptes_interval = PlanDossierComptableTable::getInstance()->loadByInterval($compte_min, $compte_max, $dossier_id, $exercice_id);

        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut_affiche = '01/01/' . $exercice;

        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin_affiche = '31/12/' . $exercice;

        ini_set('memory_limit', '640M');

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Fiche Comptes Comptables</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Du Compte Comptable :</b> ' . trim($compte_comptable_min->getNumeroCompte()) . ' - ' . trim($compte_comptable_min->getLibelle()) . '<br>
                            <b>Au Compte Comptable :</b> ' . trim($compte_comptable_max->getNumeroCompte()) . ' - ' . trim($compte_comptable_max->getLibelle()) . '<br>
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_affiche . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        foreach ($comptes_interval as $c_i) {
            $etatFicheCompte = LignepiececomptableTable::getInstance()->loadEtatFicheSeulCompte($c_i->getId(), $date_debut, $date_fin, $crediteur, $debiteur, $solde);
            if ($etatFicheCompte->count() != 0) {
                $totalcredit = 0;
                $totaldebit = 0;
                $solde_total = 0;
                $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                Fiche Compte Comptable : ' . trim($c_i->getNumeroCompte()) . ' - ' . trim($c_i->getLibelle()) .
                        '</div>&nbsp;<br>
                            <table border="1" cellpadding="3" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th style="width:10%;height:25px;">Date</th>
                                        <th style="width:24%;">Journal</th>
                                        <th style="width:10%;">N° Pièce</th>
                                        <th style="width:15%;">Libellé</th>
                                        <th style="width:11%;">Contre Partie</th>      
                                        <th style="width:10%;">Débit</th>
                                        <th style="width:10%;">Crédit</th>
                                        <th style="width:10%;">Solde</th>
                                    </tr>
                                </thead>
                                <tbody>';

                foreach ($etatFicheCompte as $fiche):
                    $html.='<tr>
                                <td style="width:10%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                                <td style="width:24%;text-align:left;">' . $fiche->getPiececomptable()->getJournalcomptable()->getLibelle() . '</td>
                                <td style="width:10%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                                <td style="width:15%;text-align:center;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                                <td style="width:11%;text-align:center;">' . $fiche->getPlandossiercomptablecontre()->getNumerocompte() . '</td>
                                <td style="width:10%;text-align:right;">';
                    if ($fiche->getMontantdebit() != 0)
                        $html.= $fiche->getMontantdebit();

                    $html.='</td>
                            <td style="width:10%;text-align:right;">';

                    if ($fiche->getMontantcredit() != 0)
                        $html.= $fiche->getMontantcredit();

                    $html.='</td>
                            <td style="width:10%;text-align:right;">' . number_format($fiche->getMontantdebit() - $fiche->getMontantcredit(), 3, '.', ' ') . '</td>
                        </tr>';
                    $totalcredit += $fiche->getMontantcredit();
                    $totaldebit += $fiche->getMontantdebit();

                endforeach;
                $solde_total = $totaldebit - $totalcredit;
                $html.='</tbody>
                            <tr>
                                <td colspan="4"></td>
                                <td style="font-weight:bold;text-align:center;height:25px;background-color:#ECECEC;">Total</td>
                                <td style="font-weight:bold;text-align:right;">';

                if ($totaldebit != 0)
                    $html.= number_format($totaldebit, 3, '.', ' ');

                $html.='</td>
                        <td style="font-weight:bold;text-align:right;">';

                if ($totalcredit != 0)
                    $html.= number_format($totalcredit, 3, '.', ' ');

                $html.='</td>
                        <td style="font-weight:bold;text-align:right;">';

                if ($solde_total != 0)
                    $html.= number_format($solde_total, 3, '.', ' ');

                $html.='</td>
                    </tr>
                </table>&nbsp;<br>';
            }else {
                $html.='<div style="border-color:#E8B10D;background:#FFDD9C;font-weight:bold;">
                                Fiche Compte Comptable : ' . trim($c_i->getNumeroCompte()) . ' - ' . trim($c_i->getLibelle()) .
                        '</div>&nbsp;<br>
                        <table border="1" cellpadding="3" cellspacing="0">
                            <thead>
                                <tr>
                                    <th style="width:10%;height:25px;">Date</th>
                                    <th style="width:24%;">Journal</th>
                                    <th style="width:10%;">N° Pièce</th>
                                    <th style="width:15%;">Libellé</th>
                                    <th style="width:11%;">Contre Partie</th>      
                                    <th style="width:10%;">Débit</th>
                                    <th style="width:10%;">Crédit</th>
                                    <th style="width:10%;">Solde</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align:center;height:25px;font-size:16px;" colspan="8">Pas de pièces comptables</td>
                                </tr>
                            </tbody>
                        </table>&nbsp;<br>';
            }
        }

        return $html;
    }

    public function ReadHtmlFicheCompteNonVide(sfWebRequest $request) {

        $compte_min = $request->getParameter('compte_min', '');
        $compte_max = $request->getParameter('compte_max', '');

        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');

        $crediteur = $request->getParameter('crediteur', '');
        $debiteur = $request->getParameter('debiteur', '');
        $solde = $request->getParameter('solde', '');

        $dossier_id = $_SESSION['dossier_id'];
        $exercice = $_SESSION['exercice'];
        $exercice_id = $_SESSION['exercice_id'];
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $compte_comptable_min = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdExerciceAndIdDossier($compte_min, $exercice_id, $dossier_id)->getFirst();
        $compte_comptable_max = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdExerciceAndIdDossier($compte_max, $exercice_id, $dossier_id)->getFirst();
        $comptes_interval = PlanDossierComptableTable::getInstance()->loadByIntervalForFicheCompte($compte_min, $compte_max, $dossier_id, $exercice_id, $date_debut, $date_fin, $crediteur, $debiteur, $solde);

        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut_affiche = '01/01/' . $exercice;

        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin_affiche = '31/12/' . $exercice;

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Fiche Comptes Comptables</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Du Compte Comptable :</b> ' . trim($compte_comptable_min->getNumeroCompte()) . ' - ' . trim($compte_comptable_min->getLibelle()) . '<br>
                            <b>Au Compte Comptable :</b> ' . trim($compte_comptable_max->getNumeroCompte()) . ' - ' . trim($compte_comptable_max->getLibelle()) . '<br>
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_affiche . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        foreach ($comptes_interval as $c_i) {
            $etatFicheCompte = LignepiececomptableTable::getInstance()->loadEtatFicheSeulCompte($c_i->getId(), $date_debut, $date_fin, $crediteur, $debiteur, $solde);
            if ($etatFicheCompte->count() != 0) {
                $totalcredit = 0;
                $totaldebit = 0;
                $solde_total = 0;
                $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                Fiche Compte Comptable : ' . trim($c_i->getNumeroCompte()) . ' - ' . trim($c_i->getLibelle()) .
                        '</div>&nbsp;<br>
                            <table border="1" cellpadding="3" cellspacing="0">
                                <thead>
                                    <tr style="background-color:#ECECEC;">
                                        <th style="width:10%;height:25px;"><b>Date</b></th>
                                        <th style="width:24%;text-align:left;"><b>Journal Comptable</b></th>
                                        <th style="width:10%;"><b>N° Pièce</b></th>
                                        <th style="width:15%;"><b>Libellé</b></th>
                                        <th style="width:11%;"><b>Contre Partie</b></th>      
                                        <th style="width:10%;"><b>Débit</b></th>
                                        <th style="width:10%;"><b>Crédit</b></th>
                                        <th style="width:10%;"><b>Solde</b></th>
                                    </tr>
                                </thead>
                                <tbody>';

                foreach ($etatFicheCompte as $fiche):
                    $html.='<tr>
                                <td style="width:10%;text-align:center;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                                <td style="width:24%;text-align:left;">' . $fiche->getPiececomptable()->getJournalcomptable()->getLibelle() . '</td>
                                <td style="width:10%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                                <td style="width:15%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                                <td style="width:11%;text-align:center;">' . $fiche->getPlandossiercomptablecontre()->getNumerocompte() . '</td>
                                <td style="width:10%;text-align:right;">';
                    if ($fiche->getMontantdebit() != 0)
                        $html.= $fiche->getMontantdebit();

                    $html.='</td>
                            <td style="width:10%;text-align:right;">';

                    if ($fiche->getMontantcredit() != 0)
                        $html.= $fiche->getMontantcredit();

                    $html.='</td>
                            <td style="width:10%;text-align:right;">' . number_format($fiche->getMontantdebit() - $fiche->getMontantcredit(), 3, '.', ' ') . '</td>
                        </tr>';
                    $totalcredit += $fiche->getMontantcredit();
                    $totaldebit += $fiche->getMontantdebit();

                endforeach;
                $solde_total = $totaldebit - $totalcredit;
                $html.='</tbody>
                            <tr>
                                <td colspan="4"></td>
                                <td style="font-weight:bold;text-align:center;background-color:#ECECEC;height:25px;">Total</td>
                                <td style="font-weight:bold;text-align:right;">';

                if ($totaldebit != 0)
                    $html.= number_format($totaldebit, 3, '.', ' ');

                $html.='</td>
                        <td style="font-weight:bold;text-align:right;">';

                if ($totalcredit != 0)
                    $html.= number_format($totalcredit, 3, '.', ' ');

                $html.='</td>
                        <td style="font-weight:bold;text-align:right;">';

                if ($solde_total != 0)
                    $html.= number_format($solde_total, 3, '.', ' ');

                $html.='</td>
                    </tr>
                </table>&nbsp;<br>';
            }
        }

        return $html;
    }

    public function ReadHtmlExtraitCompte(sfWebRequest $request) {
        $compte = $request->getParameter('compte', '');

        $date_debut = $request->getParameter('date_debut');
        if ($date_debut == '' || $date_debut == NULL)
            $date_debut = date('Y') . '-01-01';

        $date_fin = $request->getParameter('date_fin');
        if ($date_fin == '' || $date_fin == NULL)
            $date_fin = date('Y') . '-12-31';

        $journal = $request->getParameter('journal', '');
        $order = $request->getParameter('order', '');
        $lettre = $request->getParameter('lettre', '');
        $non_lettre = $request->getParameter('non_lettre', '');
        $debit = $request->getParameter('debit', '');
        $credit = $request->getParameter('credit', '');
        $Plan_dossier_comptable = PlandossiercomptableTable::getInstance()->find($compte);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $etatExtraitCompte = LignePieceComptableTable::getInstance()->loadEtatExtraitCompte($compte, $date_debut, $date_fin, $journal, $order, $lettre, $non_lettre, $debit, $credit);

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Fiche Compte Comptable : ' . trim($Plan_dossier_comptable->getNumerocompte()) . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Compte Comptable :</b> ' . trim($Plan_dossier_comptable->getNumerocompte()) . ' - ' . trim($Plan_dossier_comptable->getLibelle()) . '<br>
                            <b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($date_debut)) . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($date_fin)) . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="3" border="1">
                    <thead>
                        <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
                            <td style="width:9%;">Date</td>
                            <td style="width:23%;">Journal Comptable</td>
                            <td style="width:10%;">N° Pièce Comptable</td>
                            <td style="width:25%;">Libellé</td>
                            <td style="width:11%;">Débit</td>
                            <td style="width:11%;">Crédit</td>
                            <td style="width:11%;">Solde</td>
                        </tr>
                    </thead>';
        $resultat_debit = 0;
        $resultat_credit = 0;
        $resultat_solde = 0;
        if ($etatExtraitCompte->count() == 0):
            $html.= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="8">Extrait de Compte Vide</td>
                        </tr>';
        else:
            foreach ($etatExtraitCompte as $fiche):
                if (($fiche->getMontantdebit() != 0) || ($fiche->getMontantcredit() != 0)):
                    $html.= '<tr>
                            <td style="width:9%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getDate())) . '</td>
                            <td style="width:23%;text-align:left;">' . $fiche->getPiececomptable()->getJournalcomptable()->getCode() . '</td>
                            <td style="width:10%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                            <td style="width:25%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                            <td style="width:11%;text-align:right;">';
                    if ($fiche->getMontantdebit() != 0) {
                        $html.= $fiche->getMontantdebit();
                        $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                    }
                    $html.= '</td>
                        <td style="width:11%;text-align:right;">';
                    if ($fiche->getMontantcredit() != 0) {
                        $html.= $fiche->getMontantcredit();
                        $resultat_credit = $resultat_credit + $fiche->getMontantcredit();
                    }
                    $html.= '</td>
                        <td style="width:11%;text-align:right;">';
                    $html.= number_format($fiche->getMontantdebit() - $fiche->getMontantcredit(), 3, '.', ' ');
                    $resultat_solde = $resultat_solde + $fiche->getMontantdebit() - $fiche->getMontantcredit();
                    $html.= '</td>
                    </tr>';

                endif;
            endforeach;
            $html.= '<tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;border: solid 1px #000000">'
                    . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                    . '<td colspan="2"> </td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_solde, 3, '.', ' ') . '</b></td>'
                    . '</tr>';
        endif;

        $html.= '</table>';

        return $html;
    }

    public function ReadHtmlEtatBalance(sfWebRequest $request) {
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $compte_min = $request->getParameter('compte_min', '');
        $compte_max = $request->getParameter('compte_max', '');
        $date_debut = $request->getParameter('date_debut');
        $date_fin = $request->getParameter('date_fin');

        $chiffre_1 = $request->getParameter('chiffre_1', 'false');
        $chiffre_2 = $request->getParameter('chiffre_2', 'false');
        $chiffre_3 = $request->getParameter('chiffre_3', 'false');
        $chiffre_4 = $request->getParameter('chiffre_4', 'false');
        $chiffre_5 = $request->getParameter('chiffre_5', 'false');
        $chiffre_6 = $request->getParameter('chiffre_6', 'false');
        $chiffre_7 = $request->getParameter('chiffre_7', 'false');

        $comptes_non_solde = $request->getParameter('comptes_non_solde', '');

        $dossier_id = $_SESSION['dossier_id'];

        $compte_min_comptable = PlanComptableTable::getInstance()->findOneByNumeroCompte($compte_min);
        $compte_max_comptable = PlanComptableTable::getInstance()->findOneByNumeroCompte($compte_max);

        $balance = calculBalance::getBalance($compte_min, $compte_max, $date_debut, $date_fin, $comptes_non_solde, $chiffre_1, $chiffre_2, $chiffre_3, $chiffre_4, $chiffre_5, $chiffre_6, $chiffre_7, $dossier_id, $_SESSION['exercice_id']);

        if ($date_debut != '' && $date_debut != NULL)
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '';
        if ($date_fin != '' && $date_fin != NULL)
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '';

        $th_periode = '<br>' . $date_debut . ' Au ' . $date_fin;

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat des Balances générales (simples) : ' . $_SESSION['exercice'] . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                            <ul><b>Compte Comptable :</b>
                                <li>
                                    <b>Du :</b> ' . $compte_min_comptable->getNumerocompte() . ' - ' . $compte_min_comptable->getLibelle() . '
                                </li>
                                <li>
                                    <b>Au :</b> ' . $compte_max_comptable->getNumerocompte() . ' - ' . $compte_max_comptable->getLibelle() . '
                                </li>
                            </ul>
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                        <tr align="center" style="font-weight:bold;background-color:#F2F2F2;">
                            <td rowspan="2" style="width:10%;height:25px;">Compte Comptable</td>
                            <td rowspan="2" style="width:42%;">Libellé</td>
                            <td style="width:16%;">Mouvement Ouverture</td>
                            <td style="width:16%;">Mouvement Période ' . $th_periode . '</td>
                            <td style="width:16%;">Soldes</td>
                        </tr>
                        <tr style="font-weight:bold;background-color:#F2F2F2;">
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr align="center" style="font-weight:bold;background-color:#F2F2F2;">
                            <td></td>
                            <td style="height:35px;">Report</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>';

        $solde_credit_classe_1_5 = 0;
        $solde_debit_classe_1_5 = 0;
        $solde_credit_classe_6 = 0;
        $solde_debit_classe_6 = 0;
        $solde_credit_classe_7 = 0;
        $solde_debit_classe_7 = 0;
        for ($i = 0; $i < (sizeof($balance) - 1); $i++) {

            if ($balance[$i]['debitOuv'] == 0)
                $montantDebit = '';
            else
                $montantDebit = number_format($balance[$i]['debitOuv'], 3, '.', ' ');

            if ($balance[$i]['creditOuv'] == 0)
                $montantCredit = '';
            else
                $montantCredit = number_format($balance[$i]['creditOuv'], 3, '.', ' ');

            if ($balance[$i]['debitMois'] == 0)
                $montantMoisDebit = '';
            else
                $montantMoisDebit = number_format($balance[$i]['debitMois'], 3, '.', ' ');

            if ($balance[$i]['creditMois'] == 0)
                $montantMoisCredit = '';
            else
                $montantMoisCredit = number_format($balance[$i]['creditMois'], 3, '.', ' ');

            if ($balance[$i]['debiteur'] == 0)
                $debiteur = '';
            else
                $debiteur = number_format($balance[$i]['debiteur'], 3, '.', ' ');

            if ($balance[$i]['crediteur'] == 0)
                $crediteur = '';
            else
                $crediteur = number_format($balance[$i]['crediteur'], 3, '.', ' ');

            $html.='<tr style="' . $balance[$i]['ligne'] . '">
                        <td style="text-align:center;height:20px;' . $balance[$i]['ligne'] . '">' . $balance[$i]['compte'] . '</td>
                        <td style="text-align:left;font-size:9px;' . $balance[$i]['ligne'] . '">' . $balance[$i]['libelle'] . '</td>
                        <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                            <table cellspacing="0" cellpadding="3">
                                <tr>
                                    <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $montantDebit . '</td>
                                    <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $montantCredit . '</td>
                                </tr>
                            </table>
                        </td>
                        <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                            <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $montantMoisDebit . '</td>
                                  <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $montantMoisCredit . '</td>
                              </tr>
                          </table>
                       </td>
                       <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                          <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $debiteur . '</td>
                                  <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $crediteur . '</td>
                              </tr>
                          </table>
                       </td>
                    </tr>';
        }

        if ($balance[sizeof($balance) - 1]['6_debit'] == 0)
            $solde_debit_classe_6 = '';
        else
            $solde_debit_classe_6 = number_format($balance[sizeof($balance) - 1]['6_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['6_credit'] == 0)
            $solde_credit_classe_6 = '';
        else
            $solde_credit_classe_6 = number_format($balance[sizeof($balance) - 1]['6_credit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['7_debit'] == 0)
            $solde_debit_classe_7 = '';
        else
            $solde_debit_classe_7 = number_format($balance[sizeof($balance) - 1]['7_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['7_credit'] == 0)
            $solde_credit_classe_7 = '';
        else
            $solde_credit_classe_7 = number_format($balance[sizeof($balance) - 1]['7_credit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['1_5_debit'] == 0)
            $solde_debit_classe_1_5 = '';
        else
            $solde_debit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['1_5_credit'] == 0)
            $solde_credit_classe_1_5 = '';
        else
            $solde_credit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_credit'], 3, '.', ' ');

        $html.='<tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;">Total Classes Charges</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight:bold;">
                         <table cellspacing="0" cellpadding="3">
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_6 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_6 . '</td>
                            </tr>
                         </table>
                      </td>
                </tr>
                <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;border-right:1px solid #828282;">Total Classes Produits</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight: bold;">
                         <table cellspacing="0" cellpadding="3">
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_7 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_7 . '</td>
                            </tr>
                         </table>
                      </td>
                      </tr>
                <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:35px;">Résultat de Gestion</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight:bold;text-align:right;">
                                ' . number_format(($balance[sizeof($balance) - 1]['7_credit'] - $balance[sizeof($balance) - 1]['6_debit']), 3, '.', ' ') . '
                      </td>
                 </tr>
                 <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;">Résultat de Bilan</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight:bold;">
                        <table cellspacing="0" cellpadding="3">
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_1_5 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_1_5 . '</td>
                            </tr>
                        </table>
                      </td>
                 </tr>
              </table>';

        return $html;
    }

    public function ReadHtmlEtatBalanceTotaux(sfWebRequest $request) {
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $compte_min = $request->getParameter('compte_min', '');
        $compte_max = $request->getParameter('compte_max', '');
        $date_debut = $request->getParameter('date_debut');
        $date_fin = $request->getParameter('date_fin');
        $comptes_non_solde = $request->getParameter('comptes_non_solde', '');
        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $_SESSION['exercice_id'];
        $compte_min_comptable = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdDossierAndIdExercice($compte_min,$dossier_id,$exercice_id)->getFirst();
        $compte_max_comptable = PlandossiercomptableTable::getInstance()->findByNumerocompteAndIdDossierAndIdExercice($compte_max,$dossier_id,$exercice_id)->getFirst();
        $balance = calculBalanceTotaux::getBalance($compte_min, $compte_max, $date_debut, $date_fin, $comptes_non_solde, $dossier_id, $exercice_id);
        $dossiercomptable = DossiercomptableTable::getInstance()->find($dossier_id);
        if ($date_debut != '' && $date_debut != NULL)
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '';
        if ($date_fin != '' && $date_fin != NULL)
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '';

        $th_periode = '<br>' . $date_debut . ' Au ' . $date_fin;

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $dossiercomptable->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat des Balances Sous Totaux : ' . $_SESSION['exercice'] . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:11px;width:100%;">
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                            <ul><b>Compte Comptable :</b>
                                <li>
                                    <b>Du :</b> ' . $compte_min_comptable->getNumerocompte() . ' - ' . $compte_min_comptable->getLibelle() . '
                                </li>
                                <li>
                                    <b>Au :</b> ' . $compte_max_comptable->getNumerocompte() . ' - ' . $compte_max_comptable->getLibelle().  '
                                </li>
                            </ul>
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                        <tr align="center" style="font-weight:bold;font-size:11px;background-color:#F2F2F2;">
                            <td rowspan="2" style="width:12%;height:25px;">Compte<br> Comptable</td>
                            <td rowspan="2" style="width:13%;">Libellé</td>
                            <td style="width:25%;">Soldes Ouverture</td>
                            <td style="width:25%;">Mouvements Période ' . $th_periode . '</td>
                          
                            <td style="width:25%;">Soldes de clôture</td>
                        </tr>
                        <tr style="font-weight:bold;background-color:#F2F2F2;">
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                             <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                           
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débiteur</td>
                                        <td style="text-align:center;font-weight:bold;width:52%;">Créditeur</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr align="center" style="font-weight:bold;background-color:#F2F2F2;">
                            <td></td>
                            <td style="height:35px;">Report</td>
                            <td></td>
                            
                            <td></td>
                             <td></td>
                        </tr>';

        $solde_credit_classe_1_5 = 0;
        $solde_debit_classe_1_5 = 0;
        $solde_credit_classe_6 = 0;
        $solde_debit_classe_6 = 0;
        $solde_credit_classe_7 = 0;
        $solde_debit_classe_7 = 0;
        for ($i = 0; $i < (sizeof($balance) - 1); $i++) :
            if ($balance[$i]['debitMois'] != 0 || $balance[$i]['creditMois'] != 0 || $balance[$i]['creditOuv'] != 0 || $balance[$i]['debitOuv'] != 0):
                if ($balance[$i]['debitOuv'] == 0)
                    $montantDebit = '';
                else
                    $montantDebit = number_format($balance[$i]['debitOuv'], 3, '.', ' ');

                if ($balance[$i]['creditOuv'] == 0)
                    $montantCredit = '';
                else
                    $montantCredit = number_format($balance[$i]['creditOuv'], 3, '.', ' ');

                if ($balance[$i]['debitMois'] == 0)
                    $montantMoisDebit = '';
                else
                    $montantMoisDebit = number_format($balance[$i]['debitMois'], 3, '.', ' ');

                if ($balance[$i]['creditMois'] == 0)
                    $montantMoisCredit = '';
                else
                    $montantMoisCredit = number_format($balance[$i]['creditMois'], 3, '.', ' ');
//                if ($balance[$i]['debitCumulMois'] == 0)
//                    $montantCumulDebit = '';
//                else
//                    $montantCumulDebit = number_format($balance[$i]['debitCumulMois'], 3, '.', ' ');
//
//                if ($balance[$i]['crediCumultMois'] == 0)
//                    $montantCumulCredit = '';
//                else
//                    $montantCumulCredit = number_format($balance[$i]['crediCumultMois'], 3, '.', ' ');

                if ($balance[$i]['debiteur'] == 0)
                    $debiteur = '';
                else
                    $debiteur = number_format($balance[$i]['debiteur'], 3, '.', ' ');

                if ($balance[$i]['crediteur'] == 0)
                    $crediteur = '';
                else
                    $crediteur = number_format($balance[$i]['crediteur'], 3, '.', ' ');
//  if ($balance[$i]['debitMois'] != 0 || $balance[$i]['creditMois'] != 0 || $balance[$i]['creditOuv'] != 0 || $balance[$i]['debitOuv'] != 0):
                $html.='<tr style="' . $balance[$i]['ligne'] . '">';
                if (strlen($balance[$i]['compte']) > 2):
                    $html.='<td style="text-align:center;height:20px;' . $balance[$i]['ligne'] . '">' . $balance[$i]['compte'] . '</td>
                    <td style="text-align:left;font-size:9px;' . $balance[$i]['ligne'] . '">' . $balance[$i]['libelle'] . '</td>';
                else:
                    $html.='<td colspan="2" style="text-align:center;height:20px;' . $balance[$i]['ligne'] . '">Total : ' . $balance[$i]['compte'] . '</td>';
                endif;
                $html.='<td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                            <table cellspacing="0" cellpadding="3">
                                <tr>
                                    <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $montantDebit . '</td>
                                    <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $montantCredit . '</td>
                                </tr>
                            </table>
                        </td>
                        <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                            <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $montantMoisDebit . '</td>
                                  <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $montantMoisCredit . '</td>
                                                            
                               </tr>
                          </table>
                       </td>';
//                       <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
//                            <table cellspacing="0" cellpadding="3">
//                              <tr>
//                            <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $montantCumulDebit . '</td>
//                                  <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $montantCumulCredit . '</td>
//                                                                             
//                              </tr>
//                          </table>
//                       </td>

                $html.='   <td style="font-size:9px;' . $balance[$i]['ligne'] . '">
                          <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;' . $balance[$i]['ligne'] . '">' . $debiteur . '</td>
                                  <td style="text-align:right;width:50%;' . $balance[$i]['ligne'] . '">' . $crediteur . '</td>
                              </tr>
                          </table>
                       </td>
                    </tr>';
            endif;
        endfor;

        if ($balance[sizeof($balance) - 1]['6_debit'] == 0)
            $solde_debit_classe_6 = 0;
        else
            $solde_debit_classe_6 = number_format($balance[sizeof($balance) - 1]['6_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['6_credit'] == 0)
            $solde_credit_classe_6 = '';
        else
            $solde_credit_classe_6 = number_format($balance[sizeof($balance) - 1]['6_credit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['7_debit'] == 0)
            $solde_debit_classe_7 = '';
        else
            $solde_debit_classe_7 = number_format($balance[sizeof($balance) - 1]['7_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['7_credit'] == 0)
            $solde_credit_classe_7 = '';
        else
            $solde_credit_classe_7 = number_format($balance[sizeof($balance) - 1]['7_credit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['1_5_debit'] == 0)
            $solde_debit_classe_1_5 = '';
        else
            $solde_debit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['1_5_credit'] == 0)
            $solde_credit_classe_1_5 = '';
        else
            $solde_credit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_credit'], 3, '.', ' ');

        $html.='<tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;">Total Classes Charges</td>
                      <td colspan="2">'. '</td>
                      <td style="font-size: 8px;font-weight:bold; text-align: right;">' . 
                         '<table >
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_6 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_6 . '</td>
                            </tr>
                         </table>'.
                '</td>
                </tr>';
              $html.='  <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;border-right:1px solid #828282;">Total Classes Produits</td>
                      <td colspan="2"></td>
                      <td style="font-size:8px;font-weight: bold;">
                         <table cellspacing="0" cellpadding="3">
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_7 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_7 . '</td>
                            </tr>
                         </table>
                      </td>
                      </tr>
                <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:35px;">Résultat de Gestion</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight:bold;text-align:right;">
                                ' . number_format(($balance[sizeof($balance) - 1]['7_credit'] - $balance[sizeof($balance) - 1]['6_debit']), 3, '.', ' ') . '
                      </td>
                 </tr>
                 <tr style="font-weight: bold;">
                      <td colspan="2" style="text-align:center;font-size:11px;font-weight:bold;height:25px;">Résultat de Bilan</td>
                      <td colspan="2"></td>
                      <td style="font-size:9px;font-weight:bold;">
                        <table cellspacing="0" cellpadding="3">
                            <tr>
                                <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_1_5 . '</td>
                                <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_1_5 . '</td>
                            </tr>
                        </table>
                      </td>';
               $html.='  </tr>';
        $html.='  </table>';

        return $html;
    }

    public function ReadHtmlEtatBalanceTiers(sfWebRequest $request) {
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $compte = $request->getParameter('compte_min', '');
        $date_debut = $request->getParameter('date_debut');
        $date_fin = $request->getParameter('date_fin');
        $comptes_non_solde = $request->getParameter('comptes_non_solde', '');

        $compte_comptable = PlandossiercomptableTable::getInstance()->find($compte);
        $sous_comptes = PlanDossierComptableTable::getInstance()->findByCompteIdOrderNumero($compte);

        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $_SESSION['exercice_id'];

        $balance = calculBalanceTiers::getBalance($compte, $sous_comptes->getFirst()->getNumeroCompte(), $sous_comptes->getLast()->getNumeroCompte(), $date_debut, $date_fin, $comptes_non_solde, $dossier_id, $exercice_id);

        if ($date_debut != '' && $date_debut != NULL)
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '';
        if ($date_fin != '' && $date_fin != NULL)
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '';

        $th_periode = '<br>' . $date_debut . ' Au ' . $date_fin;

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Balance Tiers : ' . $_SESSION['exercice'] . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '<br>
                            <b>Compte Comptable :</b> ' . $compte_comptable->getNumerocompte() . ' - ' . $compte_comptable->getLibelle() . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                        <tr align="center" style="font-weight:bold;background-color:#F2F2F2;">
                            <td rowspan="2" style="width:10%;height:25px;">Compte Comptable</td>
                            <td rowspan="2" style="width:42%;">Libellé</td>
                            <td style="width:16%;">Mouvement Ouverture</td>
                            <td style="width:16%;">Mouvement Période ' . $th_periode . '</td>
                            <td style="width:16%;">Soldes</td>
                        </tr>
                        <tr style="font-weight:bold;background-color:#F2F2F2;">
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                            <td>
                                <table cellspacing="0" cellpadding="3">
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;height:20px;width:50%;border-right:1px solid #828282;">Débit</td>
                                        <td style="text-align:center;font-weight:bold;width:50%;">Crédit</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        <tr align="center" style="font-weight:bold;background-color:#F2F2F2;">
                            <td></td>
                            <td style="height:35px;">Report</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>';

        $total_debit = 0;
        $total_credit = 0;
        for ($i = 0; $i < (sizeof($balance) - 1); $i++) {

            if ($balance[$i]['debitOuv'] == 0)
                $montantDebit = '';
            else
                $montantDebit = number_format($balance[$i]['debitOuv'], 3, '.', ' ');

            if ($balance[$i]['creditOuv'] == 0)
                $montantCredit = '';
            else
                $montantCredit = number_format($balance[$i]['creditOuv'], 3, '.', ' ');

            if ($balance[$i]['debitMois'] == 0)
                $montantMoisDebit = '';
            else
                $montantMoisDebit = number_format($balance[$i]['debitMois'], 3, '.', ' ');

            if ($balance[$i]['creditMois'] == 0)
                $montantMoisCredit = '';
            else
                $montantMoisCredit = number_format($balance[$i]['creditMois'], 3, '.', ' ');

            if ($balance[$i]['debiteur'] == 0)
                $debiteur = '';
            else {
                $debiteur = number_format($balance[$i]['debiteur'], 3, '.', ' ');
                $total_debit = $total_debit + $balance[$i]['debiteur'];
            }

            if ($balance[$i]['crediteur'] == 0)
                $crediteur = '';
            else {
                $crediteur = number_format($balance[$i]['crediteur'], 3, '.', ' ');
                $total_credit = $total_credit + $balance[$i]['crediteur'];
            }

            $html.='<tr>
                        <td style="text-align:center;height:20px;">' . $balance[$i]['compte'] . '</td>
                        <td style="text-align:left;">' . $balance[$i]['libelle'] . '</td>
                        <td style="font-size:9px;">
                            <table cellspacing="0" cellpadding="3">
                                <tr>
                                    <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;">' . $montantDebit . '</td>
                                    <td style="text-align:right;width:50%;">' . $montantCredit . '</td>
                                </tr>
                            </table>
                        </td>
                        <td style="font-size:9px;">
                            <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;">' . $montantMoisDebit . '</td>
                                  <td style="text-align:right;width:50%;">' . $montantMoisCredit . '</td>
                              </tr>
                          </table>
                       </td>
                       <td style="font-size:9px;">
                          <table cellspacing="0" cellpadding="3">
                              <tr>
                                  <td style="text-align:right;height:20px;width:50%;border-right:1px solid #828282;">' . $debiteur . '</td>
                                  <td style="text-align:right;width:50%;">' . $crediteur . '</td>
                              </tr>
                          </table>
                       </td>
                    </tr>';
        }

        $solde_credit_classe_1_5 = 0;
        $solde_debit_classe_1_5 = 0;
        if ($balance[sizeof($balance) - 1]['1_5_debit'] == 0)
            $solde_debit_classe_1_5 = '';
        else
            $solde_debit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_debit'], 3, '.', ' ');

        if ($balance[sizeof($balance) - 1]['1_5_credit'] == 0)
            $solde_credit_classe_1_5 = '';
        else
            $solde_credit_classe_1_5 = number_format($balance[sizeof($balance) - 1]['1_5_credit'], 3, '.', ' ');

        $html.='<tr style="font-weight:bold;">
                    <td colspan="2" style="text-align:center;font-weight:bold;height:35px;">Total</td>
                    <td colspan="2"></td>
                    <td style="font-size:9px;font-weight:bold;text-align:right;">
                        <table cellspacing="0" cellpadding="3">
                          <tr>
                              <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . number_format($total_debit, 3, '.', ' ') . '</td>
                              <td style="text-align:right;font-weight:bold;">' . number_format($total_credit, 3, '.', ' ') . '</td>
                          </tr>
                        </table>
                    </td>
                 </tr>
                 <tr style="font-weight:bold;">
                    <td style="text-align:center;font-weight:bold;height:25px;">' . $balance[sizeof($balance) - 1]['compte_tiers'] . '</td>
                    <td style="text-align:center;font-weight:bold;height:25px;">' . $balance[sizeof($balance) - 1]['libelle_tiers'] . '</td>
                    <td colspan="2"></td>
                    <td style="font-size:9px;font-weight:bold;">
                      <table cellspacing="0" cellpadding="3">
                          <tr>
                              <td style="text-align:right;font-weight:bold;height:25px;border-right:1px solid #828282;">' . $solde_debit_classe_1_5 . '</td>
                              <td style="text-align:right;font-weight:bold;">' . $solde_credit_classe_1_5 . '</td>
                          </tr>
                      </table>
                    </td>
                 </tr>
              </table>';

        return $html;
    }

    public function ReadHtmlPlan(sfWebRequest $request) {
        ini_set('memory_limit', '-1');
        $id = $request->getParameter('id');
        $dossier_comptable = DossiercomptableTable::getInstance()->find($_SESSION['dossier_id']);

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT CONCAT('<tr><td>', TRIM(plandossiercomptable.numerocompte), '</td><td>', TRIM(plandossiercomptable.libelle), '</td><td>', CASE WHEN plancomptable.standard=1 THEN ' X' ELSE '' END, '</td><td>', TRIM(classecompte.libelle), '</td></tr>') as ligne"
                . " FROM plandossiercomptable, plancomptable, classecompte"
                . " WHERE plandossiercomptable.id_dossier = " . $dossier_comptable->getId() . " AND id_exercice = " . $_SESSION['exercice_id']
                . " AND plandossiercomptable.id_plan = plancomptable.id AND plancomptable.id_classe = classecompte.id"
                . " AND classecompte.id = " . $id
                . " ORDER BY plandossiercomptable.numerocompte";
        $compte = $conn->fetchAssoc($query);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $classe = ClassecompteTable::getInstance()->find($id);

        $html = '<table border="1"><tr><td>
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:16px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;"> Plan Comptable - Exercice' . $_SESSION['exercice'] . '<br>Classe : ' . $classe->getLibelle() . '</td>
                        </tr>
                    </table>
                </td></tr></table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="3" border="1" style="font-size:8px;">
                    <tr style="font-weight:bold;background-color:#F3F3F3;font-size:10px;">
                        <td style="width:7%;height:25px;">Num.</td>
                        <td style="width:75%;">Intitulé du Compte Comptable (St : Standard)</td>
                        <td style="width:3%;">St</td>
                        <td style="width:15%;">Classe</td>
                    </tr>
                    <tbody>';

        if (sizeof($compte) != 0):
            $html.= implode('', array_map(function ($entry) {
                        return $entry['ligne'];
                    }, $compte));
        else:
            $html.= '<tr>
                        <td style="text-align:center;font-size:14px;" colspan="4">&nbsp;<br>Pas de Comptes Comptable pour ce plan Comptable&nbsp;<br></td>
                    </tr>';
        endif;

        $html.= '</tbody></table>';

        return $html;
    }

}
