<?php

/**
 * ContratachatTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ContratachatTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object ContratachatTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Contratachat');
    }

    public function findBytypePartielEtdefifitif() {
//        1 c'est de type partiel
        $q = $this->createQuery('c')
                ->where('c.id_typedoc=' . 20)
                ->andWhere("trim(c.type)= '1'")
                ->orderBy('c.id')
//         die ($q);
                ->execute();


        return $q;
    }
 public function getByTypeDocAndDateBCICONTRAT($id_type) {

        $q = $this->createQuery('d')
                ->from('contratachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)    ;          
        $q->orderBy('d.numero asc');
        
        return $q->execute();
    }
    public function getAllDocByFilter($datedebut = '', $datefin = '', $idtype, $idfrs = '0') {

        $boncommandeexterne = Doctrine_Core::getTable('contratachat')
                ->createQuery('a')->where('id_typedoc=' . $idtype)
                ->andWhere('a.etatdocachat is null');

        if ($datedebut && $datedebut != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }
        if ($datefin && $datefin != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }
        if ($idfrs && $idfrs != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("id_frs=" . $idfrs);
        }
        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getAllDocByFilterProvisoire($datedebut = '', $datefin = '') {
        $year = date('Y');
        $boncommandeexterne = Doctrine_Core::getTable('contratachat')
                ->createQuery('a')->where('id_typedoc=' . 19)
                ->andWhere('a.etatdocachat is null')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        ;

        if ($datedebut && $datedebut != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }
        if ($datefin && $datefin != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }

        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getAllDocByFilterDefinitif($datedebut = '', $datefin = '', $idtype, $idfrs = '0') {

        $boncommandeexterne = Doctrine_Core::getTable('contratachat')
                ->createQuery('a')->where('id_typedoc=' . 20)
                ->andWhere('a.etatdocachat is null');

        if ($datedebut && $datedebut != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }
        if ($datefin && $datefin != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }
        if ($idfrs && $idfrs != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("id_frs=" . $idfrs);
        }
        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getAllDocByFilterDefinitifAvecdact($datedebut = '', $datefin = '') {
        $year = date('Y');
        $boncommandeexterne = Doctrine_Core::getTable('contratachat')
                ->createQuery('a')->where('id_typedoc=' . 20)
                ->andWhere('a.etatdocachat is null')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        ;

        if ($datedebut && $datedebut != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }
        if ($datefin && $datefin != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }

        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getAllContratProviAnnule() {
        $year = date('Y');
        $q = $this->createQuery('con')
                ->from('Documentcontratannulation docannu')
                ->leftJoin('docannu.Contratachat con')
                ->andWhere("trim(con.etatdocachat) = '" . trim("Annulé(e)") . "'")
                ->andWhere('docannu.valide_budget = false'
                        . ' and con.id_typedoc=19')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->orderBy('docannu.dateannulation desc');

        return $q;
    }

    public function getAllContratDefResilier() {
        $year = date('Y');
        $q = $this->createQuery('con')
                ->from('Documentcontratresiliation docannu')
                ->leftJoin('docannu.Contratachat con')
                ->andWhere("trim(con.etatdocachat) = '" . trim("Resilié(e)") . "'")
                ->andWhere('docannu.valide_budget = false'
                        . ' and con.id_typedoc=20')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->orderBy('docannu.dateresiliation desc');

        return $q;
    }

    public function getAllContratDefAnnule() {
        $year = date('Y');
        $q = $this->createQuery('con')
                ->from('Documentcontratannulation docannu')
                ->leftJoin('docannu.Contratachat con')
                ->andWhere("trim(con.etatdocachat) = '" . trim("Annulé(e)") . "'")
                ->andWhere('docannu.valide_budget = false'
                        . ' and con.id_typedoc=20')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->orderBy('docannu.dateannulation desc');

        return $q;
    }

}
