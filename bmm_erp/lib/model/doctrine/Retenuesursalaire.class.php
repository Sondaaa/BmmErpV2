<?php

/**
 * Retenuesursalaire
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Retenuesursalaire extends BaseRetenuesursalaire {

    public function __toString() {

        return "" . $this->getAgents()->getIdrh() . " " . $this->getAgents()->getNomcomplet() . " " . $this->getAgents()->getPrenom() . " " . $this->getMois() . " " . $this->getAnnee();
    }

    public function ReadHtmlListeRetenuesursalaire(sfWebRequest $request) {
        $id_fournisseur = $request->getParameter('id_fournisseur', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $id_agents = $request->getParameter('id_agents', '');
        if ($id_fournisseur != '') {
            $fournisseur = Doctrine_Core::getTable('fournisseur')->findOneById($id_fournisseur);
        }

        $q = Doctrine_Core::getTable('Retenuesursalaire')
                ->createQuery('rs')
                ->from('Retenuesursalaire rs')
                ->leftJoin('rs.Fournisseur f')
                ->leftJoin('rs.Agents a')
        ;

        if ($annee != '')
            $q->where('rs.annee = ' . intval($annee));
        if ($mois != '')
            $q->andWhere('rs.mois = ' . intval($mois));

        if ($id_fournisseur != '') {
            $q->andWhere('rs.id_fournisseur = ' . $id_fournisseur);
        }
        if ($id_agents != '')
            $q->andWhere('rs.id_agents = ' . $id_agents);

       
        $q->orderBy('rs.id');

        $demandes = $q->execute();

        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $html = '<h3>RECAPITULATIF DES RETENUES SUR SALAIRE';
        if ($id_fournisseur != ''): $html .= " DE  " . $fournisseur->getRs();
        else: $html .= "";
        endif;
        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;

        if ($id_agents != ""):
            $html .=" DE " 
                //. $agents->getNomcomplet() . " " . $agents->getPrenom() 
                . '</h3>';
        else :
            $html .= '</h3>';
        endif;


        $html.='&nbsp;<br>&nbsp;<br><table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 10%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 20%;text-align:center;"><label> Agents</label></td>
                        <td style="width: 15%;text-align:center;"><label>Fourniseur</label></td>
                        <td style="width: 10%;text-align:center;"><label>Moontant Global</label></td>
                        <td style="width: 10%;text-align:center;"><label>Période</label></td>      
                        <td style="width: 10%;text-align:center;"><label>Retenue Mensuel </label></td>
                        <td style="width: 10%;text-align:center;"><label>Date Retenue </label></td>
                        <td style="width: 10%;text-align:center;"><label>Dernière Retenue</label></td>
                    </tr>';
        if($demandes->count() > 0){
        $i = 1;
        foreach ($demandes as $demande):
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $demande->getAgents()->getIdrh() . '</td>
                        <td style="text-align:center;">' . $demande->getAgents()->getNomcomplet() . ' ' . $demande->getAgents()->getPrenom() . '</td>';

            if ($demande->getIdFournisseur() != ""):
                $html.= '<td style="text-align:center;">' . $demande->getFournisseur()->getRs() . '</td>';
            endif;
            $html.= '<td style="text-align:center;">' . $demande->getMontantpret() . '</td>                        
                        <td style="text-align:center;">' . $demande->getNbrmois() . " mois" . '</td>
                        <td style="text-align:center;">' . $demande->getRetenuesursalaire() . '</td>
                        <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande->getDatedebut()))
                    . '</td>
                       <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande->getDatefin()))
                    . '</td>
                            
                  </tr>';
            $i++;
        endforeach;
        }else{
            $html.='<tr style="font-size:16px;">
                        <td style="width:100%;height:80px;text-align:center;">&nbsp;<br><b>Pas de retenue sur salaire</b></td>
                    </tr>';
        }

        $html.='</table>';

        return $html;
    }

}
