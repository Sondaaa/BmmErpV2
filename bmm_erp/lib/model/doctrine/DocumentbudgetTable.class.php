<?php

/**
 * DocumentbudgetTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class DocumentbudgetTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object DocumentbudgetTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Documentbudget');
    }

    public function getOrdonnanceNonDeclare($date_debut = '', $date_fin = '', $id_caissebanque = '') {
        $q = $this->createQuery('o')
                ->leftJoin('o.Ligprotitrub l')
                ->leftJoin('l.Lignebanquecaisse lbc')
                ->where('o.id_declaration IS NULL')
                ->andWhere('lbc.id_caissebanque = ?', $id_caissebanque)
                ->andWhere('o.id_documentbudget IS NOT NULL')
                ->andWhere('o.id_type = 2')
                ->andWhere('o.datecreation >= ?', $date_debut)
                ->andWhere('o.datecreation <= ?', $date_fin)
                ->orderBy('o.datecreation asc');

        return $q->execute();
    }

    public function getByLigAndPieceJointb($id_ligne = '', $iddoc = '') {
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $q = 'SELECT o.id_budget ,o.numero as numero ,typedocbudget.libelle as typebudget, '
                . ' titrebudjet.libelle as titrebudget ,rubrique.libelle as rubrique , '
                . 'rubrique.id as id_rubrique'
                . ' , o.mnt as mnt , l.mntengage as mntengage , l.relicaengager as mntrelicat'
                . ' FROM documentbudget o ,Ligprotitrub l ,typedocbudget , titrebudjet,rubrique '
                . ' WHERE o.id_budget=l.id AND o.id_budget = ' . $id_ligne
                . ' AND o.id_documentbudget IS NULL AND o.id '
                . ' in (select id_documentbudget from piecejointbudget where '
                . ' id_docachat=' . $iddoc . ')'
                . ' and o.id_type = typedocbudget.id'
                . ' and l.id_titre=titrebudjet.id '
                . ' and l.id_rubrique =rubrique.id '
                . ' and o.id_budget=l.id'
                . ' GROUP BY o.id_budget , o.numero,typedocbudget.libelle,rubrique.libelle'
                . ' , titrebudjet.libelle , rubrique.id , o.mnt ,l.mntengage,l.relicaengager'
        //        $q = $this->createQuery('o')
        //                ->select('o.id_budget')
        //                ->from('documentbudget o ,Ligprotitrub l ')
        //                ->where('o.id_budget=l.id')
        //                ->andWhere('o.id_budget = ' . $id_ligne)
        //                ->andWhere('o.id_documentbudget IS NULL')
        //                ->andWhere('o.id in  (select id_documentbudget from piecejointbudget where'
        //                        . ' id_docachat=' . $iddoc . ')')
        //                ->groupBy('o.id_budget')
        ;
        //        die($q);
        $piecebudget = $conn->fetchAssoc($q);
        return $piecebudget;
    }

    public function getByListeId($ids) {
        $q = $this->createQuery('o')
                ->whereIn('o.id', (array) $ids)
                ->orderBy('o.datecreation')
                ->execute();
        return $q;
    }

    public function getMontantAntecedantByLigprotitrub($date = '', $id_ligprotitrub = '') {
        
        $q = $this->createQuery('o')
                ->select('COALESCE(SUM(o.mnt),0) as mnt')
                ->andWhere('o.id_budget = ?', $id_ligprotitrub)
                ->andWhere('o.id_documentbudget IS NULL')
                ->andWhere('o.id_type = 1')
                ->andWhere('(o.annule = false OR o.annule IS NULL)')
                ->andWhere('o.datecreation < ?', $date);

        return $q->execute()->getFirst();
    }

    public function getMontantCourantByLigprotitrub($date = '', $date_fin = '', $id_ligprotitrub = '') {
        $q = $this->createQuery('o')
                ->select('COALESCE(SUM(o.mnt),0) as mnt')
                ->andWhere('o.id_budget = ?', $id_ligprotitrub)
                ->andWhere('o.id_documentbudget IS NULL')
                ->andWhere('o.id_type = 3')
                ->andWhere('(o.annule = false OR o.annule IS NULL)')
                ->andWhere('o.datecreation >= ?', $date)
                ->andWhere('o.datecreation <= ?', $date_fin);

        return $q->execute()->getFirst();
    }

    public function getMontantCourantRubriqueByLigprotitrub($date = '', $date_fin = '', $id_ligprotitrub = '') {
        $q = $this->createQuery('o')
                ->select('COALESCE(SUM(o.mnt),0) as mnt')
                ->andWhere('o.id_budget = ?', $id_ligprotitrub)
                ->andWhere('o.id_documentbudget IS NULL')
                ->andWhere('o.id_type = 1')
                ->andWhere('(o.annule = false OR o.annule IS NULL)')
                ->andWhere('o.datecreation >= ?', $date)
                ->andWhere('o.datecreation <= ?', $date_fin);

        return $q->execute()->getFirst();
    }

    public function getMntTypeDocBudget($id_ligprotitrub, $type) {
        $q = $this->createQuery('o')
                ->select('COALESCE(SUM(o.mntnet),0) as mnt')
                ->andWhere('o.id_budget = ?', $id_ligprotitrub)
                ->andWhere('o.id_type = ' . $type)
                ->andWhere('(o.annule = false OR o.annule IS NULL)');
        return $q->execute()->getFirst();
    }

    public function getByDocbudgetAndType($id_budget, $type) {
        $q = $this->createQuery('o')
                ->select('*')
                ->andWhere('o.id_documentbudget = ' . $id_budget)
                ->andWhere('o.id_type = ' . $type)
                ->andWhere('(o.annule = false OR o.annule IS NULL)');
        return $q->execute()->getFirst();
    }

    public function getDocumentByNumeroInPeriode($date_debut = '', $date_fin = '', $numero = '') {
        $q = $this->createQuery('d')
                ->select('d.*')
                ->andWhere('d.numero = ?', $numero)
                ->andWhere('(d.annule = false OR d.annule IS NULL)')
                ->andWhere('d.datecreation >= ?', $date_debut)
                ->andWhere('d.datecreation <= ?', $date_fin);

        return $q->execute()->getFirst();
    }

    public function getByMontntandtype() {
        $q = $this->createQuery('d')
                ->select('d.*')
                ->from('documentbudget d,documentachat')
                ->andWhere('d.mntnet=documentachat.mntttc')
                ->andWhere('d.id_type = 2');

        return $q->execute();
    }

    public function getByMontntandtypeAA($mntttc) {

        $q = $this->createQuery('d')
                ->select('d.*')
                ->from('documentbudget d,documentachat')
                ->andWhere('d.mntnet=' . $mntttc)
                ->andWhere('d.id_type = 2');

        return $q->execute();
    }

    public function getByIdDocumentbudget($id_doc) {

        $q = $this->createQuery('d')
                ->select('d.*')
                ->from('documentbudget d')
                ->andWhere('d.id_documentbudget=' . $id_doc)
                ->andWhere('d.id_type = 2');

        return $q->execute();
    }

}
