<?php

/**
 * MouvementcomptableTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class MouvementcomptableTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object MouvementcomptableTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Mouvementcomptable');
    }

   public function RechercheByPeriode($datedebut = '', $datefin = '') {
        $q = Doctrine_Core::getTable('Mouvementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('a.id asc');
        return $q->execute();
    }

    public function loadByInterval($reglement_min = '', $reglement_max = '', $datedebut = '', $datefin = '') {
        $q = Doctrine_Core::getTable('Mouvementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);

        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");
        if ($reglement_min != "")
            $q = $q->AndWhere('a.id >=' . $reglement_min);

        if ($reglement_max != '')
            $q->andWhere('a.id <= ' . $reglement_max);
        $q = $q->Andwhere("a.saisie = 0");
        $q = $q->orderby('id asc');
        return $q->execute();
    }

    public function load($datedebut = '', $datefin = '', $reference = '', $libelle = '', $type = '') {
      
      
        $q = Doctrine_Core::getTable('Mouvementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id'])
        ;  
        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER( a.libelle)  LIKE '%" . strtoupper($libelle) . "%'");
        if ($type && $type != "")
            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");

        $q = $q->Andwhere("a.saisie = 0");

        $q = $q->orderby('id asc');
        return $q;
    }

    public function loadSaisie($datedebut = '', $datefin = '', $reference = '', $libelle = '', $type = '') {
        $q = Doctrine_Core::getTable('Mouvementcomptable')
                ->createQuery('a')
                ->where("a.id_dossier = ?", $_SESSION['dossier_id']);
        if ($datedebut && $datedebut != "")
            $q = $q->Andwhere("date >= '" . $datedebut . "'");

        if ($datefin && $datefin != "")
            $q = $q->Andwhere("date <= '" . $datefin . "'");

        if ($reference && $reference != "")
            $q = $q->Andwhere("(a.numero)  ='" . $reference . "'");
        if ($libelle && $libelle != "")
            $q = $q->Andwhere("UPPER( a.libelle)  LIKE '%" . strtoupper($libelle) . "%'");
        if ($type && $type != "")
            $q = $q->Andwhere("UPPER( a.type)  LIKE '" . strtoupper($type) . "%'");
        $q = $q->Andwhere("a.saisie = 1");

        $q = $q->orderby('id asc');
        return $q;
    }

    public function getAllPagerComptabilite($numero = '', $libelle = '', $type = '', $compte = '') {
        $q = $this->createQuery('f')
                ->select('f.id as id, f.numero as reference, p.numerocompte as numerocompte, p.libelle as libellecompte')
                ->from('Mouvementcomptable f')
                ->leftJoin('f.Plandossiercomptable p')
                ->where('f.id_dossier = ?', $_SESSION['dossier_id']);
        if ($numero != '') {
            $q = $q->andWhere('UPPER(f.numero) like ?', '%' . $numero . '%');
        }
        if ($libelle != '') {
            $q = $q->andWhere('UPPER(f.libelle) like ?', '%' . $libelle . '%');
        }
        if ($libelle != '') {
            $q = $q->andWhere('UPPER(f.libelle) like ?', '%' . $libelle . '%');
        } if ($type != '') {
            $q = $q->andWhere('UPPER(f.type) like ?', '%' . $type . '%');
        }
        if ($compte != '') {
            $q = $q->andWhere("p.id = " . $compte);
        }

        $q = $q->orderBy('f.id');
        return $q;
    }
}