<?php

/**
 * Paie
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    Tes
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Paie extends BasePaie {

//liste
    public function ReadHtmllistePaieAllFilter($idag, $idAgF, $mois, $annee, $annee_session) {

        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');

        if ($idag != '' && $idAgF == null)
            $q = $q->andWhere('a.id= ?', $idag)
            ;

        if ($idAgF != '' && $idag == null)
            $q = $q->andWhere('a.id= ?', $idAgF);

        if ($idAgF != '' && $idag != '') {
            $q = $q->andWhere('a.id >= ?', $idag);
            $q = $q->andWhere('a.id < ?', $idAgF);
        }

        if ($mois != '')
            $q = $q->andWhere('p.mois= ?', $mois);

        if ($annee != '')
            $q = $q->andWhere('p.annee= ?', $annee);

        $listes = $q->execute();
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");

        $html = '<h3>Liste des Fiches de Paie </h3>
            &nbsp;<br>
            <table border="1" cellpadding="3">
            <tr>
                <td style="width:25%;font-weight:bold;" rowspan="3">Recherche suivant : </td>';

        if ($mois != ''):
            $html.='<td style="width:40%;font-weight:bold;">Mois : ' . $array[$mois] . '</td>';
        endif;
        if ($annee != ''):
            $html.='<td style="width:35%;font-weight:bold;">Année : ' . $annee . '</td>';
        endif;

        $html.='</tr>';
        if ($idag != ''): $agents = Doctrine_Core::getTable('agents')->findOneById($idag);
            $html.='<tr>
                        <td style="width:10%;font-weight:bold;" rowspan="2">Agent : </td>
                        <td style="width:65%;font-weight:bold;">De : ' . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</td>
                    </tr>';
        endif;

        if ($idAgF != ''):
            $agents = Doctrine_Core::getTable('agents')->findOneById($idAgF);
            $html.= '<tr>
                        <td style="width:65%;font-weight:bold;">Au : ' . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</td>
                    </tr>';
        endif;
        $html.='</table>&nbsp;<br>';

        $html.='<table border="1" cellpadding="3">
           <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;font-size:12px;">
                    <th style="width: 5%;text-align:center;">N°</th>
                    <th style="width: 19%;text-align:center;">Agents</th>
                    <th style="width: 11%;text-align:center;">Salaire de Base</th> 
                    <th style="width: 11%;text-align:center;">Salaire Brut</th> 
                    <th style="width: 13%;text-align:center;">Salaire Imposable</th> 
                    <th style="width: 11%;text-align:center;">Total Retenue</th> 
                    <th style="width: 10%;text-align:center;">Net à Payer</th> 
                    <th style="width: 12%;text-align:center;">Mois</th> 
                    <th style="width: 8%;text-align:center">Année</th>       
                </tr>';

        if ($listes->count() != 0):
            $i = 1;
            foreach ($listes as $p):
                $html.='<tr style="font-size:11px;">
                            <td style="text-align:center;">' . $i . '</td>
                            <td>' . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . '</td>
                            <td style="text-align:right;">' . $p->getSalairedebase() . '</td>
                            <td style="text-align:right;">' . $p->getSalairebrut() . '</td>
                            <td style="text-align:right;">' . $p->getSalaireimposable() . '</td>
                            <td style="text-align:right;">' . $p->getTotalretenue() . '</td>
                            <td style="text-align:right;">' . $p->getNetapayyer() . '</td>
                            <td style="text-align:center;">' . $array[$p->getMois()] . '</td>
                            <td style="text-align:center;">' . $p->getAnnee() . '</td>
                        </tr>';
                $i++;
            endforeach;
            $html.='</tbody>';
        else:
            $html.='<tr>
                        <td style="width:100%;height:60px;text-align:center;">&nbsp;<br><b>Pas des Fiches de Paie</b></td>
                    </tr>';
        endif;
        $html.='</table>';

        return $html;
    }

//impression all fiche de Paie 
    public function ReadFiche($p) {

        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        $query = " select COALESCE(count(primes.id ),0) as nbrpci  ,titreprimes.libelle as libelle, primes.montant as montant  "
                . " from paie ,contrat,ligneprimecontrat ,primes ,titreprimes"
                . "   where paie.id_contrat=contrat.id"
                . " and primes.id_titreprime=titreprimes.id"
                . " and ligneprimecontrat.id_prime=primes.id "
                . " and ligneprimecontrat.id_contrat=contrat.id "
                . " and primes.cotisable=true"
                . " and primes.imposable=true"
//                ." and primes.primeactiveindemnite=false"
                . " and paie.id=" . $p->getId()
                . " group by titreprimes.libelle,primes.montant";

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $primesCI = $conn->fetchAssoc($query);

        $query_2 = " select COALESCE(count(primes.id ),0) as nbrpci ,titreprimes.libelle as libelle, primes.montant as montant  "
                . " from paie ,contrat,ligneprimecontrat ,primes ,titreprimes"
                . "   where paie.id_contrat=contrat.id"
                . " and primes.id_titreprime=titreprimes.id"
                . " and ligneprimecontrat.id_prime=primes.id "
                . " and ligneprimecontrat.id_contrat=contrat.id "
                . " and primes.cotisable=false"
                . " and primes.imposable=false"
//                ." and primes.primeactiveindemnite=false"
                . " and paie.id=" . $p->getId()
                . " group by titreprimes.libelle,primes.montant";

        $primesNCNI = $conn->fetchAssoc($query_2);
        if ($p->getIdPresence() != null):
            $fiche = '<table class="tableligne"><tr><td><table>' .
                    "<tbody>" . ""
                    . '<tr><td style="width: 70%;text-align: left;font-weight:bold; font-size: 10px">' . $societe->getRs() . " <br>" .
                    $societe->getAdresse() . "<br>N° ";

            if ($societe->getTypecotisation() == 1):
                $fiche.= 'CNSS : ';
            endif;
            if ($societe->getTypecotisation() == 2):
                $fiche.= 'CNRPS : ';
            endif;
            $fiche.= $societe->getIdunique()
                    . ' </td> <td style="width: 30%;text-align:center; font-weight:bold; font-size: 10px">Fiche de Paie <br>';
            if ($p->getMois() <= 12):
                $fiche.= $array[$p->getMois()] . " ";
            elseif ($p->getMois() > 12):
                $ligne = Doctrine_Core::getTable('lignesociete')->findOneByCodemois($p->getMois());
                $fiche.= $ligne->getLibelle();
            endif;
            $fiche.= $p->getAnnee() . " "
                    . "</td></tr></tbody></table></td></tr></table>";
            $fiche.='<table class="tableligne"><tr><td><table>' . ""
                    . '<tr>'
                    . '<td style="text-align: left;font-weight:bold;font-size: 10px;width:25%">Matricule Employé : </td>'
                    . '<td style="font-weight:bold;font-size: 10px;width:37%;text-align: left;">' . $p->getAgents()->getIdrh() . '</td>'
                    . '<td style="font-weight:bold;font-size: 10px;width: 20%;text-align: left;">N° Affiliation :</td>'
                    . '<td style="width:18%;text-align: right;font-weight:bold;font-size: 10px;"> ' . $p->getContrat()->getIdunique() . "</td>"
                    . '</tr>' .
                    '<tr>'
                    . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:19%;">Nom Prénom : ' . "</td>"
                    . '<td style="font-weight:bold; font-size: 10px;width:43%;text-align: left;">'
                    . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . "</td>"
                    . '<td style="font-weight:bold;font-size: 10px;width:22%;text-align: left;">Date Embauche : ' . "</td>"
                    . '<td style="width:16%;text-align: right;font-weight:bold;font-size: 10px;">' . date('d/m/Y', strtotime($p->getContrat()->getDateemposte())) . "</td>"
                    . "</tr>" .
                    "<tr>"
                    . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:19%;">Qualification : ' .
                    '</td>' . '<td style="text-align: left; width:43%; font-weight:bold;">' . $p->getContrat()->getSalairedebase()->getGrade()->getLibelle() . "</td>"
                    . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:22%;text-align: left">Catégorie : ' . "</td>" .
                    '<td style="text-align: left; font-weight:bold; font-size: 10px;width:16%;text-align: right;">'
                    . $p->getContrat()->getSalairedebase()->getCategorierh() . "</td></tr>"
                    . "<tr>" .
                    '<td style="text-align: left; font-weight:bold; font-size: 10px;width:19%">Echelle: ' . "</td>"
                    . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:43%">' .
                    $p->getContrat()->getSalairedebase()->getEchelle()->getLibelle() .
                    "</td>"
                    . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:22%">Echelon: ' . "</td>" .
                    '<td style="text-align: left; font-weight:bold; font-size: 10px;width:16%;text-align: right ">' .
                    $p->getContrat()->getSalairedebase()->getEchelon()->getLibelle() .
                    "</td>"
                    . "</tr>"
                    . "<tr>" . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:19%">Etat Civil : ' . "</td>";

            if ($p->getMois() <= 12):
                $fiche.='<td style="font-weight:bold; font-size: 10px;width:10%;text-align: left;">' . $p->getAgents()->getEtatcivil() . "</td>"
                        . '<td style="font-weight:bold;font-size: 10px;width:33%;">S.T  : ' . number_format($p->getSalaireteorique(), 3, '.', ' ') . '</td>'
                        . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:20%;">Salaire de Base  : ' . "</td>" .
                        '<td style="font-weight:bold;font-size: 10px;width:18%;text-align: right;">' . number_format($p->getSalairedebase(), 3, '.', ' ') . "</td>";

            else:
                $fiche.='<td style="font-weight:bold; font-size: 10px;width:35%;text-align: left">' . $p->getAgents()->getEtatcivil() . "</td>"
                        . '<td style="font-weight:bold;width:23%">S.T : </td><td style="font-weight:bold;width:23%;text-align: right;">'
                        . number_format($p->getSalaireteorique(), 3, '.', ' ') . '</td>';

            endif;

            $fiche.= "</tr>"
                    . "</tbody></table></td></tr></table>";
            if ($p->getMois() <= 12):
                $height = 270;
            else:
                $height = 362;
            endif;
            $fiche.= '<table class="tableligne" style="border: 1px solid black">
            <tbody>';

            $fiche.=' <tr>
                     <td style=" width: 45%; font-size: 10px;font-weight:bold;">Elément de salaire</td>
                     <td style=" width: 15%; font-size: 10px;font-weight:bold;">Nbr J/H</td>
                     <td style=" width: 20%; font-size: 10px;font-weight:bold;">Gains</td>
                     <td style=" width: 20%; font-size: 10px;font-weight:bold;">Retenues</td>
                     </tr>';
            if ($p->getMois() <= 12):

                $fiche.='<tr style="border-bottom:2pt solid none;">
                            <td style="text-align: left;font-size: 10px; border-bottom:1.9pt solid none"> JOURS TRAVAILLES</td>'
                        . '<td  style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none"> ' . $p->getNbrjtravaille() . ' J' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none"> ' . number_format((($p->getSalairedebase() / ( $p->getNbrjtravaille() + $p->getNbrjf() ) ) * $p->getNbrjtravaille()), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom:1.9pt solid none"></td>
                        </tr>
                        <tr style="border-bottom:2pt solid none;">
                            <td style="text-align: left ;border-bottom:1.9pt solid none;"> JOURS FERIES</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none;"> ' . $p->getNbrjf() . ' J' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none;"> ' . number_format((($p->getSalairedebase() / ($p->getNbrjtravaille() + $p->getNbrjf()) ) * $p->getNbrjf()), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom:1.9pt solid none"></td>
                        </tr>
            
                        <tr style="border-bottom: 0pt solid black;">
                            <td style="font-weight:bold; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE SANS PRIMES </td>'
                        . '<td style="border-bottom:2px solid none"> </td>'
                        . '<td style="font-weight:bold;text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalairedebase(), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>
                        </tr>';

                for ($i = 0; $i < sizeof($primesCI); $i++):
                    $fiche.= '<tr style="margin-bottom: 0px">
                      <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> ' . $primesCI[$i]['libelle'] . ' </td>'
                            . '<td style="border-bottom: 1.9px solid none"></td>'
                            . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($primesCI[$i]['montant'], 3, '.', ' ') . '</td>'
                            . '<td style="border-bottom: 1.9px solid none"></td>'
                            . '</tr>';
                    $height = $height - 25;
                endfor;
            endif;
            $fiche.= '<tr style="margin-bottom: 0px">';
            if ($p->getMois() <= 12):
                $fiche.= '<td style="font-weight:bold ;text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE  BRUT </td>';
            else:
                $fiche.= '<td style="font-weight:bold ;text-align: left;font-size: 10px;border-bottom: 1.9px solid none">   BRUT Prime</td>';
            endif;
            $fiche.='<td style="border-bottom: 1.9px solid none"> ' . '' . '</td>';
            if ($p->getMois() <= 12):
                $fiche.= '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalairebrut(), 3, '.', ' ') . '</td>';
            else:
                $fiche.= '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getBrutprime(), 3, '.', ' ') . '</td>';
            endif;
            $fiche.= '<td style="border-bottom: 1.9px solid none"></td>'
                    . '</tr>';

            if ($p->getLignecodesociale()->getTaux() != '' && $p->getLignecodesociale()->getTaux() != 0.000):
                $fiche.= '<tr>';
                $fiche.='<td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> '
                        . $p->getCodesociale()->getLibelle()
                        . '</td>';
                $fiche.='<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> '
                        . number_format($p->getLignecodesociale()->getTaux(), 2, '.', ' ') . " %"
                        . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getMontantsocialemensuel(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= '<tr>
                 <td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE IMPOSABLE</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '' . '</td>'
                    . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalaireimposable(), 3, '.', ' ') . '</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                    . '</tr> ';

            if ($p->getMontantirpp() != '' && $p->getMontantirpp() != 0):
                $fiche.= '<tr>
                  <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> IRPP</td>'
                        . '<td style="text-align: right;border-bottom: 1.9px solid none"> </td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getMontantirpp(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            if ($p->getContribitionsociale() != '' && $p->getContribitionsociale() != 0):
                $fiche.= '<tr>
                  <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> CTR.SOCIALE ET DE SOLIDARITE(1%)  </td>'
                        . '<td style="text-align: right;border-bottom: 1.9px solid none"> </td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getContribitionsociale(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= '<tr>
                 <td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE NET D\'IMPOTS</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '' . '</td>'
                    . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' .
                    number_format(($p->getSalaireimposable() - $p->getMontantirpp() - $p->getContribitionsociale()), 3, '.', ' ')
                    . '</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                    . '</tr>';

            for ($i = 0; $i < sizeof($primesNCNI); $i++):
                $fiche.= '<tr>
                      <td style="text-align: left;font-size: 10px; border-bottom: 1.9px solid none"> ' . $primesNCNI[$i]['libelle'] . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($primesNCNI[$i]['montant'], 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '</tr>';
                $height = $height - 25;
            endfor;

//        $fiche.= ' <tr><td style="font-weight:bold ; text-align: left"> SALAIRE NET   </td>'
//                . '<td>' . '' . '</td>'
//                . '<td style="font-weight:bold ; text-align: right"> ' .
//                $p->getSalairenet()
//                . '</td>'
//                . '<td>' . '</td>'
//                . '</tr> ';
//        $height = $height - 25;

            if ($p->getTotalretenue() != '' && $p->getTotalretenue() != 0):
                $fiche.= ' <tr><td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none">  TOTAL RETENUE   </td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' .
                        number_format($p->getTotalretenue(), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= "<tr>"
                    . '<td style="border-bottom: 0px solid none; height: ' . $height . 'px;">&nbsp;</td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . "</tr>"
                    . "</tbody></table>";

            $fiche.='<table class="tableligne">'
                    . '<tr><td style="width: 60%"><table>'
                    . '<tr><td style="text-align: center;font-size: 10px;">'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . 'Signature Employeur</td></tr><br><tr><td style="text-align: left ; font-size: 10px;">'
                    . 'Sit. Prof : ' . $p->getContrat()->getTypecontrat()
                    . '</td></tr><tr><td style="text-align: left ; font-size: 10px;">'
                    . 'Signature Employé :</td></tr><tr><td><br><br></td><br><br></tr></table></td>'
                    . '<td style="font-weight:bold; text-align: center;width: 40%;font-size: 10px;height: 130px;">'
                    . 'Net à Payer : ' . number_format($p->getNetapayyer(), 3, '.', '')
                    . '</td></tr></table>';
        endif;
        return $fiche;
    }

    public function ReadHtmllisteFichesPaieAllFilter($idag, $idAgF, $mois, $annee) {

        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a,codesociale c , lignecodesociale l')
                ->where('p.id_agents=a.id')
                ->andWhere('p.id_codesociale=c.id')
                ->andWhere('p.id_lignecodesociale=l.id')
                ->andWhere('l.id_codesoc=c.id')
        ;

        if ($idag != '' && $idAgF == null)
            $q = $q->andWhere('a.id= ?', $idag);

        if ($idAgF != '' && $idag == null)
            $q = $q->andWhere('a.id= ?', $idAgF);
        if ($idAgF != '' && $idag != '') {
            $q = $q->andWhere('a.id >= ?', $idag);
            $q = $q->andWhere('a.id < ?', $idAgF);
        }
        if ($mois != '')
            $q = $q->andWhere('p.mois= ?', $mois);
        if ($annee != '')
            $q = $q->andWhere('p.annee= ?', $annee);
        $q = $q->orderBy('p.id_agents,p.mois');
        $listes = $q->execute();

        $html = '<style>
                    td{font-size: 12px;}
                </style>';
        foreach ($listes as $p):
            $fiche = $this->ReadFiche($p);

            $html.= '<table style="width: 100%">'
                    . "<tbody><tr>"
                    . '<td style="width:49%;">' . $fiche . '</td>'
                    . '<td style="width:1%;border-right: 1px dashed #000000;"></td>'
                    . '<td style="width:1%;"></td>'
                    . '<td style="width:49%;">' . $fiche . '</td>'
                    . "</tr>"
                    . "</table>";
        endforeach;

        return $html;
    }

//format A4 
    public function ReadHtmllisteFichesPaieA4AllFilter($idag, $idAgF, $mois, $annee) {
        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');

        if ($idag != '' && $idAgF == null)
            $q = $q->andWhere('a.id= ?', $idag);

        if ($idAgF != '' && $idag == null)
            $q = $q->andWhere('a.id= ?', $idAgF);
        if ($idAgF != '' && $idag != '') {
            $q = $q->andWhere('a.id >= ?', $idag);
            $q = $q->andWhere('a.id < ?', $idAgF);
        }
        if ($mois != '')
            $q = $q->andWhere('p.mois= ?', $mois);
        if ($annee != '')
            $q = $q->andWhere('p.annee= ?', $annee);
        $listes = $q->execute();
        $fiche = '';

        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        foreach ($listes as $p) :
            $societe = Doctrine_Core::getTable('societe')->findOneById(1);
            $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
            $query = " select COALESCE(count(primes.id ),0) as nbrpci  ,titreprimes.libelle as libelle, primes.montant as montant  "
                    . " from paie ,contrat,ligneprimecontrat ,primes ,titreprimes"
                    . " where paie.id_contrat=contrat.id"
                    . " and primes.id_titreprime=titreprimes.id"
                    . " and ligneprimecontrat.id_prime=primes.id "
                    . " and ligneprimecontrat.id_contrat=contrat.id "
                    . " and primes.cotisable=true"
                    . " and primes.imposable=true"
                    . " and paie.id=" . $p->getId()
                    . " group by titreprimes.libelle,primes.montant";
            $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
            $primesCI = $conn->fetchAssoc($query);
            $query_2 = " select COALESCE(count(primes.id ),0) as nbrpci ,titreprimes.libelle as libelle, primes.montant as montant  "
                    . " from paie ,contrat,ligneprimecontrat ,primes ,titreprimes"
                    . " where paie.id_contrat=contrat.id"
                    . " and primes.id_titreprime=titreprimes.id"
                    . " and ligneprimecontrat.id_prime=primes.id "
                    . " and ligneprimecontrat.id_contrat=contrat.id "
                    . " and primes.cotisable=false"
                    . " and primes.imposable=false"
                    . " and paie.id=" . $p->getId()
                    . " group by titreprimes.libelle,primes.montant";
            $primesNCNI = $conn->fetchAssoc($query_2);
            $fiche.= '<table class="tableligne"><tr><td><table>' .
                    "<tbody>" . ""
                    . '<tr><td style="width: 70%;text-align: left;font-weight:bold; font-size: 10px">' . $societe->getRs() . " <br>" .
                    $societe->getAdresse() . "<br>"
                    . "N° ";
            if ($societe->getTypecotisation() == 1):
                $fiche.= 'CNSS : ';
            endif;
            if ($societe->getTypecotisation() == 2):
                $fiche.= 'CNRPS : ';
            endif;
            $fiche.= $societe->getIdunique()
                    . ' </td> <td style="width: 30%;text-align:center; font-weight:bold; font-size: 10px">Fiche de Paie <br>';

            if ($p->getMois() <= 12):
                $fiche.= $array[$p->getMois()] . " ";
            else:
                $ligne = Doctrine_Core::getTable('lignesociete')->findOneByCodemois($p->getMois());
                $fiche.= $ligne->getLibelle();
            endif;
            $fiche.= " " . $p->getAnnee() . " "
                    . "</td></tr></tbody></table></td></tr></table>";
            $fiche.='<table class="tableligne" ><tr><td><table >' . ""
                    . '<tr>'
                    . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:19%">Matricule Employé : </td>'
                    . '<td style="font-weight:bold; font-size: 10px;width:43%;text-align: left">' . $p->getAgents()->getIdrh() . '</td>'
                    . '<td style="font-weight:bold; font-size: 10px ;width: 22%;text-align: left" >N° Affiliation :</td>'
                    . '<td style="width:16% ;text-align: right;font-weight:bold; font-size: 10px;"> ' . $p->getContrat()->getIdunique() . '</td>
                    </tr>
                    <tr>
                        <td style="text-align: left;font-weight:bold; font-size: 10px;width:15%;">Nom Prénom : ' . "</td>"
                    . '<td style="font-weight:bold; font-size: 10px;width:47%;text-align: left;">'
                    . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . "</td>"
                    . '<td style="font-weight:bold; font-size: 10px;width:22%;text-align: left">Date Embauche : ' . "</td>"
                    . '<td style="width:16%;text-align: right;font-weight:bold; font-size: 10px;">' . date('d/m/Y', strtotime($p->getContrat()->getDateemposte())) . '</td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight:bold; font-size: 10px;width:15%">Qualification : </td>'
                    . '<td style="text-align: left; width:47%;font-weight:bold; font-size: 10px;">' . $p->getContrat()->getSalairedebase()->getGrade()->getLibelle() . "</td>"
                    . '<td style="text-align: left; font-weight:bold; font-size: 10px;width:22%;text-align: left">Catégorie : ' . "</td>" .
                    '<td style="text-align: left; font-weight:bold; font-size: 10px;width:16%;text-align: right;">'
                    . $p->getContrat()->getSalairedebase()->getCategorierh() . '</td>
                    </tr>
                    <tr>
                        <td style="text-align: left;font-weight:bold; font-size: 10px;width:15%">Echelle : ' . "</td>"
                    . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:47%">' . $p->getContrat()->getSalairedebase()->getEchelle()->getLibelle() . "</td>"
                    . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:22%">Echelon : ' . "</td>" .
                    '<td style="text-align: left;font-weight:bold; font-size: 10px;width:16%;text-align: right ">' . $p->getContrat()->getSalairedebase()->getEchelon()->getLibelle() . "</td>" . "</tr>"
                    . "<tr>" . '<td style="text-align: left;font-weight:bold;font-size: 10px;width:15%">Etat Civil : ' . "</td>"
            ;
            if ($p->getMois() <= 12):
                $fiche.='<td style="font-weight:bold; font-size: 10px;width:10%;text-align: left">' . $p->getAgents()->getEtatcivil() . "</td>"
                        . '<td style="font-weight:bold;width:37%;font-size: 10px;">S.T  : '
                        . number_format($p->getSalaireteorique(), 3, '.', ' ') . '</td>'
                        . '<td style="text-align: left;font-weight:bold; font-size: 10px;width:20%;">Salaire de Base  : ' . "</td>" .
                        '<td style="font-weight:bold; font-size: 10px;width:18%;text-align: right;">' . number_format($p->getSalairedebase(), 3, '.', ' ') . "</td>";
            else:
                $fiche.='<td style="font-weight:bold; font-size: 10px;width:37%;text-align: left">' . $p->getAgents()->getEtatcivil() . "</td>"
                        . '<td style="font-weight:bold;width:25%;font-size: 10px;">S.T  : </td><td style="font-weight:bold;width:23%;text-align: right;">'
                        . number_format($p->getSalaireteorique(), 3, '.', ' ') . '</td>';
            endif;
            $fiche.= "</tr>"
                    . "</tbody></table></td></tr></table>";
            if ($p->getMois() <= 12):
                $height = 560;
            else:
                $height = 630;
            endif;

            $fiche.= '<table class="tableligne" style="border: 1px solid black">
            <tbody>
                   <tr>
                     <td style=" width: 45%; font-size: 10px;font-weight:bold;">Elément de salaire</td>
                     <td style=" width: 15%; font-size: 10px;font-weight:bold;">Nbr J/H</td>
                     <td style=" width: 20%; font-size: 10px;font-weight:bold;">Gains</td>
                     <td style=" width: 20%; font-size: 10px;font-weight:bold;border-bottom:1.0pt solid none">Retenues</td>
                     </tr>';
            if ($p->getMois() <= 12):
                $fiche.= ' <tr style="border-bottom:1.9pt solid none;">
                     <td style="text-align: left;font-size: 10px; border-bottom:1.9pt solid none"> JOURS TRAVAILLES</td>'
                        . '<td  style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none"> ' . $p->getNbrjtravaille() . ' J' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none"> ' . number_format(( ($p->getSalairedebase() / ($p->getNbrjtravaille() + $p->getNbrjf())) * $p->getNbrjtravaille()), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom:1.9pt solid none"></td>'
                        . '</tr>
                     <tr style="border-bottom:2pt solid none;">
                     <td style="text-align: left ;border-bottom:1.9pt solid none;"> JOURS FERIES</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none;"> ' . $p->getNbrjf() . ' J' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom:1.9pt solid none;"> ' . number_format(( ($p->getSalairedebase() / ($p->getNbrjtravaille() + $p->getNbrjf())) * $p->getNbrjf()), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom:1.9pt solid none"></td>'
                        . '</tr>';

                $fiche.= '<tr  style="border-bottom: 0pt solid black;">
                     <td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE SANS PRIMES </td>'
                        . '<td style="border-bottom:2px solid none"> ' . '' . '</td>'
                        . '<td style="font-weight:bold;text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalairedebase(), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '</tr>';

                for ($i = 0; $i < sizeof($primesCI); $i++):
                    $fiche.= '<tr style="margin-bottom: 0px">
                      <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> ' . $primesCI[$i]['libelle'] . ' </td>'
                            . '<td style="border-bottom: 1.9px solid none"></td>'
                            . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($primesCI[$i]['montant'], 3, '.', ' ') . '</td>'
                            . '<td style="border-bottom: 1.9px solid none"></td>'
                            . '</tr>';
                    $height = $height - 25;
                endfor;
            endif;

            $fiche.= '<tr style="margin-bottom: 0px">';
            if ($p->getMois() <= 12):
                $fiche.= '<td style="font-weight:bold;text-align: left;font-size: 10px;border-bottom: 1.9px solid none">SALAIRE  BRUT </td>';
            else:
                $fiche.= '<td style="font-weight:bold;text-align: left;font-size: 10px;border-bottom: 1.9px solid none">BRUT Prime</td>';
            endif;
            $fiche.= '<td style="border-bottom: 1.9px solid none"> </td>';
            if ($p->getMois() <= 12):
                $fiche.= '<td style="font-weight:bold; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalairebrut(), 3, '.', ' ') . '</td>';
            else:
                $fiche.= '<td style="font-weight:bold; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getBrutprime(), 3, '.', ' ') . '</td>';
            endif;
            $fiche.= '<td style="border-bottom: 1.9px solid none"></td>'
                    . '</tr>';

            if ($p->getLignecodesociale()->getTaux() != '' && $p->getLignecodesociale()->getTaux() != 0.000):
                $fiche.= '<tr>';

                $fiche.='<td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none">'
                        . $p->getCodesociale()->getLibelle()
                        . '</td>';

                $fiche.='<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getLignecodesociale()->getTaux(), 2, '.', ' ') . " %" . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getMontantsocialemensuel(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= '<tr>
                 <td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE IMPOSABLE</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '' . '</td>'
                    . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($p->getSalaireimposable(), 3, '.', ' ') . '</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                    . '</tr> ';

            if ($p->getMontantirpp() != '' && $p->getMontantirpp() != 0):
                $fiche.= '<tr>
                  <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> IRPP</td>'
                        . '<td style="text-align: right;border-bottom: 1.9px solid none"> </td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getMontantirpp(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            if ($p->getContribitionsociale() != '' && $p->getContribitionsociale() != 0):
                $fiche.= '<tr>
                  <td style="text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> CTR.SOCIALE ET DE SOLIDARITE(1%)  </td>'
                        . '<td style="text-align: right;border-bottom: 1.9px solid none"> </td>'
                        . '<td style="border-bottom: 1.9px solid none"> ' . '</td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none">' . number_format($p->getContribitionsociale(), 3, '.', ' ') . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= '<tr>
                 <td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none"> SALAIRE NET D\'IMPOTS</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '' . '</td>'
                    . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' .
                    number_format(($p->getSalaireimposable() - $p->getMontantirpp() - $p->getContribitionsociale()), 3, '.', ' ')
                    . '</td>'
                    . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                    . '</tr>';

            for ($i = 0; $i < sizeof($primesNCNI); $i++):
                $fiche.= '<tr>
                      <td style="text-align: left;font-size: 10px; border-bottom: 1.9px solid none"> ' . $primesNCNI[$i]['libelle'] . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '<td style="text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' . number_format($primesNCNI[$i]['montant'], 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '</tr>';
                $height = $height - 25;
            endfor;

//        $fiche.= ' <tr><td style="font-weight:bold ; text-align: left"> SALAIRE NET   </td>'
//                . '<td>' . '' . '</td>'
//                . '<td style="font-weight:bold ; text-align: right"> ' .
//                $p->getSalairenet()
//                . '</td>'
//                . '<td>' . '</td>'
//                . '</tr> ';
//        $height = $height - 25;

            if ($p->getTotalretenue() != '' && number_format($p->getTotalretenue(), 3, '.', ' ') != 0.000):
                $fiche.= ' <tr><td style="font-weight:bold ; text-align: left;font-size: 10px;border-bottom: 1.9px solid none">  TOTAL RETENUE   </td>'
                        . '<td style="border-bottom: 1.9px solid none"></td>'
                        . '<td style="font-weight:bold ; text-align: right;font-size: 10px;border-bottom: 1.9px solid none"> ' .
                        number_format($p->getTotalretenue(), 3, '.', ' ') . '</td>'
                        . '<td style="border-bottom: 1.9px solid none">' . '</td>'
                        . '</tr>';
                $height = $height - 25;
            endif;

            $fiche.= "<tr>"
                    . '<td style="border-bottom: 0px solid none; height: ' . $height . 'px;">&nbsp;</td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . '<td style="border-bottom: 0px solid none;"></td>'
                    . "</tr>"
                    . "</tbody></table>";

            $fiche.='<table class="tableligne">'
                    . '<tr><td style="width: 60%"><table>'
                    . '<tr><td style="text-align: center;font-size: 10px;">'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
                    . 'Signature Employeur</td></tr><br><tr><td style="text-align: left ; font-size: 10px;">'
                    . 'Sit. Prof : ' . $p->getContrat()->getTypecontrat()
                    . '</td></tr><tr><td style="text-align: left ; font-size: 10px;">'
                    . 'Signature Employé :</td></tr><tr><td><br><br></td><br><br></tr></table></td>'
                    . '<td style="font-weight:bold; text-align: center;width: 40%;font-size: 10px;height: 116px;">'
                    . 'Net à Payer : ' . $p->getNetapayyer()
                    . '</td></tr></table>&nbsp;<br>';

        endforeach;

        return $fiche;
    }

    public function ReadHtmllisteFichesPaieAllFilterJournalPaie($mois, $annee, $id_codesociale, $id_codesocialeF) {
        $ligne_societe = Doctrine_Core::getTable('lignesociete')->findAll();
        $trouve = 0;
        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');
        if ($mois != '') {
            foreach ($ligne_societe as $lign) :
                if ($mois == $lign->getMoiscalendiarle() && $mois_journalepaie != 12) {
                    $trouve = 1;
                    $ligne = Doctrine_Core::getTable('lignesociete')->findOneByMoiscalendiarle($mois);
                    if ($ligne)
                        $q = $q->andWhere('(p.mois= ' . $ligne->getCodemois() . ' OR p.mois=' . $mois . ')');
                }
                if ($mois != $lign->getMoiscalendiarle()) {
                    $q = $q->andWhere('p.mois=' . $mois);
                } else {
                    $trouve = 1;
                }
            endforeach;
        }
        if ($annee != '')
            $q = $q->andWhere('p.annee= ?', $annee);
//        if ($id_codesociale != '') {
//            $q = $q->andWhere('p.id_lignecodesociale= ' . $id_codesociale)
////                        ->andWhere('lignecodesociale.id_codesoc=codesociale.id')
//            ;
//        }
        if ($id_codesociale != '' && $id_codesocialeF == '')
            $q = $q->andWhere('p.id_lignecodesociale= ?', $id_codesociale);
        if ($id_codesociale == '' && $id_codesocialeF != '')
            $q = $q->andWhere('p.id_lignecodesociale= ?', $id_codesocialeF);


        if ($id_codesociale != '' && $id_codesocialeF != '') {
            $q = $q->andWhere('p.id_lignecodesociale >= ?', $id_codesociale);
            $q = $q->andWhere('p.id_lignecodesociale < ?', $id_codesocialeF);
        }

        $q = $q->orderBy('p.mois');
        $listes = $q->execute();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $query = " select id as id  "
                . " from exercice"
                . " where exercice.libelle = " . "'" . $annee . "'";
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $excercice = $conn->fetchAssoc($query);
        $id_exercice = $excercice[0]['id'];
        $dossier = Doctrine_Core::getTable('dossiercomptable')->findOneByIdExercice(1);
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");

        $html = '<table>
                    <tbody> 
                        <tr><td style="width: 70%;text-align: left;font-weight:bold; font-size: 12px"><I>' . $societe->getRs() . " </I><br>" .
                $societe->getAdresse() . '<br></td><td style="width: 30%;text-align:center; font-weight:bold; font-size: 10px"><br>';
        $html.= "</td></tr></tbody></table>";
        $html.=
                '<h3>Journal de Paie Avec Pointage<br>';
        if ($mois <= 12):
            $html.=$array[$mois] . " ";
        else:
            $lg = Doctrine_Core::getTable('lignesociete')->findOneByCodemois($mois);
            $html.=$lg->getLibelle();
        endif;
        $html.=$annee . '</h3>&nbsp;<br> ';
        $html.='<table border="1" cellpadding="3"><thead>
                    <tr style="background-color:#EDEDED;text-align:center;font-weight:bold;font-size :9px;">         
                        <th style="width: 4%;"><I>Mat.</I></th>
                        <th style="width: 17%;"><I>Agents</I></th>
                        <th style="width: 4%;"><I>Png</I></th>
                        <th style="width: 3%;"><I>Fér</I></th>
                        <th style="width: 4%;"><I>Cng</I></th>
                        <th style="width: 9%;"><I>Salaire Brut</I></th>
                        <th style="width: 6%;"><I>C.Soc.</I></th>
                        <th style="width: 8%;"><I>Mnt.Soc.</I></th>
                        <th style="width: 8%;"><I>Salaire Impo.</I></th>
                        <th style="width: 7%;"><I>I.R.P.P</I></th>
                        <th style="width: 6%;"><I>CSS1%</I></th>
                        <th style="width: 8%;"><I>Total Retenue</I></th>
                        <th style="width: 8%;"><I>Net à Payer</I></th>
                        <th style="width: 8%;"><I>Signature </I></th>
                    </tr></thead>
                    <tbody>';

        if ($listes->count() != 0):
            $resultat_brut = 0;
            $resultat_cnss = 0;
            $resultat_simposable = 0;
            $resultat_irpp = 0;
            $resultat_css = 0;
            $resultat_retenue = 0;
            $resultat_netapayer = 0;
            $resultat_brut_3 = 0;
            $resultat_cnss_3 = 0;
            $resultat_simposable_3 = 0;
            $resultat_irpp_3 = 0;
            $resultat_css_3 = 0;
            $resultat_retenue_3 = 0;
            $resultat_netapayer_3 = 0;
            foreach ($listes as $p):
                $html.='<tr>
                            <td style="width: 4%;text-align:center;">' . $p->getAgents()->getIdrh() . '</td>
                            <td style="width: 17%;text-align:left;heigth: 25px">' . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . '</td>
                            <td style="width: 4%;text-align:center;">' . $p->getNbrjtravaille() . 'J </td>
                            <td style="width: 3%;text-align:center;">' . $p->getNbrjf() . 'J</td>
                            <td style="width: 4%;text-align:center;">' . $p->getNbrjconge() . 'J</td>
                            <td style="width: 9%;text-align:right;">' . $p->getSalairebrut() . '</td>
                            <td style="width: 6%;text-align:center;">' . $p->getCodesociale()->getLibelle() . '</td>
                            <td style="width: 8%;text-align:right;">' . $p->getMontantsocialemensuel() . '</td>
                            <td style="width: 8%;text-align:right;">' . $p->getSalaireimposable() . '</td>
                            <td style="width: 7%;text-align:right;">' . $p->getMontantirpp() . '</td>
                            <td style="width: 6%;text-align:right;">' . $p->getContribitionsociale() . '</td>
                            <td style="width: 8%;text-align:right;">' . $p->getTotalretenue() . '</td>
                            <td style="width: 8%;text-align:right;">' . $p->getNetapayyer() . '</td>
                            <td style="width: 8%;"></td>
                        </tr>';
                $resultat_brut = $resultat_brut + $p->getSalairebrut();
                $resultat_cnss = $resultat_cnss + $p->getMontantsocialemensuel();
                $resultat_simposable = $resultat_simposable + $p->getSalaireimposable();
                $resultat_irpp = $resultat_irpp + $p->getMontantirpp();
                $resultat_css = $resultat_css + $p->getContribitionsociale();
                $resultat_retenue = $resultat_retenue + $p->getTotalretenue();
                $resultat_netapayer = $resultat_netapayer + $p->getNetapayyer();
            endforeach;
            if ($mois != ""):
                $html.='<tr style="background-color:#ddd;">
                        <td style="width: 4%;"></td>
                        <td style="width: 17%;"><h4 style="float:right;width: 40%;font-weight:bold;">TOTAL:' . $array[$mois] . '-';
                if ($annee):
                    $html.= $annee;
                else:
                    $html.=$p->getAnnee();
                endif;
                $html.= '</h4></td>
                        <td style="width: 4%;"></td>
                        <td style="width: 3%;"></td>
                        <td style="width: 4%;"></td>
                        <td style="text-align:right; width: 9%;">' . number_format($resultat_brut, 3, '.', ' ') . '</td>
                        <td style="width: 6%;"></td>
                        <td style="text-align:right;width: 8%;">' . number_format($resultat_cnss, 3, '.', ' ') . '</td>
                        <td style="text-align:right;width: 8%;">' . number_format($resultat_simposable, 3, '.', ' ') . '</td>
                        <td style="text-align:right;width: 7%;">' . number_format($resultat_irpp, 3, '.', ' ') . '</td>
                        <td style="text-align:right;width: 6%;">' . number_format($resultat_css, 3, '.', ' ') . '</td>
                        <td style="text-align:right;width: 8%;">' . number_format($resultat_retenue, 3, '.', ' ') . '</td>
                        <td style="text-align:right;width: 8%;">' . number_format($resultat_netapayer, 3, '.', ' ') . '</td>
                        <td style="width: 8%;"></td>
                    </tr>';
            endif;
            foreach ($ligne_societe as $lign) :
                if ($mois == $lign->getMoiscalendiarle()):

                    $q_3 = Doctrine_Query::create()
                            ->select('p.*')
                            ->from('paie p,agents a')
                            ->where('p.id_agents=a.id');
                    $q_3 = $q_3->andWhere('p.mois= ' . $lign->getCodemois());
                    if ($annee != '')
                        $q_3 = $q_3->andWhere('p.annee= ?', $annee);
                    if ($id_codesociale != '')
                        $q_3 = $q_3->andWhere('p.id_lignecodesociale= ?', $id_codesociale);
                    $listes_3 = $q_3->execute();

                    $html.='<tr style="background-color:#FDF6D5;">'
                            . '<td></td>'
                            . '<td><h4 style="float:right;width: 40%;font-weight:bold;font-size :11px">';
                    $ligne = Doctrine_Core::getTable('lignesociete')->findOneByMoiscalendiarle($mois);
                    if ($ligne)
                        $html.= $ligne->getLibelle() . " ";
                    $html.='</h4></td>'
                            . '<td></td><td></td>'
                            . '<td></td> <td></td>'
                            . '<td></td>'
                            . '<td></td><td></td>'
                            . '<td></td><td></td><td></td>'
                            . '<td></td><td></td>'
                            . '</tr>';

                    if ($listes_3->count() != 0):
                        foreach ($listes_3 as $p):

                            $html.='<tr>
                                <td style="text-align:center;">' . $p->getAgents()->getIdrh() . '</td>';
                            $html.='<td style="text-align:left;">' . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . $p->getMois() . '</td>';
                            $html.=' <td style="text-align:center;">' . $p->getNbrjtravaille() . '</td>';
                            $html.=' <td style="text-align:center;">' . $p->getNbrjf() . '</td>';
                            $html.=' <td style="text-align:center;">' . $p->getNbrjconge() . '</td>';
                            $html.='<td style="text-align:right;">' . $p->getBrutprime() . '</td>'
                                    . '<td style="text-align:center; "></td>'
                                    . '<td style="text-align:right;">' . $p->getMontantsocialemensuel() . '</td>' .
                                    '<td style="text-align:right;">' . $p->getSalaireimposable() . '</td>' .
                                    '<td style="text-align:right;">' . $p->getMontantirpp() . '</td>' .
                                    '<td style="text-align:right;">' . $p->getContribitionsociale() . '</td>' .
                                    '<td style="text-align:right;">' . $p->getTotalretenue() . '</td>
                                    <td style="text-align:right;">' . $p->getNetapayyer() . '</td>
                                    <td></td> 
                                </tr>';

                            $resultat_brut_3 = $resultat_brut_3 + $p->getBrutprime();
                            $resultat_cnss_3 = $resultat_cnss_3 + $p->getMontantsocialemensuel();
                            $resultat_simposable_3 = $resultat_simposable_3 + $p->getSalaireimposable();
                            $resultat_irpp_3 = $resultat_irpp_3 + $p->getMontantirpp();
                            $resultat_css_3 = $resultat_css_3 + $p->getContribitionsociale();
                            $resultat_retenue_3 = $resultat_retenue_3 + $p->getTotalretenue();
                            $resultat_netapayer_3 = $resultat_netapayer_3 + $p->getNetapayyer();
                        endforeach;
                    else:
                        $html.='<tr>
                                    <td colspan="14" style="text-align:center;">Pas de ligne de paie pour ce prime</td> 
                                </tr>';
                    endif;
                    if ($mois != ''):
                        $html.='<tr style="background-color: #FAF0E6;"><td> </td>'
                                . '<td><h4 style="float:right;width: 40%;font-weight:bold;font-size: 11px">TOTAL ';
                        $ligne = Doctrine_Core::getTable('lignesociete')->findOneByMoiscalendiarle($mois);
                        if ($ligne)
                            $html.= $ligne->getLibelle() . " ";
                        $html.='</h4></td>'
                                . '<td></td>'
                                . '<td></td>'
                                . '<td></td>'
                                . '<td style="text-align:right;">' . number_format($resultat_brut_3, 3, '.', ' ') . '</td>'
                                . '<td></td>'
                                . '<td style="text-align:right;">' . number_format($resultat_cnss_3, 3, '.', ' ') . '</td>'
                                . '<td style="text-align:right;">' . number_format($resultat_simposable_3, 3, '.', ' ') . '</td>'
                                . '<td style="text-align:right;">' . number_format($resultat_irpp_3, 3, '.', ' ') . '</td>'
                                . '<td style="text-align:right;">' . number_format($resultat_css_3, 3, '.', ' ') . '</td>'
                                . '<td style="text-align:right;">' . number_format($resultat_retenue_3, 3, '.', ' ') . '</td>'
                                . '<td style="text-align:right;">' . number_format($resultat_netapayer_3, 3, '.', ' ') . '</td>'
                                . '<td></td>'
                                . '</tr>';
                    endif;
                endif;

            endforeach;

            $html.='<tr><td style="background-color:#ddd;"></td>
                            <td style="background-color:#ddd;"><h4 style="float:right;width: 40%;font-weight:bold;">TOTAL GENERAL ' . '</h4></td>
                            <td style="background-color:#ddd;"></td>
                            <td style="background-color:#ddd;"></td>
                            <td style="background-color:#ddd;"></td>
                            <td style="background-color:#ddd;text-align:right; ">' . number_format($resultat_brut + $resultat_brut_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;"></td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_cnss + $resultat_cnss_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_simposable + $resultat_simposable_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_irpp + $resultat_irpp_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_css + $resultat_css_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_retenue + $resultat_retenue_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;text-align:right;">' . number_format($resultat_netapayer + $resultat_netapayer_3, 3, '.', ' ') . '</td>
                            <td style="background-color:#ddd;"></td>
                            </tr>';

            $html.='</tbody>';
            $html.='</table><br><br>'
                    . '<table><tbody><tr>'
                    . '<td style="font-weight:bold;width:23%;">Montant Global : ' . number_format($resultat_brut + $resultat_brut_5, 3, '.', ' ') . '</td>';
            if ($dossier->getTfp() == TRUE):
                $tfp = (($resultat_brut + $resultat_brut_5 ) * $dossier->getTauxtfp()) / 100;
                $html.='<td style="font-weight:bold;width:23%;">[TFP '
                        . number_format($dossier->getTauxtfp(), 2, '.', ' ') . '% = ' . number_format($tfp, 3, '.', ' ')
                        . ']</td>';
            endif;
            if ($dossier->getFoprolos() == TRUE):
                $foprolos = (($resultat_brut + $resultat_brut_3 ) * $dossier->getTauxfoprolos()) / 100;
                $html.='<td style="font-weight:bold;width:54%;">[FOPROLOS '
                        . number_format($dossier->getTauxfoprolos(), 2, '.', ' ') . '% = ' . number_format($foprolos, 3, '.', ' ')
                        . ']</td>';
            endif;
            $html.= '</tr>';
        else:
            $html.='<tr>
                        <td style="width:100%;height:20px;text-align:center;"><b>Pas des Fiches Journal de Paie</b></td>
                    </tr>';
        endif;
        $html.='</tbody></table>';
        return $html;
    }

//declaration cnss
    public function ReadHtmllisteFichesPaieAllFilterDeclaration($trimestre, $annee_declaration, $id_codesociale) {
        if ($id_codesociale)
            $lignecodesoc = LignecodesocialeTable::getInstance()->findOneById($id_codesociale);
        $ligne_societe_3 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('3');
        if ($ligne_societe_3) {
            $code_mois_attache_3 = '';
            foreach ($ligne_societe_3 as $ligne):
                $code_mois_attache_3 = $code_mois_attache_3 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_6 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('6');
        if ($ligne_societe_6) {
            $code_mois_attache_6 = '';
            foreach ($ligne_societe_6 as $ligne):
                $code_mois_attache_6 = $code_mois_attache_6 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_9 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('9');
        if ($ligne_societe_9) {
            $code_mois_attache_9 = '';
            foreach ($ligne_societe_9 as $ligne):
                $code_mois_attache_9 = $code_mois_attache_9 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_12 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('12');
        $code_mois_attache_12 = '';
        foreach ($ligne_societe_12 as $ligne):
            $code_mois_attache_12 = $code_mois_attache_12 . ' OR p.mois = ' . $ligne->getCodemois();
        endforeach;
        $min_mois = 0;
        $max_mois = 0;
        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');
        if ($id_codesociale != '')
            $q = $q->andWhere('p.id_lignecodesociale= ?', $id_codesociale);
        if ($trimestre == '1' && sizeof($ligne_societe_3) > 0):
            $q = $q->andWhere('(p.mois=1 OR p.mois=2 OR p.mois=3)');
            $min_mois = 0;
            $max_mois = 3;
        elseif ($trimestre == '1' && sizeof($ligne_societe_3) == 0):
            $q = $q->andWhere('(p.mois=1 OR p.mois=2 OR p.mois=3 ' . $code_mois_attache_3 . ')');
            $min_mois = 0;
            $max_mois = 3;
        endif;
        if ($trimestre == '2' && sizeof($ligne_societe_6) > 0):
            $q = $q->andWhere('(p.mois=4 OR p.mois=5 OR p.mois=6 ' . $code_mois_attache_6 . ')');
            $min_mois = 3;
            $max_mois = 6;
        elseif ($trimestre == '2' && sizeof($ligne_societe_6) == 0):
            $q = $q->andWhere('(p.mois=4 OR p.mois=5 OR p.mois=6)');
            $min_mois = 3;
            $max_mois = 6;
        endif;
        if ($trimestre == '3' && sizeof($ligne_societe_9) > 0):
            $q = $q->andWhere('(p.mois=7 OR p.mois=8 OR p.mois=9 ' . $code_mois_attache_9 . ')');
            $min_mois = 6;
            $max_mois = 9;
        elseif ($trimestre == '3' && sizeof($ligne_societe_9) == 0):
            $q = $q->andWhere('(p.mois=7 OR p.mois=8 OR p.mois=9 )');
            $min_mois = 6;
            $max_mois = 9;
        endif;
        if ($trimestre == '4'):
            $q = $q->andWhere('(p.mois=10 OR p.mois=11 OR p.mois=12 ' . $code_mois_attache_12 . ')');
            $min_mois = 9;
            $max_mois = 12;
        endif;
        $q->orderBy('p.id_agents, p.mois');
        $listes = $q->execute();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $query = " select id as id  "
                . " from exercice"
                . " where exercice.libelle = " . "'" . $annee_declaration . "'";
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $excercice = $conn->fetchAssoc($query);

        $html = '';
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        $html.='<table><tbody><tr>';
        if ($lignecodesoc->getIdCodesoc() == 1):
            $html.= '<td>Miistère DES AFFAIRES SOCIALES<br>CAISSE NATIONALE<BR>DE SECURITE SOCIALE'
                    . '</td><td style="text-align: right"></td>';
        elseif ($lignecodesoc->getIdCodesoc() == 2):
            $html.= '<td>CAISSE NATIONALE <br>DE RETRAITE ET <br>DE PREVOYANCE SOCIALE</td><td style="text-align: right"></td>';
        endif;
        $html.= '</tr><br><br></tbody></table>'
                . '<table><tbody><tr>'
                . '<td align="center" style="text-align: center;font-size: 16px;font-weight:bold;"><I>'
                . 'Déclaration Trimestrielle de';
        if ($lignecodesoc->getIdCodesoc() == 1):
            $html.=' C.N.S.S';
        elseif ($lignecodesoc->getIdCodesoc() == 2):
            $html.=' C.N.R.P.S';
        endif;
        $html.='</I></td></tr>'
                . '</tbody></table>&nbsp;<br>';
        $html.= '<table ><tr><td><table>' .
                "<tbody>";
        $html.= '<tr>'
                . '<td style="width: 70%;text-align: left; font-size: 12px">N°';
        if ($societe->getTypecotisation() == 1):
            $html.= 'CNSS : ';

        elseif ($societe->getTypecotisation() == 2):
            $html.= 'CNRPS : ';
        endif;
        $html.= $societe->getIdunique();
        $html.='<br>Matricule Fiscal :' . $societe->getMatfiscal()
                . '<br>Période : Trimestre N°' . $trimestre . '/' . $annee_declaration;
        $html.= ' </td><td>' . $societe->getRs() . " <br>" . $societe->getAdresse() . '</td> ';
        $html.="</tr></tbody></table></td></tr></table><br><br>";

        $html.='<table class="tableligne" border="1" cellpadding="3"><tbody>
                <tr style="background-color:#DDD;">
                    <th style="width: 5%; height: 30px;">N°</th>';
        if ($societe->getTypecotisation() == 1):
            $html.='<th style="width: 10%">N° CNSS</th>';
        elseif ($societe->getTypecotisation() == 2):
            $html.='<th style="width: 10%">N° CNRPS</th>';
        endif;
        $html.='<th style="width: 17%">Agents</th>
            <th style="width: 9%">Matricule</th>
            <th style="width: 17%">Qualification</th>
            <th style="width: 10%; text-align: center">1° Mois</th>
            <th style="width: 10%;text-align: center">2°Mois</th>
            <th style="width: 10%;text-align: center">3° Mois</th>
            <th style="width: 11%; text-align: center">Total</th>
            </tr>';
        $resultat_Tot = 0;
        $index = 0;
        $id_agents = '';
        $finaletat = array();
        $somme_mois = array();
        $m = $min_mois + 1;
        while ($m <= $max_mois):
            $somme_mois[$m] = 0;
            $m++;
        endwhile;

        if ($listes->count() != 0):
            foreach ($listes as $p):

                if ($id_agents != $p->getIdAgents()) {
                    if ($id_agents != '')
                        $index++;

                    $etat = array();
                    $etat['id_agents'] = $p->getIdAgents();
                    $etat['mois'] = $p->getMois();
                    $etat['idunique'] = $p->getContrat()->getIdunique();
                    $etat['nomprenom'] = $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom();
                    $etat['idrh'] = $p->getAgents()->getIdrh();
                    $etat['grade'] = $p->getContrat()->getSalairedebase()->getGrade()->getLibelle();
                    $m = $min_mois + 1;
                    while ($m <= $max_mois):
                        $etat[$m] = 0;
                        $m++;
                    endwhile;

                    if ($p->getMois() <= $max_mois) {
                        $etat[$p->getMois()] = $p->getSalairebrut();
                    } else {
                        $etat[$max_mois] = $etat[$max_mois] + $p->getBrutprime();
                    }

                    array_push($finaletat, $etat);

                    $id_agents = $p->getIdAgents();
                } else {
                    if ($p->getMois() <= $max_mois)
                        $finaletat[$index][$p->getMois()] = $p->getSalairebrut();
                    else
                        $finaletat[$index][$max_mois] = $finaletat[$index][$max_mois] + $p->getBrutprime();
                }

            endforeach;
            for ($i = 1; $i <= sizeof($finaletat); $i++):
                $total_agent = 0;
                $html.='<tr>
                            <td style="text-align:center; height: 25px;">' . $i . '</td>
                            <td style="text-align:center;">' . $finaletat[$i - 1]['idunique'] . '</td>
                            <td style="text-align:left;">' . $finaletat[$i - 1]['nomprenom'] . '</td>
                            <td style="text-align:center;">' . $finaletat[$i - 1]['idrh'] . '</td>
                            <td style="text-align:center;">' . $finaletat[$i - 1]['grade'] . '</td>';
                $m = $min_mois + 1;
                while ($m <= $max_mois):
                    $total_agent = $total_agent + $finaletat[$i - 1][$m];
                    $resultat_Tot = $resultat_Tot + $finaletat[$i - 1][$m];
                    $somme_mois[$m] = $somme_mois[$m] + $finaletat[$i - 1][$m];
                    $html.= '<td style="text-align:right;">' . number_format($finaletat[$i - 1][$m], 3, '.', ' ') . '</td>';
                    $m++;
                endwhile;

                $html.= '<td style="text-align:right;">' . number_format($total_agent, 3, '.', ' ') . '</td>';
                $html.='</tr>';
            endfor;

            $html.='<tr style="background-color:#EDEDED;font-weight:bold;">
                        <td colspan="4"></td>
                        <td style="text-align:center; height: 30px;">TOTAL GENERAL</td>';
            $m = $min_mois + 1;
            while ($m <= $max_mois):
                $html.='<td style="text-align:right; ">' . number_format($somme_mois[$m], 3, '.', ' ') . '</td>';
                $m++;
            endwhile;
            $html.='<td style="text-align:right;">' . number_format($resultat_Tot, 3, '.', ' ') . '</td>
            </tr>';
            $html.= '</tbody></table><br><br><br>';
            $html.='<table><tbody><tr>
            <td style="width:60%;height:20px;text-align:left;">
            Certifie sincère et conforme à nos documents comptables et arrêté à la somme de : <br>
            ' . strtoupper(chiffreToLettre::cvnbst($resultat_Tot)) . '</td>
            <td style="width: 40%; text-align:center;"> Fait à SFAX Le ' . date('d/m/Y') .
                    '<br>Cachet et Signature de l\'entreprise </td>
            </tr></tbody></table>';
        else:
            $html.='<table><tbody><tr>
            <td style="width:100%;height:20px;text-align:center;"><b>Pas des Fiches de Déclaration Trimestrielle</b></td>
            </tr></tbody></table>';
        endif;


        return $html;
    }

//etat recap w

    public function ReadHtmllisteFichesPaieAllFilterRecap($trimestre, $annee_declaration, $id_codesociale, $annee_session) {
        if ($id_codesociale)
            $lignecodesoc = LignecodesocialeTable::getInstance()->findOneById($id_codesociale);
        $ligne_societe_3 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('3');
        if ($ligne_societe_3) {
            $code_mois_attache_3 = '';
            foreach ($ligne_societe_3 as $ligne):
                $code_mois_attache_3 = $code_mois_attache_3 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_6 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('6');
        if ($ligne_societe_6) {
            $code_mois_attache_6 = '';
            foreach ($ligne_societe_6 as $ligne):
                $code_mois_attache_6 = $code_mois_attache_6 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_9 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('9');
        if ($ligne_societe_9) {
            $code_mois_attache_9 = '';
            foreach ($ligne_societe_9 as $ligne):
                $code_mois_attache_9 = $code_mois_attache_9 . ' OR p.mois = ' . $ligne->getCodemois();
            endforeach;
        }
        $ligne_societe_12 = Doctrine_Core::getTable('lignesociete')->findByMoiscalendiarle('12');
        $code_mois_attache_12 = '';
        foreach ($ligne_societe_12 as $ligne):
            $code_mois_attache_12 = $code_mois_attache_12 . ' OR p.mois = ' . $ligne->getCodemois();
        endforeach;
        $min_mois = 0;
        $max_mois = 0;
        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');
        if ($id_codesociale != '')
            $q = $q->andWhere('p.id_lignecodesociale= ?', $id_codesociale);
        if ($trimestre == '1' && sizeof($ligne_societe_3) > 0):
            $q = $q->andWhere('(p.mois=1 OR p.mois=2 OR p.mois=3)');
            $min_mois = 0;
            $max_mois = 3;
        elseif ($trimestre == '1' && sizeof($ligne_societe_3) == 0):
            $q = $q->andWhere('(p.mois=1 OR p.mois=2 OR p.mois=3 ' . $code_mois_attache_3 . ')');
            $min_mois = 0;
            $max_mois = 3;
        endif;
        if ($trimestre == '2' && sizeof($ligne_societe_6) > 0):
            $q = $q->andWhere('(p.mois=4 OR p.mois=5 OR p.mois=6 ' . $code_mois_attache_6 . ')');
            $min_mois = 3;
            $max_mois = 6;
        elseif ($trimestre == '2' && sizeof($ligne_societe_6) == 0):
            $q = $q->andWhere('(p.mois=4 OR p.mois=5 OR p.mois=6)');
            $min_mois = 3;
            $max_mois = 6;
        endif;
        if ($trimestre == '3' && sizeof($ligne_societe_9) > 0):
            $q = $q->andWhere('(p.mois=7 OR p.mois=8 OR p.mois=9 ' . $code_mois_attache_9 . ')');
            $min_mois = 6;
            $max_mois = 9;
        elseif ($trimestre == '3' && sizeof($ligne_societe_9) == 0):
            $q = $q->andWhere('(p.mois=7 OR p.mois=8 OR p.mois=9 )');
            $min_mois = 6;
            $max_mois = 9;
        endif;
        if ($trimestre == '4'):
            $q = $q->andWhere('(p.mois=10 OR p.mois=11 OR p.mois=12 ' . $code_mois_attache_12 . ')');
            $min_mois = 9;
            $max_mois = 12;
        endif;
        $q->orderBy('p.id_agents, p.mois');
        $listes = $q->execute();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $query_exercie = " select id as id  "
                . " from exercice"
                . " where exercice.libelle = " . "'" . $annee_session . "'";
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $excercice = $conn->fetchAssoc($query_exercie);
        $id_exercice = $excercice[0]['id'];
        $dossier = Doctrine_Core::getTable('dossiercomptable')->findOneByIdExercice($id_exercice);
        $html = '';
        $resultat_Tot = 0;
        $index = 0;
        $id_agents = '';
        $finaletat = array();
        $somme_mois = array();
        $m = $min_mois + 1;
        while ($m <= $max_mois):
            $somme_mois[$m] = 0;
            $m++;
        endwhile;
        if ($listes->count() != 0):
            foreach ($listes as $p):

                if ($id_agents != $p->getIdAgents()) {
                    if ($id_agents != '')
                        $index++;

                    $etat = array();
                    $etat['id_agents'] = $p->getIdAgents();
                    $etat['mois'] = $p->getMois();
                    $etat['idunique'] = $p->getContrat()->getIdunique();
                    $etat['nomprenom'] = $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom();
                    $etat['idrh'] = $p->getAgents()->getIdrh();
                    $etat['grade'] = $p->getContrat()->getSalairedebase()->getGrade()->getLibelle();
                    $m = $min_mois + 1;
                    while ($m <= $max_mois):
                        $etat[$m] = 0;
                        $m++;
                    endwhile;

                    if ($p->getMois() <= $max_mois) {
                        $etat[$p->getMois()] = $p->getSalairebrut();
                    } else {
                        $etat[$max_mois] = $etat[$max_mois] + $p->getBrutprime();
                    }

                    array_push($finaletat, $etat);

                    $id_agents = $p->getIdAgents();
                } else {
                    if ($p->getMois() <= $max_mois)
                        $finaletat[$index][$p->getMois()] = $p->getSalairebrut();
                    else
                        $finaletat[$index][$max_mois] = $finaletat[$index][$max_mois] + $p->getBrutprime();
                }
            endforeach;
            for ($i = 1; $i <= sizeof($finaletat); $i++):
                $total_agent = 0;
                $m = $min_mois + 1;
                while ($m <= $max_mois):
                    $total_agent = $total_agent + $finaletat[$i - 1][$m];
                    $resultat_Tot = $resultat_Tot + $finaletat[$i - 1][$m];
                    $somme_mois[$m] = $somme_mois[$m] + $finaletat[$i - 1][$m];
                    $m++;
                endwhile;
            endfor;
            $m = $min_mois + 1;
            while ($m <= $max_mois):
                $m++;
            endwhile;
        endif;
        //calcul du permanet et occationnel et totoal qui ont un contrat 
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query_permant = " select COALESCE(count(DISTINCT contrat.id_agents),0) as nbrgantspermanets"
                . " from contrat"
                . " where contrat.id_typecontrat= 1"
        ;
        $permanet = $conn->fetchAssoc($query_permant);

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query_total = " select COALESCE(count(DISTINCT contrat.id_agents),0) as nbrgants"
                . " from contrat"

        ;
        $total_agents = $conn->fetchAssoc($query_total);
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query_occasionelle = " select COALESCE(count(DISTINCT contrat.id_agents),0) as nbrgantsoccasionnelle"
                . " from contrat"
                . " where contrat.id_typecontrat<> 1"
        ;
        $occasionnel = $conn->fetchAssoc($query_occasionelle);
        //----------------////////////
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        if ($lignecodesoc->getIdCodesoc() == 1):
            $html.= '<h3>ETAT RECAPITULATIF DES SALAIRES ET APPOINTEMENTS</h3>'
                    . '&nbsp;<br>';
            $html.='<table class="tableligne" border="1" cellpadding="3"> '
                    . '<tbody>'
                    . '<tr >';

            $html.= '<td rowspan="2" style="width: 30%">République tunisienne<br>'
                    . 'Miistère DES AFFAIRES SOCIALES, DE LA SOLIDARITE ET DES TUNISIENS à l\'ETRANGER'
                    . '<br><b>CAISSE NATIONALE <BR> DE SECURITE SOCIALE </b>'
                    . '</td>';
            $caisse = 'CAISSE NATIONALE DE SECURITE SOCIALE  ';
//        elseif ($lignecodesoc->getIdCodesoc() == 2):
//            $caisse = 'CAISSE NATIONALE DE RETRAITE ET DE PREVOYANCE SOCIALE';
//            $html.= '<td rowspan="2" style="width: 34%">CAISSE NATIONALE <br>DE RETRAITE ET<br>DE PREVOYANCE SOCIALE</td><td style="text-align: right"></td>';
//        endif;

            $html.='<td style="text-align:center;font-weight:bold;width:6%;height:25px;">TR</td>'
                    . '<td style="text-align: center;font-weight:bold;width: 7%">Année</td>'
                    . '<td style="text-align: center;font-weight:bold;width: 11%">N°Employeur</td>'
                    . '<td style="text-align: center;font-weight:bold;width: 6%">BR</td>'
                    . '<td rowspan="4" style="text-align: center;font-weight:bold;width: 40%">&nbsp;<br>'
                    . $societe->getRs() . " &nbsp;<br>" . $societe->getAdresse()
                    . '</td>'
            ;
            $html.= '</tr>'
                    . '<tr>'
                    . '<td>&nbsp;<br>' . $trimestre . '</td>'
                    . '<td>&nbsp;<br>' . $annee_declaration . '</td>'
                    . '<td>&nbsp;<br>' . $societe->getIdunique() . '</td>'
                    . '<td>&nbsp;<br>' . $societe->getBr() . '</td>'
                    . '</tr>
                     <tr>
                            <td style="width: 20%;height:25px;font-weight:bold;">Permanents</td>
                            <td style="width: 20%;font-weight:bold;">Occasionnels</td>
                            <td style="width: 20%;font-weight:bold;">Nbre tot salariés</td>
                     </tr>
                    <tr>
                            <td style="height:25px;">' . $permanet[0]['nbrgantspermanets'] . '</td>
                            <td>' . $occasionnel[0]['nbrgantsoccasionnelle'] . '</td>
                            <td>' . $total_agents[0]['nbrgants'] . '</td>
                    </tr>';

            $totalsociale = (floatval(floatval($dossier->getLignecontribitionsociale()->getTaux()) + floatval($lignecodesoc->getTaux())) * $resultat_Tot) / 100;
            $total_accident = ($dossier->getTauxaccidentcotisation() * $resultat_Tot) / 100;
            $total = $totalsociale + $total_accident;
            $html.='<tr>
                    <td style="text-align:left;" rowspan="5" colspan="3">
                        <table>
                            <tr>
                                <td style="height:25px;">Date d\'arrivée : </td>
                            </tr>
                            <tr>
                                <td style="height:25px;">Mode de paiement par : </td>
                            </tr>
                            <tr>
                                <td style="height:25px;">Montant : </td>
                            </tr>
                            <tr>
                                <td style="height:25px;">Caisse le : </td>
                            </tr>
                            <tr>
                                <td style="width:50%;height:25px;">Chéque N° : </td><td style="width:50%;"> sur banque </td>
                            </tr>
                            <tr>
                                <td style="height:25px;">Virement bancaire sur : </td>
                            </tr>
                            <tr>
                                <td style="height:25px;">Mondat N° : </td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 10%;height:25px;font-weight:bold;">Nature</td>
                    <td style="width: 10%;font-weight:bold;">Salaires déclarés</td>
                    <td style="width: 10%;font-weight:bold;">Taux Cotisations</td>
                    <td style="width: 10%;font-weight:bold;">Montant à payer</td>
                </tr>
                <tr>
                    <td style="width: 10%;height:25px;font-weight:bold;">Sécurité Sociale</td>
                    <td style="width: 10%">' . $resultat_Tot . '</td>
                    <td style="width: 10%">' . floatval(floatval($dossier->getLignecontribitionsociale()->getTaux()) + floatval($lignecodesoc->getTaux())) . ' %</td>
                    <td style="width: 10%">' . number_format($totalsociale, 3, '.', ' ') . '</td>
                </tr>
                <tr>
                    <td style="height:25px;font-weight:bold;">Accident de travail</td>
                    <td>' . $resultat_Tot . '</td>
                    <td>' . number_format($dossier->getTauxaccidentcotisation(), 2, '.', ' ') . ' %</td>
                    <td>' . number_format($total_accident, 3, '.', ' ') . '</td>
                </tr>
                <tr>
                    <td style="height:25px;font-weight:bold;">Pénalités</td>
                    <td style="font-weight:bold;">Nbre de jours</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align:right;height:25px;font-weight:bold;">Total à payer</td>
                    <td>' . number_format($total, 3, '.', ' ') . '</td>
                </tr>
                <tr>
                    <td style="text-align:left;font-weight:bold;height: 40px" colspan="7">La présente déclaration de salaire certifiée et conforme à nos documents comptables est arrêtée à la somme de :<br>' . strtoupper(chiffreToLettre::cvnbst($total)) . '</td>
                </tr>
                <tr>
                    <td colspan="3" style="height:98px;font-weight:bold;">OBSERVATIONS</td>
                    <td colspan="4" style="height:98px;font-weight:bold;">Fait à Sfax le ' . date('d/m/Y') . '<br> Signature de l\'employeur</td>
                </tr>
                <tr>
                    <td style="text-align:center;font-weight:bold;width:15%;height:32px;">TR</td>
                    <td style="text-align:center;font-weight:bold;width: 15%">Année</td>
                    <td style="text-align:center;font-weight:bold;width: 15%">N° Employeur</td>
                    <td style="text-align:center;font-weight:bold;width: 15%">BR</td>
                    <td rowspan="6" style="width:40%;font-weight:bold;">
                        <table>
                            <tr><br>
                                <td style="width:10%;"></td>
                                <td style="width:80%;text-align:left;">' . $caisse . '</td>
                                <td style="width:10%;"></td>
                            </tr>
                            <tr>
                                <td style="width:10%;"></td>
                                <td style="width:80%;text-align:left;height:40px;">Bureau Régional : ....................................</td>
                                <td style="width:10%;"></td>
                            </tr>
                            <tr>
                                <td style="width:50%;text-align:center;">L\'agent de contrôle</td>
                                <td style="width:50%;text-align:center;">Cachet</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>'
                    . '<td style="height:30px;">' . $trimestre . '</td>'
                    . '<td>' . $annee_declaration . '</td>'
                    . '<td>' . $societe->getIdunique() . '</td>'
                    . '<td>' . $societe->getBr() . '</td>'
                    . '</tr>'
                    . '<tr><td colspan="4" style="text-align:left;height:26px;">Chéque N°........................' . '</td>'
                    . '</tr>'
                    . '<tr><td colspan="4" style="text-align:left;height:26px;">Sur........</td></tr>'
                    . '<tr>'
                    . '<td colspan="2" style="text-align:left;height:26px;">Du</td> '
                    . '<td>Déposé le</td><td>' . date('d/m/Y') . '</td></tr>'
                    . '<tr><td colspan="4" style="text-align:left;height:26px;">Montant</td></tr>'
                    . '</tbody>'
                    . '</table>';
        elseif ($lignecodesoc->getIdCodesoc() == 2):
            $html.="";
        endif;

        return $html;
    }

//etat recap cnrps 

    public function ReadHtmllisteFichesPaieAllFilterRecapcnrps($mois, $annee, $id_codesociale, $annee_session) {
        $q = Doctrine_Query::create()
                ->select('p.*')
                ->from('paie p,agents a')
                ->where('p.id_agents=a.id');
        if ($annee != '')
            $q = $q->andWhere('p.annee= ?', $annee);
        if ($codesociale != '')
            $q = $q->andWhere('p.id_lignecodesociale= ?', $codesociale);
        if ($mois != '')
            $q = $q->andWhere('p.mois= ?', $mois);
        $q->orderBy('p.id_agents, p.mois');
        $listes = $q->execute();

        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
//nbre demployé qui on le code cnrps 
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query_cnrps = " select COALESCE(count(DISTINCT contrat.id_agents),0) as nbreagents_cnrps"
                . " from contrat"
                . " where contrat.id_codesociale= 2"
        ;
        $resultat_cnrps = $conn->fetchAssoc($query_cnrps);
        $query__somme_brut = " select COALESCE(SUM(paie.salairebrut),0) as sommebrut_cnrps"
                . " from paie"
                . " where paie.id_codesociale= 2"
                . " and paie.mois= " . $mois
                . " and paie.annee= " . $annee
                . " and paie.id_lignecodesociale= " . $id_codesociale;

        $resultat_somme_brut = $conn->fetchAssoc($query__somme_brut);

        if ($mois < 10):
            $mois = '0' . $mois;
        else: $mois = $mois;
        endif;
        $limit_debut = date($annee . '-' . $mois . '-01');
        $limit_fin = date($annee . '-' . $mois . '-01');

        $query__somme_pret_personnel = " select COALESCE(SUM(demandepret.montantmentielle),0) as s_pret_personnel"
                . " from demandepret"
                . " where demandepret.id_sourcepret= 1"
                . " and demandepret.id_typepret=2 "
                . " and demandepret.datedebutretenue <= '" . $limit_debut . "'"
                . " and demandepret.datefinretenue >= '" . $limit_fin . "'"
//                . " and (EXTRACT(MONTH FROM demandepret.datedebutretenue) <= " . $mois . " and EXTRACT(YEAR FROM demandepret.datedebutretenue) <= " . $annee . ")"
//                . " and (EXTRACT(MONTH FROM demandepret.datefinretenue) > " . $mois . " and EXTRACT(YEAR FROM demandepret.datefinretenue) > " . $annee . ")"
                . " and demandepret.valide =true"

        ;
        $resultat_pret_personnel = $conn->fetchAssoc($query__somme_pret_personnel);

        $query__somme_pret_veicule = " select COALESCE(SUM(demandepret.montantmentielle),0) as s_pret_veicule"
                . " from demandepret"
                . " where demandepret.id_sourcepret= 1"
                . " and demandepret.id_typepret=4 "
                . " and demandepret.datedebutretenue <= '" . $limit_debut . "'"
                . " and demandepret.datefinretenue >= '" . $limit_fin . "'"
                . " and demandepret.valide =true";
        $resultat_pret_veicule = $conn->fetchAssoc($query__somme_pret_veicule);
        $query__somme_pret_logement = " select COALESCE(SUM(demandepret.montantmentielle),0) as s_pret_logement"
                . " from demandepret"
                . " where demandepret.id_sourcepret= 1"
                . " and demandepret.id_typepret=3 "
                . " and demandepret.datedebutretenue <= '" . $limit_debut . "'"
                . " and demandepret.datefinretenue >= '" . $limit_fin . "'"
                . " and demandepret.valide =true";
        $resultat_pret_logement = $conn->fetchAssoc($query__somme_pret_logement);
        $query__somme_pret_universitaire = " select COALESCE(SUM(demandepret.montantmentielle),0) as s_pret_universitaire"
                . " from demandepret"
                . " where demandepret.id_sourcepret= 1"
                . " and demandepret.id_typepret=3 "
                . " and demandepret.datedebutretenue <= '" . $limit_debut . "'"
                . " and demandepret.datefinretenue >= '" . $limit_fin . "'"
                . " and demandepret.valide =true";
        $resultat_pret_universitaire = $conn->fetchAssoc($query__somme_pret_universitaire);
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $array = array("01" => "جانفي ", "02" => "فيفري ", "03" => "مارس", "04" => "آفريل ",
            "05" => "ماي ", "06" => "جوان ", "07" => "جويلية ", "08" => "أوت ", "09" => "سبتمبر ",
            "10" => "أكتوبر ", "11" => "نوفمبر ", "12" => "ديسمبر ");
        $html = '<table border="1">
                     <table style="width:100%">
                            <tbody>
                                <tr><br>
                                    <td style="font-weight:bold;width:14%;text-align:center;heigth: 1%"> 
                                    <table>
                                       <tr><td style="height:50px;width:80px;text-align:right;"><img src="' . sfconfig::get('sf_appdir') . '/images/cnrps.png"></td></tr> 
                                    </table>
                                        </td>                      
                                    <td style="font-weight:bold;width:86%;text-align:center;font-size:24px">الصندوق الوطني للتقاعد والحيطة الاجتماعية&nbsp;<br> </td>
                                </tr>
                                <tr>
                                    <td style="width: 5%"></td>
                                    <td style="font-weight:bold;width:45%;text-align:center;font-size:17px;">' . $societe->getRs() . '</td>
                                    <td style="width: 5%"></td>
                                    <td style="font-weight:bold;width:45%;text-align:right;font-size:16px"> كـشـف إيـداع مـبـالـغ</td>  
                                </tr>
                                <tr style="width: 100%;text-align: right">
                                <td style="width: 5%"></td>
                               <td style="font-weight:bold;text-align: center;width:45%">&nbsp;<br>' . $societe->getAdresse() . '</td>
                                <td style="width: 5%"></td>
                                <td style="width: 25%">
                                    <table border="1"> 
                                         <tbody>
                                         <tr><td style="height: 20px;text-align: center" colspan="2">  الفترة </td>
                                         </tr>
                                            <tr>
                                            <td style="height: 20px;text-align: center">   السنة</td> 
                                            <td style="height: 20px;text-align: center"> الشهر</td>
                                         </tr>
                                         <tr>
                                            <td style="height: 20px;text-align: center">' . $annee . '</td>
                                            <td style="height: 20px;text-align: center"> ' . $array [$mois] . ' </td>
                                         </tr>
                                         </tbody>
                                    </table>
                                 </td>
                                <td style="width: 20%">
                                    <table border="1"> 
                                        <tbody>
                                         <tr><td style="height: 20px;text-align: center">  عدد المساهمين</td>
                                         </tr>
                                            <tr>
                                            <td style="height: 40px;text-align: center">&nbsp;<br>' . $resultat_cnrps[0]['nbreagents_cnrps'] . ' </td>
                                         </tr>
                                        </tbody>
                                    </table>
                                </td>
                              </tr>
                              <hr>
                                <tr>
                                        <td style="font-weight:bold;width:100%;text-align:right;font-size:17px;height: 25px">المحجوزات بعنوان مختلف الأنظمة</td>
                                </tr><hr>
                                <tr> &nbsp;<br>
                                       <td style="font-weight:bold;width:50%;text-align:right;font-size:18px">  مساهمات المشغل </td>
                                        <td style="font-weight:bold;width:50%;text-align:right;font-size:18px">  مساهمات الأجراء</td>
                                 </tr>
                                <tr> 
                                    <td style="font-weight:bold;width:25%;text-align:right;font-size:14px">' . number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (14.5 + 4 ) / 100, 3, '.', ' ') . '</td>
                                    <td style="width:25%;text-align:right;font-size:18px">&nbsp;-التقاعد  </td>

                                    <td style="font-weight:bold;width:22%;text-align:right;font-size:14px">' . number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (2.75 + 8.2 ) / 100, 3, '.', ' ') . '</td>
                                    <td style="width:28%;text-align:right;font-size:18px">&nbsp;-التقاعد  </td>
                                      
                                </tr>
                                <tr>
                                    <td style="font-weight:bold;width:72%;text-align:right;font-size:14px">' . number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (1 ) / 100, 3, '.', ' ') . '</td>
                                    <td style="width:28%;text-align:right;font-size:18px">&nbsp;-رأس المال عند الوفاة </td>
                                </tr>
                                <hr>
                                <tr>
                                    <td style="font-weight:bold;width:100%;text-align:right;font-size:17px;height: 25px">استرجاع  مبالغ  </td>
                                </tr><hr>
                                <tr>&nbsp;<br>
                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . $resultat_pret_universitaire[0]['s_pret_universitaire'] . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">- قروض جامعية</td>

                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . $resultat_pret_logement[0]['s_pret_logement'] . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">- قروض سكن</td>
                                      
                                </tr>
                                 <tr> 
                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . '.............' . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">- كراء </td>

                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . $resultat_pret_veicule[0]['s_pret_veicule'] . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px"> - قروض سيارات</td>
                                        
                                </tr>
                                 <tr> 
                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . '.............' . '</td>
                                    <td style="width3525%;text-align:right;font-size:18px">- بيع مساكن</td>

                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . $resultat_pret_personnel[0]['s_pret_personnel'] . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">- قروض شخصية</td>
                                      
                                </tr>
                                 <tr> 
                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . '.............' . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">- مبالغ أخرى</td>

                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . '............' . '</td>
                                    <td style="width:35%;text-align:right;font-size:18px">-  ضم خدمات على كاهل العون</td>
                                      
                                </tr>
                               <tr> 
                                    <td style="font-weight:bold;width:15%;text-align:right;font-size:14px">' . '.............' . '</td>
                                    <td style="width:35%;text-align:right;font-size:12px"> التنصيص عليها</td>

                                    <td style="font-weight:bold;width:35%;text-align:right;font-size:14px"></td>
                                    <td style="width:25%;text-align:right;font-size:18px"></td>
                                      
                                </tr>
                                <hr>';
        $total = number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (1 ) / 100, 3, '.', '') + number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (2.75 + 8.2 ) / 100, 3, '.', '') + number_format($resultat_somme_brut[0]['sommebrut_cnrps'] * (14.5 + 4 ) / 100, 3, '.', '');
        $html.='<tr>
                                        <td style="font-weight:bold;width:50%;text-align:center;font-size:20px">   المجموع  العام</td>
                                         <td style="font-weight:bold;width:50%;text-align:right;font-size:20px"> توصيات هامة  </td>
                                </tr>
                                <tr>&nbsp;<br>
                                <td style="font-weight:bold;width:50%;text-align:center;font-size:14px">' . number_format($total, 3, '.', '') . '</td>
                                <td style="width:50%;direction:rtl;text-align:right;font-size:14px;"><br>- بالنسبة إلى المساهمات المحمولة على كاهل المشغل على غرار التعديل 
                                الألي للجرايات والتنفيل وضم الخدمات يتم إعتماد المراسلات الموجهة من قبل الصندوق قصد خلاصها.    
                                &nbsp;<br>- كل كشف إيداع يغطي عديد الأشهر يقع رفضه آليا.
                                &nbsp;<br>-   منح اإلنتاج بعنوان االربع ثالثيات وكذلك منحة رأس السنة(الشهر 13) 
                                                يجب إفرادها بكشوفات إيداع منفصلة مع التنصيص تباعا على الرتقيم
                                                21 - 22 - 23 - 24 أو 13 وذلك  بخانة الشهر المبنية أعلاه.
                                </td>
                                </tr>
                                <tr> &nbsp;<br>
                                <td style="width: 50%">
                                        <table border="1" > 
                                             <tbody>
                                             <tr>
                                             <td>
                                                <table>
                                                    <tr>
                                                        <td style="height:244px;text-align:center;font-size:14px;border-right: 1px solid #000 ;">  المــــشـــغل    
                                                            &nbsp;<br>&nbsp;<br>
                                                            <div style="text-align: right;font-size: 14px">    التاريخ</div>
                                                             &nbsp;<br>&nbsp;<br>
                                                            <div style="text-align: center;font-size: 14px">    ختم وإمضاء&nbsp;<br>
                                                            وصفة المسؤول المفوض</div>
                                                             &nbsp;<br>&nbsp;<br>&nbsp;<br>
                                                            </td>
                                                             <td style="height: 100px;text-align: center;font-size: 14px;">' . 'الصندوق الوطني للتقاعد والحيطة االجتماعية 
                                                                &nbsp;<br>
                                                            <div style="text-align: right;font-size: 14px">    التاريخ</div>  
                                                             &nbsp;<br>&nbsp;<br>
                                                            <div style="text-align: center;font-size: 14px">    الختم واإلمضاء</div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td style="width: 50%">
                                        <table border="1"> 
                                             <tbody>
                                                <tr>
                                                    <td style="width:100%">
                                                        <table>
                                                            <tr>
                                                               <td style="font-weight:bold;height: 25px;text-align: right;font-size:18px">  ملاحظات  </td>
                                                            </tr>
                                                            <tr>
                                                                <td style="height: 65px;text-align: center"></td>
                                                            </tr>
                                                        </table>
                                                    </td>
                                                </tr>
                                             </tbody>
                                        </table>
                                         &nbsp;<br>
                                        <table border="1"> 
                                             <tbody>
                                                <tr>
                                                    <td>
                                                        <table cellpadding="3">
                                                            <tr>
                                                                <td style="font-weight:bold;height: 25px;text-align:right;width: 100%"> صرف لفائدة الصندوق الوطني للتقاعد والحيطة الاجتماعية  بواسطة:  </td>
                                                            </tr>
                                                            <tr>&nbsp;<br>
                                                                <td style="height: 27px;text-align: right;width: 38%;font-size: 14px">   تحويل بنكي </td>
                                                                <td style="width:10%"><table border="1"><tr><td style="height:20px;width:32px;text-align:center;"></td></tr></table></td>
                                                                <td style="height: 27px;text-align: right;width: 38%;font-size: 14px">   صك </td>
                                                                <td style="width:10%"><table border="1"><tr><td style="height:20px;width:32px;text-align:center;"></td></tr></table></td>
                                                            </tr>
                                                            <tr>&nbsp;<br>
                                                                <td style="height: 42px;text-align: right;width: 86%;font-size: 14px">  تحويل بريدي بالحساب الجاري عدد       121-18  </td>
                                                                <td style="width:14%"><table border="1"><tr><td style="height:20px;width:32px;text-align:right;"></td></tr></table></td>
                                                            </tr>
                                                       </table>
                                                   </td>                                             
                                               </tr>
                                            </tbody>
                                        </table><div></div>
                                    </td>
                                </tr>
                          </tbody>
                        </table>
                </table>';
        return $html;
    }

}
