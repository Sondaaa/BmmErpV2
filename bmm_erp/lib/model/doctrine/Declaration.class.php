<?php

/**
 * Declaration
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProject1
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Declaration extends BaseDeclaration {

    public function ReadHtmlDeclaration(sfWebRequest $request) {
        $id = $request->getParameter('id');
        $declaration = DeclarationTable::getInstance()->find($id);
        $html = '';
        $html.='<h3 style="font-size:18px;">Fiche Déclaration : ' . trim($declaration->getLibelle()) . '</h3>';

        $etat = "";
        if ($declaration->getEtat())
            $etat = "traitée";

        $html.='&nbsp;<br><table cellpadding="3">
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Date de Création</td>
                        <td style="width:78%;">' . date('d/m/Y', strtotime($declaration->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Libellé</td>
                        <td style="width:78%;">' . trim($declaration->getLibelle()) . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Date Début</td>
                        <td style="width:78%;">' . date('d/m/Y', strtotime($declaration->getDatedebut())) . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Date Fin</td>
                        <td style="width:78%;">' . date('d/m/Y', strtotime($declaration->getDateFin())) . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Montant</td>
                        <td style="width:78%;">' . number_format($declaration->getMontant(), 3, '.', ' ') . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Compte Bancaire / CCP</td>
                        <td style="width:78%;">' . trim($declaration->getCaissesbanques()) . '</td>
                    </tr>
                    <tr>
                        <td style="width:22%;height:25px;font-weight:bold;">Etat</td>
                        <td style="width:78%;">' . $etat . '</td>
                    </tr>
                </table>&nbsp;<br>';

        $html.='<table border="1" cellpadding="3">
                    <tr style="text-align:center;font-weight:bold;background-color:#EDEDED;">
                        <td style="width:10%;height:25px;">Ordonnance</td>
                        <td style="width:9%;">Date</td>
                        <td style="width:10%;">Montant</td>
                        <td style="width:25%;">Compte Bancaire / CCP</td>
                        <td style="width:10%;">Ordonnance sujet R.S</td>
                        <td style="width:10%;">Retenue à la Source</td>
                        <td style="width:6%;">Taux R.S</td>
                        <td style="width:20%;">Fournisseur</td>
                    </tr>';

        foreach ($declaration->getDocumentbudget() as $ordonnance):

            $ordonnance_parent = DocumentbudgetTable::getInstance()->find($ordonnance->getIdDocumentbudget());
            $certificat = $ordonnance_parent->getCertificatretenue()->getFirst();
            $budget_id = $ordonnance->getLigprotitrub()->getId();
            $lignebanquecaisse = LignebanquecaisseTable::getInstance()->findByIdBudget($budget_id)->getFirst();

            $html.='<tr>
                        <td style="text-align: center;">' . $ordonnance->getNumero() . '</td>
                        <td style="text-align: center;">' . date('d/m/Y', strtotime($ordonnance->getDatecreation())) . '</td>
                        <td style="text-align: center;">' . number_format($ordonnance->getMntnet(), 3, ".", " ") . '</td>
                        <td>';

            if ($lignebanquecaisse != null)
                $html.= trim($lignebanquecaisse->getCaissesbanques());

            $html.='</td>
                    <td style="text-align: center;">' . $ordonnance_parent->getNumero() . '</td>
                    <td style="text-align: center;">' . date('d/m/Y', strtotime($certificat->getDatecreation())) . '</td>
                    <td style="text-align: center;">' . $certificat->getRetenuesource()->getValeurretenue() . '%</td>
                    <td>' . $certificat->getFournisseur() . '</td>
                </tr>';
        endforeach;
        
        $html.='</table>';

        return $html;
    }

    public function ReadHtmlListeDeclaration() {
//        $annee = $_SESSION['exercice_budget'];
        $annee = '';
        $declarations = DeclarationTable::getInstance()->getByAnnee($annee);

        $html = '';
        if ($annee != '')
            $html.='<h3 style="font-size:18px;">Liste des Déclarations - ' . $annee . '</h3>';
        else
            $html.='<h3>Liste des Déclarations</h3>';

        $html.='&nbsp;<br><table border="1" cellpadding="3">
                    <tr style="text-align:center;font-weight:bold;background-color:#EDEDED;">
                        <td style="width:3%;height:25px;">N°</td>
                        <td style="width:10%;">Date de Création</td>
                        <td style="width:20%;">Libellé</td>
                        <td style="width:10%;">Date Début</td>
                        <td style="width:10%;">Date Fin</td>
                        <td style="width:12%;">Montant</td>
                        <td style="width:30%;">Compte Bancaire / CCP</td>
                        <td style="width:5%;">Etat</td>
                    </tr>';
        $i = 1;
        foreach ($declarations as $declaration):
            $etat = "";
            if ($declaration->getEtat())
                $etat = "traitée";
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($declaration->getDatecreation())) . '</td>
                        <td style="text-align:center;">' . trim($declaration->getLibelle()) . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($declaration->getDatedebut())) . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($declaration->getDatefin())) . '</td>
                        <td style="text-align:right;">' . number_format($declaration->getMontant(), 3, ".", " ") . '</td>
                        <td style="text-align:left; font-size:10px;">' . trim($declaration->getCaissesbanques()) . '</td>
                        <td style="text-align:center;">' . $etat . '</td>
                </tr>';
            $i++;
        endforeach;

        $html.='</table>';

        return $html;
    }

}
