<?php

/**
 * Conge
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Conge extends BaseConge {

    public function ReadHtmllisteAgentsAllFilter($idag, $idtype, $annee) {

        $q = Doctrine_Query::create()
                ->select('c.*')
                ->from('conge c,agents a')
                ->where('c.id_agents=a.id')
                ->orderBy(' c.id_type ASC')

        ;
        if ($idag != '')
            $q = $q->andWhere('a.id= ?', $idag);
        if ($idtype != '')
            $q = $q->andWhere('c.id_type= ?', $idtype);
        if ($annee != '')
            $q = $q->andWhere('c.annee= ?', $annee);
        $q = $q->orderBy('c.id_type, c.datedebutvalide');
        $listes = $q->execute();

        $html = '<h3>Liste des Suivis des Congés </h3>
            &nbsp;<br>
            <table border="1" cellpadding="3">
            <tr>
       <td style="width:30%;">
       <span style="margin-top:10px;color:#000;font-weight:bold;font-size:14px;">Recherche suivant :</span></td>';

        if ($annee != ''):
            $html.='<td style="width:70%;">';
            $html.=' <span style="margin-top:10px;color:#000;font-weight:bold;font-size:14px;">Année : ' . '</span><b>' . $annee . '</b>';
            $html.='</td>';
        endif;

        $html.='</tr>';
        if ($idag != ''): $agents = Doctrine_Core::getTable('agents')->findOneById($idag);
            $html.='<tr><td></td> <td style="width:0%;">
       <span style="margin-top:10px;color:#000;font-weight:bold;font-size:14px;">Agent :</span><b>
      ' . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</b>' . '</td></tr>';

        endif;

        if ($idtype != ''):
            $type = Doctrine_Core::getTable('typeconge')->findOneById($idtype);
            $html.= '<tr><td></td><td>
       <span style="margin-top:10px;color:#000;font-weight:bold;font-size:14px;"> Type Congé :  </span><b>'
                    . $type->getLibelle() . '</b></td></tr>';

        endif;
        $html.='</table>&nbsp;<br>';


        $html.='<table border="1" cellpadding="3">
           <tbody>
    
        <tr style="background-color:#EDEDED;">
           
                                <th style="width: 5%;text-align:center;">N°</th>
                                    <th style="width: 20%;text-align:center;">Agents</th>
                                    <th style="width: 15%;text-align:center;">Nbr.J. Consommé</th> 
                                    <th style="width: 10%;text-align:center;">Date Début<br></th> 
                                    <th style="width: 10%;text-align:center;">Date Fin</th> 
                                    <th style="width: 10%;text-align:center;">Nbr.J. Restant</th> 
                                    <th style="width: 20%;text-align:center;">Type Congé</th> 
                                    <th style="width: 10%">Année</th>       
</tr>';

        if ($listes->count() != 0):
            $i = 1;
            foreach ($listes as $p):
                $html.='<tr>
        <td style = "width:5%;text-align:center;">' . $i . '</td>';

                $html.= '<td style = "text-align:center;">' . $p->getAgents()->getNomcomplet() . " " . $p->getAgents()->getPrenom() . '</td>';


                $html.=' <td style = "text-align:center;">' . $p->getNbrcongeralise() . '</td>
        <td style = "text-align:center;">' . $p->getDatedebutvalide() . '</td>
        <td style = "text-align:center;">' . $p->getDatefinvalide() . '</td>
        <td style = "text-align:center;">' . $p->getNbrcongerestant() . '</td>';

                $html.=' <td style = "text-align:center;">' . $p->getTypeconge()->getLibelle() . '</td>';

                $html.=' <td style = "text-align:center;">' . $p->getAnnee() . '</td>
        </tr>';
                $i++;
            endforeach;
            $html.='</tbody>'
            ;
        else:
            $html.='<tr>
                        <td style="width:100%;height:20px;text-align:center;"><b>Pas des suivis des congés</b></td>
                    </tr>';
        endif;
        $html.='</table>';
        return $html;
    }

    public function getDate() {
        echo date('Y');
    }

//
    public function ReadHtmlDemandeConge($idd) {
        $conge = Doctrine_Core::getTable('conge')->findOneById($idd);

        $html = '<div class = "titre" style = "text-align:center;font-size:22px;width:100%;font-weight:bold;">'
                . '<br>&nbsp;
        <u>مطلب عطلة إستراحة ' . '</u></div>&nbsp;
        <br>&nbsp;
        <br>&nbsp;
        <br>&nbsp;
        <br>';

        $html.= '<table><tr><td style="font-size:14x;">' . $conge->getTypeconge()->getLibelle() . date("Y") . '</td></tr></table>';

        $query = " select SUM( conge.nbrjour ) as nbr"
                . " from conge "
                . " where conge.id_agents=" . $conge->getAgents()->getId();

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $liste = $conn->fetchAssoc($query);

        $nbrjour = $conge->getTypeconge()->getNbrjour() - $liste[0]['nbr'];

        $html.= '<table class = "tableligne " ><tbody>
                    <tr>
                        <td>خاص بالمسؤول المباشر </td>
                        <td>خاص بصاحب الطلب </td>
                    </tr>
                    <tr>
                        <td style = "text-align: rigth">رأي المسؤول المباشر :'
                . '<br>';
        if ($conge->getObjection() != 1):
            $html.= '<b>' . "بدون اعتراض" . '</b>'
                    . '<br><br><br><br>';
        else:
            $html.= '<b>' . "مع اعتراض" . '</b>';
            $html.= '<br><br><u>في صورة الاعتراض</u>'
                    . '<br>المدة الجديدة المتفق عليها '
                    . '<br> من ' . date('d/m/Y', strtotime($conge->getDatedebutvalide())) . 'إلى ' . date('d/m/Y', strtotime($conge->getDatefinvalide()));
        endif;

        $html.= '<br><br>إسم و لقب المعوض :';
        $idrespnsable = $conge->getResponsable();
        if ($idrespnsable != "") {
            $age = Doctrine_Core::getTable('agents')->findOneById($idrespnsable);
        }
        if ($idrespnsable != ""):
            $html.= $age->getNomcomplet() . ' ' . $age->getPrenom();
        else :
            $html.= "";
        endif;

        $html.= '<br><br>'
                . 'حر ر ب ' . 'قبلي ' . 'في ' . date('d/m/Y', strtotime(date("Y-m-d")))
                . '<br><br><table><tr><td style="text-align:center;height:90px;width:140px;">الإمضاء</td></tr></table>'
                . $conge->getSignatureresponsable()
                . '</td>'
                . '<td style = "text-align:rigth">'
                . $conge->getAgents()->getNomcomplet() . ' ' . $conge->getAgents()->getPrenom() . ': اللقب و' . ' الإسم' . '<br>' . 'الرقم : ' . $conge->getAgents()->getIdrh()
                . '<br>الرتبة أو الخطة : ' . $conge->getAgents()->getContrat()->getLast()->getPosterh()->getlibelle() . ' '
                . '<br>'
                . $conge->getAgents()->getContrat()->getLast()->getGrade()->getLibelle()
                . '<br>'
                . 'عدد الأيام المطلوبة : ' . $conge->getNbrjour() . '<br>'
                . 'المدة المقترحة  : من ' . date('d/m/Y', strtotime($conge->getDatedebut())) . ' ' . 'إلى ' . date('d/m/Y', strtotime(($conge->getDatefin())))
                . '<br>عدد الأيام :' . ' '
                . $nbrjour . ' '
                . 'يوما '
                . '<br>' . 'مكان قضاء الراحة (العنوان) :' . $conge->getLieu()
                . '<br><br>' . 'حر ر ب ' . 'قبلي ' . 'في ' . date('d/m/Y', strtotime(date("Y-m-d")))
                . '<br><br><table><tr><td style="text-align:center;height:90px;">الإمضاء</td></tr></table>'
                . $conge->getSignature()
                . '</td> '
                . '</tr>'
                . '</tbody></table>'
                . '<br><br><table style="margin-left: 200px;text-align: rigth"><tr><td>'
                . '<b>' . 'كشف تفصيلي لعطلة الإستراحة ' . '</b>'
                . '</td></tr></table><br>';

        $html.= '<br><br>'
                . '<table style=" margin-left: 200px;text-align: rigth" class="tableligne ">'
                . '<tbody>'
                . ' <tr>' . '<td colspan="2">' . 'خاص بمصلحة التصرف في الموارد البشرية  ' . '</td>'
                . '</tr>'
                . '<tr>'
                . '<td style="text-align:rigth">مدة الإستراحة الممنوحة '
                . '<br>'
                . 'من .................................. ' . 'إلى   ..............................'
                . '<br> تاريخ الرجوع  ...........................................................................'
                . '<br>أي صورة التمديد :'
                . '<br>'
                . 'من .................................. ' . 'إلى   ..............................'
                . '<br><br><table><tr><td style="text-align:center;height:90px;width:130px;">' . ' رئيس مصلحة التصرف في الموارد' . ' البشرية ' . '</td></tr></table>'
                . '</td>'
                . '<td>الحق في عطلة بتاريخ .................................. / .........'
                . '<br>الرصيد السابق ........................................... / .........'
                . '<br><br> المجموع .................................................. / .........'
                . '<br> عدد الأيام المطلوبة .................................... / .........'
                . '<br> عدد الأيام المتبقية ...................................... / .........'
                . '<br><br><br><table><tr><td style="text-align:center;height:90px;">الإمضاء</td></tr></table>'
                . '</td>'
                . '</tr>'
                . '</tbody>'
                . '</table>'
                . '<br>';
        $html.= '<br><table>
                        <tr>
                            <td style="width:50%;text-align: center;">' . 'المدير العام ' . '</td>
                            <td style="width:50%;text-align: rigth;">' . ' قبلي في ' . date('d/m/Y', strtotime(date("Y-m-d"))) . '</td>
                        </tr>
                    </table><br>';

        return $html;
    }

}
