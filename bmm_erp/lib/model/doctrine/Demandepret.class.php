<?php

/**
 * Demandepret
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Demandepret extends BaseDemandepret {

    public function __toString() {

        return "" . $this->getAgents()->getIdrh() . " " . $this->getAgents()->getNomcomplet() . " " . $this->getAgents()->getPrenom() . " " . $this->getMois() . " " . $this->getAnnee();
    }

    //demande par personne
    public function ReadHtmlListeDemandeDePret($id) {
        $demande = Doctrine_Core::getTable('demandepret')->findOneById($id);
        $id_agents = $demande->getIdAgents();
        $demande_liste = DemandepretTable::getInstance()->getByAgentEnCours($id_agents);

        $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $html = '<div class="titre" style="text-align:center;font-size:22px;width:100%;font-weight:bold;">'
                . '&nbsp;<br> مطلب قرض شخصي '
                . '</div>&nbsp;<br>&nbsp;<br>&nbsp;<br>'
//                . ' <table><tr><td>'
                . '<div class="titre" style="text-align:right;width:100%;font-weight:bold;font-size:16px;">
                    <table><tr><td style="background-color:#ECECEC;height:25px;">'
                . 'ركن خاص بالمنخرط '
                . '</td></tr></table></div>'
//                . '</td></tr></table><br>'
                . '<div class="titre" style="text-align:left;width:100%;">'
                . '<table><tr><td style="width:7%;">&nbsp;</td><td>'
                . 'المعرف الوحيد  : ' . $agents->getIdrh() . '</td></tr></table>'
                . '<table style="text-align:right;">
                        <tr>
                            <td style="width:82%; height:25px;" colspan="4">' . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</td>
                            <td style="width:18%;"> الاسم والقب :</td>
                        </tr>
                        <tr>
                            <td style="width:15%;height:25px;">' . $agents->getCodepostal() . '</td>
                            <td style="width:15%;"> الترقيم  البريدي :</td>
                            <td style="width:15%;">&nbsp;</td>
                            <td style="width:37%;">' . $agents->getAdresse() . '</td>
                            <td style="width:18%;">العنوان الشخصي  :</td>
                        </tr>
                        <tr>
                            <td colspan="4">' . $agents->getMail() . '</td>
                            <td style="height:25px;"> العنوان الالكتروني:</td>
                        </tr>
                        <tr>
                            <td colspan="3">&nbsp;</td>
                            <td style="height:25px;">' . $demande->getMontantpret() . ' د</td>
                            <td> مبلغ القرض المطلوب : </td>
                        </tr>
                        <tr>
                            <td colspan="2"> في : ' .
                date('d/m/Y', strtotime($demande->getDatedemande()))
                . '</td>
                            <td style="height:25px;">  حر ر ب : ' . $demande->getLieu() . '</td>
                            <td colspan="2"></td>
                        </tr>
                    </table>';

        $html.= '<div class="titre" style="text-align:right;width:100%;font-weight:bold;font-size:16px;">
                    <table><tr><td style="background-color:#ECECEC;height:25px;">ركن خاص بالمؤسسة المشغلة  </td></tr></table></div>
                <table style="text-align:right;">
                        <tr>
                            <td style="width:15%; height:25px;" colspan="4">' . $societe->getMatfiscal() . '</td>
                            <td style="width:15%;"> ترقيمها بالصندوق :</td>
                            <td style="width:60%;">' . $societe->getRs() . '</td>
                            <td style="width:10%;">المؤسسة   :</td>
                        </tr>
                        <tr>
                            <td style="width:30%;height:25px;">' . $agents->getContrat()->getLast()->getSalairedebase()->getCategorierh()->getLibelle() . '</td>
                            <td style="width:8%;"> الصنف :</td>
                            <td style="width:25%;">' . $agents->getContrat()->getLast()->getSalairedebase()->getGrade()->getLibelle() . '</td>
                            <td style="width:7%;">  الرتبة :</td>
                            <td style="width:20%;">' . $agents->getContrat()->getLast()->getPosterh()->getUnite()->getServicerh()->getSousdirection()->getDirection()->getLibelle() . '</td>
                            <td style="width:10%;">الإدارة   :</td>
                        </tr>
                        <tr>
                            <td style="width:50%;"></td>
                            <td style="width:35%;height:25px;">' .
                date('d/m/Y', strtotime($agents->getContrat()->getLast()->getDateemposte()))
                . '</td>
                            <td style="width:15%;"> تاريخ الانخراط : </td>
                        </tr>
                        <tr>
                            <td style="width:35%;height:25px;">' .
                date('d/m/Y', strtotime($agents->getContrat()->getLast()->getDatetitulaire()))
                . '</td>
                            <td style="width:15%;">  تاريخ الترسيم  :</td> 
                            <td style="width:35%;">' . $agents->getContrat()->getLast()->getTypecontrat()->getLibelle() . '</td>
                            <td style="width:15%;"> الوضعية الإدارية :</td>  
                        </tr>
                        

                    </table>'
                . '<div class="titre" style="text-align:rigth;width:100%;">' .
                "المرتب الأساسي  الشهري    : " . $agents->getContrat()->getLast()->getSalairedebase()->getMotant() . ' د<br><br></div>';
        $ligneprime = Doctrine_Core::getTable('ligneprimecontrat')->findByIdContrat($agents->getContrat()->getLast()->getId());
        $html.='<table id="tab" class="tableligne">
            <tbody>
                <tr>
                    <td style="background-color:#ddd;"><h4>المبلغ</h4></td>
                    <td style="background-color:#ddd;"><h4>المنحة </h4></td>
                </tr>';
        foreach ($ligneprime as $p):
            $html.= '<tr>
                        <td>' . number_format($p->getPrimes()->getMontant(), 3, '.', ' ') . ' د</td>
                        <td>' . $p->getPrimes()->getTitreprimes()->getLibelle() . '</td>
                    </tr>';
        endforeach;
        $html.= ' </tbody>
        </table>';
        $html.= '<br><br><div class="titre" style="text-align:right;width:100%;font-weight:bold;">'
                . "معدل الدخل الخام الشهري      : " . $demande->getSalairebrut() . ' د<br><br>' .
                "مبالغ المخصومة بعنوان القروض  :<br><br>";

        $html.='<table id="tab" class="tableligne">
            <tbody>
                <tr>
                    <td style="background-color:#ddd;"><h4>تاريخ اخر أجل للدفع </h4></td>
                    <td style="background-color:#ddd;"><h4>الخصم الشهري </h4></td>
                    <td style="background-color:#ddd;"><h4>نوع القرض </h4></td>
                </tr>';

        foreach ($demande_liste as $demande_en_cours):
            $html.= '<tr>
                        <td>' .
                    date('d/m/Y', strtotime($demande_en_cours->getDatefinretenue()))
                    . '</td>
                        <td>' . number_format($demande_en_cours->getMontantmentielle(), 3, '.', ' ') . ' د</td>
                        <td>' . $demande_en_cours->getPret()->getLibelle() . '</td>
                   </tr>';
        endforeach;

        $html.= ' </tbody>
        </table>';

        return $html;
    }

    //retenue
    public function ReadHtmlListeRetenue(sfWebRequest $request) {
        $typepret = $request->getParameter('id_typepret', '');
        $id_source = $request->getParameter('id_source', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $id_agents = $request->getParameter('id_agents', '');
        if ($typepret != '') {
            $type = Doctrine_Core::getTable('pret')->findOneById($typepret);
        }
        if ($id_source != '') {
            $source = Doctrine_Core::getTable('sourcepret')->findOneById($id_source);
        }
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT  *, pret.libelle as typepret,sourcepret.libelle as sourcepret, "
                . " Concat(agents.nomcomplet,agents.prenom) as nom,agents.idrh as matricule"
                . ",demandepret.montantmentielle as montant ,demandepret.montantpret as montantpret"
                . " ,demandepret.nbrmois as nbrmois,"
                . " demandepret.datedebutretenue as datedebutretenue"
                . " ,demandepret.datefinretenue as datefinretenue"
                . " FROM demandepret, pret, agents ,sourcepret"
                . " WHERE demandepret.id_agents = agents.id"
                . " and demandepret.id_typepret= pret.id"
                . " and  demandepret.id_sourcepret=sourcepret.id ";

        if ($typepret != '')
            $query.= " AND demandepret.id_typepret = " . $typepret;
        if ($id_source != '')
            $query.= " AND demandepret.id_sourcepret = " . $id_source;
        if ($annee != '')
            $query.= " AND demandepret.annee = " . $annee;
        if ($mois != '')
            $query.= " AND demandepret.mois = " . $mois;
        if ($id_agents != '')
            $query.= " AND demandepret.id_agents = " . $id_agents;

        $query.= " ORDER BY agents.nomcomplet";
        $demandes = $conn->fetchAssoc($query);


        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $html = '<h3>RECAPITULATIF DES RETENUES ';
        if ($typepret != ''): $html .= "De  " . $type->getLibelle();
        else: $html .= "";
        endif;
        if ($id_source != ''): $html .= "Du " . $source->getLibelle();
        else: $html .= "";
        endif;
        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;
        if ($id_agents != ""): $html .=" De " . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</h3>';
        else :
            $html .= '</h3>';
        endif;


        $html.='&nbsp;<br>&nbsp;<br> <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                   <td style="width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                   <td style="width: 10%;text-align:center;"><label>Matricule</label></td>
                   <td style="width: 15%;text-align:center;"><label>Agents</label></td>      
                   <td style="width: 10%;text-align:center;"><label>Nature des Prêts</label></td>
                   <td style="width: 10%;text-align:center;"><label>Source des Prêts</label></td>
                   <td style="width: 10%;text-align:center;"><label>Montant des Prêts</label></td>
                   <td style="width: 10%;text-align:center;"><label>Nbre de mois</label></td>      
                   <td style="width: 10%;text-align:center;"><label>Retenue Mensuel </label></td>
                   <td style="width: 10%;text-align:center;"><label>Date Début de Prêt </label></td>
                  <td style="width: 10%;text-align:center;"><label>Date Fin de Prêt</label></td>
                            
                    </tr>';
        $i = 1;
        $resultat = 0;
        foreach ($demandes as $demande):
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td>' . $demande['matricule'] . '</td>
                        <td style="text-align:center;">' . $demande['nom'] . '</td>
                        <td style="text-align:center;">' . $demande['typepret'] . '</td>
                        <td style="text-align:center;">' . $demande['sourcepret'] . '</td>        
                       <td style="text-align:center;">' . $demande['montantpret'] . '</td>                        
                        <td style="text-align:center;">' . $demande['nbrmois'] . "mois" . '</td>
                        <td style="text-align:center;">' . $demande['montant'] . '</td>
                        <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande['datedebutretenue']))
                    . '</td>
                       <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande['datefinretenue']))
                    . '</td>
                            
                  </tr>';
            $resultat = $resultat + $demande['montant'];
            $i++;
        endforeach;
        $html.='<tr style="font-weight:bold;">
                    <td style="width: 60%;background-color:#ddd"></td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;height:25px;">
                    Total</td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;">
                  ' . number_format($resultat, 3, '.', ' ') . '</td>
                    <td  style="width: 20%;background-color:#ddd"></td>
              
</tr>';
        $html.='</tbody></table>';

        return $html;
    }

//liste des demande 

    public function ReadHtmlListeDemande(sfWebRequest $request) {
        $typepret = $request->getParameter('id_typepret', '');
        $id_source = $request->getParameter('id_source', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $id_agents = $request->getParameter('id_agents', '');
        if ($typepret != '') {
            $type = Doctrine_Core::getTable('pret')->findOneById($typepret);
        }
        if ($id_source != '') {
            $source = Doctrine_Core::getTable('sourcepret')->findOneById($id_source);
        }
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT  *, pret.libelle as typepret,sourcepret.libelle as sourcepret, "
                . " Concat(agents.nomcomplet,agents.prenom) as nom,agents.idrh as matricule"
                . ",demandepret.montantmentielle as montant ,demandepret.montantpret as montantpret"
                . " ,demandepret.nbrmois as nbrmois,"
                . " demandepret.datedebutretenue as datedebutretenue"
                . " ,demandepret.datefinretenue as datefinretenue"
                . " FROM demandepret, pret, agents ,sourcepret"
                . " WHERE demandepret.id_agents = agents.id"
                . " and demandepret.id_typepret= pret.id"
                . " and  demandepret.id_sourcepret=sourcepret.id ";

        if ($typepret != '')
            $query.= " AND demandepret.id_typepret = " . $typepret;
        if ($id_source != '')
            $query.= " AND demandepret.id_sourcepret = " . $id_source;
        if ($annee != '')
            $query.= " AND demandepret.annee = " . $annee;
        if ($mois != '')
            $query.= " AND demandepret.mois = " . $mois;
        if ($id_agents != '')
            $query.= " AND demandepret.id_agents = " . $id_agents;

        $query.= " ORDER BY agents.nomcomplet";
        $demandes = $conn->fetchAssoc($query);


        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $html = '<h3>RECAPITULATIF DES DEMANDE DE PRËT ';
        if ($typepret != ''): $html .= "De  " . $type->getLibelle();
        else: $html .= "";
        endif;
        if ($id_source != ''): $html .= "Du " . $source->getLibelle();
        else: $html .= "";
        endif;
        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;
        if ($id_agents != ""): $html .=" De " . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</h3>';
        else :
            $html .= '</h3>';
        endif;


        $html.='&nbsp;<br>&nbsp;<br> <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                   <td style="width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                   <td style="width: 10%;text-align:center;"><label>Matricule</label></td>
                   <td style="width: 15%;text-align:center;"><label>Agents</label></td>      
                   <td style="width: 10%;text-align:center;"><label>Nature des Prêt</label></td>
                   <td style="width: 10%;text-align:center;"><label>Source des Prêt</label></td>
                   <td style="width: 10%;text-align:center;"><label>Montant des Prêt</label></td>
                   <td style="width: 10%;text-align:center;"><label>Nbre de mois</label></td>      
                   <td style="width: 10%;text-align:center;"><label>Retenue Mensuel </label></td>
                   <td style="width: 10%;text-align:center;"><label>Date Début de Prêt </label></td>
                  <td style="width: 10%;text-align:center;"><label>Date Fin de Prêt</label></td>
                            
                    </tr>';
        $i = 1;
        $resultat = 0;
        foreach ($demandes as $demande):
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td>' . $demande['matricule'] . '</td>
                        <td style="text-align:center;">' . $demande['nom'] . '</td>
                        <td style="text-align:center;">' . $demande['typepret'] . '</td>
                        <td style="text-align:center;">' . $demande['sourcepret'] . '</td>        
                       <td style="text-align:center;">' . $demande['montantpret'] . '</td>                        
                        <td style="text-align:center;">' . $demande['nbrmois'] . "mois" . '</td>
                        <td style="text-align:center;">' . $demande['montant'] . '</td>
                        <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande['datedebutretenue']))
                    . '</td>
                       <td style="text-align:center;">' .
                    date('d/m/Y', strtotime($demande['datefinretenue']))
                    . '</td>
                            
                  </tr>';
            $resultat = $resultat + $demande['montant'];
            $i++;
        endforeach;
        $html.='<tr style="font-weight:bold;">
                    <td style="width: 60%;background-color:#ddd"></td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;height:25px;">
                    Total</td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;">
                  ' . number_format($resultat, 3, '.', ' ') . '</td>
                    <td  style="width: 20%;background-color:#ddd"></td>
              
</tr>';
        $html.='</tbody></table>';

        return $html;
    }

}
