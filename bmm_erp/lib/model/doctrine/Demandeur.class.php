<?php

/**
 * Demandeur
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    BmmErpTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Demandeur extends BaseDemandeur {

    public function __toString() {
        return "" . $this->getLibelle();
    }

    public function ReadHtmldemandeur($id_demandeur) {
        $demandeur = DemandeurTable::getInstance()->findOneById($id_demandeur);
        $agent = $demandeur->getAgents();
        $demandeur_contrat = DemandeurTable::getInstance()->getContrat($demandeur->id);
        $html = ' <h3 style="font-size:18px;">Fiche Demandeur<br>Agent : ' . $demandeur->getAgents()->getNomcomplet() . ' ' . $demandeur->getAgents()->getPrenom() . '</h3>
            <h5 style="font-size:4px;">&nbsp;</h5>
            <h4 border="1" style="text-align:center;background-color:#DCDCDC;"><i>Données de Base</i></h4>
            &nbsp;<br>
            <table>
                <tbody>
                    <tr>
                        <td style="width: 20%; border-right: 1px solide #000;"><h4>Données de Base</h4><hr width="96%"></td>
                        <td style="width: 80%;">
                            <table boder="1">
                                <tr>
                                    <td style="width: 16%; height: 25px;"><b>Matricule :</b></td>
                                    <td style="width: 34%;">' . $agent->getIdrh() . '</td>
                                    <td style="width: 15%;"><b>C.I.N :</b></td>
                                    <td style="width: 35%;">' . $agent->getCin() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 10%; height: 20px;"><b>Nom :</b></td>
                                    <td style="width: 40%;">' . $agent->getNomcomplet() . '</td>
                                    <td style="width: 15%;"><b>Prénom :</b></td>
                                    <td style="width: 35%;">' . $agent->getPrenom() . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                <tbody>
            </table>&nbsp;<br>';

        $html.='<h4 border="1" style="text-align:center;background-color:#DCDCDC;"><i>Informations Administratives</i></h4>
                <h5 style="font-size:4px;">&nbsp;</h5>
              
                <table border="1" cellspace="0" cellpadding="3">
                    <tr style="background-color:#ECECEC;">
                        <td style="width:15%;"><b>Nom & Prénom</b></td>
                        <td style="width:10%;"><b>Unité</b></td>
                         <td style="width:25%;"><b>Service</b></td>
                          <td style="width:30%;"><b>Sous Direction</b></td>
                           <td style="width:20%;"><b>Direction</b></td>
                    </tr>';
        $html.='<tr>'
                . '<td style="width:15%;"><b>' . $agent->getNomcomplet() . ' ' . $agent->getPrenom() . '</b></td>';
        if ($demandeur->getIdAgent() && count($demandeur_contrat) >= 1):
            $unite = $agent->getContrat()->getFirst()->getPosterh()->getUnite();
            $html.= '<td style="height:20px;text-align:center;">' . $unite->getLibelle() . '</td>';

            $html.='  <td>' . $agent->getContrat()->getFirst()->getPosterh()->getUnite()->getServicerh()->getLibelle() . '</td>
                        <td>' . $agent->getContrat()->getFirst()->getPosterh()->getUnite()->getServicerh()->getSousdirection()->getLibelle() . '</td>
                        <td style="text-align:center;">' . $agent->getContrat()->getFirst()->getPosterh()->getUnite()->getServicerh()->getSousdirection()->getDirection()->getLibelle() . '</td>';

        else:
            $html.= '<td style = "height:20px;text-align:center;"></td>'
                    . '<td style = "height:20px;text-align:center;"></td>' .
                    '<td style = "height:20px;text-align:center;"></td>' .
                    '<td style = "height:20px;text-align:center;"></td>'
            ;
        endif;
        $html.=' </tr>';



        $html.='</table>';

        return $html;
    }

    public function ReadHtmAlllListeDemandeur(sfWebRequest $request) {

        $libelle = $request->getParameter('libelle', '');
        $id_agents = $request->getParameter('id_agents', '');
        $demandeur_contrat = DemandeurTable::getInstance()->getContrat();

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $q = Doctrine_Core::getTable('demandeur')
                ->createQuery('d')
                ->select(',d.* ,d.libelle as libelle,a.*,a.id as agents_id, Concat(a.nomcomplet, a.prenom) as nom')
                ->from('Demandeur d')
                ->leftJoin('d.Agents a');
        if ($id_agents != '')
            $q->where('d.id_agent = ' . $id_agents);
        if ($libelle != '' || $libelle != null)
            $q->andWhere("d.libelle  like '%" . $libelle . "%'");

//      
        $q->orderBy('libelle');

        $agents = $q->execute();

        $html = '<h3>Liste des Demandeurs</h3>
                    &nbsp;<br>
                    <table border="1" cellpadding="3">
                        <tr>
                            <td style="width:100%;">
                                <span style="margin-top:10px; color:#000;font-weight:bold;font-size:14px;">Recherche suivant :</span>
                                <ul style="width:100%;">';


        if ($libelle != ''):
            $html.='<li> Libellé : ' . $libelle . '</li>';
        else:
            $html.='<li> Libellé : - </li>';
        endif;

        if ($id_agents != ''):
            $agent = AgentsTable::getInstance()->findOneById($id_agents);
            $html.='<li> Agents : ' . $agent->getIdrh() . ' ' . $agent->getNomcomplet() . ' ' . $agent->getPrenom() . '</li>';
        else:
            $html.='<li> Agents : - </li>';
        endif;

        $html.='</ul> </td> </tr></table>&nbsp;
        <br>
        <table border = "1" cellpadding = "3">
            <tbody>
                <tr style="background-color:#EDEDED;font-weight:bold;">
                    <td style="width:5%;text-align:center;height:30px;font-size:14px;"><label>N°</label></td>
                    <td style="width:15%;text-align:center;"><label>Libellé</label></td>
                    <td style="width:15%;text-align:center;"><label>Agents</label></td>
                    <td style="width:10%;text-align:center;"><label>Regr</label></td>
                    <td style="width:10%;text-align:center;"><label>Unité</label></td>
                    <td style="width:15%;text-align:center;"><label>Service</label></td>
                     <td style="width:15%;text-align:center;"><label>Sous Direction</label></td>
                      <td style="width:15%;text-align:center;"><label>Direction</label></td>
                </tr>';
        $i = 1;
        foreach ($agents as $agent_d):
            $html.='<tr>
                        <td style="width:5%;text-align:center;">' . $i . '</td>
                        <td style="width:15%;text-align:left;">' . $agent_d->getLibelle() . '</td>
                        ';
            if ($agent_d->getIdAgent()):
                $html.='<td style="width:15%;text-align:left;">' . $agent_d->getAgents()->getIdrh() . ' ' . $agent_d->getAgents()->getNomcomplet() . " " . $agent_d->getAgents()->getPrenom() . '</td>';
              else: 
                $html.='<td></td>';
            endif; 
            if( $agent_d->getIdAgent() && $agent_d->getAgents()->getIdRegrouppement()):
             $html.='<td style = "width:10%;text-align:left;">' .
                        $agent_d->getAgents()->getRegroupementagents()->getLibelle() .
                     ' </td>';
            else: $html.='<td></td>';
            endif;
            if (count($demandeur_contrat) >= 1):

                $html.= ' < td style = "width:10%;text-align:left;">' .
                        $agent_d->getAgents()->getContrat()->getLast()->getPosterh()->getUnite()->getLibelle()
                        . ' < / td>';
                $html.= ' <td style = "width:15%;text-align:left;">' .
                        $agent_d->getAgents()->getContrat()->getLast()->getPosterh()->getUnite()->getServicerh()->getLibelle() .
                        ' < / td>
                        <td style = "width:15%;text-align:left;">' .
                        $agent_d->getAgents()->getContrat()->getLast()->getPosterh()->getUnite()->getServicerh()->getSousdirection()->getLibelle() .
                        ' < / td>
                        <td style = "width:15%;text-align:left;">' .
                        $agent_d->getAgents()->getContrat()->getLast()->getPosterh()->getUnite()->getServicerh()->getSousdirection()->getDirection()->getLibelle() .
                        ' < / td>'
                ;
            else:
                $html.= '<td style = "width:10%;text-align:left;"></td>
                        <td style = "width:15%;text-align:left;"></td>
                        <td style = "width:15%;text-align:left;"></td>
                        <td style = "width:15%;text-align:left;"></td>'
                ;
            endif;
            $html.= '</tr>';
            $i++;
        endforeach;
        $html.='</tbody>
            </table>';
        return $html;
    }

}
