
<?php

/**
 * Documentbudget
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    BmmErpTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Documentbudget extends BaseDocumentbudget {

    public function __toString() {
        return "" . $this->getTypedocbudget() . " N° " . $this->getNumero();
    }

    public function getDocumentachat() {
        $p = new Piecejointbudget();
        $piecejoint = Doctrine_Core::getTable('piecejointbudget')->findOneByIdDocumentbudget($this->getId());
        if ($piecejoint) {
            $p = $piecejoint;
            return $p->getDocumentachat();
        }
        return null;
    }

    public function getTitrebudget() {
        if (!$this->getLigprotitrub()) {
            return "";
        }
        $titre = TitrebudjetTable::getInstance()->findOneById($this->getLigprotitrub()->getIdTitre());
        return $titre;
    }

    public function getRubriqueparent() {

        if (!$this->getLigprotitrub()) {
            return "";
        }
        if ($this->getLigprotitrub()->getRubrique()->getIdRubrique())
            $rubrique = RubriqueTable::getInstance()->findOneById($this->getLigprotitrub()->getRubrique()->getIdRubrique());
        elseif ($this->getLigprotitrub()->getRubrique()->getId())
            $rubrique = RubriqueTable::getInstance()->findOneById($this->getLigprotitrub()->getRubrique()->getId());
        if ($rubrique)
            return $rubrique;
        return "";
    }

    public function getSousRubriqueBudgetaire() {
        if (!$this->getLigprotitrub()) {
            $rubrique = null;
        }
        if ($this->getLigprotitrub()->getRubrique()->getIdRubrique())
            $rubrique = RubriqueTable::getInstance()->findOneById($this->getLigprotitrub()->getRubrique()->getId());
        return $rubrique;
    }

    public function NumeroSeqDocumentAchat($idtype) {
        $years = date('y');
        if (isset($_SESSION['exercice_budget'])) {
            $maxdate = $_SESSION['exercice_budget'] . "-12-31";
            $mindate = $_SESSION['exercice_budget'] . "-01-01";
        } else {
            $maxdate = date("Y") . "-12-31";
            $mindate = date('Y') . "-01-01";
        }

        $doc = Doctrine_Query::create()
                        ->select('COALESCE(MAX(a.numero), 0) as numero')
                        ->from('Documentbudget a')
                        ->where('id_type=' . $idtype)
                        ->andwhere("datecreation <='" . date('Y-m-d', strtotime($maxdate)) . "'")
                        ->andwhere("datecreation >='" . date('Y-m-d', strtotime($mindate)) . "'")
                        ->execute()->getFirst();
        if ($doc->getNumero() == 0) {
            return $idtype . $years . sprintf('%05d', 1);
        } else {
            $numero = $doc->getNumero();
            $numero++;
            return $numero;
        }
    }

    public function getNumerodocachat() {
        return $this->getNumero();
    }

    //getHtmlDocProvisoirecaisse


    function random_color_part() {
        return str_pad(dechex(mt_rand(0, 255)), 2, '0', STR_PAD_LEFT);
    }

    function random_color() {
        return $this->random_color_part() . $this->random_color_part() . $this->random_color_part();
    }

    public function getListesDocumentAchatByDocumentBudget() {
        $piece = new Piecejointbudget();
        $numeroDocAchat = "";
        $lites_pieces = Doctrine_Core::getTable('piecejointbudget')->findByIdDocumentbudget($this->getId());
        $i = 0;
        foreach ($lites_pieces as $p) {
            $piece = $p;
            //style="color:#' . $this->random_color() . '"
            $numeroDocAchat .= '' . $piece->getDocumentachat()->getNumerodocachat() . "";
            if ($i < count($lites_pieces) - 1)
                $numeroDocAchat .= '-';
            $i++;
        }
        //die($numeroDocAchat.'jj');
        return $numeroDocAchat;
    }

    public function getHtmlDocProvisoireBDC($iddoc, $idtype) {
        $html = '';
        $docachat = DocumentachatTable::getInstance()->find($iddoc);
        $quitance_prov = LigneoperationcaisseTable::getInstance()->findByIdDocachatAndIdCategorie($docachat->getId(), 1);
        $piecejoint_prov = PiecejointbudgetTable::getInstance()->findByIdDocachatAndIdType($iddoc, 4);
        $engagementprovisoire = DocumentbudgetTable::getInstance()->find($piecejoint_prov->getFirst()->getIdDocumentbudget());
        //       $html.='eeeeeeeeeeee'.  sizeof($piecejoint_prov)."edf".$iddoc."vfd".$piecejoint_prov->getFirst()->getIdDocumentbudget();
        $date = date('Y', strtotime($this->getLigprotitrub()->getTitrebudjet()->getDatecreation()));
        $type_text = 'Provisoire';
        if ($this->getIdType() == 1)
            $type_text = 'Définitif';
        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement ' . $type_text . '</h3>
            <table border="1" style="padding:1%">
                <tbody>                                 
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' . $this->getNumerodocachat() . '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td><label>Etat || Type Document </label></td>
                        <td>' . $this->getTypedocbudget() . '</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>Informations sur le Budget</h3>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $this->getLigprotitrub()->getTitrebudjet()->getLibelle() . '</td>
                    </tr>
                    <tr>
                        <td><label>Rubrique</label></td>
                        <td>' . $this->getLigprotitrub()->getRubrique() . '</td>
                    </tr>';

        $sousrubrique = Doctrine_Core::getTable('rubrique')->findOneByIdRubrique($this->getLigprotitrub()->getIdRubrique());
        if ($sousrubrique)
            $html .= '<tr>
                        <td><label>Sous Rubrique</label></td>
                        <td>' . $sousrubrique->getLibelle() . '</td>
                    </tr>';

        $html .= '     <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' .
                $this->getListesDocumentAchatByDocumentBudget() . '</td>
                    </tr>
                    <tr>
                        <td><label>Mnt.</label></td>';
        if (sizeof($engagementprovisoire) >= 1)
            $html .= '<td colspan="3">' . number_format($engagementprovisoire->getMnt(), 3, ",", " ") . ' TND</td>';
        $html .= '</tr>
                    <tr>
                        <td><label>Mnt Engagé</label></td>
                        <td colspan="3">' . number_format($engagementprovisoire->getMntengage(), 3, ",", " ") . ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  Engagé</label></td>
                        <td>' . number_format($engagementprovisoire->getMntrelicat(), 3, ",", " ") . ' TND</td>
                    </tr>
                </tbody>
            </table>';

        return $html;
    }

    public function getHtmlDocProvisoire($iddoc, $idtype) {
        $html = '';
        if ($iddoc) {
            $docachat = DocumentachatTable::getInstance()->find($iddoc);
        }
        $date = date('Y', strtotime($this->getLigprotitrub()->getTitrebudjet()->getDatecreation()));
        $type_text = 'Provisoire';
        if ($this->getIdType() == 1)
            $type_text = 'Définitif';
        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement ' . $type_text . '</h3>
            <table border="1" style="padding:1%">
                <tbody>
                 
                 
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' . $this->getNumerodocachat() . '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td><label>Etat || Type Document </label></td>
                        <td>' . $this->getTypedocbudget() . '</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>Informations sur le Budget</h3>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $this->getLigprotitrub()->getTitrebudjet()->getLibelle() . '</td>
                    </tr>
                    <tr>
                    <td><label>Rubrique</label></td>
                    <td>' . $this->getRubriqueparent() . '</td>
                </tr>';


        if ($this->getLigprotitrub()->getRubrique()->getSousRubriqueBudgetaire())
            $html .= '<tr>
                <td><label>Sous Rubrique</label></td>
                <td>' . $this->getLigprotitrub()->getRubrique()->getSousRubriqueBudgetaire()->getLibelle() . '</td>
            </tr>';
        // $doc_achat->getNumerodocumentachat() .

        if ($iddoc) {
            $html .= '     <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' .
                    $this->getListesDocumentAchatByDocumentBudget() . '</td>
                    </tr>';
        }
        $html .= '     <tr>
                        <td><label>Mnt. Engagement</label></td>
                        <td colspan="3">' . number_format($this->getMnt(), 3, ",", " ") . ' TND</td>
                    </tr>
                    <tr>
                        <td><label>Mnt rubrique engagé</label></td>
                        <td colspan="3">' . number_format($this->getMntengage(), 3, ",", " ") . ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  rubrique engagé</label></td>
                        <td>' . number_format($this->getMntrelicat(), 3, ",", " ") . ' TND</td>
                    </tr>
                </tbody>
            </table>';

        return $html;
    }

    public function getHtmlDocProvisoireAvenant($iddoc, $doc_budget, $idtype) {
        $html = '';
        $date = date('Y', strtotime($this->getLigprotitrub()->getTitrebudjet()->getDatecreation()));
        $type_text = 'provisoire';
        if ($this->getIdType() == 1)
            $type_text = 'définitif';
        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement de L\'Avenant du Contrat' . $type_text . '</h3>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' . $this->getNumerodocachat() . '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td><label>Etat || Type Document </label></td>
                        <td>' . $this->getTypedocbudget() . '</td>
                    </tr>
                     <tr>
                        <td><label>Montant Avenant </label></td>
                        <td>' . number_format($this->getMntnet(), 3, ",", " ") . '</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>Informations sur le Budget</h3>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $this->getLigprotitrub()->getTitrebudjet()->getLibelle() . '</td>
                    </tr>
                    <tr>
                        <td><label>Rubrique</label></td>
                        <td>' . $this->getLigprotitrub()->getRubrique() . '</td>
                    </tr>';

        $sousrubrique = Doctrine_Core::getTable('rubrique')->findOneByIdRubrique($this->getLigprotitrub()->getIdRubrique());
        if ($sousrubrique)
            $html .= '<tr>
                        <td><label>Sous Rubrique</label></td>
                        <td>' . $sousrubrique->getLibelle() . '</td>
                    </tr>
                    <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' . $this->getListesDocumentAchatByDocumentBudget() . '</td>
                    </tr>
                    <tr>
                        <td><label>Mnt.</label></td>
                        <td colspan="3">' . number_format($this->getMnt(), 3, ",", " ") . ' TND</td>
                    </tr>
                    <tr>
                        <td><label>Mnt Engagé</label></td>
                        <td colspan="3">' . number_format($this->getMntengage(), 3, ",", " ") . ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  Engagé</label></td>
                        <td>' . number_format($this->getMntrelicat(), 3, ",", " ") . ' TND</td>
                    </tr>
                </tbody>
            </table>';
        $piecejointbudget = PiecejointbudgetTable::getInstance()->findByIdDocachatAndIdType($iddoc, 1);
        $html .= ' <h3>Informations sur le Budget Du Contrat</h3>'
                . ' <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' . $piecejointbudget->getLast()->getDocumentbudget()->getNumerodocachat() . '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>' . date('d/m/Y', strtotime($piecejointbudget->getLast()->getDocumentbudget()->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td><label>Etat || Type Document </label></td>
                        <td>' . $piecejointbudget->getLast()->getDocumentbudget()->getTypedocbudget() . '</td>
                    </tr>
                     <tr>
                        <td><label>Montant Contrat </label></td>
                        <td>' . number_format($piecejointbudget->getLast()->getDocumentbudget()->getMntnet(), 3, ",", " ") . '</td>
                    </tr>
                </tbody>
            </table>';

        return $html;
    }

    //*************** Affectation de fiche prengagment *****************/
    public function NouvelleficheEngagementProvisoire($ligne, $numero, $idtype, $datecreation, $idbudget, $mnt, $mntengager) {
        $doc = new Documentbudget();
        if (isset($_SESSION['exercice_budget'])) {
            $maxdate = $_SESSION['exercice_budget'] . "-12-31";
            $mindate = $_SESSION['exercice_budget'] . "-01-01";
        } else {
            $maxdate = date("Y") . "-12-31";
            $mindate = date('Y') . "-01-01";
        }
        $documentbudget = DocumentbudgetTable::getInstance()->getDocumentByNumeroInPeriode($mindate, $maxdate, $numero);
        if (!$documentbudget) {
            $relicat = 0;
            $doc->setIdType($idtype);
            $doc->setNumero($numero);
            $doc->setDatecreation($datecreation);
            $doc->setIdBudget($idbudget);
            $doc->setMnt($mnt);
            $doc->setMntnet($mnt);
            $doc->setMntengage($mntengager);
            $relicat = $ligne->getMnt() - ($ligne->getMntprovisoire() + $ligne->getMntengage());
            $doc->setMntrelicat($relicat);
            $doc->save();
        } else {
            $doc = $documentbudget;
        }
        return $doc;
    }

    public function ReadHtmlOrdonnanceComp($id, $id_docachat) {

        $ordonnance = DocumentbudgetTable::getInstance()->find($id);
        $rubrique = $ordonnance->getLigprotitrub();
        $titre_budget = $rubrique->getTitrebudjet();
        $lignebanquecaisse = $rubrique->getLignebanquecaisse()->getFirst();
        if ($lignebanquecaisse)
            $compte = $lignebanquecaisse->getCaissesbanques();
        else
            $compte = null;

        $montant_facture = "";
        $numero_engagement = "";
        $fournisseur = "";
        $piecejointe_budget = $ordonnance->getPiecejointbudget()->getFirst();
        if ($piecejointe_budget) {
            $facture = $piecejointe_budget->getDocumentachat();
            if ($facture->getIdTypedoc() == 22 || $facture->getIdTypedoc() == 15) {
                $mouvementcaisse = LigneoperationcaisseTable::getInstance()->findByIdDocachat($facture->getId())->getFirst();
            } else {
                $fournisseur = $facture->getFournisseur();
                $montant_facture = $facture->getMntttc();
                $engagement = $societe = Doctrine_Query::create()
                                ->select('*')
                                ->from('Documentbudget db')
                                ->leftJoin('db.Piecejointbudget pjb')
                                ->where('db.id_type = 1')
                                ->andWhere('pjb.id_docachat = ' . $facture->getId())
                                ->execute()->getFirst();

                if ($engagement) {
                    $numero_engagement = $engagement->getNumero();
                }
            }
        }
       
        //        die($ordonnance->getId() . 'mmm');
        //        $certificat = $ordonnance->getCertificatretenue()->getFirst();
        if ($ordonnance->getIdDocumentbudget() != null)
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getIdDocumentbudget());
        else {
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getId());
        }

        if ($certificat)
            $montant_facture = $certificat->getMontantordonnancenet();

        $mouvementbanciare = MouvementbanciareTable::getInstance()->findOneByIdDocumentbudget($id);
        $objet = "";
        if ($mouvementbanciare) :
            $montant_reglement = $mouvementbanciare->getDebit();
            $objet = $mouvementbanciare->getNomoperation();
        else :
            $montant_reglement = $montant_facture;
        endif;


        $label_montant_facture = "Montant de la Facture : ";

        if ($ordonnance->getIdDocumentbudget() != null) {
            $ordonnance_parent = DocumentbudgetTable::getInstance()->find($ordonnance->getIdDocumentbudget());
            $montant_reglement = $ordonnance->getMntnet();
            $label_montant_facture = "Montant : ";
            $objet = "Déclaration du retenue à la source de l'ordonnance <b>N°" . $ordonnance_parent->getNumero() . "</b> créée le <b>" . date('d/m/Y', strtotime($ordonnance_parent->getDatecreation())) . "</b>";
        }


        $html = '<style>td{height:22px;}</style>';

        $html .= '<table style="width:100%;">
                    <tr>
                        <td style="width:35%;text-align:center;">
                            OFFICE DE DEVELOPPEMENT<br>
                            DE RJIM MAATOUG<br>
                            KEBILI
                        </td>
                        <td style="width:65%;"></td>
                    </tr>
                </table>';
 
        $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;"><u>ORDONNANCE DE PAIEMENT</u></div>
                    <div style="text-align:right">DATE : ' . date('d/m/Y') . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
                    <div style="text-align:center;font-size:14px;font-weight:bold;">N° ' . $ordonnance->getNumero() . '</div>
                </div>';

        $html .= '<table style="width:100%;" border="1" cellpadding="3">
                    <tr>
                        <td style="width:50%">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">IMPUTATION BUDGETAIRE</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>Exercice : ' . str_replace("Exercice:", "", trim($titre_budget->getTypebudget())) . '</td>
                                </tr>
                                <tr>
                                    <td>Catégorie : ' . trim($titre_budget->getCategorietitre()) . '</td>
                                </tr>
                                <tr>
                                    <td>Budget : ' . $titre_budget->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>N° D\'engagement : ' . $numero_engagement . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Rubrique : ' . $rubrique->getRubrique()->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits alloués : ' . number_format($rubrique->getMnt(), 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits consommés : ' . number_format(abs($ordonnance->getMntengage()), 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td>
                                        <table>
                                            <tr>
                                                <td style="width:19%">Reliquat :</td>
                                                <td style="width:18%">
                                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                                </td>
                                                <td style="width:63%"></td>
                                            </tr>
                                        </table>
                                        
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <table cellpadding="3">
                                            <tr>
                                                <td style="width:50%;text-align:center;height:70px;"></td>
                                                <td style="width:50%;text-align:center;">Signature</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:50%" rowspan="2">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">MODE DE REGLEMENT</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>' . $label_montant_facture . number_format($montant_reglement, 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Objet : ' . $objet . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Fournisseur : ' . $fournisseur . '</td>
                                </tr>';

        if ($mouvementbanciare) :
            //Compte Bancaire
            $compte = $mouvementbanciare->getCaissesbanques();
            if ($compte) :
                $label_compte = $compte->getLibelle() . ' ' . $compte->getCodecb();
            else :
                $label_compte = "";
            endif;
            $cheque_existe = "";
            $cheque_numero = "";
            $cheque_du = "";
            $virement_existe = "";
            $virement_numero = "";
            $virement_du = "";
            if ($mouvementbanciare->getIdInstrument() == 1 || $mouvementbanciare->getIdInstrument() == 2) {
                $cheque_existe = "X";
                $cheque_numero = $mouvementbanciare->getPapiercheque()->getRefpapier();
                if ($mouvementbanciare->getPapiercheque()->getDatesignature() != null)
                    $cheque_du = date('d/m/Y', strtotime($mouvementbanciare->getPapiercheque()->getDatesignature()));
            } else if ($mouvementbanciare->getIdInstrument() == 3 || $mouvementbanciare->getIdInstrument() == 4) {
                $virement_existe = "X";
                $virement_numero = $mouvementbanciare->getReferenceautre();
                if ($mouvementbanciare->getDateoperation() != null)
                    $virement_du = date('d/m/Y', strtotime($mouvementbanciare->getDateoperation()));
            }

            $html .= '<tr>
                        <td>
                            Payée par :<br>
                            <table cellpadding="3">
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $cheque_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Chèque N° : ' . $cheque_numero . '</td>
                                    <td style="width:35%">du : ' . $cheque_du . '</td>
                                </tr>
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $virement_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Virement N° : ' . $virement_numero . '</td>
                                    <td style="width:35%">du : ' . $virement_du . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>Sur CCB N° : ' . $label_compte . '</td>
                    </tr>
                    <tr>
                        <td style="height:40px;">Solde disponible : ' . number_format($rubrique->getRelicaengager(), 3, ',', ' ') . '</td>
                    </tr>
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <td style="width:18%">
                                        <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                    </td>
                                    <td style="width:82%">Caisse : </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>Solde disponible : </td>
                    </tr>';
        elseif ($mouvementcaisse) :
            //Caisse
            $caisse = $mouvementcaisse->getCaissesbanques();
            $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $caisse->getLibelle() . ' ' . $caisse->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : ' . number_format($caisse->getMntdefini(), 3, ',', ' ') . '</td>
                </tr>';
        else :
            if ($compte) :
                //S'il n'y a pas de Compte Bancaire ou Caisse
                //Compte Bancaire
                if ($compte->getIdTypecb() == 2) :
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : </td>
                </tr>';
                else :
                    //Caisse
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : </td>
                </tr>';
                endif;
            else :
                //Si pas de Compte Bancaire ou Caisse
                $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : </td>
                </tr>';
            endif;
        endif;

        $html .= '<tr>
                                    <td>
                                        <table cellpadding="3">
                                            <tr>
                                                <td style="width:50%;text-align:center;"></td>
                                                <td style="width:50%;text-align:center;height:70px;">Signature</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>';

        //Zone Certificat de Retenue à la Source
        if ($certificat) :
            $html .= '<tr>
                        <td style="width:50%">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">Certificat de Retenue</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>1) Certificat de Retenue .............................................</td>
                                </tr>
                                <tr>
                                    <td>2) Recap. de Règlement des Factures .......................</td>
                                </tr>
                                <tr>
                                    <td>3) ...............................................................................</td>
                                </tr>
                                <tr>
                                    <td>4) ...............................................................................</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>&nbsp;<br>';
        else :
            $html .= '<tr>
                        <td style="width:50%">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">Certificat de Retenue</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>1) ...............................................................................</td>
                                </tr>
                                <tr>
                                    <td>2) ...............................................................................</td>
                                </tr>
                                <tr>
                                    <td>3) ...............................................................................</td>
                                </tr>
                                <tr>
                                    <td>4) ...............................................................................</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>&nbsp;<br>';
        endif;

        $html .= '<table border="1" cellpadding="3">
                    <tr>
                        <td style="width:100%;text-align:center;font-weight:bold;">Pièces Jointes</td>
                    </tr>
                    <tr>
                        <td style="width:30%;text-align:center;">B.C</td>
                        <td style="width:30%;text-align:center;">P.V.R / R.R.S</td>
                        <td style="width:40%;text-align:center;">Facture</td>
                    </tr>
                    <tr>
                        <td style="width:15%;text-align:center;">N°</td>
                        <td style="width:15%;text-align:center;">DATE</td>
                        
                        <td style="width:15%;text-align:center;">N°</td>
                        <td style="width:15%;text-align:center;">DATE</td>
                        <td style="width:12%;text-align:center;">N°</td>
                        <td style="width:12%;text-align:center;">DATE</td>
                        <td style="width:16%;text-align:center;">MONTANT</td>
                    </tr>';
        $j = 0;
        $resultat = 0;
        if ($certificat) :
            foreach ($ordonnance->getPiecejointbudget() as $piece) :
                $doc_achat = $piece->getDocumentachat();
                $ligne_mouvement_facture = $doc_achat->getLignemouvementfacturation()->getFirst();
                if (sizeof($ligne_mouvement_facture) >= 1) :
                    $piece_joint_budgets = $doc_achat->getPiecejointbudget()->getFirst();
                    $certifacat_bdcrergs = CertificatretenueTable::getInstance()->findByIdDocumentbudget($piece_joint_budgets->getDocumentbudget()->getId());
                    foreach ($certifacat_bdcrergs as $certifacat_bdcrerg) :
                        $html .= '<tr style="font-size:10px;">
                        <td style="width:15%;text-align:center;">' . $doc_achat->getNumero() . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($doc_achat->getDatecreation())) . '</td>
                        
                        <td style="width:15%;text-align:center;">' . trim($ligne_mouvement_facture->getPvr()) . '/' . trim($ligne_mouvement_facture->getRrs()) . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDaterrspvr())) . '</td>
                        <td style="width:12%;text-align:center;">' . $ligne_mouvement_facture->getNumerofacture() . '</td>
                        <td style="width:12%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDate())) . '</td>
                        <td style="width:16%;text-align:right;">' . number_format($certifacat_bdcrerg->getMontantordonnancenet(), 3, ',', ' ') . '</td>
                    </tr>';
                        $resultat = $resultat + $certifacat_bdcrerg->getMontantordonnancenet();
                    endforeach;
                    $j++;
                endif;
            endforeach;
        else :
            foreach ($ordonnance->getPiecejointbudget() as $piece) :
                $doc_achat = $piece->getDocumentachat();
                $ligne_mouvement_facture = $doc_achat->getLignemouvementfacturation()->getFirst();
                if ($doc_achat->getIdTypedoc() == 15) {
                    $piece_joint_budget = $doc_achat->getPiecejointbudget()->getFirst();
                    $document_budget = $piece_joint_budget->getDocumentbudget();
                    $ligne = $document_budget->getLigprotitrub();
                    $mnt_tva = $doc_achat->getMnttva() / 4;
                    //                    if($certificat){
                    //                    $mnt_retenue = ($doc_achat->getMntttc() * $certificat->getRetenuesource()->getValeurretenue()) / 100;
                    //                    $mnt_net = $doc_achat->getMntttc() - $mnt_tva - $mnt_retenue;}
                }
                //              die(sizeof($ligne_mouvement_facture).'mp'.$ligne_mouvement_facture);
                if (sizeof($ligne_mouvement_facture) >= 1) :
                    if ($doc_achat->getIdTypedoc() != 16 && $doc_achat->getIdTypedoc() != 7) {
                        //                        $bce = $doc_achat->getDocumentachat()->getFirst();
                        $id_docparent = $doc_achat->getIdDocparent();
                        $bce = DocumentachatTable::getInstance()->findOneById($id_docparent);
                        //                        die(sizeof($bce).'gg'.$id_docparent."lk".$doc_achat->getIdDocparent());
                    } else
                        $bce = $doc_achat;

                    if ($bce != null)
                        $id_type_doc = $bce->getIdTypedoc();
                    $id_doc_parent = $bce->getIdDocparent();
                    //                    die($id_doc_parent.'mp'.$id_type_doc.$bce->getId());
                    while (!($id_type_doc == '16' || $id_type_doc == '7')) :
                        if ($id_doc_parent != null) :
                            $doc_anticident = DocumentachatTable::getInstance()->findOneById($id_doc_parent);
                            $bce = $doc_anticident;
                        endif;
                    endwhile;

                    $html .= '<tr style="font-size:10px;">
                        <td style="width:15%;text-align:center;">' . $bce->getNumero() . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($bce->getDatecreation())) . '</td>
                        
                        <td style="width:15%;text-align:center;">' . trim($ligne_mouvement_facture->getPvr()) . '/' . trim($ligne_mouvement_facture->getRrs()) . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDaterrspvr())) . '</td>
                        <td style="width:12%;text-align:center;">' . $ligne_mouvement_facture->getNumerofacture() . '</td>
                        <td style="width:12%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDate())) . '</td>
                        <td style="width:16%;text-align:right;">' . number_format($ligne_mouvement_facture->getMontant(), 3, ',', ' ') . '</td>
                    </tr>';
                    $resultat = $resultat + $ligne_mouvement_facture->getMontant();
                    $j++;
                endif;
            endforeach;

        endif;

        for ($i = $j; $i < 3; $i++) :
            $html .= '<tr>
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:15%;text-align:center;"></td>
                        
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:12%;text-align:center;"></td>
                        <td style="width:12%;text-align:center;"></td>
                        <td style="width:16%;text-align:right;"></td>
                    </tr>';
        endfor;
        $html .= '<tr>
                        <td style="width:84%;text-align:center;"colspan="4">Total</td>
                        
                        
                        
                        <td style="width:16%;text-align:right;">' . number_format($resultat, 3, ',', ' ') . '</td>
                    </tr>';
        $html .= '</table>';

        $html .= '<table cellpadding="3">
                    <tr>
                        <td style="width:50%;text-align:center;">S/Financier</td>
                        <td style="width:50%;text-align:center;">D.A.F</td>
                    </tr>
                </table>';

        return $html;
    }

    public function ReadHtmlOrdonnance($id) {
        $ordonnance = DocumentbudgetTable::getInstance()->find($id);
        $rubrique = $ordonnance->getLigprotitrub();
        $titre_budget = $rubrique->getTitrebudjet();
        $lignebanquecaisse = $rubrique->getLignebanquecaisse()->getFirst();
        if ($lignebanquecaisse)
            $compte = $lignebanquecaisse->getCaissesbanques();
        else
            $compte = null;

        $montant_facture = "";
        $numero_engagement = "";
        $fournisseur = "";
        $piecejointe_budget = $ordonnance->getPiecejointbudget()->getFirst();

        if ($piecejointe_budget) {
            if ($piecejointe_budget->getIdDocachat()) {
                $facture = $piecejointe_budget->getDocumentachat();
                if ($facture->getIdTypedoc() == 2 || $facture->getIdTypedoc() == 15) {
                    $mouvementcaisse = LigneoperationcaisseTable::getInstance()->findByIdDocachat($facture->getId())->getFirst();
                } else {
                    $fournisseur = $facture->getFournisseur();
                    $montant_facture = $facture->getMntttc();
                    $engagement = $societe = Doctrine_Query::create()
                                    ->select('*')
                                    ->from('Documentbudget db')
                                    ->leftJoin('db.Piecejointbudget pjb')
                                    ->where('db.id_type = 1')
                                    ->andWhere('pjb.id_docachat = ' . $facture->getId())
                                    ->execute()->getFirst();

                    if ($engagement) {
                        $numero_engagement = $engagement->getNumero();
                    }
                }
            }
        }
        if ($ordonnance->getIdDocumentbudget() != null)
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getIdDocumentbudget());
        else {
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getId());
        }
        if ($certificat)
            $montant_facture = $certificat->getMontantordonnancenet();
        $mouvementbanciare = MouvementbanciareTable::getInstance()->findOneByIdDocumentbudget($id);
        $objet = "";
        if ($mouvementbanciare) :
            $montant_reglement = $mouvementbanciare->getDebit();
            $objet = $mouvementbanciare->getNomoperation();
        else :
            $montant_reglement = $montant_facture;
        endif;
        $label_montant_facture = "Montant de la Facture : ";
        if ($ordonnance->getIdDocumentbudget() != null) {
            $ordonnance_parent = DocumentbudgetTable::getInstance()->find($ordonnance->getIdDocumentbudget());
            $montant_reglement = $ordonnance->getMntnet();
            $label_montant_facture = "Montant : ";
            $objet = "Déclaration du retenue à la source de l'ordonnance <b>N°" . $ordonnance_parent->getNumero() . "</b> créée le <b>" . date('d/m/Y', strtotime($ordonnance_parent->getDatecreation())) . "</b>";
        }

        if ($ordonnance->getIdDocumentbudget() != null)
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getIdDocumentbudget());
        else {
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getId());
        }

        if ($certificat)
            $montant_facture = $certificat->getMontantordonnancenet();

        $mouvementbanciare = MouvementbanciareTable::getInstance()->findOneByIdDocumentbudget($id);
        $objet = "";
        if ($mouvementbanciare) :
            $montant_reglement = $mouvementbanciare->getDebit();
            $objet = $mouvementbanciare->getNomoperation();
        else :
            $montant_reglement = $montant_facture;
        endif;


        $label_montant_facture = "Montant de la Facture : ";

        if ($ordonnance->getIdDocumentbudget() != null) {
            $ordonnance_parent = DocumentbudgetTable::getInstance()->find($ordonnance->getIdDocumentbudget());
            $montant_reglement = $ordonnance->getMntnet();
            $label_montant_facture = "Montant : ";
            $objet = "Déclaration du retenue à la source de l'ordonnance <b>N°" . $ordonnance_parent->getNumero() . "</b> créée le <b>" . date('d/m/Y', strtotime($ordonnance_parent->getDatecreation())) . "</b>";
        }

        $html = '<style>td{height:22px;}</style>';

        $html .= '<table style="width:100%;">
                    <tr>
                        <td style="width:35%;text-align:center;">
                            OFFICE DE DEVELOPPEMENT<br>
                            DE RJIM MAATOUG<br>
                            KEBILI
                        </td>
                        <td style="width:65%;"></td>
                    </tr>
                </table>';

        $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;"><u>ORDONNANCE DE PAIEMENT</u></div>
                    <div style="text-align:right">DATE : ' . date('d/m/Y') . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
                    <div style="text-align:center;font-size:14px;font-weight:bold;">N° ' . $ordonnance->getNumero() . '</div>
                </div>';

        $html .= '<table style="width:100%;" border="1" cellpadding="3">
                    <tr>
                        <td style="width:50%">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">IMPUTATION BUDGETAIRE</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>Exercice : ' . str_replace("Exercice:", "", trim($titre_budget->getTypebudget())) . '</td>
                                </tr>
                                <tr>
                                    <td>Catégorie : ' . trim($titre_budget->getCategorietitre()) . '</td>
                                </tr>
                                <tr>
                                    <td>Budget : ' . $titre_budget->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>N° D\'engagement : ' . $numero_engagement . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Rubrique : ' . $rubrique->getRubrique()->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits alloués : ' . number_format($rubrique->getMnt(), 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits consommés : ' . number_format(abs($ordonnance->getMntengage()), 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td>
                                        <table>
                                            <tr>
                                                <td style="width:19%">Reliquat :</td>
                                                <td style="width:18%">
                                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                                </td>
                                                <td style="width:63%"></td>
                                            </tr>
                                        </table>
                                        
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <table cellpadding="3">
                                            <tr>
                                                <td style="width:50%;text-align:center;height:70px;"></td>
                                                <td style="width:50%;text-align:center;">Signature</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="width:50%" rowspan="2">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">MODE DE REGLEMENT</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>' . $label_montant_facture . number_format($montant_reglement, 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Objet : ' . $objet . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Fournisseur : ' . $fournisseur . '</td>
                                </tr>';
        if ($mouvementbanciare) :
            //Compte Bancaire
            $compte = $mouvementbanciare->getCaissesbanques();
            if ($compte) :
                $label_compte = $compte->getLibelle() . ' ' . $compte->getCodecb();
            else :
                $label_compte = "";
            endif;
            $cheque_existe = "";
            $cheque_numero = "";
            $cheque_du = "";
            $virement_existe = "";
            $virement_numero = "";
            $virement_du = "";
            if ($mouvementbanciare->getIdInstrument() == 1 || $mouvementbanciare->getIdInstrument() == 2) {
                $cheque_existe = "X";
                $cheque_numero = $mouvementbanciare->getPapiercheque()->getRefpapier();
                if ($mouvementbanciare->getPapiercheque()->getDatesignature() != null)
                    $cheque_du = date('d/m/Y', strtotime($mouvementbanciare->getPapiercheque()->getDatesignature()));
            } else if ($mouvementbanciare->getIdInstrument() == 3 || $mouvementbanciare->getIdInstrument() == 4) {
                $virement_existe = "X";
                $virement_numero = $mouvementbanciare->getReferenceautre();
                if ($mouvementbanciare->getDateoperation() != null)
                    $virement_du = date('d/m/Y', strtotime($mouvementbanciare->getDateoperation()));
            }
            $html .= '<tr>
                        <td>
                            Payée par :<br>
                            <table cellpadding="3">
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $cheque_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Chèque N° : ' . $cheque_numero . '</td>
                                    <td style="width:35%">du : ' . $cheque_du . '</td>
                                </tr>
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $virement_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Virement N° : ' . $virement_numero . '</td>
                                    <td style="width:35%">du : ' . $virement_du . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>Sur CCB N° : ' . $label_compte . '</td>
                    </tr>
                    <tr>
                        <td style="height:40px;">Solde disponible : ' . number_format($rubrique->getRelicaengager(), 3, ',', ' ') . '</td>
                    </tr>
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <td style="width:18%">
                                        <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                    </td>
                                    <td style="width:82%">Caisse : </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                   ';

        //Zone Certificat de Retenue à la Source
        elseif ($mouvementcaisse) :
            //Caisse
            $caisse = $mouvementcaisse->getCaissesbanques();
            $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $caisse->getLibelle() . ' ' . $caisse->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : ' . number_format($caisse->getMntdefini(), 3, ',', ' ') . '</td>
                </tr>';
        else :
            if ($compte) :
                //S'il n'y a pas de Compte Bancaire ou Caisse
                //Compte Bancaire
                if ($compte->getIdTypecb() == 2) :
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                </tr>
               
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                ';
                else :
                    //Caisse
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                
            ';
                endif;
            else :
                //Si pas de Compte Bancaire ou Caisse
                $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                ';
            endif;
        endif;

        $html .= '<tr>
                                    <td>
                                        <table cellpadding="3">
                                            <tr>
                                                <td style="width:50%;text-align:center;"></td>
                                                <td style="width:50%;text-align:center;height:70px;">Signature</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>';



        $html .= '<table border="1" cellpadding="3">
                    <tr>
                        <td style="width:100%;text-align:center;font-weight:bold;">Pièces Jointes</td>
                    </tr>
                    <tr>
                        <td style="width:30%;text-align:center;">B.C</td>
                        <td style="width:30%;text-align:center;">P.V.R / R.R.S</td>
                        <td style="width:40%;text-align:center;">Facture</td>
                    </tr>
                    <tr>
                        <td style="width:15%;text-align:center;">N°</td>
                        <td style="width:15%;text-align:center;">DATE</td>
                        
                        <td style="width:15%;text-align:center;">N°</td>
                        <td style="width:15%;text-align:center;">DATE</td>
                        <td style="width:12%;text-align:center;">N°</td>
                        <td style="width:12%;text-align:center;">DATE</td>
                        <td style="width:16%;text-align:center;">MONTANT</td>
                    </tr>';
        $j = 0;
        if ($certificat) :

            foreach ($ordonnance->getPiecejointbudget() as $piece) :
                $doc_achat = $piece->getDocumentachat();
                $ligne_mouvement_facture = $doc_achat->getLignemouvementfacturation()->getFirst();

                if ($doc_achat->getIdTypedoc() == 15) {
                    $piece_joint_budget = $doc_achat->getPiecejointbudget()->getFirst();
                    $document_budget = $piece_joint_budget->getDocumentbudget();
                    $ligne = $document_budget->getLigprotitrub();
                    $mnt_tva = $doc_achat->getMnttva() / 4;
                    $mnt_retenue = ($doc_achat->getMntttc() * $certificat->getRetenuesource()->getValeurretenue()) / 100;
                    $mnt_net = $doc_achat->getMntttc() - $mnt_tva - $mnt_retenue;
                }
                $ligne_mouvement_facture = $doc_achat->getLignemouvementfacturation()->getFirst();
                if ($ligne_mouvement_facture) :
                    if ($doc_achat->getIdTypedoc() != 16 && $doc_achat->getIdTypedoc() != 7)
                        $bce = $doc_achat->getDocumentachat()->getFirst();
                    else
                        $bce = $doc_achat;
                    //                    die($bce->getIdTypedoc().'m');
                    ///////*//modfificaton de ligne //////////sonda
                    ////// while (!($bce->getIdTypedoc() == '16' || $bce->getIdTypedoc() == '7')):
                    if ($bce != null)
                        while (($bce->getIdTypedoc() == '16' || $bce->getIdTypedoc() == '7')) :
                            //                         die($bce->getIdTypedoc().'m'.$bce->getDocumentachat()->getFirst()->getId());
                            $bce = $bce->getDocumentachat()->getFirst();
                        endwhile;
                    $html .= '<tr style="font-size:10px;">
                        <td style="width:15%;text-align:center;">' . $bce->getNumero() . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($bce->getDatecreation())) . '</td>
                        
                        <td style="width:15%;text-align:center;">' . trim($ligne_mouvement_facture->getPvr()) . '/' . trim($ligne_mouvement_facture->getRrs()) . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDaterrspvr())) . '</td>
                        <td style="width:12%;text-align:center;">' . $ligne_mouvement_facture->getNumerofacture() . '</td>
                        <td style="width:12%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDate())) . '</td>

                        <td style="width:16%;text-align:right;">' . number_format($certificat->getMontantordonnancenet(), 3, ',', ' ') . '</td>
                    </tr>';
                    $j++;
                endif;
            endforeach;
        else :
            $j = 0;
            foreach ($ordonnance->getPiecejointbudget() as $piece) :

                $doc_achat = $piece->getDocumentachat();

                $doc_parent = DocumentachatTable::getInstance()->find($doc_achat->getIdDocparent());
                if ($doc_parent) {
                    if ($doc_parent->getIdTypedoc() == 6)
                        $ligne_mouvement_facture = $doc_parent->getLignemouvementfacturation()->getFirst();
                } else
                    $ligne_mouvement_facture = $doc_achat->getLignemouvementfacturation()->getFirst();
                if ($doc_achat->getIdTypedoc() == 15) {
                    $piece_joint_budget = $doc_achat->getPiecejointbudget()->getFirst();
                    $document_budget = $piece_joint_budget->getDocumentbudget();
                    $ligne = $document_budget->getLigprotitrub();
                    $mnt_tva = $doc_achat->getMnttva() / 4;
                    //                    if($certificat){
                    //                    $mnt_retenue = ($doc_achat->getMntttc() * $certificat->getRetenuesource()->getValeurretenue()) / 100;
                    //                    $mnt_net = $doc_achat->getMntttc() - $mnt_tva - $mnt_retenue;}
                }
                //              die(sizeof($ligne_mouvement_facture).'mp'.$ligne_mouvement_facture);
                if (sizeof($ligne_mouvement_facture) >= 1) :
                    if ($doc_achat->getIdTypedoc() != 16 && $doc_achat->getIdTypedoc() != 7) {
                        //                        $bce = $doc_achat->getDocumentachat()->getFirst();
                        $id_docparent = $doc_achat->getIdDocparent();
                        if ($id_docparent)
                            $bce = DocumentachatTable::getInstance()->findOneById($id_docparent);
                        //                        die(sizeof($bce).'gg'.$id_docparent."lk".$doc_achat->getIdDocparent());
                    } else
                        $bce = $doc_achat;

                    if ($bce)
                        $id_type_doc = $bce->getIdTypedoc();
                    $id_doc_parent = $bce->getIdDocparent();
                    //                    die($id_doc_parent.'mp'.$id_type_doc.$bce->getId());
                    //                    while (!($id_type_doc == '16' || $id_type_doc == '7')):
                    //                        if ($id_doc_parent != null):
                    //                            $doc_anticident = DocumentachatTable::getInstance()->findOneById($id_doc_parent);
                    //                            $bce = $doc_anticident;
                    //                        endif;
                    //                    endwhile;

                    $html .= '<tr style="font-size:10px;">
                        <td style="width:15%;text-align:center;">' . $bce->getNumero() . '</td>
                        <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($bce->getDatecreation())) . '</td>';
                    if ($ligne_mouvement_facture)
                        $html .= '   <td style="width:15%;text-align:center;">' . trim($ligne_mouvement_facture->getPvr()) . '/' . trim($ligne_mouvement_facture->getRrs()) . '</td>                     <td style="width:15%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDaterrspvr())) . '</td>
                        <td style="width:12%;text-align:center;">' . $ligne_mouvement_facture->getNumerofacture() . '</td>
                        <td style="width:12%;text-align:center;">' . date('d/m/Y', strtotime($ligne_mouvement_facture->getDate())) . '</td>
                        <td style="width:16%;text-align:right;">' . number_format($ligne_mouvement_facture->getMontant(), 3, ',', ' ') . '</td>';
                    else
                        $html .= '<td></td><td></td><td></td><td></td>';
                    $html .= '   </tr>';
                    $j++;
                endif;
            endforeach;
        endif;
        for ($i = $j; $i < 5; $i++) :
            $html .= '<tr>
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:15%;text-align:center;"></td>
                        
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:15%;text-align:center;"></td>
                        <td style="width:12%;text-align:center;"></td>
                        <td style="width:12%;text-align:center;"></td>
                        <td style="width:16%;text-align:right;"></td>
                    </tr>';
        endfor;

        $html .= '</table>';

        $html .= '<table cellpadding="3">
                    <tr>
                        <td style="width:50%;text-align:center;">S/Financier</td>
                        <td style="width:50%;text-align:center;">D.A.F</td>
                    </tr>
                </table>';


        return $html;
    }

    public function ReadHtmlOrdonnanceHorBCI($id) {
        $html = '';
        $ordonnance = DocumentbudgetTable::getInstance()->find($id);
        $rubrique = $ordonnance->getLigprotitrub();
        $titre_budget = $rubrique->getTitrebudjet();
        $lignebanquecaisse = $rubrique->getLignebanquecaisse()->getFirst();
        if ($lignebanquecaisse)
            $compte = $lignebanquecaisse->getCaissesbanques();
        else
            $compte = null;

        $montant_facture = "";
        $numero_engagement = "";
        $fournisseur = "";
        $piecejointe_budget = $ordonnance->getPiecejointbudget()->getFirst();

        if ($ordonnance->getIdDocumentbudget() != null)
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getIdDocumentbudget());
        else {
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getId());
        }
        if ($certificat)
            $montant_facture = $certificat->getMontantordonnancenet();
        $mouvementbanciare = MouvementbanciareTable::getInstance()->findOneByIdDocumentbudget($id);
        $objet = "";
        if ($mouvementbanciare) :
            $montant_reglement = $mouvementbanciare->getDebit();
            $objet = $mouvementbanciare->getNomoperation();
            $fournisseur = $mouvementbanciare->getRefbenifi();
        else :
            $montant_reglement = $montant_facture;
            $fournisseur = '';
        endif;
        $label_montant_facture = "Montant de la Facture : ";
        if ($ordonnance->getIdDocumentbudget() != null) {
            $ordonnance_parent = DocumentbudgetTable::getInstance()->find($ordonnance->getIdDocumentbudget());
            $montant_reglement = $ordonnance->getMntnet();
            $label_montant_facture = "Montant : ";
            $objet = "Ordonnance  de paiement <b>N°" .
                    $ordonnance_parent->getNumero() . "</b> créée le <b>" .
                    date('d/m/Y', strtotime($ordonnance_parent->getDatecreation())) . "</b>";
        }

        if ($ordonnance->getIdDocumentbudget() != null)
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getIdDocumentbudget());
        else {
            $certificat = CertificatretenueTable::getInstance()->findOneByIdDocumentbudget($ordonnance->getId());
        }

        if ($certificat)
            $montant_facture = $certificat->getMontantordonnancenet();

        $mouvementbanciare = MouvementbanciareTable::getInstance()->findOneByIdDocumentbudget($id);
        $objet = "";
        if ($mouvementbanciare) :
            $montant_reglement = $mouvementbanciare->getDebit();
            $objet = $mouvementbanciare->getNomoperation();
        else :
            $montant_reglement = $montant_facture;
        endif;


        $label_montant_facture = "Montant Ordonnancé : ";


        $html .= '<table style="width:100%;">
                            <tr>
                                <td style="width:35%;text-align:center;">
                                    OFFICE DE DEVELOPPEMENT<br>
                                    DE RJIM MAATOUG<br>
                                    KEBILI
                                </td>
                                <td style="width:65%;"></td>
                            </tr>
                        </table>';
        $html .= '<div style="text-align:center;font-size:14px;font-weight:bold;"><u>ORDONNANCE DE PAIEMENT</u></div>
                    <div style="text-align:center;font-size:14px;font-weight:bold;">N° ' . $ordonnance->getNumero() . '</div>
                    <div style="text-align:right">DATE : ' . date('d/m/Y') . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
                    
                </div>';

        $html .= '<table style="width:100%;" border="1" cellpadding="3">
                    <tr>
                        <td style="width:50%">
                            <table cellpadding="3"><tr><td style="text-align:center;font-size:14px;font-weight:bold;">IMPUTATION BUDGETAIRE</td></tr></table>
                            <table cellpadding="3">
                                <tr>
                                    <td>Exercice : ' . str_replace("Exercice:", "", trim($titre_budget->getTypebudget())) . '</td>
                                </tr>
                                <tr>
                                    <td>Catégorie : ' . trim($titre_budget->getCategorietitre()) . '</td>
                                </tr>
                                <tr>
                                    <td>Budget : ' . $titre_budget->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>N° D\'engagement : ' . $numero_engagement . '</td>
                                </tr>
                                <tr>
                                    <td style="height:50px;">Rubrique : ' . $rubrique->getRubrique()->getLibelle() . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits alloués : ' . number_format($rubrique->getMnt(), 3, ',', ' ') . '</td>
                                </tr>
                                <tr>
                                    <td>Crédits consommés : ' . number_format(abs($ordonnance->getMntengage()), 3, ',', ' ') . '</td>
                                </tr>';
        $html .= '<tr>
                                    <td>Crédits consommés : ' . number_format($rubrique->getMnt() - abs($ordonnance->getMntrelicat()), 3, ',', ' ') . '</td>
                                </tr>
                                        <tr>
                                            <td>
                                                <table>
                                                    <tr>
                                                        <td style="width:19%">Reliquat :</td>
                                                        <td style="width:18%">
                                                            <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                                        </td>
                                                        <td style="width:63%"></td>
                                                    </tr>
                                                </table>
                                                
                                            </td>
                                        </tr>';
        $html .= ' <tr>
        <td><br><br><br>
        <table cellpadding = "3">
        <tr>
        <td style = "width:50%;text-align:center;height:70px;"></td>
        <td style = "width:50%;text-align:center;">Signature</td>
        </tr>
        </table>
        </td>
        </tr>
        </table>
        </td>
        <td style = "width:50%" rowspan = "2">
        <table cellpadding = "3"><tr><td style = "text-align:center;font-size:14px;font-weight:bold;">MODE DE REGLEMENT</td></tr></table>
        <table cellpadding = "3">
        <tr>
        <td>' . $label_montant_facture . number_format($montant_reglement, 3, ', ', ' ') . '</td>
        </tr>
        <tr>
        <td style = "height:50px;">Objet : ' . $objet . '</td>
        </tr > ';
        $html.='  <tr>
               <td style="height:50px;">Fournisseur : ' . $fournisseur . '</td>
              </tr>';
        if ($mouvementbanciare) :
            //Compte Bancaire
            $compte = $mouvementbanciare->getCaissesbanques();
            if ($compte) :
                $label_compte = $compte->getLibelle() . ' ' . $compte->getCodecb();
            else :
                $label_compte = "";
            endif;
            $cheque_existe = "";
            $cheque_numero = "";
            $cheque_du = "";
            $virement_existe = "";
            $virement_numero = "";
            $virement_du = "";
            if ($mouvementbanciare->getIdInstrument() == 1 || $mouvementbanciare->getIdInstrument() == 2) {
                $cheque_existe = "X";
                $cheque_numero = $mouvementbanciare->getPapiercheque()->getRefpapier();
                if ($mouvementbanciare->getPapiercheque()->getDatesignature() != null)
                    $cheque_du = date('d/m/Y', strtotime($mouvementbanciare->getPapiercheque()->getDatesignature()));
            } else if ($mouvementbanciare->getIdInstrument() == 3 || $mouvementbanciare->getIdInstrument() == 4) {
                $virement_existe = "X";
                $virement_numero = $mouvementbanciare->getReferenceautre();
                if ($mouvementbanciare->getDateoperation() != null)
                    $virement_du = date('d/m/Y', strtotime($mouvementbanciare->getDateoperation()));
            }
            $html .= '<tr>
                        <td>
                            Payée par :<br>
                            <table cellpadding="3">
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $cheque_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Chèque N° : ' . $cheque_numero . '</td>
                                    <td style="width:35%">du : ' . $cheque_du . '</td>
                                </tr>
                                <tr>
                                    <td style="width:15%">
                                        <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">' . $virement_existe . '</td></tr></table>
                                    </td>
                                    <td style="width:50%">Virement N° : ' . $virement_numero . '</td>
                                    <td style="width:35%">du : ' . $virement_du . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>Sur CCB N° : ' . $label_compte . '</td>
                    </tr>
                    <tr>
                        <td style="height:40px;">Solde disponible : ' . number_format($rubrique->getRelicaengager(), 3, ',', ' ') . '</td>
                    </tr>
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <td style="width:18%">
                                        <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                    </td>
                                    <td style="width:82%">Caisse : </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                   ';

        //Zone Certificat de Retenue à la Source
        elseif ($mouvementcaisse) :
            //Caisse
            $caisse = $mouvementcaisse->getCaissesbanques();
            $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $caisse->getLibelle() . ' ' . $caisse->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Solde disponible : ' . number_format($caisse->getMntdefini(), 3, ',', ' ') . '</td>
                </tr>';
        else :
            if ($compte) :
                //S'il n'y a pas de Compte Bancaire ou Caisse
                //Compte Bancaire
                if ($compte->getIdTypecb() == 2) :
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                </tr>
               
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                ';
                else :
                    //Caisse
                    $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;text-align:center;">X</td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : ' . $compte->getLibelle() . ' ' . $compte->getCodecb() . '</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                
            ';
                endif;
            else :
                //Si pas de Compte Bancaire ou Caisse
                $html .= '<tr>
                    <td>
                        Payée par :<br>
                        <table cellpadding="3">
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Chèque N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                            <tr>
                                <td style="width:15%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:50%">Virement N° : </td>
                                <td style="width:35%">du : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>Sur CCB N° : </td>
                </tr>
                <tr>
                    <td style="height:40px;">Solde disponible : </td>
                </tr>
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td style="width:18%">
                                    <table border="1"><tr><td style="height:20px;width:32px;"></td></tr></table>
                                </td>
                                <td style="width:82%">Caisse : </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                ';
            endif;
        endif;
        $html .= '</table>
                        </td>
                    </tr>';

//        $html .= '<table border="1" cellpadding="3">
//                    <tr>
//                        <td style="width:100%;text-align:center;font-weight:bold;">Pièces Jointes</td>
//                    </tr>
//                    <tr>
//                        <td style="width:30%;text-align:center;">B.C</td>
//                        <td style="width:30%;text-align:center;">P.V.R / R.R.S</td>
//                        <td style="width:40%;text-align:center;">Facture</td>
//                    </tr>
//                    <tr>
//                        <td style="width:15%;text-align:center;">N°</td>
//                        <td style="width:15%;text-align:center;">DATE</td>
//                        
//                        <td style="width:15%;text-align:center;">N°</td>
//                        <td style="width:15%;text-align:center;">DATE</td>
//                        <td style="width:12%;text-align:center;">N°</td>
//                        <td style="width:12%;text-align:center;">DATE</td>
//                        <td style="width:16%;text-align:center;">MONTANT</td>
//                    </tr>';
//        $j = 0;
//        for ($i = $j; $i < 5; $i++) :
//            $html .= '<tr>
//                        <td style="width:15%;text-align:center;"></td>
//                        <td style="width:15%;text-align:center;"></td>
//                        
//                        <td style="width:15%;text-align:center;"></td>
//                        <td style="width:15%;text-align:center;"></td>
//                        <td style="width:12%;text-align:center;"></td>
//                        <td style="width:12%;text-align:center;"></td>
//                        <td style="width:16%;text-align:right;"></td>
//                    </tr>';
//        endfor;
//        $html .= '</table>';
        $html .= '<br><br><br><table cellpadding="3">
                    <tr><td style="width:50%;text-align:center;"></td>';
        $html .= '      <td style="width:50%;text-align:center;">D.A.F</td>
                    </tr>
                </table>';
        return $html;
    }

    public function ReadHtmlEngagementdefinitif($iddoc, $id_marche) {
        $finacemets = FinancementTable::getInstance()->findByIdMarche($id_marche);

        $piecejointnudg = Doctrine_Core::getTable('piecejointbudget')
                ->createQuery('a')
                ->andwhere('a.id_docachat=' . $iddoc)
                ->execute();

        $html = '';
        $type_text = 'définitif';

        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement '
                . $type_text
                . '</h3>';
        foreach ($piecejointnudg as $piece) :
            $documentbudget = DocumentbudgetTable::getInstance()->findOneById($piece->getIdDocumentbudget());

            $date = date('Y', strtotime($documentbudget->getLigprotitrub()->getTitrebudjet()->getDatecreation()));

            $html .= ' <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' .
                    $documentbudget->getNumerodocachat() .
                    '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>'
                    . date('d/m/Y', strtotime($documentbudget->getDatecreation()))
                    . '</td>
                    </tr>
                    <tr>
                        <td><label>Type Document </label></td>
                        <td>'
                    . $documentbudget->getTypedocbudget()
                    . '</td>
                    </tr>
                </tbody>
            </table>';

            $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
               <h3>Informations sur le Budget</h3>
             <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $documentbudget->getLigprotitrub()->getTitrebudjet()->getLibelle() . '</td>
                    </tr>
                    <tr>
                        <td><label>Rubrique</label></td>
                        <td>' . $documentbudget->getLigprotitrub()->getRubrique() . '</td>
                    </tr>';
            $sousrubrique = RubriqueTable::getInstance()->getByRubtique($documentbudget->getLigprotitrub()->getIdRubrique());
            //       die(count($sousrubrique).'r');
            //$sousrubrique = Doctrine_Core::getTable('rubrique')->findOneByIdRubrique($documentbudget->getLigprotitrub()->getIdRubrique());
            if ($sousrubrique)
                $html .= '<tr>
                        <td><label>Sous Rubrique</label></td>
                        <td>' . $sousrubrique->getFirst()->getLibelle() . '</td>
                    </tr>
                    <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' . $documentbudget->getListesDocumentAchatByDocumentBudget() . '</td>
                    </tr>
                    <tr>
                        <td><label>Mnt.</label></td>
                        <td colspan="3">' . number_format($documentbudget->getMnt(), 3, ",", " ") . ' TND</td>
                    </tr>
                    <tr>
                        <td><label>Mnt Engagé</label></td>
                        <td colspan="3">' . number_format($documentbudget->getMntengage(), 3, ",", " ") . ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  Engagé</label></td>
                        <td>' . number_format($documentbudget->getMntrelicat(), 3, ",", " ") . ' TND</td>
                    </tr>
                </tbody>
            </table>';
        endforeach;

        return $html;
    }

    public function ReadHtmlEngagementdefinitifMarche($iddoc, $id_marche) {
        $finacemets = FinancementTable::getInstance()->findByIdMarche($id_marche);
        $doc_achat = DocumentachatTable::getInstance()->find($iddoc);

        $piecejointnudg = Doctrine_Core::getTable('piecejointbudget')
                ->createQuery('a')
                ->andwhere('a.id_docachat=' . $iddoc)
                //                    ->andwhere($iddoc . 'in (select id_documentachat from marches'
                //                            . ' where id in (select id_marche'
                //                            . ' where id_marche=' . $id_marche . ' and marches.id_documentachat=documentachat.id')
                ->execute();
        $html = '';
        foreach ($finacemets as $finacemet) :
            $ligproti = $finacemet->getIdLignebudget();
            $lignepro = LigprotitrubTable::getInstance()->find($finacemet->getIdLignebudget());
            // die($lignepro->getTitrebudjet()->getDatecreation().'fr');
            $type_text = 'définitif';
            $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement '
                    . $type_text
                    . '</h3>';
            //        foreach ($piecejointnudg as $piece):           
            $documentbudget = DocumentbudgetTable::getInstance()->getByLigAndPieceJointb($lignepro->getId(), $iddoc);
            //            foreach ($documentbudgets as $documentbudget):
            $date = date('Y', strtotime($lignepro->getTitrebudjet()->getDatecreation()));

            $html .= ' <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' .
                    $documentbudget[0]['numero'] .
                    '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>'
                    . date('d/m/Y', strtotime($lignepro->getTitrebudjet()->getDatecreation()))
                    . '</td>
                    </tr>
                    <tr>
                        <td><label>Type Document </label></td>
                      <td>'
                    . $documentbudget[0]['typebudget']
                    . '</td>
                    </tr>
                </tbody>
            </table>';

            $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
               <h3>Informations sur le Budget</h3>
             <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $documentbudget[0]['titrebudget'] .
                    '</td>
                    </tr>
                    <tr>
                        <td><label>Rubrique</label></td>
                        <td>' .
                    $documentbudget[0]['rubrique'] .
                    '</td>
                    </tr>';

            if ($documentbudget[0]['id_rubrique'])
                $sousrubrique = RubriqueTable::getInstance()->getByRubtique($documentbudget[0]['id_rubrique']);
            //       die(count($sousrubrique).'r');
            //$sousrubrique = Doctrine_Core::getTable('rubrique')->findOneByIdRubrique($documentbudget->getLigprotitrub()->getIdRubrique());
            if ($sousrubrique)
                $html .= '<tr>
                        <td><label>Sous Rubrique</label></td>
                        <td>' .
                        $sousrubrique->getFirst()->getLibelle() .
                        '</td>
                    </tr>
                    <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' .
                        $doc_achat->getNumerodocumentachat() .
                        //                            $documentbudget->getListesDocumentAchatByDocumentBudget() .
                        '</td>
                    </tr>
                    <tr>
                        <td><label>Mnt.</label></td>
                        <td colspan="3">' .
                        number_format($documentbudget[0]['mnt'], 3, ",", " ") .
                        ' TND</td>
                    </tr>
                    <tr>
                        <td><label>Mnt Engagé</label></td>
                        <td colspan="3">' .
                        number_format($documentbudget[0]['mntengage'], 3, ",", " ") .
                        ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  Engagé</label></td>
                        <td>' .
                        number_format($documentbudget[0]['mntrelicat'], 3, ",", " ") .
                        ' TND</td>
                    </tr>
                </tbody>
            </table>';
        endforeach;
//        endforeach;
        return $html;
    }

    public function ReadHtmlDoc($documentachat) {
        $html = '';

        $date = date('Y', strtotime($this->getLigprotitrub()->getTitrebudjet()->getDatecreation()));
        $type_text = 'Provisoire';
        if ($this->getIdType() == 1)
            $type_text = 'Définitif';
        if ($this->getIdType() == 2)
            $type_text = 'Ordonnancement';
        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}</style> 
            &nbsp;<br><h3>Fiche d\'engagement ' . $type_text . '</h3>
            <table border="1" style="padding:1%">
                <tbody>
                 
                 
                    <tr>
                        <td style="width: 30%;"><label>Numéro</label></td>
                        <td style="width: 70%;">' . $this->getNumerodocachat() . '</td>
                    </tr>
                    <tr>
                        <td><label>Date Création</label></td>
                        <td>' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                    </tr>
                    <tr>
                        <td><label>Etat || Type Document </label></td>
                        <td>' . $this->getTypedocbudget() . '</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>Informations sur le Budget</h3>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width: 30%;"><label>Exercice</label></td>
                        <td style="width: 70%;">' . $date . '</td>                    
                    </tr>
                    <tr>
                        <td><label>Titre Budget</label></td>
                        <td>' . $this->getLigprotitrub()->getTitrebudjet()->getLibelle() . '</td>
                    </tr>
                    <tr>
                    <td><label>Rubrique</label></td>
                    <td>' . $this->getRubriqueparent() . '</td>
                </tr>';


        if ($this->getLigprotitrub()->getRubrique()->getSousRubriqueBudgetaire())
            $html .= '<tr>
                <td><label>Sous Rubrique</label></td>
                <td>' . $this->getLigprotitrub()->getRubrique()->getSousRubriqueBudgetaire()->getLibelle() . '</td>
            </tr>';
// $doc_achat->getNumerodocumentachat() .

        if ($documentachat) {
            $html .= '     <tr>
                        <td><label>Document(s) Achat(s)</label></td>
                        <td colspan="3">' .
                    $this->getListesDocumentAchatByDocumentBudget() . '</td>
                    </tr>';
        }
        $html .= '     <tr>
                        <td><label>Mnt. Engagement</label></td>
                        <td colspan="3">' . number_format($this->getMnt(), 3, ",", " ") . ' TND</td>
                    </tr>
                    <tr>
                        <td><label>Mnt rubrique engagé</label></td>
                        <td colspan="3">' . number_format($this->getMntengage(), 3, ",", " ") . ' TND</td>
                    </tr>
                     <tr>
                        <td><label>Reliquat  rubrique engagé</label></td>
                        <td>' . number_format($this->getMntrelicat(), 3, ",", " ") . ' TND</td>
                    </tr>
                </tbody>
            </table>';

        return $html;
    }

}
