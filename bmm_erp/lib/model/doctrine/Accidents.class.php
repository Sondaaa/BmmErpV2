<?php

/**
 * Accidents
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Accidents extends BaseAccidents {

    public function ReadHtmlListeAccidents(sfWebRequest $request) {

        $id_agents = $request->getParameter('id_agents', '');
        $date = $request->getParameter('date', '');
        $id_lieu = $request->getParameter('id_lieu', '');
        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        if ($id_lieu != '') {
            $lieu = Doctrine_Core::getTable('lieutravail')->findOneById($id_lieu);
        }
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT  *, accidents.adresse as adresse,"
                . "  accidents.date as date,"
                . "  accidents.nbrjour as nbrjour,"
                . " lieutravail.libelle as gouvernera  "
                . "  ,accidents.observation as observation,"
                . "  accidents.motif as motif,"
                . "Concat(agents.nomcomplet, ' ', agents.prenom) as nom, agents.idrh as idrh"
                . " FROM agents, accidents,lieutravail "
                . " WHERE accidents.id_lieu= lieutravail.id "
                . " and accidents.id_agents= agents.id "
        ;
        if ($id_agents != '')
            $query.= "  and accidents.id_agents =" . $id_agents
            ;
        if ($id_lieu != '')
            $query.= "  and accidents.id_lieu =" . $id_lieu
            ;
        if ($date != '')
            $query.= "  and accidents.date ='" . $date . "'"
            ;
        $query.= " ORDER BY agents.nomcomplet";
        $consultation = $conn->fetchAssoc($query);
        $html = '<h3>RECAPITULATIF DES ACCIDENTS DE TRAVAIL  ';
        if ($id_agents != ""): $html .=" De " . $agents->getNomcomplet() . " " . $agents->getPrenom() . '';
        else: $html .= "";
        endif;
        if ($date != ""): $html .=" Â " . date('d/m/Y', strtotime($date)) . '';
        else: $html .= "";
        endif;
          if ($id_lieu != ""): $html .=" Âu " . $lieu->getLibelle(). '</h3>';
        else :
        $html .= '</h3>';
        endif;
        $html.='&nbsp;<br>&nbsp;<br>
                <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 3%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 8%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 18%;text-align:center;"><label>Agents </label></td> 
                        <td style="width: 30%;text-align:center;"><label>Motif d\'accidents</label></td>
                        <td style="width: 14%;text-align:center;"><label>Date d\'accidents (Lieu)</label></td>
                        <td style="width: 7%;text-align:center;"><label>Nbr.jour </label></td>
                        <td style="width: 20%;text-align:center;"><label>Observations </label></td>
                       
                    </tr>';
        if (sizeof($consultation) > 0) {
            $i = 1;
            foreach ($consultation as $consul):
                $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $consul['idrh'] . '</td>
                        <td style="text-align:left;">' . $consul['nom'] . '</td>
                        <td style="text-align:justify;">' . $consul['motif'] . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($consul['date'])) . ' (' . $consul['gouvernera'] . ')' . '</td>
                        <td style="text-align:center;">' . $consul['nbrjour'] . ' Jour</td>
                        <td style="text-align:justify;">' . $consul['observation'] . '</td>
                  </tr>';
                $i++;
            endforeach;
        }else {
            $html.='<tr style="font-size:16px;">
                        <td style="height:80px;text-align:center;width:100%;">&nbsp;<br>Pas d\'accidents de travail</td>
                  </tr>';
        }

        $html.='</table>';

        return $html;
    }

}
