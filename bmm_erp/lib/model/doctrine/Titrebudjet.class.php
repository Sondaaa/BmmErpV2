<?php

/**
 * Titrebudjet
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    BmmErpTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Titrebudjet extends BaseTitrebudjet {

    public function __toString() {

        return trim($this->getTypebudget()) . " : " . strtoupper($this->getLibelle());
    }

    public function SaveMntGlobal() {
        $mnt_global = 0;

        $sql = "select sum(ligprotitrub.mnt) as mntglobal from ligprotitrub,titrebudjet,rubrique
                where ligprotitrub.id_titre=titrebudjet.id
                and rubrique.id=ligprotitrub.id_rubrique and rubrique.id_rubrique is null
                and titrebudjet.id=" . $this->id;
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $result = $conn->fetchAssoc($sql);

        $this->setMntglobal(floatval($result[count($result) - 1]['mntglobal']));
        $this->save();
    }

    public function GetJson() {
        $ligne_detail_budgets = Doctrine_Query::create()
                        ->select("*")
                        ->from('ligprotitrub')
                        ->where("id_titre=" . $this->getId())
                        ->orderBy('nordre asc')->execute();
// die(count($ligne_detail_budgets).'hh');
        $ligne = new Ligprotitrub();
        $json = '{"sousdetail":[';
// return $json;
        $k = 0;
        foreach ($ligne_detail_budgets as $ll) {
            $ligne = $ll;

//            if ($ligne->getNordre() . trim() == $ligne->getNordre() . trim()) {

            $r = Doctrine_Core::getTable('rubrique')->findOneById($ligne->getIdRubrique());
            if ($r && !$r->getIdRubrique()) {
                if ($k > 0 && $k < count($ligne_detail_budgets))
                    $json .= ",";


//traitement pour avoir l'ordre des ligne par integer nordre
//(supprmer tous les caractères et laisser que les numéros)
                $ligne_ordre = preg_replace("[^0-9]", "", $ligne->getNordre());
                $ligne_ordre = str_replace('"', "''", $ligne_ordre);

                $nordre_rubrique = str_replace('"', "''", $ligne->getNordre());
                $json .= '{"nordre":"' . trim($nordre_rubrique) . '",';

                $rubriqueTitre = str_replace('  ', '', $r->getLibelle());
                $rubriqueTitre = str_replace('"', "''", $rubriqueTitre);


                $json .= '"ligne_ordre":"' . trim($ligne_ordre) . '",';


//                    $nordre_rubrique = str_replace('"', "''", $ligne->getNordre());
//                    $json.='{"nordre":"' . trim($nordre_rubrique) . '",';
//
                //                    $rubriqueTitre = str_replace('  ', '', $r->getLibelle());
//                    $rubriqueTitre = str_replace('"', "''", $rubriqueTitre);
//                    
//                $rubriqueTitre = str_replace(',', '', $rubriqueTitre);
//                $rubriqueTitre=  strtolower($rubriqueTitre);
                $mntencaisserexterne = number_format($ligne->getMntencaisse() + $ligne->getMntexterne(), 3, '.', '');

                $json .= '"idligne":"' . $ligne->getId() . '",';
                $json .= '"code":"' . trim($r->getCode()) . '",';
                $json .= '"idtitre":"' . $ligne->getIdTitre() . '",';
                $json .= '"designation":"' . $rubriqueTitre . '",';
                $json .= '"mnt":"' . $ligne->getMnt() . '",';
                $json .= '"mntexterne":"' . $ligne->getMntexterne() . '",';
                $json .= '"mntencaisser":"' . $ligne->getMntencaisse() . '",';
                $json .= '"mntencaisserexterne":"' . $mntencaisserexterne . '",';
                $json .= '"sousrubrique":[';

                $sousrubriques = Doctrine_Core::getTable('rubrique')->findByIdRubrique($ligne->getIdRubrique());
                $sous_rubrique = new Rubrique();
                $i = 0;
                foreach ($sousrubriques as $sr) {
                    $sous_rubrique = $sr;
                    $lrubrique = new Ligprotitrub();
                    $ligne_rubrique = Doctrine_Core::getTable('ligprotitrub')->findOneByIdRubriqueAndIdTitre($sous_rubrique->getId(), $this->getId());

                    if ($ligne_rubrique) {
                        $lrubrique = $ligne_rubrique;
                        if ($i > 0 && $i < count($sousrubriques))
                            $json .= ',';
                        $str = str_replace('  ', '', $sous_rubrique->getLibelle());
                        $str = str_replace('"', "''", $sous_rubrique->getLibelle());
                        $nordre_sous_rubrique = str_replace('"', "''", $lrubrique->getNordre());
                        $sous_mntencaisserexterne = number_format($lrubrique->getMntencaisse() + $lrubrique->getMntexterne(), 3, '.', '');
                        $json .= '{"nordre":"' . trim($nordre_sous_rubrique) . '"'
                                . ',"idligne":"' . $lrubrique->getId() . '"'
                                . ',"code":"' . trim($sous_rubrique->getCode()) . '"'
                                . ',"designation":"' . $str . '"'
                                . ',"mntexterne":"' . $lrubrique->getMntexterne() . '"'
                                . ',"mntencaisser":"' . $lrubrique->getMntencaisse() . '"'
                                . ',"mnt":"' . $lrubrique->getMnt() . '"'
                                . ',"mntencaisserexterne":"' . $sous_mntencaisserexterne . '"'
                                . '}';

                        $i++;
                    }
                }

                $json .= ']}';

                $k++;
            }
//            }
        }
        $etat = 1;
        if ($this->getEtatbudget())
            $etat = $this->getEtatbudget();
        $json .= '],"idtype":1,"idbudget":' . $this->getId() . ',"etat":"' . $etat . '"}';
        $json = str_replace("  ", "", $json);
        $json = str_replace("\n", "", $json);
        $jsondata = $json;
        return $jsondata;
    }

//    public function GetJson() {
//
    ////        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
////        if ($type == "detail")
////            $query = "SELECT   titrebudjet.id as idbudget,  titrebudjet.etatbudget as etat,"
////                    . " ligprotitrub.nordre ,   ligprotitrub.id as idligne, "
////                    . "  ligprotitrub.id_titre as idtitre,   "
////                    . "rubrique.libelle as designation, rubrique.id as idr ,"
////                . "  rubrique.id_rubrique as idsousr , "
////                    . " ligprotitrub.mntprovisoire, ligprotitrub.mnt as mnt, "
////                    . " ligprotitrub.mntencaisse as mntencaisser,   ligprotitrub.mntredresement "
////                    . "FROM    ligprotitrub,    rubrique,    titrebudjet "
////                    . "WHERE    ligprotitrub.id_titre = titrebudjet.id "
////                    . "AND   ligprotitrub.id_rubrique = rubrique.id   "
////                    . "and ligprotitrub.id_titre= " . $this->getId()
////                    . "and rubrique.id_rubrique is null;";
////        else
////            $query = "SELECT titrebudjet.id as idbudget,  titrebudjet.etatbudget as etat, ligprotitrub.nordre,   ligprotitrub.id as idligne, "
////                    . "  ligprotitrub.id_titre as idtitre,   "
////                    . "rubrique.libelle as designation, rubrique.id as idr ,rubrique.id_rubrique as idsousr , "
////                    . " ligprotitrub.mntprovisoire, ligprotitrub.mnt as mnt, "
////                    . " ligprotitrub.mntencaisse as mntencaisser,   ligprotitrub.mntredresement "
////                    . "FROM    ligprotitrub,    rubrique,    titrebudjet "
////                    . "WHERE    ligprotitrub.id_titre = titrebudjet.id "
////                    . "AND   ligprotitrub.id_rubrique = rubrique.id   "
////                    . "and ligprotitrub.id_titre= " . $this->getId()
////                    . "and rubrique.id_rubrique is not null;";
////        //die($query);
////        $json_rubrique_parent = $conn->fetchAssoc($query);
////
////        die(json_encode($json_rubrique_parent));
//        //->execute(array(), Doctrine::HYDRATE_SINGLE_SCALAR);
////        $ligne_rubrique = Doctrine_Query::create()
////                        ->select("id_rubrique")
////                        ->from('ligprotitrub')
////                        ->where("id_titre=" . $this->getId())
////                        ->orderBy('nordre asc')->execute(array(), Doctrine::HYDRATE_SINGLE_SCALAR);
////        $rubrique = Doctrine_Query::create()
////        ->select("rubrique.*")
////        ->from('rubrique')
////        ->whereIn("id", $ligne_rubrique)
////        ->fetchArray();
////        die(json_encode($rubrique));
//        $array_result = array();
//        $ligne_detail_budgets = Doctrine_Query::create()
//                        ->select("*")
//                        ->from('ligprotitrub')
//                        ->where("id_titre=" . $this->getId())
//                        ->orderBy('nordre asc')->execute();
//        $ligne = new Ligprotitrub();
//        $budget = array();
////        $json = '{"sousdetail":[';
//        // return $json;
////        $k = 0;
//        foreach ($ligne_detail_budgets as $ll) {
//            $ligne = $ll;
//
    //            $diff = $ligne->getNordre() - intval($ligne->getNordre());
//            if ($diff == 0) {
////                if ($k > 0 && $k < count($ligne_detail_budgets))
////                    $json.=",";
//                $sousdetail = array();
//                $sousdetail["nordre"] = $ligne->getNordre();
//
    ////                $json.='{"nordre":' . intval($ligne->getNordre()) . ',';
//                $r = Doctrine_Core::getTable('rubrique')->findOneById($ligne->getIdRubrique());
//                $rubriqueTitre = str_replace('  ', '', $r->getLibelle());
//                //$rubriqueTitre = str_replace('\b', '', $rubriqueTitre);
////                $rubriqueTitre = str_replace(',', '', $rubriqueTitre);
////                $rubriqueTitre=  strtolower($rubriqueTitre);
//                // $json.='"idligne":"' . $ligne->getId() . '",';
//                $sousdetail["idligne"] = $ligne->getId();
////                $json.='"idtitre":"' . $ligne->getIdTitre() . '",';
//                $sousdetail["idtitre"] = $ligne->getIdTitre();
////                $json.='"designation":"' . $rubriqueTitre . '",';
//                $sousdetail["designation"] = $rubriqueTitre;
////                $json.='"mnt":"' . $ligne->getMnt() . '",';
//                $sousdetail["mnt"] = $ligne->getMnt();
////                $json.='"mntencaisser":"' . $ligne->getMntencaisse() . '",';
//                $sousdetail["mntencaisser"] = $ligne->getMntencaisse();
////                $json.='"sousrubrique":[';
//
    //                $sousrubriques = Doctrine_Core::getTable('rubrique')->findByIdRubrique($ligne->getIdRubrique());
//                $sous_rubrique = new Rubrique();
////                $i = 0;
//                foreach ($sousrubriques as $sr) {
//                    $sous_rubrique = $sr;
//                    $lrubrique = new Ligprotitrub();
//                    $ligne_rubrique = Doctrine_Core::getTable('ligprotitrub')->findOneByIdRubriqueAndIdTitre($sous_rubrique->getId(), $this->getId());
//
    //                    $sousrubrique = array();
//                    if ($ligne_rubrique) {
//                        $lrubrique = $ligne_rubrique;
////                        if ($i > 0 && $i < count($sousrubriques))
////                            $json.=',';
////                        $json.='{"nordre":"' . $lrubrique->getNordre() . '"'
////                                . ',"idligne":"' . $lrubrique->getId() . '"'
////                                . ',"designation":"' . str_replace('  ', '', $sous_rubrique->getLibelle()) . '"'
////                                . ',"mntencaisser":"' . $lrubrique->getMntencaisse() . '"'
////                                . ',"mnt":"' . $lrubrique->getMnt() . '"'
////                                . '}';
//                        $sousrubrique['nordre'] = $lrubrique->getNordre();
//                        $sousrubrique['idligne'] = $lrubrique->getId();
//                        $sousrubrique['designation'] = str_replace('  ', '', $sous_rubrique->getLibelle());
//                        $sousrubrique['mntencaisser'] = $lrubrique->getMntencaisse();
//                        $sousrubrique['mnt'] = $lrubrique->getMnt();
//                        //$json_sousrubrique = json_encode($sousrubrique);
//
    //                        $sousdetail['sousrubrique'] = $sousrubrique;
////                        $i++;
//                    }
//                }
//                $budget[] = $sousdetail;
//
    ////                $json.=']}';
////
////                $k++;
//            }
//        }
//        $etat = 1;
//        if ($this->getEtatbudget())
//            $etat = $this->getEtatbudget();
////        $json.='],"idtype":1,"idbudget":' . $this->getId() . ',"etat":"' . $etat . '"}';
////        $json = str_replace("  ", "", $json);
////        $json = str_replace("\n", "", $json);
////        return $json;
//        $budget['idtype'] = 1;
//        $budget['idbudget'] = $this->getId();
//        $budget['etat'] = $etat;
//        $json = array('sousdetail' => $budget);
//        $json_data = json_encode($json);
//        
//        return $json_data;
//    }

    public function CopierRubriqueEtSousRubrique($id_titre_principal) {
        $ligne = new Ligprotitrub();
        $ligne_rubriques = Doctrine_Query::create()
                        ->select("*")
                        ->from('ligprotitrub')
                        ->where("id_titre=" . $id_titre_principal)
                        ->orderBy('id asc')->execute();
//Doctrine_Core::getTable('ligprotitrub')->findByIdTitre($id_titre_principal);
        foreach ($ligne_rubriques as $l) {
            $ligne = $l;

            $nordre = $ligne->getNordre();
            $designation = $ligne->getRubrique()->getLibelle();
            $totalht = $ligne->getMnt() - $ligne->getMntengage();
            $ligne_budget = new Ligprotitrub();
            $ss = Doctrine_Core::getTable('ligprotitrub')->findOneByIdTitreAndNordre($this->getId(), $nordre);
            if ($ss) {
                $ligne_budget = $ss;
            }
            $ligne_budget->setIdTitre($this->getId());
//           
            if ($totalht && $totalht != "" && $totalht >= 0)
                $ligne_budget->setMnt($totalht);
            else
                $ligne_budget->setMnt(0);
            $ligne_budget->setNordre($nordre);
            $ligne_budget->setCode($ligne->getCode());
            $rub = new Rubrique();
            $rubrique = Doctrine_Core::getTable('rubrique')->findOneByIdAndLibelle($ligne->getIdRubrique(), $designation);
            if ($rubrique)
                $rub = $rubrique;
            else {
                $rub->setLibelle($designation);
                $rub->setCode($ligne->getCode());
                if ($ligne->getRubrique()->getIdRubrique())
                    $rub->setIdRubrique($ligne->getRubrique()->getIdRubrique());
            }
            $ligne_budget->setIdRubrique($rub->getId());
//            $lignebudget = Doctrine_Core::getTable('ligprotitrub')->findByIdTitre($this->getId());
//            foreach ($lignebudget as $lg) {
//                //$designation=  str_replace($ligne, $lignebudget, $rub)
//                $rubrique = Doctrine_Core::getTable('rubrique')->findOneByIdAndLibelle($lg->getIdRubrique(), $designation);
//
            //                if ($rubrique)
//                    $rub = $rubrique;
//            }
//
            //            $rub->setLibelle($designation);
////            $diff = number_format($ligne->getNordre(), 2) - intval($ligne->getNordre());
////            if ($diff > 0) {
//                $n_ordre_rubrique = $ligne->getNordre();
//                //die($ligne->getNordre() . 'hh');
//                $detail_rub = Doctrine_Core::getTable('ligprotitrub')->findOneByIdTitreAndNordre($this->getId(), $n_ordre_rubrique);
//
            //                if ($detail_rub)
//                    $rub->setIdRubrique($detail_rub->getIdRubrique());
////            }
//            $rub->save();

            $ligne_budget->save();
        }
    }

    public function CopierRubriqueEtSousRubriqueForGlobal($id_titre_principal) {
        $ligne = new Ligprotitrub();
        $ligne_rubriques = Doctrine_Query::create()
                        ->select("*")
                        ->from('ligprotitrub')
                        ->where("id_titre=" . $id_titre_principal)
                        ->orderBy('id asc')->execute();
        foreach ($ligne_rubriques as $l) {
            $ligne = $l;

            $ligne_budget = new Ligprotitrub();
            $ss = $ligne_rubriques = Doctrine_Query::create()
                            ->select("*")
                            ->from('ligprotitrub')
                            ->where("id_titre=" . $this->getId())
                            ->andWhere("trim(code) = ?", trim($ligne->getCode()))
                            ->execute()->getFirst();

            if ($ss) {
                $ligne_budget = $ss;
                $total_montant = $ligne->getMnt() + $ss->getMnt();
            } else {
                $total_montant = $ligne->getMnt();
            }
            $ligne_budget->setIdTitre($this->getId());
            $ligne_budget->setMnt($total_montant);
            $ligne_budget->setNordre($ligne->getNordre());
            $ligne_budget->setCode($ligne->getCode());
            $ligne_budget->setIdRubrique($ligne->getIdRubrique());
            $ligne_budget->save();

            foreach ($l->getAnnexebudgetrubrique() as $annexe) {
                $copie_annexe = new Annexebudgetrubrique();
                $copie_annexe->setDatecreation(date("Y-m-d"));
                $copie_annexe->setDescription($annexe->getDescription());
                $copie_annexe->setContenu($annexe->getContenu());
                $copie_annexe->setTotal($annexe->getTotal());
                $copie_annexe->setIdAnnexebudget($annexe->getIdAnnexebudget());
                $copie_annexe->setIdLigprotitrub($ligne_budget->getId());
                $copie_annexe->save();
            }
        }
    }

    public function CopierRubriqueEtSousRubriqueForGlobalByCategorie($id_titre_principal) {
        $mnt_global = 0;
        $ligne = new Ligprotitrub();
        $budgetPrincipal = TitrebudjetTable::getInstance()->findOneById($id_titre_principal);

        $budgetParDirections = Doctrine_Core::getTable('Titrebudjet')->createQuery('a')
                ->where("typebudget='Budget Prévisionnel / Direction & Projet'")
                ->andWhere('id_cat=' . $budgetPrincipal->getIdCat())
                ->andWhere('etatbudget=2')
                ->andWhere("EXTRACT(YEAR FROM datecreation) = " . date('Y', strtotime($budgetPrincipal->getDatecreation())))
                ->execute();

        foreach ($budgetParDirections as $budgetParDirection) {


            $ligne_rubriques = Doctrine_Query::create()
                            ->select("*")
                            ->from('ligprotitrub')
                            ->where("id_titre=" . $budgetParDirection->getId())
                            ->orderBy('id asc')->execute();

            foreach ($ligne_rubriques as $ligne) {

                $ss = Doctrine_Query::create()
                                ->select("*")
                                ->from('ligprotitrub')
                                ->andWhere("id_titre=" . $id_titre_principal)
                                ->andWhere("code = ?", trim($ligne->getCode()))
                                ->execute()->getFirst();

                if ($ss) {
                    $ligne_budget = $ss;
                    $total_montant = $ligne->getMnt() + $ss->getMnt();
                } else {
                    $ligne_budget = new Ligprotitrub();
                    $total_montant = $ligne->getMnt();
                }


                $ligne_budget->setIdTitre($id_titre_principal);
                $ligne_budget->setMnt($total_montant);
                $ligne_budget->setNordre($ligne->getNordre());
                $ligne_budget->setCode($ligne->getCode());
                $ligne_budget->setIdRubrique($ligne->getIdRubrique());
                $ligne_budget->save();

                foreach ($ligne->getAnnexebudgetrubrique() as $annexe) {
                    $copie_annexe = new Annexebudgetrubrique();
                    $copie_annexe->setDatecreation(date("Y-m-d"));
                    $copie_annexe->setDescription($annexe->getDescription());
                    $copie_annexe->setContenu($annexe->getContenu());
                    $copie_annexe->setTotal($annexe->getTotal());
                    $copie_annexe->setIdAnnexebudget($annexe->getIdAnnexebudget());
                    $copie_annexe->setIdLigprotitrub($ligne_budget->getId());
                    $copie_annexe->save();
                }
            }
        }

        $budgetPrincipal->setEtatbudget(1);
        $budgetPrincipal->save();
        $query = "update  titrebudjet set mntglobal=(SELECT COALESCE(sum(ligprotitrub.mnt),0) FROM public.ligprotitrub,rubrique 
        where id_titre=" . $budgetPrincipal->getId() . " and rubrique.id_rubrique is null and rubrique.id=ligprotitrub.id_rubrique) where titrebudjet.id=" . $budgetPrincipal->getId();

        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $conn->execute($query);
    }

    function random_color_part() {
        return str_pad(dechex(mt_rand(0, 255)), 2, '0', STR_PAD_LEFT);
    }

    function random_color() {
        return "#" . $this->random_color_part() . $this->random_color_part() . $this->random_color_part();
    }

    public function getHtmlBudget($user) {


        if ($this->getDatesignature() != null)
            $date_signature = date('d/m/Y', strtotime($this->getDatesignature()));
        else
            $date_signature = '';

        $total_debloque = 0;
        $tranchebudgets = TranchebudgetTable::getInstance()->findByIdTitrebudget($this->getId());
        foreach ($tranchebudgets as $tranchebudget) {
            $total_debloque = $total_debloque + $tranchebudget->getMntvaleur();
        }

        $html = '';
        $html .= '<h3 style="font-size:18px;">' . $this->getLibelle() . '</h3>
            <h2 style="font-size:16px;">Identification du responsable suivi Budget</h2>
            <table border="1" style="padding:1%;width:100%;">
                <tbody>
                    <tr>
                        <td style="width: 35%;background-color:#F0F0F0;"><label>Responsable unité Budget</label></td>
                        <td style="width: 65%;">' . $user . '</td>
                    </tr>
                    <tr>
                        <td style="background-color:#F0F0F0;"><label>Nom & Prénom</label></td>
                        <td>';
        if ($user)
            $html .= $user->getAgents()->getNomcomplet();
        $html .= '</td>
                    </tr>
                    <tr>
                        <td style="background-color:#F0F0F0;"><label>Mail / Gsm / Poste</label></td>
                        <td>';
        if ($user)
            $html .= $user->getAgents()->getMail() . ' - ' . $user->getAgents()->getGsm() . ' - ' . $user->getAgents()->getPoste();
        $html .= '</td>
                    </tr>
                </tbody>
            </table>
            &nbsp;<br>
            <h2 style="font-size:16px;">Informations sur le Budget</h2>
            <table border="1" style="padding:1%">
                <tbody>
                    <tr>
                        <td style="width:22%; background-color:#F0F0F0;"><label>Date de Création</label></td>
                        <td style="width:28%">' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
                        <td style="width:16%; background-color:#F0F0F0;"><label>Type Budget</label></td>
                        <td style="width:34%">' . $this->getTypebudget() . '</td>
                    </tr>';
//                    <tr>
//                        <td style="background-color:#F0F0F0;"><label>Nom Budget</label></td>
//                        <td colspan="3">' . $this->getLibelle() . '</td>
//                    </tr>
//
        //                    <tr>
//                        <td style="background-color:#F0F0F0;"><label>Projet</label></td>
//                        <td>' . $this->getProjet() . '</td>
//                        <td style="background-color:#F0F0F0;"><label>Origine</label></td>
//                        <td>' . $this->getSourcesbudget() . '</td>
//                    </tr>';
//        if ($this->getTypebudget() == "Budget Prévisionnel / Direction & Projet" || $this->getTypebudget() == "Budget Prévisionnel Global")
//            $html .= '<tr>
//                        <td style="background-color:#F0F0F0;"><label>Direction</label></td>
//                        <td colspan="3">' . $this->getDirection() . '</td>
//                    </tr>';
//        $html .= '<tr>
//                        <td colspan="2" style="width:34%; background-color:#F0F0F0;"><label>Montant Global en TND</label></td>
//                        <td colspan="2" style="width:66%;">' . number_format($this->getMntglobal(), 3, '.', ' ') . '</td>
//                    </tr>
//                    <tr>
//                        <td colspan="2" style="width:34%; background-color:#F0F0F0;"><label>Prototype Ou  Budget Sources</label></td>
//                        <td colspan="2" style="width:66%;">' . $this->getSourcesbudget() . '</td>
//                    </tr>
//                    <tr>
//                        <td style="width:22%; background-color:#F0F0F0;"><label>Date de Validation</label></td>
//                        <td colspan="3" style="width:78%">' . $date_signature . '</td>
//                    </tr>
//                    <tr>
//                        <td style="width:22%; background-color:#F0F0F0;"><label>Montant Transfert en TND</label></td>
//                        <td style="width:28%;">' . number_format($this->getMntexterne(), 3, '.', ' ') . '</td>
//                        <td style="width:22%; background-color:#F0F0F0;"><label>Montant Débloqué en TND</label></td>
//                        <td style="width:28%;">' . number_format($total_debloque, 3, '.', ' ') . '</td>
//                    </tr>
        $html .= '<tr>
                                     <td colspan="2" style="width:34%; background-color:#F0F0F0;"><label>Montant Global en TND</label></td>
                                     <td colspan="2" style="width:66%;">' . number_format($this->getMntglobal(), 3, '.', ' ') . '</td>
                                 </tr>
                  </tbody>
            </table>
            &nbsp;<br>
            <h2 style="font-size:16px;">Chapitres & Rubriques budgétaires</h2>
            <table border="1" style="padding-left:4px;padding-left:4px;padding-top:6px;padding-bottom:6px;">
                <thead>
                    <tr style="background-color:#F0F0F0;font-size:11px;">
                        <th style="width:20%"><label>Code</label></th>
                        <th style="width:50%"><label>Rubrique + Sous Rubrique</label></th>
                        <th style="width:30%"><label>Montant global</label></th>';
//                        <th style="width:12%"><label>Mnt Encais.</label></th>
//                        <th style="width:12%"><label>Enc+Tran</label></th>
//                        <th style="width:12%"><label>Cré. Alloué</label></th>
        $html.='      </tr>
                </thead>
                <tbody>';
        $listes = Doctrine_Core::getTable('ligprotitrub')
                        ->createQuery('a')
                        ->where('id_titre=' . $this->getId())
                        ->OrderBy('LENGTH(nordre),nordre asc')->execute();
        $ligne = new Ligprotitrub();
        foreach ($listes as $l) {
            $ligne = $l;
            if (!$ligne->getRubrique()->getIdRubrique()) {
                $color = ''; //$this->random_color()  color:' . $color . '; 
                $html .= ' <tr style="font-size:10px;">
                            <td style="width:20%">' . $ligne->getCode() . '</td>
                            <td style="width:50%">' . $ligne->getRubrique()->getLibelle() . '</td>
                            <td style="width:30%;text-align:right;">' . number_format($ligne->getMnt(), 3, ".", ",") . '</td>';
//                            <td style="width:12%;text-align:right;">' . number_format($ligne->getMntexterne(), 3, ".", ",") . '</td>
//                            <td style="width:12%;text-align:right;">' . number_format($ligne->getMntencaisse() + $ligne->getMntexterne(), 3, ".", ",") . '</td>
//                            <td style="width:12%;text-align:right;">' . number_format($ligne->getMnt(), 3, ".", ",") . '</td>
                $html .= '     </tr>';
                $k = 1;
                $html .= $this->getTableRubrique($ligne, $color, $k);
//                $rubs = Doctrine_Core::getTable('rubrique')->findByIdRubrique($ligne->getIdRubrique());
//                if (count($rubs) > 0) {
//                    foreach ($rubs as $r) {
//                        $lignesousrubrique = Doctrine_Core::getTable('ligprotitrub')->findOneByIdRubriqueAndIdTitre($r->getId(), $this->getId());
//                        if ($lignesousrubrique) {
//                            $html.='<tr>
//                            <td colspan="4">
//                            <table>
//                                <tr style="color:' . $color . '">
//                                    <td style="width:3%"></td>
//                                    <td style="width:9%;font-size:11px;">' . $lignesousrubrique->getNordre() . '</td>
//                                    <td style="width:46%;font-size:11px;">' . $lignesousrubrique->getRubrique() . '</td>
//                                    <td style="width:20%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMnt(), 3, ".", ",") . '</td>
//                                    <td style="width:22%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse(), 3, ".", ",") . '</td>
//                                </tr>
//                            </table>
//                            </td>                        
//                            </tr>';
//                        }
//                    }
//                }
            }
        }
        $html .= ' </tbody>
            </table>';

        $html .= '<style>td{font-size:12px;}label{font-weight:bold;}h2{text-align:center;}</style>';

        return $html;
    }

    public function ReadHtmlListeBudgetParDirection($request) {
        $id_cat = $request->getParameter('id_cat', "");
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $type = 'Budget Prévisionnel Global';
        if ($_SESSION['exercice_budget'])
            $budgets = TitrebudjetTable::getInstance()->getByTypeAndCategorie($id_cat, $type, $_SESSION['exercice_budget']);
        else
            $budgets = TitrebudjetTable::getInstance()->getByType($type);

        $html = '';

        $html .= '<h3 style = "font-size:20px;">Budget Prévisionnels globale Par Direction</h3>';

        $categorie="";
        $mnt_par_direction="";
       
        if ($id_cat != ''):
            $categorietitrebudget = Doctrine_Core::getTable('categorietitre')->findOneById($id_cat);
            $categorie.=' Catégorie Budget : <b>' . $categorietitrebudget . '</b>';
            $query_mnt_direction="SELECT sum(a.mnt) as mnt,c.libelle, d.libelle as direction 
            FROM titrebudjet t,ligprotitrub a ,direction d ,categorietitre c,rubrique r
            WHERE a.id_titre=t.id AND t.typebudget='Budget Prévisionnel / Direction & Projet' and c.id=t.id_cat and r.id=a.id_rubrique and r.id_rubrique is  null
            AND a.id_titre = t.id and EXTRACT(YEAR FROM t.datecreation) =".$_SESSION['exercice_budget']." and t.id_direction=d.id and c.id=".$categorietitrebudget->getId()." group by(c.libelle, d.libelle )";
            
            $resul_mnt_direction = $conn->fetchAssoc($query_mnt_direction);
            $mnt_par_direction.='<h2 style = "font-size:16px;">Montant par direction</h2><table  border = "1"><tr style = "text-align:center;font-weight:bold;background-color:#F0F0F0;"><th>Direction</th><th>Montant (TND) </th></tr>';
            foreach ($resul_mnt_direction as $ligne_direction):
             
                $mnt_par_direction.='<tr  style = "text-align:center;"><td>'.$ligne_direction["direction"].'</td><td>'.$ligne_direction["mnt"].'</td></tr>';
            endforeach;
            $mnt_par_direction.="</table>";
            
        else:
            $categorie.=' Catégorie Budget : ';
        endif;
        $html.=' </td>
        </tr>
        </table>&nbsp;</br>';

        $html .= '
                <br><table border = "1" cellpadding = "3">
                <tr style = "text-align:center;font-weight:bold;background-color:#F0F0F0;">
                <td style = "width:55%;">Budget('.$type.')</td>
                <td style = "width:20%;">Date de Création</td>
                <td style = "width:25%;">Montant Global (TND)</td>
                </tr>';
        $i = 1;
        if ($budgets->count() != 0) :
            // foreach ($budgets as $budget) :
            if ($budgets->getFirst()->getDatecreation() != '')
                $date_creation = date('d/m/Y', strtotime($budgets->getFirst()->getDatecreation()));
            else
                $date_creation = '';
            $html .= '<tr style = "font-size:12px;">
                     <td>' . $categorie . '</td>
                <td style = "text-align:center;">' . $date_creation . '</td>               
                <td style = "text-align:right;">' . number_format($budgets->getFirst()->getMntglobal(), 3, '.', ' ') . '</td>
                </tr>';
                $html.='</table>'.$mnt_par_direction;

            $html .= '     <h2 style = "font-size:16px;">Chapitres & Rubriques budgétaires</h2>
                <table border = "1" style = "padding-left:4px;padding-left:4px;padding-top:6px;padding-bottom:6px;">
                <thead>
                <tr style = "background-color:#F0F0F0;font-size:11px;">
                <th style = "width:25%"><label>Code</label></th>
                <th style = "width:50%"><label>Rubrique </label></th>
                <th style = "width:25%"><label>Montant global</label></th>';
            $html.=' </tr>
                </thead>';
            $html.=' <tbody>';
            $listes = Doctrine_Core::getTable('ligprotitrub')
                    ->createQuery('a')
                    ->where('id_titre=' . $budgets->getFirst()->getId())
                    ->OrderBy('LENGTH(nordre),nordre asc')
                    ->execute();

            $ligne = new Ligprotitrub();
            foreach ($listes as $l) {
                $ligne = $l;
                if (!$ligne->getRubrique()->getIdRubrique()) {
                    $html .= ' <tr style="font-size:10px;">
                            <td style="width:25%">' . $ligne->getCode() . '</td>
                            <td style="width:50%">' . $ligne->getRubrique()->getLibelle() . '</td>
                            <td style="width:25%;text-align:right;"><b>' . number_format($ligne->getMnt(), 3, ".", ",") . '</b></td>';
                    $html .= '     </tr>';
                    $query = "SELECT a.mnt,t.libelle, d.libelle as direction "
                            . " FROM titrebudjet t,ligprotitrub a ,direction d"
                            . " WHERE a.id_titre=t.id "
                            . " AND t.typebudget='Budget Prévisionnel / Direction & Projet'"
                            . " AND a.id_titre = t.id"
                            . " and a.id_rubrique=" . $ligne->getIdRubrique()
                            . " and t.id_direction=d.id"
                    ;
                   
                    if ($id_cat)
                        $query.= " AND t.id_cat=" . $id_cat;
                    //  die($query);
                   
                    $resul = $conn->fetchAssoc($query);
                    foreach ($resul as $ligne_ligneligpr):
                        $html .= ' <tr style="font-size:10px;">';

                        $html.=' <td style="width:25%">' . '' . '</td>
                            <td style="width:50%"><b>' . $ligne_ligneligpr['direction'] . '</b></td>
                            <td style="width:25%;text-align:right;"><b>' . $ligne_ligneligpr['mnt'] . '</b></td>';
                        $html .= '     </tr>';
                    endforeach;

                    // endforeach;
                }
            }

            $html.=' ';

            $html .= ' </tbody>
            </table>';

        // endforeach;
        else :
            $html .= '<tr style = "font-size:12px;">
                <td style = "font-size:16px;font-weight:bold;height:65px;text-align:center;width:100%;">&nbsp;
                <br>Pas de Budget!</td>
                </tr>';
        endif;

        $html .= '</table>';

        return $html;
    }

    public function ReadHtmlListeBudgetParorigine($request) {
        $id_cat = $request->getParameter('id_cat', "");
        $type = 'Budget Prévisionnel Global';
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        if ($_SESSION['exercice_budget'])
            $budgets = TitrebudjetTable::getInstance()->getByTypeAndCategorie($id_cat, $type, $_SESSION['exercice_budget']);
        else
            $budgets = TitrebudjetTable::getInstance()->getByType($type);

        $html = '';

        $html .= '<h3 style = "font-size:20px;">Budgets Prévisionnels global Par Origine</h3>';

        $categorie="";
        $mnt_par_direction="";
       
        if ($id_cat != ''):
            $categorietitrebudget = Doctrine_Core::getTable('categorietitre')->findOneById($id_cat);
            $categorie.=' Catégorie Budget : <b>' . $categorietitrebudget . '</b>';
            $query_mnt_direction="SELECT sum(a.mnt) as mnt,c.libelle, d.libelle as direction ,s.source
            FROM titrebudjet t,ligprotitrub a ,direction d ,categorietitre c,rubrique r,sourcesbudget s
            WHERE a.id_titre=t.id and s.id=t.id_source AND t.typebudget='Budget Prévisionnel / Direction & Projet' and c.id=t.id_cat and r.id=a.id_rubrique and r.id_rubrique is  null
            AND a.id_titre = t.id and EXTRACT(YEAR FROM t.datecreation) =".$_SESSION['exercice_budget']." and t.id_direction=d.id and c.id=".$categorietitrebudget->getId()." group by(c.libelle, d.libelle ,s.source)";
            
            $resul_mnt_direction = $conn->fetchAssoc($query_mnt_direction);
            $mnt_par_direction.='<h2 style = "font-size:16px;">Montant par origine</h2>
            <table  border = "1"><tr style = "text-align:center;font-weight:bold;background-color:#F0F0F0;">
            <th>Origine</th><th>Direction</th><th>Montant (TND) </th></tr>';
            foreach ($resul_mnt_direction as $ligne_direction):
             
                $mnt_par_direction.='<tr  style = "text-align:center;"><td>'.$ligne_direction["source"].'</td><td>'.$ligne_direction['direction'].'</td><td>'.$ligne_direction["mnt"].'</td></tr>';
            endforeach;
            $mnt_par_direction.="</table>";
        else:
            $html.='<li> Catégorie Budget : - </li>';
        endif;
        $html .= '
        <br><table border = "1" cellpadding = "3">
        <tr style = "text-align:center;font-weight:bold;background-color:#F0F0F0;">
        <td style = "width:55%;">Budget('.$type.')</td>
        <td style = "width:20%;">Date de Création</td>
        <td style = "width:25%;">Montant Global (TND)</td>
        </tr>';
$i = 1;
if ($budgets->count() != 0) :
    // foreach ($budgets as $budget) :
    if ($budgets->getFirst()->getDatecreation() != '')
        $date_creation = date('d/m/Y', strtotime($budgets->getFirst()->getDatecreation()));
    else
        $date_creation = '';
    $html .= '<tr style = "font-size:12px;">
             <td>' . $categorie . '</td>
        <td style = "text-align:center;">' . $date_creation . '</td>               
        <td style = "text-align:right;">' . number_format($budgets->getFirst()->getMntglobal(), 3, '.', ' ') . '</td>
        </tr>';
        $html.='</table>'.$mnt_par_direction;


            $html .= '     <h2 style = "font-size:16px;">Chapitres & Rubriques budgétaires</h2>
                <table border = "1" style = "padding-left:4px;padding-left:4px;padding-top:6px;padding-bottom:6px;">
                <thead>
                <tr style = "background-color:#F0F0F0;font-size:11px;">
                <th style = "width:25%"><label>Code</label></th>
                <th style = "width:50%"><label>Rubrique </label></th>
                <th style = "width:25%"><label>Montant global</label></th>';
            $html.=' </tr>
                </thead>';
            $html.=' <tbody>';
            $listes = Doctrine_Core::getTable('ligprotitrub')
                    ->createQuery('a')
                    ->where('id_titre=' . $budgets->getFirst()->getId())
                    ->OrderBy('LENGTH(nordre),nordre asc')
                    ->execute();

            $ligne = new Ligprotitrub();
            foreach ($listes as $l) {
                $ligne = $l;
                if (!$ligne->getRubrique()->getIdRubrique()) {
                    $html .= ' <tr style="font-size:10px;">
                            <td style="width:25%">' . $ligne->getCode() . '</td>
                            <td style="width:50%">' . $ligne->getRubrique()->getLibelle() . '</td>
                            <td style="width:25%;text-align:right;"><b>' . number_format($ligne->getMnt(), 3, ".", ",") . '</b></td>';
                    $html .= '     </tr>';
                    $query = "SELECT a.mnt,t.libelle, source.source as origine, d.libelle as direction  "
                            . " FROM titrebudjet t,ligprotitrub a ,sourcesbudget source , direction d"
                            . " WHERE a.id_titre=t.id "
                            . " AND t.typebudget='Budget Prévisionnel / Direction & Projet'"
                            . " AND a.id_titre = t.id"
                            . " and a.id_rubrique=" . $ligne->getIdRubrique()
                            . " and t.id_source=source.id"
                            . " and t.id_direction=d.id"
                    ;
                    if ($id_cat)
                        $query.= " AND t.id_cat=" . $id_cat;
                    //  die($query);
                   
                    $resul = $conn->fetchAssoc($query);
                    foreach ($resul as $ligne_ligneligpr):
                        $html .= ' <tr style="font-size:10px;">';

                        $html.=' <td style="width:25%"><b>' . $ligne_ligneligpr['direction'] . '</b></td>
                            <td style="width:50%"><b>' . $ligne_ligneligpr['origine'] . '</b></td>
                            <td style="width:25%;text-align:right;"><b>' . number_format($ligne_ligneligpr['mnt'], 3, ".", " ") . '</b></td>';
                        $html .= '     </tr>';
                    endforeach;

                    // endforeach;
                }
            }

            $html.=' ';

            $html .= ' </tbody>
            </table>';

        // endforeach;
        else :
            $html .= '<tr style = "font-size:12px;">
                <td style = "font-size:16px;font-weight:bold;height:65px;text-align:center;width:100%;">&nbsp;
                <br>Pas de Budget!</td>
                </tr>';
        endif;

        $html .= '</table>';

        return $html;
    }

    public function getParDirection($listes_par_direction) {

        $html.= '';
//  $lignesousrubriques = LigprotitrubTable::getInstance()->getSousRubrique($rubrique->getIdRubrique(), $rubrique->getIdTitre());
        foreach ($listes_par_direction as $ligne_par_direction) :
//die('v '. count($listes_par_direction));
            $html .= '<tr>
                        <td colspan="6">
                            <table>
                                <tr style="color:' . $color . '">';
//            $width_code = 12.5;
//            for ($i = 0; $i < $k; $i++) :
//                $html .= '<td style="width:2%"></td>';
//                $width_code = $width_code - 2;
//            endfor;

            $html .= '<td style="width:18%;font-size:11px;">' . $ligne_par_direction->getDirection() . '</td>
                                    <td style="width:50%;font-size:11px;">' . $ligne_par_direction->getLibelle() . '</td>';
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse(), 3, ".", ",") . '</td>
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse() + $lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
            $html .= '           <td style="width:30%;text-align:right;font-size:11px;">' . number_format($ligne_par_direction->getMntglobal(), 3, ".", ",") . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>';
            $j = $k + 1;
//$html .= $this->getParDirection($listes_par_direction);
        endforeach;
        return $html;
    }

    public function getTableRubrique($rubrique, $color, $k) {
        $html = '';
        $lignesousrubriques = LigprotitrubTable::getInstance()->getSousRubrique($rubrique->getIdRubrique(), $rubrique->getIdTitre());
        foreach ($lignesousrubriques as $lignesousrubrique) :
            $html .= '<tr>
                        <td colspan="6">
                            <table>
                                <tr style="color:' . $color . '">';
            $width_code = 12.5;
            for ($i = 0; $i < $k; $i++) :
                $html .= '<td style="width:2%"></td>';
                $width_code = $width_code - 2;
            endfor;

            $html .= '<td style="width:18%;font-size:11px;">' . $lignesousrubrique->getCode() . '</td>
                                    <td style="width:50%;font-size:11px;">' . $lignesousrubrique->getRubrique()->getLibelle() . '</td>';
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse(), 3, ".", ",") . '</td>
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
//                                    <td style="width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse() + $lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
            $html .= '           <td style="width:30%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMnt(), 3, ".", ",") . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>';
            $j = $k + 1;
            $html .= $this->getTableRubrique($lignesousrubrique, $color, $j);
        endforeach;
        return $html;
    }

    public function getFormHtmlBudget($user) {

        if ($this->getDatesignature() != null)
            $date_signature = date('d/m/Y', strtotime($this->getDatesignature()));
        else
            $date_signature = '';

        $total_debloque = 0;
        $tranchebudgets = TranchebudgetTable::getInstance()->findByIdTitrebudget($this->getId());
        foreach ($tranchebudgets as $tranchebudget) {
            $total_debloque = $total_debloque + $tranchebudget->getMntvaleur();
        }

        $html = '';
        $html .= '<h3 style="font-size:18px;">' . $this->getLibelle() . '</h3>
            <h2 style="font-size:16px;">Identification du responsable suivi Budget</h2>
            <table border="1" style="padding:1%;width:100%;">
                <tbody>
                    <tr>
                        <td style="width: 35%;background-color:#F0F0F0;"><label>Responsable unité Budget</label></td>
                        <td style="width: 65%;">' . $user . '</td>
                    </tr>
                    <tr>
                        <td style="background-color:#F0F0F0;"><label>Nom & Prénom</label></td>
                        <td>';
        if ($user)
            $html .= $user->getAgents()->getNomcomplet();

        $html .= '</td>
</tr>
<tr>
<td style = "background-color:#F0F0F0;"><label>Mail / Gsm / Poste</label></td>
<td>';
        if ($user)
            $html .= $user->getAgents()->getMail() . ' - ' . $user->getAgents()->getGsm() . ' - ' . $user->getAgents()->getPoste();
        $html .= '</td>
</tr>
</tbody>
</table>
&nbsp;
<br>
<h2 style = "font-size:16px;">Informations sur le Budget</h2>
<table border = "1" style = "padding:1%">
<tbody>
<tr>
<td style = "width:22%; background-color:#F0F0F0;"><label>Date de Création</label></td>
<td style = "width:28%">' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
<td style = "width:16%; background-color:#F0F0F0;"><label>Type Budget</label></td>
<td style = "width:34%">' . $this->getTypebudget() . '</td>
</tr>
<tr>
<td style = "background-color:#F0F0F0;"><label>Nom Budget</label></td>
<td colspan = "3">' . $this->getLibelle() . '</td>
</tr>

<tr>
<td style = "background-color:#F0F0F0;"><label>Projet</label></td>
<td>' . $this->getProjet() . '</td>
<td style = "background-color:#F0F0F0;"><label>Origine</label></td>
<td>' . $this->getSourcesbudget() . '</td>
</tr>';

        if (trim($this->getTypebudget()) == "Budget Prévisionnel / Direction & Projet" || trim($this->getTypebudget()) == "Budget Prévisionnel Global")
            $html .= '<tr>
<td style = "background-color:#F0F0F0;"><label>Direction</label></td>
<td colspan = "3">' . $this->getDirection()->getLibelle() . '</td>
</tr>';

        $html .= '<tr>
<td colspan = "2" style = "width:34%; background-color:#F0F0F0;"><label>Montant Global en TND</label></td>
<td colspan = "2" style = "width:66%;">' . number_format($this->getMntglobal(), 3, '.', ' ') . '</td>
</tr>
<tr>
<td colspan = "2" style = "width:34%; background-color:#F0F0F0;"><label>Prototype Ou Budget Sources</label></td>
<td colspan = "2" style = "width:66%;">' . $this->getSourcesbudget() . '</td>
</tr>
<tr>
<td style = "width:22%; background-color:#F0F0F0;"><label>Date de Validation</label></td>
<td colspan = "3" style = "width:78%">' . $date_signature . '</td>
</tr>
<tr>
<td style = "width:22%; background-color:#F0F0F0;"><label>Montant Transfert en TND</label></td>
<td style = "width:28%;">' . number_format($this->getMntexterne(), 3, '.', ' ') . '</td>
<td style = "width:22%; background-color:#F0F0F0;"><label>Montant Débloqué en TND</label></td>
<td style = "width:28%;">' . number_format($total_debloque, 3, '.', ' ') . '</td>
</tr>
</tbody>
</table>
&nbsp;
<br>
<h2 style = "font-size:16px;">Chapitres & Rubriques budgétaires</h2>
<table border = "1" style = "padding-left:4px;padding-left:4px;padding-top:6px;padding-bottom:6px;">
<thead>
<tr style = "background-color:#F0F0F0;font-size:11px;">
<th style = "width:13%"><label>Code</label></th>
<th style = "width:39%"><label>Rubrique + Sous Rubrique</label></th>
<th style = "width:12%"><label>Mnt Transf.</label></th>
<th style = "width:12%"><label>Mnt Encais.</label></th>
<th style = "width:12%"><label>Enc+Tran</label></th>
<th style = "width:12%"><label>Cré. Alloué</label></th>
</tr>
</thead>
<tbody>';
        $listes = Doctrine_Core::getTable('ligprotitrub')
                        ->createQuery('a')
                        ->where('id_titre = ' . $this->getId())
                        ->OrderBy('LENGTH(nordre), nordre asc')->execute();
        $ligne = new Ligprotitrub();
        foreach ($listes as $l) {
            $ligne = $l;
            if (!$ligne->getRubrique()->getIdRubrique()) {
                if (trim($this->getTypebudget() == "Budget Prévisionnel / Direction & Projet") || trim($this->getTypebudget()) == "Budget Prévisionnel Global") {
                    $sous_rubriques = LigprotitrubTable::getInstance()->getSousRubrique($ligne->getIdRubrique(), $ligne->getIdTitre());
                    if ($sous_rubriques->count() == 0)
                        $code = '<span class = "btn btn-success btn-xs pull-right" onclick = "setTableAnnexe(' . $ligne->getId() . ')"><i class = "ace-icon fa fa-list bigger-110 icon-only"></i></span>' . $ligne->getCode();
                    else
                        $code = $ligne->getCode();
                } else {
                    $code = $ligne->getCode();
                }
                $color = ''; //color:' . $color . ';  $this->random_color();
                $html .= ' <tr style = "font-size:10px;">
<td style = "width:13%">' . $code . '</td>
<td style = "width:39%">' . $ligne->getRubrique() . '</td>
<td style = "width:12%;text-align:right;">' . number_format($ligne->getMntencaisse(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;">' . number_format($ligne->getMntexterne(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;">' . number_format($ligne->getMntencaisse() + $ligne->getMntexterne(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;">' . number_format($ligne->getMnt(), 3, ".", ",") . '</td>
</tr>';
                $k = 1;
                $html .= $this->getFormTableRubrique($ligne, $color, $k);
            }
        }
        $html .= ' </tbody>
</table>';

        $html .= '<style>td{font-size:12px;
}label{font-weight:bold;
}h2{text-align:center;
}</style>';

        return $html;
    }

    public function getFormTableRubrique($rubrique, $color, $k) {
        $html = '';
        $lignesousrubriques = LigprotitrubTable::getInstance()->getSousRubrique($rubrique->getIdRubrique(), $rubrique->getIdTitre());
        foreach ($lignesousrubriques as $lignesousrubrique) :
            $html .= '<tr>
<td colspan = "6">
<table>
<tr style = "color:' . $color . '">';
            $width_code = 12.5;
            for ($i = 0; $i < $k; $i++) :
                $html .= '<td style = "width:2%"></td>';
                $width_code = $width_code - 2;
            endfor;

            if (trim($this->getTypebudget() == "Budget Prévisionnel / Direction & Projet") || trim($this->getTypebudget()) == "Budget Prévisionnel Global") {
                $sous_rubriques = LigprotitrubTable::getInstance()->getSousRubrique($lignesousrubrique->getIdRubrique(), $lignesousrubrique->getIdTitre());
                if ($sous_rubriques->count() == 0)
                    $code = '<span class = "btn btn-success btn-xs pull-right" onclick = "setTableAnnexe(' . $lignesousrubrique->getId() . ')"><i class = "ace-icon fa fa-list bigger-110 icon-only"></i></span>' . $lignesousrubrique->getCode();
                else
                    $code = $lignesousrubrique->getCode();
            } else {
                $code = $lignesousrubrique->getCode();
            }

            $html .= '<td style = "width:' . $width_code . '%;font-size:11px;">' . $code . '</td>
<td style = "width:39.5%;font-size:11px;">' . $lignesousrubrique->getRubrique() . '</td>
<td style = "width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMntencaisse() + $lignesousrubrique->getMntexterne(), 3, ".", ",") . '</td>
<td style = "width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMnt(), 3, ".", ",") . '</td>
</tr>
</table>
</td>
</tr>';
            $j = $k + 1;
            $html .= $this->getFormTableRubrique($lignesousrubrique, $color, $j);
        endforeach;
        return $html;
    }

    public function ReadHtmlListeBudget($type) {
        if ($_SESSION['exercice_budget'])
            $budgets = TitrebudjetTable::getInstance()->getByType($type, $_SESSION['exercice_budget']);
        else
            $budgets = TitrebudjetTable::getInstance()->getByType($type);

        $html = '';
        if (!(strpos(trim($type), "Direction") === false)) {
            if ($_SESSION['exercice_budget'])
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Prévisionnels / Direction & Projet<br>Année : ' . $_SESSION['exercice_budget'] . '</h3>';
            else
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Prévisionnels / Direction & Projet</h3>';
        } elseif (!(strpos(trim($type), "Global") === false)) {
            if ($_SESSION['exercice_budget'])
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Prévisionnels Globaux<br>Année : ' . $_SESSION['exercice_budget'] . '</h3>';
            else
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Prévisionnels Globaux</h3>';
        } elseif (strpos(trim($type), "Final") === false)
            $html .= '<h3 style = "font-size:20px;">Liste des Budgets Prototypes</h3>';
        else {
            if ($_SESSION['exercice_budget'])
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Définitifs<br>Année : ' . $_SESSION['exercice_budget'] . '</h3>';
            else
                $html .= '<h3 style = "font-size:20px;">Liste des Budgets Définitifs</h3>';
        }

        $html .= '&nbsp;
<br><table border = "1" cellpadding = "3">
<tr style = "text-align:center;font-weight:bold;background-color:#F0F0F0;">
<td style = "width:3%;">N°</td>
<td style = "width:9%;">Date de Création</td>
<td style = "width:25%;">Titre de budget</td>
<td style = "width:17%;">Catégorie du Budget</td>
<td style = "width:19%;">Projet</td>
<td style = "width:15%;">Origine</td>
<td style = "width:12%;">Montant Global (TND)</td>
</tr>';
        $i = 1;
        if ($budgets->count() != 0) :
            foreach ($budgets as $budget) :
                if ($budget->getDatecreation() != '')
                    $date_creation = date('d/m/Y', strtotime($budget->getDatecreation()));
                else
                    $date_creation = '';
                $html .= '<tr style = "font-size:12px;">
<td style = "height:25px;text-align:center;">' . $i . '</td>
<td style = "text-align:center;">' . $date_creation . '</td>
<td>' . $budget->getLibelle() . '</td>
<td>' . $budget->getCategorietitre() . '</td>
<td>' . $budget->getProjet() . '</td>
<td>' . $budget->getSourcesbudget() . '</td>
<td style = "text-align:right;">' . number_format($budget->getMntglobal(), 3, '.', ' ') . '</td>
</tr>';
                $i++;
            endforeach;
        else :
            $html .= '<tr style = "font-size:12px;">
<td style = "font-size:16px;font-weight:bold;height:65px;text-align:center;width:100%;">&nbsp;
<br>Pas de Budget!</td>
</tr>';
        endif;

        $html .= '</table>';

        return $html;
    }

    public function ReadHtmlBudgetPrevisionelleGlobal() {
        $user = $this->getUtilisateur();
        if ($this->getDatesignature() != null)
            $date_signature = date('d/m/Y', strtotime($this->getDatesignature()));
        else
            $date_signature = '';

        $total_debloque = 0;
        $tranchebudgets = TranchebudgetTable::getInstance()->findByIdTitrebudget($this->getId());
        foreach ($tranchebudgets as $tranchebudget) {
            $total_debloque = $total_debloque + $tranchebudget->getMntvaleur();
        }

        $html = '';
        $html .= '<h3 style="font-size:18px;">' . $this->getLibelle() . '</h3>
        <h2 style="font-size:16px;">Identification du responsable suivi Budget</h2>
        <table border="1" style="padding:1%;width:100%;">
            <tbody>
                <tr>
                    <td style="width: 35%;background-color:#F0F0F0;"><label>Responsable unité Budget</label></td>
                    <td style="width: 65%;">' . $user . '</td>
                </tr>
                <tr>
                    <td style="background-color:#F0F0F0;"><label>Nom & Prénom</label></td>
                    <td>';
        if ($user)
            $html .= $user->getAgents()->getNomcomplet();

        $html .= '</td>
</tr>
<tr>
<td style = "background-color:#F0F0F0;"><label>Mail / Gsm / Poste</label></td>
<td>';
        if ($user)
            $html .= $user->getAgents()->getMail() . ' - ' . $user->getAgents()->getGsm() . ' - ' . $user->getAgents()->getPoste();
        $html .= '</td>
</tr>
</tbody>
</table>
&nbsp;
<br>
<h2 style = "font-size:16px;">Informations sur le Budget</h2>
<table border = "1" style = "padding:1%">
<tbody>
<tr>
<td style = "width:22%; background-color:#F0F0F0;"><label>Date de Création</label></td>
<td style = "width:28%">' . date('d/m/Y', strtotime($this->getDatecreation())) . '</td>
<td style = "width:16%; background-color:#F0F0F0;"><label>Type Budget</label></td>
<td style = "width:34%">' . $this->getTypebudget() . '</td>
</tr>
<tr>

</tr>
';

        $html .= '<tr>
<td  style = " background-color:#F0F0F0;"><label>Montant Global en TND</label></td>
<td colspan="3">' . number_format($this->getMntglobal(), 3, '.', ' ') . '</td>
</tr>';
// <tr>
// <td style = "width:22%; background-color:#F0F0F0;"><label>Date de Creation</label></td>
// <td colspan = "3" style = "width:78%">' . $date_signature . '</td>
// </tr>

        $html .= '</tbody>
</table>
&nbsp;
<br>
<h2 style = "font-size:16px;">Chapitres & Rubriques budgétaires</h2>
<table border = "1" style = "padding-left:4px;padding-left:4px;padding-top:6px;padding-bottom:6px;">
<thead>
<tr style = "background-color:#F0F0F0;font-size:11px;">
<th style = "width:13%"><label>Code</label></th>
<th style = "width:39%"><label>Rubrique + Sous Rubrique</label></th>

<th style = "width:12%"><label>Montant global</label></th>
</tr>
</thead>
<tbody>';
        $listes = Doctrine_Core::getTable('ligprotitrub')
                        ->createQuery('a')
                        ->where('id_titre = ' . $this->getId())
                        ->OrderBy('LENGTH(nordre), nordre asc')->execute();
        $ligne = new Ligprotitrub();
        foreach ($listes as $l) {
            $ligne = $l;
            if (!$ligne->getRubrique()->getIdRubrique()) {
                if (trim($this->getTypebudget() == "Budget Prévisionnel / Direction & Projet") || trim($this->getTypebudget()) == "Budget Prévisionnel Global") {
                    $sous_rubriques = LigprotitrubTable::getInstance()->getSousRubrique($ligne->getIdRubrique(), $ligne->getIdTitre());
                    if ($sous_rubriques->count() == 0)
                        $code = '<span class = "btn btn-success btn-xs pull-right" onclick = "setTableAnnexe(' . $ligne->getId() . ')"><i class = "ace-icon fa fa-list bigger-110 icon-only"></i></span>' . $ligne->getCode();
                    else
                        $code = $ligne->getCode();
                } else {
                    $code = $ligne->getCode();
                }
                $color = ''; //color:' . $color . ';  $this->random_color();
                $html .= ' <tr style = "font-size:10px;">
<td style = "width:13%">' . $code . '</td>
<td style = "width:39%">' . $ligne->getRubrique() . '</td>
<td style = "width:12%;text-align:right;">' . number_format($ligne->getMnt(), 3, ".", ",") . '</td>
</tr>';
                $k = 1;
                $html .= $this->getFormTableRubriqueGlobal($ligne, $color, $k);
            }
        }
        $html .= ' </tbody>
</table>';

        $html .= '<style>td{font-size:12px;
}label{font-weight:bold;
}h2{text-align:center;
}</style>';

        return $html;
    }

    public function getFormTableRubriqueGlobal($rubrique, $color, $k) {
        $html = '';
        $lignesousrubriques = LigprotitrubTable::getInstance()->getSousRubrique($rubrique->getIdRubrique(), $rubrique->getIdTitre());
        foreach ($lignesousrubriques as $lignesousrubrique) :
            $html .= '<tr>
<td colspan = "6">
<table>
<tr style = "color:' . $color . '">';
            $width_code = 12.5;
            for ($i = 0; $i < $k; $i++) :
                $html .= '<td style = "width:2%"></td>';
                $width_code = $width_code - 2;
            endfor;

            if (trim($this->getTypebudget() == "Budget Prévisionnel / Direction & Projet") || trim($this->getTypebudget()) == "Budget Prévisionnel Global") {
                $sous_rubriques = LigprotitrubTable::getInstance()->getSousRubrique($lignesousrubrique->getIdRubrique(), $lignesousrubrique->getIdTitre());
                if ($sous_rubriques->count() == 0)
                    $code = '<span class = "btn btn-success btn-xs pull-right" onclick = "setTableAnnexe(' . $lignesousrubrique->getId() . ')"><i class = "ace-icon fa fa-list bigger-110 icon-only"></i></span>' . $lignesousrubrique->getCode();
                else
                    $code = $lignesousrubrique->getCode();
            } else {
                $code = $lignesousrubrique->getCode();
            }

            $html .= '<td style = "width:' . $width_code . '%;font-size:11px;">' . $code . '</td>
<td style = "width:39.5%;font-size:11px;">' . $lignesousrubrique->getRubrique() . '</td>
<td style = "width:12%;text-align:right;font-size:11px;">' . number_format($lignesousrubrique->getMnt(), 3, ".", ",") . '</td>
</tr>
</table>
</td>
</tr>';
            $j = $k + 1;
            $html .= $this->getFormTableRubrique($lignesousrubrique, $color, $j);
        endforeach;
        return $html;
    }

}
