<?php

/**
 * RecapbudgetTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class RecapbudgetTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object RecapbudgetTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Recapbudget');
    }

    public function getByAnneeAndMois($annee, $mois, $id_titre) {
        $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('ru.id_rubrique is  null')
                ->andWhere('r.annees_exercice = ?', $annee)
                ->andWhere('r.mois = ?', $mois)
                ->andWhere('r.id_budget = ?', $id_titre)
                ->andWhere("l.nordre NOT LIKE '%-%'")
                ->orderBy('LENGTH(l.nordre), l.nordre');
        //    die($q);
        $q = $q->execute();
        return $q;
    }

    public function getSousByAnneeAndMois($annee, $mois, $id_titre, $id_rubrique) {
        $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('ru.id_rubrique = ?', $id_rubrique)
                ->andWhere('r.annees_exercice = ?', $annee)
                ->andWhere('r.mois = ?', $mois)
                ->andWhere('r.id_budget = ?', $id_titre)
                ->orderBy('LENGTH(l.nordre), l.nordre')
                ->execute();
        return $q;
    }

    public function getByMoisAndLigpr($id_lig, $mois) {
        $annee = date('Y');
        $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('r.mois = ?', $mois)
                ->andWhere('r.annees_exercice = ?', $annee)
                ->andWhere("r.id_ligrubtitre=" . $id_lig)
                ->orderBy('l.nordre');
        $q = $q->execute();
        return $q;
    }

    public function getByIdLigrubMois($id_lig, $mois) {
        $annee = date('Y');
        $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('r.mois >=' . $mois)
                ->andWhere('r.annees_exercice = ?', $annee)
                ->andWhere("r.id_ligrubtitre=" . $id_lig)
                ->orderBy('l.nordre');
        // die($q);
        $q = $q->execute();
        return $q;
    }

    public function getByMoisAndRubrique($id_rubrique, $mois, $annee) {

        $q = $this->createQuery('r')
                ->leftJoin('r.Ligprotitrub l')
                ->leftJoin('l.Rubrique ru')
                ->where('r.mois = ?', $mois)
                ->andWhere('r.annees_exercice = ?', $annee)
                ->andWhere("r.id_rubrique=" . $id_rubrique)
                ->orderBy('l.nordre');
        $q = $q->execute();
        return $q;
    }

}
