<?php

/**
 * Lignemouvementfacturation
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProject1
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Lignemouvementfacturation extends BaseLignemouvementfacturation {

    public function __toString() {
        return "N°" . $this->getOrdre() . ' (' . date('d/m/Y', strtotime($this->getDate())) . ')';
    }

    public function ReadHtmlMouvements($date_debut, $date_fin, $fournisseur_id, $facture, $idtype, $valide = '') {

        $mouvements = LignemouvementfacturationTable::getInstance()->findAllMouvement($date_debut, $date_fin, $fournisseur_id, $facture, $idtype, $valide);

        switch ($idtype) {
            case 2:
                $document_label = " B.D.C";
                $th_label = "B.D.C";
                break;

            case 7:
                $document_label = " B.C.E";
                $th_label = "B.C.E";
                break;

            case 19:
                $document_label = " Contrats";
                $th_label = "Contrats";
                break;

            default :
                $document_label = " <br>B.D.C / B.C.E / Contrats";
                $th_label = "B.D.C / B.C.E / Contrats";
                break;
        }

        $html = '';

        $html.='<table>
                    <tr>
                        <td style="35%;"></td>
                        <td style="30%; text-align:center;"><h2>&nbsp;<br><u>Journal des Mouvements' . $document_label . '</u></h2></td>
                        <td style="35%;text-align:right;font-size:12px;">' . date('H:i d/m/Y') . '</td>
                    </tr>
                </table>';

        if ($date_debut != '')
            $periode_de = 'de ' . date('d/m/Y', strtotime($date_debut));
        else
            $periode_de = ' ----- ';

        if ($date_fin != '')
            $periode_a = 'à ' . date('d/m/Y', strtotime($date_fin));
        else
            $periode_a = ' ----- ';

        if ($fournisseur_id != '' && $fournisseur_id != 0)
            $fournisseur = FournisseurTable::getInstance()->find($fournisseur_id);
        else
            $fournisseur = ' Tous les fournisseurs ';

        $html.='&nbsp;<br><table>
                    <tr>
                        <td style="50%;text-align:left;font-size:12px;"><b>Période :</b> ' . $periode_de . ' ' . $periode_a . '</td>
                        <td style="50%;text-align:right;font-size:12px;"><b>Fournisseur :</b> ' . $fournisseur . '</td>
                    </tr>
                </table>&nbsp;<br>';

        $html.='<table cellspacing="0" cellpadding="2" border="1" style="margin:0px;">
                    <thead>
                        <tr>
                            <th style="width:5%;height:25px;text-align:center;background-color:#EDEDED;border-left-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>N°</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Facture N°</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;font-size:9px;"><b>' . $th_label . '</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:13%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>R.R.S + P.V.R</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:25%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Fournisseur</b></th>
                        </tr>
                    </thead>
                    <tbody>';
        if ($mouvements->count() >= 1) {
            $i = 0;
            $class = "secondtd";
            $total = 0;
            foreach ($mouvements as $mvt):
                $var = $i % 2;
                if ($var == 0)
                    $class = "secondtd";
                else
                    $class = "fersttd";

                $i++;
                  $doc_achat = DocumentachatTable::getInstance()->find($mvt->getIdDocumentachat());
                $html .= '<tr class="' . $class . '" style="font-size:11px;">
	                        <td style="width:5%;text-align:center;height:25px;border-left-width:1px;border-right-width:1px;">' . $mvt->getOrdre() . '</td>
	                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($mvt->getDate())) . '</td>
	                        <td style="width:10%;text-align:center;border-right-width:1px;">' . $mvt->getNumerofacture() . '</td>
	                        <td style="width:10%;text-align:right;border-right-width:1px;">' . number_format($mvt->getMontant(), 3, '.', ' ') . '</td>
	                        <td style="width:10%;text-align:center;border-right-width:1px;">' . $doc_achat->getNumerodocachat() . '</td>
	                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($doc_achat->getDatecreation())) . '</td>
	                        <td style="width:13%;text-align:center;border-right-width:1px;">' . $mvt->getRrs() . ' + ' . $mvt->getPvr() . '</td>
	                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($mvt->getDaterrspvr())) . '</td>
	                        <td style="width:25%;text-align:left;border-right-width:1px;">&nbsp;' . $mvt->getFournisseur()->getRs() . '</td>
	                    </tr>';
                $total = $total + $mvt->getMontant();
            endforeach;
              $html.='<tr style="background-color:#EDEDED;"><td colspan="3" style="text-align:center;font-size: 14px; " ><b>ToTal</b></td>
                    <td style="text-align:rigth;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>
                       ' . number_format($total,3, '.', ' ') . '</b>
                        </td><td colspan="5"></td>
                    </tr>';
        }else {
            $html.='<tr>
                        <td style="width:100%;text-align:center;height:100px;font-size:14px;font-weight:bold;border-left-width:1px;border-bottom-width:1px;border-right-width:1px;">&nbsp;<br>&nbsp;<br>Pas de mouvements dans cette période</td>
                    </tr>';
        }
      
        $html.='</tbody>
                </table>';

        return $html;
    }

    public function ReadHtmlListesdesMouvements() {

        $mouvements = LignemouvementfacturationTable::getInstance()->findAllMouvementbyidDesc();

        switch ($idtype) {
            case 2:
                $document_label = " B.D.C";
                $th_label = "B.D.C";
                break;

            case 7:
                $document_label = " B.C.E";
                $th_label = "B.C.E";
                break;

            case 19:
                $document_label = " Contrats";
                $th_label = "Contrats";
                break;

            default :
                $document_label = " <br>B.D.C / B.C.E / Contrats";
                $th_label = "B.D.C / B.C.E / Contrats";
                break;
        }

        $html = '';

        $html.='<table>
                    <tr>
                        <td style="35%;"></td>
                        <td style="30%; text-align:center;"><h2>&nbsp;<br><u>Journal des Mouvements' . $document_label . '</u></h2></td>
                        <td style="35%;text-align:right;font-size:12px;">' . date('H:i d/m/Y') . '</td>
                    </tr>
                </table>';


        $fournisseur = ' Tous les fournisseurs ';

        $html.='&nbsp;<br><table>
                    <tr>
                         </tr>
                </table>&nbsp;<br>';

        $html.='<table cellspacing="0" cellpadding="2" border="1" style="margin:0px;">
                    <thead>
                        <tr>
                            <th style="width:5%;height:25px;text-align:center;background-color:#EDEDED;border-left-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>N°</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Facture N°</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant</b></th>
                            <th style="width:10%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;font-size:9px;"><b>' . $th_label . '</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:13%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>R.R.S + P.V.R</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:25%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Fournisseur</b></th>
                        </tr>
                    </thead>
                    <tbody>';
        if ($mouvements->count() >= 1) {
            $i = 0;
            $class = "secondtd";
            foreach ($mouvements as $mvt):
                $var = $i % 2;
                if ($var == 0)
                    $class = "secondtd";
                else
                    $class = "fersttd";

                $i++;
                $html.='<tr class="' . $class . '" style="font-size:11px;">
                        <td style="width:5%;text-align:center;height:25px;border-left-width:1px;border-right-width:1px;">' . $mvt->getOrdre() . '</td>
                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($mvt->getDate())) . '</td>
                        <td style="width:10%;text-align:center;border-right-width:1px;">' . $mvt->getNumerofacture() . '</td>
                        <td style="width:10%;text-align:right;border-right-width:1px;">' . number_format($mvt->getMontant(), 3, '.', ' ') . '</td>
                        <td style="width:10%;text-align:center;border-right-width:1px;">' . $mvt->getDocumentachat()->getNumerodocachat() . '</td>
                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($mvt->getDocumentachat()->getDatecreation())) . '</td>
                        <td style="width:13%;text-align:center;border-right-width:1px;">' . $mvt->getRrs() . ' + ' . $mvt->getPvr() . '</td>
                        <td style="width:9%;text-align:center;border-right-width:1px;">' . date('d/m/Y', strtotime($mvt->getDaterrspvr())) . '</td>
                        <td style="width:25%;text-align:left;border-right-width:1px;">&nbsp;' . $mvt->getFournisseur()->getRs() . '</td>
                    </tr>';
            endforeach;
        }else {
            $html.='<tr>
                        <td style="width:100%;text-align:center;height:100px;font-size:14px;font-weight:bold;border-left-width:1px;border-bottom-width:1px;border-right-width:1px;">&nbsp;<br>&nbsp;<br>Pas de mouvements </td>
                    </tr>';
        }

        $html.='</tbody>
                </table>';

        return $html;
    }

}
