<?php

/**
 * Historiqueretenue
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Historiqueretenue extends BaseHistoriqueretenue {

    public function ReadHtmlListeRetenueMensielle(sfWebRequest $request) {
        $id_agents = $request->getParameter('id_agents', '');
        $demande_retenue = $request->getParameter('id_demande_retenue', '');
        $demande_avance = $request->getParameter('id_demande_avance', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $demande_pret = $request->getParameter('id_demandepret', '');
        if ($demande_pret != '') {
            $pret = Doctrine_Core::getTable('pret')->findOneById($demande_pret);
        }
        if ($demande_avance != '') {
            $avance = Doctrine_Core::getTable('avance')->findOneById($demande_avance);
        }
        if ($demande_retenue != '') {
            $retenue = Doctrine_Core::getTable('fournisseur')->findOneById($demande_retenue);
        }

        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $q = Doctrine_Core::getTable('Historiqueretenue')
                ->createQuery('h')
                ->select('h.*, COALESCE(da.id_agents, dp.id_agents, rs.id_agents) as agents_id')
                ->from('Historiqueretenue h')
                ->leftJoin('h.Demandeavance da')
                ->leftJoin('h.Demandepret dp')
                ->leftJoin('h.Retenuesursalaire rs');

        if ($annee != '')
            $q->where('h.annee = ' . intval($annee));
        if ($mois != '')
            $q->andWhere('h.mois = ' . intval($mois));

        if ($demande_retenue != '') {
            $q->andWhere('rs.id_fournisseur = ' . $demande_retenue);
            if ($id_agents != '')
                $q->andWhere('rs.id_agents = ' . $id_agents);
        }

        if ($demande_pret != '') {
            $q->andWhere('dp.id_typepret = ' . $demande_pret);
            if ($id_agents != '')
                $q->andWhere('dp.id_agents = ' . $id_agents);
        }

        if ($demande_avance != '') {
            $q->andWhere('da.id_typeavance = ' . $demande_avance);
            if ($id_agents != '')
                $q->andWhere('da.id_agents = ' . $id_agents);
        }

        if ($demande_retenue == '' && $demande_pret == '' && $demande_avance == '' && $id_agents != '')
            $q->andWhere('(rs.id_agents = ' . $id_agents . ' OR dp.id_agents = ' . $id_agents . ' OR da.id_agents = ' . $id_agents . ')');

        $q->orderBy('agents_id, h.annee, h.mois');

        $demandes = $q->execute();

        $html = '<h3>RECAPITULATIF DES RETENUES ';
        if ($id_agents != ""):$html .="De " . $agents->getNomcomplet() . " " . $agents->getPrenom();
        endif;

        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;

        if ($demande_retenue != ""):$html .="Du Fournisseur" . $retenue->getRs();
        endif;


        if ($demande_avance != ""):$html .="De l'" . $avance->getLibelle();
        endif;

        if ($demande_pret != ""):$html .="De " . $pret->getLibelle() . " Du " . $pret->getSourcepret()->getLibelle();
        endif;
        $html.='&nbsp;<br>&nbsp;<br> <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style = "width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style = "width: 8%;text-align:center;"><label>Matricule</label></td>
                        <td style = "width: 15%;text-align:center;"><label>Nom Complet</label></td>
                        <td style = "width: 15%;text-align:center;"><label>Type</label></td>
                        <td style = "width: 7%;text-align:center;"><label>Mois</label></td>
                        <td style = "width: 5%;text-align:center;"><label>Année</label></td>
                        <td style = "width: 10%;text-align:center;"><label>Montant Total</label></td>
                        <td style = "width: 10%;text-align:center;"><label>Retenue Men. </label></td>
                        <td style = "width: 7%;text-align:center;"><label>Période </label></td>
                        <td style = "width: 9%;text-align:center;"><label>Date Début</label></td>
                        <td style = "width: 9%;text-align:center;"><label>Date Fin</label></td>
                    </tr>';

        $i = 1;
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        $resultat = 0;
        $resultat_mensuel = 0;
        $current_agent_id = '';
        $current_agent_name = '';
        $total_montant_agent = 0;
        $total_retenue_agent = 0;
        foreach ($demandes as $demande):
            if ($current_agent_id != $demande->getAgentsId()) {
                if ($current_agent_id != '') {
                    //Ajouter ligne total agent
                    $html.='<tr>
                                <td style = "width: 5%;text-align:center;height:30px;background-color:#EDEDED;"></td>
                                <td style = "width: 38%;text-align:center;" colspan="3">' . $current_agent_name . '</td>
                                <td style = "width: 12%;text-align:center;height:25px;" colspan="2">Total</td>
                                <td style = "width: 10%;text-align:center;">' . number_format($total_montant_agent, 3, '.', ' ') . '</td>
                                <td style = "width: 10%;text-align:center;"> ' . number_format($total_retenue_agent, 3, '.', ' ') . '</td>
                                <td style = "width: 25%;text-align:center;" colspan="3"></td>
                            </tr>';
                }
                $current_agent_id = $demande->getAgentsId();
                $total_montant_agent = 0;
                $total_retenue_agent = 0;
            }

            $html.='<tr style ="font-size:12px;">
                        <td style ="width: 5%;height:25px;text-align:center;">' . $i . '</td>';
            if ($demande->getIdDemandeavance() != null):
                $html.= '<td style ="width: 8%;text-align:center;">' . $demande->getDemandeavance()->getAgents()->getIdrh() . '</td>
                        <td style="width: 15%;">' . $demande->getDemandeavance()->getAgents()->getNomcomplet() . ' ' . $demande->getDemandeavance()->getAgents()->getPrenom() . '</td>';
                $current_agent_name = $demande->getDemandeavance()->getAgents()->getNomcomplet() . ' ' . $demande->getDemandeavance()->getAgents()->getPrenom();
            elseif ($demande->getIdRetenue() != null):
                $html.= '<td style ="width: 8%;text-align:center;">' . $demande->getRetenuesursalaire()->getAgents()->getIdrh() . '</td>
                        <td style="width: 15%;">' . $demande->getRetenuesursalaire()->getAgents()->getNomcomplet() . ' ' . $demande->getRetenuesursalaire()->getAgents()->getPrenom() . '</td>';
                $current_agent_name = $demande->getRetenuesursalaire()->getAgents()->getNomcomplet() . ' ' . $demande->getRetenuesursalaire()->getAgents()->getPrenom();
            elseif ($demande->getIdDemandepret() != null):
                $html.= '<td style ="width: 8%;text-align:center;">' . $demande->getDemandepret()->getAgents()->getIdrh() . '</td>
                        <td style="width: 15%;">' . $demande->getDemandepret()->getAgents()->getNomcomplet() . ' ' . $demande->getDemandepret()->getAgents()->getPrenom() . '</td>';
                $current_agent_name = $demande->getDemandepret()->getAgents()->getNomcomplet() . ' ' . $demande->getDemandepret()->getAgents()->getPrenom();
            endif;
            if ($demande->getIdDemandeavance() != null):
                $html.= '<td style ="width: 15%;text-align:center;">' . $demande->getDemandeavance()->getAvance()->getLibelle() . '</td>';
            elseif ($demande->getIdRetenue() != null):
                $html.= '<td style ="width: 15%;text-align:center;">' . $demande->getRetenuesursalaire()->getFournisseur()->getRs() . '</td>';
            elseif ($demande->getIdDemandepret() != null):
                $html.= '<td style ="width: 15%;text-align:center;">' . $demande->getDemandepret()->getPret()->getLibelle() . ' ' . $demande->getDemandepret()->getPret()->getSourcepret()->getLibelle() . '</td>';
            endif;
            $html.='<td style ="width: 7%;text-align:center;">' . $array[$demande->getMois()] . '</td>
                    <td style ="width: 5%;text-align:center;">' . $demande->getAnnee() . '</td>';
            if ($demande->getIdDemandeavance() != null):
                $html.= '<td style ="text-align:center;">' . $demande->getDemandeavance()->getMontanttotal() . '</td>';
            elseif ($demande->getIdRetenue() != null):
                $html.= '<td style ="text-align:center;">' . $demande->getRetenuesursalaire()->getMontantpret() . '</td>';
            elseif ($demande->getIdDemandepret() != null):
                $html.= '<td style ="text-align:center;">' . $demande->getDemandepret()->getMontantpret() . '</td>';
            endif;
            $html.=' <td style ="text-align:center;">' . $demande->getMontantsoustre() . '</td>';
            if ($demande->getIdDemandeavance() != null):
                $html.= '<td style ="width: 7%;text-align:center;">' . $demande->getDemandeavance()->getAvance()->getRemboursement() . ' Mois </td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getDemandeavance()->getDatedebutretenue() . '</td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getDemandeavance()->getDatefinretenue() . '</td>';
            elseif ($demande->getIdRetenue() != null):
                $html.= '<td style ="width: 7%;text-align:center;">' . $demande->getRetenuesursalaire()->getNbrmois() . ' Mois </td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getRetenuesursalaire()->getDatedebut() . '</td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getRetenuesursalaire()->getDatefin() . '</td>';
            elseif ($demande->getIdDemandepret() != null):
                $html.= '<td style ="width: 7%;text-align:center;">' . $demande->getDemandepret()->getNbrmois() . ' Mois </td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getDemandepret()->getDatedebutretenue() . '</td>';
                $html.= '<td style ="width: 9%;text-align:center;">' . $demande->getDemandepret()->getDatefinretenue() . '</td>';
            endif;

            if ($demande->getIdDemandeavance() != null):
                $resultat = $resultat + $demande->getDemandeavance()->getMontanttotal();
                $total_montant_agent = $total_montant_agent + $demande->getDemandeavance()->getMontanttotal();
            elseif ($demande->getIdRetenue() != null):
                $resultat = $resultat + $demande->getRetenuesursalaire()->getMontantpret();
                $total_montant_agent = $total_montant_agent + $demande->getRetenuesursalaire()->getMontantpret();
            elseif ($demande->getIdDemandepret() != null):
                $resultat = $resultat + $demande->getDemandepret()->getMontantpret();
                $total_montant_agent = $total_montant_agent + $demande->getDemandepret()->getMontantpret();
            endif;

            if ($demande->getIdDemandeavance() != null):
                $resultat_mensuel = $resultat_mensuel + $demande->getDemandeavance()->getMontantmensielle();
                $total_retenue_agent = $total_retenue_agent + $demande->getDemandeavance()->getMontantmensielle();
            elseif ($demande->getIdRetenue() != null):
                $resultat_mensuel = $resultat_mensuel + $demande->getRetenuesursalaire()->getRetenuesursalaire();
                $total_retenue_agent = $total_retenue_agent + $demande->getRetenuesursalaire()->getRetenuesursalaire();
            elseif ($demande->getIdDemandepret() != null):
                $resultat_mensuel = $resultat_mensuel + $demande->getDemandepret()->getMontantmentielle();
                $total_retenue_agent = $total_retenue_agent + $demande->getDemandepret()->getMontantmentielle();
            endif;
            $html.=' </tr>';
            $i++;
        endforeach;

        //Ajouter ligne total last agent
        $html.='<tr>
                    <td style = "width: 5%;text-align:center;height:30px;background-color:#EDEDED;"></td>
                    <td style = "width: 38%;text-align:center;" colspan="3">' . $current_agent_name . '</td>
                    <td style = "width: 12%;text-align:center;height:30px;" colspan="2">Total</td>
                    <td style = "width: 10%;text-align:center;">' . number_format($total_montant_agent, 3, '.', ' ') . '</td>
                    <td style = "width: 10%;text-align:center;"> ' . number_format($total_retenue_agent, 3, '.', ' ') . '</td>
                    <td style = "width: 25%;text-align:center;" colspan="3"></td>
                </tr>';

        $html.='<tr style="background-color:#EDEDED;">
                    <td style = "width: 43%;text-align:center;" colspan="4"></td>
                    <td style = "width: 12%;text-align:center;height:30px;" colspan="2">Total</td>
                    <td style = "width: 10%;text-align:center;">' . number_format($resultat, 3, '.', ' ') . '</td>
                    <td style = "width: 10%;text-align:center;"> ' . number_format($resultat_mensuel, 3, '.', ' ') . '</td>
                    <td style = "width: 25%;text-align:center;" colspan="3"></td>
                </tr>';

        $html.='</table>';

        return $html;
    }

    //liste demandes de paiement specifique 

    public function ReadHtmlListeDemande($ids) {

        if (strpos($ids, ',')) {

            $ids = explode(',', $ids);
            $idd = $ids[0];
        } else {
            $idd = $ids;
        }

        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        $historique = Doctrine_Core::getTable('Historiqueretenue')->findOneById($idd);

        $html = '<h3>RECAPITULATIF DE PAIEMENT SPECIFIQUE' . '</h3>&nbsp;<br>
                <table border="1" cellpadding="3">
                    <tbody>
                        <tr style="background-color:#EDEDED;font-weight:bold;">
                            <td style="width: 6%;text-align:center;height:30px;"><label>N°</label></td>
                            <td style="width: 14%;text-align:center;"><label>Matricule</label></td>
                            <td style="width: 25%;text-align:center;"><label>Agent</label></td>
                            <td style="width: 10%;text-align:center;"><label>Montant Payé</label></td>
                              <td style="width: 12%;text-align:center;"><label>Référence</label></td>
                            <td style="width: 33%;text-align:center;"><label>Mois Payé</label></td>
                        </tr>';

        $histo = HistoriqueretenueTable::getInstance()->getByListeId($ids);
        $i = 1;
        $resultat1 = 0;
        foreach ($histo as $hi) {
            $html.='<tr style="font-size:12px;">
                        <td style="text-align:center;">' . $i . '</td>';
            if ($hi->getIdDemandeavance() != ""):
                $html.='<td style="text-align:center;">' . $hi->getDemandeavance()->getAgents()->getIdrh() . '</td>';
                $html.='<td>' . $hi->getDemandeavance()->getAgents()->getNomcomplet() . " " . $hi->getDemandeavance()->getAgents()->getPrenom() . '</td>';
            elseif ($hi->getIdDemandepret() != ""):
                $html.='<td style="text-align:center;">' . $hi->getDemandepret()->getAgents()->getIdrh() . '</td>';
                $html.='<td>' . $hi->getDemandepret()->getAgents()->getNomcomplet() . " " . $hi->getDemandepret()->getAgents()->getPrenom() . '</td>';
            elseif ($hi->getIdRetenue() != ""):
                $html.='<td style="text-align:center;">' . $hi->getRetenuesursalaire()->getAgents()->getIdrh() . '</td>';
                $html.='<td>' . $hi->getRetenuesursalaire()->getAgents()->getNomcomplet() . " " . $hi->getRetenuesursalaire()->getAgents()->getPrenom() . '</td>';
            endif;

            $mois_affiche = '';
            for ($i = 0; $i < $hi->getNbrmoispaye(); $i++) {
                $index = $hi->getMois() + $i;
                if ($mois_affiche == '')
                    $mois_affiche = $array[$index];
                else {
                    if ($i + 1 == $hi->getNbrmoispaye())
                        $mois_affiche = $mois_affiche . ' et ' . $array[$index];
                    else
                        $mois_affiche = $mois_affiche . ', ' . $array[$index];
                }
            }

            $mois_affiche = $mois_affiche . ' <b>' . $hi->getAnnee() . '</b>';

            $html.='<td style="text-align:center;">' . $hi->getMontantsoustre() . '</td>
                    <td style="text-align:center;">' . $hi->getReference() . '</td>
            <td style = "text-align:justify;">(' . $hi->getNbrmoispaye() . ') ' . $mois_affiche . '</td>
            </tr>';
            $resultat1 = $resultat1 + $hi->getMontantsoustre();

            $i++;
        }
        $html.='<tr>
            <td style = "width: 20%;background-color:#ddd"></td>
            <td style = "width: 25%;background-color:#ddd;text-align:center;height:25px;"><h4 style = "float:right;font-weight:bold;">Total</h4></td>
            <td style = "width: 10%;background-color:#ddd;text-align:center;"><h4 style = "float:right;font-weight:bold;">' . number_format($resultat1, 3, '.', ' ') . '</h4></td>
            <td style = "width: 45%;background-color:#ddd"></td>
            </tr>';
        $html.='<tbody></table>';

        return $html;
    }

}
