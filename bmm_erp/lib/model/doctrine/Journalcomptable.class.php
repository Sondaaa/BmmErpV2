<?php

/**
 * Journalcomptable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProject1
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Journalcomptable extends BaseJournalcomptable {

    public function __toString() {
        return "" . $this->getLibelle();
    }

    public function ReadHtmlSeulJournal(sfWebRequest $request) {
        $date_debut = $request->getParameter('date_debut', '');
        $date_fin = $request->getParameter('date_fin', '');
        $journal_id = $request->getParameter('id', '');

        $journal = JournalcomptableTable::getInstance()->find($journal_id);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournalSeul($journal_id, $date_debut, $date_fin);
        $etatJournal_precedent = LignepiececomptableTable::getInstance()->loadEtatJournalSeulPrecedent($journal_id, $date_debut);
        if ($etatJournal_precedent->count() != 0):
            foreach ($etatJournal_precedent as $fiche_prec):
                if ($fiche_prec->getMontantdebit() <> 0):
                    $resultat_debit_precedent = $resultat_debit_precedent + $fiche_prec->getMontantdebit();
                endif;
                if ($fiche_prec->getMontantcredit() <> 0):
                    $resultat_credit_precedent = $resultat_credit_precedent + $fiche_prec->getMontantcredit();
                endif;
            endforeach;
        endif;
        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '--/--/----';

        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '--/--/----';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:12px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:12px;width:100%;">Etat Journal Comptable</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr style="font-size:10px;width:100%;">
                        <td style="font-size:10px;width:100%;">
                            <b>Journal Comptable :</b> ' . $journal->getCode() . ' - ' . $journal->getLibelle() . '<br>
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="3"  border="1">
                    <tr style="font-weight:bold;font-size:10px;text-align:center;background-color:#F3F3F3;">
                        <td style="width:12%;">Date</td>
                        <td style="width:5%;">N°ex</td>
                        <td style="width:14%;">N°.Compte</td>
                        <td style="width:41%;">Libellé</td>
                        <td style="width:14%;">Débit</td>
                        <td style="width:14%;">Crédit</td>
                    </tr>';

        if ($etatJournal->count() != 0):
            $resultat_debit = 0;
            $resultat_credit = 0;
            $Str_Row_Color = "";
            $color1 = "#e6ecff";
            $color2 = "#b3c6ff;";
            $border = '';
            $html.='<tr style="font-size:11px;background-color:#F3F3F3;font-size:8px ; font-weight: blod">'
                    . '<td  style=" text-align: left; " colspan="3">' . $journal->getCode() . ' ' . $journal->getLibelle() . '</td>                           
                            <td colspan="1" style="font-weight: bold;">Report</td>
                            <td style="text-align: right; ">' .
                    number_format($resultat_debit_precedent, 3, '.', ' ')
                    . '</td><td style="text-align: right; ">' .
                    number_format($resultat_credit_precedent, 3, '.', ' ')
                    . '</td>   </tr>';
            foreach ($etatJournal as $fiche):
                if ($fiche->getMontantdebit() == 0):
                    $debit = '';

                else:
                    $debit = number_format($fiche->getMontantdebit(), 3, '.', ' ');
                    $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                endif;
                if ($fiche->getMontantcredit() == 0):
                    $credit = '';


                else:
                    $credit = number_format($fiche->getMontantcredit(), 3, '.', ' ');
                    $resultat_credit = $resultat_credit + $fiche->getMontantcredit();
                endif;

                if ($fiche->getLibelle() != '' && $fiche->getLibelle() != null):
                    $libelle = $fiche->getLibelle();
                else:
                    $libelle = $fiche->getPiececomptable()->getLibelle();
                endif;
//                 $numero_piece = "";
                if ($numero_piece != $fiche->getPiececomptable()->getNumero() && $numero_piece != ''):
                    $numero_piece = $fiche->getPiececomptable()->getNumero();
                    if ($Str_Row_Color == $color1)
                        $Str_Row_Color = $color2;
                    else
                        $Str_Row_Color = $color1;
                    $border = 'border:solid 1px #000000';
                else:
                    $numero_piece = $fiche->getPiececomptable()->getNumero();
                    $border = '';


                endif;

//                if ($numero_piece != $fiche->getPiececomptable()->getNumero()):
//                    $html.= '<tr style="font-size:11px;background-color: #eaf3f7;">';
//                else:
//                    $html.= '<tr style="font-size:11px;">';
//                endif;
                $html.= '<tr style="font-size:11px;background-color:' . $Str_Row_Color . '; ' . $border . '">'
                        . '<td style="text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                            <td style="text-align:center;">' . $fiche->getPiececomptable()->getLignepiececomptable()->getFirst()->getNumeroexterne() . '</td>
                            <td style="text-align:center;">' . $fiche->getPlandossiercomptable()->getNumerocompte() . '</td>
                            <td style="text-align:left;">' . $libelle . '</td>
                            <td style="text-align:right;">' . $debit . '</td>
                            <td style="text-align:right;">' . $credit . '</td>';
                $html.= '  </tr>';
//                $numero_piece = $fiche->getPiececomptable()->getNumero();
            endforeach;
            $html.= '<tr style="text-align:center;font-size: 8px;font-weight: blod;background-color:#F3F3F3;border: solid 1px #000000">'
                    . '<td colspan="3" style="text-align:center;">Total</td>'
                    . '<td colspan=""> </td>'
                    . ' <td style="text-align:right;">' . number_format($resultat_debit, 3, '.', ' ') . '</td>'
                    . ' <td style="text-align:right;">' . number_format($resultat_credit, 3, '.', ' ') . '</td>'
                    . '</tr>';

            $html.= '<tr style="text-align:center;font-size: 8px;font-weight: blod;background-color:#F3F3F3;border: solid 1px #000000">'
                    . '<td colspan="3" style="text-align:center;">Total Avec Report</td>'
                    . '<td colspan=""> </td>'
                    . ' <td style="text-align:right;">' . number_format($resultat_debit + $resultat_debit_precedent, 3, '.', ' ') . '</td>'
                    . ' <td style="text-align:right;">' . number_format($resultat_credit + $resultat_credit_precedent, 3, '.', ' ') . '</td>'
                    . '</tr>';
        else:
            $html.= '<tr style="border: solid 1px #000000">
                        <td style="text-align:center;font-size:14px;" colspan="8">&nbsp;<br>Pas de Pièces Comptables dans ce Journal Comptable&nbsp;<br></td>
                    </tr>';
        endif;

        $html.= '</table>';

        return $html;
    }

    public function ReadHtmlJournaux(sfWebRequest $request) {
        $date_debut = $request->getParameter('date_debut');
        if ($date_debut == '' || $date_debut == NULL)
            $date_debut = $_SESSION['exercice'] . '-01-01';

        $date_fin = $request->getParameter('date_fin');
        if ($date_fin == '' || $date_fin == NULL)
            $date_fin = $_SESSION['exercice'] . '-12-31';

        $date_debut_journal = $request->getParameter('date_debut_journal');
        if ($date_debut_journal == '' || $date_debut_journal == NULL)
            $date_debut_journal = $_SESSION['exercice'] . '-01-01';

        $date_fin_journal = $request->getParameter('date_fin_journal');
        if ($date_fin_journal == '' || $date_fin_journal == NULL)
            $date_fin_journal = $_SESSION['exercice'] . '-12-31';

        $journals = array();
        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $_SESSION['exercice_id'];
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $journals_interval = JournalComptableTable::getInstance()->loadByInterval($date_debut_journal, $date_fin_journal, $dossier_id, $exercice_id);
//        $i = 0;
//        foreach ($journals_interval as $j_i) {
//            $journals[$i]['code'] = $j_i->getCode();
//            $journals[$i]['libelle'] = $j_i->getLibelle();
//            $i++;
//        }
//        $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournal($date_debut, $date_fin, $date_debut_journal, $date_fin_journal);

        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut_affiche = '--/--/----';

        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin_affiche = '--/--/----';

        if ($date_debut_journal != '')
            $date_debut_journal_affiche = date('d/m/Y', strtotime($date_debut_journal));
        else
            $date_debut_journal_affiche = '--/--/----';

        if ($date_fin_journal != '')
            $date_fin_journal_affiche = date('d/m/Y', strtotime($date_fin_journal));
        else
            $date_fin_journal_affiche = '--/--/----';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Journaux Comptables</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Clôture Journal Comptable : Période du :</b> &nbsp;&nbsp;' . $date_debut_journal_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_journal_affiche . '<br>
                            <b>Pièce Comptable : Période du : </b> &nbsp;&nbsp;' . $date_debut_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_affiche . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';


        foreach ($journals_interval as $journal) {
            $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournal($date_debut, $date_fin, $date_debut_journal, $date_fin_journal, $journal->getId());
            if ($etatJournal->count() == 0) {
                $resultat_credit = 0;
                $resultat_debit = 0;
                $html.='<div style="border-color:#E8B10D;background:#FFDD9C;font-weight:bold;">
                            Journal Comptable : ' . trim($journal->getCode()) . ' - ' . trim($journal->getLibelle()) .
                        '</div>&nbsp;<br>
                        <table cellpadding="3" cellspacing="0" border="1">
                            <thead>
                                <tr style="background-color:#ECECEC;font-weight:bold;">
                                    <th style="width:14%;text-align:center;height:25px;">Date</th>
                                    <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                    <th style="width:14%;text-align:center;">Numèro compte</th>
                                    <th style="width:30%;text-align:center;">Libellé</th>
                                    <th style="width:14%;text-align:center;">Débit</th>
                                    <th style="width:14%;text-align:center;">Crédit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align:center;font-size:16px;" colspan="6">&nbsp;<br>Pas de Pièces Comptables dans ce Journal Comptable&nbsp;<br></td>
                                </tr>
                            </tbody>
                        </table>&nbsp;<br>';
            } else {
                $resultat_credit = 0;
                $resultat_debit = 0;

                $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                    Journal Comptable : ' . trim($journal->getCode()) . ' - ' . trim($journal->getLibelle()) .
                        '</div>&nbsp;<br>
                        <table cellpadding="3" cellspacing="0" border="1">
                            <thead>
                                <tr style="background-color:#ECECEC;font-weight:bold;">
                                    <th style="width:14%;text-align:center;height:25px;">Date</th>
                                    <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                    <th style="width:14%;text-align:center;">Numèro compte</th>
                                    <th style="width:30%;text-align:center;">Libellé</th>
                                    <th style="width:14%;text-align:center;">Débit</th>
                                    <th style="width:14%;text-align:center;">Crédit</th>
                                </tr>
                            </thead>
                            <tbody>';
                foreach ($etatJournal as $fiche):
                    if ($fiche->getMontantDebit() == 0):
                        $montant_debit = '';

                    else:
                        $montant_debit = number_format($fiche->getMontantDebit(), 3, '.', ' ');

                        $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                    endif;

                    if ($fiche->getMontantCredit() == 0):
                        $montant_credit = '';
                    else:
                        $montant_credit = number_format($fiche->getMontantCredit(), 3, '.', ' ');
                        $resultat_credit = $resultat_credit + $fiche->getMontantcredit();
                    endif;
                    $html.='<tr>
                            <td style="width:14%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                            <td style="width:14%;text-align:center;">' . trim($fiche->getPiececomptable()->getNumero()) . '</td>
                            <td style="width:14%;text-align:center;">' . $fiche->getPlandossiercomptable()->getNumerocompte() . '</td>
                            <td style="width:30%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                            <td style="width:14%;text-align:right;">' . $montant_debit . '</td>
                            <td style="width:14%;text-align:right;">' . $montant_credit . '</td>
                        </tr>';
                endforeach;
                $html.= '<tr style="background-color:#ECECEC;font-weight:bold;">'
                        . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                        . '<td></td>'
                        . '<td></td>'
                        . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                        . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                        . '</tr>';

                $html.='</tbody>
                    </table>&nbsp;<br>';
            }
        }

        return $html;
    }

    public function ReadHtmlJournauxNonVides(sfWebRequest $request) {
        $resultat_credit = 0;
        $resultat_debit = 0;
        $date_debut = $request->getParameter('date_debut');
        if ($date_debut == '' || $date_debut == NULL)
            $date_debut = $_SESSION['exercice'] . '-01-01';

        $date_fin = $request->getParameter('date_fin');
        if ($date_fin == '' || $date_fin == NULL)
            $date_fin = $_SESSION['exercice'] . '-12-31';

        $date_debut_journal = $request->getParameter('date_debut_journal');
        if ($date_debut_journal == '' || $date_debut_journal == NULL)
            $date_debut_journal = $_SESSION['exercice'] . '-01-01';

        $date_fin_journal = $request->getParameter('date_fin_journal');
        if ($date_fin_journal == '' || $date_fin_journal == NULL)
            $date_fin_journal = $_SESSION['exercice'] . '-12-31';

        $journals = array();
        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $_SESSION['exercice_id'];
        $journals_interval = JournalComptableTable::getInstance()->loadByInterval($date_debut_journal, $date_fin_journal, $dossier_id, $exercice_id);
        $i = 0;
        foreach ($journals_interval as $j_i) {
            $journals[$i]['code'] = $j_i->getCode();
            $journals[$i]['libelle'] = $j_i->getLibelle();
            $i++;
        }

        $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournal($date_debut, $date_fin, $date_debut_journal, $date_fin_journal);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);

        if ($date_debut != '')
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '--/--/----';

        if ($date_fin != '')
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '--/--/----';

        if ($date_debut_journal != '')
            $date_debut_journal = date('d/m/Y', strtotime($date_debut_journal));
        else
            $date_debut_journal = '--/--/----';

        if ($date_fin_journal != '')
            $date_fin_journal = date('d/m/Y', strtotime($date_fin_journal));
        else
            $date_fin_journal = '--/--/----';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Journaux Comptables<br>( pas vides )</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Clôture Journal Comptable : Période du :</b> &nbsp;&nbsp;' . $date_debut_journal . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_journal . '<br>
                            <b>Pièce Comptable : Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $first_journal = $etatJournal->getFirst();
        $index = 0;
        $fermeture = 1;

        for ($j = 0; $j < count($journals); $j++):
            if ($journals[$j]['code'] == $first_journal->getPiececomptable()->getJournalcomptable()->getCode()):
                break;
            else:
                $index++;
            endif;
        endfor;

        foreach ($etatJournal as $fiche):
            if ($fermeture == 1):
                $resultat_credit = 0;
                $resultat_debit = 0;
                $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                    Journal Comptable : ' . $fiche->getPiececomptable()->getJournalcomptable()->getCode() . ' - ' . $fiche->getPiececomptable()->getJournalcomptable()->getLibelle() .
                        '</div>&nbsp;<br>
                                    <table cellpadding="3" cellspacing="0" border="1">
                                        <thead>
                                            <tr style="background-color:#ECECEC;font-weight:bold;">
                                                <th style="width:14%;text-align:center;">Date</th>
                                                <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                                <th style="width:14%;text-align:center;">Numéro compte</th>
                                                <th style="width:30%;text-align:center;">Libellé</th>
                                                <th style="width:14%;text-align:center;">Débit</th>
                                                <th style="width:14%;text-align:center;">Crédit</th>
                                            </tr>
                                        </thead>
                                        <tbody>';
                $fermeture = 0;
                if ($fiche->getMontantDebit() == 0):
                    $montant_debit = '';
                else:
                    $montant_debit = number_format($fiche->getMontantDebit(), 3, '.', ' ');
                    $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                endif;

                if ($fiche->getMontantCredit() == 0):
                    $montant_credit = '';
                else:
                    $montant_credit = number_format($fiche->getMontantCredit(), 3, '.', ' ');
                    $resultat_credit = $resultat_credit + $fiche->getMontantCredit();
                endif;

                $index++;
            else:
                $index--;

                if ($journals[$index]['code'] == $fiche->getPiececomptable()->getJournalcomptable()->getCode()):
                    if ($fiche->getMontantDebit() == 0):
                        $montant_debit = '';
                    else:
                        $montant_debit = number_format($fiche->getMontantDebit(), 3, '.', ' ');
                        $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                    endif;

                    if ($fiche->getMontantCredit() == 0):
                        $montant_credit = '';
                    else:
                        $montant_credit = number_format($fiche->getMontantCredit(), 3, '.', ' ');
                        $resultat_credit = $resultat_credit + $fiche->getMontantCredit();
                    endif;

                    $html.='<tr>
                                <td style="width:14%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                                <td style="width:14%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                                <td style="width:14%;text-align:center;">' . $fiche->getPlandossiercomptable()->getNumerocompte() . '</td>
                                <td style="width:30%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                                <td style="width:14%;text-align:right;">' . $montant_debit . '</td>
                                <td style="width:14%;text-align:right;">' . $montant_credit . '</td>
                            </tr>';
                    $index++;
                else:
                    $html.= '<tr style="font-size:11px;background: repeat-x #F2F2F2;">'
                            . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                            . '<td></td>'
                            . '<td></td>'
                            . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                            . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                            . '</tr>';
                    $html.='</tbody>
                        </table>&nbsp;<br>';
                    $fermeture = 1;
                    $index++;
                    $index_sup = $index;
                    for ($j = $index; $j < count($journals); $j++):
                        if ($journals[$j]['code'] == $fiche->getPiececomptable()->getJournalcomptable()->getCode()):
                            $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                        Journal Comptable : ' . $fiche->getPiececomptable()->getJournalcomptable()->getCode() . ' - ' . $fiche->getPiececomptable()->getJournalcomptable()->getLibelle() .
                                    '</div>&nbsp;<br>
                                    <table cellpadding="3" cellspacing="0" border="1">
                                        <thead>
                                            <tr style="background-color:#ECECEC;font-weight:bold;">
                                                <th style="width:14%;text-align:center;">Date</th>
                                                <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                                <th style="width:14%;text-align:center;">Numèro compte</th>
                                                <th style="width:30%;text-align:center;">Libellé</th>
                                                <th style="width:14%;text-align:center;">Débit</th>
                                                <th style="width:14%;text-align:center;">Crédit</th>
                                            </tr>
                                        </thead>
                                        <tbody>';
                            $fermeture = 0;
                            if ($fiche->getMontantDebit() == 0):
                                $montant_debit = '';
                            else:
                                $montant_debit = number_format($fiche->getMontantDebit(), 3, '.', ' ');
                                $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                            endif;

                            if ($fiche->getMontantCredit() == 0):
                                $montant_credit = '';
                            else:
                                $montant_credit = number_format($fiche->getMontantCredit(), 3, '.', ' ');
                                $resultat_credit = $resultat_credit + $fiche->getMontantCredit();

                            endif;
                            $html.='<tr>
                                        <td style="width:14%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                                        <td style="width:14%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                                        <td style="width:14%;text-align:center;">' . $fiche->getPlandossiercomptable()->getNumerocompte() . '</td>
                                        <td style="width:30%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                                        <td style="width:14%;text-align:right;">' . $montant_debit . '</td>
                                        <td style="width:14%;text-align:right;">' . $montant_credit . '</td>
                                    </tr>';
                            $index_sup++;
                            break;
                        else:
                            $index_sup++;
                        endif;
                    endfor;
                    $index = $index_sup;
                endif;
            endif;
        endforeach;
        $html.= '<tr style="font-size:11px;background: repeat-x #F2F2F2;">'
                . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                . '<td></td>'
                . '<td></td>'
                . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                . '</tr>';
        if ($fermeture == 0):
            $html.='</tbody>
                        </table>&nbsp;<br>';
            $fermeture = 1;
        endif;
        return $html;
    }

    public function ReadHtmlJournauxNonVide(sfWebRequest $request) {
        $date_debut = $request->getParameter('date_debut');
        if ($date_debut == '' || $date_debut == NULL)
            $date_debut = $_SESSION['exercice'] . '-01-01';

        $date_fin = $request->getParameter('date_fin');
        if ($date_fin == '' || $date_fin == NULL)
            $date_fin = $_SESSION['exercice'] . '-12-31';

        $date_debut_journal = $request->getParameter('date_debut_journal');
        if ($date_debut_journal == '' || $date_debut_journal == NULL)
            $date_debut_journal = $_SESSION['exercice'] . '-01-01';

        $date_fin_journal = $request->getParameter('date_fin_journal');
        if ($date_fin_journal == '' || $date_fin_journal == NULL)
            $date_fin_journal = $_SESSION['exercice'] . '-12-31';

        $journals = array();
        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $_SESSION['exercice_id'];
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $journals_interval = JournalComptableTable::getInstance()->loadByInterval($date_debut_journal, $date_fin_journal, $dossier_id, $exercice_id);
//        $i = 0;
//        foreach ($journals_interval as $j_i) {
//            $journals[$i]['code'] = $j_i->getCode();
//            $journals[$i]['libelle'] = $j_i->getLibelle();
//            $i++;
//        }
//        $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournal($date_debut, $date_fin, $date_debut_journal, $date_fin_journal);

        if ($date_debut != '')
            $date_debut_affiche = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut_affiche = '--/--/----';

        if ($date_fin != '')
            $date_fin_affiche = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin_affiche = '--/--/----';

        if ($date_debut_journal != '')
            $date_debut_journal_affiche = date('d/m/Y', strtotime($date_debut_journal));
        else
            $date_debut_journal_affiche = '--/--/----';

        if ($date_fin_journal != '')
            $date_fin_journal_affiche = date('d/m/Y', strtotime($date_fin_journal));
        else
            $date_fin_journal_affiche = '--/--/----';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Journaux Comptables</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                            <b>Clôture Journal Comptable : Période du :</b> &nbsp;&nbsp;' . $date_debut_journal_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_journal_affiche . '<br>
                            <b>Pièce Comptable : Période du : </b> &nbsp;&nbsp;' . $date_debut_affiche . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin_affiche . '
                        </td>
                    </tr>
                </table>&nbsp;<br>';


        foreach ($journals_interval as $journal) {
            $etatJournal = LignePieceComptableTable::getInstance()->loadEtatJournal($date_debut, $date_fin, $date_debut_journal, $date_fin_journal, $journal->getId());
            if ($etatJournal->count() == 0) {
                $resultat_credit = 0;
                $resultat_debit = 0;
                $html.='<div style="border-color:#E8B10D;background:#FFDD9C;font-weight:bold;">
                            Journal Comptable : ' . trim($journal->getCode()) . ' - ' . trim($journal->getLibelle()) .
                        '</div>&nbsp;<br>
                        <table cellpadding="3" cellspacing="0" border="1">
                            <thead>
                                <tr style="background-color:#ECECEC;font-weight:bold;">
                                    <th style="width:14%;text-align:center;height:25px;">Date</th>
                                    <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                    <th style="width:14%;text-align:center;">Numèro compte</th>
                                    <th style="width:30%;text-align:center;">Libellé</th>
                                    <th style="width:14%;text-align:center;">Débit</th>
                                    <th style="width:14%;text-align:center;">Crédit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align:center;font-size:16px;" colspan="6">&nbsp;<br>Pas de Pièces Comptables dans ce Journal Comptable&nbsp;<br></td>
                                </tr>
                            </tbody>
                        </table>&nbsp;<br>';
            } else {
                $resultat_credit = 0;
                $resultat_debit = 0;

                $html.='<div style="background:#82AF6F;border-color:#82AF6F;font-weight:bold;">
                                    Journal Comptable : ' . trim($journal->getCode()) . ' - ' . trim($journal->getLibelle()) .
                        '</div>&nbsp;<br>
                        <table cellpadding="3" cellspacing="0" border="1">
                            <thead>
                                <tr style="background-color:#ECECEC;font-weight:bold;">
                                    <th style="width:14%;text-align:center;height:25px;">Date</th>
                                    <th style="width:14%;text-align:center;">Pièce Comptable</th>
                                    <th style="width:14%;text-align:center;">Numèro compte</th>
                                    <th style="width:30%;text-align:center;">Libellé</th>
                                    <th style="width:14%;text-align:center;">Débit</th>
                                    <th style="width:14%;text-align:center;">Crédit</th>
                                </tr>
                            </thead>
                            <tbody>';
                foreach ($etatJournal as $fiche):
                    if ($fiche->getMontantDebit() == 0):
                        $montant_debit = '';

                    else:
                        $montant_debit = number_format($fiche->getMontantDebit(), 3, '.', ' ');

                        $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                    endif;

                    if ($fiche->getMontantCredit() == 0):
                        $montant_credit = '';
                    else:
                        $montant_credit = number_format($fiche->getMontantCredit(), 3, '.', ' ');
                        $resultat_credit = $resultat_credit + $fiche->getMontantcredit();
                    endif;
                    $html.='<tr>
                            <td style="width:14%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getPiececomptable()->getDate())) . '</td>
                            <td style="width:14%;text-align:center;">' . trim($fiche->getPiececomptable()->getNumero()) . '</td>
                            <td style="width:14%;text-align:center;">' . $fiche->getPlandossiercomptable()->getNumerocompte() . '</td>
                            <td style="width:30%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                            <td style="width:14%;text-align:right;">' . $montant_debit . '</td>
                            <td style="width:14%;text-align:right;">' . $montant_credit . '</td>
                        </tr>';
                endforeach;
                $html.= '<tr style="background-color:#ECECEC;font-weight:bold;">'
                        . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                        . '<td></td>'
                        . '<td></td>'
                        . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                        . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                        . '</tr>';

                $html.='</tbody>
                    </table>&nbsp;<br>';
            }
        }

        return $html;
    }

    public function ReadHtmlCentralisateur($id_exercice) {
        $exercie = Doctrine_Core::getTable('Exercice')->findOneById($id_exercice);
        $annee = $exercie->getLibelle();
        $date_periode = array();
        for ($i = 1; $i < 7; $i++) {
            if ($i < 10)
                $mois = '0' . $i;
            else
                $mois = $i;

            $date_debut_mois = $annee . '-' . $mois . '-01';
            $date_fin_mois = date('Y-m-d', strtotime(date('Y-m-d', strtotime($date_debut_mois . ' +1 month')) . ' -1 day'));
            $date_periode[$i - 1]['date_debut'] = $date_debut_mois;
            $date_periode[$i - 1]['date_fin'] = $date_fin_mois;
        }

        $dossier_id = $_SESSION['dossier_id'];
        $exercice_id = $id_exercice;

        $journals_interval = JournalComptableTable::getInstance()->findByIdDossierAndIdExercice($dossier_id, $exercice_id);

//        $all_etatJournal = calculJournalCentralisateur::getJournal($dossier_id, $exercice_id);
        $total_all_etatJournal = calculJournalCentralisateur::getTotalJournal($annee);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat du Journal Centralisateur</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.='<table cellspacing="0" cellpadding="3">
                    <tr style="font-size:12px;">
                        <td>* L\'état du journal centralisateur est présenté sous la forme de deux (2) tableaux : Un tableau pour les 1èr six (6) mois, et l\'autre pour les derniers six (6) mois.</td>
                    </tr>
                </table>';

        $html.='<table border="1" cellspacing="0" cellpadding="3">
                    <thead>
                        <tr style="background-color:#F2F2F2;font-weight:bold;">
                            <th rowspan="3" style="width:10%;text-align:center;">Code<br>Journal<br>Comptable</th>
                            <th colspan="24" style="width:90%;text-align:center;font-size:14px;">Mouvement => Mois ' . ' 01 - 06 / ' . $annee . '</th>
                        </tr>
                        <tr style="background-color:#F2F2F2;font-weight:bold;">';
        for ($h = 0; $h < 6; $h++):
            $html.='<th colspan="2" style="width:15%;text-align:center;">Mois ' . date('m', strtotime($date_periode[$h]['date_debut'])) . '</th>';
        endfor;
        $html.='</tr>
                <tr style="background-color:#F2F2F2;font-weight:bold;">';
        for ($h = 0; $h < 6; $h++):
            $html.='<th style="width:7.5%;text-align:center;">Débit</th>
                    <th style="width:7.5%;text-align:center;">Crédit</th>';
        endfor;
        $html.='</tr>
            </thead>
            <tbody>';
        foreach ($journals_interval as $journal_interval):
            $html.='<tr style="font-size:10px;">
                    <td style="width:10%;text-align:center;font-size:12px;font-weight:bold;height:25px;">' . $journal_interval->getCode() . '</td>';
            $count_td = 0;
//             $all_etatJournal = calculJournalCentralisateur::getJournal($dossier_id, $exercice_id);

            $all_etatJournal = JournalcentralisateurTable::getInstance()->getByJournalAndExercice($journal_interval->getId(), $exercice_id);
            foreach ($all_etatJournal as $etatJournal):
                if ($count_td < 6):
                    $html.='<td style="width:7.5%;text-align: right;">';
                    if ($etatJournal->getDebit() != 0):
                        $html.=number_format($etatJournal->getDebit(), 3, '.', ' ');
                    endif;
                    $html.='</td>';
                    $html.='<td style="width:7.5%;text-align: right;">';
                    if ($etatJournal->getCredit() != 0) :
                        $html.=number_format($etatJournal->getCredit(), 3, '.', ' ');
                    endif;
                    $html.='</td>';
                endif;
                $count_td++;
            endforeach;
            $html.='</tr>';
        endforeach;
        $html.='<tr style="background-color:#F2F2F2;font-size:10px;">
                    <td style="width:10%;text-align:center;font-weight:bold;font-size:12px;height:25px;">Total</td>';
        for ($h = 1; $h < 7; $h++):
            $q = Doctrine_Query::create()
                    ->select("SUM(j.debit) as debit, SUM(j.credit) as credit")
                    ->from('journalcentralisateur j')
                    ->where("j.id_exercice = " . $id_exercice)
                    ->andWhere('j.mois = ' . $h);

            $total_etatJournaux = $q->fetchArray();
            $html.='<td style="text-align: right; font-weight: bold;">';
            if ($total_etatJournaux[0]['debit'] != 0)
                $html.=number_format($total_etatJournaux[0]['debit'], 3, '.', ' ');
            $html.='</td>';
            $html.='<td style="text-align: right; font-weight: bold;">';
            if ($total_etatJournaux[0]['credit'] != 0)
                $html.= number_format($total_etatJournaux[0]['credit'], 3, '.', ' ');
            $html.='</td>';
        endfor;
        $html.='</tr>
            </tbody>
        </table>&nbsp;<br>';

//        ****************************************************************

        $html.='<table border="1" cellspacing="0" cellpadding="3">
                    <thead>
                        <tr style="background-color:#F2F2F2;font-weight:bold;">
                            <th rowspan="3" style="width:10%;text-align:center;">Code<br>Journal<br>Comptable</th>
                            <th colspan="24" style="width:90%;text-align:center;font-size:14px;">Mouvement => Mois ' . ' 07 - 12 / ' . date('Y') . '</th>
                        </tr>
                    <tr style="background-color:#F2F2F2;font-weight:bold;">';

        for ($h = 6; $h < 12; $h++):
            $mois = $h + 1;
            if ($mois < 10)
                $mois = '0' . $mois;
            $html.='<th colspan="2" style="width:15%;text-align:center;">Mois ' . $mois . '</th>';
        endfor;
        $html.='</tr>
                <tr style="background-color:#F2F2F2;font-weight:bold;">';
        for ($h = 6; $h < 12; $h++):
            $html.='<th style="width:7.5%;text-align:center;">Débit</th>
                    <th style="width:7.5%;text-align:center;">Crédit</th>';
        endfor;
        $html.='</tr>
                </thead>
                <tbody>';
        foreach ($journals_interval as $journal_interval):
            $html.='<tr style="font-size:10px;">
                        <td style="width:10%;text-align:center;font-size:12px;font-weight:bold;height:25px;">' . $journal_interval->getCode() . '</td>';
            $count_td = 0;
            $all_etatJournal = JournalcentralisateurTable::getInstance()->getByJournalAndExercice($journal_interval->getId(), $_SESSION['exercice_id']);
            foreach ($all_etatJournal as $etatJournal):
                if ($count_td > 5):
                    $html.='<td style="width:7.5%;text-align: right;">';
                    if ($etatJournal->getDebit() != 0):
                        $html.=number_format($etatJournal->getDebit(), 3, '.', ' ');
                    endif;
                    $html.='</td>';
                    $html.='<td style="width:7.5%;text-align: right;">';
                    if ($etatJournal->getCredit() != 0) :
                        $html.=number_format($etatJournal->getCredit(), 3, '.', ' ');
                    endif;
                    $html.='</td>';
                endif;
                $count_td++;
            endforeach;
            $html.='</tr>';
        endforeach;
        $html.='<tr style="background-color:#F2F2F2;font-size:10px;">
                    <td style="width:10%;text-align:center;font-weight:bold;font-size:12px;height:25px;">Total</td>';
        for ($h = 7; $h < 13; $h++):
            $q = Doctrine_Query::create()
                    ->select("SUM(j.debit) as debit, SUM(j.credit) as credit")
                    ->from('journalcentralisateur j')
                    ->where("j.id_exercice = " . $_SESSION['exercice_id'])
                    ->andWhere('j.mois = ' . $h);

            $total_etatJournaux = $q->fetchArray();
            $html.='<td style="text-align: right; font-weight: bold;">';
            if ($total_etatJournaux[0]['debit'] != 0)
                $html.=number_format($total_etatJournaux[0]['debit'], 3, '.', ' ');
            $html.='</td>';
            $html.='<td style="text-align: right; font-weight: bold;">';
            if ($total_etatJournaux[0]['credit'] != 0)
                $html.= number_format($total_etatJournaux[0]['credit'], 3, '.', ' ');
            $html.='</td>';
        endfor;
        $html.='</tr>
            </tbody>
        </table>';


        return $html;
    }

}
