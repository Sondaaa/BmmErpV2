<?php

/**
 * Demandeavance
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    PhpProjecttest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Demandeavance extends BaseDemandeavance {

    public function __toString() {

        return "" . $this->getAgents()->getIdrh() . " " . $this->getAgents()->getNomcomplet() . " " . $this->getAgents()->getPrenom() . "  " . $this->getAvance()->getLibelle();
    }

    public function ReadHtmlListeDemandeAvance($ids, $typeavance, $annee) {

        if (strpos($ids, ',')) {
            $ids = substr($ids, 0, -2);
            $ids = explode(',,', $ids);
            $idd = $ids[0];
        } else {
            $idd = $ids;
        }

        $demande = DemandeavanceTable::getInstance()->getByIdAgentsAndIdTypeavanceAndAnnee($idd, $typeavance, $annee);

        $type = Doctrine_Core::getTable('avance')->findOneById($typeavance);
        $html = '<h3>RECAPITULATIF DES DEMANDES  ' . '<br>' . $type->getLibelle() . 'en ' . $annee . '</h3>&nbsp;<br>
          
            <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 8%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 20%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 38%;text-align:center;"><label>Agents</label></td>
                        <td style="width: 15%;text-align:center;"><label>Montant</label></td>
                        <td style="width: 18%;text-align:center;"><label>Remboursé sur</label></td>
                    </tr>';

        $dem = DemandeavanceTable::getInstance()->getByListeId($ids);

        $i = 1;

        foreach ($dem as $d) {
            $html.='<tr style="font-size:12px;">
                        <td style="text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $d->getAgents()->getIdrh() . '</td>
                        <td>' . $d->getAgents()->getNomcomplet() . ' ' . $d->getAgents()->getPrenom() . '</td>
                        <td style="text-align:center;">' . $d->getMontanttotal() . '</td>
                        <td style="text-align:center;">' . $d->getMois() . ' Mois</td>
                    </tr>';
            $i++;
        }

        $html.='<tbody></table>';


        return $html;
    }

    public function ReadHtmlDemande($ids, $typeavance, $annee) {

        if (strpos($ids, ',')) {
            $ids = substr($ids, 0, -2);
            $ids = explode(',,', $ids);
            $idd = $ids[0];
        } else {
            $idd = $ids;
        }

        $demande = DemandeavanceTable::getInstance()->getByIdAgentsAndIdTypeavanceAndAnnee($idd, $typeavance, $annee);

        $type = Doctrine_Core::getTable('avance')->findOneById($typeavance);
        $html = '<h3>RECAPITULATIF DES DEMANDES  ' . '</br>' . $type->getLibelle() . 'en ' . $annee . '</h3>
          
            <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 10%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 25%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 35%;text-align:center;"><label>Agents </label></td>
                        <td style="width: 30%;text-align:center;"><label>Montant </label></td>
                    </tr>';

//        $agents = AgentsTable::getInstance()->getByListeId($ids);
//        $i = 1;
//        
//        foreach ($agents as $agent) {
//            $html.='<tr>
//                        <td style="text-align:center;">' . $i . '</td>
//                        <td style="text-align:center;">' . $agent->getIdrh() . '</td>
//                        <td>' . $agent->getNomcomplet() . ' ' . $agent->getPrenom() . '</td>
//                        <td>'.$demande->getMontanttotal().'</td>    
//                    </tr>';
//            $i++;
//        }

        $dem = DemandeavanceTable::getInstance()->getByListeId($ids);

        $i = 1;

        foreach ($dem as $d) {
            $html.='<tr>
                        <td style="text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $d->getAgents()->getIdrh() . '</td>
                        <td>' . $d->getAgents()->getNomcomplet() . ' ' . $d->getAgents()->getPrenom() . '</td>
                        <td>' . $d->getMontanttotal() . '</td>    
                    </tr>';
            $i++;
        }

        $html.='<tbody></table>';


        return $html;
    }

//impression liste demane avance 
    public function ReadHtmlListeDemande(sfWebRequest $request) {

        $typeavance = $request->getParameter('id_typeavance', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $id_agents = $request->getParameter('id_agents', '');
        if ($typeavance != '') {
            $type = Doctrine_Core::getTable('avance')->findOneById($typeavance);
        }
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT  *, avance.libelle as typeavance, "
                . "Concat(agents.nomcomplet,agents.prenom) as nom,agents.idrh as matricule"
                . ",demandeavance.montantmensielle as montant ,avance.remboursement as nbrmois,"
                . " demandeavance.datedebutretenue as datedebutretenue ,demandeavance.datefinretenue as datefinretenue"
                . " FROM demandeavance, avance, agents "
                . " WHERE demandeavance.id_agents = agents.id"
                . " and demandeavance.id_typeavance= avance.id ";

        if ($typeavance != '')
            $query.= " AND demandeavance.id_typeavance = " . $typeavance;
        if ($annee != '')
            $query.= " AND demandeavance.annee = " . $annee;
        if ($mois != '')
            $query.= " AND demandeavance.mois = " . $mois;
        if ($id_agents != '')
            $query.= " AND demandeavance.id_agents = " . $id_agents;

        $query.= " ORDER BY agents.nomcomplet";
        $demandes = $conn->fetchAssoc($query);


        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $html = '<h3>RECAPITULATIF DES DEMANDES D\'AVANCES ';
        if ($typeavance != ''): $html .= "D\' " . $type->getLibelle();
        else: $html .= "";
        endif;
        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;
        if ($id_agents != ""): $html .=" De " . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</h3>';
        else :
            $html .= '</h3>';
        endif;


        $html.='&nbsp;<br>&nbsp;<br> <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 10%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 24%;text-align:center;"><label>Agents </label></td>      
                        <td style="width: 20%;text-align:center;"><label>Nature Avance</label></td>
                        <td style="width: 9%;text-align:center;"><label>Nbr.Mois</label></td>      
                        <td style="width: 10%;text-align:center;"><label>Retenue Men. </label></td>
                        <td style="width: 11%;text-align:center;"><label>Date Début d\'avance </label></td>
                        <td style="width: 11%;text-align:center;"><label>Date Fin d\'avance</label></td>
                    </tr>';
        $i = 1;
        $resultat = 0;

        if (sizeof($demandes) > 0):
            foreach ($demandes as $demande):
                $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $demande['matricule'] . '</td>
                        <td>' . $demande['nom'] . '</td>
                        <td style="text-align:center;">' . $demande['typeavance'] . '</td>
                        <td style="text-align:center;">' . $demande['nbrmois'] . ' Mois </td>
                        <td style="text-align:center;">' . $demande['montant'] . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($demande['datedebutretenue'])) . '</td>
                        <td style="text-align:center;">' . date('d/m/Y', strtotime($demande['datefinretenue'])) . '</td>
                  </tr>';
                $resultat = $resultat + $demande['montant'];
                $i++;
            endforeach;
            $html.='<tr style="font-weight:bold;">
                    <td style="width: 59%;background-color:#ddd"></td>
                    <td style="width: 9%;background-color:#ddd;text-align:center;height:25px;">
                    Total</td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;">
                    ' . number_format($resultat, 3, '.', ' ') . '</td>
                    <td  style="width: 22%;background-color:#ddd"></td>
              
                </tr>';
        else:
            $html.='<tr><td style="text-align: center ; width: 100%;height:30px;font-size:15px"><br>Pas d\'historiques des deamsdes d\'Avances</td></tr>';
        endif;
        $html.='</table>';

        return $html;
    }

//impression liste des retenus 
    public function ReadHtmlListeRetenue(sfWebRequest $request) {

        $typeavance = $request->getParameter('id_typeavance', '');
        $annee = $request->getParameter('id_annee', '');
        $mois = $request->getParameter('id_mois', '');
        $id_agents = $request->getParameter('id_agents', '');
        if ($typeavance != '') {
            $type = Doctrine_Core::getTable('avance')->findOneById($typeavance);
        }
//        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
//        $query = "SELECT  *, avance.libelle as typeavance, "
//                . "Concat(agents.nomcomplet,agents.prenom) as nom,agents.idrh as matricule"
//                . ",demandeavance.montantmensielle as montant ,avance.remboursement as nbrmois,"
//                . " demandeavance.datedebutretenue as datedebutretenue ,demandeavance.datefinretenue as datefinretenue"
//                . " FROM demandeavance, avance, agents "
//                . " WHERE demandeavance.id_agents = agents.id"
//                . " and demandeavance.id_typeavance= avance.id ";

        $q = Doctrine_Core::getTable('Historiqueretenue')
                ->createQuery('h')
                ->select('h.*, COALESCE(da.id_agents) as agents_id')
                ->from('Historiqueretenue h')
                ->leftJoin('h.Demandeavance da');
        if ($annee != '')
            $q->where('h.annee = ' . intval($annee));
        if ($mois != '')
            $q->andWhere('h.mois = ' . intval($mois));
        if ($typeavance != '')
            $query.= " AND da.id_typeavance = " . $typeavance;
        if ($id_agents != '')
            $query.= " AND da.id_agents = " . $id_agents;
        $q->orderBy('agents_id, h.annee, h.mois');
        $demandes = $q->execute();
        if ($id_agents != '') {
            $agents = Doctrine_Core::getTable('agents')->findOneById($id_agents);
        }
        $html = '<h3>RECAPITULATIF DES RETENUES ';
        if ($typeavance != ''): $html .= "D\' " . $type->getLibelle();
        else: $html .= "";
        endif;
        $first_date = $annee . '-' . $mois . '-01';
        setlocale(LC_TIME, 'french');
        if ($mois != ''): $html .= ' EN ' .
                    strftime('%B', strtotime($first_date)) . ' ' . $annee;
        else: $html .= "";
        endif;
        if ($id_agents != ""): $html .=" De " . $agents->getNomcomplet() . " " . $agents->getPrenom() . '</h3>';
        else :
            $html .= '</h3>';
        endif;


        $html.='&nbsp;<br>&nbsp;<br> <table border="1" cellpadding="3">
                <tbody>
                    <tr style="background-color:#EDEDED;font-weight:bold;">
                        <td style="width: 5%;text-align:center;height:30px;"><label>N°</label></td>
                        <td style="width: 10%;text-align:center;"><label>Matricule</label></td>
                        <td style="width: 24%;text-align:center;"><label>Agents </label></td>      
                        <td style="width: 20%;text-align:center;"><label>Type Avance</label></td>
                        <td style="width: 7%;text-align:center;"><label>Mois</label></td>      
                        <td style="width: 10%;text-align:center;"><label>Année </label></td>
                        <td style="width: 11%;text-align:center;"><label>Date Début d\'avance </label></td>
                        <td style="width: 11%;text-align:center;"><label>Date Fin d\'avance</label></td>
                    </tr>';
        $i = 1;
        $resultat = 0;
        $array = array("1" => "Janvier", "2" => "Février", "3" => "Mars", "4" => "Avril", "5" => "Mai", "6" => "Juin", "7" => "Juillet", "8" => "Août", "9" => "Septembre", "10" => "Octobre", "11" => "Nouvembre", "12" => "Décembre");
        foreach ($demandes as $demande):
            $html.='<tr style="font-size:12px;">
                        <td style="height:25px;text-align:center;">' . $i . '</td>
                        <td style="text-align:center;">' . $demande->getDemandeavance()->getAgents()->getIdrh() . '</td>
                        <td>' . $demande->getDemandeavance()->getAgents()->getNomcomplet() . ' ' . $demande->getDemandeavance()->getAgents()->getPrenom() . '</td>
                        <td style="text-align:center;">' . $demande->getDemandeavance()->getAvance()->getLibelle() . '</td>
                        <td style="text-align:center;">' . $array[$demande->getMois()] . '</td>
                        <td style="text-align:center;">' . $demande->getAnnee() . '</td>
                        <td style="text-align:center;">' .   '</td>
                        <td style="text-align:center;">' . '</td>
                  </tr>';
            $resultat = $resultat + $demande['montant'];
            $i++;
        endforeach;
        $html.='<tr style="font-weight:bold;">
                    <td style="width: 59%;background-color:#ddd"></td>
                    <td style="width: 7%;background-color:#ddd;text-align:center;height:25px;">
                    Total</td>
                    <td style="width: 10%;background-color:#ddd;text-align:center;">
                    ' . number_format($resultat, 3, '.', ' ') . '</td>
                    <td  style="width: 22%;background-color:#ddd"></td>
              
</tr>';
        $html.='</table>';

        return $html;
    }

}
