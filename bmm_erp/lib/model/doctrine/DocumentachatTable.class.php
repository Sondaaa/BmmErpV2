<?php

/**
 * DocumentachatTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class DocumentachatTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object DocumentachatTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Documentachat');
    }

    public function getByidDocAndType($iddoc) {

        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 20')
                ->andWhere("id_contrat =" . $iddoc)
                ->execute();
        return $doc_bci;
    }

    public function getBybceBdc($iddoc) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 17 or id_typedoc = 18 ')
                ->andWhere("id_docparent =" . $iddoc)
                ->execute();
        return $doc_bci;
    }

    public function getBybceBdcAndType($iddoc, $id_type) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = ' . $id_type)
                ->andWhere("id_docparent =" . $iddoc)
                ->orderBy('id desc')
                ->execute();
        return $doc_bci;
    }

    public function getbyContrat() {
        $year = date('Y');
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 20')
                // ->andWhere("documentachat.datecreation >= '" . $year . "-01-01'")
                // ->andWhere("documentachat.datecreation <= '" . $year . "-12-31'")
                ->andWhere("documentachat.id_contrat is not null")
                ->execute();
        return $doc_bci;
    }

    public function getAllDoc($idtype = '7', $idfrs = '0') {
        $boncommandeexterne = Doctrine_Core::getTable('documentachat')
                        ->createQuery('a')->where('id_typedoc=' . $idtype);

        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getAllDocByFilter($datedebut = '', $datefin = '', $idtype, $idfrs = '0', $user) {
        $year = date('Y');
        $boncommandeexterne = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')->where('id_typedoc=' . $idtype)
                ->andWhere("trim(etatdocachat)  is  null");
        if ($idtype == 17) {
            $boncommandeexterne->Andwhere("mntttc != 0 ");
        }

        if ($datedebut != "") {
            $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }

        if ($datefin != "") {
            $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }
        if ($datedebut == "" && $datefin == "") {
            $boncommandeexterne->andWhere("datecreation >= '" . $year . "-01-01'")
                    ->andWhere("datecreation <= '" . $year . "-12-31'");
        }

        if ($idfrs && $idfrs != "") {
            $boncommandeexterne->Andwhere("id_frs=" . $idfrs);
        }
        if ($user) {
            $boncommandeexterne = $boncommandeexterne->andWhere('a.id_user = ' . $user->getId());
        }
        $boncommandeexterne->orderby('id desc');

        return $boncommandeexterne;
    }

    public function getAllDocByFilterBDCNULL($datedebut = '', $datefin = '', $idtype, $idfrs = '0', $user) {

        $boncommandeexterne = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')->where('id_typedoc=' . $idtype)
                ->andwhere('a.mntttc is null ')
        // ->andWhere('a.id_etatdoc = 59')
        ;

        if ($datedebut && $datedebut != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation>='" . $datedebut . "'");
        }
        if ($datefin && $datefin != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("datecreation<='" . $datefin . "'");
        }
        if ($idfrs && $idfrs != "") {
            $boncommandeexterne = $boncommandeexterne->Andwhere("id_frs=" . $idfrs);
        }
        if ($user) {
            $boncommandeexterne = $boncommandeexterne->andWhere('a.id_user = ' . $user->getId());
        }
        $boncommandeexterne = $boncommandeexterne->orderby('id desc');
        return $boncommandeexterne;
    }

    public function getDocumentsachatbdc() {
        $doc_bci_non_imputer = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->whereIn('id_typedoc', array(17, 2, 21, 22))
                ->execute();
        return $doc_bci_non_imputer;
    }

    public function getLastBciByYear($year) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                        ->createQuery('a')
                        ->where('id_typedoc = 9')
                        ->andWhere("datecreation >= '" . $year . "-01-01'")
                        ->andWhere("datecreation <= '" . $year . "-12-31'")
                        ->orderBy('numero desc')
                        ->limit("1")
                        ->execute()->getFirst();

        return $doc_bci;
    }

    public function getAllBciWithoutVisa() {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere('id_etatdoc = 1')
                ->andWhere("etatdocachat IS NULL")
                ->orderBy('datecreation,numero desc');

        return $doc_bcimp;
    }

    public function getEtatdoc($id, $id_etat_doc) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 19')
                ->andWhere('id=' . $id)
                ->andWhere("id_etatdoc =" . $id_etat_doc)
                ->execute();

        return $doc_bci;
    }

    public function getSansFrs() {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 2')
                ->andWhere('id_frs is null')
                ->execute();

        return $doc_bci;
    }

    public function getByDocparentAndContrat($id_docparent, $id_type, $id_contrat) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc =' . $id_type)
                ->andWhere('id_docparent= ' . $id_docparent)
                ->andWhere('id_contrat=' . $id_contrat)
                ->execute();

        return $doc_bci;
    }

    public function getContrat($id_contrat, $id_type) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc  in (6,19,20)')
                ->andWhere('id_contrat=' . $id_contrat)
                ->execute();

        return $doc_bci;
    }

    public function getByDocparentAndTypedoc($id_docachat, $id_type) {
        $doc_bci = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc  = 15 ')
                ->andWhere('id_docparent=' . $id_docachat)
                ->execute();

        return $doc_bci;
    }

    public function getAllBciNotAffected() {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere('id_etatdoc = 11')
                ->andWhere('id NOT IN (select id_documentachat from marches)')
                ->andWhere("etatdocachat IS NULL")
                ->orderBy('datecreation,numero desc');

        return $doc_bcimp;
    }

    public function getAllBciCourant() {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere('id IN (select id_documentachat from marches)')
                ->andWhere("etatdocachat IS NULL")
                ->orderBy('datecreation,numero desc');

        return $doc_bcimp;
    }

    public function getAllBciAnnule() {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere("trim(etatdocachat) = '" . trim("Annulé(e)") . "'")
                ->orderBy('datecreation,numero desc');

        return $doc_bcimp;
    }

    public function getAllBciCloture() {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere("trim(etatdocachat) = '" . trim("Annulé(e)") . "'")
                ->orderBy('datecreation,numero desc');

        return $doc_bcimp;
    }

    public function getByIds($ids) {
        $q = $this->createQuery('d')
                ->whereIn('d.id', (array) $ids)
                ->orderBy('d.id')
                ->execute();
        return $q;
    }

    public function getByFrss($ids) {
        //         die(( $ids);
        $q = $this->createQuery('d')
                ->leftJoin('d.Fournisseur f')
                ->where('d.id_docparent =' . $ids)
                ->andWhere('d.id_typedoc=8')
                //                ->andWhere("f.etatfrs= 'Actif'")
                ->orderBy('d.id')
                ->execute();
        //        die ($q);
        return $q;
    }

    public function findAllForVisa($date_debut, $date_fin, $id_typedoc) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Typedoc t')
                // ->where('(d.id_etatdoc = 9 OR d.id_etatdoc = 6)')
                ->andWhere('d.etatdocachat IS NULL');

        if ($id_typedoc == 'BDCNUll') {
            $q = $q->andWhere('d.id_typedoc = 17 and d.mntttc = 0.000');
        } elseif ($id_typedoc == 17) {
            $q = $q->andWhere('d.id_typedoc = 17 or id_typedoc= 18');
        } else {
            $q = $q->andWhere('d.id_typedoc = ' . $id_typedoc);
        }

        $q = $q->andWhere('d.id NOT IN (select id_doc from ligavissig)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        $q->orderBy('d.id desc');
        return $q->execute();
    }

    public function findAllByRubrique($date_debut, $date_fin, $id_rubrique) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Ligavisdoc l')
                ->where('(d.id_etatdoc = 9 OR d.id_etatdoc = 6)')
                ->andWhere('d.etatdocachat IS NULL')
                ->andWhere('d.id_typedoc = 6');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_rubrique != '' && $id_rubrique != '0') {
            $q->andWhere("l.id_ligprotitrub = " . $id_rubrique);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllBDCRegrouppeByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL')
                ->andWhere('(d.id_typedoc = 21)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllByFournisseurBDCNULL($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL')
                ->andWhere('(d.id_typedoc = 17)')
                ->andWhere("d.mntttc=" . 0.000 . " or d.mntttc is null ");
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL')
                ->andWhere('(d.id_typedoc = 2 OR d.id_typedoc = 7)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllBDCProvisoireByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.datesignature IS NULL')
                //  ->andWhere('d.id_etatdoc = 1')
                ->andWhere('(d.id_typedoc = 17)');
        //                ->andWhere('d.id IN (SELECT piecejointbudget.id_docachat'
        //                        . ' FROM piecejointbudget '
        //                        . 'WHERE piecejointbudget.id_type = 4 OR piecejointbudget.id_type = 5)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllContratDefByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                //  ->andWhere('d.datesignature IS NULL')
                //  ->andWhere('d.id_etatdoc = 1')
                ->andWhere('(d.id_typedoc = 20)');
        //                ->andWhere('d.id IN (SELECT piecejointbudget.id_docachat'
        //                        . ' FROM piecejointbudget '
        //                        . 'WHERE piecejointbudget.id_type = 4 OR piecejointbudget.id_type = 5)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllContratProvisoireByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                //  ->andWhere('d.datesignature IS NULL')
                //  ->andWhere('d.id_etatdoc = 1')
                ->andWhere('(d.id_typedoc = 19)');
        //                ->andWhere('d.id IN (SELECT piecejointbudget.id_docachat'
        //                        . ' FROM piecejointbudget '
        //                        . 'WHERE piecejointbudget.id_type = 4 OR piecejointbudget.id_type = 5)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function findAllProvisoireByFournisseur($date_debut, $date_fin, $id_fournisseur) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.datesignature IS NULL')
                //  ->andWhere('d.id_etatdoc = 1')
                ->andWhere('(d.id_typedoc = 18 OR d.id_typedoc = 17)');
        //                ->andWhere('d.id IN (SELECT piecejointbudget.id_docachat'
        //                        . ' FROM piecejointbudget '
        //                        . 'WHERE piecejointbudget.id_type = 4 OR piecejointbudget.id_type = 5)');
        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q;
    }

    public function getAllByFournisseurContratrprovisoire($date_debut, $date_fin, $id_fournisseur, $id_type) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL');
        if ($id_type) {
            $q = $q->andWhere('(d.id_typedoc = 20)');
        } else {
            $q = $q->andWhere('(d.id_typedoc = 19)');
        }

        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q->execute();
    }

    public function getAllByFournisseurrprovisoire($date_debut, $date_fin, $id_fournisseur, $id_type) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL');
        if ($id_type) {
            $q = $q->andWhere('d.id_typedoc=' . $id_type);
        } else {
            $q = $q->andWhere('(d.id_typedoc = 17 OR d.id_typedoc = 18)');
        }

        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q->execute();
    }

    public function getAllByFournisseur($date_debut, $date_fin, $id_fournisseur, $id_type, $type) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.etatdocachat IS NULL');
        if ($id_type) {
            $q = $q->andWhere('d.id_typedoc=' . $id_type);
            if ($type) {
                $q = $q->andWhere('d.mntttc is null or d.mntttc=' . 0.000);
            }
        } else {
            $q = $q->andWhere('(d.id_typedoc = 2 OR d.id_typedoc = 7)');
        }

        if ($date_debut != '') {
            $q->andWhere("d.datecreation >= '" . $date_debut . "'");
        }

        if ($date_fin != '') {
            $q->andWhere("d.datecreation <= '" . $date_fin . "'");
        }

        if ($id_fournisseur != '' && $id_fournisseur != '0') {
            $q->andWhere("d.id_frs = " . $id_fournisseur);
        }

        $q->orderBy('d.id desc');
        return $q->execute();
    }

    public function getByTableId($ids) {
        $q = $this->createQuery('d')
                ->whereIn('d.id', (array) $ids)
                ->execute();
        return $q;
    }

    public function getFacture($id_doc) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->Where('(d.id_typedoc = 15)');
        if ($id_doc != '') {
            $q->andWhere("d.id_docparent in (select id from documentachat where id_docparent= " . $id_doc . " and id_typedoc=16)");
        }

        $q->orderBy('d.id desc');

        //        die($q);
        $resultat = $q->execute();
        //        die(json_encode($resultat).size);
    }

    public function getDocByTypeDocAndDate($id_type, $pager, $offset, $start, $end, $id_bci = null, $id_bce = null, $id_bcedef, $id_fac, $id_bcilabo) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
        ;
        if ($id_bci && !$id_bce) {
            $q->andWhere('d.id=' . $id_bci);
        }
        if ($id_bcilabo && !$id_bci) {
            $doc_bcilabo = DocumentachatTable::getInstance()->find($id_bcilabo);
            $q->andWhere(' ( d.id_docparent=' . $doc_bcilabo->getId() . ' or d.id_docparent is null )');
            // $q->andWhere('(d.id_docparent=' . $doc_bcilabo->getId()
            //     . ' or  ' . $id_bcilabo . ' in
            //     (select id_bci from docachatreg
            //       where docachatreg.id_docreg=d.id and d.id_docparent is null  ))');
        }
        if ($id_bce && !$id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bce);
            $q->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        // die($q);
        if ($id_bcedef && !$id_bci) {
            $doc_bcedef = DocumentachatTable::getInstance()->find($id_bcedef);

            $q->andWhere('d.id=' . $doc_bcedef->getIdDocparent())
            ;
        }
        if ($id_fac && !$id_bci) {
            $doc_fac = DocumentachatTable::getInstance()->find($id_fac);
            $doc_def = documentachatTable::getInstance()->find($doc_fac->getIdDocparent());
            if ($doc_def && $doc_def->getIdDocparent() != null && $doc_def->getIdDocparent() != '') {
                $q->andWhere('d.id=' . $doc_def->getIdDocparent())
                ;
            }
        }

        if ($id_bce && $id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bce);
            $q->andWhere('d.id=' . $id_bci)
                    ->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        if (!$id_bci && !$id_bce && !$id_bcedef && !$id_fac && !$id_bcilabo) {
            $q->andWhere("d.datecreation >= '" . $start . "'")
                    ->andWhere("d.datecreation <= '" . $end . "'");
        }

        $q->orderBy('d.numero asc');
        if (isset($pager) && isset($offset)) {
            $q->limit($pager)->offset($offset);
        }
        // die($q);
        return $q->execute();
    }

    public function getDocByTypeDocAndDateContrat($id_type, $pager, $offset, $start, $end, $id_bci = null, $id_contrat = null, $id_contratdef, $id_fac) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
        ;
        if ($id_bci && !$id_contrat) {
            $q->andWhere('d.id=' . $id_bci);
        }
        // if ($id_bcilabo && !$id_bci) {
        //     $doc_bcilabo = DocumentachatTable::getInstance()->find($id_bcilabo);
        //     $q->andWhere(' ( d.id_docparent=' . $doc_bcilabo->getId() . ' or d.id_docparent is null )');
        // }

        if ($id_contrat && !$id_bci) {
            $doc_contrat = DocumentachatTable::getInstance()->find($id_contrat);
            $q->andWhere('d.id=' . $doc_contrat->getIdDocparent());
        }

        if ($id_contratdef && !$id_bci) {
            $doc_contratdef = DocumentachatTable::getInstance()->find($id_contratdef);
            $doc_contratprov = DocumentachatTable::getInstance()->find($doc_contratdef->getIdDocparent());
            $q->andWhere('d.id=' . $doc_contratprov->getIdDocparent())
            ;
        }
        if ($id_fac && !$id_bci) {
            $doc_fac = DocumentachatTable::getInstance()->find($id_fac);
            $doc_def = documentachatTable::getInstance()->find($doc_fac->getIdDocparent());
            if ($doc_def && $doc_def->getIdDocparent() != null && $doc_def->getIdDocparent() != '') {
                $q->andWhere('d.id=' . $doc_def->getIdDocparent())
                ;
            }
        }

        if ($id_contrat && $id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_contrat);
            $q->andWhere('d.id=' . $id_bci)
                    ->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        if (!$id_bci && !$id_contrat && !$id_contratdef && !$id_fac && !$id_bcilabo) {
            $q->andWhere("d.datecreation >= '" . $start . "'")
                    ->andWhere("d.datecreation <= '" . $end . "'");
        }

        $q->orderBy('d.numero asc');
        if (isset($pager) && isset($offset)) {
            $q->limit($pager)->offset($offset);
        }
        // die($q);
        return $q->execute();
    }

    public function getDocByTypeDocAndDateBDC($id_type, $pager, $offset, $start, $end, $id_bci = null, $id_bdc = null, $id_bdcdef, $id_fac, $id_bcilabo) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
        ;
        if ($id_bci && !$id_bce) {
            $q->andWhere('d.id=' . $id_bci);
        }
        if ($id_bcilabo && !$id_bci) {
            $doc_bcilabo = DocumentachatTable::getInstance()->find($id_bcilabo);
            $q->andWhere(' ( d.id_docparent=' . $doc_bcilabo->getId() . ' or d.id_docparent is null )');
            // $q->andWhere('(d.id_docparent=' . $doc_bcilabo->getId()
            //     . ' or  ' . $id_bcilabo . ' in
            //     (select id_bci from docachatreg
            //       where docachatreg.id_docreg=d.id and d.id_docparent is null  ))');
        }
        if ($id_bce && !$id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bce);
            $q->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        // die($q);
        if ($id_bcedef && !$id_bci) {
            $doc_bcedef = DocumentachatTable::getInstance()->find($id_bcedef);

            $q->andWhere('d.id=' . $doc_bcedef->getIdDocparent())
            ;
        }
        if ($id_fac && !$id_bci) {
            $doc_fac = DocumentachatTable::getInstance()->find($id_fac);
            $doc_def = documentachatTable::getInstance()->find($doc_fac->getIdDocparent());

            $q->andWhere('d.id=' . $doc_def->getIdDocparent())
            ;
        }

        if ($id_bce && $id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bce);
            $q->andWhere('d.id=' . $id_bci)
                    ->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        if (!$id_bci && !$id_bce && !$id_bcedef && !$id_fac && !$id_bcilabo) {
            $q->andWhere("d.datecreation >= '" . $start . "'")
                    ->andWhere("d.datecreation <= '" . $end . "'");
        }

        $q->orderBy('d.numero asc');
        if (isset($pager) && isset($offset)) {
            $q->limit($pager)->offset($offset);
        }
        // die($q);
        return $q->execute();
    }

    public function getAllBciByDateBDC($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Documentachat doc')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        //        if ($id_bci)
        //            $q->andWhere('id=' . $id_bci);
        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getAllDatecontrat($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Documentachat doc')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        $q->orderBy('d.numero asc');
        return $q->execute();
    }

    public function getAllBciByDateBCE($start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                //  ->leftJoin('d.Documentachat doc')
                ->andWhere(' ( d.id_typedoc = 18 ) ')
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        //        if ($id_bci)
        //            $q->andWhere('id=' . $id_bci);
        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getAllBciByDateBCEdef($start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere(' ( d.id_typedoc = 7 ) ')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        $q->orderBy('d.numero asc');
        return $q->execute();
    }

    public function getAllBciByDateFacture($start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere(' ( d.id_typedoc = 15 ) ')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        $q->orderBy('d.numero asc');
        return $q->execute();
    }

    public function getAllBciByDateBCILabo($start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere(' ( d.id_typedoc = 4 ) ')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        // ->andWhere("d.datecreation >= '" . $start . "'")
        // ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        $q->orderBy('d.numero asc');
        return $q->execute();
    }

    public function getAllBciByDateContrat($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Documentachat doc')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere('doc.id_typedoc = ' . 19)
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
        //                ->andWhere("d.datecreation >= '" . $start . "'")
        //                ->andWhere("d.datecreation <= '" . $end . "'")
        ;
        //        if ($id_bci)
        //            $q->andWhere('id=' . $id_bci);
        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getDocByTypeDocAndDateBDCR($id_type, $pager, $offset, $start, $end, $id_bci = null, $id_bdc = null, $id_bdcdef, $id_fac) {
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type);
        if ($id_bci && !$id_bce) {
            $q->andWhere('d.id=' . $id_bci);
        }
        if ($id_bdc && !$id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bdc);
            $q->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        if ($id_bdcdef && !$id_bci) {
            $doc_bcedef = DocumentachatTable::getInstance()->find($id_bdcdef);
            $q->andWhere('d.id=' . $doc_bcedef->getIdDocparent());
        }
        if ($id_fac && !$id_bci) {
            $doc_fac = DocumentachatTable::getInstance()->find($id_fac);
            $doc_def = documentachatTable::getInstance()->find($doc_fac->getIdDocparent());
            $q->andWhere('d.id=' . $doc_def->getIdDocparent());
        }
        if ($id_bdc && $id_bci) {
            $doc_bce = DocumentachatTable::getInstance()->find($id_bdc);
            $q->andWhere('d.id=' . $id_bci)
                    ->andWhere('d.id=' . $doc_bce->getIdDocparent());
        }
        if (!$id_bci && !$id_bdc && !$id_bdcdef && !$id_fac) {
            $q->andWhere("d.datecreation >= '" . $start . "'")
                    ->andWhere("d.datecreation <= '" . $end . "'");
        }
        $q->orderBy('d.numero asc');
        if (isset($pager) && isset($offset)) {
            $q->limit($pager)->offset($offset);
        }
        // die($q);
        return $q->execute();
    }

    public function getDocByTypeDocAndDateBCICONTRAT($id_type, $pager, $offset, $start, $end, $id_bci = null) {

        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere('d.id_contrat is not null ')
                ->andWhere("d.datecreation >= '" . $start . "'")
                ->andWhere("d.datecreation <= '" . $end . "'");
        if ($id_bci) {
            $q->andWhere('id=' . $id_bci);
        }

        $q->orderBy('d.numero asc');
        if (isset($pager)) {
            $q->limit($pager)
            //->offset($offset)
            ;
        }

        return $q->execute();
    }

    public function getAllBciByDateBCIContrat($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere('d.id_contrat is not null')
                // ->andWhere("d.datecreation >= '" . $start . "'")
                // ->andWhere("d.datecreation <= '" . $end . "'")
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'");
        //        if ($id_bci)
        //            $q->andWhere('id=' . $id_bci);
        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getAllBciByDateBDCR($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->leftJoin('d.Documentachat doc')
                ->andWhere('d.id_typedoc = ' . $id_type)
                ->andWhere('doc.id_typedoc = ' . 21)
                // ->andWhere("d.datecreation >= '" . $start . "'")
                // ->andWhere("d.datecreation <= '" . $end . "'")
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'");
        //        if ($id_bci)
        //            $q->andWhere('id=' . $id_bci);

        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getAllBciByDate($id_type, $start, $end, $id_bci = null) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->andWhere('d.id_typedoc = ' . $id_type)
                // ->andWhere("d.datecreation >= '" . $start . "'")
                // ->andWhere("d.datecreation <= '" . $end . "'")
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'");
        // if ($id_bci) {
        //     $q->andWhere('id=' . $id_bci);
        // }

        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getByTypedoc($id_type) {
        $year = date('Y');
        $date_now = date('Y-m-d');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->Where('(d.id_typedoc = 6)')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $date_now . "'");

        $q->orderBy('d.numero asc');

        return $q->execute();
    }

    public function getByTypedocContrat($id_type) {
        $year = date('Y');
        $q = $this->createQuery('d')
                ->from('Documentachat d')
                ->Where('d.id_typedoc =' . $id_type)
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->andWhere('d.id_contrat is not null');

        $q->orderBy('d.numero asc');

        //        die($q);
        return $q->execute();
    }

    public function getByTypedocContratDef($id_type, $id_docachat) {
        $contra_prov = DocumentachatTable::getInstance()->findOneByIdDocparentAndIdTypedoc($id_docachat, 19);
        //die($id_docachat.'rr'. sizeof($contra_prov));
        if ($contra_prov) {
            $q = $this->createQuery('d')
                    ->from('Documentachat d')
                    ->Where('d.id_typedoc =' . $id_type)
                    ->andWhere('d.id_contrat is not null')
                    ->andWhere('d.id_docparent=' . $contra_prov->getId());

            $q->orderBy('d.numero asc');

            //   die($q);
            return $q->execute();
        }
    }

    public function loadAllParLabo($numero_bci = '', $reference_bci = '') {
        $ids = '';
        $id_natures = '';
        $array_emplacement = [];
        $array_user = [];
        $array_naturedoc_user = [];
        $user = sfContext::getInstance()->getUser()->getAttribute('userB2m');
        $ids = json_decode($user->getIdMagasin());
        $id_user = '';
        $idsss = '';
        $id_user_parnature = [];
        $id_utilisateur = $user->getId();
        $nature_user = [];
        if ($user->getIdMagasin() && $user->getIdMagasin() != 'null') {
            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->leftJoin('a.Naturedocachat nature')
                    ->leftJoin('a.Etage etage')
                    ->where('a.id_typedoc=4')
                    ->andWhereIn('a.id_emplacement   ', $ids)
                    ->andWhere('a.id not in (select id_docparent
                          from documentachat dc where id_typedoc=6)')
                    ->andWhere('a.id_etatdoc = 1');
            if ($numero_bci != '') {
                $documentsachat = $documentsachat->andWhere('a.numero =' . $numero_bci);
            }

            if ($reference_bci != '') {
                $documentsachat = $documentsachat->andWhere('a.reference like ?', '%' . $reference_bci . '%');
            }
        } else {
            $user_nature_docachat = Doctrine_Core::getTable('Naturedocachat')
                    ->createQuery('na')
                    ->select('id_user')
                    ->where('id_user is not null')
                    ->execute();

            if (sizeof($user_nature_docachat) >= 1) {
                foreach ($user_nature_docachat as $user_nature):
                    $user_nat = substr($user_nature->getIdUser(), 1, count($user_nature));
                    $user_nat = explode(',', $user_nat);
                    for ($i = 0; $i < sizeof($user_nat); $i++):
                        if ($user_nat[$i] != "") {
                            $nature_user[] = substr($user_nat[$i], 1, strlen($user_nat[$i] - 1));
                        }
                    endfor;
                endforeach;
            }
            //die(json_encode($nature_user));
            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->leftJoin('a.Naturedocachat nature')
                    ->where('id_typedoc=4')
                    ->andWhereIn($user->getId(), $nature_user)
                    ->andwhere('id_naturedoc=nature.id')
                    ->andwhere("nature.id_user like '%" . $user->getId() . "%'");

            if ($numero_bci != '') {
                $documentsachat = $documentsachat->andWhere('a.numero =' . $numero_bci);
            }

            if ($reference_bci != '') {
                $documentsachat = $documentsachat->andWhere('a.reference like ?', '%' . $reference_bci . '%');
            }
        }
        $documentsachat->orderBy('a.id desc');
        return $documentsachat;
    }

    public function ExtraireDemandeur($user) {
        $ids = json_decode($user->getIdMagasin());
        $documentsachat = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->addSelect(' a.id_demandeur ')
                ->leftJoin('a.Naturedocachat nature')
                ->leftJoin('a.Etage etage')
                ->where('a.id_typedoc=4')
                ->where('a.id_demandeur is not null');
        if ($ids) {
            $documentsachat = $documentsachat->andWhereIn('a.id_emplacement', $ids);
        }

        $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)')
                        ->andWhere('a.id_etatdoc = 1')->fetchArray();
        $demandeurs = array_column($documentsachat, 'id_demandeur');
        $liste_demandeur = Doctrine_Core::getTable('Demandeur')->createQuery('a')
                        ->select('id')
                        ->whereIn('id', $demandeurs)
                        ->groupBy('id')->execute();
        return $liste_demandeur;
    }

    public function getbyIdDocs($iddocs) {
        $ids = explode(',', $iddocs);
        $documentachats = Doctrine_Core::getTable('documentachat')
                ->createQuery('d')
                ->from('Documentachat d')
                ->Where(" id IN (" . implode(',', array_map('intval', $ids)) . ")")
                ->execute();

        return $documentachats;
    }

    public function ExtraireBci($user) {

        $id_valide = $user->getVailderegrouppement();
        // $labo_administration = $user->getAdministartionSite();
        // $labo = $user->getLaboName();
        $check_labo = null;

        if ($user->getIdMagasin() && $user->getIdMagasin() != 'null') {

            $magasins = Doctrine_Query::create()
                    ->select('p.id as id')
                    ->from('Etage p')
                    ->whereIn('id', json_decode($user->getIdMagasin()))
                    ->AndWhere('is_administration is null');
            if ($magasins->execute()->getFirst()) {
                $check_labo = true;
            }
            $ids = json_decode($user->getIdMagasin());

            if ($id_valide == true) {
                $documentsachat = Doctrine_Core::getTable('documentachat')
                        ->createQuery('a')
                        ->andwhere('a.id_etatdoc = 1 ')
                        ->andwhere('a.id_naturedoc = 2 ')
                        //->andwhere('a.id_emplacement is null')
                        ->andwhereIn('a.id_emplacement', $ids)
                // ->andWhere("a.id_emplacement in (select id_magasin
                // from utilisateur where is_administration is not null)")
                ;
            }
        }

        if ($check_labo) {

            $ids = $magasins->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);

            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->addSelect(' a.* ')
                    ->leftJoin('a.Naturedocachat nature')
                    ->leftJoin('a.Etage etage')
                    ->where('a.id_typedoc=4');
            $naturedoc = NaturedocachatTable::getInstance()->findAll();
            $nature = null;
            foreach ($naturedoc as $nnature) {
                if ($nnature->getIdUser() && $nnature->getIdUser() != 'NULL') {
                    $array = json_decode($nnature->getIdUser());
                    if (in_array($user->getId(), $array)) {
                        $nature = $nnature;
                    }
                }
            }
            if ($nature) {
                $documentsachat = $documentsachat->andwhere('id_naturedoc=' . $nature->getId());
            }
            if (count($ids) > 0 && $id_valide == false && $nature && $nature->getId() == 2) {
                $documentsachat = $documentsachat
                        ->andWhereIn('a.id_emplacement', $ids)
                        ->andWhere('a.id_etatdoc = 1');
            }

            $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)');
            if ($id_valide == true && count($ids) > 0 && $nature && $nature->getId() == 2) {
                $documentsachat = $documentsachat
                        ->andWhereIn('a.id_emplacement ', $ids)
                        ->andwhere('a.id_etatdoc = 1 ');
            }

            if ($id_valide == true && count($ids) == 0 && $nature && $nature->getId() == 2) {
                $documentsachat = $documentsachat
                        ->andWhereIn('a.id_emplacement is null')
                        ->andwhere('a.id_etatdoc = 1 ');
            }

            $documentsachat = $documentsachat->execute();
            return $documentsachat;
        } else {
            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->addSelect(' a.* ')
                    ->leftJoin('a.Naturedocachat nature')
                    ->leftJoin('a.Etage etage')
                    ->where('a.id_typedoc=4');
            $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)');
            $ids = json_decode($user->getIdMagasin());
            $naturedoc = NaturedocachatTable::getInstance()->findAll();
            $nature = null;
            foreach ($naturedoc as $nnature) {
                if ($nnature->getIdUser() && $nnature->getIdUser() != 'NULL') {
                    $array = json_decode($nnature->getIdUser());
                    if (in_array($user->getId(), $array)) {
                        $nature = $nnature;
                    }
                }
            }
            if ($nature) {
                $documentsachat = $documentsachat->andwhere('id_naturedoc=' . $nature->getId());
            }

            $documentsachat = $documentsachat->execute();
            return $documentsachat;
        }

        return null;
    }

    public function getAllBciMarcheParAnne($year) {
        $doc_bcimp = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->where('id_typedoc = 9')
                ->andWhere("datecreation >= '" . $year . "-01-01'")
                ->andWhere("datecreation <= '" . $year . "-12-31'")
                ->orderBy('datecreation,numero desc')
                ->execute()
        ;

        return $doc_bcimp;
    }

    public function ExtraireBciRecu($user) {
        $ids = json_decode($user->getIdMagasin());
        $id_valide = $user->getVailderegrouppement();
        if ($user->getIdMagasin() && $user->getIdMagasin() != 'null') {
            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->addSelect(' a.id_demandeur ')
                    ->leftJoin('a.Naturedocachat nature')
                    ->leftJoin('a.Etage etage')
                    ->where('a.id_typedoc=4')
                    ->andwhere('a.id_destination= ' . $user->getId());
            if (count($ids) > 0 && $id_valide == false) {
                $documentsachat = $documentsachat
                        ->andWhereIn('a.id_emplacement', $ids)
                        ->andWhere('a.id_etatdoc = 79 ');
            }

            $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)');
            if ($id_valide == true && count($ids) > 0) {
                $documentsachat = $documentsachat
                        ->andWhereNotIn('a.id_emplacement ', $ids)
                        ->andwhere('a.id_etatdoc = 78 ');
            }

            $documentsachat = $documentsachat->execute();
            return $documentsachat;
        } else {
            $documentsachat = Doctrine_Core::getTable('documentachat')
                    ->createQuery('a')
                    ->addSelect(' a.id_demandeur ')
                    // ->leftJoin('a.Naturedocachat nature')
                    // ->leftJoin('a.Etage etage')
                    ->where('a.id_typedoc=4')
                    ->andwhere('a.id_etatdoc = 78 ')
                    ->andwhere('a.id_destination= ' . $user->getId());
            // if (count($ids) > 0 && $id_valide == false)
            //     $documentsachat =  $documentsachat
            //         //->andWhere('a.id_emplacement is null')
            //         ->andWhere('a.id_etatdoc = 79 ');
            // $documentsachat =  $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)');
            // if ($id_valide == true && count($ids) > 0)
            //     $documentsachat =  $documentsachat
            //         //  ->andwhere('a.id_emplacement is null')
            //         ->andwhere('a.id_etatdoc = 78 ');
            // //   ->andwhere('a.id_emplacement is null');

            $documentsachat = $documentsachat->execute();
            return $documentsachat;
        }

        return null;
    }

    public function ExtraireBciRejete($user) {
        $ids = json_decode($user->getIdMagasin());
        $id_valide = $user->getVailderegrouppement();
        $documentsachat = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->addSelect(' a.id_demandeur ')
                ->leftJoin('a.Naturedocachat nature')
                ->leftJoin('a.Etage etage')
                ->where('a.id_typedoc=4');
        if (count($ids) > 0) {
            $documentsachat = $documentsachat
                    ->andWhereIn('a.id_emplacement', $ids)
                    ->andWhere('a.id_etatdoc = 79 ');
        }

        $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)');
        // if ($id_valide == true && count($ids) > 0)
        //     $documentsachat =  $documentsachat
        //         ->andWhereNotIn('a.id_emplacement ', $ids)
        //         ->andwhere('a.id_etatdoc = 78 ');
        // if ($id_valide == false)
        //     $documentsachat =  $documentsachat->andWhere('a.id_etatdoc = 1 or a.id_etatdoc=79');
        //die($documentsachat);
        $documentsachat = $documentsachat->execute();
        return $documentsachat;
    }

    public function Extrairelignedoc($user) {
        $ids = json_decode($user->getIdMagasin());
        $documentsachat = Doctrine_Core::getTable('documentachat')
                ->createQuery('a')
                ->addSelect(' a.id ')
                ->leftJoin('a.Naturedocachat nature')
                ->leftJoin('a.Etage etage')
                ->where('a.id_typedoc=4')
                ->where('a.id_demandeur is not null');
        if ($ids) {
            $documentsachat = $documentsachat->andWhereIn('a.id_emplacement', $ids);
        }

        $documentsachat = $documentsachat->andWhere('a.id not in (select id_docparent from documentachat dc where id_typedoc=6)')
                        ->andWhere('a.id_etatdoc = 1')->fetchArray();
        $lignedocs = Doctrine_Core::getTable('Lignedocachat')->createQuery('q')
                        ->whereIn('id_doc', array_column($documentsachat, 'id'))->execute();
        return $lignedocs;
    }

}
