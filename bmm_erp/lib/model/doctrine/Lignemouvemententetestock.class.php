<?php

/**
 * Lignemouvemententetestock
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 *  
 * @package    Bmm
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Lignemouvemententetestock extends BaseLignemouvemententetestock
{
    public function ReadHtmlMouvementstcok(sfWebRequest $request)
    {

        $article_min = $request->getParameter('article_min', '');
        $exercice = date('Y');
        $date_debut = $request->getParameter('date_debut');
        if ($date_debut == '' || $date_debut == NULL)
            $date_debut = $exercice . '-01-01';
        $date_fin = $request->getParameter('date_fin');
        if ($date_fin == '' || $date_fin == NULL)
            $date_fin = $exercice . '-12-31';

        $etatMouvements = LignemouvemententetestockTable::getInstance()->loadEtatArticleMouvement($article_min, $date_debut, $date_fin,  $exercice);
        $article = ArticleTable::getInstance()->find($article_min);
        // $etatLivres_pres = LignePieceComptableTable::getInstance()->loadEtatLivre2Pre($compte_min, $compte_max, $date_debut, $order, $_SESSION['dossier_id'], $_SESSION['exercice_id']);
        // $compte_min_comptable = PlanComptableTable::getInstance()->findOneByNumeroCompte($compte_min);
        // $compte_max_comptable = PlanComptableTable::getInstance()->findOneByNumeroCompte($compte_max);
        if ($date_debut != '' && $date_debut != NULL)
            $date_debut = date('d/m/Y', strtotime($date_debut));
        else
            $date_debut = '';
        if ($date_fin != '' && $date_fin != NULL)
            $date_fin = date('d/m/Y', strtotime($date_fin));
        else
            $date_fin = '';

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                      
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Mouvement Stock Article : ' . date('Y') . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html .= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:10px;width:100%;">
                            <b>Période du : </b> &nbsp;&nbsp;' . $date_debut . '&nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . $date_fin . '
                            <ul><b>Article :</b>
                                <li>
                                    ' . $article->getCodeart() . ' - ' . $article->getDesignation() . '
                                </li>
                               
                            </ul>
                        </td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table cellspacing="0" cellpadding="3" border="1">
                    <thead>
                    <tr style="border-bottom: 1px solid #000000">
                    <th style="width: 9%;">Date</th>
                    <th style="text-align: left;width: 5%;">REF Art</th>
                    <th style="width: 10%;">Article</th>
                    <th style="width: 8%;">Famil.</th>
                    <th style="width: 9%;">S.Famil.</th>
                    <th style="width: 8%;">N Bon entre</th>
                    <th style="width: 7%;">Qte Entre</th>
                    <th style="width: 7%;">Qte Sortie</th>
                    <th style="width: 7%;">Stock Final</th>
                    <th style="width: 10%;">PU Achat</th>
                    <th style="width: 10%;">CUMP</th>
                    <th style="width: 10%;">Stock en valeur</th>
                </tr>
                    </thead> <tbody>';

        if ($etatMouvements->count() == 0) :
            $html .= '<tr>
                                    <td style="text-align:center;font-weight:bold;font-size:10px;width:100%;">Liste des Fiches Vide</td>
                                </tr>';
        else :
            $somme_qte = 0;
            $somme_qte_sortie = 0;
            $stock_final = 0;
            $pu_achat = 0;
            $cump = 0;
            $val_en_stock = 0;

            if ($etatMouvements->count() != 0) :
                foreach ($etatMouvements as $livre) :
                    $somme_qte = $somme_qte + $livre->getQteEntere();
                    $somme_qte_sortie = $somme_qte_sortie + $livre->getQteSortie();
                    $pu_achat = $pu_achat + $livre->getPuachat();
                    $cump = $cump + $livre->getCump();
                    $val_en_stock = $val_en_stock + $livre->getStockValeur();
                    $html .= '<tr style = "font-size:10px;">
                            <td style = "width:9%;height:25px;font-size:10px;text-align:center;">' . date('d/m/Y', strtotime($livre->getCreatedAt())) . '</td>
                            <td style = "width:5%;">' . $livre->getArticle()->getCodeart()  . '</td>
                            <td style = "width:10%;text-align:center;">' . $livre->getArticle() . '</td>
                            <td style = "width:8%;">' . $livre->getArticle()->getFamillearticle() . '</td>
                            <td style = "width:9%;">' . $livre->getArticle()->getSousfamillearticle() . '</td>
            
                            <td style = "width:8%;text-align:left;">' . $livre->getLibelle() . '</td>
                            <td style = "width:7%;text-align:right;">' . number_format($livre->getQteEntere(), 3, '.', ' ') . '</td>
                            <td style = "width:7%;text-align:right;">' . number_format($livre->getQteSortie(), 3, '.', ' ') . '</td>
                            <td style = "width:7%;text-align:right;">' . number_format($somme_qte - $somme_qte_sortie, 3, '.', ' ') . '</td>
                            <td style = "width:10%;text-align:right;">' . number_format($livre->getPuachat(), 3, '.', ' ') . '</td>
                            <td style = "width:10%;text-align:right;">' .  number_format($livre->getCump(), 3, '.', ' ') . '</td>
                            <td style = "width:10%;text-align:right;">' . number_format($livre->getStockValeur(), 3, '.', ' ') . '</td>
                            </tr>';
                endforeach;
                $html .= ' <tr style="font-size:8px;font-weight:bold;">
                        <td colspan = "4" style = "">&nbsp;</td>
                        <td colspan = "2" style = " background-color: #F7F7F7;">Total Période</td>
                        <td style = " text-align: right; background-color: #fcf8e3;">';
                if ($somme_qte != 0)
                    $html .= number_format($somme_qte, 3, '.', ' ');
                $html .= '</td>
                        <td style = "text-align: right; background-color: #dff0d8;">';
                if ($somme_qte_sortie != 0)
                    $html .= number_format($somme_qte_sortie, 3, '.', ' ');
                $html .= ' </td>
                        <td style = "text-align: right; background-color: #fcf8e3;">';
                $html .= number_format($somme_qte - $somme_qte_sortie, 3, '.', ' ');
                $html .= ' </td>
                        <td style = " text-align: right; background-color: #dff0d8;">';
                if ($pu_achat != 0)
                    $html .= number_format($pu_achat, 3, '.', ' ');
                $html .= ' </td>';
                $html .= '<td style = " text-align: right; background-color: #dff0d8;">';
                if ($cump != 0)
                    $html .= number_format($cump, 3, '.', ' ');
                $html .= ' </td>';
                $html .= '<td style = " text-align: right; background-color: #dff0d8;">';
                if ($val_en_stock != 0)
                    $html .= number_format($val_en_stock, 3, '.', ' ');
                $html .= ' </td>';
                $html .= '</tr>';

            endif;
        endif;

        $html .= '</tbody></table>';

        return $html;
    }
}
