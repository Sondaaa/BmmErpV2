<?php

/**
 * Client
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    Commercial
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Client extends BaseClient {

    public function __toString() {
        return '----  ' . trim($this->getRs()) . "  ----";
    }

    public function ReadHtmlExtraitCompteClient(sfWebRequest $request) {
        $compte = $request->getParameter('compte', '');

        $date_debut = $request->getParameter('date_debut');
//        if ($date_debut == '' || $date_debut == NULL)
//            $date_debut = date('Y') . '-01-01';

        $date_fin = $request->getParameter('date_fin');
//        if ($date_fin == '' || $date_fin == NULL)
//            $date_fin = date('Y') . '-12-31';

        $journal = $request->getParameter('journal', '');
        $order = $request->getParameter('order', '');
        $lettre = $request->getParameter('lettre', '');
        $non_lettre = $request->getParameter('non_lettre', '');
        $debit = $request->getParameter('debit', '');
        $credit = $request->getParameter('credit', '');
        $client = ClientTable::getInstance()->find($compte);
        $societe = Doctrine_Core::getTable('dossiercomptable')->findOneById($_SESSION['dossier_id']);
        $etatExtraitCompte = LignePieceComptableTable::getInstance()->loadEtatExtraitCompteClient($compte, $date_debut, $date_fin, $journal, $order, $lettre, $non_lettre, $debit, $credit);

        $html = '<div border="1">
                    <table cellspacing="0" cellpadding="3">
                        <tr align="center">
                            <td style="font-weight:bold;font-size:18px;width:100%;">' . $societe->getRaisonsociale() . '</td>
                        </tr>
                        <tr align="center">
                            <td style="font-weight:bold;font-size:14px;width:100%;">Etat Fiche  Client : ' . trim($client->getCodeclt()) . ' - ' . trim($client->getRs()) . '</td>
                        </tr>
                    </table>
                </div>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="5" border="1">
                    <tr>
                        <td style="font-size:12px;width:100%;">
                         <b> Client :</b> '. trim($client->getCodeclt()) . ' - ' . trim($client->getRs()) . '<br>';
        if ($date_debut != ''):
            $html.= '     <b>Période du : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($date_debut));
        endif;
        if ($date_fin != ''):
            $html.= '   &nbsp;&nbsp; <b>Au : </b> &nbsp;&nbsp;' . date('d/m/Y', strtotime($date_fin));
        endif;
        $html.= '     </td>
                    </tr>
                </table>&nbsp;<br>';

        $html.= '<table cellspacing="0" cellpadding="3" border="1">
                    <thead>
                        <tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;">
                            <td style="width:9%;">Date</td>
                            <td style="width:23%;">Journal Comptable</td>
                            <td style="width:10%;">N° Pièce Comptable</td>
                            <td style="width:25%;">Libellé</td>
                            <td style="width:11%;">Débit</td>
                            <td style="width:11%;">Crédit</td>
                            <td style="width:11%;">Solde</td>
                        </tr>
                    </thead>';
        $resultat_debit = 0;
        $resultat_credit = 0;
        $resultat_solde = 0;
        if ($etatExtraitCompte->count() == 0):
            $html.= '<tr>
                            <td style="text-align:center;font-weight:bold;font-size:16px;" colspan="8">Extrait Auxiliaire Cleint Vide</td>
                        </tr>';
        else:
            foreach ($etatExtraitCompte as $fiche):
                if (($fiche->getMontantdebit() != 0) || ($fiche->getMontantcredit() != 0)):
                    $html.= '<tr>
                            <td style="width:9%;text-align:center;height:25px;">' . date('d/m/Y', strtotime($fiche->getDate())) . '</td>
                            <td style="width:23%;text-align:left;">' . $fiche->getPiececomptable()->getJournalcomptable()->getCode() .' '.$fiche->getPiececomptable()->getJournalcomptable()->getLibelle() . '</td>
                            <td style="width:10%;text-align:center;">' . $fiche->getPiececomptable()->getNumero() . '</td>
                            <td style="width:25%;text-align:left;">' . $fiche->getPiececomptable()->getLibelle() . '</td>
                            <td style="width:11%;text-align:right;">';
                    if ($fiche->getMontantdebit() != 0) {
                        $html.= $fiche->getMontantdebit();
                        $resultat_debit = $resultat_debit + $fiche->getMontantdebit();
                    }
                    $html.= '</td>
                        <td style="width:11%;text-align:right;">';
                    if ($fiche->getMontantcredit() != 0) {
                        $html.= $fiche->getMontantcredit();
                        $resultat_credit = $resultat_credit + $fiche->getMontantcredit();
                    }
                    $html.= '</td>
                        <td style="width:11%;text-align:right;">';
                    $html.= number_format($fiche->getMontantdebit() - $fiche->getMontantcredit(), 3, '.', ' ');
                    $resultat_solde = $resultat_solde + $fiche->getMontantdebit() - $fiche->getMontantcredit();
                    $html.= '</td>
                    </tr>';

                endif;
            endforeach;
            $html.= '<tr style="font-weight:bold;text-align:center;background-color:#F3F3F3;border: solid 1px #000000">'
                    . '<td colspan="2" style="text-align:center;bold;font-size 18px"><b>Total</b></td>'
                    . '<td colspan="2"> </td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_debit, 3, '.', ' ') . '</b></td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_credit, 3, '.', ' ') . '</b></td>'
                    . ' <td style="text-align:right;font-size 18px"><b>' . number_format($resultat_solde, 3, '.', ' ') . '</b></td>'
                    . '</tr>';
        endif;

        $html.= '</table>';

        return $html;
    }

}
