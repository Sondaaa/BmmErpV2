<?php

/**
 * Ligprotitrub
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    BmmErpTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Ligprotitrub extends BaseLigprotitrub {

    public function __toString() {
        return '' . $this->getRubrique();
    }

    public function getMntAlloueFinal() {
        return $this->getMnt() + $this->getMntexterne() - $this->getMmntretire();
    }

    public function getSourcefinancement() {
        return $this->getTitrebudjet()->getSourcesbudget();
    }

    public function getTitreEtRubrique() {
        $html = "<p>" . $this->getTitrebudjet() . ' </p><p>';
        if ($this->getRubrique()) {
            if (!$this->getRubrique()->getSousRubriqueBudgetaire())
                $html .= $this->getRubrique()->getRubriqueparent();
            else {

                $html .= $this->getRubrique() . ': ' . $this->getRubrique()->getSousRubriqueBudgetaire();
            }
        }
        $html .= '</p>';
        return $html;
    }

    public function getDetailMontant() {
        $mntengage = number_format(0, 3);
        $mntdeponse = number_format(0, 3);
        $relicaengage = number_format(0, 3);
        $relicadeponse = number_format(0, 3);

        if ($this->getMntengage())
            $mntengage = $this->getMntengage();
        if ($this->getMntdeponser())
            $mntdeponse = $this->getMntdeponser();
        if ($this->getRelicaengager())
            $relicaengage = $this->getRelicaengager();
        if ($this->getRelicadeponser())
            $relicadeponse = $this->getRelicadeponser();
        $chaine = '<p> '
                . '<span style="color: steelblue;">Montant: ' . $this->getMnt() . ' DT</span><br>'
                . '<span style="color: #a7ccec;">Montant engagé: ' . $mntengage . ' DT</span><br>'
                . '<span style="color: #1b19a5;">Montant dépensé: ' . $mntdeponse . ' DT</span><br>'
                . '<span style="color: #6619a5;">Relica engagé: ' . $relicaengage . ' DT</span><br>'
                . '<span style="color: #19a533;">Relica dépensé: ' . $relicadeponse . ' DT</span><p>';
        echo $chaine;
    }

    public function getDetail() {
        $chaine = '<p> '
                . '<span style="color: #1b19a5;">Titre: ' . $this->getTitrebudjet() . ' </span><br>'
                . '<span style="color: #6619a5;">Rubrique: ' . $this->getRubrique() . ' </span><br>';
        echo $chaine;
    }

    public function getOrder() {
        $chaine = '<p> '
                . '<span style="color: red;">' . $this->getOrderbudget() . '/' . ' </span><br>';
        echo $chaine;
    }

    public function MisAjourMntRubriqueAvenantcontrat($docAchat, $idcontrat) {
        $mntrestant = 0;

        $contratachat = ContratachatTable::getInstance()->find($idcontrat);
        $mnt_avenant = $contratachat->getMontantavenant();
        // calcul relicat enagé et mnt engagé définitif
        $mntttc = $docAchat->getMntttc();
        if ($docAchat->getIdFils()) {
            $documentfils = Doctrine_Core::getTable('documentachat')->findOneById($docAchat->getIdFils());
            // die($documentfils.'hh');
            if ($documentfils)
                $mntttc = $documentfils->getMntttc();
        }
        /* -------- Mis a jour montant engager ------------ */
        if ($this->getMntengage())
            $mntrestant = $this->getMntengage();
        $relicat = $mntrestant + $mnt_avenant;
        $this->setMntengage($relicat);

        /* --------- Fin mis a jour montant engager ------------ */

        /* ---------Mis à jour relicat engager ----------------- */
        $relicat_engager = 0;
        $relicat_engager = $this->getMnt() - $relicat;
        $this->setRelicaengager($relicat_engager);
        /* ---------fin Reliqut mnt engager------------------------- */
        /* --------- mis a jour mont provisoire et relicat provisoire- */

        $mnt_provisoire = $this->getMntprovisoire() - $mntttc;
        //        $this->setMntprovisoire($mnt_provisoire);

        /* ---------fin reliquat provisoire ------------------------------ */
    }

    /*   Mis a jour les mnt du ligne rubrique         */

    public function MisAjourMntRubrique($docAchat) {
        $mntrestant = 0;
        // calcul relicat enagé et mnt engagé définitif
        $mntttc = $docAchat->getMntttc();
        if ($docAchat->getIdFils()) {
            $documentfils = Doctrine_Core::getTable('documentachat')->findOneById($docAchat->getIdFils());
            // die($documentfils.'hh');
            if ($documentfils)
                $mntttc = $documentfils->getMntttc();
        }
        /* -------- Mis a jour montant engager ------------ */
        if ($this->getMntengage())
            $mntrestant = $this->getMntengage();
        $relicat = $mntrestant + $docAchat->getMntttc();
        $this->setMntengage($relicat);
        /* --------- Fin mis a jour montant engager ------------ */

        /* ---------Mis à jour relicat engager ----------------- */
        $relicat_engager = 0;
        $relicat_engager = $this->getMnt() - $relicat;
        $this->setRelicaengager($relicat_engager);
        /* ---------fin Reliqut mnt engager------------------------- */
        /* --------- mis a jour mont provisoire et relicat provisoire- */

        $mnt_provisoire = $this->getMntprovisoire() - $mntttc;
        $this->setMntprovisoire($mnt_provisoire);

        /* ---------fin reliquat provisoire ------------------------------ */
    }

    /* Mis A jour Mnt Rubrique BCIM* */

    public function MisAjourMntRubriqueMarcheFinan($id_doclig, $mntttc) {
        $ligne = LigprotitrubTable::getInstance()->find($id_doclig);
        $mntrestant = 0;
        // calcul relicat enagé et mnt engagé définitif       
        /* -------- Mis a jour montant engager ------------ */
        if ($ligne->getMntengage())
            $mntrestant = $ligne->getMntengage();

        $mnt_enga = $mntrestant - $mntttc;
        $ligne->setMntengage($mnt_enga);
        //        die($mnt_enga.'fr'.$mntrestant.'vf'.$mntttc);
        /* --------- Fin mis a jour montant engager ------------ */
        /* ---------Mis à jour relicat engager ----------------- */
        $relicat_engager = 0;
        $relicat_engager = $ligne->getMnt() - $mnt_enga;
        $ligne->setRelicaengager($relicat_engager);

        /* ---------fin Reliqut mnt engager------------------------- */
        /* --------- mis a jour mont provisoire et relicat provisoire- */
        $mnt_provisoire_def = floatval($ligne->getMntprovisoire() + $mntttc);
        $ligne->setMntprovisoire($mnt_provisoire_def);
        $ligne->save();
        /* ---------fin reliquat provisoire ------------------------------ */
    }

    public function MisAjourMntRubriqueMarche($id_ligne, $docAchat, $mntttc) {
        $ligne = LigprotitrubTable::getInstance()->find($id_ligne);
        //die($id_ligne.'mp');
        $mntrestant = 0;
        // calcul relicat enagé et mnt engagé définitif       
        /* -------- Mis a jour montant engager ------------ */

        if ($this->getMntengage())
            $mntrestant = $this->getMntengage();
        $mnt_enga = $mntttc;
        $this->setMntengage($mntttc);
        /* --------- Fin mis a jour montant engager ------------ */
        /* ---------Mis à jour relicat engager ----------------- */
        $relicat_engager = 0;
        $relicat_engager = $this->getMnt() - $mnt_enga;
        $this->setRelicaengager($relicat_engager);
        /* ---------fin Reliqut mnt engager------------------------- */
        /* --------- mis a jour mont provisoire et relicat provisoire- */
        $mnt_provisoire = $this->getMntprovisoire() + $mntttc;
        //        $this->setMntprovisoire($mnt_provisoire);

        /* ---------fin reliquat provisoire ------------------------------ */
    }

    public function MisAjourMntRubriqueBDCG($docAchat) {
        $mntrestant = 0;
        // calcul relicat enagé et mnt engagé définitif
        $mntttc = $docAchat->getMntttc();
        if ($docAchat->getIdFils()) {
            $documentfils = Doctrine_Core::getTable('documentachat')->findOneById($docAchat->getId());
            // die($documentfils.'hh');
            if ($documentfils)
                $mntttc = $documentfils->getMntttc();
        }
        /* -------- Mis a jour montant engager ------------ */
        if ($this->getMntengage())
            $mntrestant = $this->getMntengage();
        $relicat = $mntrestant + $docAchat->getMntttc();
        $this->setMntengage($relicat);

        /* --------- Fin mis a jour montant engager ------------ */

        /* ---------Mis à jour relicat engager ----------------- */
        $relicat_engager = 0;
        $relicat_engager = $this->getMnt() - $relicat;

        $this->setRelicaengager($relicat_engager);
        /* ---------fin Reliqut mnt engager------------------------- */
        /* --------- mis a jour mont provisoire et relicat provisoire- */

        $mnt_provisoire = $this->getMntprovisoire() - $mntttc;
        $this->setMntprovisoire($mnt_provisoire);

        /* ---------fin reliquat provisoire ------------------------------ */
    }

    public function ReadHtmlRapportRubrique($id) {

        $titre_budget = TitrebudjetTable::getInstance()->find($id);
        $rubriques = LigprotitrubTable::getInstance()->getFirstParentByTitre($titre_budget->getId());

        $html = '';

        $html .= '<table>
                    <tr>
                        <td style="width:15%;"></td>
                        <td style="width:70%; text-align:center;"><h2>&nbsp;<br><u>Rapport Budget<br>' . $titre_budget->getLibelle() . '</u></h2></td>
                        <td style="width:15%;text-align:right;font-size:12px;">' . date('H:i d/m/Y') . '</td>
                    </tr>
                </table>&nbsp;<br>';

        $html .= '<table cellspacing="0" cellpadding="3" border="1">
                    <thead>
                        <tr>
                            <th style="width:8%;height:25px;text-align:center;background-color:#EDEDED;border-left-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Code</b></th>
                            <th style="width:32%;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Rubrique<br><span style="color:#000;font-size:14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sous Rubrique</span></b></th>
                            <th style="width:12%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant Eng. Provisoire</b></th>
                            <th style="width:12%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant Eng. Définitif</b></th>
                            <th style="width:12%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Ecart Engagement</b></th>
                            <th style="width:12%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Ordonnance de Paiement</b></th>
                            <th style="width:12%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant<br>Payé</b></th>
                        </tr>
                    </thead>
                    <tbody>';
        if ($rubriques->count() >= 1) {
            foreach ($rubriques as $ldb) :
                $rubriques_sous_lignes = LigprotitrubTable::getInstance()->getSousRubrique($ldb->getIdRubrique(), $ldb->getIdTitre());
                if ($rubriques_sous_lignes->count() != 0) :
                    $mnt_rapport = calculMontantRapportSousRubrique::getMnt($rubriques_sous_lignes);
                    $html .= '<tr style="background-color: #e5f1f7;">
                                <td style="width:8%;height:25px;">' . $ldb->getCode() . '</td>
                                <td style="width:32%;">' . $ldb->getRubrique()->getLibelle() . '</td>
                                <td style="width:12%;">' . number_format($mnt_rapport["provisoire"], 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($mnt_rapport["engagement"], 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($mnt_rapport["ecart"], 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($mnt_rapport["ordonnance"], 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($mnt_rapport["paye"], 3, '.', ' ') . '</td>
                            </tr>';

                    $margin_left = "&nbsp;&nbsp;&nbsp;";
                    $color = "#006ea6";
                    $html .= $this->getSousRubrique($rubriques_sous_lignes, $margin_left, $color);
                else :
                    $total_provisoire = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ldb->getId(), 3)->getMnt();
                    $total_engage = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ldb->getId(), 1)->getMnt();
                    $total_ordonnance = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ldb->getId(), 2)->getMnt();
                    $total_caisse = LigneoperationcaisseTable::getInstance()->getMntPaye($ldb->getId())->getMnt();
                    $total_banque = MouvementbanciareTable::getInstance()->getMntPaye($ldb->getId())->getMnt();
                    $total_paye = $total_caisse + $total_banque;

                    $html .= '<tr style="background-color: #e5f1f7;">
                                <td style="width:8%;height:25px;">' . $ldb->getCode() . '</td>
                                <td style="width:32%;">' . $ldb->getRubrique()->getLibelle() . '</td>
                                <td style="width:12%;">' . number_format($total_provisoire, 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($total_engage, 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($total_provisoire - $total_engage, 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($total_ordonnance, 3, '.', ' ') . '</td>
                                <td style="width:12%;">' . number_format($total_paye, 3, '.', ' ') . '</td>
                            </tr>';
                endif;
            endforeach;
        } else {
            $html .= '<tr>
                        <td style="width:100%;text-align:center;height:100px;font-size:14px;font-weight:bold;border-left-width:1px;border-bottom-width:1px;border-right-width:1px;">&nbsp;<br>&nbsp;<br>Pas de rubriques</td>
                    </tr>';
        }

        $html .= '</tbody>
                </table>';

        return $html;
    }

    public function getSousRubrique($rubriques_sous_lignes, $margin_left, $color) {
        $html = '';
        foreach ($rubriques_sous_lignes as $ligne_sous_rubrique) :
            $rub_sous_lignes = LigprotitrubTable::getInstance()->getSousRubrique($ligne_sous_rubrique->getIdRubrique(), $ligne_sous_rubrique->getIdTitre());
            if ($rub_sous_lignes->count() != 0) :
                $style_td = "text-align: left;";
                $mnt_rapport = calculMontantRapportSousRubrique::getMnt($rub_sous_lignes);

                $html .= '<tr>
                            <td style="width:8%;color:#006ea6;height:25px;">&nbsp;&nbsp;&nbsp;&nbsp;' . $ligne_sous_rubrique->getCode() . '</td>
                            <td style="width:32%;color:#006ea6;">' . $margin_left . $ligne_sous_rubrique->getRubrique()->getLibelle() . '</td>
                            <td style="width:12%;text-align:left;">' . $margin_left . number_format($mnt_rapport["provisoire"], 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:left;">' . $margin_left . number_format($mnt_rapport["engagement"], 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:left;">' . $margin_left . number_format($mnt_rapport["ecart"], 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:left;">' . $margin_left . number_format($mnt_rapport["ordonnance"], 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:left;">' . $margin_left . number_format($mnt_rapport["paye"], 3, '.', ' ') . '</td>
                        </tr>';

                $m_left = $margin_left . "&nbsp;&nbsp;&nbsp;";

                switch ($color) {
                    case '#006ea6':
                        $s_color = "#338703";
                        break;
                    case '#338703':
                        $s_color = "#870360";
                        break;
                    case '#870360':
                        $s_color = "#873b03";
                        break;
                    case '#873b03':
                        $s_color = "#006ea6";
                        break;
                    default:
                        $s_color = "#006ea6";
                        break;
                }
                $html .= $this->getSousRubrique($rub_sous_lignes, $m_left, $s_color);
            else :
                $style_td = "text-align: right;";
                //Calcul des Totaux
                $total_provisoire = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ligne_sous_rubrique->getId(), 3)->getMnt();
                $total_engagement = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ligne_sous_rubrique->getId(), 1)->getMnt();
                $total_ordonnance = DocumentbudgetTable::getInstance()->getMntTypeDocBudget($ligne_sous_rubrique->getId(), 2)->getMnt();
                $total_caisse = LigneoperationcaisseTable::getInstance()->getMntPaye($ligne_sous_rubrique->getId())->getMnt();
                $total_banque = MouvementbanciareTable::getInstance()->getMntPaye($ligne_sous_rubrique->getId())->getMnt();
                $total_paye = $total_caisse + $total_banque;

                $html .= '<tr>
                            <td style="width:8%;color:#006ea6;height:25px;">&nbsp;&nbsp;&nbsp;&nbsp;' . $ligne_sous_rubrique->getCode() . '</td>
                            <td style="width:32%;color:#006ea6;">' . $margin_left . $ligne_sous_rubrique->getRubrique()->getLibelle() . '</td>
                            <td style="width:12%;text-align:right;">' . number_format($total_provisoire, 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:right;">' . number_format($total_engagement, 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:right;">' . number_format($total_provisoire - $total_engagement, 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:right;">' . number_format($total_ordonnance, 3, '.', ' ') . '</td>
                            <td style="width:12%;text-align:right;">' . number_format($total_paye, 3, '.', ' ') . '</td>
                        </tr>';
            endif;
        endforeach;

        return $html;
    }

    public function ReadHtmlDetailsRubrique($id) {
        $rubrique = LigprotitrubTable::getInstance()->find($id);
        $html = '';

        $html .= '<table>
                    <tr>
                        <td style="width:15%;"></td>
                        <td style="width:70%;text-align:center;"><h2>&nbsp;<br><u>Rapport Rubrique / Sous Rubrique<br>' . trim($rubrique->getRubrique()->getLibelle()) . '</u></h2></td>
                        <td style="width:15%;text-align:right;font-size:12px;">' . date('H:i d/m/Y') . '</td>
                    </tr>
                </table>&nbsp;<br>
                <span style="color: #1da600;">*Compte B. :</span> <span>Paiement(s) effectué(s) à travers le <b>compte bancaire.</b></span>
                <br>
                <span style="color: #a65d00;">*Caisse :</span> <span>Paiement(s) effectué(s) à travers la <b>caisse.</b></span>
                &nbsp;<br>&nbsp;<br>';

        $html .= '<table cellspacing="0" cellpadding="3" border="1">
                    <thead>
                        <tr>
                            <th style="width:4%;height:25px;text-align:center;background-color:#EDEDED;border-left-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>#</b></th>
                            <th style="width:9%;text-align:center;background-color:#EDEDED;border-left-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>N° Ordon.</b></th>
                            <th style="width:8.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Date</b></th>
                            <th style="width:26%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Fournisseur</b></th>
                            <th style="width:10.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant Eng. Provisoire</b></th>
                            <th style="width:10.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant Eng. Définitif</b></th>
                            <th style="width:10.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Ecart Engagement</b></th>
                            <th style="width:10.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Ordonnance de Paiement</b></th>
                            <th style="width:10.5%;text-align:center;background-color:#EDEDED;border-right-width:1px;border-bottom-width:1px;border-top-width:1px;"><b>Montant<br>Payé</b></th>
                        </tr>
                    </thead>
                    <tbody>';

        $total_provisoire = 0;
        $total_engage = 0;
        $total_paye = 0;
        $total_ordonnance = 0;
        $document_budgets = $rubrique->getDocumentbudget();
        $i = 1;
        foreach ($document_budgets as $db) :
            if ($db->getAnnule() == false || $db->getAnnule() == null) :
                $piecejointbudget = $db->getPiecejointbudget()->getFirst();
                if ($piecejointbudget) {
                    if ($piecejointbudget->getIdDocachat()) {
                        $document_achat = $piecejointbudget->getDocumentachat();

                        $document_budget_provisoire = Doctrine_Core::getTable('documentbudget')
                                        ->createQuery('db')
                                        ->from('Documentbudget db')
                                        ->leftJoin('db.Piecejointbudget pjb')
                                        ->leftJoin('pjb.Documentachat da')
                                        ->where('db.id_type=' . 3)
                                        ->where('db.annule=false')
                                        ->andWhere('da.id = ' . $document_achat->getId())
                                        ->execute()->getFirst();
                        $document_budget_engage = Doctrine_Core::getTable('documentbudget')
                                        ->createQuery('db')
                                        ->from('Documentbudget db')
                                        ->leftJoin('db.Piecejointbudget pjb')
                                        ->leftJoin('pjb.Documentachat da')
                                        ->where('db.id_type=' . 1)
                                        ->where('db.annule=false')
                                        ->andWhere('da.id = ' . $document_achat->getId())
                                        ->execute()->getFirst();
                    }
                }

                $color = "#FFFFFF";
                if (!$document_budget_provisoire || !$document_budget_provisoire) :
                    $color = "#ffdcdc";
                endif;

                $mnt_provisoire = 0;
                $mnt_engage = 0;
                $mnt_ordonnance = 0;
                $ecart = 0;
                if ($document_budget_provisoire && $db->getIdType() == 3)
                    $mnt_provisoire = $document_budget_provisoire->getMnt();
                if ($document_budget_engage && $db->getIdType() == 1)
                    $mnt_engage = $document_budget_engage->getMnt();
                if ($db->getIdType() != 2)
                    $ecart = $mnt_provisoire - $mnt_engage;
                else
                    $ecart = '';

                if ($db->getIdType() == 2)
                    $mnt_ordonnance = $db->getMntnet();

                if ($mnt_provisoire == 0)
                    $mnt_provisoire = '';
                if ($mnt_engage == 0)
                    $mnt_engage = '';
                if ($mnt_ordonnance == 0)
                    $mnt_ordonnance = '';

                $html .= '<tr style="background-color:' . $color . '">
                        <td style="width:4%;text-align:center;height:25px;">' . $i . '</td>
                        <td style="width:9%;text-align:center;color:#006ea6;">' . $db->getNumero() . '</td>
                        <td style="width:8.5%;text-align:center;color:#006ea6;">' . date('d/m/Y', strtotime($db->getDatecreation())) . '</td>
                        <td style="width:26%;color:#006ea6;">';
                if ($piecejointbudget) {
                    if ($piecejointbudget->getIdDocachat()) {
                        $thml.= $document_achat->getFournisseur()->getRs();
                    }
                }

                $html.= '</td>
                        <td style="width:10.5%;text-align:right;">' . number_format($mnt_provisoire, 3, '.', ' ') . '</td>
                        <td style="width:10.5%;text-align:right;">' . number_format($mnt_engage, 3, '.', ' ') . '</td>
                        <td style="width:10.5%;text-align:right;">' . number_format($ecart, 3, '.', ' ') . '</td>
                        <td style="width:10.5%;text-align:right;">' . number_format($mnt_ordonnance, 3, '.', ' ') . '</td>
                        <td style="width:10.5%;text-align:right;"></td>
                    </tr>';

                $total_provisoire = $total_provisoire + $mnt_provisoire;
                $total_engage = $total_engage + $mnt_engage;
                $total_ordonnance = $total_ordonnance + $mnt_ordonnance;
                $i++;
                if ($db->getIdType() == 2) :
                    //ajout des montants de paiement par banque
                    foreach ($db->getMouvementbanciare() as $mouvement) :
                        $html .= '<tr>
                                    <td style="text-align: center;">' . $i . '</td>
                                    <td style="text-align: center; color: #006ea6;">' . $mouvement->getReford() . '</td>
                                    <td style="text-align: center; color: #006ea6;">' . date('d/m/Y', strtotime($mouvement->getDateoperation())) . '</td>
                                    <td style="padding-left: 20px; color: #006ea6;"><span style="color: #1da600;">*Compte B. :</span> ' . $mouvement->getCaissesbanques() . '</td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;">' . number_format($mouvement->getDebit() + $mouvement->getMntenoper() - $mouvement->getCredit(), 3, '.', ' ') . '</td>
                                </tr>';

                        $total_paye = $total_paye + $mouvement->getDebit() + $mouvement->getMntenoper() - $mouvement->getCredit();
                        $i++;
                    endforeach;

                    //ajout des montants de paiement par caisse
                    $ligne_caisses = LigneoperationcaisseTable::getInstance()->findByIdBudget($rubrique->getId());
                    foreach ($ligne_caisses as $ligne_caisse) :
                        $html .= '<tr>
                                    <td style="text-align: center;">' . $i . '</td>
                                    <td style="text-align: center; color: #006ea6;">' . $ligne_caisse->getNumeroo() . '</td>
                                    <td style="text-align: center; color: #006ea6;">' . date('d/m/Y', strtotime($ligne_caisse->getDateoperation())) . '</td>
                                    <td style="padding-left: 20px; color: #006ea6;"><span style="color: #a65d00;">*Caisse :</span> ' . $ligne_caisse->getCaissesbanques() . '</td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;"></td>
                                    <td style="text-align: right;">' . number_format($ligne_caisse->getMntoperation(), 3, '.', ' ') . '</td>
                                </tr>';

                        $total_paye = $total_paye + $ligne_caisse->getMntoperation();
                        $i++;
                    endforeach;
                endif;
            endif;
        endforeach;

        $total_ecart = $total_provisoire - $total_engage;
        $html .= '<tr style="background-color: #f5f5f5;">
                    <td style="width:47.5%;text-align:center;height:25px;"><b>Total</b></td>
                    <td style="width:10.5%;text-align:right;">' . number_format($total_provisoire, 3, '.', ' ') . '</td>
                    <td style="width:10.5%;text-align:right;">' . number_format($total_engage, 3, '.', ' ') . '</td>
                    <td style="width:10.5%;text-align:right;">' . number_format($total_ecart, 3, '.', ' ') . '</td>
                    <td style="width:10.5%;text-align:right;">' . number_format($total_ecart, 3, '.', ' ') . '</td>
                    <td style="width:10.5%;text-align:right;">' . number_format($total_ordonnance, 3, '.', ' ') . '</td>
                </tr>';

        $html .= '</tbody>
                </table>';

        return $html;
    }

    public function ReadHtmlSituationEngagement(sfWebRequest $request) {
        $mois = $request->getParameter('mois');
        $annee = $request->getParameter('annee');
        $titre = $request->getParameter('titre');
        $listes = LigprotitrubTable::getInstance()->getParentByTitreBudget($titre);
        $titre_budget = TitrebudjetTable::getInstance()->find($titre);

        $html = '<h3 style="font-size:18px;">SITUATION DES ENGAGEMENTS BUDGETAIRES</h3>';

        $html .= '&nbsp;<br><table>
                    <tr>
                        <td style="width:80%;"><b>Budget :</b> ' . $titre_budget . '</td>
                        <td style="width:20%;"><b>Jusqu\'au :</b> ' .
//                str_pad($mois, 2, 0, STR_PAD_LEFT) '/' . $annee .
                date('d/m/Y') . '</td>
                    </tr>
                </table>';

        $html .= '<table><tr><td style="text-align:right;width:100%;"><b>(en DT)</b></td></tr></table>
                <table border="1" cellpadding="3">
                <thead>
                    <tr style="font-size:11px;text-align:center;font-weight:bold;background-color:#E0E0E0;">
                        <td style="width: 15%;height:25px;">Rubriques</td>
                        <td style="width: 10%;text-align: center;">Crédits Alloués</td>
                        <td style="width: 9%;text-align: center;">Engag° Antérieurs</td>
                        <td style="width: 9%;text-align: center;">Engag° du Mois</td>
                        <td style="width: 10%;text-align: center;">Engag° Cumulés</td>
                        <td style="width: 10%;text-align: center;">Reliquats à Engager</td>
                        <td style="width: 9%;text-align: center;">Paiem° Antérieurs</td>
                        <td style="width: 9%;text-align: center;">Paiem° du Mois</td>
                        <td style="width: 9%;text-align: center;">Paiem° Cumulés</td>
                        <td style="width: 10%;text-align: center;">Engag° à Payer</td>
                    </tr></thead><tbody>';

        $mnt_alloue = 0;
        $mnt_transfert_final = 0;
        $mnt_engage_anterieur = 0;
        $mnt_transfert_sous_liste = 0;
        $mnt_engage_courant = 0;
        $mnt_engage_cumule = 0;
        $relica_engage = 0;
        $mnt_paiement_anterieur = 0;
        $mnt_paiement_courant = 0;
        $mnt_paiement_courant_sous = 0;
        $mnt_paiement_cumule = 0;
        $mnt_engage_payer = 0;
        $mnt_courant_rub = 0;
        $mnt_courant_rub_sans = 0;
        $montant_paiement_anterieur_rub = 0;
        $montant_ordonnance_antecedent_rub = 0;
        $montant_ordonnance_antecedent_rub_sans_sous_liste = 0;
        $montant_paiement_courant_rubsousrubrique = 0;
        $montant_paiement_courant_rub = 0;
        $montant_paiement_courant_liste = 0;
        $montant_ordonnance_courant_rub = 0;
        $montant_ordonnance_courant_rub_sans_sous_liste = 0;
        $mois_anterieur = $mois - 1;
        if ($mois_anterieur < 10)
            $mois_anterieur = sprintf("%02d", $mois_anterieur);
        $date_antecedent = $annee . '-' . $mois_anterieur . '-31';

        $date_fin = date('Y-m-t', strtotime($annee . '-' . $mois . '-01'));


        foreach ($listes as $liste) :
            $sous_listes = LigprotitrubTable::getInstance()->getSousrubriqueByTitreBudget($titre, $liste->getIdRubrique());
            foreach ($sous_listes as $sous_liste) :
                $mnt_transfert_sous_liste = $mnt_transfert_sous_liste + $sous_liste->getMntexterne() + $sous_liste->getMntretire();
                $montant_ordonnance_courant_sous_liste = DocumentbudgetTable::getInstance()->getMontantCourantByLigprotitrub($date_antecedent, $date_fin, $sous_liste->getId());
                $mnt_courant_rub = $mnt_courant_rub + $sous_liste->getMntEngage();
                $montant_paiement_anterieur_sous_liste = LigprotitrubTable::getInstance()->getMontantPaiementAnterieurByLigprotitrub($date_antecedent, $sous_liste->getId());
                $montant_paiement_anterieur_rub = $montant_paiement_anterieur_rub + $montant_paiement_anterieur_sous_liste->getMnt();
                $montant_paiement_courant_sous_liste = LigprotitrubTable::getInstance()->getMontantPaiementCourantByLigprotitrub($date_antecedent, $date_fin, $sous_liste->getId());
                $montant_paiement_courant_rub = $montant_paiement_courant_rub + $montant_paiement_courant_sous_liste->getMnt();
                $montant_ordonnance_courant_rub = $montant_ordonnance_courant_rub + $montant_ordonnance_courant_sous_liste->getMnt();
                $montant_ordonnance_antecedent_sous_liste = DocumentbudgetTable::getInstance()->getMontantAntecedantByLigprotitrub($date_antecedent, $sous_liste->getId());
                $montant_ordonnance_antecedent_rub = $montant_ordonnance_antecedent_rub + $montant_ordonnance_antecedent_sous_liste->getMnt();
            endforeach;
            $mnt_transfert = $liste->getMntexterne() + $liste->getMntretire();
            if (count($sous_listes) == 0) {
                $montant_ordonnance_antecedent_sous_liste_sans_sous = DocumentbudgetTable::getInstance()->getMontantAntecedantByLigprotitrub($date_antecedent, $liste->getId());
                $montant_ordonnance_antecedent_rub_sans_sous_liste = $montant_ordonnance_antecedent_rub_sans_sous_liste + $montant_ordonnance_antecedent_sous_liste_sans_sous->getMnt();

                $montant_ordonnance_courant_sans_sous_liste = DocumentbudgetTable::getInstance()->getMontantCourantByLigprotitrub($date_antecedent, $date_fin, $liste->getId());
                $montant_ordonnance_courant_rub_sans_sous_liste = $montant_ordonnance_courant_rub + $montant_ordonnance_courant_sans_sous_liste->getMnt();

                $mnt_courant_rub_sans = $mnt_courant_rub + $liste->getMntEngage();
                $mnt_transfert_final = $mnt_transfert_sous_liste + $mnt_transfert;
                $montant_paiement_courant_liste = LigprotitrubTable::getInstance()->getMontantPaiementCourantByLigprotitrub($date_antecedent, $date_fin, $liste->getId());
                $montant_paiement_courant_rubsousrubrique = $montant_paiement_courant_rubsousrubrique + $montant_paiement_courant_liste->getMnt();
            } else {

                $mnt_courant_rub_sans = $mnt_courant_rub;
                $mnt_transfert_final = $mnt_transfert;
                $montant_paiement_courant_rubsousrubrique = $montant_paiement_courant_rub;
            }

            $montant_ordonnance_antecedent = DocumentbudgetTable::getInstance()->getMontantAntecedantByLigprotitrub($date_antecedent, $liste->getId());
            $montant_ordonnance_courant = DocumentbudgetTable::getInstance()->getMontantCourantByLigprotitrub($date_antecedent, $date_fin, $liste->getId());
            $montant_ordonnance_courant_ruprique = DocumentbudgetTable::getInstance()->getMontantCourantRubriqueByLigprotitrub($date_antecedent, $date_fin, $liste->getId());
            $montant_paiement_anterieur = LigprotitrubTable::getInstance()->getMontantPaiementAnterieurByLigprotitrub($date_antecedent, $liste->getId());
            $montant_paiement_courant = LigprotitrubTable::getInstance()->getMontantPaiementCourantByLigprotitrub($date_antecedent, $date_fin, $liste->getId());
            if (count($sous_listes) != 0) {
                $montant_ordonnance_antecedent = $montant_ordonnance_antecedent_rub;
            } else {
                $montant_ordonnance_antecedent = $montant_ordonnance_antecedent->getMnt();
            }
            if (count($sous_listes) != 0) {
                $montant_ordonnance_courant = $montant_ordonnance_courant_rub;
            } else {
                $montant_ordonnance_courant = $montant_ordonnance_courant->getMnt();
            }
            $html .= '<tr >
                        <td style="width: 15%;height:25px;"><b style="color: #0066cc;">' . $liste->getRubrique()->getCode() . ' : ' . $liste->getRubrique()->getLibelle() . '</b> </td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #dff0d8;"><b>' . number_format($liste->getMnt() + $mnt_transfert_final, 3, '.', ' ') . '</b></td>
                        <td style="width: 9%;text-align: right; font-size: 10px;"><b>' . number_format($montant_ordonnance_antecedent, 3, '.', ' ') . '</b></td>
                        <td style="width: 9%;text-align: right; font-size: 10px;"><b>' . number_format($montant_ordonnance_courant, 3, '.', ' ') . '</b></td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #d9edf7;"><b>' . number_format($montant_ordonnance_antecedent + $montant_ordonnance_courant, 3, '.', ' ') . '</b></td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #fdffd5;"><b>' . number_format(($liste->getMnt() + $mnt_transfert_final) - ($montant_ordonnance_antecedent + $montant_ordonnance_courant), 3, '.', ' ') . '</b></td>
                        <td style="width: 9%;text-align: right; font-size: 10px;"><b>' . number_format($montant_paiement_anterieur_rub, 3, '.', ' ') . '</b></td>
                        <td style="width: 9%;text-align: right; font-size: 10px;"><b>' . number_format($montant_paiement_courant_rubsousrubrique, 3, '.', ' ') . '</b></td>
                        <td style="width: 9%;text-align: right; font-size: 10px; background-color: #fcf8e3;"><b>' . number_format($montant_paiement_anterieur_rub + $montant_paiement_courant_rubsousrubrique, 3, '.', ' ') . '</b></td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #f2dede;"><b>' . number_format($montant_ordonnance_antecedent + $montant_ordonnance_courant - ($montant_paiement_anterieur_rub + $montant_paiement_courant_rubsousrubrique), 3, '.', ' ') . '</b></td>
                    </tr>';
            $sous_listes = LigprotitrubTable::getInstance()->getSousrubriqueByTitreBudget($titre, $liste->getIdRubrique());
            foreach ($sous_listes as $sous_liste) :
                $montant_ordonnance_antecedent_sous_liste = DocumentbudgetTable::getInstance()->getMontantAntecedantByLigprotitrub($date_antecedent, $sous_liste->getId());
                $montant_ordonnance_courant_sous_liste = DocumentbudgetTable::getInstance()->getMontantCourantByLigprotitrub($date_antecedent, $date_fin, $sous_liste->getId());
                $montant_paiement_anterieur_sous_liste = LigprotitrubTable::getInstance()->getMontantPaiementAnterieurByLigprotitrub($date_antecedent, $sous_liste->getId());
                $montant_paiement_courant_sous_liste = LigprotitrubTable::getInstance()->getMontantPaiementCourantByLigprotitrub($date_antecedent, $date_fin, $sous_liste->getId());
                $html .= '<tr><td style="width: 15%;text-align: left; font-size: 10px;" >' . $sous_liste->getRubrique()->getCode() . ' : ' . $sous_liste->getRubrique()->getLibelle() . '</td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #dff0d8;">' . number_format($sous_liste->getMnt() + $sous_liste->getMntexterne() + $sous_liste->getMntretire(), 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 10px;">' . number_format($montant_ordonnance_antecedent_sous_liste->getMnt(), 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 10px;">' . number_format($montant_ordonnance_courant_sous_liste->getMnt(), 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #d9edf7;">' . number_format($montant_ordonnance_antecedent_sous_liste->getMnt() + $montant_ordonnance_courant_sous_liste->getMnt(), 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #fdffd5;">' . number_format(($sous_liste->getMnt() + $sous_liste->getMntexterne() + $sous_liste->getMntretire()) - ($montant_ordonnance_antecedent_sous_liste->getMnt() + $montant_ordonnance_courant_sous_liste->getMnt()), 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 10px;">' . number_format($montant_paiement_anterieur_sous_liste->getMnt(), 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 10px;">' . number_format($montant_paiement_courant_sous_liste->getMnt(), 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 10px; background-color: #fcf8e3;">' . number_format(($montant_paiement_anterieur_sous_liste->getMnt() + $montant_paiement_courant_sous_liste->getMnt()), 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 10px; background-color: #f2dede;">' . number_format($sous_liste->getMntEngage() - ($montant_paiement_anterieur_sous_liste->getMnt() + $montant_paiement_courant_sous_liste->getMnt()), 3, '.', ' ') . '</td>
                    </tr>';
//                $mnt_engage_anterieur = $mnt_engage_anterieur + $montant_ordonnance_antecedent_sous_liste->getMnt();
                $relica_engage_sous = $relica_engage + ($sous_liste->getMnt() + $sous_liste->getMntexterne() + $sous_liste->getMntretire()) - ($montant_ordonnance_antecedent_sous_liste->getMnt() + $sous_liste->getMntEngage());
                $mnt_paiement_anterieur = $mnt_paiement_anterieur + $montant_paiement_anterieur_sous_liste->getMnt();
                $mnt_paiement_courant_sous = $mnt_paiement_courant_sous + $montant_paiement_courant_sous_liste->getMnt();
                $mnt_paiement_cumule = $mnt_paiement_cumule + $montant_paiement_anterieur_sous_liste->getMnt() + $montant_paiement_courant->getMnt();
                $mnt_engage_payer_sous = $mnt_engage_payer + $montant_ordonnance_antecedent_sous_liste->getMnt() + $sous_liste->getMntEngage() - ($montant_paiement_anterieur_sous_liste->getMnt() + $montant_paiement_courant_sous_liste->getMnt());
            endforeach;
            $mnt_engage_anterieur = $mnt_engage_anterieur + $montant_ordonnance_antecedent;
                $mnt_engage_courant = $mnt_engage_courant + $montant_ordonnance_courant;
                $mnt_engage_cumule = $mnt_engage_anterieur + $mnt_engage_courant;
                $mnt_paiement_courant = $mnt_paiement_courant + $montant_paiement_courant_rubsousrubrique;
                $mnt_alloue = $mnt_alloue + $liste->getMnt() + $mnt_transfert_final;
                $relica_engage = $mnt_alloue - $mnt_engage_cumule;
                $mnt_engage_payer = $mnt_engage_cumule - $mnt_engage_payer_sous;
                 endforeach;
        $html .= '<tr style="font-size:10px;font-weight:bold;background-color:#EEEEEE;">
                        <td style="width: 15%;text-align: center; height:25px; font-size:11px;">Total</td>
                        <td style="width: 10%;text-align: right; font-size: 11px; background-color: #dff0d8;">' . number_format($mnt_alloue, 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 11px;">' . number_format($mnt_engage_anterieur, 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 11px;">' . number_format($mnt_engage_courant, 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 11px; background-color: #d9edf7;">' . number_format($mnt_engage_cumule, 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 11px; background-color: #fdffd5;">' . number_format($relica_engage, 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 11px;">' . number_format($mnt_paiement_anterieur, 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 11px;">' . number_format($mnt_paiement_courant, 3, '.', ' ') . '</td>
                        <td style="width: 9%;text-align: right; font-size: 11px; background-color: #fcf8e3;">' . number_format($mnt_paiement_courant + $mnt_paiement_anterieur, 3, '.', ' ') . '</td>
                        <td style="width: 10%;text-align: right; font-size: 11px; background-color: #f2dede;">' . number_format($mnt_engage_cumule - ($mnt_paiement_anterieur + $mnt_paiement_courant), 3, '.', ' ') . '</td>
                </tr>';

        $html .= '</tbody></table>';

        return $html;
    }

}
