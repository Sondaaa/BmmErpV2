<?php

/**
 * Immobilisation
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    InventaireTest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Immobilisation extends BaseImmobilisation
{
    public function ReadHtmlFicheImmobbilisationAvecChoix(sfWebRequest $request)
    {

        $numero = $request->getParameter('numero');
        $date_creation = $request->getParameter('date_creation');
        $date_enservice = $request->getParameter('date_enservice');
        $date_enrebut = $request->getParameter('date_enrebut');
        $anicen_num = $request->getParameter('anicen_num');
        $emeteur = $request->getParameter('emeteur');
        $categorie = $request->getParameter('categorie');
        $famille = $request->getParameter('famille');
        $sous_famille = $request->getParameter('sous_famille');
        $code = $request->getParameter('code');
        $designation = $request->getParameter('designation');
        $desciption = $request->getParameter('desciption');
        $type_affectation = $request->getParameter('type_affectation');
        $site = $request->getParameter('site');
        $sous_site = $request->getParameter('sous_site');
        $local = $request->getParameter('local');
        $date_acquisition = $request->getParameter('date_acquisition');
        $mnttva = $request->getParameter('mnttva');
        $tva = $request->getParameter('tva');
        $mnttc = $request->getParameter('mnttc');

        // $q = Doctrine_Core::getTable('immobilisation')
        //     ->createQuery('immo')
        //     ->select('*')
        //     ->from('immobilisation as immo,site as site , etage as etage,bureaux,categoerie,famille,sousfamille')
        //     ->andWhere('immo.id_site =site.id ')
        //     ->andWhere('immo.id_etage =etage.id ')
        //     ->andWhere('immo.id_bureaux = bureaux.id')
        //     ->andWhere('immo.id_categorie =categoerie.id ')
        //     ->andWhere('immo.id_famille = famille.id')
        //     ->andWhere('immo.id_sousfamille =sousfamille.id ')
        //     ;
        // $q->orderBy('numero');
        // $immobilisations = $q->execute();
        $immobilisations = ImmobilisationTable::getInstance()->findAll();
        $html = '<h3 style="font-size:18px;">Liste des Immobilisation<br><span style="font-size:16px;"></h3>
            ';
        $html .= '<table border="1" cellspace="0" cellpadding="2" style="width:100%;" >
            <tr style="background-color:#ECECEC;">
                <td style="height:25px;text-align:center;">N°</td>';
        if ($numero != "")
            $html .= ' <td style="text-align:center;">N°Fi.</td>';
        if ($date_creation != "")
            $html .= ' <td style="width:8%;text-align:center;">Date.Cré</td>';
        if ($designation != "")
            $html .= '<td style="text-align:center;">Désig.</td>';
        if ($date_enservice != "")
            $html .= '<td style="text-align:center;">Date En Service</td>';
        if ($date_enrebut != "")
            $html .= '<td style="text-align:center;">Date En Rebus</td>';
        if ($anicen_num != "")
            $html .= '<td style="text-align:center;">Ancien N°</td>';
        if ($emeteur != "")
            $html .= '<td style="text-align:center;">Emetteur</td>';
        if ($categorie != "")
            $html .= '<td style="text-align:center;">Cat.</td>';
        if ($famille != "")
            $html .= '<td style="text-align:center;">Famille</td>';
        if ($sous_famille != "")
            $html .= '<td style="text-align:center;">S.Famille</td>';
        if ($code != "")
            $html .= '<td style="text-align:center;">Code Imm.</td>';
        if ($desciption != "")
            $html .= '<td style="text-align:center;">Déscription</td>';
        if ($type_affectation != "")
            $html .= '<td style="text-align:center;">Type Affec.</td>';
        if ($site != "")
            $html .= ' <td style="text-align:center;">Site</td>';
        if ($sous_site != "")
            $html .= '<td style="text-align:center;">Sous<br>Site</td>';
        if ($local != "")
            $html .= ' <td style="text-align:center;">Local</td>';
        if ($designation != "")
            $html .= ' <td style="text-align:center;">Catégo.</td>';
        if ($designation != "")
            $html .= '<td style="text-align:center;">Famille</td>';
        if ($designation != "")
            $html .= '<td style="text-align:center;">Sous Famil.</td>';
        if ($date_acquisition != "")
            $html .= '<td style="text-align:center;">D.Acquisition</td>';
        if ($mnttva != "")
            $html .= ' <td style="text-align:center;">MT HTVA</td>';
        if ($tva != "")
            $html .= ' <td style="text-align:center;">TVA</td>';
        if ($mnttc != "")
            $html .= ' <td style="text-align:center;">MT TTC</td>';
        $html .= ' </tr>';
        if (sizeof($immobilisations) != 0) :
            $k = 1;
            foreach ($immobilisations as $immob) :
                $html .= '<tr style="font-size:10px;">
                    <td style="text-align:center;">' . $k . '</td>';
                if ($numero != "")
                    $html .= '<td style="text-align:left;">' . $immob->getNumero() . '</td>';
                if ($date_creation != "") {
                    $html .= '    <td>';
                    if ($immob->getDatecreation()) {
                        $immob->getDatecreation();
                    }
                    $html .= '</td>';
                }
                if ($date_enservice != "") {
                    $html .= '<td>';
                    if ($immob->getDatemisajour()) {
                        $immob->getDatemisajour();
                    }
                    $html .=  '</td>';
                }
                if ($date_enrebut != "") {
                    $html .= '    <td>';
                    if ($immob->getDatemiseenrebut()) {
                        $immob->getDatemiseenrebut();
                    }
                    $html .= '</td>';
                }
                if ($anicen_num != "") {
                    $html .= '    <td>' . $immob->getNumeropiece() . '</td>';
                }
                if ($emeteur != "") {
                    $html .= '<td>';
                    if ($immob->getIdUser())
                        $immob->getUtilisateur()->getAgents();
                    $html .=   '</td>';
                }
                if ($categorie != "") {
                    $html .=   '<td style="text-align:left;">';
                    if ($immob->getIdCategorie())
                        $html .= $immob->getCategoerie()->getCodecategoeie() . ' ' . $immob->getCategoerie();
                    $html .=  '</td>';
                }
                if ($famille) {
                    $html .=   '<td style="text-align:left;">';
                    if ($immob->getIdFamille())
                        $html .= $immob->getFamille();
                    $html .=  '</td>';
                }
                if ($sous_famille) {
                    $html .=   '<td style="text-align:left;">';
                    if ($immob->getIdSousfamille())
                        $html .= $immob->getSousfamille();
                    $html .=  '</td>';
                }
                if ($code != "")
                    $html .= '    <td>' . $immob->getReference() . '</td>';
                if ($designation != "")
                    $html .= '    <td>' . $immob->getDesignation() . '</td>';
                if ($desciption != "")
                    $html .= '    <td>' . $immob->getDescription() . '</td>';
                if ($type_affectation != "") {
                    if ($immob->getIdTypeaffectationimmo())
                        $html .= '    <td>' . $immob->getTypeaffectationimmo() . '</td>';
                }
                if ($site) {
                    if ($immob->getIdSite())
                        $html .= '<td>' . $immob->getSite()->getCode() . ' ' . $immob->getSite();
                    $html .= ' </td>';
                }
                if ($sous_site) {
                    if ($immob->getIdEtage()) {
                        $html .= $immob->getEtage()->getCode() . ' ' . $immob->getEtage();
                    }
                    $html .=  '</td>';
                }
                if ($local) {
                    $html .=   '<td style="text-align:left;">';
                    if ($immob->getIdBureaux())
                        $html .= $immob->getBureaux()->getCode() . ' ' . $immob->getBureaux();
                    $html .=  '</td>';
                }


                if ($date_acquisition) {
                    $html .= '<td>' .
                        date('d/m/Y', strtotime($immob->getDateacquisition())) . '</td>';
                }
                if ($mnttva) {
                    $html .= '  <td style="text-align:rigth;">' . number_format($immob->getPrixhtva(), 3, '.', ' ') . '</td>';
                }

                if ($tva) {
                    $html .=   '<td style="text-align:left;">';
                    if ($immob->getITva())
                        $html .= $immob->getTva()->getVa()->getLibelle();
                    $html .=  '</td>';
                }
                if ($mnttc) {
                    $html .= '  <td style="text-align:rigth;">' . number_format($immob->getMntttc(), 3, '.', ' ') . '</td>';
                }

                $html .= '   </tr>';

                $k++;
            endforeach;
        else :
            $html .= '<tr>
                                <td style="width:100%;height:20px;text-align:center;">Pas d\'immobilisations</td>
                            </tr>';
        endif;

        $html .= '</table>';


        return $html;
    }

    public function __toString()
    {
        return "" . $this->getReference() . " " . $this->getDesignation();
    }

    public function getEmplacement()
    {
        $donees = "";
        $donees .= "<p><span style='color:#9f191f'>Code Bureaux: </span>" . $this->getBureaux()->getCode() . '<br>';
        $donees .= "<span style='color:#9f191f'>Bureaux: </span>" . $this->getBureaux()->getBureau() . '<br>';
        $donees .= "<span style='color:#9f191f'>Etage:</span> " . $this->getEtage() . " </p>";
        $donees .= "<p><span style='color:#9f191f'>Site:</span> " . $this->getSite() . '<br>';
        $donees .= "<span style='color:#9f191f'>Gouvernorat: </span>" . $this->getGouvernera() . "<br>";
        $donees .= "<span style='color:#9f191f'>Pays:</span> " . $this->getPays() . " <br>";
        $donees .= "<span style='color:#9f191f'>Utilisateur:</span> " . $this->getAgents() . " <br>";
        echo $donees;
    }

    public function getClassificationcomptable()
    {
        $donees = "";
        $donees .= "<p><span style='color:#ff0084'>Famille:</span> " . $this->getFamille() . '<br>';
        $donees .= "<span style='color:#ff0084'>Sous Famille:</span> " . $this->getSousfamille() . "</p>";
        $donees .= "<p><span style='color:#ff0084'>Date d'acquisation:</span> " . $this->getDateacquisition() . '<br>';
        $donees .= "<span style='color:#ff0084'>Prix d'acquisation:</span> " . $this->getMntttc() . " DT <br>";
        if ($this->getDateacquisition())
            $donees .= "<span style='color:#ff0084'>Année d'acquisation:</span> " . date('Y', strtotime($this->getDateacquisition())) . "<br>";
        else
            $donees .= "<span style='color:#ff0084'>Année d'acquisation:</span><br>";
        $donees .= "<span style='color:#ff0084'>Compte Comptable:</span> " . $this->getPlancomptable()->getNumerocompte() . "<br>";
        echo $donees;
    }

    public function getMntttc1()
    {
        if ($this->getMntttc())
            return "" . $this->getMntttc() . " DT";
        else
            return "0.000 DT";
    }

    public function getDateacquisition1()
    {
        return date("d-m-Y", strtotime($this->getDateacquisition()));
    }

    public function getCodebarre($new)
    {

        if ($new == 0)
            return $this->getReference();
        else {
            $listeimmobilisations = Doctrine_Core::getTable('immobilisation')->findAll();
            $i = count($listeimmobilisations) + 1;
            $chaine_numerofiche = sprintf('%06d', $i);
            $chaine = '0000000' . $chaine_numerofiche;

            return $chaine;
        }
    }

  

    public function CalculeNombreImmob($des, $idb)
    {
        $listeimmobilisations = Doctrine_Core::getTable('immobilisation')->findByDesignationAndIdBureaux($des, $idb);
        return count($listeimmobilisations);
    }

    public function ReadHtmlFiche($id)
    {
        $societe = Doctrine_Core::getTable('societe')->findOneById(1);
        $immo = Doctrine_Core::getTable('immobilisation')->findOneById($id);
        $emplacments = EmplacementTable::getInstance()->findByIdImmo($immo->getId());

        $emplacments_html = '';
        foreach ($emplacments as $emplacment) :
            $buureau = '';
            if ($emplacment->getIdBureau())
                $buureau = Doctrine_Core::getTable('bureaux')->findOneById($emplacment->getIdBureau());
            $user = '';
            if ($emplacment->getIdUser())
                $user = Doctrine_Core::getTable('agents')->findOneById($emplacment->getIdUser());
            $emplacments_html .= '<tr><td>
                                        <table>
                                            <tr><td style="width:26%"><b>Type :</b></td><td style="width:74%">' . $emplacment->getAdresse() . '</td></tr>
                                            <tr><td style="width:26%"><b>Date Affectation :</b></td><td style="width:74%">' . date('d/m/Y', strtotime($emplacment->getDateaffectation())) . '</td></tr>
                                            <tr><td style="width:26%"><b>Bureau :</b></td><td style="width:74%">' . $buureau . '</td></tr>
                                            <tr><td style="width:26%"><b>Utilisateur :</b></td><td style="width:74%">' . $user . '</td></tr>
                                            <tr><td style="width:26%"><b>Référence :</b></td><td style="width:74%">' . $emplacment->getReference() . '</td></tr>
                                        </table>
                                </td></tr>';
        endforeach;

        $date_creation = '';
        if ($immo->getDatecreation())
            $date_creation = date('d/m/Y', strtotime($immo->getDatecreation()));
        $date_service = '';
        if ($immo->getDatemiseenservice())
            $date_service = date('d/m/Y', strtotime($immo->getDatemiseenservice()));
        $date_rebut = '';
        if ($immo->getDatemiseenrebut())
            $date_rebut = date('d/m/Y', strtotime($immo->getDatemiseenrebut()));
        $date_maj = '';
        if ($immo->getDatemisajour())
            $date_maj = date('d/m/Y', strtotime($immo->getDatemisajour()));

        $etat_fiche = '';
        if ($immo->getEtat() == "0")
            $etat_fiche = "Non Valide";
        else
            $etat_fiche = "Valide";
        $is_validecomptable = '';

        if ($immo->getIsValidecomptable() == true)
            $is_validecomptable = " Valide";
        else
            $is_validecomptable = "Non Valide";

        $duree_utilisation = '';

        date_default_timezone_set("UTC");

        // Time format is UNIX timestamp or
        // PHP strtotime compatible strings

        function dateDiff($time1, $time2, $precision = 6)
        {
            // If not numeric then convert texts to unix timestamps
            if (!is_int($time1)) {
                $time1 = strtotime($time1);
            }
            if (!is_int($time2)) {
                $time2 = strtotime($time2);
            }

            // If time1 is bigger than time2
            // Then swap time1 and time2
            if ($time1 > $time2) {
                $ttime = $time1;
                $time1 = $time2;
                $time2 = $ttime;
            }

            // Set up intervals and diffs arrays
            $intervals = array('year', 'month', 'day', 'hour', 'minute', 'second');

            $diffs = array();

            // Loop thru all intervals
            foreach ($intervals as $interval) {
                // Set default diff to 0
                $diffs[$interval] = 0;
                // Create temp time from time1 and interval
                $ttime = strtotime("+1 " . $interval, $time1);
                // Loop until temp time is smaller than time2
                while ($time2 >= $ttime) {
                    $time1 = $ttime;
                    $diffs[$interval]++;
                    // Create new temp time from time1 and interval
                    $ttime = strtotime("+1 " . $interval, $time1);
                }
            }

            $count = 0;
            $times = array();
            // Loop thru all diffs
            foreach ($diffs as $interval => $value) {
                // Break if we have needed precission
                if ($count >= $precision) {
                    break;
                }
                // Add value and interval
                // if value is bigger than 0
                if ($value > 0) {
                    // Add s if value is not 1
                    if ($value != 1) {
                        $interval .= "s";
                    }
                    // Add value and interval to times array
                    $intervals_no['second'] = 'seconde';
                    $intervals_no['seconds'] = 'secondes';

                    $intervals_no['minute'] = 'minute';
                    $intervals_no['minutes'] = 'minutes';

                    $intervals_no['hour'] = 'heure';
                    $intervals_no['hours'] = 'heures';

                    $intervals_no['day'] = 'jour';
                    $intervals_no['days'] = 'jours';

                    $intervals_no['month'] = 'mois';
                    $intervals_no['months'] = 'mois';

                    $intervals_no['year'] = 'an';
                    $intervals_no['years'] = 'ans';

                    $times[] = $value . " " . $intervals_no[$interval];

                    $count++;
                }
            }

            // Return string with times
            return implode(", ", $times);
        }

        $today = date('Y-m-d H:i:s');
        if ($immo->getDatemiseenservice()) {
            $date = $immo->getDatemiseenservice();
            $immo->setDuree(dateDiff($today, $date));
            $immo->save();
            $duree_utilisation = $immo->getDuree();
        } else
            $duree_utilisation = "0 Jour";

        $html = '<h3 style="font-size:18px;">' .  'FICHE D\'IMMOBILISATION</h3>
            &nbsp;<br>
            <table>
                <tbody>
                    <tr>
                        <td style="width: 21%; border-right: 1px solide #000;"><h4>FICHE<br>D\'IMMOBILISATION</h4><hr width="96%"></td>
                        <td style="width: 79%;">
                            <table boder="1">
                                <tr>
                                    <td style="width: 16%; height: 25px;"><b>Numéro :</b></td>
                                    <td style="width: 35%;">' . $immo->getNumero() . '</td>
                                    <td style="width: 34%;"><b>Date de création :</b></td>
                                    <td style="width: 15%;">' . $date_creation . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 36%; height: 25px;"><b>Date de mise en service :</b></td>
                                    <td style="width: 15%;">' . $date_service . '</td>
                                    <td style="width: 34%;"><b>Date de mise en rebut :</b></td>
                                    <td style="width: 15%;">' . $date_rebut . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 50%; height: 25px;"><b>Ancien Numéro Inventaire :</b></td>
                                    <td style="width: 50%;">' . $immo->getNumeropiece() . '</td>
                                    
                                </tr>
                                <tr>
                                    <td style="width: 16%; height: 20px;"><b>Emetteur :</b></td>
                                    <td style="width: 49%;">' . $immo->getUtilisateur() . '</td>
                                    <td style="width: 20%;"><b>Date de MAJ :</b></td>
                                    <td style="width: 15%;">' . $date_maj . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                <tbody>
            </table>&nbsp;<br>&nbsp;<br>
            
            <table>
                <tbody>
                    <tr>
                        <td style="width: 21%; border-right: 1px solide #000;"><h4>DONNEES DE<br>CLASSIFICATION</h4><hr width="100%"></td>
                        <td style="width: 79%;">
                            <table boder="1">
                                <tr>
                                    <td style="width: 20%; height: 25px;"><b>Catégorie :</b></td>
                                    <td style="width: 80%;">' . $immo->getCategoerie() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 20%; height: 25px;"><b>Famille :</b></td>
                                    <td style="width: 80%;">' . $immo->getFamille() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 20%; height: 20px;"><b>Sous Famille :</b></td>
                                    <td style="width: 80%;">' . $immo->getSousfamille() . '</td>
                                </tr>
                                <tr>
                    <td style="width: 25%; height: 38px;"><b>Code Immo. :</b></td>
                    <td style="width: 25%;">' . $immo->getReference() . '</td>
                    <td style="width: 25%;"><b>Désignation :</b></td>
                    <td style="width: 25%;">' . $immo->getDesignation() . '</td>
                </tr>
                
                            </table>
                        </td>
                    </tr>
                    
                <tbody>
            </table>&nbsp;<br>&nbsp;<br>
            <table>
                <tbody>
                    <tr>
                        <td style="width: 21%; border-right: 1px solide #000;"><h4>DONNEES<br>D\'AFFECTATION</h4><hr width="96%"></td>
                        <td style="width: 79%;">
                            <table boder="1">
                            <tr>
                            <td style="width: 25%; height: 30px;"><b>Type Affectation :</b></td>
                            <td style="width: 75%;">' . $immo->getTypeaffectationimmo() . '</td>
                        </tr>
                                <tr>
                                    <td style="width: 11%; height: 25px;"><b>Site :</b></td>
                                    <td style="width: 37%;">' . $immo->getSite() . '</td>
                                    <td style="width: 21%;"><b>Sous Site :</b></td>
                                    <td style="width: 31%;">' . $immo->getEtage() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 17%; height: 25px;"><b>Local :</b></td>
                                    <td style="width: 83%;">' . $immo->getBureaux() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 17%; height: 25px;"><b>Utilisateur :</b></td>
                                    <td style="width: 83%;">' . $immo->getAgents() . '</td>
                                </tr>
                              
                               
                                <tr>
                                    <td style="width: 100%;">
                                        <table border="1" cellpadding="3">
                                            <tr><td style="text-align:center;background-color:#DEDEDE;">Affectation Emplacement</td></tr>
                                            ' . $emplacments_html . '
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                <tbody>
            </table>&nbsp;<br>&nbsp;<br>
            <table>
                <tbody>
                    <tr>
                        <td style="width: 21%; border-right: 1px solide #000;"><h4>DONNEES<br>COMPTABLES</h4><hr width="96%"></td>
                        <td style="width: 79%;">
                            <table boder="1">
                                <tr>
                                    <td style="width: 28%; height: 25px;"><b>Date d\'acquisition :</b></td>
                                    <td style="width: 23%;">' . date('d/m/Y', strtotime($immo->getDateacquisition())) . '</td>
                                    <td style="width: 30%;"><b>Compte Comptable :</b></td>
                                    <td style="width: 19%;">' . $immo->getPlancomptable()->getNumerocompte() . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 36%; height: 25px;"><b>Date de mise en service :</b></td>
                                    <td style="width: 15%;">' . $date_service . '</td>
                                    <td style="width: 34%;"><b>Date de mise en rebut :</b></td>
                                    <td style="width: 15%;">' . $date_rebut . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 16%; height: 30px;"><b>Emetteur :</b></td>
                                    <td style="width: 49%;">' . $immo->getUtilisateur() . '</td>
                                    <td style="width: 20%;"><b>Date de MAJ :</b></td>
                                    <td style="width: 15%;">' . $date_maj . '</td>
                                </tr>
                                <tr>
                                    <td style="width: 100%;">
                                        <table border="1" cellpadding="3">
                                            <tr><td style="text-align:center;background-color:#DEDEDE;">Prix d\'acquisition</td></tr>
                                            <tr>
                                                <td>
                                                    <table>
                                                        <tr>
                                                            <td style="width: 15%; height: 43px;"><b>MT HTVA :</b></td>
                                                            <td style="width: 17%; text-align:right;">' . $immo->getPrixhtva() . '</td>
                                                            <td style="width: 2%;"></td>
                                                            <td style="width: 28%;"><b>Taux d\'amortisement :</b></td>
                                                            <td style="width: 38%;">' . $immo->getTauxammortisement() . '</td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width: 15%; height: 43px;"><b>TVA :</b></td>
                                                            <td style="width: 17%; text-align:right;">' . $immo->getTva() . '%</td>
                                                            <td style="width: 2%;"></td>
                                                            <td style="width: 28%;"><b>Mode d\'amortisement :</b></td>
                                                            <td style="width: 38%;">' . $immo->getModeammortisement() . '</td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width: 15%; height: 43px;"><b>MT TTC :</b></td>
                                                            <td style="width: 17%; text-align:right;">' . $immo->getMntttc() . '</td>
                                                            <td style="width: 2%;"></td>
                                                            <td style="width: 28%;"><b>Source de Financement :</b></td>
                                                            <td style="width: 38%;">' . $immo->getSourcefinancement() . '</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>&nbsp;<br>
                                    </td>
                                </tr>
                              
                                <tr>
                                    <td style="width: 30%; height: 25px;"><b>Durée d\'utilisation :</b></td>
                                    <td style="width: 70%;">' . $duree_utilisation . '</td>
                                </tr>
                                
                                <tr>
                                <td style="width: 50%; height: 20px;"><b>Validation Fiche Par le Comptable  :</b></td>
                                <td style="width: 25%;">' . $is_validecomptable . '</td>
                            </tr>
                                <tr>
                                    <td style="width: 18%; height: 20px;"><b>Etat Fiche :</b></td>
                                    <td style="width: 82%;">' . $etat_fiche . '</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                <tbody>
            </table>&nbsp;<br>&nbsp;<br>';

        return $html;
    }

    public function ReadHtmlListeBarcode($id)
    {
        $bureau = Doctrine_Core::getTable('bureaux')->findOneById($id);
        $immobilisations = ImmobilisationTable::getInstance()->findByIdBureaux($id);

        $html = '<h3 style="font-size:18px;">FICHE D\'IMMOBILISATION / ' . $bureau . '</h3>
            &nbsp;<br>';

        $html .= '<table border="1" cellspace="0" cellpadding="3">
                    <tr style="background-color:#ECECEC;">
                        <td style="width:30%;height:25px;text-align:center;"><b>Emplacement</b></td>
                        <td style="width:30%;text-align:center;"><b>Immob.</b></td>
                        <td style="width:15%;text-align:center;"><b>Réference</b></td>
                        <td style="width:25%;text-align:center;"><b>Code à barre</b></td>
                    </tr>';

        if ($immobilisations->count() != 0) :
            foreach ($immobilisations as $immobilisation) :
                if ($immobilisation->getDatemiseenrebut() == "" || $immobilisation->getDatemiseenrebut() == "0000-00-00") {
                    $emplacment_codebarre = EmplacementTable::getInstance()->findOneByIdBureauAndIdImmo($immobilisation->getIdBureaux(), $immobilisation->getId());
                    $cheminfile = sfconfig::get('codebarre') . "/";

                    if ($emplacment_codebarre) {
                        $html .= '<tr style="font-size:10px;">
                                <td style="height:25px;">' . $emplacment_codebarre . '<br>' . $immobilisation->getReference() . '</td>
                                <td>' . $immobilisation->getDesignation() . '</td>
                                <td style="text-align:center;">' . $emplacment_codebarre->getReference() . '</td>
                                <td style="text-align:center;"><h5 style="font-size:4px;">&nbsp;</h5>';
                        if (file_exists($cheminfile . $emplacment_codebarre->getReference() . ".png")) {
                            $html .= ' <img src="' . sfconfig::get('sf_appdir') . 'codebarre/' . $emplacment_codebarre->getReference() . '.png" width="150" height="150"></td>';
                        }
                    }


                    $html .= ' </tr>';
                }
            endforeach;
        else :
            $html .= '<tr>
                        <td style="width:100%;height:20px;text-align:center;">Pas d\'articles</td>
                    </tr>';
        endif;

        $html .= '</table>';
        return $html;
    }


    public function ReadHtmListeImmobilisation(sfWebRequest $request)
    {
        $numero = $request->getParameter('numero', '');
        $designation = $request->getParameter('designation', '');
        $id_site = $request->getParameter('id_site', '');
        $id_soussite = $request->getParameter('id_soussite', '');
        $id_bureau = $request->getParameter('id_bureau', '');
        $id_cat = $request->getParameter('id_cat', '');
        $id_famille = $request->getParameter('id_famille', '');
        $id_sousfamille = $request->getParameter('id_sousfamille', '');

        $q = Doctrine_Core::getTable('immobilisation')
            ->createQuery('immo');
        if ($numero != '') {
            $q = $q->andWhere('immo.numero like ?', '%' . $numero . '%');
        }
        if ($designation != '') {
            $q = $q->andWhere('UPPER(immo.designation) like ?', '%' . strtoupper($designation) . '%');
        }
        if ($id_site != '') {
            $q->andWhere('immo.id_site = site.id')
                ->andWhere('immo.id_site = ' . $id_site);
        }
        if ($id_soussite != '') {
            $q->andWhere('immo._id_etage = etage.id')
                ->andWhere('immo._id_etage = ' . $id_soussite);
        }
        if ($id_bureau != '') {
            $q->andWhere('immo.id_bureau = bureaux.id')
                ->andWhere('immo.id_bureau = ' . $id_bureau);
        }
        if ($id_cat != '') {
            $q->andWhere('immo.id_categorie = categoerie.id')
                ->andWhere('immo.id_categorie = ' . $id_cat);
        }
        if ($id_famille != '') {
            $q->andWhere('immo.id_famille = famille.id')
                ->andWhere('immo.id_famille = ' . $id_famille);
        }
        if ($id_sousfamille != '') {
            $q->andWhere('immo.id_sousfamille = sousfamille.id')
                ->andWhere('immo.id_sousfamille = ' . $id_sousfamille);
        }
        $q->orderBy('numero');
        $immobilisations = $q->execute();

        if ($id_site != '')
            $site_libelle = '';
        if ($id_site != '') {
            $site = SiteTable::getInstance()->find($id_site);
            $site_libelle = $site->getCode() + ' ' + $site->getSite();
        }
        if ($id_soussite != '')
            $souss_site_libelle = '';
        if ($id_soussite != '') {
            $soussite = EtageTable::getInstance()->find($id_soussite);
            $souss_site_libelle = $soussite->getCode() + ' ' + $soussite->getEtage();
        }
        if ($id_bureau != '')
            $bureau_libelle = '';
        if ($id_cat != '') {
            $bureau = CategoerieTable::getInstance()->find($id_bureau);
            $bureau_libelle = $bureau->getCode() + ' ' + $bureau->getBureau();
        }
        if ($id_bureau != '')
            $bureau_libelle = '';
        if ($id_cat != '') {
            $bureau = CategoerieTable::getInstance()->find($id_bureau);
            $bureau_libelle = $bureau->getCode() + ' ' + $bureau->getBureau();
        }
        if ($id_cat != '')
            $cat_libelle = '';
        if ($id_cat != '') {
            $categ = CategoerieTable::getInstance()->find($id_cat);
            $cat_libelle = $categ->getCodecategoeie() + ' ' + $categ->getCategorie();
        }
        if ($id_famille != '')
            $famille_libelle = '';
        if ($id_famille != '') {
            $famille = FamilleTable::getInstance()->find($id_famille);
            $famille_libelle = $famille->getCode() + ' ' + $famille->getFamille();
        }
        if ($id_sousfamille != '')
            $sousfamille = '';
        if ($id_sousfamille != '') {
            $sous_famille = SousfamilleTable::getInstance()->find($id_sousfamille);
            $sousfamille = $sous_famille->getCode() + ' ' + $sous_famille->getSousfamille();
        }


        $html = '<h3 style="font-size:18px;">Liste des Immobilisation<br><span style="font-size:16px;"></h3>
                ';
        if ($numero != '') :
            $html .= '<div>
                <table border="1" cellpadding="3">
                           <tr>
                               <td style="width:100%;">
                                   <span style="margin-top:10px; color:#000;font-weight:bold;font-size:14px;">Recherche suivant :</span>
                                   <ul style="width:50%;">';

            if ($numero != '' || $designation != '' ||  $id_site != '' ||  $id_soussite != '' ||   $id_bureau != '' ||  $id_cat != '' ||  $id_famille != '' || $id_sousfamille != '') :
                $html .= '<li style="font-size:12px;"> Numéro Fiche Immo  : ' . $numero . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Numéro Fiche Immo   : - </li>';
            endif;
            if ($designation != '') :
                $html .= '<li style="font-size:12px;"> Désignation: ' . $designation . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;">  Désignation  : - </li>';
            endif;
            if ($id_site != '' && $site_libelle != '') :
                $html .= '<li style="font-size:12px;"> Site : ' . $site_libelle . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Site : - </li>';
            endif;
            if ($id_soussite != '' && $souss_site_libelle != '') :
                $html .= '<li style="font-size:12px;"> Sous Site : ' . $souss_site_libelle . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Sous Site : - </li>';
            endif;
            if ($id_bureau != ''  && $bureau_libelle != '') :
                $html .= '<li style="font-size:12px;"> Local : ' . $bureau_libelle . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Local  : - </li>';
            endif;
            if ($id_cat != ''  && $cat_libelle != '') :
                $html .= '<li style="font-size:12px;"> Categorie : ' . $cat_libelle . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Categorie  : - </li>';
            endif;
            if ($id_famille != ''  && $famille_libelle != '') :
                $html .= '<li style="font-size:12px;"> Famille : ' . $famille_libelle . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Famille  : - </li>';
            endif;
            if ($id_sousfamille != ''  && $sousfamille != '') :
                $html .= '<li style="font-size:12px;"> Sous Famille : ' . $sousfamille . '</li>';
            // else :
            //     $html .= '<li style="font-size:12px;"> Sous Famille  : - </li>';
            endif;

            $html .= '</ul></td></tr></table>&nbsp;
           <br>';
        endif;
        $html .= '<table border="1" cellspace="0" cellpadding="2">
                        <tr style="background-color:#ECECEC;">
                            <td style="width:5%;height:25px;text-align:center;"><b>N°</b></td>
                            <td style="width:7%;text-align:center;"><b>N°Fi.</b></td>
                            <td style="width:8%;text-align:center;"><b>Désig.</b></td>
                            <td style="width:10%;text-align:center;"><b>Site</b></td>
                            <td style="width:10%;text-align:center;"><b>Sous<br>Site</b></td>
                            <td style="width:8%;text-align:center;"><b>Local</b></td>
                            <td style="width:10%;text-align:center;"><b>Catégo.</b></td>
                            <td style="width:10%;text-align:center;"><b>Famille</b></td>
                            <td style="width:8%;text-align:center;"><b>Sous Famil.</b></td>
                            <td style="width:10%;text-align:center;"><b>D.Acquisition</b></td>
                            <td style="width:7%;text-align:center;"><b>MT HTVA</b></td>
                            <td style="width:7%;text-align:center;"><b>MT TTC</b></td>
                        </tr>';

        if (sizeof($immobilisations) != 0) :
            $k = 1;
            foreach ($immobilisations as $immob) :

                $html .= '<tr style="font-size:10px;">
                <td style="text-align:center;">' . $k . '</td>
                <td style="text-align:left;">' . $immob->getNumero() . '</td>
                <td>' . $immob->getDesignation() . '</td>
                <td style="text-align:left;">';
                if ($immob->getIdSite())
                    $html .= $immob->getSite()->getCode() . ' ' . $immob->getSite();
                $html .= ' </td>
                <td style="text-align:left;">';
                if ($immob->getIdEtage())
                    $html .= $immob->getEtage()->getCode() . ' ' . $immob->getEtage();
                $html .=  '</td>';

                $html .=   '<td style="text-align:left;">';
                if ($immob->getIdBureaux())
                    $html .= $immob->getBureaux()->getCode() . ' ' . $immob->getBureaux();
                $html .=  '</td>';

                $html .=   '<td style="text-align:left;">';
                if ($immob->getIdCategorie())
                    $html .= $immob->getCategoerie()->getCodecategoeie() . ' ' . $immob->getCategoerie();
                $html .=  '</td>';
                $html .=   '<td style="text-align:left;">';
                if ($immob->getIdFamille())
                    $html .= $immob->getFamille();
                $html .=  '</td>';
                $html .=   '<td style="text-align:left;">';
                if ($immob->getIdSousfamille())
                    $html .= $immob->getSousfamille();
                $html .=  '</td>';
                $html .= '<td>' .
                    date('d/m/Y', strtotime($immob->getDateacquisition())) . '</td>

                    <td style="text-align:rigth;">' . number_format($immob->getPrixhtva(), 3, '.', ' ') . '</td>
                    <td style="text-align:rigth;">' . number_format($immob->getMntttc(), 3, '.', ' ') . '</td>
                                </tr>';

                $k++;
            endforeach;
        else :
            $html .= '<tr>
                            <td style="width:100%;height:20px;text-align:center;">Pas d\'immobilisations</td>
                        </tr>';
        endif;

        $html .= '</table>';
        return $html;
    }
    public function ReadHtmlListeType($id)
    {
        $type = TypeaffectationimmoTable::getInstance()->find($id);
        $conn = Doctrine_Manager::getInstance()->getCurrentConnection();
        $query = "SELECT immobilisation.id, numero, designation, dateacquisition, mntttc, famille.famille, sousfamille.sousfamille"
            . " FROM immobilisation, famille, sousfamille "
            . " WHERE id_typeaffectationimmo = " . $id . " "
            . " AND immobilisation.id_famille = famille.id "
            . " AND immobilisation.id_sousfamille = sousfamille.id "
            . " ORDER BY designation, numero";
        $immobilisations = $conn->fetchAssoc($query);

        $html = '<h3 style="font-size:18px;">Liste des Immobilisation<br><span style="font-size:16px;">Type Affectation : ' . $type . '</span></h3>
            &nbsp;<br>';

        $html .= '<table border="1" cellspace="0" cellpadding="3">
                    <tr style="background-color:#ECECEC;">
                        <td style="width:4%;height:25px;text-align:center;"><b>#</b></td>
                        <td style="width:7%;text-align:center;"><b>Numéro</b></td>
                        <td style="width:26%;text-align:center;"><b>Immobilisation</b></td>
                        <td style="width:9%;text-align:center;"><b>Date<br>Acquisition</b></td>
                        <td style="width:9%;text-align:center;"><b>Prix<br>Acquisition</b></td>
                        <td style="width:25%;text-align:center;"><b>Famille</b></td>
                        <td style="width:20%;text-align:center;"><b>Sous Famille</b></td>
                    </tr>';

        if (sizeof($immobilisations) != 0) :
            $k = 0;
            for ($i = 0; $i < sizeof($immobilisations); $i++) :
                $date_aquisition = '';
                if ($immobilisations[$i]['dateacquisition'] != null)
                    $date_aquisition = date('d/m/Y', strtotime($immobilisations[$i]['dateacquisition']));
                $k = $i + 1;
                $html .= '<tr style="font-size:10px;">
                                <td style="text-align:center;height:25px;">' . $k . '</td>
                                <td style="text-align:center;">' . $immobilisations[$i]['numero'] . '</td>
                                <td>' . $immobilisations[$i]['designation'] . '</td>
                                <td style="text-align:center;">' . $date_aquisition . '</td>
                                <td style="text-align:right;">' . number_format($immobilisations[$i]['mntttc'], 3, '.', ' ') . '</td>
                                <td>' . $immobilisations[$i]['famille'] . '</td>
                                <td>' . $immobilisations[$i]['sousfamille'] . '</td>
                        </tr>';
            endfor;
        else :
            $html .= '<tr>
                        <td style="width:100%;height:20px;text-align:center;">Pas d\'immobilisations</td>
                    </tr>';
        endif;

        $html .= '</table>';
        return $html;
    }
}
